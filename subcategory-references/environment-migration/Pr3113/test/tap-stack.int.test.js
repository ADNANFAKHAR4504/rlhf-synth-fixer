"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const client_ec2_1 = require("@aws-sdk/client-ec2");
const client_elastic_load_balancing_v2_1 = require("@aws-sdk/client-elastic-load-balancing-v2");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const outputs = JSON.parse(fs_1.default.readFileSync('cfn-outputs/flat-outputs.json', 'utf8'));
// Get environment suffix from environment variable (set by CI/CD pipeline)
const environmentSuffix = process.env.ENVIRONMENT_SUFFIX || 'dev';
const ec2Client = new client_ec2_1.EC2Client({});
const elbv2Client = new client_elastic_load_balancing_v2_1.ElasticLoadBalancingV2Client({});
const ssmClient = new client_ssm_1.SSMClient({});
const waitForSsmInstance = async (instanceId) => {
    let instanceReady = false;
    while (!instanceReady) {
        try {
            const command = new client_ssm_1.DescribeInstanceInformationCommand({
                Filters: [
                    {
                        Key: 'InstanceIds',
                        Values: [instanceId],
                    },
                ],
            });
            const response = await ssmClient.send(command);
            if (response.InstanceInformationList && response.InstanceInformationList.length > 0) {
                instanceReady = true;
            }
        }
        catch (error) {
            // Ignore errors
        }
        await new Promise((resolve) => setTimeout(resolve, 5000));
    }
};
describe('Three-Tier Architecture Integration Tests', () => {
    beforeAll(async () => {
        await waitForSsmInstance(outputs.BastionInstanceId);
        const describeInstancesCommand = new client_ec2_1.DescribeInstancesCommand({
            Filters: [
                {
                    Name: 'tag:aws:autoscaling:groupName',
                    Values: [outputs.WebServerAsgName],
                },
            ],
        });
        const describeInstancesResponse = await ec2Client.send(describeInstancesCommand);
        if (describeInstancesResponse.Reservations && describeInstancesResponse.Reservations.length > 0 && describeInstancesResponse.Reservations[0].Instances && describeInstancesResponse.Reservations[0].Instances.length > 0) {
            const instanceId = describeInstancesResponse.Reservations[0].Instances[0].InstanceId;
            if (instanceId) {
                await waitForSsmInstance(instanceId);
            }
        }
    }, 300000);
    describe('Resource Count and Placement', () => {
        test('should have 1 VPC with 6 subnets (2 public, 2 app, 2 DB)', async () => {
            const command = new client_ec2_1.DescribeSubnetsCommand({ Filters: [{ Name: 'vpc-id', Values: [outputs.VpcId] }] });
            const response = await ec2Client.send(command);
            const subnets = response.Subnets;
            if (subnets) {
                const publicSubnets = subnets.filter((subnet) => subnet.MapPublicIpOnLaunch);
                const privateSubnets = subnets.filter((subnet) => !subnet.MapPublicIpOnLaunch);
                const appSubnets = privateSubnets.filter((subnet) => subnet.Tags && subnet.Tags.some((tag) => tag.Value && tag.Value.includes('PrivateApplication')));
                const dbSubnets = privateSubnets.filter((subnet) => subnet.Tags && subnet.Tags.some((tag) => tag.Value && tag.Value.includes('PrivateDatabase')));
                expect(subnets.length).toBe(6);
                expect(publicSubnets.length).toBe(2);
                expect(appSubnets.length).toBe(2);
                expect(dbSubnets.length).toBe(2);
            }
        });
        test('should have 1 Application Load Balancer in public subnets', async () => {
            const command = new client_elastic_load_balancing_v2_1.DescribeLoadBalancersCommand({
                LoadBalancerArns: [outputs.LoadBalancerArn],
            });
            const response = await elbv2Client.send(command);
            if (response.LoadBalancers && response.LoadBalancers.length > 0) {
                const alb = response.LoadBalancers[0];
                if (alb.AvailabilityZones) {
                    const subnetIds = alb.AvailabilityZones.map((az) => az.SubnetId).filter((id) => !!id);
                    const describeSubnetsCommand = new client_ec2_1.DescribeSubnetsCommand({
                        SubnetIds: subnetIds,
                    });
                    const subnetsResponse = await ec2Client.send(describeSubnetsCommand);
                    if (subnetsResponse.Subnets) {
                        const allPublic = subnetsResponse.Subnets.every((subnet) => subnet.MapPublicIpOnLaunch);
                        expect(allPublic).toBe(true);
                    }
                }
            }
            expect(response.LoadBalancers && response.LoadBalancers.length).toBe(1);
        });
        test('should have NAT Gateways', async () => {
            const command = new client_ec2_1.DescribeNatGatewaysCommand({});
            const response = await ec2Client.send(command);
            expect(response.NatGateways && response.NatGateways.length).toBeGreaterThan(0);
        });
    });
    describe('Network Accessibility', () => {
        test('Public subnets should have internet access', async () => {
            const sendCommandCommand = new client_ssm_1.SendCommandCommand({
                InstanceIds: [outputs.BastionInstanceId],
                DocumentName: 'AWS-RunShellScript',
                Parameters: {
                    commands: ['curl -s http://checkip.amazonaws.com'],
                },
            });
            const sendCommandResponse = await ssmClient.send(sendCommandCommand);
            if (sendCommandResponse.Command && sendCommandResponse.Command.CommandId) {
                const commandId = sendCommandResponse.Command.CommandId;
                await (0, client_ssm_1.waitUntilCommandExecuted)({ client: ssmClient, maxWaitTime: 60 }, { CommandId: commandId, InstanceId: outputs.BastionInstanceId });
                const getCommandInvocationCommand = new client_ssm_1.GetCommandInvocationCommand({
                    CommandId: commandId,
                    InstanceId: outputs.BastionInstanceId,
                });
                const getCommandInvocationResponse = await ssmClient.send(getCommandInvocationCommand);
                expect(getCommandInvocationResponse.StandardOutputContent).toMatch(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/);
            }
        });
        test('Private subnets should have internet access via NAT Gateway', async () => {
            const describeInstancesCommand = new client_ec2_1.DescribeInstancesCommand({
                Filters: [
                    {
                        Name: 'tag:aws:autoscaling:groupName',
                        Values: [outputs.WebServerAsgName],
                    },
                ],
            });
            const describeInstancesResponse = await ec2Client.send(describeInstancesCommand);
            if (describeInstancesResponse.Reservations && describeInstancesResponse.Reservations.length > 0 && describeInstancesResponse.Reservations[0].Instances && describeInstancesResponse.Reservations[0].Instances.length > 0) {
                const instanceId = describeInstancesResponse.Reservations[0].Instances[0].InstanceId;
                if (instanceId) {
                    const sendCommandCommand = new client_ssm_1.SendCommandCommand({
                        InstanceIds: [instanceId],
                        DocumentName: 'AWS-RunShellScript',
                        Parameters: {
                            commands: ['curl -s http://checkip.amazonaws.com'],
                        },
                    });
                    const sendCommandResponse = await ssmClient.send(sendCommandCommand);
                    if (sendCommandResponse.Command && sendCommandResponse.Command.CommandId) {
                        const commandId = sendCommandResponse.Command.CommandId;
                        await (0, client_ssm_1.waitUntilCommandExecuted)({ client: ssmClient, maxWaitTime: 60 }, { CommandId: commandId, InstanceId: instanceId });
                        const getCommandInvocationCommand = new client_ssm_1.GetCommandInvocationCommand({
                            CommandId: commandId,
                            InstanceId: instanceId,
                        });
                        const getCommandInvocationResponse = await ssmClient.send(getCommandInvocationCommand);
                        expect(getCommandInvocationResponse.StandardOutputContent).toMatch(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/);
                    }
                }
            }
        });
        test('Database subnets should not have public IPs', async () => {
            const command = new client_ec2_1.DescribeSubnetsCommand({
                Filters: [{ Name: 'tag:aws-cdk:subnet-type', Values: ['PrivateDatabase'] }],
            });
            const response = await ec2Client.send(command);
            if (response.Subnets) {
                const allPrivate = response.Subnets.every((subnet) => !subnet.MapPublicIpOnLaunch);
                expect(allPrivate).toBe(true);
            }
        });
    });
    describe('Traffic Flow and Security', () => {
        test('Web server instances should be healthy in the target group', async () => {
            const command = new client_elastic_load_balancing_v2_1.DescribeTargetHealthCommand({ TargetGroupArn: outputs.TargetGroupArn });
            const response = await elbv2Client.send(command);
            if (response.TargetHealthDescriptions) {
                const allHealthy = response.TargetHealthDescriptions.every((th) => th.TargetHealth && th.TargetHealth.State === 'healthy');
                expect(allHealthy).toBe(true);
            }
        });
        test('ALB should route traffic to the web tier', async () => {
            const sendCommandCommand = new client_ssm_1.SendCommandCommand({
                InstanceIds: [outputs.BastionInstanceId],
                DocumentName: 'AWS-RunShellScript',
                Parameters: {
                    commands: [`curl -s http://${outputs.LoadBalancerDNS}`],
                },
            });
            const sendCommandResponse = await ssmClient.send(sendCommandCommand);
            if (sendCommandResponse.Command && sendCommandResponse.Command.CommandId) {
                const commandId = sendCommandResponse.Command.CommandId;
                await (0, client_ssm_1.waitUntilCommandExecuted)({ client: ssmClient, maxWaitTime: 60 }, { CommandId: commandId, InstanceId: outputs.BastionInstanceId });
                const getCommandInvocationCommand = new client_ssm_1.GetCommandInvocationCommand({
                    CommandId: commandId,
                    InstanceId: outputs.BastionInstanceId,
                });
                const getCommandInvocationResponse = await ssmClient.send(getCommandInvocationCommand);
                expect(getCommandInvocationResponse.StandardOutputContent).toContain('Welcome to the Migration Web App!');
            }
        });
        test('Web tier should not be directly accessible from the internet', async () => {
            const describeInstancesCommand = new client_ec2_1.DescribeInstancesCommand({
                Filters: [
                    {
                        Name: 'tag:aws:autoscaling:groupName',
                        Values: [outputs.WebServerAsgName],
                    },
                ],
            });
            const describeInstancesResponse = await ec2Client.send(describeInstancesCommand);
            if (describeInstancesResponse.Reservations && describeInstancesResponse.Reservations.length > 0 && describeInstancesResponse.Reservations[0].Instances && describeInstancesResponse.Reservations[0].Instances.length > 0) {
                const instanceIp = describeInstancesResponse.Reservations[0].Instances[0].PrivateIpAddress;
                await expect(fetch(`http://${instanceIp}`)).rejects.toThrow();
            }
        });
        test('Database tier should be isolated', async () => {
            const command = new client_ec2_1.DescribeInstancesCommand({
                Filters: [{ Name: 'subnet-id', Values: [outputs.DatabaseSubnetAId, outputs.DatabaseSubnetBId] }],
            });
            const response = await ec2Client.send(command);
            expect(response.Reservations && response.Reservations.length).toBe(0);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFwLXN0YWNrLmludC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGFwLXN0YWNrLmludC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLG9EQU02QjtBQUM3QixnR0FJbUQ7QUFDbkQsb0RBTTZCO0FBRTdCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQ3hCLFlBQUUsQ0FBQyxZQUFZLENBQUMsK0JBQStCLEVBQUUsTUFBTSxDQUFDLENBQ3pELENBQUM7QUFFRiwyRUFBMkU7QUFDM0UsTUFBTSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEtBQUssQ0FBQztBQUVsRSxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDcEMsTUFBTSxXQUFXLEdBQUcsSUFBSSwrREFBNEIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6RCxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFcEMsTUFBTSxrQkFBa0IsR0FBRyxLQUFLLEVBQUUsVUFBa0IsRUFBRSxFQUFFO0lBQ3RELElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztJQUMxQixPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDO1lBQ0gsTUFBTSxPQUFPLEdBQUcsSUFBSSwrQ0FBa0MsQ0FBQztnQkFDckQsT0FBTyxFQUFFO29CQUNQO3dCQUNFLEdBQUcsRUFBRSxhQUFhO3dCQUNsQixNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUM7cUJBQ3JCO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQy9DLElBQUksUUFBUSxDQUFDLHVCQUF1QixJQUFJLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLEdBQUcsQ0FB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RyxDQUFDLEVBQUUsQ0FBQztnQkFDek4sTUFBTSxVQUFVLEdBQUcseUJBQXlCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQztnQkFFM0YsTUFBTSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNoRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDbEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxxQ0FBd0IsQ0FBQztnQkFDM0MsT0FBTyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2FBQ2pHLENBQUMsQ0FBQztZQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMvQyxNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHtcbiAgRUMyQ2xpZW50LFxuICBEZXNjcmliZVN1Ym5ldHNDb21tYW5kLFxuICBEZXNjcmliZU5hdEdhdGV3YXlzQ29tbWFuZCxcbiAgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kLFxuICB3YWl0VW50aWxJbnN0YW5jZVJ1bm5pbmcsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1lYzInO1xuaW1wb3J0IHtcbiAgRWxhc3RpY0xvYWRCYWxhbmNpbmdWMkNsaWVudCxcbiAgRGVzY3JpYmVMb2FkQmFsYW5jZXJzQ29tbWFuZCxcbiAgRGVzY3JpYmVUYXJnZXRIZWFsdGhDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtZWxhc3RpYy1sb2FkLWJhbGFuY2luZy12Mic7XG5pbXBvcnQge1xuICBTU01DbGllbnQsXG4gIFNlbmRDb21tYW5kQ29tbWFuZCxcbiAgR2V0Q29tbWFuZEludm9jYXRpb25Db21tYW5kLFxuICB3YWl0VW50aWxDb21tYW5kRXhlY3V0ZWQsXG4gIERlc2NyaWJlSW5zdGFuY2VJbmZvcm1hdGlvbkNvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuXG5jb25zdCBvdXRwdXRzID0gSlNPTi5wYXJzZShcbiAgZnMucmVhZEZpbGVTeW5jKCdjZm4tb3V0cHV0cy9mbGF0LW91dHB1dHMuanNvbicsICd1dGY4Jylcbik7XG5cbi8vIEdldCBlbnZpcm9ubWVudCBzdWZmaXggZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZSAoc2V0IGJ5IENJL0NEIHBpcGVsaW5lKVxuY29uc3QgZW52aXJvbm1lbnRTdWZmaXggPSBwcm9jZXNzLmVudi5FTlZJUk9OTUVOVF9TVUZGSVggfHwgJ2Rldic7XG5cbmNvbnN0IGVjMkNsaWVudCA9IG5ldyBFQzJDbGllbnQoe30pO1xuY29uc3QgZWxidjJDbGllbnQgPSBuZXcgRWxhc3RpY0xvYWRCYWxhbmNpbmdWMkNsaWVudCh7fSk7XG5jb25zdCBzc21DbGllbnQgPSBuZXcgU1NNQ2xpZW50KHt9KTtcblxuY29uc3Qgd2FpdEZvclNzbUluc3RhbmNlID0gYXN5bmMgKGluc3RhbmNlSWQ6IHN0cmluZykgPT4ge1xuICBsZXQgaW5zdGFuY2VSZWFkeSA9IGZhbHNlO1xuICB3aGlsZSAoIWluc3RhbmNlUmVhZHkpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBEZXNjcmliZUluc3RhbmNlSW5mb3JtYXRpb25Db21tYW5kKHtcbiAgICAgICAgRmlsdGVyczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEtleTogJ0luc3RhbmNlSWRzJyxcbiAgICAgICAgICAgIFZhbHVlczogW2luc3RhbmNlSWRdLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc3NtQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBpZiAocmVzcG9uc2UuSW5zdGFuY2VJbmZvcm1hdGlvbkxpc3QgJiYgcmVzcG9uc2UuSW5zdGFuY2VJbmZvcm1hdGlvbkxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICBpbnN0YW5jZVJlYWR5ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWdub3JlIGVycm9yc1xuICAgIH1cbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDAwKSk7XG4gIH1cbn07XG5cbmRlc2NyaWJlKCdUaHJlZS1UaWVyIEFyY2hpdGVjdHVyZSBJbnRlZ3JhdGlvbiBUZXN0cycsICgpID0+IHtcbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB3YWl0Rm9yU3NtSW5zdGFuY2Uob3V0cHV0cy5CYXN0aW9uSW5zdGFuY2VJZCk7XG4gICAgY29uc3QgZGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kID0gbmV3IERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCh7XG4gICAgICBGaWx0ZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBOYW1lOiAndGFnOmF3czphdXRvc2NhbGluZzpncm91cE5hbWUnLFxuICAgICAgICAgIFZhbHVlczogW291dHB1dHMuV2ViU2VydmVyQXNnTmFtZV0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuICAgIGNvbnN0IGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChkZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpO1xuICAgIGlmIChkZXNjcmliZUluc3RhbmNlc1Jlc3BvbnNlLlJlc2VydmF0aW9ucyAmJiBkZXNjcmliZUluc3RhbmNlc1Jlc3BvbnNlLlJlc2VydmF0aW9ucy5sZW5ndGggPiAwICYmIGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zWzBdLkluc3RhbmNlcyAmJiBkZXNjcmliZUluc3RhbmNlc1Jlc3BvbnNlLlJlc2VydmF0aW9uc1swXS5JbnN0YW5jZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgaW5zdGFuY2VJZCA9IGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zWzBdLkluc3RhbmNlc1swXS5JbnN0YW5jZUlkO1xuICAgICAgaWYgKGluc3RhbmNlSWQpIHtcbiAgICAgICAgYXdhaXQgd2FpdEZvclNzbUluc3RhbmNlKGluc3RhbmNlSWQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgMzAwMDAwKTtcblxuICBkZXNjcmliZSgnUmVzb3VyY2UgQ291bnQgYW5kIFBsYWNlbWVudCcsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgaGF2ZSAxIFZQQyB3aXRoIDYgc3VibmV0cyAoMiBwdWJsaWMsIDIgYXBwLCAyIERCKScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVTdWJuZXRzQ29tbWFuZCh7IEZpbHRlcnM6IFt7IE5hbWU6ICd2cGMtaWQnLCBWYWx1ZXM6IFtvdXRwdXRzLlZwY0lkXSB9XSB9KTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZWMyQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBjb25zdCBzdWJuZXRzID0gcmVzcG9uc2UuU3VibmV0cztcbiAgICAgIGlmIChzdWJuZXRzKSB7XG4gICAgICAgIGNvbnN0IHB1YmxpY1N1Ym5ldHMgPSBzdWJuZXRzLmZpbHRlcigoc3VibmV0KSA9PiBzdWJuZXQuTWFwUHVibGljSXBPbkxhdW5jaCk7XG4gICAgICAgIGNvbnN0IHByaXZhdGVTdWJuZXRzID0gc3VibmV0cy5maWx0ZXIoKHN1Ym5ldCkgPT4gIXN1Ym5ldC5NYXBQdWJsaWNJcE9uTGF1bmNoKTtcbiAgICAgICAgY29uc3QgYXBwU3VibmV0cyA9IHByaXZhdGVTdWJuZXRzLmZpbHRlcigoc3VibmV0KSA9PlxuICAgICAgICAgIHN1Ym5ldC5UYWdzICYmIHN1Ym5ldC5UYWdzLnNvbWUoKHRhZykgPT4gdGFnLlZhbHVlICYmIHRhZy5WYWx1ZS5pbmNsdWRlcygnUHJpdmF0ZUFwcGxpY2F0aW9uJykpXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGRiU3VibmV0cyA9IHByaXZhdGVTdWJuZXRzLmZpbHRlcigoc3VibmV0KSA9PlxuICAgICAgICAgIHN1Ym5ldC5UYWdzICYmIHN1Ym5ldC5UYWdzLnNvbWUoKHRhZykgPT4gdGFnLlZhbHVlICYmIHRhZy5WYWx1ZS5pbmNsdWRlcygnUHJpdmF0ZURhdGFiYXNlJykpXG4gICAgICAgICk7XG5cbiAgICAgICAgZXhwZWN0KHN1Ym5ldHMubGVuZ3RoKS50b0JlKDYpO1xuICAgICAgICBleHBlY3QocHVibGljU3VibmV0cy5sZW5ndGgpLnRvQmUoMik7XG4gICAgICAgIGV4cGVjdChhcHBTdWJuZXRzLmxlbmd0aCkudG9CZSgyKTtcbiAgICAgICAgZXhwZWN0KGRiU3VibmV0cy5sZW5ndGgpLnRvQmUoMik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgaGF2ZSAxIEFwcGxpY2F0aW9uIExvYWQgQmFsYW5jZXIgaW4gcHVibGljIHN1Ym5ldHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IERlc2NyaWJlTG9hZEJhbGFuY2Vyc0NvbW1hbmQoe1xuICAgICAgICBMb2FkQmFsYW5jZXJBcm5zOiBbb3V0cHV0cy5Mb2FkQmFsYW5jZXJBcm5dLFxuICAgICAgfSk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGVsYnYyQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBpZiAocmVzcG9uc2UuTG9hZEJhbGFuY2VycyAmJiByZXNwb25zZS5Mb2FkQmFsYW5jZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgYWxiID0gcmVzcG9uc2UuTG9hZEJhbGFuY2Vyc1swXTtcbiAgICAgICAgaWYgKGFsYi5BdmFpbGFiaWxpdHlab25lcykge1xuICAgICAgICAgIGNvbnN0IHN1Ym5ldElkcyA9IGFsYi5BdmFpbGFiaWxpdHlab25lcy5tYXAoKGF6KSA9PiBhei5TdWJuZXRJZCkuZmlsdGVyKChpZCk6IGlkIGlzIHN0cmluZyA9PiAhIWlkKTtcblxuICAgICAgICAgIGNvbnN0IGRlc2NyaWJlU3VibmV0c0NvbW1hbmQgPSBuZXcgRGVzY3JpYmVTdWJuZXRzQ29tbWFuZCh7XG4gICAgICAgICAgICBTdWJuZXRJZHM6IHN1Ym5ldElkcyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCBzdWJuZXRzUmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChkZXNjcmliZVN1Ym5ldHNDb21tYW5kKTtcbiAgICAgICAgICBpZiAoc3VibmV0c1Jlc3BvbnNlLlN1Ym5ldHMpIHtcbiAgICAgICAgICAgIGNvbnN0IGFsbFB1YmxpYyA9IHN1Ym5ldHNSZXNwb25zZS5TdWJuZXRzLmV2ZXJ5KFxuICAgICAgICAgICAgICAoc3VibmV0KSA9PiBzdWJuZXQuTWFwUHVibGljSXBPbkxhdW5jaFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGV4cGVjdChhbGxQdWJsaWMpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBleHBlY3QocmVzcG9uc2UuTG9hZEJhbGFuY2VycyAmJiByZXNwb25zZS5Mb2FkQmFsYW5jZXJzLmxlbmd0aCkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBoYXZlIE5BVCBHYXRld2F5cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVOYXRHYXRld2F5c0NvbW1hbmQoe30pO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5OYXRHYXRld2F5cyAmJiByZXNwb25zZS5OYXRHYXRld2F5cy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ05ldHdvcmsgQWNjZXNzaWJpbGl0eScsICgpID0+IHtcbiAgICB0ZXN0KCdQdWJsaWMgc3VibmV0cyBzaG91bGQgaGF2ZSBpbnRlcm5ldCBhY2Nlc3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzZW5kQ29tbWFuZENvbW1hbmQgPSBuZXcgU2VuZENvbW1hbmRDb21tYW5kKHtcbiAgICAgICAgSW5zdGFuY2VJZHM6IFtvdXRwdXRzLkJhc3Rpb25JbnN0YW5jZUlkXSxcbiAgICAgICAgRG9jdW1lbnROYW1lOiAnQVdTLVJ1blNoZWxsU2NyaXB0JyxcbiAgICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICAgIGNvbW1hbmRzOiBbJ2N1cmwgLXMgaHR0cDovL2NoZWNraXAuYW1hem9uYXdzLmNvbSddLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICBjb25zdCBzZW5kQ29tbWFuZFJlc3BvbnNlID0gYXdhaXQgc3NtQ2xpZW50LnNlbmQoc2VuZENvbW1hbmRDb21tYW5kKTtcbiAgICAgIGlmIChzZW5kQ29tbWFuZFJlc3BvbnNlLkNvbW1hbmQgJiYgc2VuZENvbW1hbmRSZXNwb25zZS5Db21tYW5kLkNvbW1hbmRJZCkge1xuICAgICAgICBjb25zdCBjb21tYW5kSWQgPSBzZW5kQ29tbWFuZFJlc3BvbnNlLkNvbW1hbmQuQ29tbWFuZElkO1xuXG4gICAgICAgIGF3YWl0IHdhaXRVbnRpbENvbW1hbmRFeGVjdXRlZCh7IGNsaWVudDogc3NtQ2xpZW50LCBtYXhXYWl0VGltZTogNjAgfSwgeyBDb21tYW5kSWQ6IGNvbW1hbmRJZCwgSW5zdGFuY2VJZDogb3V0cHV0cy5CYXN0aW9uSW5zdGFuY2VJZCB9KTtcblxuICAgICAgICBjb25zdCBnZXRDb21tYW5kSW52b2NhdGlvbkNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZEludm9jYXRpb25Db21tYW5kKHtcbiAgICAgICAgICBDb21tYW5kSWQ6IGNvbW1hbmRJZCxcbiAgICAgICAgICBJbnN0YW5jZUlkOiBvdXRwdXRzLkJhc3Rpb25JbnN0YW5jZUlkLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgZ2V0Q29tbWFuZEludm9jYXRpb25SZXNwb25zZSA9IGF3YWl0IHNzbUNsaWVudC5zZW5kKGdldENvbW1hbmRJbnZvY2F0aW9uQ29tbWFuZCk7XG5cbiAgICAgICAgZXhwZWN0KGdldENvbW1hbmRJbnZvY2F0aW9uUmVzcG9uc2UuU3RhbmRhcmRPdXRwdXRDb250ZW50KS50b01hdGNoKC9cXGR7MSwzfVxcLlxcZHsxLDN9XFwuXFxkezEsM31cXC5cXGR7MSwzfS8pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGVzdCgnUHJpdmF0ZSBzdWJuZXRzIHNob3VsZCBoYXZlIGludGVybmV0IGFjY2VzcyB2aWEgTkFUIEdhdGV3YXknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkZXNjcmliZUluc3RhbmNlc0NvbW1hbmQgPSBuZXcgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kKHtcbiAgICAgICAgRmlsdGVyczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIE5hbWU6ICd0YWc6YXdzOmF1dG9zY2FsaW5nOmdyb3VwTmFtZScsXG4gICAgICAgICAgICBWYWx1ZXM6IFtvdXRwdXRzLldlYlNlcnZlckFzZ05hbWVdLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChkZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpO1xuICAgICAgaWYgKGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zICYmIGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zLmxlbmd0aCA+IDAgJiYgZGVzY3JpYmVJbnN0YW5jZXNSZXNwb25zZS5SZXNlcnZhdGlvbnNbMF0uSW5zdGFuY2VzICYmIGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zWzBdLkluc3RhbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlSWQgPSBkZXNjcmliZUluc3RhbmNlc1Jlc3BvbnNlLlJlc2VydmF0aW9uc1swXS5JbnN0YW5jZXNbMF0uSW5zdGFuY2VJZDtcbiAgICAgICAgaWYgKGluc3RhbmNlSWQpIHtcbiAgICAgICAgICBjb25zdCBzZW5kQ29tbWFuZENvbW1hbmQgPSBuZXcgU2VuZENvbW1hbmRDb21tYW5kKHtcbiAgICAgICAgICAgIEluc3RhbmNlSWRzOiBbaW5zdGFuY2VJZF0sXG4gICAgICAgICAgICBEb2N1bWVudE5hbWU6ICdBV1MtUnVuU2hlbGxTY3JpcHQnLFxuICAgICAgICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICBjb21tYW5kczogWydjdXJsIC1zIGh0dHA6Ly9jaGVja2lwLmFtYXpvbmF3cy5jb20nXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3Qgc2VuZENvbW1hbmRSZXNwb25zZSA9IGF3YWl0IHNzbUNsaWVudC5zZW5kKHNlbmRDb21tYW5kQ29tbWFuZCk7XG4gICAgICAgICAgaWYgKHNlbmRDb21tYW5kUmVzcG9uc2UuQ29tbWFuZCAmJiBzZW5kQ29tbWFuZFJlc3BvbnNlLkNvbW1hbmQuQ29tbWFuZElkKSB7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kSWQgPSBzZW5kQ29tbWFuZFJlc3BvbnNlLkNvbW1hbmQuQ29tbWFuZElkO1xuXG4gICAgICAgICAgICBhd2FpdCB3YWl0VW50aWxDb21tYW5kRXhlY3V0ZWQoeyBjbGllbnQ6IHNzbUNsaWVudCwgbWF4V2FpdFRpbWU6IDYwIH0sIHsgQ29tbWFuZElkOiBjb21tYW5kSWQsIEluc3RhbmNlSWQ6IGluc3RhbmNlSWQgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGdldENvbW1hbmRJbnZvY2F0aW9uQ29tbWFuZCA9IG5ldyBHZXRDb21tYW5kSW52b2NhdGlvbkNvbW1hbmQoe1xuICAgICAgICAgICAgICBDb21tYW5kSWQ6IGNvbW1hbmRJZCxcbiAgICAgICAgICAgICAgSW5zdGFuY2VJZDogaW5zdGFuY2VJZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgZ2V0Q29tbWFuZEludm9jYXRpb25SZXNwb25zZSA9IGF3YWl0IHNzbUNsaWVudC5zZW5kKGdldENvbW1hbmRJbnZvY2F0aW9uQ29tbWFuZCk7XG5cbiAgICAgICAgICAgIGV4cGVjdChnZXRDb21tYW5kSW52b2NhdGlvblJlc3BvbnNlLlN0YW5kYXJkT3V0cHV0Q29udGVudCkudG9NYXRjaCgvXFxkezEsM31cXC5cXGR7MSwzfVxcLlxcZHsxLDN9XFwuXFxkezEsM30vKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRlc3QoJ0RhdGFiYXNlIHN1Ym5ldHMgc2hvdWxkIG5vdCBoYXZlIHB1YmxpYyBJUHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVTdWJuZXRzQ29tbWFuZCh7XG4gICAgICAgICAgICBGaWx0ZXJzOiBbeyBOYW1lOiAndGFnOmF3cy1jZGs6c3VibmV0LXR5cGUnLCBWYWx1ZXM6IFsnUHJpdmF0ZURhdGFiYXNlJ10gfV0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICAgICAgICBpZiAocmVzcG9uc2UuU3VibmV0cykge1xuICAgICAgICAgICAgY29uc3QgYWxsUHJpdmF0ZSA9IHJlc3BvbnNlLlN1Ym5ldHMuZXZlcnkoXG4gICAgICAgICAgICAgIChzdWJuZXQpID0+ICFzdWJuZXQuTWFwUHVibGljSXBPbkxhdW5jaFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGV4cGVjdChhbGxQcml2YXRlKS50b0JlKHRydWUpO1xuICAgICAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1RyYWZmaWMgRmxvdyBhbmQgU2VjdXJpdHknLCAoKSA9PiB7XG4gICAgdGVzdCgnV2ViIHNlcnZlciBpbnN0YW5jZXMgc2hvdWxkIGJlIGhlYWx0aHkgaW4gdGhlIHRhcmdldCBncm91cCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVUYXJnZXRIZWFsdGhDb21tYW5kKHsgVGFyZ2V0R3JvdXBBcm46IG91dHB1dHMuVGFyZ2V0R3JvdXBBcm4gfSk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGVsYnYyQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBpZiAocmVzcG9uc2UuVGFyZ2V0SGVhbHRoRGVzY3JpcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGFsbEhlYWx0aHkgPSByZXNwb25zZS5UYXJnZXRIZWFsdGhEZXNjcmlwdGlvbnMuZXZlcnkoXG4gICAgICAgICAgKHRoKSA9PiB0aC5UYXJnZXRIZWFsdGggJiYgdGguVGFyZ2V0SGVhbHRoLlN0YXRlID09PSAnaGVhbHRoeSdcbiAgICAgICAgKTtcbiAgICAgICAgZXhwZWN0KGFsbEhlYWx0aHkpLnRvQmUodHJ1ZSk7XG4gICAgICB9XG4gICAgfSk7XG5cblxuICAgIHRlc3QoJ0FMQiBzaG91bGQgcm91dGUgdHJhZmZpYyB0byB0aGUgd2ViIHRpZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzZW5kQ29tbWFuZENvbW1hbmQgPSBuZXcgU2VuZENvbW1hbmRDb21tYW5kKHtcbiAgICAgICAgSW5zdGFuY2VJZHM6IFtvdXRwdXRzLkJhc3Rpb25JbnN0YW5jZUlkXSxcbiAgICAgICAgRG9jdW1lbnROYW1lOiAnQVdTLVJ1blNoZWxsU2NyaXB0JyxcbiAgICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICAgIGNvbW1hbmRzOiBbYGN1cmwgLXMgaHR0cDovLyR7b3V0cHV0cy5Mb2FkQmFsYW5jZXJETlN9YF0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHNlbmRDb21tYW5kUmVzcG9uc2UgPSBhd2FpdCBzc21DbGllbnQuc2VuZChzZW5kQ29tbWFuZENvbW1hbmQpO1xuICAgICAgaWYgKHNlbmRDb21tYW5kUmVzcG9uc2UuQ29tbWFuZCAmJiBzZW5kQ29tbWFuZFJlc3BvbnNlLkNvbW1hbmQuQ29tbWFuZElkKSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRJZCA9IHNlbmRDb21tYW5kUmVzcG9uc2UuQ29tbWFuZC5Db21tYW5kSWQ7XG5cbiAgICAgICAgYXdhaXQgd2FpdFVudGlsQ29tbWFuZEV4ZWN1dGVkKHsgY2xpZW50OiBzc21DbGllbnQsIG1heFdhaXRUaW1lOiA2MCB9LCB7IENvbW1hbmRJZDogY29tbWFuZElkLCBJbnN0YW5jZUlkOiBvdXRwdXRzLkJhc3Rpb25JbnN0YW5jZUlkIH0pO1xuXG4gICAgICAgIGNvbnN0IGdldENvbW1hbmRJbnZvY2F0aW9uQ29tbWFuZCA9IG5ldyBHZXRDb21tYW5kSW52b2NhdGlvbkNvbW1hbmQoe1xuICAgICAgICAgIENvbW1hbmRJZDogY29tbWFuZElkLFxuICAgICAgICAgIEluc3RhbmNlSWQ6IG91dHB1dHMuQmFzdGlvbkluc3RhbmNlSWQsXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBnZXRDb21tYW5kSW52b2NhdGlvblJlc3BvbnNlID0gYXdhaXQgc3NtQ2xpZW50LnNlbmQoZ2V0Q29tbWFuZEludm9jYXRpb25Db21tYW5kKTtcblxuICAgICAgICBleHBlY3QoZ2V0Q29tbWFuZEludm9jYXRpb25SZXNwb25zZS5TdGFuZGFyZE91dHB1dENvbnRlbnQpLnRvQ29udGFpbignV2VsY29tZSB0byB0aGUgTWlncmF0aW9uIFdlYiBBcHAhJyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdXZWIgdGllciBzaG91bGQgbm90IGJlIGRpcmVjdGx5IGFjY2Vzc2libGUgZnJvbSB0aGUgaW50ZXJuZXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkZXNjcmliZUluc3RhbmNlc0NvbW1hbmQgPSBuZXcgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kKHtcbiAgICAgICAgRmlsdGVyczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIE5hbWU6ICd0YWc6YXdzOmF1dG9zY2FsaW5nOmdyb3VwTmFtZScsXG4gICAgICAgICAgICBWYWx1ZXM6IFtvdXRwdXRzLldlYlNlcnZlckFzZ05hbWVdLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChkZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpO1xuICAgICAgaWYgKGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zICYmIGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zLmxlbmd0aCA+IDAgJiYgZGVzY3JpYmVJbnN0YW5jZXNSZXNwb25zZS5SZXNlcnZhdGlvbnNbMF0uSW5zdGFuY2VzICYmIGRlc2NyaWJlSW5zdGFuY2VzUmVzcG9uc2UuUmVzZXJ2YXRpb25zWzBdLkluc3RhbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlSXAgPSBkZXNjcmliZUluc3RhbmNlc1Jlc3BvbnNlLlJlc2VydmF0aW9uc1swXS5JbnN0YW5jZXNbMF0uUHJpdmF0ZUlwQWRkcmVzcztcblxuICAgICAgICBhd2FpdCBleHBlY3QoZmV0Y2goYGh0dHA6Ly8ke2luc3RhbmNlSXB9YCkpLnJlamVjdHMudG9UaHJvdygpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGVzdCgnRGF0YWJhc2UgdGllciBzaG91bGQgYmUgaXNvbGF0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCh7XG4gICAgICAgIEZpbHRlcnM6IFt7IE5hbWU6ICdzdWJuZXQtaWQnLCBWYWx1ZXM6IFtvdXRwdXRzLkRhdGFiYXNlU3VibmV0QUlkLCBvdXRwdXRzLkRhdGFiYXNlU3VibmV0QklkXSB9XSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBlYzJDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5SZXNlcnZhdGlvbnMgJiYgcmVzcG9uc2UuUmVzZXJ2YXRpb25zLmxlbmd0aCkudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXX0=
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "SaaS Encryption Standards Enforcement Template - Compliant with cfn-nag and AWS Config",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "production",
            "AllowedValues": [
                "development",
                "staging",
                "production"
            ],
            "Description": "Environment name for resource tagging"
        },
        "MFAAge": {
            "Type": "Number",
            "Default": 3600,
            "Description": "Maximum age in seconds for MFA authentication (default 1 hour)"
        },
        "KMSKeyArn": {
            "Type": "String",
            "Default": "",
            "Description": "Optional KMS key ARN for S3 encryption (leave empty for AWS managed key)"
        }
    },
    "Conditions": {
        "UseCustomKMS": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KMSKeyArn"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseDefaultKMS": {
            "Fn::Equals": [
                {
                    "Ref": "KMSKeyArn"
                },
                ""
            ]
        }
    },
    "Resources": {
        "EncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "UseDefaultKMS",
            "Properties": {
                "Description": "Master key for encryption compliance",
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow use of the key for encryption",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "s3.amazonaws.com",
                                    "ec2.amazonaws.com",
                                    "config.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "EncryptionCompliance"
                    }
                ]
            }
        },
        "EncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Condition": "UseDefaultKMS",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/encryption-compliance-${Environment}"
                },
                "TargetKeyId": {
                    "Ref": "EncryptionKey"
                }
            }
        },
        "ApplicationDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "saas-app-data-${AWS::AccountId}-${Environment}"
                },
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerPreferred"
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": {
                                    "Fn::If": [
                                        "UseCustomKMS",
                                        "aws:kms",
                                        "AES256"
                                    ]
                                },
                                "KMSMasterKeyID": {
                                    "Fn::If": [
                                        "UseCustomKMS",
                                        {
                                            "Ref": "KMSKeyArn"
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 90
                        }
                    ]
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "LoggingBucket"
                    },
                    "LogFilePrefix": "application-data/"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Encryption",
                        "Value": "Required"
                    }
                ]
            }
        },
        "ApplicationDataBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ApplicationDataBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyInsecureConnections",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ApplicationDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "DenyUnencryptedObjectUploads",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": [
                                        "AES256",
                                        "aws:kms"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LoggingBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "saas-logs-${AWS::AccountId}-${Environment}"
                },
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerPreferred"
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 365
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Logging"
                    }
                ]
            }
        },
        "LoggingBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "LoggingBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "S3ServerAccessLogsPolicy",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logging.s3.amazonaws.com"
                            },
                            "Action": [
                                "s3:PutObject"
                            ],
                            "Resource": {
                                "Fn::Sub": "${LoggingBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "EBSEncryptionLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "EnableEBSEncryption",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:EnableEbsEncryptionByDefault",
                                        "ec2:GetEbsEncryptionByDefault",
                                        "ec2:ModifyEbsDefaultKmsKeyId"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EBSEncryptionLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "EnableEBSEncryption-${Environment}"
                },
                "Runtime": "python3.9",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "EBSEncryptionLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Code": {
                    "ZipFile": "import boto3\nimport json\nimport cfnresponse\n\ndef handler(event, context):\n    ec2 = boto3.client('ec2')\n    \n    try:\n        request_type = event['RequestType']\n        \n        if request_type in ['Create', 'Update']:\n            # Enable EBS encryption by default\n            response = ec2.enable_ebs_encryption_by_default()\n            print(f\"EBS encryption enabled: {response}\")\n            \n            # Optionally set KMS key if provided\n            kms_key = event['ResourceProperties'].get('KmsKeyId')\n            if kms_key and kms_key != '':\n                print(f\"Setting custom KMS key: {kms_key}\")\n                ec2.modify_ebs_default_kms_key_id(KmsKeyId=kms_key)\n            else:\n                print(\"Using AWS managed key for EBS encryption\")\n            \n            cfnresponse.send(event, context, cfnresponse.SUCCESS, \n                           {'Message': 'EBS encryption enabled successfully'})\n        elif request_type == 'Delete':\n            # For delete operations, we typically don't disable EBS encryption\n            # as it's a security feature that should remain enabled\n            cfnresponse.send(event, context, cfnresponse.SUCCESS,\n                           {'Message': 'Delete completed - EBS encryption left enabled'})\n        else:\n            cfnresponse.send(event, context, cfnresponse.SUCCESS,\n                           {'Message': 'No action taken'})\n                           \n    except Exception as e:\n        print(f\"Error in Lambda function: {str(e)}\")\n        import traceback\n        print(f\"Traceback: {traceback.format_exc()}\")\n        cfnresponse.send(event, context, cfnresponse.FAILED,\n                       {'Message': f'Lambda execution failed: {str(e)}'})\n"
                }
            }
        },
        "EnableEBSEncryption": {
            "Type": "Custom::EnableEBSEncryption",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "EBSEncryptionLambda",
                        "Arn"
                    ]
                },
                "KmsKeyId": {
                    "Fn::If": [
                        "UseCustomKMS",
                        {
                            "Ref": "KMSKeyArn"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "MFAEnforcementPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": {
                    "Fn::Sub": "RequireMFA-${Environment}"
                },
                "Description": "Enforces MFA for all IAM users",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowViewAccountInfo",
                            "Effect": "Allow",
                            "Action": [
                                "iam:GetAccountPasswordPolicy",
                                "iam:ListVirtualMFADevices"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowManageOwnPasswordsAndMFA",
                            "Effect": "Allow",
                            "Action": [
                                "iam:ChangePassword",
                                "iam:GetUser",
                                "iam:CreateVirtualMFADevice",
                                "iam:DeleteVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:ListMFADevices",
                                "iam:ResyncMFADevice",
                                "iam:DeactivateMFADevice"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:user/${!aws:username}"
                                },
                                {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:mfa/${!aws:username}"
                                }
                            ]
                        },
                        {
                            "Sid": "DenyAllExceptListedIfNoMFA",
                            "Effect": "Deny",
                            "NotAction": [
                                "iam:CreateVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:GetUser",
                                "iam:ListMFADevices",
                                "iam:ListVirtualMFADevices",
                                "iam:ResyncMFADevice",
                                "sts:GetSessionToken"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "BoolIfExists": {
                                    "aws:MultiFactorAuthPresent": "false"
                                }
                            }
                        },
                        {
                            "Sid": "DenyIfMFATooOld",
                            "Effect": "Deny",
                            "Action": "*",
                            "Resource": "*",
                            "Condition": {
                                "NumericGreaterThan": {
                                    "aws:MultiFactorAuthAge": {
                                        "Ref": "MFAAge"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigRecorder": {
            "Type": "AWS::Config::ConfigurationRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "EncryptionComplianceRecorder-${Environment}"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "ConfigRole",
                        "Arn"
                    ]
                },
                "RecordingGroup": {
                    "AllSupported": true,
                    "IncludeGlobalResourceTypes": true
                }
            }
        },
        "ConfigDeliveryChannel": {
            "Type": "AWS::Config::DeliveryChannel",
            "Properties": {
                "Name": {
                    "Fn::Sub": "EncryptionComplianceChannel-${Environment}"
                },
                "S3BucketName": {
                    "Ref": "ConfigBucket"
                },
                "SnsTopicARN": {
                    "Ref": "ConfigSNSTopic"
                },
                "ConfigSnapshotDeliveryProperties": {
                    "DeliveryFrequency": "TwentyFour_Hours"
                }
            }
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "config-bucket-${AWS::AccountId}-${Environment}"
                },
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerPreferred"
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldConfigData",
                            "Status": "Enabled",
                            "ExpirationInDays": 2555
                        }
                    ]
                }
            }
        },
        "ConfigBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ConfigBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowConfigAccess",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": [
                                "s3:GetBucketAcl",
                                "s3:ListBucket"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ConfigBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AllowConfigPutObject",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ConfigBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigSNSTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "DisplayName": "Config Compliance Notifications",
                "KmsMasterKeyId": {
                    "Fn::If": [
                        "UseCustomKMS",
                        {
                            "Ref": "KMSKeyArn"
                        },
                        {
                            "Ref": "EncryptionKey"
                        }
                    ]
                }
            }
        },
        "ConfigRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "ConfigServiceRolePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketAcl",
                                        "s3:ListBucket",
                                        "s3:PutObject",
                                        "sns:Publish",
                                        "config:Put*",
                                        "config:Get*",
                                        "config:List*",
                                        "config:Describe*",
                                        "config:BatchGet*",
                                        "config:Select*"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketAcl",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ConfigBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ConfigBucket.Arn}/*"
                                    },
                                    "Condition": {
                                        "StringEquals": {
                                            "s3:x-amz-acl": "bucket-owner-full-control"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "S3BucketSSLRequestsOnly": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "s3-bucket-ssl-requests-only",
                "Description": "Checks S3 buckets have policies requiring SSL",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_SSL_REQUESTS_ONLY"
                }
            }
        },
        "S3BucketServerSideEncryption": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "s3-bucket-server-side-encryption-enabled",
                "Description": "Checks that S3 buckets have encryption enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
                }
            }
        },
        "S3DefaultEncryptionKMS": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "s3-default-encryption-kms",
                "Description": "Checks S3 buckets have KMS encryption by default",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_DEFAULT_ENCRYPTION_KMS"
                }
            }
        },
        "EncryptedVolumes": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "encrypted-volumes",
                "Description": "Checks EBS volumes are encrypted",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ENCRYPTED_VOLUMES"
                }
            }
        },
        "EC2EBSEncryptionByDefault": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "ec2-ebs-encryption-by-default",
                "Description": "Checks that EBS encryption is enabled by default",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "EC2_EBS_ENCRYPTION_BY_DEFAULT"
                }
            }
        },
        "RDSStorageEncrypted": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "rds-storage-encrypted",
                "Description": "Checks RDS instances have storage encryption",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "RDS_STORAGE_ENCRYPTED"
                }
            }
        },
        "EFSEncryptedCheck": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "efs-encrypted-check",
                "Description": "Checks EFS file systems are encrypted",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "EFS_ENCRYPTED_CHECK"
                }
            }
        },
        "IAMUserMFAEnabled": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "iam-user-mfa-enabled",
                "Description": "Checks that IAM users have MFA enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "IAM_USER_MFA_ENABLED"
                }
            }
        },
        "RootAccountMFAEnabled": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigRecorder",
            "Properties": {
                "ConfigRuleName": "root-account-mfa-enabled",
                "Description": "Checks that root account has MFA enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ROOT_ACCOUNT_MFA_ENABLED"
                }
            }
        },
        "EncryptionConformancePack": {
            "Type": "AWS::Config::ConformancePack",
            "DependsOn": [
                "ConfigRecorder",
                "ConfigDeliveryChannel"
            ],
            "Properties": {
                "ConformancePackName": {
                    "Fn::Sub": "encryption-compliance-pack-${Environment}"
                },
                "TemplateBody": "Resources:\n  S3BucketPublicReadProhibited:\n    Type: AWS::Config::ConfigRule\n    Properties:\n      ConfigRuleName: s3-bucket-public-read-prohibited\n      Source:\n        Owner: AWS\n        SourceIdentifier: S3_BUCKET_PUBLIC_READ_PROHIBITED\n  \n  S3BucketPublicWriteProhibited:\n    Type: AWS::Config::ConfigRule\n    Properties:\n      ConfigRuleName: s3-bucket-public-write-prohibited\n      Source:\n        Owner: AWS\n        SourceIdentifier: S3_BUCKET_PUBLIC_WRITE_PROHIBITED\n  \n  CloudTrailEncryptionEnabled:\n    Type: AWS::Config::ConfigRule\n    Properties:\n      ConfigRuleName: cloud-trail-encryption-enabled\n      Source:\n        Owner: AWS\n        SourceIdentifier: CLOUD_TRAIL_ENCRYPTION_ENABLED\n"
            }
        }
    },
    "Outputs": {
        "ApplicationDataBucketName": {
            "Description": "Name of the encrypted application data bucket",
            "Value": {
                "Ref": "ApplicationDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AppBucket"
                }
            }
        },
        "LoggingBucketName": {
            "Description": "Name of the logging bucket",
            "Value": {
                "Ref": "LoggingBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogBucket"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Fn::If": [
                    "UseCustomKMS",
                    {
                        "Ref": "KMSKeyArn"
                    },
                    {
                        "Ref": "EncryptionKey"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKey"
                }
            }
        },
        "MFAPolicyArn": {
            "Description": "ARN of the MFA enforcement policy",
            "Value": {
                "Ref": "MFAEnforcementPolicy"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-MFAPolicy"
                }
            }
        },
        "ConfigRecorderName": {
            "Description": "Name of the Config Recorder",
            "Value": {
                "Ref": "ConfigRecorder"
            }
        },
        "ComplianceStatus": {
            "Description": "Check Config Rules dashboard for compliance status",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/config/home?region=${AWS::Region}#/rules"
            }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "Environment"
                    ]
                },
                {
                    "Label": {
                        "default": "Security Settings"
                    },
                    "Parameters": [
                        "MFAAge",
                        "KMSKeyArn"
                    ]
                }
            ],
            "ParameterLabels": {
                "Environment": {
                    "default": "Environment Name"
                },
                "MFAAge": {
                    "default": "MFA Token Max Age (seconds)"
                },
                "KMSKeyArn": {
                    "default": "Custom KMS Key ARN (optional)"
                }
            }
        }
    }
}
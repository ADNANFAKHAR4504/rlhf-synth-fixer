# Integration Tests for TapStack

This directory contains integration tests for the TapStack CDK stack. These tests verify that the CloudFormation template generated by the CDK stack meets all security and functional requirements.

## Overview

The integration tests validate:

- **Resource Creation**: Ensures all required AWS resources (S3 bucket, KMS key, etc.) are created
- **Security Configuration**: Verifies encryption, access policies, and security settings
- **Naming Conventions**: Checks that resources follow expected naming patterns
- **Policy Validation**: Ensures IAM policies and bucket policies are correctly configured
- **Output Verification**: Validates that required CloudFormation outputs are present

## Test Structure

### Test Classes

- `TestTapStackIntegration`: Main test class containing all integration tests

### Test Categories

1. **Resource Creation Tests**
   - `test_kms_key_created`: Verifies KMS key creation
   - `test_s3_bucket_created`: Verifies S3 bucket creation
   - `test_kms_key_alias_exists`: Verifies KMS key alias

2. **Security Configuration Tests**
   - `test_bucket_encryption_is_kms`: Verifies KMS encryption
   - `test_bucket_public_access_block`: Verifies public access blocking
   - `test_bucket_policy_restricts_unencrypted_uploads`: Verifies encryption enforcement
   - `test_kms_key_rotation_enabled`: Verifies key rotation

3. **Policy Validation Tests**
   - `test_bucket_policy_has_principal_control`: Verifies IAM principal access
   - `test_kms_key_policy_includes_s3_service_principal`: Verifies S3 service access
   - `test_kms_key_policy_includes_user_principal`: Verifies user access

4. **Configuration Tests**
   - `test_environment_suffix_propagation`: Verifies environment suffix handling
   - `test_principal_arns_propagation`: Verifies multiple principal ARN handling
   - `test_default_environment_suffix`: Verifies default environment handling
   - `test_empty_principal_arns_handling`: Verifies empty principal ARN handling

5. **Output and Structure Tests**
   - `test_stack_outputs_exist`: Verifies CloudFormation outputs
   - `test_nested_stack_structure`: Verifies nested stack creation
   - `test_stack_resource_exposure`: Verifies resource exposure
   - `test_template_generation`: Verifies template generation

## Running the Tests

### Prerequisites

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   # or
   pipenv install
   ```

2. Ensure you have the required AWS CDK dependencies:
   ```bash
   pip install aws-cdk-lib constructs
   ```

### Running All Integration Tests

```bash
# Using pytest directly
python -m pytest tests/integration/test_tap_stack.py -v

# Using the test runner script
python run_integration_tests.py

# Using pipenv
pipenv run python -m pytest tests/integration/test_tap_stack.py -v
```

### Running Specific Tests

```bash
# Run a specific test
python -m pytest tests/integration/test_tap_stack.py::TestTapStackIntegration::test_kms_key_created -v

# Run tests matching a pattern
python -m pytest tests/integration/test_tap_stack.py -k "kms" -v

# Run tests with specific markers
python -m pytest tests/integration/test_tap_stack.py -m integration -v
```

### Running with Coverage

```bash
# Run with coverage (for unit tests)
python -m pytest tests/unit/ --cov=lib --cov-report=term-missing

# Run integration tests without coverage (recommended)
python -m pytest tests/integration/ --no-cov
```

## Test Configuration

### Fixtures

The tests use several pytest fixtures:

- `app`: Creates a CDK App instance
- `stack`: Creates a TapStack instance with test configuration
- `template`: Generates CloudFormation template from the stack

### Test Environment

Tests use the following configuration:
- Environment suffix: "test"
- Principal ARNs: `["arn:aws:iam::123456789012:user/test-user"]`
- AWS Account ID: "123456789012"
- AWS Region: "us-east-1"

## Expected Test Results

When all tests pass, you should see output similar to:

```
============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-7.4.3, pluggy-1.3.0
rootdir: /path/to/project
plugins: cov-4.1.0
collected 25 items

tests/integration/test_tap_stack.py::TestTapStackIntegration::test_kms_key_created PASSED
tests/integration/test_tap_stack.py::TestTapStackIntegration::test_s3_bucket_created PASSED
...
tests/integration/test_tap_stack.py::TestTapStackIntegration::test_kms_key_rotation_enabled PASSED

============================== 25 passed in 2.34s ==============================
```

## Troubleshooting

### Common Issues

1. **Import Errors**: Ensure the project root is in the Python path
2. **CDK Version Mismatch**: Update AWS CDK dependencies to match your project
3. **Template Generation Errors**: Check that all required CDK constructs are imported

### Debug Mode

Run tests with verbose output for debugging:

```bash
python -m pytest tests/integration/test_tap_stack.py -v -s --tb=long
```

### Template Inspection

To inspect the generated CloudFormation template:

```python
# Add this to a test for debugging
template_json = template.to_json()
print(json.dumps(template_json, indent=2))
```

## Adding New Tests

When adding new integration tests:

1. Follow the existing naming convention: `test_<feature_name>`
2. Use descriptive docstrings explaining what the test validates
3. Use appropriate fixtures (`template`, `stack`, `app`)
4. Test both positive and negative scenarios
5. Include edge cases and error conditions

## Best Practices

1. **Isolation**: Each test should be independent and not rely on other tests
2. **Clarity**: Use clear, descriptive test names and docstrings
3. **Completeness**: Test all major functionality and edge cases
4. **Maintainability**: Keep tests simple and focused on single concerns
5. **Performance**: Integration tests should run quickly (no actual AWS calls)

## Related Files

- `lib/tap_stack.py`: The main CDK stack being tested
- `tests/conftest.py`: Shared test configuration and fixtures
- `pytest.ini`: Pytest configuration
- `run_integration_tests.py`: Test runner script 
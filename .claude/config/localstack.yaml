# LocalStack Migration Configuration
# Central configuration for localstack-migrate command and related agents
# Version: 1.0.0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ITERATION SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
iteration:
  max_fix_iterations: 10 # Maximum fix iterations (increased to ensure production ready)
  max_cicd_iterations: 10 # Maximum CI/CD monitoring iterations after PR push
  max_deployment_attempts: 3 # Maximum deployment attempts per iteration
  use_batch_fix: true # Enable batch fix approach (apply ALL fixes before re-deploy)
  continue_until_production_ready: true # MUST iterate until all CI/CD jobs pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TIMEOUT SETTINGS (in seconds)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
timeouts:
  localstack_health_check: 5 # Timeout for LocalStack health check
  deployment_timeout: 300 # Maximum time for deployment (5 minutes)
  test_timeout: 120 # Maximum time for integration tests (2 minutes)
  bootstrap_timeout: 120 # Maximum time for CDK bootstrap (2 minutes)
  npm_install_timeout: 180 # Maximum time for npm install (3 minutes)
  pip_install_timeout: 120 # Maximum time for pip install (2 minutes)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOCALSTACK SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
localstack:
  endpoint: 'http://localhost:4566'
  region: 'us-east-1'
  account_id: '000000000000'
  access_key: 'test'
  secret_key: 'test'
  reset_state_before_deploy: false # Set to false for parallel execution
  unique_stack_names: true # Use tap-stack-{PR_ID} for parallel safety

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BATCH FIX STRATEGY SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
batch_fix:
  enabled: true # Enable batch fix approach
  apply_preventive_fixes: true # Apply fixes even without specific errors

  # Fix priority order (applied in this sequence)
  # IMPORTANT: metadata_fix MUST be first - CI/CD validates metadata.json before anything else
  fix_priority:
    - metadata_fix # ğŸ”´ CRITICAL - MUST BE FIRST - Schema compliance for CI/CD
    - endpoint_config # ğŸ”´ Critical - LocalStack endpoint detection
    - s3_path_style # ğŸ”´ Critical - S3 path-style access
    - removal_policy # ğŸŸ¡ High - RemovalPolicy.DESTROY
    - test_config # ğŸŸ¡ High - Test endpoint configuration
    - iam_simplify # ğŸŸ¡ Medium - IAM policy simplification
    - resource_naming # ğŸŸ¡ Medium - Resource naming simplification
    - unsupported_service # ğŸŸ¡ Medium - Unsupported service conditionals
    - default_parameters # ğŸŸ¢ Low - Default parameter values

  # Preventive fixes (apply even if no error detected)
  # IMPORTANT: metadata_fix is ALWAYS applied first
  preventive_fixes:
    - metadata_fix # ALWAYS - Required for CI/CD to pass
    - endpoint_config # Almost always needed
    - s3_path_style # If using S3/buckets
    - removal_policy # Always for LocalStack
    - test_config # If test/ directory exists

  # Conditional fixes (only apply if specific error detected)
  conditional_fixes:
    iam_simplify:
      error_patterns:
        - 'policy'
        - 'iam'
        - 'principal'
        - 'malformed'
    resource_naming:
      error_patterns:
        - 'name'
        - 'invalid.*bucket'
        - 'too long'
        - 'character'
    unsupported_service:
      error_patterns:
        - 'not supported'
        - 'unsupported'
        - 'not available'
        - 'appsync'
        - 'amplify'
        - 'sagemaker'
    default_parameters:
      error_patterns:
        - 'parameter'
        - 'missing.*required'
        - 'undefined'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SERVICE COMPATIBILITY (LocalStack Community Edition)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
service_compatibility:
  # High compatibility - full support in Community
  high:
    - s3
    - dynamodb
    - sqs
    - sns
    - iam
    - kms
    - cloudwatch
    - logs
    - secretsmanager
    - ssm
    - eventbridge
    - events

  # Medium compatibility - mostly supported
  medium:
    - lambda
    - apigateway
    - stepfunctions
    - kinesis
    - cloudformation

  # Low compatibility - limited or Pro-only
  low:
    - ecs
    - rds
    - ec2
    - elasticache
    - elasticsearch

  # Not supported in Community (Pro only)
  pro_only:
    - eks
    - appsync
    - amplify
    - sagemaker
    - cognito-idp # Limited in Community

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SMART SELECTION SCORING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
smart_selection:
  enabled: true
  base_score: 100

  # Score adjustments based on services used
  service_penalties:
    low_compatibility: -25 # Penalty for each low-compat service
    medium_compatibility: -10 # Penalty for each medium-compat service
    pro_only: -50 # Penalty for pro-only services (likely to fail)

  # Score bonuses based on platform
  platform_bonuses:
    cfn: 10 # CloudFormation is most compatible
    cdk: 5 # CDK has good compatibility
    tf: 0 # Terraform is neutral
    pulumi: -5 # Pulumi has some quirks

  # Score bonuses based on complexity
  complexity_bonuses:
    easy: 10
    medium: 0
    hard: -10
    expert: -20

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARALLEL EXECUTION SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
parallel:
  enabled: true
  max_concurrent_agents: 10 # Maximum parallel agents
  use_git_worktrees: true # Use git worktrees for isolation
  use_file_locking: true # Lock migration log for concurrent writes
  lock_timeout_seconds: 30 # Timeout for acquiring file lock
  lock_retry_attempts: 10 # Number of retry attempts for lock
  stale_lock_timeout: 60 # Consider lock stale after this many seconds

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKING DIRECTORY SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
worktree:
  base_path: 'worktree'
  localstack_pattern: 'localstack-{pr_id}' # Working directory for deployment
  git_pattern: 'git-{pr_id}' # Git worktree for branch operations
  github_pattern: 'github-{pr_id}' # Temp directory for GitHub fetches
  auto_cleanup: true # Clean up after completion
  prune_orphaned: true # Prune orphaned git worktrees

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PR CREATION SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
pr_creation:
  branch_pattern: 'ls-synth-{pr_id}' # Branch naming pattern
  pr_id_prefix: 'ls-' # Prefix for new PR IDs (ls-Pr1234)
  title_pattern: '[LocalStack] {ls_pr_id} - {platform}/{language}'
  force_push: true # Force push to handle existing branches
  auto_create_pr: true # Automatically create GitHub PR

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MIGRATION LOG SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
migration_log:
  path: '.claude/reports/localstack-migrations.json'
  lock_file: '.claude/reports/.migration-log.lock'
  track_iterations: true
  track_fixes_applied: true
  include_timestamps: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# LOGGING CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
logging:
  level: INFO # DEBUG, INFO, WARN, ERROR
  verbose_deployment: false # Show full deployment output
  verbose_test_output: false # Show full test output
  log_to_file: false # Log to file (in addition to console)
  log_directory: '/tmp/localstack-migrate-logs'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXIT CODES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
exit_codes:
  success: 0 # Migration successful, PR created
  fix_failed: 1 # Unable to fix within max iterations
  unsupported_services: 2 # Uses Pro-only services
  localstack_not_running: 3 # LocalStack is not available
  github_error: 4 # GitHub CLI error
  git_error: 5 # Git operation failed

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PLATFORM-SPECIFIC SETTINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
platforms:
  cdk:
    bootstrap_required: true
    bootstrap_command: 'cdklocal bootstrap aws://{account_id}/{region}'
    deploy_command: 'cdklocal deploy --all --require-approval never'
    destroy_command: 'cdklocal destroy --all --force'
    output_directory: 'cdk.out'

  cfn:
    bootstrap_required: false
    deploy_command: 'awslocal cloudformation create-stack --stack-name {stack_name} --template-body file://lib/TapStack.yml --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM'
    wait_command: 'awslocal cloudformation wait stack-create-complete --stack-name {stack_name}'
    destroy_command: 'awslocal cloudformation delete-stack --stack-name {stack_name}'

  tf:
    bootstrap_required: false
    init_command: 'tflocal init'
    deploy_command: 'tflocal apply -auto-approve'
    destroy_command: 'tflocal destroy -auto-approve'

  pulumi:
    bootstrap_required: true
    backend: 'file://~/.pulumi-localstack'
    deploy_command: 'pulumi up --yes --stack {stack_name}'
    destroy_command: 'pulumi destroy --yes --stack {stack_name}'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GITHUB SETTINGS
# These settings are used by the modular scripts in .claude/scripts/:
#   - localstack-common.sh (loads GITHUB_REPO from here)
#   - localstack-fetch-github.sh (fetches PRs from this repo)
#   - localstack-create-pr.sh (creates PRs in this repo)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
github:
  repo: 'TuringGpt/iac-test-automations' # Central config - used by all scripts
  fetch_method: 'api' # api, clone, or checkout
  api_timeout: 30 # GitHub API timeout
  clone_depth: 1 # Shallow clone depth

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# METADATA SCHEMA COMPLIANCE
# The schema at config/schemas/metadata.schema.json has
# additionalProperties: false, so we MUST sanitize metadata.json
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
metadata:
  schema_path: 'config/schemas/metadata.schema.json'
  sanitize_on_migrate: true # Remove fields not in schema
  validate_before_commit: true # Validate against schema before creating PR

  # Fields that MUST be removed (not allowed by schema)
  fields_to_remove:
    - task_id # Use po_id instead
    - training_quality
    - coverage
    - author
    - dockerS3Location
    - pr_id
    - original_pr_id
    - localstack_migration

  # Valid subtask values (from schema enum)
  valid_subtasks:
    - 'Provisioning of Infrastructure Environments'
    - 'Application Deployment'
    - 'CI/CD Pipeline Integration'
    - 'Failure Recovery and High Availability'
    - 'Security, Compliance, and Governance'
    - 'IaC Program Optimization'
    - 'Infrastructure QA and Management'

  # Subtask mapping (old invalid values to valid values)
  subtask_mapping:
    'Security and Compliance Implementation': 'Security, Compliance, and Governance'
    'Security Configuration': 'Security, Compliance, and Governance'
    'Database Management': 'Provisioning of Infrastructure Environments'
    'Network Configuration': 'Provisioning of Infrastructure Environments'
    'Monitoring Setup': 'Infrastructure QA and Management'
    'Performance Optimization': 'IaC Program Optimization'
    'Access Control': 'Security, Compliance, and Governance'

  # Valid subject_labels (from schema enum)
  valid_subject_labels:
    - 'Environment Migration'
    - 'Cloud Environment Setup'
    - 'Multi-Environment Consistency'
    - 'Web Application Deployment'
    - 'Serverless Infrastructure (Functions as Code)'
    - 'CI/CD Pipeline'
    - 'Failure Recovery Automation'
    - 'Security Configuration as Code'
    - 'IaC Diagnosis/Edits'
    - 'IaC Optimization'
    - 'Infrastructure Analysis/Monitoring'
    - 'General Infrastructure Tooling QA'

  # Subject label mapping (old invalid values to valid values)
  subject_label_mapping:
    'Security Configuration': 'Security Configuration as Code'
    'Database Management': 'General Infrastructure Tooling QA'
    'Network Configuration': 'Cloud Environment Setup'
    'Access Control': 'Security Configuration as Code'
    'Monitoring Setup': 'Infrastructure Analysis/Monitoring'
    'Performance Optimization': 'IaC Optimization'

  # Default values if mapping fails
  default_subtask: 'Infrastructure QA and Management'
  default_subject_label: 'General Infrastructure Tooling QA'

name: CI/CD Pipeline

# Special keyword [skip-jobs] can be added to commit messages to skip most jobs
# The upload-task-to-s3 job will still run when a PR is merged, regardless of this tag
# The cleanup-pr job will still run when a PR is closed, regardless of this tag
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      environment_suffix:
        description: 'Environment suffix for resource naming (e.g., pr123, dev, test)'
        required: false
        default: 'manual'
        type: string
      skip_cleanup:
        description: 'Skip cleanup/destroy step after deployment'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  NODE_VERSION: '22.17.0'
  GO_VERSION: '1.23.12'
  # Use PR number for resource isolation, manual input, or fallback to 'dev' for main branch
  # Prefix with 'pr' to ensure AWS resource names start with a letter
  ENVIRONMENT_SUFFIX: ${{ github.event.inputs.environment_suffix || (github.event.number && format('pr{0}', github.event.number)) || 'dev' }}
  S3_RELEASE_BUCKET_NAME: 'iac-rlhf-aws-release-342597974367-us-east-1'
  TERRAFORM_STATE_BUCKET: 'iac-rlhf-tf-states-342597974367'
  TERRAFORM_STATE_BUCKET_REGION: 'us-east-1'
  TERRAFORM_STATE_BUCKET_KEY: ${{ github.event.pull_request.number }}
  PULUMI_STATE_BUCKET: 'iac-rlhf-pulumi-states-342597974367'
  PULUMI_BUCKET_REGION: 'us-east-1'
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
  PULUMI_ORG: 'organization'
  AWS_REGION: ${{ vars.AWS_REGION }}
  CDK_DEFAULT_REGION: ${{ vars.CDK_DEFAULT_REGION || vars.AWS_REGION || 'us-east-1' }}
  CURRENT_ACCOUNT_ID: ${{ vars.ACCOUNT_ID }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  MODEL_S3_URI: 's3://social-platform-sagemaker-342597974367-dev/model.tar.gz'
  # Go caching optimization
  GOCACHE: ${{ github.workspace }}/.cache/go-build
  GOMODCACHE: ${{ github.workspace }}/.cache/go-mod
  IAC_ANALYSIS_SUBJECT_LABEL: 'Infrastructure Analysis/Monitoring'
  CICD_PIPELINE_SUBJECT_LABEL: 'CI/CD Pipeline'

jobs:
  detect-metadata:
    name: Detect Project Files
    runs-on: ubuntu-24.04
    if: ${{ (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') && !contains(github.event.head_commit.message, '[skip-jobs]') }}
    outputs:
      platform: ${{ steps.metadata.outputs.platform }}
      language: ${{ steps.metadata.outputs.language }}
      po_id: ${{ steps.metadata.outputs.po_id }}
      team: ${{ steps.metadata.outputs.team }}
      provider: ${{ steps.metadata.outputs.provider }}
      subtask: ${{ steps.metadata.outputs.subtask }}
      subject_labels: ${{ steps.metadata.outputs.subject_labels }}
      analysis_subject_label: ${{ env.IAC_ANALYSIS_SUBJECT_LABEL }}
      cicd_pipeline_subject_label: ${{ env.CICD_PIPELINE_SUBJECT_LABEL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin main:main

      - name: Validate metadata.json
        uses: cardinalby/schema-validator-action@v3
        with:
          file: 'metadata.json'
          schema: 'config/schemas/metadata.schema.json'

      - name: Check Project Files
        id: check-files
        run: ./scripts/check-project-files.sh

      - name: Detect metadata and validate project
        id: metadata
        run: ./scripts/detect-metadata.sh

  claude-review-prompt-quality:
    runs-on: ubuntu-24.04
    name: 'Claude Review: Prompt Quality'
    needs: detect-metadata
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && !contains(github.event.head_commit.message, '[skip-jobs]') }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.pull_request.number }}/head

      - name: Check if prompt quality review file exists
        id: check-prompt-file
        run: |
          if [ -f .claude/prompts/claude-prompt-quality-review.md ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Prompt quality review file found"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Prompt quality review file not found - skipping this check"
            echo "This is expected for PRs created before this feature was merged to main"
          fi

      - name: Prepare Claude prompt
        if: steps.check-prompt-file.outputs.file_exists == 'true'
        id: prepare-prompt
        run: |
          PROMPT=$(cat .claude/prompts/claude-prompt-quality-review.md)
          {
            echo 'CLAUDE_PROMPT<<PROMPT_EOF'
            echo "$PROMPT"
            echo 'PROMPT_EOF'
          } >> $GITHUB_ENV

      - name: Run Claude Prompt Quality Review
        if: steps.check-prompt-file.outputs.file_exists == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: 'Bash,Read,Grep,Glob'
          trigger_phrase: ''
          custom_instructions: '${{ env.CLAUDE_PROMPT }}'

      - name: Verify Prompt Quality Validation Result
        run: |
          echo "Verifying prompt quality validation result..."
          # Run the validation script directly to check if it passes
          if bash .claude/scripts/claude-validate-prompt-quality.sh; then
            echo "‚úÖ Prompt quality validation PASSED"
            exit 0
          else
            echo "‚ùå Prompt quality validation FAILED"
            echo "::error::Prompt quality validation failed. Check the Claude review comment for details."
            exit 1
          fi

  validate-commit-message:
    name: Validate Commit Message
    needs: [detect-metadata, claude-review-prompt-quality]
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && !contains(github.event.head_commit.message, '[skip-jobs]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to fetch all history for commitlint

      - name: Setup Node for Commitlint
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Commitlint locally
        run: |
          npm install --no-save \
            @commitlint/{cli,config-conventional}

      - name: Validate commit message
        run: npx commitlint --last

  validate-jest-config:
    name: Validate Jest Config
    runs-on: ubuntu-24.04
    needs: [detect-metadata, validate-commit-message]
    # Only run for TypeScript/JavaScript projects (Jest is not used for Python, Go, Java)
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && (needs.detect-metadata.outputs.language == 'ts' || needs.detect-metadata.outputs.language == 'js') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate jest.config.js test folder
        run: ./scripts/ci-validate-jest-config.sh
        env:
          LANGUAGE: ${{ needs.detect-metadata.outputs.language }}

  build:
    name: Build
    runs-on: ubuntu-24.04
    needs:
      [
        detect-metadata,
        claude-review-prompt-quality,
        validate-commit-message,
        validate-jest-config,
      ]
    if: |
      always() &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label) &&
      needs.claude-review-prompt-quality.result == 'success' &&
      needs.validate-commit-message.result == 'success' &&
      (needs.validate-jest-config.result == 'success' || needs.validate-jest-config.result == 'skipped')
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'
          upload-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}

      - name: Validate Stack Naming
        run: |
          echo "üîç Validating stack naming conventions..."
          if [ -f "scripts/validate-stack-naming.sh" ]; then
            ./scripts/validate-stack-naming.sh || echo "‚ö†Ô∏è Stack naming validation found issues (non-blocking)"
          else
            echo "‚ö†Ô∏è validate-stack-naming.sh not found, skipping"
          fi

      - name: Build
        run: ./scripts/build.sh

      - name: Upload build artifacts (dist/)
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist
          if-no-files-found: ignore

  synth:
    name: Synth
    runs-on: ubuntu-24.04
    needs: [detect-metadata, build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)
    environment: dev
    permissions:
      contents: read
    outputs:
      platform: ${{ needs.detect-metadata.outputs.platform }}
      language: ${{ needs.detect-metadata.outputs.language }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Skip Synth for non-CDK/CDKTF platforms
        if: ${{ needs.detect-metadata.outputs.platform != 'cdk' && needs.detect-metadata.outputs.platform != 'cdktf' }}
        run: |
          echo "‚úÖ Synth step not required for platform: ${{ needs.detect-metadata.outputs.platform }}"
          echo "This platform does not require synthesis. Job passes automatically."

      - name: Setup Environment
        if: ${{ needs.detect-metadata.outputs.platform == 'cdk' || needs.detect-metadata.outputs.platform == 'cdktf' }}
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}

      - name: Configure AWS
        if: ${{ needs.detect-metadata.outputs.platform == 'cdk' || needs.detect-metadata.outputs.platform == 'cdktf' }}
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Synth
        if: ${{ needs.detect-metadata.outputs.platform == 'cdk' || needs.detect-metadata.outputs.platform == 'cdktf' }}
        run: ./scripts/synth.sh
        env:
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          TERRAFORM_STATE_BUCKET: ${{ env.TERRAFORM_STATE_BUCKET }}
          TERRAFORM_STATE_BUCKET_REGION: ${{ env.TERRAFORM_STATE_BUCKET_REGION }}
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}

  infracost:
    name: Infracost (Terraform Cost Estimation)
    needs: [detect-metadata, build, synth]
    runs-on: ubuntu-24.04
    # if: >
    #   ${{
    #   github.event_name == 'pull_request' &&
    #   github.event.action != 'closed' && !contains(github.event.head_commit.message, '[skip-jobs]') &&
    #   needs.detect-metadata.outputs.platform == 'tf'}}
    if: false
    environment: dev
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Terraform files
        id: tf-check
        run: |
          if ! find lib -maxdepth 1 -name "*.tf" | grep -q .; then
            echo "No Terraform files found in lib/. Skipping Infracost job."
            echo "skip_infracost=true" >> $GITHUB_ENV
            exit 0
          fi

      - name: Setup Terraform
        if: env.skip_infracost != 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Setup Infracost
        if: env.skip_infracost != 'true'
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Setup Environment (variables)
        if: env.skip_infracost != 'true'
        run: |
          echo "TERRAFORM_STATE_BUCKET=${{ env.TERRAFORM_STATE_BUCKET }}" >> $GITHUB_ENV
          echo "TERRAFORM_STATE_BUCKET_REGION=${{ env.TERRAFORM_STATE_BUCKET_REGION }}" >> $GITHUB_ENV
          echo "ENVIRONMENT_SUFFIX=${{ env.ENVIRONMENT_SUFFIX }}" >> $GITHUB_ENV

      - name: Terraform Init
        if: env.skip_infracost != 'true'
        working-directory: lib
        run: terraform init

      - name: Terraform Plan
        if: env.skip_infracost != 'true'
        working-directory: lib
        run: terraform plan -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Convert plan to JSON
        if: env.skip_infracost != 'true'
        working-directory: lib
        run: terraform show -json tfplan > plan.json
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Run Infracost breakdown
        if: env.skip_infracost != 'true'
        working-directory: lib
        run: infracost breakdown --path=plan.json --format=json --out-file=../infracost.json
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Post Infracost comment
        if: env.skip_infracost != 'true'
        working-directory: lib
        run: |
          infracost comment github --path=../infracost.json \
                                 --pull-request=${{ github.event.pull_request.number }} \
                                 --repo=${{ github.repository }} \
                                 --github-token=${{ secrets.GITHUB_TOKEN }} \
                                 --behavior=update
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}
  analysis:
    name: Analysis
    runs-on: ubuntu-24.04
    needs: [detect-metadata, claude-review-prompt-quality, lint, unit-tests]
    if: |
      always() &&
      needs.claude-review-prompt-quality.result == 'success' &&
      needs.lint.result == 'success' &&
      needs.unit-tests.result == 'success' &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label)
    environment: dev
    env:
      AWS_ENDPOINT_URL: http://127.0.0.1:5001
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'
          is-analysis: 'true'

      - name: Run analysis
        run: ./scripts/analysis.sh
        env:
          IAC_ANALYSIS_SUBJECT_LABEL: ${{ needs.detect-metadata.outputs.analysis_subject_label }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}

      - name: Upload analysis results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: lib/analysis-results.txt
          if-no-files-found: warn

  cicd-pipeline-optimization:
    name: CICD Pipeline Optimization
    runs-on: ubuntu-24.04
    needs:
      [detect-metadata, claude-review-prompt-quality, validate-commit-message]
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' && !contains(github.event.head_commit.message, '[skip-jobs]') && contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label) && needs.claude-review-prompt-quality.result == 'success' && needs.validate-commit-message.result == 'success' }}
    environment: dev
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Execute CI/CD Pipeline Script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: ./scripts/cicd-pipeline.sh

      - name: Upload Pipeline Configuration
        uses: actions/upload-artifact@v4
        with:
          name: cicd-pipeline-config
          path: lib/ci-cd.yml
          if-no-files-found: error

  deploy:
    name: Deploy
    runs-on: ubuntu-24.04
    needs: [detect-metadata, claude-review-prompt-quality, synth]
    if: |
      always() &&
      needs.claude-review-prompt-quality.result == 'success' &&
      (needs.synth.result == 'success' || needs.synth.result == 'skipped') &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}
          provider: ${{ needs.detect-metadata.outputs.provider }}

      - name: Download build artifacts (dist/)
        if: ${{ needs.detect-metadata.outputs.language == 'ts' || needs.detect-metadata.outputs.language == 'js' }}
        uses: actions/download-artifact@v4
        with:
          name: build-dist
          path: dist

      - name: Validate Stack Naming Before Deploy
        run: ./scripts/ci-validate-stack-naming-before-deploy.sh

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      # Terraform State Management Setup
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      # (Removed DynamoDB lock table step per PR review)

      - name: Bootstrap (AWS only)
        if: ${{ needs.detect-metadata.outputs.provider != 'localstack' }}
        run: ./scripts/bootstrap.sh
        env:
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          REPOSITORY: ${{ github.repository }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}

      - name: Skip Bootstrap (LocalStack)
        if: ${{ needs.detect-metadata.outputs.provider == 'localstack' }}
        run: |
          echo "‚ÑπÔ∏è Skipping AWS bootstrap for LocalStack deployment"
          echo "LocalStack bootstrap will be handled during deployment"

      - name: Start LocalStack (if provider is localstack)
        if: ${{ needs.detect-metadata.outputs.provider == 'localstack' }}
        run: ./scripts/localstack-start-ci.sh
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}

      - name: Deploy
        run: ./scripts/ci-deploy-conditional.sh
        env:
          PROVIDER: ${{ needs.detect-metadata.outputs.provider }}
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          REPOSITORY: ${{ github.repository }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}
          PR_NUMBER: ${{ github.event.number || 'unknown' }}
          TEAM: ${{ needs.detect-metadata.outputs.team }}
          TERRAFORM_STATE_BUCKET: ${{ env.TERRAFORM_STATE_BUCKET }}
          TERRAFORM_STATE_BUCKET_REGION: ${{ env.TERRAFORM_STATE_BUCKET_REGION }}
          TERRAFORM_STATE_BUCKET_KEY: ${{ env.ENVIRONMENT_SUFFIX }}
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}
          CURRENT_ACCOUNT_ID: ${{ env.CURRENT_ACCOUNT_ID }}

      # Note: Deployment outputs are now collected by the deploy.sh script

      - name: Upload Deployment Outputs
        uses: actions/upload-artifact@v4
        with:
          name: cfn-outputs
          path: |
            cfn-outputs/
            cdk-stacks.json

  iac-optimization:
    name: IaC Optimization
    runs-on: ubuntu-24.04
    needs: [detect-metadata, deploy]
    if: |
      always() &&
      needs.deploy.result == 'success' &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      contains(needs.detect-metadata.outputs.subject_labels, 'IaC Optimization')
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}
          provider: ${{ needs.detect-metadata.outputs.provider }}

      - name: Download Deployment Outputs
        uses: actions/download-artifact@v4
        with:
          name: cfn-outputs
          path: .

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Check and Run IaC Optimization
        run: ./scripts/optimize.sh
        env:
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}

  lint:
    name: Lint
    runs-on: ubuntu-24.04
    needs: [detect-metadata, claude-review-prompt-quality, build]
    if: |
      always() &&
      needs.claude-review-prompt-quality.result == 'success' &&
      needs.build.result == 'success' &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)
    environment: qa
    outputs:
      platform: ${{ needs.detect-metadata.outputs.platform }}
      language: ${{ needs.detect-metadata.outputs.language }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}

      # Python setup is handled by the setup-environment action

      - name: Run Linting
        run: ./scripts/lint.sh

  unit-tests:
    name: Unit Testing
    runs-on: ubuntu-24.04
    needs: [detect-metadata, lint]
    if: |
      always() &&
      needs.lint.result == 'success' &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)
    environment: qa
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}

      - name: Run unit tests
        run: ./scripts/unit-tests.sh

      - name: Prepare coverage reports for Java projects
        if: ${{ needs.detect-metadata.outputs.language == 'java' }}
        run: ./scripts/ci-prepare-java-coverage.sh
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage/
            cov.json

  integration-tests-live:
    name: Integration Tests (Live)
    runs-on: ubuntu-24.04
    needs: [detect-metadata, lint, unit-tests, deploy]
    environment: qa
    if: |
      always() &&
      needs.deploy.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      (github.event_name == 'pull_request' && github.event.action != 'closed' || github.event_name == 'workflow_dispatch') &&
      !contains(github.event.head_commit.message, '[skip-jobs]') &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) &&
      !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}
          provider: ${{ needs.detect-metadata.outputs.provider }}

      - name: Download Deployment Outputs
        uses: actions/download-artifact@v4
        with:
          name: cfn-outputs
          path: .

      - name: Configure AWS (if provider is aws)
        if: ${{ needs.detect-metadata.outputs.provider == 'aws' || needs.detect-metadata.outputs.provider == '' }}
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Start LocalStack (if provider is localstack)
        if: ${{ needs.detect-metadata.outputs.provider == 'localstack' }}
        run: ./scripts/localstack-start-ci.sh
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}

      - name: Run integration tests
        run: ./scripts/ci-integration-tests-conditional.sh
        env:
          PROVIDER: ${{ needs.detect-metadata.outputs.provider }}
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION || 'us-east-1' }}
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          CI: '1' # Set CI for the entire step
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}

  claude-code-action:
    runs-on: ubuntu-24.04
    name: 'Claude Review'
    needs:
      [
        detect-metadata,
        claude-review-prompt-quality,
        integration-tests-live,
        analysis,
        cicd-pipeline-optimization,
      ]
    # For Infrastructure Analysis/Monitoring OR CI/CD Pipeline: Allow int-tests to be skipped
    # For all other subject labels: Require int-tests to succeed
    if: |
      always() && !cancelled() &&
      github.event_name == 'pull_request' &&
      (needs.analysis.result == 'success' || needs.analysis.result == 'skipped') &&
      (needs.cicd-pipeline-optimization.result == 'success' || needs.cicd-pipeline-optimization.result == 'skipped') &&
      needs.claude-review-prompt-quality.result == 'success' &&
      (
        (
          (contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) ||
           contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)) &&
          (needs.integration-tests-live.result == 'success' || needs.integration-tests-live.result == 'skipped')
        ) ||
        (
          !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) &&
          !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label) &&
          needs.integration-tests-live.result == 'success'
        )
      )
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.pull_request.number }}/head

      - name: Check for required documentation files
        id: docs-check
        run: ./scripts/ci-check-required-docs.sh

      - name: Verify IaC Program Optimization script exists
        if: ${{ contains(needs.detect-metadata.outputs.subject_labels, 'Infrastructure Analysis/Monitoring') }}
        run: ./scripts/ci-verify-iac-optimization-script.sh

      - name: Determine review type
        id: review-type
        run: ./scripts/ci-determine-review-type.sh

      - name: Prepare Claude system prompt
        id: prepare-prompt
        run: ./scripts/ci-prepare-claude-prompt.sh

      - name: Run Claude PR Review Action
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: 'Bash,Read,Write,Edit,MultiEdit,Glob,Grep,LS,Task,TodoWrite'
          trigger_phrase: ''
          custom_instructions: '${{ env.SYSTEM_PROMPT_CONTENT }}'

      - name: Verify metadata.json Updated
        id: verify_metadata
        run: ./scripts/ci-verify-metadata-updated.sh

      - name: Verify Claude Posted Review Comment
        id: verify_comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: ./scripts/ci-verify-claude-comment.sh

      - name: Check for Critical Issues in Claude Review
        id: check_critical
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: ./scripts/ci-check-critical-issues.sh

      - name: Extract Claude Quality Score from PR Comment
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: ./scripts/ci-extract-quality-score.sh

      - name: Verify Claude Ran Validation Script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: ./scripts/ci-verify-validation-ran.sh

      - name: Enforce Quality Threshold
        id: quality_gate
        env:
          QUALITY_SCORE: ${{ steps.extract.outputs.quality_score }}
        run: ./scripts/ci-enforce-quality-gate.sh

      - name: Upload updated metadata.json
        uses: actions/upload-artifact@v4
        with:
          name: updated-metadata
          path: metadata.json
          if-no-files-found: warn
    outputs:
      quality_score: ${{ steps.extract.outputs.quality_score }}

  cleanup:
    name: Cleanup (Destroy Resources)
    runs-on: ubuntu-24.04
    needs:
      [
        detect-metadata,
        integration-tests-live,
        claude-code-action,
        analysis,
        cicd-pipeline-optimization,
      ]
    # Cleanup runs when:
    # 1. Claude review succeeded
    # 2. For Analysis/CI/CD tasks: int-tests can be success OR skipped
    # 3. For normal infra tasks: int-tests MUST be success (not skipped)
    if: |
      always() && !cancelled() &&
      needs.claude-code-action.result == 'success' &&
      (
        (needs.integration-tests-live.result == 'success') ||
        (needs.integration-tests-live.result == 'skipped' && 
         (contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) ||
          contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label)))
      ) &&
      ((github.event_name == 'pull_request' && github.event.action != 'closed') || 
       (github.event_name == 'workflow_dispatch' && !inputs.skip_cleanup)) &&
      !contains(github.event.head_commit.message, '[skip-jobs]')
    environment: qa
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if cleanup is needed
        id: check-cleanup
        run: ./scripts/ci-check-cleanup-needed.sh
        env:
          SUBJECT_LABELS: ${{ needs.detect-metadata.outputs.subject_labels }}
          ANALYSIS_LABEL: ${{ needs.detect-metadata.outputs.analysis_subject_label }}
          CICD_LABEL: ${{ needs.detect-metadata.outputs.cicd_pipeline_subject_label }}

      - name: Setup Environment
        if: steps.check-cleanup.outputs.needs_cleanup == 'true'
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'
          platform: ${{ needs.detect-metadata.outputs.platform }}
          language: ${{ needs.detect-metadata.outputs.language }}

      - name: Configure AWS
        if: steps.check-cleanup.outputs.needs_cleanup == 'true'
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Destroy Resources (cleanup any leftover resources)
        if: steps.check-cleanup.outputs.needs_cleanup == 'true'
        run: ./scripts/destroy.sh
        env:
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          TF_VAR_environmentSuffix: ${{ env.ENVIRONMENT_SUFFIX }}
          TERRAFORM_STATE_BUCKET: ${{ env.TERRAFORM_STATE_BUCKET }}
          TERRAFORM_STATE_BUCKET_REGION: ${{ env.TERRAFORM_STATE_BUCKET_REGION }}
          TERRAFORM_STATE_BUCKET_KEY: ${{ env.ENVIRONMENT_SUFFIX }}
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}

      - name: Cleanup Complete
        run: |
          if [ "${{ steps.check-cleanup.outputs.needs_cleanup }}" == "true" ]; then
            echo "‚úÖ Infrastructure cleanup completed"
          else
            echo "‚úÖ No cleanup needed - proceeding to archive"
          fi
  debug-claude-outputs:
    name: Debug Claude outputs
    runs-on: ubuntu-24.04
    needs: [claude-code-action]
    if: always()
    steps:
      - name: Dump needs info
        run: |
          echo "needs.claude-code-action.result=${{ needs.claude-code-action.result }}"
          echo "needs.claude-code-action.outputs.quality_score='${{ needs.claude-code-action.outputs.quality_score }}'"
          echo "---- full needs json ----"
          echo '${{ toJson(needs) }}'

  claude-review-ideal-response:
    runs-on: ubuntu-24.04
    name: 'Claude Review: IDEAL_RESPONSE Code Validation'
    needs: [detect-metadata, cleanup, claude-code-action]
    if: ${{ always() && !cancelled() && needs.cleanup.result == 'success' && needs.claude-code-action.result == 'success' && needs.detect-metadata.result == 'success' && ((github.event_name == 'pull_request' && github.event.action != 'closed') || (github.event_name == 'workflow_dispatch')) && !contains(github.event.head_commit.message, '[skip-jobs]') }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if ideal response review file exists
        id: check-ideal-response-file
        run: |
          if [ -f .claude/prompts/claude-ideal-response-review.md ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Ideal response review file found"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Ideal response review file not found - This is a required file for IDEAL_RESPONSE validation"
            exit 1
          fi

      - name: Prepare Claude prompt for IDEAL_RESPONSE validation
        if: steps.check-ideal-response-file.outputs.file_exists == 'true'
        id: prepare-ideal-response-prompt
        run: |
          PROMPT=$(cat .claude/prompts/claude-ideal-response-review.md)
          {
            echo 'CLAUDE_IDEAL_RESPONSE_PROMPT<<PROMPT_EOF'
            echo "$PROMPT"
            echo 'PROMPT_EOF'
          } >> $GITHUB_ENV

      - name: Run Claude IDEAL_RESPONSE Code Validation
        if: steps.check-ideal-response-file.outputs.file_exists == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: 'Bash,Read,Grep,Glob'
          trigger_phrase: ''
          custom_instructions: '${{ env.CLAUDE_IDEAL_RESPONSE_PROMPT }}'

      - name: Verify Ideal Response Validation Result
        run: |
          echo "Verifying ideal response validation result..."
          # Run the validation script directly to check if it passes
          if bash .claude/scripts/validate-ideal-response.sh; then
            echo "‚úÖ Ideal response validation PASSED"
            exit 0
          else
            echo "‚ùå Ideal response validation FAILED"
            echo "::error::Ideal response validation failed. Check the Claude review comment for details."
            exit 1
          fi

  archive-folders:
    name: Archive Folders and Reset Repository
    runs-on: ubuntu-24.04
    needs:
      [
        detect-metadata,
        cleanup,
        claude-code-action,
        claude-review-ideal-response,
      ]
    environment: stage
    if: ${{ always() && !cancelled() && needs.cleanup.result == 'success' && needs.claude-code-action.result == 'success' && needs.claude-review-ideal-response.result == 'success' && needs.detect-metadata.result == 'success' && ((github.event_name == 'pull_request' && github.event.action != 'closed') || (github.event_name == 'workflow_dispatch')) && !contains(github.event.head_commit.message, '[skip-jobs]') }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          repository: ${{ github.repository }}
          ref: ${{ github.head_ref }}

      - name: Download coverage reports
        if: ${{ !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) && !contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label) }}
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: coverage/

      - name: Download updated metadata
        uses: actions/download-artifact@v4
        with:
          name: updated-metadata
          path: .

      - name: Download analysis results
        if: ${{ contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.analysis_subject_label) }}
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
          path: lib/

      - name: Download CI/CD Pipeline configuration
        if: ${{ contains(needs.detect-metadata.outputs.subject_labels, needs.detect-metadata.outputs.cicd_pipeline_subject_label) }}
        uses: actions/download-artifact@v4
        with:
          name: cicd-pipeline-config
          path: lib/

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Archive folders and reset repository
        env:
          PLATFORM: ${{ needs.detect-metadata.outputs.platform }}
          LANGUAGE: ${{ needs.detect-metadata.outputs.language }}
          PR_NUMBER: ${{ github.event.number }}
          COMMIT_AUTHOR: ${{ github.event.pull_request.user.login || github.actor }}
          DOCKER_S3_LOCATION: ${{ env.DOCKER_S3_LOCATION }}
        run: ./scripts/ci-archive-folders.sh

  upload-task-to-s3:
    name: Upload Task to S3
    runs-on: ubuntu-24.04
    environment: release
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.merged == true }}
    permissions:
      contents: read

    steps:
      - name: Checkout merged code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          repository: ${{ github.repository }}
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Extract platform and language for S3 upload
        id: extract-metadata
        run: ./scripts/ci-extract-s3-metadata.sh
        env:
          PR_NUMBER: ${{ github.event.number }}

      - name: Upload archive folder to S3
        run: ./scripts/ci-upload-archive-to-s3.sh
        env:
          PLATFORM: ${{ steps.extract-metadata.outputs.platform }}
          LANGUAGE: ${{ steps.extract-metadata.outputs.language }}
          PR_NUMBER: ${{ github.event.number }}
          S3_RELEASE_BUCKET_NAME: ${{ env.S3_RELEASE_BUCKET_NAME }}
      - name: Verify S3 upload
        run: |
          PLATFORM="${{ steps.extract-metadata.outputs.platform }}"
          LANGUAGE="${{ steps.extract-metadata.outputs.language }}"
          S3_PREFIX="${PLATFORM}-${LANGUAGE}/Pr${{ github.event.number }}"

          echo "Verifying S3 upload for prefix: $S3_PREFIX"
          aws s3 ls "s3://${{ env.S3_RELEASE_BUCKET_NAME }}/${S3_PREFIX}/" --recursive || echo "No files found or access denied"

  cleanup-pr:
    name: Cleanup (PR Closed)
    runs-on: ubuntu-24.04
    # This job should run regardless of the [skip-jobs] tag since it's for cleanup
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && !github.event.pull_request.merged
    environment: release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION || 'us-east-1' }}

      - name: Destroy Resources (if resources exist)
        run: ./scripts/destroy.sh
        env:
          ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          TERRAFORM_STATE_BUCKET: ${{ env.TERRAFORM_STATE_BUCKET }}
          TERRAFORM_STATE_BUCKET_REGION: ${{ env.TERRAFORM_STATE_BUCKET_REGION }}
          PULUMI_BACKEND_URL: s3://${{ env.PULUMI_STATE_BUCKET }}?region=${{ env.PULUMI_BUCKET_REGION }}
          PULUMI_ORG: ${{ env.PULUMI_ORG }}

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # permissions:
    #   contents: write
    #   issues: write
    #   pull-requests: write
    concurrency:
      group: semantic_release_pipeline
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'false'

      - name: Run semantic-release
        run: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_PAT }}

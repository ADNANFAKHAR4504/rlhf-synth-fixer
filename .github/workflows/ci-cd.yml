name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]

env:
  NODE_VERSION: '22'
  # Use PR number for resource isolation, fallback to 'main' for main branch
  # Prefix with 'pr' to ensure AWS resource names start with a letter
  ENVIRONMENT_SUFFIX: ${{ github.event.number && format('Pr{0}', github.event.number) || 'dev' }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    if: ${{ github.event.action != 'closed' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          include-hidden-files: true # <-- This one!
          path: |
            bin/
            lib/
            package*.json
            tsconfig.json
            cdk.json

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.action != 'closed' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'

      - name: Run ESLint
        run: npm run lint

  cdk-synth:
    name: CDK Synth
    runs-on: ubuntu-latest
    needs: lint
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Synth
        run: npm run cdk:synth
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}

      - name: Upload CDK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cdk-artifacts
          path: cdk.out/

  unit-tests:
    name: Unit Testing
    runs-on: ubuntu-latest
    needs: cdk-synth
    if: ${{ github.event.action != 'closed' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'

      - name: Run unit tests
        run: npm run test:unit

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/

  cdk-deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    needs: unit-tests
    if: ${{ github.event_name == 'pull_request' && github.event.action != 'closed' }}
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'
          download-cdk-artifacts: 'true'

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Bootstrap
        run: npm run cdk:bootstrap
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          REPOSITORY: ${{ github.repository }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}

      - name: CDK Deploy
        run: npm run cdk:deploy
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}
          REPOSITORY: ${{ github.repository }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}

      - name: Get CDK Outputs
        run: |
          npx cdk list --json > cdk-stacks.json
          mkdir -p cdk-outputs

          echo "Getting all CloudFormation stacks..."
          aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?contains(StackName, \`TapStack${{ env.ENVIRONMENT_SUFFIX }}\`)].StackName" --output text > cf-stacks.txt

          # Initialize consolidated outputs file
          echo "{}" > cdk-outputs/all-outputs.json

          if [ -s cf-stacks.txt ]; then
            for stack in $(cat cf-stacks.txt); do
              echo "Getting outputs for CloudFormation stack: $stack"
              
              # Get outputs for this stack
              aws cloudformation describe-stacks --stack-name "$stack" --query 'Stacks[0].Outputs' --output json > "temp-${stack}-outputs.json" 2>/dev/null || echo "No outputs for $stack"
              
              if [ -f "temp-${stack}-outputs.json" ]; then
                output_count=$(jq 'length' "temp-${stack}-outputs.json" 2>/dev/null || echo "0")
                
                if [ "$output_count" != "0" ] && [ "$output_count" != "null" ]; then
                  
                  # Merge outputs into consolidated file
                  # Create a temporary file with stack name as key and outputs as value
                  jq -n --arg stack "$stack" --slurpfile outputs "temp-${stack}-outputs.json" '{($stack): $outputs[0]}' > "temp-stack.json"
                  
                  # Merge with existing consolidated outputs
                  jq -s '.[0] * .[1]' cdk-outputs/all-outputs.json temp-stack.json > temp-merged.json
                  mv temp-merged.json cdk-outputs/all-outputs.json
                  
                  # Also flatten all outputs into a single level for easier access
                  if [ ! -f "cdk-outputs/flat-outputs.json" ]; then
                    echo "{}" > cdk-outputs/flat-outputs.json
                  fi
                  
                  # Add each output key-value pair to flat outputs
                  jq -r '.[] | "\(.OutputKey)=\(.OutputValue)"' "temp-${stack}-outputs.json" | while IFS='=' read -r key value; do
                    jq --arg key "$key" --arg value "$value" '. + {($key): $value}' cdk-outputs/flat-outputs.json > temp-flat.json
                    mv temp-flat.json cdk-outputs/flat-outputs.json
                  done
                fi
                
                # Clean up temporary file
                rm -f "temp-${stack}-outputs.json"
              fi
            done
            
            # Clean up temporary files
            rm -f temp-stack.json temp-merged.json temp-flat.json
          else
            echo "No TapStack CloudFormation stacks found"
          fi

          echo "Consolidated outputs:"
          cat cdk-outputs/all-outputs.json || echo "No consolidated outputs"

          echo "Flat outputs:"
          cat cdk-outputs/flat-outputs.json || echo "No flat outputs"

      - name: Upload CDK Outputs
        uses: actions/upload-artifact@v4
        with:
          name: cdk-outputs
          path: |
            cdk-outputs/
            cdk-stacks.json

  # mocked-integration-tests:
  #   name: Mocked Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: unit-tests

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Environment
  #       uses: ./.github/actions/setup-environment
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         download-artifacts: "true"

  #     - name: Run mocked integration tests
  #       run: npm run test:integration
  #       env:
  #         # Mock environment variables for testing
  #         API_GATEWAY_ENDPOINT: "https://mock-api.example.com/prod"
  #         READ_ONLY_API_KEY: "mock-readonly-key"
  #         ADMIN_API_KEY: "mock-admin-key"

  integration-tests-live:
    name: Integration Tests (Live)
    runs-on: ubuntu-latest
    needs: cdk-deploy
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          download-artifacts: 'true'

      - name: Download CDK Outputs
        uses: actions/download-artifact@v4
        with:
          name: cdk-outputs
          path: .

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Run integration tests against live environment
        run: npm run test:integration
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}

  archive-folders:
    name: Archive Folders and Reset Repository
    runs-on: ubuntu-latest
    needs: integration-tests-live
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Manual Approval for Archive
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.actor }},hernanmog-turing
          minimum-approvals: 1
          issue-title: 'Archive folders for PR #${{ github.event.number }}'
          issue-body: 'Please approve or deny the archiving of lib/, bin/, and test/ folders for PR #${{ github.event.number }}. This will move the folders to archive/Pr${{ github.event.number }}/ and commit the changes to the feature branch.'
          exclude-workflow-initiator-as-approver: false
          fail-on-denial: true
          timeout-minutes: 5

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          repository: ${{ github.repository }}
          ref: ${{ github.head_ref }}

      - name: Archive folders and reset repository
        run: |
          # Configure Git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Create archive directory with PR number if it doesn't exist
          mkdir -p archive/Pr${{ github.event.number }}

          # Move folders to archive
          if [ -d "lib" ]; then
            mv lib/ archive/Pr${{ github.event.number }}/
            echo "Moved lib/ to archive"
          fi

          if [ -d "bin" ]; then
            mv bin/ archive/Pr${{ github.event.number }}/
            echo "Moved bin/ to archive"
          fi

          if [ -d "test" ]; then
            mv test/ archive/Pr${{ github.event.number }}/
            echo "Moved test/ to archive"
          fi

          # Check if there are changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit - no folders found to archive"
          else
            git add -A
            git commit -m "Archive build artifacts for PR ${{ github.event.number }} [skip ci]"
            git push origin HEAD
            echo "Archive committed to current branch"
          fi

  cleanup:
    name: CDK Destroy (Cleanup)
    runs-on: ubuntu-latest
    needs: [integration-tests-live]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Destroy (cleanup any leftover resources)
        run: |
          # Try to destroy any leftover resources from PRs, but don't fail if they don't exist
          npm run cdk:destroy || echo "No resources to destroy or destruction failed"
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}

  cleanup-pr:
    name: CDK Destroy (PR Cleanup)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure AWS
        uses: ./.github/actions/configure-aws
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Destroy (if resources exist)
        run: |
          # Try to destroy resources, but don't fail if they don't exist
          npm run cdk:destroy || echo "No resources to destroy or destruction failed"
        env:
          CDK_CONTEXT_ENVIRONMENT_SUFFIX: ${{ env.ENVIRONMENT_SUFFIX }}

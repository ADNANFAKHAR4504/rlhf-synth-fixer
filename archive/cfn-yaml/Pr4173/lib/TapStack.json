{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Multi-AZ Real-time Data Analytics Pipeline for Financial Technology Payment Processing",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "General Configuration"
                    },
                    "Parameters": [
                        "EnvironmentName"
                    ]
                },
                {
                    "Label": {
                        "default": "Kinesis Data Stream Settings"
                    },
                    "Parameters": [
                        "KinesisShardCount",
                        "DataRetentionHours"
                    ]
                },
                {
                    "Label": {
                        "default": "DynamoDB Capacity Settings"
                    },
                    "Parameters": [
                        "DynamoDBReadCapacity",
                        "DynamoDBWriteCapacity"
                    ]
                },
                {
                    "Label": {
                        "default": "Lambda Configuration"
                    },
                    "Parameters": [
                        "LambdaMemorySize"
                    ]
                }
            ],
            "ParameterLabels": {
                "EnvironmentName": {
                    "default": "Deployment Environment"
                },
                "KinesisShardCount": {
                    "default": "Kinesis Stream Shard Count"
                },
                "DataRetentionHours": {
                    "default": "Kinesis Data Retention (Hours)"
                },
                "DynamoDBReadCapacity": {
                    "default": "DynamoDB Read Capacity Units"
                },
                "DynamoDBWriteCapacity": {
                    "default": "DynamoDB Write Capacity Units"
                },
                "LambdaMemorySize": {
                    "default": "Lambda Memory Size (MB)"
                }
            }
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Type": "String",
            "Default": "prod",
            "AllowedValues": [
                "dev",
                "stage",
                "prod"
            ],
            "Description": "Environment name for resource tagging",
            "AllowedPattern": "^[a-zA-Z0-9]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters"
        },
        "KinesisShardCount": {
            "Type": "Number",
            "Default": 3,
            "MinValue": 1,
            "MaxValue": 100,
            "Description": "Number of shards for Kinesis Data Stream"
        },
        "DynamoDBReadCapacity": {
            "Type": "Number",
            "Default": 100,
            "MinValue": 5,
            "MaxValue": 40000,
            "Description": "Read capacity units for DynamoDB table"
        },
        "DynamoDBWriteCapacity": {
            "Type": "Number",
            "Default": 100,
            "MinValue": 5,
            "MaxValue": 40000,
            "Description": "Write capacity units for DynamoDB table"
        },
        "LambdaMemorySize": {
            "Type": "Number",
            "Default": 1024,
            "MinValue": 128,
            "MaxValue": 10240,
            "Description": "Memory size for Lambda function in MB"
        },
        "DataRetentionHours": {
            "Type": "Number",
            "Default": 24,
            "MinValue": 24,
            "MaxValue": 168,
            "Description": "Data retention period in hours for Kinesis stream"
        }
    },
    "Mappings": {
        "SubnetConfig": {
            "VPC": {
                "CIDR": "10.0.0.0/16"
            },
            "PrivateSubnet1": {
                "CIDR": "10.0.1.0/24"
            },
            "PrivateSubnet2": {
                "CIDR": "10.0.2.0/24"
            },
            "PrivateSubnet3": {
                "CIDR": "10.0.3.0/24"
            }
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "VPC",
                        "CIDR"
                    ]
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-analytics-vpc"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet1",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet2",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet3",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-3"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-routes"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "PrivateSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                }
            }
        },
        "NetworkAcl": {
            "Type": "AWS::EC2::NetworkAcl",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-network-acl"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "NetworkAclEntryInbound": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "NetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "RuleAction": "allow",
                "CidrBlock": "10.0.0.0/16"
            }
        },
        "NetworkAclEntryOutbound": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "NetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "Egress": true,
                "RuleAction": "allow",
                "CidrBlock": "0.0.0.0/0"
            }
        },
        "SubnetNetworkAclAssociation1": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "NetworkAclId": {
                    "Ref": "NetworkAcl"
                }
            }
        },
        "SubnetNetworkAclAssociation2": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "NetworkAclId": {
                    "Ref": "NetworkAcl"
                }
            }
        },
        "SubnetNetworkAclAssociation3": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                },
                "NetworkAclId": {
                    "Ref": "NetworkAcl"
                }
            }
        },
        "VPCEndpointSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for VPC endpoints",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "10.0.0.0/16"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-vpc-endpoint-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "S3VPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "VpcEndpointType": "Gateway",
                "RouteTableIds": [
                    {
                        "Ref": "PrivateRouteTable"
                    }
                ]
            }
        },
        "KinesisVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.kinesis-streams"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "DynamoDBVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.dynamodb"
                },
                "VpcEndpointType": "Gateway",
                "RouteTableIds": [
                    {
                        "Ref": "PrivateRouteTable"
                    }
                ]
            }
        },
        "LambdaVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.lambda"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "KinesisDataStream": {
            "Type": "AWS::Kinesis::Stream",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-payment-transactions-stream"
                },
                "ShardCount": {
                    "Ref": "KinesisShardCount"
                },
                "RetentionPeriodHours": {
                    "Ref": "DataRetentionHours"
                },
                "StreamModeDetails": {
                    "StreamMode": "PROVISIONED"
                },
                "StreamEncryption": {
                    "EncryptionType": "KMS",
                    "KeyId": "alias/aws/kinesis"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-payment-stream"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "TransactionMetadataTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "${EnvironmentName}-transaction-metadata"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "transactionId",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "timestamp",
                        "AttributeType": "N"
                    },
                    {
                        "AttributeName": "merchantId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "transactionId",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
                "GlobalSecondaryIndexes": [
                    {
                        "IndexName": "MerchantIndex",
                        "KeySchema": [
                            {
                                "AttributeName": "merchantId",
                                "KeyType": "HASH"
                            },
                            {
                                "AttributeName": "timestamp",
                                "KeyType": "RANGE"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        },
                        "ProvisionedThroughput": {
                            "ReadCapacityUnits": {
                                "Ref": "DynamoDBReadCapacity"
                            },
                            "WriteCapacityUnits": {
                                "Ref": "DynamoDBWriteCapacity"
                            }
                        }
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": {
                        "Ref": "DynamoDBReadCapacity"
                    },
                    "WriteCapacityUnits": {
                        "Ref": "DynamoDBWriteCapacity"
                    }
                },
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": "alias/aws/dynamodb"
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-metadata-table"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "ProcessedDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-processed-transactions-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": "alias/aws/s3"
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                },
                                {
                                    "TransitionInDays": 90,
                                    "StorageClass": "INTELLIGENT_TIERING"
                                },
                                {
                                    "TransitionInDays": 365,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        },
                        {
                            "Id": "DeleteOldVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 90
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-data-bucket"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda function",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-lambda-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-execution-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "DeadLetterQueuePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:SendMessage",
                                        "sqs:GetQueueAttributes",
                                        "sqs:GetQueueUrl"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ProcessorDLQ",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "KinesisAccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kinesis:DescribeStream",
                                        "kinesis:GetShardIterator",
                                        "kinesis:GetRecords",
                                        "kinesis:ListShards",
                                        "kinesis:DescribeStreamSummary",
                                        "kinesis:ListStreams"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KinesisDataStream",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "DynamoDBAccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:Query",
                                        "dynamodb:BatchWriteItem"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "TransactionMetadataTable",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${TransactionMetadataTable.Arn}/index/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "S3AccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:PutObjectAcl",
                                        "s3:GetObject",
                                        "s3:GetObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ProcessedDataBucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-lambda-role"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "ProcessorLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentName}-transaction-processor"
                },
                "Runtime": "python3.9",
                "Handler": "index.handler",
                "MemorySize": {
                    "Ref": "LambdaMemorySize"
                },
                "Timeout": 60,
                "TracingConfig": {
                    "Mode": "Active"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        },
                        {
                            "Ref": "PrivateSubnet3"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DYNAMODB_TABLE": {
                            "Ref": "TransactionMetadataTable"
                        },
                        "S3_BUCKET": {
                            "Ref": "ProcessedDataBucket"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentName"
                        }
                    }
                },
                "DeadLetterConfig": {
                    "TargetArn": {
                        "Fn::GetAtt": [
                            "ProcessorDLQ",
                            "Arn"
                        ]
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom datetime import datetime\nimport base64\n\ndynamodb = boto3.resource('dynamodb')\ns3 = boto3.client('s3')\n\ndef handler(event, context):\n    table = dynamodb.Table(os.environ['DYNAMODB_TABLE'])\n    bucket = os.environ['S3_BUCKET']\n    \n    for record in event['Records']:\n        try:\n            payload = base64.b64decode(record['kinesis']['data']).decode('utf-8')\n            transaction = json.loads(payload)\n            \n            transaction_id = transaction.get('transactionId')\n            timestamp = int(datetime.now().timestamp())\n            \n            table.put_item(\n                Item={\n                    'transactionId': transaction_id,\n                    'timestamp': timestamp,\n                    'merchantId': transaction.get('merchantId', 'unknown'),\n                    'amount': transaction.get('amount', 0),\n                    'status': 'processed'\n                }\n            )\n            \n            s3_key = f\"transactions/{datetime.now().strftime('%Y/%m/%d')}/{transaction_id}.json\"\n            s3.put_object(\n                Bucket=bucket,\n                Key=s3_key,\n                Body=json.dumps(transaction),\n                ContentType='application/json'\n            )\n            \n        except Exception as e:\n            print(f\"Error processing record: {str(e)}\")\n            raise\n    \n    return {'statusCode': 200, 'body': json.dumps('Success')}\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-processor"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "ProcessorDLQ": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": {
                    "Fn::Sub": "${EnvironmentName}-processor-dlq"
                },
                "MessageRetentionPeriod": 1209600,
                "KmsMasterKeyId": "alias/aws/sqs",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-dlq"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "KinesisEventSourceMapping": {
            "Type": "AWS::Lambda::EventSourceMapping",
            "Properties": {
                "EventSourceArn": {
                    "Fn::GetAtt": [
                        "KinesisDataStream",
                        "Arn"
                    ]
                },
                "FunctionName": {
                    "Fn::GetAtt": [
                        "ProcessorLambdaFunction",
                        "Arn"
                    ]
                },
                "StartingPosition": "LATEST",
                "BatchSize": 100,
                "MaximumBatchingWindowInSeconds": 5,
                "ParallelizationFactor": 10,
                "MaximumRecordAgeInSeconds": 3600,
                "BisectBatchOnFunctionError": true,
                "MaximumRetryAttempts": 3,
                "DestinationConfig": {
                    "OnFailure": {
                        "Destination": {
                            "Fn::GetAtt": [
                                "ProcessorDLQ",
                                "Arn"
                            ]
                        }
                    }
                }
            }
        },
        "KinesisReadThroughputAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-kinesis-read-throughput"
                },
                "AlarmDescription": "Alert when Kinesis read throughput is exceeded",
                "MetricName": "GetRecords.Success",
                "Namespace": "AWS/Kinesis",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 10000,
                "ComparisonOperator": "LessThanThreshold",
                "Dimensions": [
                    {
                        "Name": "StreamName",
                        "Value": {
                            "Ref": "KinesisDataStream"
                        }
                    }
                ],
                "TreatMissingData": "breaching"
            }
        },
        "KinesisWriteThroughputAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-kinesis-write-throughput"
                },
                "AlarmDescription": "Alert when Kinesis write throughput is exceeded",
                "MetricName": "IncomingRecords",
                "Namespace": "AWS/Kinesis",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 60000,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "StreamName",
                        "Value": {
                            "Ref": "KinesisDataStream"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "KinesisIteratorAgeAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-kinesis-iterator-age"
                },
                "AlarmDescription": "Alert when Kinesis iterator age is too high",
                "MetricName": "GetRecords.IteratorAgeMilliseconds",
                "Namespace": "AWS/Kinesis",
                "Statistic": "Maximum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 60000,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "StreamName",
                        "Value": {
                            "Ref": "KinesisDataStream"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-errors"
                },
                "AlarmDescription": "Alert when Lambda function has errors",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 10,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "ProcessorLambdaFunction"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaThrottleAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-throttles"
                },
                "AlarmDescription": "Alert when Lambda function is throttled",
                "MetricName": "Throttles",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "ProcessorLambdaFunction"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaDurationAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-duration"
                },
                "AlarmDescription": "Alert when Lambda function duration is too high",
                "MetricName": "Duration",
                "Namespace": "AWS/Lambda",
                "Statistic": "Average",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 30000,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "ProcessorLambdaFunction"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBReadCapacityAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-dynamodb-read-capacity"
                },
                "AlarmDescription": "Alert when DynamoDB read capacity is exceeded",
                "MetricName": "ConsumedReadCapacityUnits",
                "Namespace": "AWS/DynamoDB",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": {
                    "Ref": "DynamoDBReadCapacity"
                },
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "TransactionMetadataTable"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBWriteCapacityAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-dynamodb-write-capacity"
                },
                "AlarmDescription": "Alert when DynamoDB write capacity is exceeded",
                "MetricName": "ConsumedWriteCapacityUnits",
                "Namespace": "AWS/DynamoDB",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": {
                    "Ref": "DynamoDBWriteCapacity"
                },
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "TransactionMetadataTable"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBThrottledRequestsAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-dynamodb-throttled-requests"
                },
                "AlarmDescription": "Alert when DynamoDB requests are throttled",
                "MetricName": "SystemErrors",
                "Namespace": "AWS/DynamoDB",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "TransactionMetadataTable"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DLQMessagesAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-dlq-messages"
                },
                "AlarmDescription": "Alert when messages are in DLQ",
                "MetricName": "ApproximateNumberOfMessagesVisible",
                "Namespace": "AWS/SQS",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "QueueName",
                        "Value": {
                            "Fn::GetAtt": [
                                "ProcessorDLQ",
                                "QueueName"
                            ]
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-VPCId"
                }
            }
        },
        "KinesisStreamArn": {
            "Description": "Kinesis Data Stream ARN",
            "Value": {
                "Fn::GetAtt": [
                    "KinesisDataStream",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-KinesisStreamArn"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "DynamoDB Table Name",
            "Value": {
                "Ref": "TransactionMetadataTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-DynamoDBTableName"
                }
            }
        },
        "S3BucketName": {
            "Description": "S3 Bucket Name for processed data",
            "Value": {
                "Ref": "ProcessedDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-S3BucketName"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "Lambda Function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "ProcessorLambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-LambdaFunctionArn"
                }
            }
        },
        "DLQUrl": {
            "Description": "Dead Letter Queue URL",
            "Value": {
                "Ref": "ProcessorDLQ"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-DLQUrl"
                }
            }
        }
    }
}
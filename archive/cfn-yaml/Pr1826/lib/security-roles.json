{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Additional Security Roles and Policies for MFA and Passkey Support",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource naming"
        },
        "SecurityKMSKeyArn": {
            "Type": "String",
            "Description": "ARN of the security KMS key"
        }
    },
    "Resources": {
        "MFASetupGroup": {
            "Type": "AWS::IAM::Group",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "MFASetupGroup-${EnvironmentSuffix}"
                },
                "Policies": [
                    {
                        "PolicyName": "MFASetupPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:ListMFADevices",
                                        "iam:EnableMFADevice",
                                        "iam:CreateVirtualMFADevice",
                                        "iam:DeleteVirtualMFADevice",
                                        "iam:DeactivateMFADevice",
                                        "iam:ResyncMFADevice",
                                        "iam:ChangePassword",
                                        "iam:UpdateUser",
                                        "iam:GetUser"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:user/*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:mfa/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:ListUsers",
                                        "iam:ListVirtualMFADevices",
                                        "iam:GetAccountPasswordPolicy"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EnforceMFAPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": {
                    "Fn::Sub": "EnforceMFAPolicy-${EnvironmentSuffix}"
                },
                "Description": "Policy that enforces MFA for all users",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowAllUsersToListAccounts",
                            "Effect": "Allow",
                            "Action": [
                                "iam:ListAccountAliases",
                                "iam:ListUsers",
                                "iam:GetAccountSummary"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowIndividualUserToSeeAndManageOnlyTheirOwnAccountInformation",
                            "Effect": "Allow",
                            "Action": [
                                "iam:ChangePassword",
                                "iam:CreateAccessKey",
                                "iam:CreateLoginProfile",
                                "iam:DeleteAccessKey",
                                "iam:DeleteLoginProfile",
                                "iam:GetLoginProfile",
                                "iam:ListAccessKeys",
                                "iam:UpdateAccessKey",
                                "iam:UpdateLoginProfile",
                                "iam:ListSigningCertificates",
                                "iam:DeleteSigningCertificate",
                                "iam:UpdateSigningCertificate",
                                "iam:UploadSigningCertificate",
                                "iam:ListSSHPublicKeys",
                                "iam:GetSSHPublicKey",
                                "iam:DeleteSSHPublicKey",
                                "iam:UpdateSSHPublicKey",
                                "iam:UploadSSHPublicKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "aws:username": "${aws:username}"
                                }
                            }
                        },
                        {
                            "Sid": "AllowIndividualUserToViewAndManageTheirOwnMFA",
                            "Effect": "Allow",
                            "Action": [
                                "iam:CreateVirtualMFADevice",
                                "iam:DeleteVirtualMFADevice",
                                "iam:ListMFADevices",
                                "iam:EnableMFADevice",
                                "iam:ResyncMFADevice",
                                "iam:DeactivateMFADevice"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "aws:username": "${aws:username}"
                                }
                            }
                        },
                        {
                            "Sid": "DenyAllExceptListedIfNoMFA",
                            "Effect": "Deny",
                            "NotAction": [
                                "iam:CreateVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:GetUser",
                                "iam:ListMFADevices",
                                "iam:ListVirtualMFADevices",
                                "iam:ResyncMFADevice",
                                "sts:GetSessionToken",
                                "iam:ChangePassword",
                                "iam:GetAccountPasswordPolicy"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "BoolIfExists": {
                                    "aws:MultiFactorAuthPresent": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "SecurityAuditRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "SecurityAuditRole-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "Bool": {
                                    "aws:MultiFactorAuthPresent": "true"
                                },
                                "NumericLessThan": {
                                    "aws:MultiFactorAuthAge": "3600"
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/SecurityAudit",
                    "arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecurityAuditExtended",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "access-analyzer:*",
                                        "securityhub:*",
                                        "guardduty:Get*",
                                        "guardduty:List*",
                                        "inspector:Describe*",
                                        "inspector:List*",
                                        "macie2:Get*",
                                        "macie2:List*"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "AccessLevel",
                        "Value": "SecurityAudit"
                    },
                    {
                        "Key": "MFARequired",
                        "Value": "true"
                    }
                ]
            }
        },
        "BreakGlassRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "BreakGlassEmergencyRole-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "Bool": {
                                    "aws:MultiFactorAuthPresent": "true"
                                },
                                "StringEquals": {
                                    "aws:RequestedRegion": "us-east-1"
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AdministratorAccess"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "AccessLevel",
                        "Value": "Emergency"
                    },
                    {
                        "Key": "MFARequired",
                        "Value": "true"
                    },
                    {
                        "Key": "Usage",
                        "Value": "EmergencyOnly"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "MFASetupGroupName": {
            "Description": "Name of the MFA setup group",
            "Value": {
                "Ref": "MFASetupGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-MFASetupGroupName"
                }
            }
        },
        "EnforceMFAPolicyArn": {
            "Description": "ARN of the enforce MFA policy",
            "Value": {
                "Ref": "EnforceMFAPolicy"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EnforceMFAPolicyArn"
                }
            }
        },
        "SecurityAuditRoleArn": {
            "Description": "ARN of the security audit role",
            "Value": {
                "Fn::GetAtt": [
                    "SecurityAuditRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecurityAuditRoleArn"
                }
            }
        },
        "BreakGlassRoleArn": {
            "Description": "ARN of the break glass emergency role",
            "Value": {
                "Fn::GetAtt": [
                    "BreakGlassRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BreakGlassRoleArn"
                }
            }
        }
    }
}
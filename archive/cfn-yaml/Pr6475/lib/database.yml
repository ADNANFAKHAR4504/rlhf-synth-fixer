AWSTemplateFormatVersion: '2010-09-09'
Description: 'Database Stack - RDS Aurora PostgreSQL cluster with conditional deletion policies'

Parameters:
  EnvironmentType:
    Type: String
    AllowedValues:
      - dev
      - staging
      - prod
    Description: 'Environment type for deployment'

  EnvironmentSuffix:
    Type: String
    Description: 'Unique suffix for resource naming'

  VpcId:
    Type: String
    Description: 'VPC ID from VPC stack'

  PrivateSubnetIds:
    Type: String
    Description: 'Comma-separated list of private subnet IDs'

  RDSInstanceClass:
    Type: String
    Description: 'RDS instance class'
    Default: 'db.r5.large'

  RDSInstanceCount:
    Type: Number
    Description: 'Number of RDS instances'
    Default: 1
    MinValue: 1
    MaxValue: 5

  BackupRetentionPeriod:
    Type: Number
    Description: 'Number of days to retain automated backups'
    Default: 7
    MinValue: 1
    MaxValue: 35

  AlarmRDSCPUThreshold:
    Type: Number
    Description: 'RDS CPU alarm threshold percentage'

  AlarmRDSConnectionsThreshold:
    Type: Number
    Description: 'RDS connections alarm threshold'

  PreferredBackupWindow:
    Type: String
    Description: 'Preferred backup window in UTC (format: hh24:mi-hh24:mi)'
    Default: '03:00-04:00'
    AllowedPattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]-([0-1][0-9]|2[0-3]):[0-5][0-9]$'
    ConstraintDescription: 'Must be in format hh24:mi-hh24:mi'

  PreferredMaintenanceWindow:
    Type: String
    Description: 'Preferred maintenance window (format: ddd:hh24:mi-ddd:hh24:mi)'
    Default: 'sun:04:00-sun:05:00'
    AllowedPattern: '^(mon|tue|wed|thu|fri|sat|sun):[0-2][0-9]:[0-5][0-9]-(mon|tue|wed|thu|fri|sat|sun):[0-2][0-9]:[0-5][0-9]$'
    ConstraintDescription: 'Must be in format ddd:hh24:mi-ddd:hh24:mi'

Conditions:
  IsProduction: !Equals [!Ref EnvironmentType, 'prod']
  IsStaging: !Equals [!Ref EnvironmentType, 'staging']
  CreateSecondInstance: !Or
    - !Equals [!Ref RDSInstanceCount, 2]
    - !Equals [!Ref RDSInstanceCount, 3]
    - !Condition IsProduction
  CreateThirdInstance: !Or
    - !Equals [!Ref RDSInstanceCount, 3]
    - !Condition IsProduction

Resources:
  # SNS Topic for Database Alarms
  DatabaseAlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'payment-db-alarms-${EnvironmentSuffix}'
      DisplayName: !Sub 'Payment Database Alarms - ${EnvironmentType}'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # SNS Topic Subscription (placeholder - add real email)
  DatabaseAlarmNotificationSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref DatabaseAlarmNotificationTopic
      Endpoint: 'dbalerts@example.com'  # Update with actual email

  # KMS Key for encryption at rest
  DatabaseEncryptionKey:
    Type: AWS::KMS::Key
    DeletionPolicy: !If [IsProduction, Retain, Delete]
    UpdateReplacePolicy: !If [IsProduction, Retain, Delete]
    Properties:
      Description: !Sub 'KMS key for RDS Aurora encryption - ${EnvironmentSuffix}'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow RDS to use the key
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
              - 'kms:CreateGrant'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 'rds.${AWS::Region}.amazonaws.com'
      Tags:
        - Key: Name
          Value: !Sub 'payment-db-key-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  DatabaseEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/payment-db-${EnvironmentSuffix}'
      TargetKeyId: !Ref DatabaseEncryptionKey

  # Database Security Group
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'payment-db-sg-${EnvironmentSuffix}'
      GroupDescription: 'Security group for RDS Aurora PostgreSQL'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: '0.0.0.0/0'
          Description: 'Allow all outbound traffic'
      Tags:
        - Key: Name
          Value: !Sub 'payment-db-sg-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # DB Subnet Group
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub 'payment-db-subnet-group-${EnvironmentSuffix}'
      DBSubnetGroupDescription: 'Subnet group for RDS Aurora PostgreSQL'
      SubnetIds: !Split [',', !Ref PrivateSubnetIds]
      Tags:
        - Key: Name
          Value: !Sub 'payment-db-subnet-group-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # DB Parameter Group
  DBClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: !Sub 'Cluster parameter group for Aurora PostgreSQL - ${EnvironmentSuffix}'
      Family: aurora-postgresql15
      Parameters:
        shared_preload_libraries: pg_stat_statements
        log_statement: all
        log_min_duration_statement: 1000
      Tags:
        - Key: Name
          Value: !Sub 'payment-db-cluster-pg-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: !Sub 'Instance parameter group for Aurora PostgreSQL - ${EnvironmentSuffix}'
      Family: aurora-postgresql15
      Parameters:
        shared_preload_libraries: pg_stat_statements
      Tags:
        - Key: Name
          Value: !Sub 'payment-db-instance-pg-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # RDS Aurora Cluster
  AuroraCluster:
    Type: AWS::RDS::DBCluster
    DeletionPolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    UpdateReplacePolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    Properties:
      Engine: aurora-postgresql
      EngineVersion: '15.8'
      DatabaseName: payments
      MasterUsername: paymentadmin
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBMasterPassword}:SecretString:password}}'
      DBClusterIdentifier: !Sub 'payment-cluster-${EnvironmentSuffix}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      DBClusterParameterGroupName: !Ref DBClusterParameterGroup
      VpcSecurityGroupIds:
        - !Ref DatabaseSecurityGroup
      BackupRetentionPeriod: !Ref BackupRetentionPeriod
      PreferredBackupWindow: !Ref PreferredBackupWindow
      PreferredMaintenanceWindow: !Ref PreferredMaintenanceWindow
      StorageEncrypted: true
      KmsKeyId: !GetAtt DatabaseEncryptionKey.Arn
      EnableCloudwatchLogsExports:
        - postgresql
      Tags:
        - Key: Name
          Value: !Sub 'payment-cluster-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # Secrets Manager Secret for DB Password
  DBMasterPassword:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'payment-db-password-${EnvironmentSuffix}'
      Description: 'Master password for RDS Aurora PostgreSQL cluster'
      GenerateSecretString:
        SecretStringTemplate: '{"username": "paymentadmin"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # Primary DB Instance
  DBInstance1:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    UpdateReplacePolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    Properties:
      DBInstanceIdentifier: !Sub 'payment-instance-1-${EnvironmentSuffix}'
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: !Ref RDSInstanceClass
      Engine: aurora-postgresql
      DBParameterGroupName: !Ref DBParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      Tags:
        - Key: Name
          Value: !Sub 'payment-instance-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # Second DB Instance (conditional)
  DBInstance2:
    Type: AWS::RDS::DBInstance
    Condition: CreateSecondInstance
    DeletionPolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    UpdateReplacePolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    Properties:
      DBInstanceIdentifier: !Sub 'payment-instance-2-${EnvironmentSuffix}'
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: !Ref RDSInstanceClass
      Engine: aurora-postgresql
      DBParameterGroupName: !Ref DBParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      Tags:
        - Key: Name
          Value: !Sub 'payment-instance-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # Third DB Instance (conditional)
  DBInstance3:
    Type: AWS::RDS::DBInstance
    Condition: CreateThirdInstance
    DeletionPolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    UpdateReplacePolicy: !If [IsProduction, Retain, !If [IsStaging, Snapshot, Delete]]
    Properties:
      DBInstanceIdentifier: !Sub 'payment-instance-3-${EnvironmentSuffix}'
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: !Ref RDSInstanceClass
      Engine: aurora-postgresql
      DBParameterGroupName: !Ref DBParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      Tags:
        - Key: Name
          Value: !Sub 'payment-instance-3-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: CostCenter
          Value: payments
        - Key: Project
          Value: payment-processing-system
        - Key: Owner
          Value: payments-team
        - Key: Department
          Value: finance
        - Key: Application
          Value: payment-processor
        - Key: ManagedBy
          Value: CloudFormation

  # CloudWatch Alarms
  RDSCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'payment-rds-cpu-${EnvironmentSuffix}'
      AlarmDescription: !Sub 'RDS CPU utilization exceeds ${AlarmRDSCPUThreshold}%'
      MetricName: CPUUtilization
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: !Ref AlarmRDSCPUThreshold
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref AuroraCluster
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref DatabaseAlarmNotificationTopic
      OKActions:
        - !Ref DatabaseAlarmNotificationTopic

  RDSConnectionsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'payment-rds-connections-${EnvironmentSuffix}'
      AlarmDescription: !Sub 'RDS connections exceed ${AlarmRDSConnectionsThreshold}'
      MetricName: DatabaseConnections
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: !Ref AlarmRDSConnectionsThreshold
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref AuroraCluster
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref DatabaseAlarmNotificationTopic
      OKActions:
        - !Ref DatabaseAlarmNotificationTopic

Outputs:
  DatabaseSecurityGroupId:
    Description: 'Database Security Group ID'
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseSecurityGroupId'

  AuroraClusterEndpoint:
    Description: 'Aurora Cluster Write Endpoint'
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-AuroraClusterEndpoint'

  AuroraReaderEndpoint:
    Description: 'Aurora Cluster Read Endpoint'
    Value: !GetAtt AuroraCluster.ReadEndpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-AuroraReaderEndpoint'

  AuroraClusterPort:
    Description: 'Aurora Cluster Port'
    Value: !GetAtt AuroraCluster.Endpoint.Port

  AuroraClusterIdentifier:
    Description: 'Aurora Cluster Identifier'
    Value: !Ref AuroraCluster

  DatabaseName:
    Description: 'Database Name'
    Value: payments

  DBSecretArn:
    Description: 'Secrets Manager Secret ARN for DB credentials'
    Value: !Ref DBMasterPassword
    Export:
      Name: !Sub '${AWS::StackName}-DBSecretArn'

  KMSKeyId:
    Description: 'KMS Key ID for encryption'
    Value: !Ref DatabaseEncryptionKey

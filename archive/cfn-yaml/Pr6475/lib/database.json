{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Database Stack - RDS Aurora PostgreSQL cluster with conditional deletion policies",
    "Parameters": {
        "EnvironmentType": {
            "Type": "String",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ],
            "Description": "Environment type for deployment"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Unique suffix for resource naming"
        },
        "VpcId": {
            "Type": "String",
            "Description": "VPC ID from VPC stack"
        },
        "PrivateSubnetIds": {
            "Type": "String",
            "Description": "Comma-separated list of private subnet IDs"
        },
        "RDSInstanceClass": {
            "Type": "String",
            "Description": "RDS instance class",
            "Default": "db.r5.large"
        },
        "RDSInstanceCount": {
            "Type": "Number",
            "Description": "Number of RDS instances",
            "Default": 1,
            "MinValue": 1,
            "MaxValue": 5
        },
        "BackupRetentionPeriod": {
            "Type": "Number",
            "Description": "Number of days to retain automated backups",
            "Default": 7,
            "MinValue": 1,
            "MaxValue": 35
        },
        "AlarmRDSCPUThreshold": {
            "Type": "Number",
            "Description": "RDS CPU alarm threshold percentage"
        },
        "AlarmRDSConnectionsThreshold": {
            "Type": "Number",
            "Description": "RDS connections alarm threshold"
        }
    },
    "Conditions": {
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentType"
                },
                "prod"
            ]
        },
        "IsStaging": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentType"
                },
                "staging"
            ]
        },
        "CreateSecondInstance": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "RDSInstanceCount"
                        },
                        2
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "RDSInstanceCount"
                        },
                        3
                    ]
                },
                {
                    "Condition": "IsProduction"
                }
            ]
        },
        "CreateThirdInstance": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "RDSInstanceCount"
                        },
                        3
                    ]
                },
                {
                    "Condition": "IsProduction"
                }
            ]
        }
    },
    "Resources": {
        "DatabaseEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for RDS Aurora encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow RDS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "rds.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-db-key-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DatabaseEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/payment-db-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "DatabaseEncryptionKey"
                }
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "payment-db-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for RDS Aurora PostgreSQL",
                "VpcId": {
                    "Ref": "VpcId"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-db-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "payment-db-subnet-group-${EnvironmentSuffix}"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS Aurora PostgreSQL",
                "SubnetIds": {
                    "Fn::Split": [
                        ",",
                        {
                            "Ref": "PrivateSubnetIds"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-db-subnet-group-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBClusterParameterGroup": {
            "Type": "AWS::RDS::DBClusterParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Cluster parameter group for Aurora PostgreSQL - ${EnvironmentSuffix}"
                },
                "Family": "aurora-postgresql15",
                "Parameters": {
                    "shared_preload_libraries": "pg_stat_statements",
                    "log_statement": "all",
                    "log_min_duration_statement": 1000
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-db-cluster-pg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Instance parameter group for Aurora PostgreSQL - ${EnvironmentSuffix}"
                },
                "Family": "aurora-postgresql15",
                "Parameters": {
                    "shared_preload_libraries": "pg_stat_statements"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-db-instance-pg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "AuroraCluster": {
            "Type": "AWS::RDS::DBCluster",
            "DeletionPolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "UpdateReplacePolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "Properties": {
                "Engine": "aurora-postgresql",
                "EngineVersion": "15.8",
                "DatabaseName": "payments",
                "MasterUsername": "paymentadmin",
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBMasterPassword}:SecretString:password}}"
                },
                "DBClusterIdentifier": {
                    "Fn::Sub": "payment-cluster-${EnvironmentSuffix}"
                },
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "DBClusterParameterGroupName": {
                    "Ref": "DBClusterParameterGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "BackupRetentionPeriod": {
                    "Ref": "BackupRetentionPeriod"
                },
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "DatabaseEncryptionKey",
                        "Arn"
                    ]
                },
                "EnableCloudwatchLogsExports": [
                    "postgresql"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-cluster-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBMasterPassword": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "payment-db-password-${EnvironmentSuffix}"
                },
                "Description": "Master password for RDS Aurora PostgreSQL cluster",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"paymentadmin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBInstance1": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "UpdateReplacePolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "payment-instance-1-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "DBInstanceClass": {
                    "Ref": "RDSInstanceClass"
                },
                "Engine": "aurora-postgresql",
                "DBParameterGroupName": {
                    "Ref": "DBParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-instance-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBInstance2": {
            "Type": "AWS::RDS::DBInstance",
            "Condition": "CreateSecondInstance",
            "DeletionPolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "UpdateReplacePolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "payment-instance-2-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "DBInstanceClass": {
                    "Ref": "RDSInstanceClass"
                },
                "Engine": "aurora-postgresql",
                "DBParameterGroupName": {
                    "Ref": "DBParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-instance-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "DBInstance3": {
            "Type": "AWS::RDS::DBInstance",
            "Condition": "CreateThirdInstance",
            "DeletionPolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "UpdateReplacePolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    {
                        "Fn::If": [
                            "IsStaging",
                            "Snapshot",
                            "Delete"
                        ]
                    }
                ]
            },
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "payment-instance-3-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "DBInstanceClass": {
                    "Ref": "RDSInstanceClass"
                },
                "Engine": "aurora-postgresql",
                "DBParameterGroupName": {
                    "Ref": "DBParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "payment-instance-3-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentType"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "payments"
                    },
                    {
                        "Key": "Application",
                        "Value": "payment-processor"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "RDSCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "payment-rds-cpu-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "RDS CPU utilization exceeds ${AlarmRDSCPUThreshold}%"
                },
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": {
                    "Ref": "AlarmRDSCPUThreshold"
                },
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBClusterIdentifier",
                        "Value": {
                            "Ref": "AuroraCluster"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "RDSConnectionsAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "payment-rds-connections-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "RDS connections exceed ${AlarmRDSConnectionsThreshold}"
                },
                "MetricName": "DatabaseConnections",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": {
                    "Ref": "AlarmRDSConnectionsThreshold"
                },
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBClusterIdentifier",
                        "Value": {
                            "Ref": "AuroraCluster"
                        }
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        }
    },
    "Outputs": {
        "DatabaseSecurityGroupId": {
            "Description": "Database Security Group ID",
            "Value": {
                "Ref": "DatabaseSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseSecurityGroupId"
                }
            }
        },
        "AuroraClusterEndpoint": {
            "Description": "Aurora Cluster Write Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AuroraClusterEndpoint"
                }
            }
        },
        "AuroraReaderEndpoint": {
            "Description": "Aurora Cluster Read Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "ReadEndpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AuroraReaderEndpoint"
                }
            }
        },
        "AuroraClusterPort": {
            "Description": "Aurora Cluster Port",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "Endpoint.Port"
                ]
            }
        },
        "AuroraClusterIdentifier": {
            "Description": "Aurora Cluster Identifier",
            "Value": {
                "Ref": "AuroraCluster"
            }
        },
        "DatabaseName": {
            "Description": "Database Name",
            "Value": "payments"
        },
        "DBSecretArn": {
            "Description": "Secrets Manager Secret ARN for DB credentials",
            "Value": {
                "Ref": "DBMasterPassword"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DBSecretArn"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Ref": "DatabaseEncryptionKey"
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Production-ready app environment in AWS (us-east-1). Creates a VPC with subnet,
  launches an EC2 instance on the latest Amazon Linux 2 AMI (via SSM), allows only
  SSH/HTTPS inbound, and provisions an S3 bucket with server-side encryption.
  All resources tagged Environment: Production.

Rules:
  MustBeUsEast1:
    Assertions:
      - Assert: !Equals [ !Ref "AWS::Region", "us-east-1" ]
        AssertDescription: "This stack must be deployed in us-east-1."

Parameters:
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: CIDR block for the VPC.

  SubnetCidr:
    Type: String
    Default: 10.0.1.0/24
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: CIDR block for the subnet.

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedPattern: '^[a-z0-9]+\.[a-z0-9]+$'
    Description: EC2 instance type.

  IngressCidrSsh:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: IPv4 CIDR for SSH ingress (port 22).

  IngressCidrHttps:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: IPv4 CIDR for HTTPS ingress (port 443).

  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: SSM public parameter for latest Amazon Linux 2 AMI (us-east-1).

  EnvironmentSuffix:
    Type: String
    Default: dev
    Description: Optional pipeline suffix (not used by resources).

Resources:
  AppVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Environment
          Value: Production
        - Key: Name
          Value: !Sub "AppVpc-${EnvironmentSuffix}"

  AppSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref AppVpc
      CidrBlock: !Ref SubnetCidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Environment
          Value: Production

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Environment
          Value: Production

  VpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref AppVpc
      InternetGatewayId: !Ref InternetGateway

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref AppVpc
      Tags:
        - Key: Environment
          Value: Production

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VpcGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AppSubnet
      RouteTableId: !Ref RouteTable

  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH (22) and HTTPS (443) only
      VpcId: !Ref AppVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref IngressCidrSsh
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref IngressCidrHttps
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Environment
          Value: Production

  AppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Environment
          Value: Production

  AppInstance:
    Type: AWS::EC2::Instance
    DependsOn: VpcGatewayAttachment
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref AppSubnet
      SecurityGroupIds:
        - !Ref AppSecurityGroup
      Tags:
        - Key: Environment
          Value: Production

Outputs:
  VpcId:
    Description: ID of the created VPC.
    Value: !Ref AppVpc
  SecurityGroupId:
    Description: ID of the security group allowing SSH/HTTPS.
    Value: !Ref AppSecurityGroup
  InstanceId:
    Description: ID of the EC2 instance.
    Value: !Ref AppInstance
  InstancePublicIp:
    Description: Public IPv4 of the EC2 instance (if assigned).
    Value: !GetAtt AppInstance.PublicIp
  BucketName:
    Description: Name of the S3 bucket with SSE enabled.
    Value: !Ref AppBucket
  EnvironmentSuffixEcho:
    Description: Echo of the pipeline-provided EnvironmentSuffix parameter.
    Value: !Ref EnvironmentSuffix

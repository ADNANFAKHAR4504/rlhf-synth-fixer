{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Infrastructure Compliance Analysis System - Monitors CloudFormation stacks for policy violations",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix"
                    ]
                },
                {
                    "Label": {
                        "default": "Compliance Configuration"
                    },
                    "Parameters": [
                        "ComplianceCheckSchedule",
                        "ReportRetentionDays",
                        "SecondaryRegions"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
            "AllowedPattern": "^[a-zA-Z0-9]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters"
        },
        "ComplianceCheckSchedule": {
            "Type": "String",
            "Default": "rate(6 hours)",
            "Description": "Schedule for compliance checks (default: every 6 hours)"
        },
        "ReportRetentionDays": {
            "Type": "Number",
            "Default": 90,
            "Description": "Number of days to retain compliance reports in S3",
            "MinValue": 1,
            "MaxValue": 365
        },
        "SecondaryRegions": {
            "Type": "CommaDelimitedList",
            "Default": "us-west-2,eu-west-1",
            "Description": "Comma-separated list of secondary regions for multi-region analysis"
        }
    },
    "Resources": {
        "ComplianceKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for compliance system encryption - ${EnvironmentSuffix}"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow Config Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow SNS Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "sns.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow Lambda Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": "SecurityTeam"
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "Security"
                    },
                    {
                        "Key": "ComplianceLevel",
                        "Value": "Critical"
                    }
                ]
            }
        },
        "ComplianceKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/compliance-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "ComplianceKMSKey"
                }
            }
        },
        "ComplianceReportsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "compliance-reports-${AWS::AccountId}-${EnvironmentSuffix}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::GetAtt": [
                                        "ComplianceKMSKey",
                                        "Arn"
                                    ]
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldReports",
                            "Status": "Enabled",
                            "ExpirationInDays": {
                                "Ref": "ReportRetentionDays"
                            },
                            "NoncurrentVersionExpirationInDays": 30
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": "SecurityTeam"
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "Security"
                    },
                    {
                        "Key": "ComplianceLevel",
                        "Value": "Critical"
                    }
                ]
            }
        },
        "ComplianceReportsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ComplianceReportsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyUnencryptedObjectUploads",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ComplianceReportsBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "aws:kms"
                                }
                            }
                        },
                        {
                            "Sid": "DenyInsecureTransport",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ComplianceReportsBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ComplianceReportsBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ComplianceAlertTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "compliance-alerts-${EnvironmentSuffix}"
                },
                "DisplayName": "Infrastructure Compliance Alerts",
                "KmsMasterKeyId": {
                    "Ref": "ComplianceKMSKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": "SecurityTeam"
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "Security"
                    },
                    {
                        "Key": "ComplianceLevel",
                        "Value": "Critical"
                    }
                ]
            }
        },
        "RequiredTagsRule": {
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "required-tags-${EnvironmentSuffix}"
                },
                "Description": "Checks if resources have required tags: Environment, Owner, CostCenter, ComplianceLevel",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "REQUIRED_TAGS"
                },
                "InputParameters": {
                    "tag1Key": "Environment",
                    "tag2Key": "Owner",
                    "tag3Key": "CostCenter",
                    "tag4Key": "ComplianceLevel"
                }
            }
        },
        "EncryptedVolumesRule": {
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "encrypted-volumes-${EnvironmentSuffix}"
                },
                "Description": "Checks if EBS volumes are encrypted",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ENCRYPTED_VOLUMES"
                }
            }
        },
        "S3BucketEncryptionRule": {
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "s3-bucket-encryption-${EnvironmentSuffix}"
                },
                "Description": "Checks if S3 buckets have encryption enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
                }
            }
        },
        "SecurityGroupRestrictedRule": {
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "security-group-restricted-${EnvironmentSuffix}"
                },
                "Description": "Checks if security groups do not allow unrestricted access to high-risk ports",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "RESTRICTED_INCOMING_TRAFFIC"
                },
                "InputParameters": {
                    "blockedPort1": "22",
                    "blockedPort2": "3389",
                    "blockedPort3": "3306",
                    "blockedPort4": "5432"
                }
            }
        },
        "ComplianceLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "compliance-lambda-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "ComplianceAnalysisPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "config:DescribeConfigRules",
                                        "config:GetComplianceDetailsByConfigRule",
                                        "config:DescribeComplianceByConfigRule"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:DescribeStacks",
                                        "cloudformation:ListStackResources",
                                        "cloudformation:GetTemplate"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:cloudformation:*:${AWS::AccountId}:stack/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:GetObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ComplianceReportsBucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "ComplianceAlertTopic"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ComplianceKMSKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "cloudwatch:namespace": "ComplianceAnalytics"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": "SecurityTeam"
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "Security"
                    },
                    {
                        "Key": "ComplianceLevel",
                        "Value": "Critical"
                    }
                ]
            }
        },
        "ComplianceAnalysisFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "compliance-analyzer-${EnvironmentSuffix}"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "ComplianceLambdaRole",
                        "Arn"
                    ]
                },
                "MemorySize": 256,
                "Timeout": 300,
                "Environment": {
                    "Variables": {
                        "REPORT_BUCKET": {
                            "Ref": "ComplianceReportsBucket"
                        },
                        "SNS_TOPIC_ARN": {
                            "Ref": "ComplianceAlertTopic"
                        },
                        "ENVIRONMENT_SUFFIX": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "SECONDARY_REGIONS": {
                            "Fn::Join": [
                                ",",
                                {
                                    "Ref": "SecondaryRegions"
                                }
                            ]
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom datetime import datetime\nfrom typing import Dict, List, Any\n\nconfig_client = boto3.client('config')\ncfn_client = boto3.client('cloudformation')\ns3_client = boto3.client('s3')\nsns_client = boto3.client('sns')\ncloudwatch_client = boto3.client('cloudwatch')\n\nREPORT_BUCKET = os.environ['REPORT_BUCKET']\nSNS_TOPIC_ARN = os.environ['SNS_TOPIC_ARN']\nENVIRONMENT_SUFFIX = os.environ['ENVIRONMENT_SUFFIX']\nSECONDARY_REGIONS = os.environ.get('SECONDARY_REGIONS', '').split(',')\n\ndef handler(event, context):\n    \"\"\"Main handler for compliance analysis\"\"\"\n    print(f\"Starting compliance analysis at {datetime.utcnow().isoformat()}\")\n\n    try:\n        # Analyze compliance in current region\n        primary_report = analyze_region(boto3.session.Session().region_name)\n\n        # Analyze secondary regions\n        secondary_reports = []\n        for region in SECONDARY_REGIONS:\n            if region.strip():\n                try:\n                    report = analyze_region(region.strip())\n                    secondary_reports.append(report)\n                except Exception as e:\n                    print(f\"Error analyzing region {region}: {str(e)}\")\n\n        # Aggregate all reports\n        aggregated_report = aggregate_reports(primary_report, secondary_reports)\n\n        # Store report in S3\n        report_key = store_report(aggregated_report)\n\n        # Publish metrics to CloudWatch\n        publish_metrics(aggregated_report)\n\n        # Send alerts if critical violations found\n        send_alerts_if_needed(aggregated_report)\n\n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Compliance analysis completed',\n                'report_location': f's3://{REPORT_BUCKET}/{report_key}',\n                'total_violations': aggregated_report['summary']['total_violations'],\n                'critical_violations': aggregated_report['summary']['critical_violations']\n            })\n        }\n\n    except Exception as e:\n        print(f\"Error in compliance analysis: {str(e)}\")\n        raise\n\ndef analyze_region(region: str) -> Dict[str, Any]:\n    \"\"\"Analyze compliance for a specific region\"\"\"\n    print(f\"Analyzing region: {region}\")\n\n    regional_config = boto3.client('config', region_name=region)\n    regional_cfn = boto3.client('cloudformation', region_name=region)\n\n    rules_response = regional_config.describe_config_rules()\n    rules = rules_response.get('ConfigRules', [])\n\n    violations = []\n    compliant_resources = 0\n    non_compliant_resources = 0\n\n    for rule in rules:\n        rule_name = rule['ConfigRuleName']\n\n        try:\n            compliance_response = regional_config.describe_compliance_by_config_rule(\n                ConfigRuleNames=[rule_name]\n            )\n\n            for compliance in compliance_response.get('ComplianceByConfigRules', []):\n                compliance_type = compliance['Compliance']['ComplianceType']\n\n                if compliance_type == 'NON_COMPLIANT':\n                    details_response = regional_config.get_compliance_details_by_config_rule(\n                        ConfigRuleName=rule_name,\n                        ComplianceTypes=['NON_COMPLIANT']\n                    )\n\n                    for result in details_response.get('EvaluationResults', []):\n                        resource_id = result['EvaluationResultIdentifier']['EvaluationResultQualifier']['ResourceId']\n                        resource_type = result['EvaluationResultIdentifier']['EvaluationResultQualifier']['ResourceType']\n\n                        stack_info = get_stack_info(regional_cfn, resource_id)\n\n                        violation = {\n                            'rule_name': rule_name,\n                            'resource_id': resource_id,\n                            'resource_type': resource_type,\n                            'region': region,\n                            'stack_name': stack_info.get('stack_name', 'Unknown'),\n                            'stack_status': stack_info.get('stack_status', 'Unknown'),\n                            'annotation': result.get('Annotation', 'No details available'),\n                            'remediation': get_remediation_steps(rule_name, resource_type)\n                        }\n                        violations.append(violation)\n                        non_compliant_resources += 1\n                elif compliance_type == 'COMPLIANT':\n                    compliant_resources += 1\n\n        except Exception as e:\n            print(f\"Error checking rule {rule_name}: {str(e)}\")\n\n    return {\n        'region': region,\n        'timestamp': datetime.utcnow().isoformat(),\n        'violations': violations,\n        'compliant_resources': compliant_resources,\n        'non_compliant_resources': non_compliant_resources\n    }\n\ndef get_stack_info(cfn_client, resource_id: str) -> Dict[str, str]:\n    \"\"\"Try to determine which CloudFormation stack owns a resource\"\"\"\n    try:\n        stacks_response = cfn_client.describe_stacks()\n\n        for stack in stacks_response.get('Stacks', []):\n            stack_name = stack['StackName']\n\n            try:\n                resources_response = cfn_client.list_stack_resources(StackName=stack_name)\n\n                for resource in resources_response.get('StackResourceSummaries', []):\n                    if resource.get('PhysicalResourceId') == resource_id:\n                        return {\n                            'stack_name': stack_name,\n                            'stack_status': stack['StackStatus']\n                        }\n            except Exception:\n                continue\n\n    except Exception as e:\n        print(f\"Error getting stack info: {str(e)}\")\n\n    return {}\n\ndef get_remediation_steps(rule_name: str, resource_type: str) -> List[str]:\n    \"\"\"Provide remediation steps based on rule and resource type\"\"\"\n    remediation_map = {\n        'required-tags': [\n            'Add missing tags: Environment, Owner, CostCenter, ComplianceLevel',\n            'Use CloudFormation stack tags to apply tags to all resources',\n            'Update resource definitions to include required tags'\n        ],\n        'encrypted-volumes': [\n            'Enable encryption on EBS volumes',\n            'Create encrypted snapshot and restore volume',\n            'Update CloudFormation template to set Encrypted: true'\n        ],\n        's3-bucket-encryption': [\n            'Enable default encryption on S3 bucket',\n            'Use AWS KMS or AES-256 encryption',\n            'Update bucket policy to deny unencrypted uploads'\n        ],\n        'security-group-restricted': [\n            'Remove unrestricted access rules (0.0.0.0/0)',\n            'Restrict access to specific IP ranges or security groups',\n            'Review and update security group ingress rules'\n        ]\n    }\n\n    for key, steps in remediation_map.items():\n        if key in rule_name.lower():\n            return steps\n\n    return ['Review AWS Config rule documentation', 'Consult security team for guidance']\n\ndef aggregate_reports(primary: Dict[str, Any], secondary: List[Dict[str, Any]]) -> Dict[str, Any]:\n    \"\"\"Aggregate reports from all regions\"\"\"\n    all_violations = primary['violations']\n    total_compliant = primary['compliant_resources']\n    total_non_compliant = primary['non_compliant_resources']\n\n    for report in secondary:\n        all_violations.extend(report['violations'])\n        total_compliant += report['compliant_resources']\n        total_non_compliant += report['non_compliant_resources']\n\n    critical_violations = [\n        v for v in all_violations\n        if 'security' in v['rule_name'].lower() or 'encryption' in v['rule_name'].lower()\n    ]\n\n    return {\n        'report_id': f\"compliance-{datetime.utcnow().strftime('%Y%m%d-%H%M%S')}\",\n        'timestamp': datetime.utcnow().isoformat(),\n        'environment': ENVIRONMENT_SUFFIX,\n        'summary': {\n            'total_violations': len(all_violations),\n            'critical_violations': len(critical_violations),\n            'compliant_resources': total_compliant,\n            'non_compliant_resources': total_non_compliant,\n            'compliance_percentage': round(\n                (total_compliant / (total_compliant + total_non_compliant) * 100)\n                if (total_compliant + total_non_compliant) > 0 else 0,\n                2\n            )\n        },\n        'regions_analyzed': [primary['region']] + [r['region'] for r in secondary],\n        'violations': all_violations,\n        'critical_violations': critical_violations\n    }\n\ndef store_report(report: Dict[str, Any]) -> str:\n    \"\"\"Store compliance report in S3\"\"\"\n    report_key = f\"reports/{report['timestamp'][:10]}/{report['report_id']}.json\"\n\n    s3_client.put_object(\n        Bucket=REPORT_BUCKET,\n        Key=report_key,\n        Body=json.dumps(report, indent=2),\n        ContentType='application/json',\n        ServerSideEncryption='aws:kms'\n    )\n\n    print(f\"Report stored: s3://{REPORT_BUCKET}/{report_key}\")\n    return report_key\n\ndef publish_metrics(report: Dict[str, Any]):\n    \"\"\"Publish compliance metrics to CloudWatch\"\"\"\n    namespace = 'ComplianceAnalytics'\n    timestamp = datetime.utcnow()\n\n    metrics = [\n        {'MetricName': 'TotalViolations', 'Value': report['summary']['total_violations'], 'Unit': 'Count'},\n        {'MetricName': 'CriticalViolations', 'Value': report['summary']['critical_violations'], 'Unit': 'Count'},\n        {'MetricName': 'CompliancePercentage', 'Value': report['summary']['compliance_percentage'], 'Unit': 'Percent'},\n        {'MetricName': 'CompliantResources', 'Value': report['summary']['compliant_resources'], 'Unit': 'Count'},\n        {'MetricName': 'NonCompliantResources', 'Value': report['summary']['non_compliant_resources'], 'Unit': 'Count'}\n    ]\n\n    for metric in metrics:\n        cloudwatch_client.put_metric_data(\n            Namespace=namespace,\n            MetricData=[{\n                'MetricName': metric['MetricName'],\n                'Value': metric['Value'],\n                'Unit': metric['Unit'],\n                'Timestamp': timestamp,\n                'Dimensions': [{'Name': 'Environment', 'Value': ENVIRONMENT_SUFFIX}]\n            }]\n        )\n\n    print(f\"Published {len(metrics)} metrics to CloudWatch\")\n\ndef send_alerts_if_needed(report: Dict[str, Any]):\n    \"\"\"Send SNS alerts if critical violations are found\"\"\"\n    critical_count = report['summary']['critical_violations']\n\n    if critical_count > 0:\n        message = f\"\"\"CRITICAL COMPLIANCE ALERT\n\nEnvironment: {ENVIRONMENT_SUFFIX}\nTimestamp: {report['timestamp']}\n\nSUMMARY:\n- Critical Violations: {critical_count}\n- Total Violations: {report['summary']['total_violations']}\n- Compliance Rate: {report['summary']['compliance_percentage']}%\n- Regions Analyzed: {', '.join(report['regions_analyzed'])}\n\nCRITICAL VIOLATIONS:\n\"\"\"\n\n        for i, violation in enumerate(report['critical_violations'][:10], 1):\n            message += f\"\\n{i}. {violation['rule_name']}\"\n            message += f\"\\n   Resource: {violation['resource_type']} ({violation['resource_id']})\"\n            message += f\"\\n   Stack: {violation['stack_name']}\"\n            message += f\"\\n   Region: {violation['region']}\"\n            message += f\"\\n   Remediation: {violation['remediation'][0]}\\n\"\n\n        if len(report['critical_violations']) > 10:\n            message += f\"\\n... and {len(report['critical_violations']) - 10} more critical violations\"\n\n        sns_client.publish(\n            TopicArn=SNS_TOPIC_ARN,\n            Subject=f'CRITICAL: {critical_count} Compliance Violations Detected',\n            Message=message\n        )\n\n        print(f\"Alert sent for {critical_count} critical violations\")\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": "SecurityTeam"
                    },
                    {
                        "Key": "CostCenter",
                        "Value": "Security"
                    },
                    {
                        "Key": "ComplianceLevel",
                        "Value": "Critical"
                    }
                ]
            }
        },
        "ComplianceScheduleRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "compliance-schedule-${EnvironmentSuffix}"
                },
                "Description": "Triggers compliance analysis every 6 hours",
                "ScheduleExpression": {
                    "Ref": "ComplianceCheckSchedule"
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "ComplianceAnalysisFunction",
                                "Arn"
                            ]
                        },
                        "Id": "ComplianceAnalysisTarget"
                    }
                ]
            }
        },
        "ComplianceSchedulePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "ComplianceAnalysisFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "ComplianceScheduleRule",
                        "Arn"
                    ]
                }
            }
        },
        "ComplianceDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Properties": {
                "DashboardName": {
                    "Fn::Sub": "compliance-dashboard-${EnvironmentSuffix}"
                },
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"ComplianceAnalytics\", \"TotalViolations\", {\"stat\": \"Average\", \"label\": \"Total Violations\"}],\n          [\".\", \"CriticalViolations\", {\"stat\": \"Average\", \"label\": \"Critical Violations\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Compliance Violations Over Time\",\n        \"period\": 21600,\n        \"yAxis\": {\"left\": {\"min\": 0}}\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [[\"ComplianceAnalytics\", \"CompliancePercentage\", {\"stat\": \"Average\"}]],\n        \"view\": \"singleValue\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Current Compliance Rate\",\n        \"period\": 21600\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"ComplianceAnalytics\", \"CompliantResources\", {\"stat\": \"Average\", \"label\": \"Compliant\"}],\n          [\".\", \"NonCompliantResources\", {\"stat\": \"Average\", \"label\": \"Non-Compliant\"}]\n        ],\n        \"view\": \"pie\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Resource Compliance Distribution\",\n        \"period\": 21600\n      }\n    }\n  ]\n}\n"
                }
            }
        }
    },
    "Outputs": {
        "ComplianceReportsBucketName": {
            "Description": "S3 bucket for compliance reports",
            "Value": {
                "Ref": "ComplianceReportsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ComplianceReportsBucket"
                }
            }
        },
        "ComplianceReportsBucketArn": {
            "Description": "ARN of compliance reports bucket",
            "Value": {
                "Fn::GetAtt": [
                    "ComplianceReportsBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ComplianceReportsBucketArn"
                }
            }
        },
        "ComplianceAlertTopicArn": {
            "Description": "SNS topic for compliance alerts",
            "Value": {
                "Ref": "ComplianceAlertTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ComplianceAlertTopic"
                }
            }
        },
        "ComplianceAnalysisFunctionArn": {
            "Description": "Lambda function for compliance analysis",
            "Value": {
                "Fn::GetAtt": [
                    "ComplianceAnalysisFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ComplianceAnalysisFunction"
                }
            }
        },
        "ComplianceKMSKeyId": {
            "Description": "KMS key for encryption",
            "Value": {
                "Ref": "ComplianceKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ComplianceKMSKey"
                }
            }
        },
        "ComplianceDashboardURL": {
            "Description": "CloudWatch dashboard URL",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=compliance-dashboard-${EnvironmentSuffix}"
            }
        },
        "StackName": {
            "Description": "Name of this CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StackName"
                }
            }
        },
        "EnvironmentSuffix": {
            "Description": "Environment suffix used for this deployment",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Fully self-contained CI/CD pipeline for containerized microservices with Blue/Green ECS deployments",
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Description": "Name of the project",
            "Default": "ms-app",
            "MinLength": 1,
            "MaxLength": 50
        },
        "EnvironmentType": {
            "Type": "String",
            "Description": "Environment type for resource configuration (determines compute size, retention, etc.)",
            "Default": "dev",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ],
            "ConstraintDescription": "Must be dev, staging, or prod"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Environment suffix for resource naming (dev, staging, prod)",
            "Default": "dev",
            "AllowedPattern": "^[a-z0-9-]+$",
            "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
        },
        "SourceObjectKey": {
            "Type": "String",
            "Description": "S3 object key for source code zip file",
            "Default": "source.zip"
        },
        "NotificationEmail": {
            "Type": "String",
            "Description": "Email for pipeline notifications and manual approvals",
            "Default": "notifications@example.com",
            "AllowedPattern": "[^@]+@[^@]+\\.[^@]+"
        },
        "GitHubOwner": {
            "Type": "String",
            "Description": "GitHub repository owner (leave default if using S3 source)",
            "Default": "my-github-user"
        },
        "GitHubRepo": {
            "Type": "String",
            "Description": "GitHub repository name (leave default if using S3 source)",
            "Default": "my-repo"
        },
        "GitHubBranch": {
            "Type": "String",
            "Description": "GitHub branch to track (leave default if using S3 source)",
            "Default": "main"
        },
        "UseGitHubSource": {
            "Type": "String",
            "Description": "Use GitHub as source (true) or S3 (false)",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        }
    },
    "Conditions": {
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentType"
                },
                "prod"
            ]
        },
        "IsStaging": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentType"
                },
                "staging"
            ]
        },
        "RequiresApproval": {
            "Fn::Or": [
                {
                    "Condition": "IsProduction"
                },
                {
                    "Condition": "IsStaging"
                }
            ]
        },
        "UseGitHub": {
            "Fn::Equals": [
                {
                    "Ref": "UseGitHubSource"
                },
                "true"
            ]
        }
    },
    "Mappings": {
        "EnvironmentConfig": {
            "dev": {
                "BuildComputeType": "BUILD_GENERAL1_SMALL",
                "RetentionDays": 7,
                "LifecycleExpirationDays": 30,
                "DesiredCount": 1,
                "MaxSize": 2
            },
            "staging": {
                "BuildComputeType": "BUILD_GENERAL1_MEDIUM",
                "RetentionDays": 14,
                "LifecycleExpirationDays": 60,
                "DesiredCount": 2,
                "MaxSize": 4
            },
            "prod": {
                "BuildComputeType": "BUILD_GENERAL1_LARGE",
                "RetentionDays": 30,
                "LifecycleExpirationDays": 90,
                "DesiredCount": 3,
                "MaxSize": 6
            }
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-vpc-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-igw-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.1.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-public-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.2.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-public-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.11.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-private-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.12.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-private-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "NatGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-nat-eip-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "NatGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-nat-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-public-rt-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-private-rt-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DefaultPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "LoadBalancerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${ProjectName}-alb-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTP from anywhere"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS from anywhere"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-alb-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSTaskSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${ProjectName}-ecs-task-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for ECS tasks",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "LoadBalancerSecurityGroup"
                        },
                        "Description": "Allow HTTP from Load Balancer"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-ecs-task-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeBuildSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${ProjectName}-codebuild-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for CodeBuild projects",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS outbound"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codebuild-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "GitHubOAuthToken": {
            "Type": "AWS::SecretsManager::Secret",
            "Condition": "UseGitHub",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-github-oauth-${EnvironmentSuffix}"
                },
                "Description": "GitHub OAuth token for CodePipeline (replace placeholder with actual token)",
                "SecretString": "{\n  \"token\": \"REPLACE_WITH_ACTUAL_GITHUB_TOKEN\"\n}\n",
                "KmsKeyId": {
                    "Ref": "KMSKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-github-secret-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "KMSKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for ${ProjectName} CI/CD pipeline encryption in ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow services to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "codepipeline.amazonaws.com",
                                    "codebuild.amazonaws.com",
                                    "s3.amazonaws.com",
                                    "ecr.amazonaws.com",
                                    "sns.amazonaws.com",
                                    "secretsmanager.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-kms-key-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "KMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${ProjectName}-pipeline-key-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "KMSKey"
                }
            }
        },
        "SourceCodeBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-source-${EnvironmentSuffix}-${AWS::AccountId}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "KMSKey"
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-source-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ArtifactBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-artifacts-${EnvironmentSuffix}-${AWS::AccountId}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "KMSKey"
                                }
                            }
                        }
                    ]
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldArtifacts",
                            "Status": "Enabled",
                            "ExpirationInDays": {
                                "Fn::FindInMap": [
                                    "EnvironmentConfig",
                                    {
                                        "Ref": "EnvironmentType"
                                    },
                                    "LifecycleExpirationDays"
                                ]
                            },
                            "NoncurrentVersionExpirationInDays": 7
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-artifacts-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "NotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${ProjectName}-pipeline-notifications-${EnvironmentSuffix}"
                },
                "DisplayName": "Pipeline Notifications",
                "KmsMasterKeyId": {
                    "Ref": "KMSKey"
                },
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "NotificationEmail"
                        },
                        "Protocol": "email"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-sns-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeBuildLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/codebuild/${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Fn::FindInMap": [
                        "EnvironmentConfig",
                        {
                            "Ref": "EnvironmentType"
                        },
                        "RetentionDays"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codebuild-logs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/ecs/${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Fn::FindInMap": [
                        "EnvironmentConfig",
                        {
                            "Ref": "EnvironmentType"
                        },
                        "RetentionDays"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-ecs-logs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECRRepository": {
            "Type": "AWS::ECR::Repository",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "RepositoryName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}"
                },
                "ImageScanningConfiguration": {
                    "ScanOnPush": true
                },
                "EncryptionConfiguration": {
                    "EncryptionType": "KMS",
                    "KmsKey": {
                        "Ref": "KMSKey"
                    }
                },
                "LifecyclePolicy": {
                    "LifecyclePolicyText": "{\n  \"rules\": [\n    {\n      \"rulePriority\": 1,\n      \"description\": \"Keep last 10 images\",\n      \"selection\": {\n        \"tagStatus\": \"any\",\n        \"countType\": \"imageCountMoreThan\",\n        \"countNumber\": 10\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    }\n  ]\n}\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-ecr-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodePipelineRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ProjectName}-codepipeline-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codepipeline.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "PipelineExecutionPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:PutObject",
                                        "s3:GetBucketVersioning"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "${ArtifactBucket.Arn}"
                                        },
                                        {
                                            "Fn::Sub": "${ArtifactBucket.Arn}/*"
                                        },
                                        {
                                            "Fn::Sub": "${SourceCodeBucket.Arn}"
                                        },
                                        {
                                            "Fn::Sub": "${SourceCodeBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codebuild:BatchGetBuilds",
                                        "codebuild:StartBuild"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "CodeBuildProject",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codedeploy:CreateDeployment",
                                        "codedeploy:GetApplication",
                                        "codedeploy:GetApplicationRevision",
                                        "codedeploy:GetDeployment",
                                        "codedeploy:GetDeploymentConfig",
                                        "codedeploy:RegisterApplicationRevision"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:application:${CodeDeployApplication}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:deploymentgroup:${CodeDeployApplication}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "NotificationTopic"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecs:DescribeServices",
                                        "ecs:DescribeTaskDefinition",
                                        "ecs:DescribeTasks",
                                        "ecs:ListTasks",
                                        "ecs:RegisterTaskDefinition",
                                        "ecs:UpdateService"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Fn::If": [
                                        "UseGitHub",
                                        {
                                            "Effect": "Allow",
                                            "Action": [
                                                "secretsmanager:GetSecretValue"
                                            ],
                                            "Resource": {
                                                "Ref": "GitHubOAuthToken"
                                            }
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codepipeline-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeBuildRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ProjectName}-codebuild-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CodeBuildExecutionPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ProjectName}-${EnvironmentSuffix}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ProjectName}-${EnvironmentSuffix}:*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:PutObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "${ArtifactBucket.Arn}/*"
                                        },
                                        {
                                            "Fn::Sub": "${SourceCodeBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketLocation",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ArtifactBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "SourceCodeBucket",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecr:GetAuthorizationToken"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecr:BatchCheckLayerAvailability",
                                        "ecr:GetDownloadUrlForLayer",
                                        "ecr:BatchGetImage",
                                        "ecr:PutImage",
                                        "ecr:InitiateLayerUpload",
                                        "ecr:UploadLayerPart",
                                        "ecr:CompleteLayerUpload"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ECRRepository",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateNetworkInterface",
                                        "ec2:DescribeDhcpOptions",
                                        "ec2:DescribeNetworkInterfaces",
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeSecurityGroups",
                                        "ec2:DescribeVpcs",
                                        "ec2:CreateNetworkInterfacePermission"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codebuild-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeDeployRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ProjectName}-codedeploy-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codedeploy.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS"
                ],
                "Policies": [
                    {
                        "PolicyName": "CodeDeployECSPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecs:CreateTaskSet",
                                        "ecs:DeleteTaskSet",
                                        "ecs:DescribeServices",
                                        "ecs:UpdateServicePrimaryTaskSet"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/${ECSCluster}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "elasticloadbalancing:DescribeTargetGroups",
                                        "elasticloadbalancing:DescribeListeners",
                                        "elasticloadbalancing:ModifyListener",
                                        "elasticloadbalancing:DescribeRules",
                                        "elasticloadbalancing:ModifyRule"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/${ProjectName}-*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:listener/app/${ProjectName}-*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:DescribeAlarms"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${ProjectName}-*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "NotificationTopic"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ArtifactBucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:PassRole"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ECSTaskExecutionRole",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "ECSTaskRole",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codedeploy-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ProjectName}-ecs-task-execution-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "ECSTaskExecutionPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecr:GetAuthorizationToken",
                                        "ecr:BatchCheckLayerAvailability",
                                        "ecr:GetDownloadUrlForLayer",
                                        "ecr:BatchGetImage"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ECSLogGroup",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-ecs-task-execution-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSTaskRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ProjectName}-ecs-task-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "ECSTaskPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ECSLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-ecs-task-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "ClusterName": {
                    "Fn::Sub": "${ProjectName}-cluster-${EnvironmentSuffix}"
                },
                "ClusterSettings": [
                    {
                        "Name": "containerInsights",
                        "Value": "enabled"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-cluster-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "Family": {
                    "Fn::Sub": "${ProjectName}-task-${EnvironmentSuffix}"
                },
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "Cpu": "256",
                "Memory": "512",
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "TaskRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    {
                        "Name": {
                            "Fn::Sub": "${ProjectName}-container"
                        },
                        "Image": "public.ecr.aws/nginx/nginx:mainline-alpine",
                        "Essential": true,
                        "PortMappings": [
                            {
                                "ContainerPort": 80,
                                "Protocol": "tcp"
                            }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ECSLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-task-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "TargetGroupBlue": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-tg-blue-${EnvironmentSuffix}"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "ip",
                "HealthCheckEnabled": true,
                "HealthCheckProtocol": "HTTP",
                "HealthCheckPath": "/",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-tg-blue-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "TargetGroupGreen": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-tg-green-${EnvironmentSuffix}"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "ip",
                "HealthCheckEnabled": true,
                "HealthCheckProtocol": "HTTP",
                "HealthCheckPath": "/",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-tg-green-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-alb-${EnvironmentSuffix}"
                },
                "Type": "application",
                "Scheme": "internet-facing",
                "IpAddressType": "ipv4",
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "LoadBalancerSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-alb-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "TargetGroupBlue"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "DependsOn": "ALBListener",
            "Properties": {
                "ServiceName": {
                    "Fn::Sub": "${ProjectName}-service-${EnvironmentSuffix}"
                },
                "Cluster": {
                    "Ref": "ECSCluster"
                },
                "TaskDefinition": {
                    "Ref": "ECSTaskDefinition"
                },
                "DesiredCount": {
                    "Fn::FindInMap": [
                        "EnvironmentConfig",
                        {
                            "Ref": "EnvironmentType"
                        },
                        "DesiredCount"
                    ]
                },
                "LaunchType": "FARGATE",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "DISABLED",
                        "Subnets": [
                            {
                                "Ref": "PrivateSubnet1"
                            },
                            {
                                "Ref": "PrivateSubnet2"
                            }
                        ],
                        "SecurityGroups": [
                            {
                                "Ref": "ECSTaskSecurityGroup"
                            }
                        ]
                    }
                },
                "LoadBalancers": [
                    {
                        "ContainerName": {
                            "Fn::Sub": "${ProjectName}-container"
                        },
                        "ContainerPort": 80,
                        "TargetGroupArn": {
                            "Ref": "TargetGroupBlue"
                        }
                    }
                ],
                "DeploymentController": {
                    "Type": "CODE_DEPLOY"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-service-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeBuildProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-build-${EnvironmentSuffix}"
                },
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "CodeBuildRole",
                        "Arn"
                    ]
                },
                "Artifacts": {
                    "Type": "CODEPIPELINE"
                },
                "Environment": {
                    "Type": "LINUX_CONTAINER",
                    "ComputeType": {
                        "Fn::FindInMap": [
                            "EnvironmentConfig",
                            {
                                "Ref": "EnvironmentType"
                            },
                            "BuildComputeType"
                        ]
                    },
                    "Image": "aws/codebuild/standard:5.0",
                    "PrivilegedMode": true,
                    "EnvironmentVariables": [
                        {
                            "Name": "AWS_DEFAULT_REGION",
                            "Value": {
                                "Ref": "AWS::Region"
                            }
                        },
                        {
                            "Name": "AWS_ACCOUNT_ID",
                            "Value": {
                                "Ref": "AWS::AccountId"
                            }
                        },
                        {
                            "Name": "ECR_REPOSITORY_URI",
                            "Value": {
                                "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}"
                            }
                        },
                        {
                            "Name": "ENVIRONMENT_SUFFIX",
                            "Value": {
                                "Ref": "EnvironmentSuffix"
                            }
                        }
                    ]
                },
                "Source": {
                    "Type": "CODEPIPELINE",
                    "BuildSpec": "version: 0.2\nphases:\n  pre_build:\n    commands:\n      - echo Logging in to Amazon ECR...\n      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com\n      - REPOSITORY_URI=$ECR_REPOSITORY_URI\n      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)\n      - IMAGE_TAG=${COMMIT_HASH:=latest}\n  build:\n    commands:\n      - echo Build started on `date`\n      - echo Building the Docker image...\n      - docker build -t $REPOSITORY_URI:latest .\n      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG\n      - echo Running unit tests...\n      - docker run --rm $REPOSITORY_URI:latest npm test || echo \"No tests defined\"\n  post_build:\n    commands:\n      - echo Build completed on `date`\n      - echo Pushing the Docker images...\n      - docker push $REPOSITORY_URI:latest\n      - docker push $REPOSITORY_URI:$IMAGE_TAG\n      - echo Writing image definitions file...\n      - printf '[{\"name\":\"container\",\"imageUri\":\"%s\"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json\n      - cat imagedefinitions.json\nartifacts:\n  files:\n    - imagedefinitions.json\n    - '**/*'\n"
                },
                "VpcConfig": {
                    "VpcId": {
                        "Ref": "VPC"
                    },
                    "Subnets": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        }
                    ],
                    "SecurityGroupIds": [
                        {
                            "Ref": "CodeBuildSecurityGroup"
                        }
                    ]
                },
                "LogsConfig": {
                    "CloudWatchLogs": {
                        "Status": "ENABLED",
                        "GroupName": {
                            "Ref": "CodeBuildLogGroup"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codebuild-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeDeployApplication": {
            "Type": "AWS::CodeDeploy::Application",
            "Properties": {
                "ApplicationName": {
                    "Fn::Sub": "${ProjectName}-app-${EnvironmentSuffix}"
                },
                "ComputePlatform": "ECS",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-codedeploy-app-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CodeDeployDeploymentGroup": {
            "Type": "AWS::CodeDeploy::DeploymentGroup",
            "Properties": {
                "ApplicationName": {
                    "Ref": "CodeDeployApplication"
                },
                "DeploymentGroupName": {
                    "Fn::Sub": "${ProjectName}-dg-${EnvironmentSuffix}"
                },
                "ServiceRoleArn": {
                    "Fn::GetAtt": [
                        "CodeDeployRole",
                        "Arn"
                    ]
                },
                "DeploymentConfigName": "CodeDeployDefault.ECSAllAtOnce",
                "DeploymentStyle": {
                    "DeploymentType": "BLUE_GREEN",
                    "DeploymentOption": "WITH_TRAFFIC_CONTROL"
                },
                "BlueGreenDeploymentConfiguration": {
                    "TerminateBlueInstancesOnDeploymentSuccess": {
                        "Action": "TERMINATE",
                        "TerminationWaitTimeInMinutes": 5
                    },
                    "DeploymentReadyOption": {
                        "ActionOnTimeout": "CONTINUE_DEPLOYMENT"
                    }
                },
                "LoadBalancerInfo": {
                    "TargetGroupPairInfoList": [
                        {
                            "ProdTrafficRoute": {
                                "ListenerArns": [
                                    {
                                        "Ref": "ALBListener"
                                    }
                                ]
                            },
                            "TargetGroups": [
                                {
                                    "Name": {
                                        "Fn::GetAtt": [
                                            "TargetGroupBlue",
                                            "TargetGroupName"
                                        ]
                                    }
                                },
                                {
                                    "Name": {
                                        "Fn::GetAtt": [
                                            "TargetGroupGreen",
                                            "TargetGroupName"
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                },
                "ECSServices": [
                    {
                        "ClusterName": {
                            "Ref": "ECSCluster"
                        },
                        "ServiceName": {
                            "Fn::GetAtt": [
                                "ECSService",
                                "Name"
                            ]
                        }
                    }
                ],
                "AutoRollbackConfiguration": {
                    "Enabled": true,
                    "Events": [
                        "DEPLOYMENT_FAILURE",
                        "DEPLOYMENT_STOP_ON_ALARM"
                    ]
                }
            }
        },
        "DeploymentAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${ProjectName}-deployment-alarm-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm for deployment failures",
                "MetricName": "UnHealthyHostCount",
                "Namespace": "AWS/ApplicationELB",
                "Dimensions": [
                    {
                        "Name": "TargetGroup",
                        "Value": {
                            "Fn::GetAtt": [
                                "TargetGroupBlue",
                                "TargetGroupFullName"
                            ]
                        }
                    },
                    {
                        "Name": "LoadBalancer",
                        "Value": {
                            "Fn::GetAtt": [
                                "ApplicationLoadBalancer",
                                "LoadBalancerFullName"
                            ]
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "PipelineFailureAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${ProjectName}-pipeline-failure-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm for pipeline failures",
                "MetricName": "PipelineExecutionFailure",
                "Namespace": "AWS/CodePipeline",
                "Dimensions": [
                    {
                        "Name": "PipelineName",
                        "Value": {
                            "Ref": "CodePipeline"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 0,
                "ComparisonOperator": "GreaterThanThreshold",
                "AlarmActions": [
                    {
                        "Ref": "NotificationTopic"
                    }
                ]
            }
        },
        "CodePipeline": {
            "Type": "AWS::CodePipeline::Pipeline",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-pipeline-${EnvironmentSuffix}"
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "CodePipelineRole",
                        "Arn"
                    ]
                },
                "ArtifactStore": {
                    "Type": "S3",
                    "Location": {
                        "Ref": "ArtifactBucket"
                    },
                    "EncryptionKey": {
                        "Id": {
                            "Ref": "KMSKey"
                        },
                        "Type": "KMS"
                    }
                },
                "Stages": [
                    {
                        "Name": "Source",
                        "Actions": [
                            {
                                "Fn::If": [
                                    "UseGitHub",
                                    {
                                        "Name": "GitHubSourceAction",
                                        "ActionTypeId": {
                                            "Category": "Source",
                                            "Owner": "ThirdParty",
                                            "Provider": "GitHub",
                                            "Version": "1"
                                        },
                                        "Configuration": {
                                            "Owner": {
                                                "Ref": "GitHubOwner"
                                            },
                                            "Repo": {
                                                "Ref": "GitHubRepo"
                                            },
                                            "Branch": {
                                                "Ref": "GitHubBranch"
                                            },
                                            "OAuthToken": {
                                                "Fn::Sub": "{{resolve:secretsmanager:${GitHubOAuthToken}:SecretString:token}}"
                                            },
                                            "PollForSourceChanges": false
                                        },
                                        "OutputArtifacts": [
                                            {
                                                "Name": "SourceOutput"
                                            }
                                        ],
                                        "RunOrder": 1
                                    },
                                    {
                                        "Name": "S3SourceAction",
                                        "ActionTypeId": {
                                            "Category": "Source",
                                            "Owner": "AWS",
                                            "Provider": "S3",
                                            "Version": "1"
                                        },
                                        "Configuration": {
                                            "S3Bucket": {
                                                "Ref": "SourceCodeBucket"
                                            },
                                            "S3ObjectKey": {
                                                "Ref": "SourceObjectKey"
                                            },
                                            "PollForSourceChanges": false
                                        },
                                        "OutputArtifacts": [
                                            {
                                                "Name": "SourceOutput"
                                            }
                                        ],
                                        "RunOrder": 1
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "Name": "Build",
                        "Actions": [
                            {
                                "Name": "BuildAction",
                                "ActionTypeId": {
                                    "Category": "Build",
                                    "Owner": "AWS",
                                    "Provider": "CodeBuild",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ProjectName": {
                                        "Ref": "CodeBuildProject"
                                    }
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "SourceOutput"
                                    }
                                ],
                                "OutputArtifacts": [
                                    {
                                        "Name": "BuildOutput"
                                    }
                                ],
                                "RunOrder": 1
                            }
                        ]
                    },
                    {
                        "Fn::If": [
                            "RequiresApproval",
                            {
                                "Name": "ManualApproval",
                                "Actions": [
                                    {
                                        "Name": "ApprovalAction",
                                        "ActionTypeId": {
                                            "Category": "Approval",
                                            "Owner": "AWS",
                                            "Provider": "Manual",
                                            "Version": "1"
                                        },
                                        "Configuration": {
                                            "NotificationArn": {
                                                "Ref": "NotificationTopic"
                                            },
                                            "CustomData": {
                                                "Fn::Sub": "Please review and approve deployment to ${EnvironmentSuffix}"
                                            }
                                        },
                                        "RunOrder": 1
                                    }
                                ]
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    {
                        "Name": "Deploy",
                        "Actions": [
                            {
                                "Name": "DeployToECS",
                                "ActionTypeId": {
                                    "Category": "Deploy",
                                    "Owner": "AWS",
                                    "Provider": "CodeDeployToECS",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ApplicationName": {
                                        "Ref": "CodeDeployApplication"
                                    },
                                    "DeploymentGroupName": {
                                        "Ref": "CodeDeployDeploymentGroup"
                                    },
                                    "TaskDefinitionTemplateArtifact": "BuildOutput",
                                    "TaskDefinitionTemplatePath": "taskdef.json",
                                    "AppSpecTemplateArtifact": "BuildOutput",
                                    "AppSpecTemplatePath": "appspec.yaml"
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "BuildOutput"
                                    }
                                ],
                                "RunOrder": 1
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-pipeline-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "project",
                        "Value": "iac-rlhf-amazon"
                    },
                    {
                        "Key": "team-number",
                        "Value": 2
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "PublicSubnets": {
            "Description": "Public Subnets",
            "Value": {
                "Fn::Sub": "${PublicSubnet1},${PublicSubnet2}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnets"
                }
            }
        },
        "PrivateSubnets": {
            "Description": "Private Subnets",
            "Value": {
                "Fn::Sub": "${PrivateSubnet1},${PrivateSubnet2}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnets"
                }
            }
        },
        "PipelineName": {
            "Description": "Name of the CodePipeline",
            "Value": {
                "Ref": "CodePipeline"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PipelineName"
                }
            }
        },
        "PipelineArn": {
            "Description": "ARN of the CodePipeline",
            "Value": {
                "Fn::Sub": "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${CodePipeline}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PipelineArn"
                }
            }
        },
        "ECRRepositoryUri": {
            "Description": "URI of the ECR repository",
            "Value": {
                "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ECRRepositoryUri"
                }
            }
        },
        "SourceCodeBucketName": {
            "Description": "Name of the S3 source code bucket (upload your source.zip here)",
            "Value": {
                "Ref": "SourceCodeBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SourceCodeBucket"
                }
            }
        },
        "ArtifactBucketName": {
            "Description": "Name of the S3 artifact bucket",
            "Value": {
                "Ref": "ArtifactBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ArtifactBucket"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Ref": "KMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyId"
                }
            }
        },
        "NotificationTopicArn": {
            "Description": "SNS Topic ARN for notifications",
            "Value": {
                "Ref": "NotificationTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NotificationTopicArn"
                }
            }
        },
        "ECSClusterName": {
            "Description": "Name of the ECS Cluster",
            "Value": {
                "Ref": "ECSCluster"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ECSCluster"
                }
            }
        },
        "ECSServiceName": {
            "Description": "Name of the ECS Service",
            "Value": {
                "Fn::GetAtt": [
                    "ECSService",
                    "Name"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ECSService"
                }
            }
        },
        "LoadBalancerDNS": {
            "Description": "DNS name of the Application Load Balancer",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LoadBalancerDNS"
                }
            }
        },
        "LoadBalancerURL": {
            "Description": "URL of the Application Load Balancer",
            "Value": {
                "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LoadBalancerURL"
                }
            }
        },
        "CodeBuildProjectName": {
            "Description": "Name of the CodeBuild project",
            "Value": {
                "Ref": "CodeBuildProject"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CodeBuildProject"
                }
            }
        },
        "CodeDeployApplicationName": {
            "Description": "Name of the CodeDeploy application",
            "Value": {
                "Ref": "CodeDeployApplication"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CodeDeployApplication"
                }
            }
        },
        "EnvironmentSuffix": {
            "Description": "Environment suffix",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
                }
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: TAP Stack - Task Assignment Platform CloudFormation Template

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix
    ParameterLabels:
      EnvironmentSuffix:
        default: "Environment Suffix"

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: Environment suffix for resource naming (e.g., dev, staging, prod)
    Default: dev
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: Must contain only alphanumeric characters

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub VPC-${EnvironmentSuffix}

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub IGW-${EnvironmentSuffix}

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub PublicSubnet1-${EnvironmentSuffix}

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub PublicSubnet2-${EnvironmentSuffix}

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub PublicSubnet3-${EnvironmentSuffix}

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.101.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet1-${EnvironmentSuffix}

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.102.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet2-${EnvironmentSuffix}

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.103.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub PrivateSubnet3-${EnvironmentSuffix}

  NatEIP1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatEIP2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatEIP3:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub NatGateway1-${EnvironmentSuffix}

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP2.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub NatGateway2-${EnvironmentSuffix}

  NatGateway3:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP3.AllocationId
      SubnetId: !Ref PublicSubnet3
      Tags:
        - Key: Name
          Value: !Sub NatGateway3-${EnvironmentSuffix}

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub PublicRouteTable-${EnvironmentSuffix}

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub PrivateRouteTable1-${EnvironmentSuffix}

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub PrivateRouteTable2-${EnvironmentSuffix}

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  PrivateRouteTable3:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub PrivateRouteTable3-${EnvironmentSuffix}

  PrivateRoute3:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable3
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway3

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable3

  HrDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets for RDS instance
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: !Sub HrDBSubnetGroup-${EnvironmentSuffix}

  # Security Groups
  HrDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref HrAppSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub HrDBSecurityGroup-${EnvironmentSuffix}

  HrAppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for application instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref HrALBSecurityGroup
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref HrALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub HrAppSecurityGroup-${EnvironmentSuffix}

  HrALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub HrALBSecurityGroup-${EnvironmentSuffix}

  # SSM Parameters first (referenced by RDS)
  HrDBName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tapstack/${EnvironmentSuffix}/db/name
      Type: String
      Value: tapstackdb
      Tags:
        Environment: !Ref EnvironmentSuffix

  HrDBUsername:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tapstack/${EnvironmentSuffix}/db/username
      Type: String
      Value: admin
      Tags:
        Environment: !Ref EnvironmentSuffix

  HrDBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub /tapstack/${EnvironmentSuffix}/db/password
      Description: RDS master password for TapStack
      GenerateSecretString:
        SecretStringTemplate: '{"username":"admin"}'
        GenerateStringKey: password
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Application Load Balancer
  HrALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub HrALB-${EnvironmentSuffix}
      Scheme: internet-facing
      Type: application
      SecurityGroups:
        - !Ref HrALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      Tags:
        - Key: Name
          Value: !Sub HrALB-${EnvironmentSuffix}

  # Target Group for ALB
  HrTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub HrTG-${EnvironmentSuffix}
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Name
          Value: !Sub HrTargetGroup-${EnvironmentSuffix}

  # ALB Listener
  HrALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref HrTargetGroup
      LoadBalancerArn: !Ref HrALB
      Port: 80
      Protocol: HTTP

  # Launch Template for EC2 instances
  HrLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub HrLaunchTemplate-${EnvironmentSuffix}
      LaunchTemplateData:
        ImageId: ami-0182f373e66f89c85  # Amazon Linux 2023 AMI (x86_64)
        InstanceType: t3.micro
        IamInstanceProfile:
          Arn: !GetAtt HrAppInstanceProfile.Arn
        SecurityGroupIds:
          - !Ref HrAppSecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd
            systemctl start httpd
            systemctl enable httpd
            echo "<h1>Hello from HR App - ${EnvironmentSuffix}</h1>" > /var/www/html/index.html
            echo "<p>Instance ID: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)</p>" >> /var/www/html/index.html
            echo "<p>Availability Zone: $(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)</p>" >> /var/www/html/index.html
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub HrApp-${EnvironmentSuffix}

  # Auto Scaling Group
  HrAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub HrASG-${EnvironmentSuffix}
      LaunchTemplate:
        LaunchTemplateId: !Ref HrLaunchTemplate
        Version: !GetAtt HrLaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 6
      DesiredCapacity: 3
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      TargetGroupARNs:
        - !Ref HrTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: !Sub HrApp-${EnvironmentSuffix}
          PropagateAtLaunch: true

  # RDS Database
  HrDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub HrDB-${EnvironmentSuffix}
      DBInstanceClass: db.t3.micro
      Engine: mysql
      MasterUsername: admin
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${HrDBSecret}:SecretString:password}}'
      AllocatedStorage: 20
      DBName: tapstackdb
      MultiAZ: true
      PubliclyAccessible: false
      DBSubnetGroupName: !Ref HrDBSubnetGroup
      VPCSecurityGroups:
        - !Ref HrDBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub HrDB-${EnvironmentSuffix}

  # DynamoDB Table
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub TurnAroundPromptTable${EnvironmentSuffix}
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: Name
          Value: !Sub TurnAroundPromptTable${EnvironmentSuffix}
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # IAM Role for EC2 instances
  HrAppInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt TurnAroundPromptTable.Arn
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref HrDBSecret
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: 
                  - !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/tapstack/${EnvironmentSuffix}/*
      Tags:
        - Key: Name
          Value: !Sub HrAppInstanceRole-${EnvironmentSuffix}

  HrAppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref HrAppInstanceRole

  # Outputs
Outputs:
  TurnAroundPromptTableName:
    Description: Name of the DynamoDB table
    Value: !Ref TurnAroundPromptTable
    Export:
      Name: !Sub "${AWS::StackName}-TurnAroundPromptTableName"

  TurnAroundPromptTableArn:
    Description: ARN of the DynamoDB table
    Value: !GetAtt TurnAroundPromptTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TurnAroundPromptTableArn"

  HrALBName:
    Description: Name of the Application Load Balancer
    Value: !Ref HrALB
    Export:
      Name: !Sub "${AWS::StackName}-HrALBName"

  HrALBDNSName:
    Description: DNS Name of the Application Load Balancer
    Value: !GetAtt HrALB.DNSName
    Export:
      Name: !Sub "${AWS::StackName}-HrALBDNSName"

  HrDBEndpoint:
    Description: Endpoint of the RDS DB instance
    Value: !GetAtt HrDBInstance.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-HrDBEndpoint"

  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"

  PrivateSubnetIds:
    Description: Private subnet IDs
    Value: !Join [",", [!Ref PrivateSubnet1, !Ref PrivateSubnet2, !Ref PrivateSubnet3]]
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetIds"

  PublicSubnetIds:
    Description: Public subnet IDs
    Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2, !Ref PublicSubnet3]]
    Export:
      Name: !Sub "${AWS::StackName}-PublicSubnetIds"

  HrAppSecurityGroupId:
    Description: Security Group ID for application instances
    Value: !Ref HrAppSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrAppSecurityGroupId"

  HrAppInstanceProfileArn:
    Description: ARN of the IAM instance profile for application instances
    Value: !GetAtt HrAppInstanceProfile.Arn
    Export:
      Name: !Sub "${AWS::StackName}-HrAppInstanceProfileArn"

  StackName:
    Description: Name of this CloudFormation stack
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub "${AWS::StackName}-StackName"

  EnvironmentSuffix:
    Description: Environment suffix used for this deployment
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub "${AWS::StackName}-EnvironmentSuffix"

  HrALBArn:
    Description: ARN of the Application Load Balancer
    Value: !Ref HrALB
    Export:
      Name: !Sub "${AWS::StackName}-HrALBArn"

  HrDBInstanceIdentifier:
    Description: Identifier of the RDS DB instance
    Value: !Ref HrDBInstance
    Export:
      Name: !Sub "${AWS::StackName}-HrDBInstanceIdentifier"

  HrTargetGroupArn:
    Description: ARN of the Target Group
    Value: !Ref HrTargetGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrTargetGroupArn"

  HrTargetGroupName:
    Description: Name of the Target Group
    Value: !Ref HrTargetGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrTargetGroupName"

  HrAutoScalingGroupName:
    Description: Name of the Auto Scaling Group
    Value: !Ref HrAutoScalingGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrAutoScalingGroupName"

  HrLaunchTemplateName:
    Description: Name of the Launch Template
    Value: !Ref HrLaunchTemplate
    Export:
      Name: !Sub "${AWS::StackName}-HrLaunchTemplateName"

  HrALBSecurityGroupId:
    Description: Security Group ID for Application Load Balancer
    Value: !Ref HrALBSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrALBSecurityGroupId"

  HrDBSecurityGroupId:
    Description: Security Group ID for RDS Database
    Value: !Ref HrDBSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-HrDBSecurityGroupId"

  HrAppInstanceRoleArn:
    Description: ARN of the IAM role for application instances
    Value: !GetAtt HrAppInstanceRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-HrAppInstanceRoleArn"

  HrDBSecretArn:
    Description: ARN of the RDS database secret
    Value: !Ref HrDBSecret
    Export:
      Name: !Sub "${AWS::StackName}-HrDBSecretArn"
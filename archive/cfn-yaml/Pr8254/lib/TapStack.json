{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-ready serverless API backend with DynamoDB, Lambda, API Gateway, and monitoring",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "prod",
            "Description": "Environment name for resource naming",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ]
        }
    },
    "Resources": {
        "DynamoDBKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS Key for DynamoDB table encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow DynamoDB Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "dynamodb.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "EnableKeyRotation": true
            }
        },
        "DynamoDBKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/dynamodb-${Environment}-key"
                },
                "TargetKeyId": {
                    "Ref": "DynamoDBKMSKey"
                }
            }
        },
        "ItemsTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "items-table-${Environment}"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": {
                        "Ref": "DynamoDBKMSKey"
                    }
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": "serverless-api"
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "lambda-execution-role-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "LambdaExecutionPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:GetItem"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ItemsTable",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DynamoDBKMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ItemsLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "items-api-${Environment}"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "TABLE_NAME": {
                            "Ref": "ItemsTable"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport uuid\nimport os\nfrom datetime import datetime\n\n# Initialize DynamoDB client\ndynamodb = boto3.resource('dynamodb')\ntable_name = os.environ['TABLE_NAME']\ntable = dynamodb.Table(table_name)\n\ndef lambda_handler(event, context):\n    print(f\"Received event: {json.dumps(event)}\")\n    \n    try:\n        # Parse the request body\n        if 'body' in event:\n            if isinstance(event['body'], str):\n                body = json.loads(event['body'])\n            else:\n                body = event['body']\n        else:\n            return {\n                'statusCode': 400,\n                'headers': {\n                    'Content-Type': 'application/json',\n                    'Access-Control-Allow-Origin': '*'\n                },\n                'body': json.dumps({'error': 'Missing request body'})\n            }\n        \n        # Generate unique ID\n        item_id = str(uuid.uuid4())\n        \n        # Prepare item for DynamoDB\n        item = {\n            'id': item_id,\n            'name': body.get('name'),\n            'created_at': datetime.utcnow().isoformat(),\n            'updated_at': datetime.utcnow().isoformat()\n        }\n        \n        # Write to DynamoDB\n        table.put_item(Item=item)\n        \n        print(f\"Successfully created item with ID: {item_id}\")\n        \n        # Return success response\n        return {\n            'statusCode': 201,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({\n                'message': 'Item created successfully',\n                'id': item_id,\n                'item': item\n            })\n        }\n        \n    except json.JSONDecodeError as e:\n        print(f\"JSON decode error: {str(e)}\")\n        return {\n            'statusCode': 400,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({'error': 'Invalid JSON format'})\n        }\n    except Exception as e:\n        print(f\"Error: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({'error': 'Internal server error'})\n        }\n"
                },
                "Timeout": 30
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/items-api-${Environment}"
                },
                "RetentionInDays": 14
            }
        },
        "LambdaApiGatewayPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "ItemsLambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ItemsRestApi}/*/*"
                }
            }
        },
        "ItemsRestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "items-api-${Environment}"
                },
                "Description": "Serverless API for managing items",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Policy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": "execute-api:Invoke",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "ApiRequestValidator": {
            "Type": "AWS::ApiGateway::RequestValidator",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "Name": "request-body-validator",
                "ValidateRequestBody": true,
                "ValidateRequestParameters": false
            }
        },
        "ItemRequestModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "Name": "ItemRequest",
                "ContentType": "application/json",
                "Schema": {
                    "type": "object",
                    "properties": {
                        "name": {
                            "type": "string",
                            "minLength": 1,
                            "maxLength": 255
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "additionalProperties": false
                }
            }
        },
        "ItemsResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "ItemsRestApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "items"
            }
        },
        "ItemsPostMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "ResourceId": {
                    "Ref": "ItemsResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "RequestValidatorId": {
                    "Ref": "ApiRequestValidator"
                },
                "RequestModels": {
                    "application/json": {
                        "Ref": "ItemRequestModel"
                    }
                },
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ItemsLambdaFunction.Arn}/invocations"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        }
                    ]
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": 400,
                        "ResponseModels": {
                            "application/json": "Error"
                        }
                    },
                    {
                        "StatusCode": 500,
                        "ResponseModels": {
                            "application/json": "Error"
                        }
                    }
                ]
            }
        },
        "ItemsOptionsMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "ResourceId": {
                    "Ref": "ItemsResource"
                },
                "HttpMethod": "OPTIONS",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "MOCK",
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200,
                            "ResponseParameters": {
                                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
                                "method.response.header.Access-Control-Allow-Methods": "'POST,OPTIONS'",
                                "method.response.header.Access-Control-Allow-Origin": "'*'"
                            }
                        }
                    ],
                    "RequestTemplates": {
                        "application/json": "{\"statusCode\": 200}"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Headers": false,
                            "method.response.header.Access-Control-Allow-Methods": false,
                            "method.response.header.Access-Control-Allow-Origin": false
                        }
                    }
                ]
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "ItemsPostMethod",
                "ItemsOptionsMethod"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "Description": {
                    "Fn::Sub": "Deployment for ${Environment} environment"
                }
            }
        },
        "ApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "RestApiId": {
                    "Ref": "ItemsRestApi"
                },
                "DeploymentId": {
                    "Ref": "ApiDeployment"
                },
                "StageName": {
                    "Ref": "Environment"
                },
                "Description": {
                    "Fn::Sub": "${Environment} stage"
                },
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "MetricsEnabled": true
                    }
                ]
            }
        },
        "AlertsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "lambda-alerts-${Environment}"
                },
                "DisplayName": "Lambda Function Alerts"
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "lambda-errors-${Environment}"
                },
                "AlarmDescription": "Alarm for Lambda function errors",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "ItemsLambdaFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "AlertsTopic"
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaDurationAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "lambda-duration-${Environment}"
                },
                "AlarmDescription": "Alarm for Lambda function high duration",
                "MetricName": "Duration",
                "Namespace": "AWS/Lambda",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 25000,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "ItemsLambdaFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "AlertsTopic"
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        }
    },
    "Outputs": {
        "ApiInvokeUrl": {
            "Description": "API Gateway invocation URL for the items endpoint",
            "Value": {
                "Fn::Sub": "https://${ItemsRestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/items"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiInvokeUrl"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "Name of the DynamoDB table",
            "Value": {
                "Ref": "ItemsTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableName"
                }
            }
        },
        "SnsTopicArn": {
            "Description": "ARN of the SNS topic for alarms",
            "Value": {
                "Ref": "AlertsTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SnsTopicArn"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "ItemsLambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunctionArn"
                }
            }
        },
        "RestApiId": {
            "Description": "ID of the REST API",
            "Value": {
                "Ref": "ItemsRestApi"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RestApiId"
                }
            }
        },
        "KMSKeyId": {
            "Description": "ID of the KMS key used for DynamoDB encryption",
            "Value": {
                "Ref": "DynamoDBKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyId"
                }
            }
        }
    }
}
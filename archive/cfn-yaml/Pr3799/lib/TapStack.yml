AWSTemplateFormatVersion: '2010-09-09'
Description: 'Serverless Logistics Shipment Automation System with EventBridge, Lambda, DynamoDB, CloudWatch, and SNS'

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: Environment suffix to append to resource names (e.g., dev, staging, prod)
    Default: prod

  NotificationEmail:
    Type: String
    Description: Email address for SNS failure notifications
    Default: logistics-team@example.com
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: Must be a valid email address

Resources:
  # DynamoDB Table for Shipment Logs
  ShipmentLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'shipment-logs-${EnvironmentSuffix}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: shipmentId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: shipmentId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Application
          Value: LogisticsAutomation

  # SNS Topic for Failure Notifications
  ShipmentAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'shipment-alerts-${EnvironmentSuffix}'
      DisplayName: Shipment Processing Alerts
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # SNS Subscription
  AlertEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref ShipmentAlertTopic
      Endpoint: !Ref NotificationEmail

  # IAM Role for Lambda Function
  ShipmentProcessorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ShipmentProcessorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt ShipmentLogsTable.Arn
                  - !Sub '${ShipmentLogsTable.Arn}/index/*'
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref ShipmentAlertTopic
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Lambda Function for Shipment Processing
  ShipmentProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'shipment-processor-${EnvironmentSuffix}'
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt ShipmentProcessorRole.Arn
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          SHIPMENT_TABLE: !Ref ShipmentLogsTable
          SNS_TOPIC_ARN: !Ref ShipmentAlertTopic
          ENVIRONMENT: !Ref EnvironmentSuffix
      Code:
        ZipFile: |
          const { DynamoDBClient, PutItemCommand, UpdateItemCommand } = require('@aws-sdk/client-dynamodb');
          const { SNSClient, PublishCommand } = require('@aws-sdk/client-sns');
          const { CloudWatchClient, PutMetricDataCommand } = require('@aws-sdk/client-cloudwatch');

          const dynamodb = new DynamoDBClient();
          const sns = new SNSClient();
          const cloudwatch = new CloudWatchClient();

          exports.handler = async (event) => {
            console.log('Processing shipment event:', JSON.stringify(event, null, 2));
            
            const startTime = Date.now();
            let processedCount = 0;
            let failedCount = 0;
            const errors = [];
            
            try {
              // Handle EventBridge events
              const shipmentData = event.detail || event;
              
              // Validate shipment data
              if (!shipmentData.shipmentId) {
                throw new Error('Missing required field: shipmentId');
              }
              
              const timestamp = Date.now();
              const shipmentId = shipmentData.shipmentId;
              const status = shipmentData.status || 'RECEIVED';
              const location = shipmentData.location || 'UNKNOWN';
              const carrier = shipmentData.carrier || 'UNKNOWN';
              
              // Store shipment log in DynamoDB
              const putParams = {
                TableName: process.env.SHIPMENT_TABLE,
                Item: {
                  shipmentId: { S: shipmentId },
                  timestamp: { N: timestamp.toString() },
                  status: { S: status },
                  location: { S: location },
                  carrier: { S: carrier },
                  eventData: { S: JSON.stringify(shipmentData) },
                  processedAt: { S: new Date().toISOString() }
                }
              };
              
              await dynamodb.send(new PutItemCommand(putParams));
              processedCount++;
              
              console.log(`Successfully processed shipment: ${shipmentId}`);
              
              // Publish CloudWatch metrics
              await publishMetrics('ShipmentProcessed', 1, 'Count');
              await publishMetrics('ProcessingDuration', Date.now() - startTime, 'Milliseconds');
              
              // Send SNS notification for critical status updates
              if (['DELAYED', 'FAILED', 'LOST'].includes(status)) {
                await sendAlert(shipmentId, status, shipmentData);
              }
              
              return {
                statusCode: 200,
                body: JSON.stringify({
                  message: 'Shipment processed successfully',
                  shipmentId: shipmentId,
                  status: status,
                  timestamp: timestamp
                })
              };
              
            } catch (error) {
              console.error('Error processing shipment:', error);
              failedCount++;
              errors.push(error.message);
              
              // Publish failure metrics
              await publishMetrics('ShipmentProcessingError', 1, 'Count');
              
              // Send failure alert
              await sendAlert('SYSTEM', 'PROCESSING_ERROR', { error: error.message });
              
              return {
                statusCode: 500,
                body: JSON.stringify({
                  message: 'Error processing shipment',
                  error: error.message
                })
              };
            }
          };

          async function publishMetrics(metricName, value, unit) {
            try {
              const params = {
                Namespace: 'LogisticsAutomation',
                MetricData: [{
                  MetricName: metricName,
                  Value: value,
                  Unit: unit,
                  Timestamp: new Date(),
                  Dimensions: [
                    {
                      Name: 'Environment',
                      Value: process.env.ENVIRONMENT
                    }
                  ]
                }]
              };
              
              await cloudwatch.send(new PutMetricDataCommand(params));
            } catch (error) {
              console.error('Error publishing metrics:', error);
            }
          }

          async function sendAlert(shipmentId, status, data) {
            try {
              const message = {
                shipmentId: shipmentId,
                status: status,
                timestamp: new Date().toISOString(),
                data: data,
                environment: process.env.ENVIRONMENT
              };
              
              const params = {
                TopicArn: process.env.SNS_TOPIC_ARN,
                Subject: `Shipment Alert: ${status} - ${shipmentId}`,
                Message: JSON.stringify(message, null, 2)
              };
              
              await sns.send(new PublishCommand(params));
              console.log('Alert sent successfully');
            } catch (error) {
              console.error('Error sending alert:', error);
            }
          }
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Lambda Log Group
  ShipmentProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/shipment-processor-${EnvironmentSuffix}'
      RetentionInDays: 30

  # EventBridge Rule for Shipment Updates
  ShipmentUpdateRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub 'shipment-update-rule-${EnvironmentSuffix}'
      Description: Route shipment update events to Lambda processor
      State: ENABLED
      EventPattern:
        source:
          - logistics.shipments
        detail-type:
          - Shipment Update
          - Shipment Status Change
      Targets:
        - Arn: !GetAtt ShipmentProcessorFunction.Arn
          Id: ShipmentProcessorTarget
          RetryPolicy:
            MaximumRetryAttempts: 2
          DeadLetterConfig:
            Arn: !GetAtt DeadLetterQueue.Arn

  # Permission for EventBridge to invoke Lambda
  EventBridgeLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ShipmentProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ShipmentUpdateRule.Arn

  # Dead Letter Queue for Failed Events
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'shipment-dlq-${EnvironmentSuffix}'
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # CloudWatch Alarm for Lambda Errors
  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'shipment-processor-errors-${EnvironmentSuffix}'
      AlarmDescription: Alert when Lambda function has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ShipmentProcessorFunction
      AlarmActions:
        - !Ref ShipmentAlertTopic
      TreatMissingData: notBreaching

  # CloudWatch Alarm for Lambda Throttles
  LambdaThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'shipment-processor-throttles-${EnvironmentSuffix}'
      AlarmDescription: Alert when Lambda function is throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ShipmentProcessorFunction
      AlarmActions:
        - !Ref ShipmentAlertTopic
      TreatMissingData: notBreaching

  # CloudWatch Alarm for DLQ Messages
  DLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'shipment-dlq-messages-${EnvironmentSuffix}'
      AlarmDescription: Alert when messages are in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt DeadLetterQueue.QueueName
      AlarmActions:
        - !Ref ShipmentAlertTopic

  # CloudWatch Dashboard
  LogisticsDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub 'logistics-automation-${EnvironmentSuffix}'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "Lambda Invocations"}],
                  [".", "Errors", {"stat": "Sum", "label": "Lambda Errors"}],
                  [".", "Throttles", {"stat": "Sum", "label": "Lambda Throttles"}]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Lambda Performance",
                "period": 300,
                "dimensions": {
                  "FunctionName": "${ShipmentProcessorFunction}"
                }
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["LogisticsAutomation", "ShipmentProcessed", {"stat": "Sum"}],
                  [".", "ShipmentProcessingError", {"stat": "Sum"}]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Shipment Processing Metrics",
                "period": 300
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", {"stat": "Average"}]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Lambda Duration",
                "period": 300,
                "dimensions": {
                  "FunctionName": "${ShipmentProcessorFunction}"
                }
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", {"label": "DLQ Messages"}]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "title": "Dead Letter Queue",
                "period": 300,
                "dimensions": {
                  "QueueName": "${DeadLetterQueue.QueueName}"
                }
              }
            }
          ]
        }

Outputs:
  DynamoDBTableName:
    Description: DynamoDB table for shipment logs
    Value: !Ref ShipmentLogsTable
    Export:
      Name: !Sub '${AWS::StackName}-ShipmentLogsTable'

  LambdaFunctionArn:
    Description: ARN of the shipment processor Lambda function
    Value: !GetAtt ShipmentProcessorFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaArn'

  SNSTopicArn:
    Description: ARN of the SNS topic for alerts
    Value: !Ref ShipmentAlertTopic
    Export:
      Name: !Sub '${AWS::StackName}-SNSTopicArn'

  EventBridgeRuleName:
    Description: Name of the EventBridge rule
    Value: !Ref ShipmentUpdateRule
    Export:
      Name: !Sub '${AWS::StackName}-EventBridgeRule'

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=logistics-automation-${EnvironmentSuffix}'

  DeadLetterQueueURL:
    Description: URL of the Dead Letter Queue
    Value: !Ref DeadLetterQueue
    Export:
      Name: !Sub '${AWS::StackName}-DLQUrl'

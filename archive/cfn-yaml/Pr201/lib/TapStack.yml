AWSTemplateFormatVersion: "2010-09-09"
Description: "TAP Stack - Task Assignment Platform CloudFormation Template"
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix
Parameters:
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: "Environment suffix for resource naming (e.g., dev, staging, prod)"
    AllowedPattern: "^[a-zA-Z0-9]+$"
    ConstraintDescription: "Must contain only alphanumeric characters"
Resources:
  # S3 Bucket for IAM testing
  TestS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "test-security-bucket-${EnvironmentSuffix}-${AWS::AccountId}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
  # IAM Role for EC2 instances with S3 read-only access
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      Policies:
        - PolicyName: !Sub "ExplicitS3WriteDeny-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Deny
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:PutBucketPolicy
                  - s3:DeleteBucket
                  - s3:PutBucketAcl
                  - s3:PutObjectTagging
                  - s3:DeleteObjectTagging
                  - s3:PutBucketTagging
                Resource: "*"
  # Instance Profile for EC2 role
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole
  # IAM User for specific S3 bucket access
  TestIAMUser:
    Type: AWS::IAM::User
    Properties:
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
  # IAM Policy for read-only access to specific S3 bucket
  S3SpecificBucketReadOnlyPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "S3SpecificBucketReadOnly-${EnvironmentSuffix}"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource:
              - !GetAtt TestS3Bucket.Arn
              - !Sub "${TestS3Bucket.Arn}/*"
      Users:
        - !Ref TestIAMUser
  # Existing DynamoDB table
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub "TurnAroundPromptTable${EnvironmentSuffix}"
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      DeletionProtectionEnabled: false
      # Tags will be applied at stack level during deployment
Outputs:
  # S3 Bucket Outputs
  TestS3BucketName:
    Description: "Name of the test S3 bucket"
    Value: !Ref TestS3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-TestS3BucketName"
  TestS3BucketArn:
    Description: "ARN of the test S3 bucket"
    Value: !GetAtt TestS3Bucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TestS3BucketArn"
  # IAM Role Outputs
  EC2InstanceRoleName:
    Description: "Name of the EC2 instance role"
    Value: !Ref EC2InstanceRole
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceRoleName"
  EC2InstanceRoleArn:
    Description: "ARN of the EC2 instance role"
    Value: !GetAtt EC2InstanceRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceRoleArn"
  EC2InstanceProfileName:
    Description: "Name of the EC2 instance profile"
    Value: !Ref EC2InstanceProfile
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceProfileName"
  EC2InstanceProfileArn:
    Description: "ARN of the EC2 instance profile"
    Value: !GetAtt EC2InstanceProfile.Arn
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceProfileArn"
  # IAM User Outputs
  TestIAMUserName:
    Description: "Name of the test IAM user"
    Value: !Ref TestIAMUser
    Export:
      Name: !Sub "${AWS::StackName}-TestIAMUserName"
  TestIAMUserArn:
    Description: "ARN of the test IAM user"
    Value: !GetAtt TestIAMUser.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TestIAMUserArn"
  # IAM Policy Outputs
  S3SpecificBucketReadOnlyPolicyName:
    Description: "Name of the S3 specific bucket read-only policy"
    Value: !Ref S3SpecificBucketReadOnlyPolicy
    Export:
      Name: !Sub "${AWS::StackName}-S3SpecificBucketReadOnlyPolicyName"
  # DynamoDB Table Outputs
  TurnAroundPromptTableName:
    Description: "Name of the DynamoDB table"
    Value: !Ref TurnAroundPromptTable
    Export:
      Name: !Sub "${AWS::StackName}-TurnAroundPromptTableName"
  TurnAroundPromptTableArn:
    Description: "ARN of the DynamoDB table"
    Value: !GetAtt TurnAroundPromptTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TurnAroundPromptTableArn"
  # Stack Information
  StackName:
    Description: "Name of this CloudFormation stack"
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub "${AWS::StackName}-StackName"
  EnvironmentSuffix:
    Description: "Environment suffix used for this deployment"
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub "${AWS::StackName}-EnvironmentSuffix"

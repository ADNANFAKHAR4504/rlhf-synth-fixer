We need a CloudFormation template in YAML to build the secure foundation for our new Healthcare Patient Portal. This template is our blueprint for HIPAA compliance, so security is the top priority. All resources must follow the nova-prod-* naming convention.
The application allows patients to log in, view their medical records, and download lab results. The application servers will run on EC2 instances in private subnets. When a patient requests their records, the application will fetch structured data (like patient demographics and appointment history) from an RDS database and unstructured data (like PDF lab results) from an S3 bucket.
Here's the infrastructure we need to define:
The foundation of our security is a new, customer-managed KMS key. This single key will be used to encrypt everything: the RDS database, the S3 buckets, and the EBS volumes on our EC2 instances. Its key policy must be locked down, only allowing access for the specific services and roles defined in this template.
For the network, set up a VPC with public and private subnets. The public-facing component will be an Application Load Balancer (ALB), which will terminate HTTPS traffic and distribute it to the application instances. The ALB must be protected by an AWS WAF using a managed rule set to block common web attacks.
The application's EC2 instances will run in the private subnets. For administrative access, we'll need a bastion host in a public subnet. The security groups are critical: the bastion should only allow SSH from a specific trusted IP, and the application instances should only allow inbound traffic from the ALB and SSH traffic from the bastion.
For the database, the RDS instance must be in a private subnet, encrypted with our master KMS key, and only accessible from the application's security group. Instead of passing a password in a parameter, the template should fetch the database master password from AWS Secrets Manager, which will be configured to automatically rotate the credential every 30 days.
We'll have two S3 buckets. One will store the patient documents and must have public access blocked and be encrypted with our master KMS key. The second bucket is for logs. To meet compliance requirements for log immutability, this logging bucket must be configured with S3 Object Lock.
For auditing, a multi-region CloudTrail trail must deliver all logs to this immutable S3 logging bucket.
Finally, we need proactive alerting. Set up an SNS topic. Then, create an EventBridge rule that watches for any security group changes and sends an immediate notification to that SNS topic, alerting our compliance team.
Please provide the final infrastructure code in a single, well-commented YAML code block for the patient-portal-secure-foundation.yaml file.
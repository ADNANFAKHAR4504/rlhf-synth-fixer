Create an AWS CloudFormation template in YAML format to deploy a highly available load balancing architecture with automated failover capabilities for a financial services payment processing API that requires 99.99% uptime SLA.

Here are the requirements for the setup:

VPC and Networking: Create a VPC with both public and private subnets across two Availability Zones for maximum availability. Define appropriate CIDR blocks for the VPC and subnets to ensure proper network segmentation. Set up an Internet Gateway and attach it to the VPC to allow internet access from the public subnets. Create NAT Gateways in the public subnets to enable instances in private subnets to access the internet for software updates and patches. Define appropriate route tables and associate them with the VPC subnets to ensure correct routing of internal and external traffic. Ensure the public subnets route through the Internet Gateway for outbound traffic, and the private subnets route through the NAT Gateways for outbound internet access.

Network Security: Define security groups that follow the principle of least privilege and only allow necessary traffic. Create a security group for the Application Load Balancer that allows inbound HTTP (port 80) traffic from the internet (0.0.0.0/0). Create a security group for EC2 instances in the Auto Scaling groups that allows inbound traffic only from the Application Load Balancer security group on the application port. All security groups must explicitly deny SSH traffic (port 22) from 0.0.0.0/0 to meet security compliance requirements. Configure appropriate outbound rules for each security group to allow necessary traffic while maintaining security. Ensure security groups are properly referenced and associated with the correct resources.

Load Balancing: Deploy an Application Load Balancer (ALB) using AWS::ElasticLoadBalancingV2 resources across both availability zones in the public subnets with cross-zone load balancing enabled to distribute traffic evenly across all targets regardless of availability zone. Configure listeners for HTTP (port 80) traffic to handle incoming requests. Create a target group to register EC2 instances from the Auto Scaling groups with a health check path of /health that expects HTTP 200 response codes. Set health check intervals to 15 seconds with an unhealthy threshold of 2 consecutive failures to quickly detect and remove unhealthy instances from the load balancer rotation. Implement connection draining (deregistration delay) with a 300-second timeout to allow in-flight requests to complete gracefully before terminating instances. Configure sticky sessions using application-based cookies with a duration of 86400 seconds (24 hours) to maintain session affinity for users. Enable deletion protection on the Application Load Balancer to prevent accidental removal of this critical infrastructure component.

Auto Scaling and Compute: Set up Auto Scaling Groups within the private subnets across both availability zones to manage the lifecycle of EC2 instances that host the payment processing application. Configure each Auto Scaling Group with a minimum size of 2 instances, desired capacity of 3 instances, and maximum size of 6 instances to ensure high availability and handle traffic spikes while maintaining cost efficiency. Use a Launch Template with t3.medium instance type and Amazon Linux 2 as the operating system. The Launch Template must be configured to use IMDSv2 (Instance Metadata Service Version 2) for the metadata service to meet security requirements. Configure target tracking scaling policies that automatically adjust the number of instances based on 70% CPU utilization threshold to maintain optimal performance during varying load conditions. Ensure all EC2 instances in the Auto Scaling Groups are automatically registered with the Application Load Balancer target group for seamless traffic distribution. Enable detailed monitoring using CloudWatch for all EC2 instances to collect metrics at 1-minute intervals for better observability and faster response to issues.

Monitoring and Alarms: Set up CloudWatch alarms to monitor the health and performance of the load balancing architecture. Create an alarm that triggers when the unhealthy host count in the target group exceeds 50% of the total registered targets to alert operations teams of potential widespread failures. Configure alarms for critical metrics such as target response time, HTTP 5xx errors from targets, HTTP 5xx errors from the load balancer, and request count to proactively identify and respond to performance degradation. Set up CloudWatch Logs to capture application logs and system logs from EC2 instances for troubleshooting and auditing. Create a CloudWatch dashboard that displays key metrics including ALB request count, target health status, Auto Scaling group metrics, and alarm states for centralized monitoring and quick visibility into system health.

IAM Roles and Policies: Create IAM roles following the principle of least privilege to grant only the necessary permissions to AWS resources. Create an IAM role for EC2 instances that allows access to required AWS services such as CloudWatch for metrics and logs, and Systems Manager for management operations. Define IAM policies with tightly scoped permissions that specify exact actions and resources required by the application. Attach the IAM role to EC2 instances through an instance profile referenced in the Launch Template. Ensure all IAM roles and policies comply with security best practices and organizational policies for the financial services industry.

Template Features: The CloudFormation template must be fully parameterized to allow easy customization and reusability without editing the template directly. Create parameters for all configurable values including VPC CIDR block, subnet CIDR blocks for public and private subnets, EC2 instance type, SSH key pair name, Auto Scaling group size parameters (minimum, maximum, desired capacity), and any other values that may vary between deployments. Include appropriate default values where sensible and parameter constraints to validate inputs and prevent deployment errors. Use CloudFormation intrinsic functions such as Ref, GetAtt, Sub, Join, Select, and Fn::GetAZs to dynamically reference resources and construct values throughout the template. Use dynamic availability zone selection to ensure the template can be deployed in any AWS region. Include a comprehensive Outputs section that exports critical resource information including VPC ID, subnet IDs, Internet Gateway ID, NAT Gateway IDs, Application Load Balancer DNS name, target group ARN, Auto Scaling group name, CloudWatch dashboard URL, and security group IDs for easy reference and integration with other systems. Organize the template with clearly defined sections for Parameters, Resources, and Outputs with descriptive comments for maintainability and readability.

Please ensure the final YAML template is syntactically correct, follows AWS CloudFormation best practices, adheres to all specified constraints and requirements, and would successfully pass AWS CloudFormation validation and deployment without errors.

{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure containerized learning management system infrastructure for European university with GDPR compliance",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Unique suffix for resource naming to ensure uniqueness",
            "Default": "lms-prod",
            "AllowedPattern": "[a-z0-9-]+",
            "ConstraintDescription": "Must contain only lowercase alphanumeric characters and hyphens"
        },
        "ECSTaskCpu": {
            "Type": "String",
            "Description": "CPU units for ECS task (256, 512, 1024, 2048, 4096)",
            "Default": "1024",
            "AllowedValues": [
                "256",
                "512",
                "1024",
                "2048",
                "4096"
            ]
        },
        "ECSTaskMemory": {
            "Type": "String",
            "Description": "Memory for ECS task in MB",
            "Default": "2048",
            "AllowedValues": [
                "512",
                "1024",
                "2048",
                "4096",
                "8192"
            ]
        },
        "DatabaseInstanceClass": {
            "Type": "String",
            "Description": "Aurora PostgreSQL instance class",
            "Default": "db.t4g.medium"
        },
        "DatabaseName": {
            "Type": "String",
            "Description": "PostgreSQL database name",
            "Default": "lmsdb"
        },
        "RedisNodeType": {
            "Type": "String",
            "Description": "ElastiCache Redis node type",
            "Default": "cache.t4g.small"
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "igw-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.11.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.12.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "NATGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-eip-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "NATGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-rt-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-rt-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "DatabaseKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for Aurora PostgreSQL encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow RDS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "DatabaseKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/database-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "DatabaseKMSKey"
                }
            }
        },
        "EFSKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for EFS encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow EFS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "elasticfilesystem.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "EFSKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/efs-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "EFSKMSKey"
                }
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "database-credentials-${EnvironmentSuffix}"
                },
                "Description": "Aurora PostgreSQL database credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"lmsadmin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\",
                    "RequireEachIncludedType": true
                }
            }
        },
        "ECSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "ecs-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for ECS Fargate tasks",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 8080,
                        "ToPort": 8080,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "Allow HTTP traffic from VPC"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ecs-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "database-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for Aurora PostgreSQL",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "Allow PostgreSQL from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "database-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RedisSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "redis-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for ElastiCache Redis",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 6379,
                        "ToPort": 6379,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "Allow Redis from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "redis-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "efs-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for EFS",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2049,
                        "ToPort": 2049,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "Allow NFS from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "efs-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
                },
                "DBSubnetGroupDescription": "Subnet group for Aurora PostgreSQL",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraCluster": {
            "Type": "AWS::RDS::DBCluster",
            "DeletionPolicy": "Delete",
            "Properties": {
                "DBClusterIdentifier": {
                    "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
                },
                "Engine": "aurora-postgresql",
                "EngineVersion": "15.4",
                "DatabaseName": {
                    "Ref": "DatabaseName"
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
                },
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "BackupRetentionPeriod": 35,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "DatabaseKMSKey",
                        "Arn"
                    ]
                },
                "EnableCloudwatchLogsExports": [
                    "postgresql"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "BackupRetention",
                        "Value": "35 days automated + AWS Backup for 90 days total"
                    }
                ]
            }
        },
        "AuroraInstance1": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "Engine": "aurora-postgresql",
                "DBInstanceClass": {
                    "Ref": "DatabaseInstanceClass"
                },
                "PubliclyAccessible": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraInstance2": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "Engine": "aurora-postgresql",
                "DBInstanceClass": {
                    "Ref": "DatabaseInstanceClass"
                },
                "PubliclyAccessible": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RedisSubnetGroup": {
            "Type": "AWS::ElastiCache::SubnetGroup",
            "Properties": {
                "CacheSubnetGroupName": {
                    "Fn::Sub": "redis-subnet-group-${EnvironmentSuffix}"
                },
                "Description": "Subnet group for ElastiCache Redis",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ]
            }
        },
        "RedisReplicationGroup": {
            "Type": "AWS::ElastiCache::ReplicationGroup",
            "Properties": {
                "ReplicationGroupId": {
                    "Fn::Sub": "redis-${EnvironmentSuffix}"
                },
                "ReplicationGroupDescription": "Redis cluster for session management",
                "Engine": "redis",
                "EngineVersion": "7.1",
                "CacheNodeType": {
                    "Ref": "RedisNodeType"
                },
                "NumCacheClusters": 2,
                "AutomaticFailoverEnabled": true,
                "MultiAZEnabled": true,
                "CacheSubnetGroupName": {
                    "Ref": "RedisSubnetGroup"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "RedisSecurityGroup"
                    }
                ],
                "AtRestEncryptionEnabled": false,
                "TransitEncryptionEnabled": true,
                "TransitEncryptionMode": "required",
                "Port": 6379,
                "SnapshotRetentionLimit": 7,
                "SnapshotWindow": "03:00-05:00",
                "PreferredMaintenanceWindow": "sun:05:00-sun:07:00",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "redis-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSFileSystem": {
            "Type": "AWS::EFS::FileSystem",
            "Properties": {
                "Encrypted": true,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "EFSKMSKey",
                        "Arn"
                    ]
                },
                "PerformanceMode": "generalPurpose",
                "ThroughputMode": "bursting",
                "LifecyclePolicies": [
                    {
                        "TransitionToIA": "AFTER_30_DAYS"
                    }
                ],
                "FileSystemTags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "efs-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSMountTarget1": {
            "Type": "AWS::EFS::MountTarget",
            "Properties": {
                "FileSystemId": {
                    "Ref": "EFSFileSystem"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EFSSecurityGroup"
                    }
                ]
            }
        },
        "EFSMountTarget2": {
            "Type": "AWS::EFS::MountTarget",
            "Properties": {
                "FileSystemId": {
                    "Ref": "EFSFileSystem"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EFSSecurityGroup"
                    }
                ]
            }
        },
        "BackupVault": {
            "Type": "AWS::Backup::BackupVault",
            "Properties": {
                "BackupVaultName": {
                    "Fn::Sub": "backup-vault-${EnvironmentSuffix}"
                },
                "EncryptionKeyArn": {
                    "Fn::GetAtt": [
                        "DatabaseKMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "BackupPlan": {
            "Type": "AWS::Backup::BackupPlan",
            "Properties": {
                "BackupPlan": {
                    "BackupPlanName": {
                        "Fn::Sub": "database-backup-plan-${EnvironmentSuffix}"
                    },
                    "BackupPlanRule": [
                        {
                            "RuleName": "DailyBackups90Days",
                            "TargetBackupVault": {
                                "Ref": "BackupVault"
                            },
                            "ScheduleExpression": "cron(0 3 * * ? *)",
                            "StartWindowMinutes": 60,
                            "CompletionWindowMinutes": 120,
                            "Lifecycle": {
                                "DeleteAfterDays": 90
                            }
                        }
                    ]
                }
            }
        },
        "BackupRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "backup-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup",
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores"
                ]
            }
        },
        "BackupSelection": {
            "Type": "AWS::Backup::BackupSelection",
            "Properties": {
                "BackupPlanId": {
                    "Ref": "BackupPlan"
                },
                "BackupSelection": {
                    "SelectionName": {
                        "Fn::Sub": "aurora-backup-selection-${EnvironmentSuffix}"
                    },
                    "IamRoleArn": {
                        "Fn::GetAtt": [
                            "BackupRole",
                            "Arn"
                        ]
                    },
                    "Resources": [
                        {
                            "Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${AuroraCluster}"
                        }
                    ]
                }
            }
        },
        "ECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "ClusterName": {
                    "Fn::Sub": "ecs-cluster-${EnvironmentSuffix}"
                },
                "CapacityProviders": [
                    "FARGATE",
                    "FARGATE_SPOT"
                ],
                "DefaultCapacityProviderStrategy": [
                    {
                        "CapacityProvider": "FARGATE",
                        "Weight": 1,
                        "Base": 1
                    }
                ],
                "ClusterSettings": [
                    {
                        "Name": "containerInsights",
                        "Value": "enabled"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ecs-cluster-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ECSTaskRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "ecs-task-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "EFSAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "elasticfilesystem:ClientMount",
                                        "elasticfilesystem:ClientWrite",
                                        "elasticfilesystem:ClientRootAccess"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "EFSFileSystem",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ECSLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/ecs/lms-${EnvironmentSuffix}"
                },
                "RetentionInDays": 30
            }
        },
        "ECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "DependsOn": [
                "EFSMountTarget1",
                "EFSMountTarget2"
            ],
            "Properties": {
                "Family": {
                    "Fn::Sub": "lms-task-${EnvironmentSuffix}"
                },
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "Cpu": {
                    "Ref": "ECSTaskCpu"
                },
                "Memory": {
                    "Ref": "ECSTaskMemory"
                },
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "TaskRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    {
                        "Name": "lms-application",
                        "Image": "nginx:latest",
                        "Essential": true,
                        "PortMappings": [
                            {
                                "ContainerPort": 8080,
                                "Protocol": "tcp"
                            }
                        ],
                        "Environment": [
                            {
                                "Name": "DATABASE_HOST",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "AuroraCluster",
                                        "Endpoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "DATABASE_PORT",
                                "Value": "5432"
                            },
                            {
                                "Name": "DATABASE_NAME",
                                "Value": {
                                    "Ref": "DatabaseName"
                                }
                            },
                            {
                                "Name": "REDIS_HOST",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "RedisReplicationGroup",
                                        "PrimaryEndPoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "REDIS_PORT",
                                "Value": "6379"
                            }
                        ],
                        "Secrets": [
                            {
                                "Name": "DATABASE_USERNAME",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:username::"
                                }
                            },
                            {
                                "Name": "DATABASE_PASSWORD",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:password::"
                                }
                            }
                        ],
                        "MountPoints": [
                            {
                                "SourceVolume": "efs-storage",
                                "ContainerPath": "/mnt/efs",
                                "ReadOnly": false
                            }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ECSLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "lms"
                            }
                        }
                    }
                ],
                "Volumes": [
                    {
                        "Name": "efs-storage",
                        "EFSVolumeConfiguration": {
                            "FilesystemId": {
                                "Ref": "EFSFileSystem"
                            },
                            "TransitEncryption": "ENABLED",
                            "AuthorizationConfig": {
                                "IAM": "ENABLED"
                            }
                        }
                    }
                ]
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "ServiceName": {
                    "Fn::Sub": "lms-service-${EnvironmentSuffix}"
                },
                "Cluster": {
                    "Ref": "ECSCluster"
                },
                "TaskDefinition": {
                    "Ref": "ECSTaskDefinition"
                },
                "DesiredCount": 2,
                "LaunchType": "FARGATE",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "DISABLED",
                        "Subnets": [
                            {
                                "Ref": "PrivateSubnet1"
                            },
                            {
                                "Ref": "PrivateSubnet2"
                            }
                        ],
                        "SecurityGroups": [
                            {
                                "Ref": "ECSSecurityGroup"
                            }
                        ]
                    }
                },
                "HealthCheckGracePeriodSeconds": 60,
                "DeploymentConfiguration": {
                    "MaximumPercent": 200,
                    "MinimumHealthyPercent": 100,
                    "DeploymentCircuitBreaker": {
                        "Enable": true,
                        "Rollback": true
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "lms-service-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "ECSClusterName": {
            "Description": "ECS Cluster Name",
            "Value": {
                "Ref": "ECSCluster"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ECSCluster"
                }
            }
        },
        "DatabaseEndpoint": {
            "Description": "Aurora PostgreSQL Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseEndpoint"
                }
            }
        },
        "RedisEndpoint": {
            "Description": "ElastiCache Redis Primary Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "RedisReplicationGroup",
                    "PrimaryEndPoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisEndpoint"
                }
            }
        },
        "EFSFileSystemId": {
            "Description": "EFS File System ID",
            "Value": {
                "Ref": "EFSFileSystem"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EFSFileSystemId"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "Database Secret ARN",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseSecretArn"
                }
            }
        },
        "BackupVaultName": {
            "Description": "AWS Backup Vault Name",
            "Value": {
                "Ref": "BackupVault"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupVaultName"
                }
            }
        },
        "BackupPlanId": {
            "Description": "AWS Backup Plan ID",
            "Value": {
                "Ref": "BackupPlan"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupPlanId"
                }
            }
        }
    }
}
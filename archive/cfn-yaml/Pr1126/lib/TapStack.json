{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-ready infrastructure with VPC, S3, Lambda, and RDS PostgreSQL",
    "Parameters": {
        "DBUsername": {
            "Type": "String",
            "Default": "postgres",
            "Description": "Database administrator username",
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
            "ConstraintDescription": "Must begin with a letter and contain only alphanumeric characters"
        },
        "DBSecretName": {
            "Type": "String",
            "Default": "production/postgresql/password",
            "Description": "AWS Secrets Manager secret name for database password",
            "AllowedPattern": "^[a-zA-Z0-9/_+=.@-]+$",
            "ConstraintDescription": "Must be a valid secret name"
        }
    },
    "Resources": {
        "ProductionVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-VPC"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-IGW"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "ProductionVPC"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.1.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-Public-Subnet-1"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.2.0/24",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-Private-Subnet-1"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.3.0/24",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-Private-Subnet-2"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "NatGateway1EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-NAT-EIP-1"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "NatGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway1EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-NAT-Gateway-1"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-Public-Routes"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-Private-Routes-1"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DefaultPrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway1"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "S3AccessLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "myapp-access-logs-${AWS::AccountId}-${AWS::Region}"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-Access-Logs-Bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "S3ApplicationBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "myapp-data-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "S3AccessLogsBucket"
                    },
                    "LogFilePrefix": "application-bucket-logs/"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "NotificationConfiguration": {
                    "LambdaConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Function": {
                                "Fn::GetAtt": [
                                    "S3ProcessorLambda",
                                    "Arn"
                                ]
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-Data-Bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "S3BackupBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "myapp-backup-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "S3AccessLogsBucket"
                    },
                    "LogFilePrefix": "backup-bucket-logs/"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-Backup-Bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3ReadAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::myapp-*-${AWS::AccountId}-${AWS::Region}/*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::myapp-*-${AWS::AccountId}-${AWS::Region}"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-Lambda-Execution-Role"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "S3ProcessorLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "MyApp-S3-Processor-${AWS::Region}"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "MemorySize": 256,
                "Environment": {
                    "Variables": {
                        "ENVIRONMENT": "Production",
                        "RDS_ENDPOINT": {
                            "Fn::GetAtt": [
                                "RDSInstance",
                                "Endpoint.Address"
                            ]
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport logging\nimport os\n\n# Configure logging\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Process S3 events and log operational information\n    \"\"\"\n    try:\n        logger.info(f\"Processing S3 event: {json.dumps(event)}\")\n        \n        # Extract S3 event information\n        for record in event['Records']:\n            bucket_name = record['s3']['bucket']['name']\n            object_key = record['s3']['object']['key']\n            event_name = record['eventName']\n            \n            logger.info(f\"Event: {event_name}, Bucket: {bucket_name}, Object: {object_key}\")\n            \n            # Example: Read object metadata (following least privilege)\n            s3_client = boto3.client('s3')\n            try:\n                response = s3_client.head_object(Bucket=bucket_name, Key=object_key)\n                logger.info(f\"Object size: {response.get('ContentLength', 'Unknown')} bytes\")\n                logger.info(f\"Last modified: {response.get('LastModified', 'Unknown')}\")\n            except Exception as e:\n                logger.error(f\"Error reading object metadata: {str(e)}\")\n        \n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'S3 event processed successfully',\n                'environment': os.environ.get('ENVIRONMENT', 'Unknown')\n            })\n        }\n    \n    except Exception as e:\n        logger.error(f\"Error processing S3 event: {str(e)}\")\n        raise e\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-S3-Processor-Lambda"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "S3InvokeLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "S3ProcessorLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "s3.amazonaws.com",
                "SourceAccount": {
                    "Ref": "AWS::AccountId"
                },
                "SourceArn": {
                    "Fn::GetAtt": [
                        "S3ApplicationBucket",
                        "Arn"
                    ]
                }
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${S3ProcessorLambda}"
                },
                "RetentionInDays": 30,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "MyApp-Lambda-Logs"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": "production-db-subnet-group",
                "DBSubnetGroupDescription": "Subnet group for Production RDS instance",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-DB-Subnet-Group"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "RDSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "Production-RDS-SecurityGroup",
                "GroupDescription": "Security group for Production RDS PostgreSQL instance",
                "VpcId": {
                    "Ref": "ProductionVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "PostgreSQL access from VPC"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-RDS-SecurityGroup"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "RDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": "production-postgresql-db",
                "DBInstanceClass": "db.t3.medium",
                "Engine": "postgres",
                "EngineVersion": "14.18",
                "MasterUsername": {
                    "Ref": "DBUsername"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBSecretName}:SecretString:password}}"
                },
                "AllocatedStorage": 100,
                "StorageType": "gp2",
                "StorageEncrypted": true,
                "MultiAZ": true,
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "RDSSecurityGroup"
                    }
                ],
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "DeletionProtection": true,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "RDSMonitoringRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-PostgreSQL-DB"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "RDSMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "RDS-Enhanced-Monitoring-Role"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "S3AccessLogsBucketName": {
            "Description": "Name of the S3 access logs bucket",
            "Value": {
                "Ref": "S3AccessLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3AccessLogsBucket"
                }
            }
        },
        "S3ApplicationBucketName": {
            "Description": "Name of the main S3 application bucket",
            "Value": {
                "Ref": "S3ApplicationBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3ApplicationBucket"
                }
            }
        },
        "S3BackupBucketName": {
            "Description": "Name of the S3 backup bucket",
            "Value": {
                "Ref": "S3BackupBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3BackupBucket"
                }
            }
        },
        "RDSEndpointURL": {
            "Description": "RDS PostgreSQL endpoint URL",
            "Value": {
                "Fn::GetAtt": [
                    "RDSInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSEndpoint"
                }
            }
        },
        "VPCId": {
            "Description": "VPC ID for the production environment",
            "Value": {
                "Ref": "ProductionVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the S3 processor Lambda function",
            "Value": {
                "Ref": "S3ProcessorLambda"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunction"
                }
            }
        },
        "RDSSecurityGroupId": {
            "Description": "Security Group ID for RDS access",
            "Value": {
                "Ref": "RDSSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSSecurityGroup"
                }
            }
        }
    }
}
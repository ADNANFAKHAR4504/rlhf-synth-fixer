Create an AWS CloudFormation template in YAML format for a secure SaaS application environment in the us-east-1 region.

Here are the requirements for the setup:

VPC and Networking: Create a VPC with the CIDR block 10.0.0.0/16 with DNS hostnames and DNS support enabled. Set up public subnets (10.0.1.0/24 and 10.0.2.0/24), private subnets (10.0.3.0/24 and 10.0.4.0/24), and database subnets (10.0.5.0/24 and 10.0.6.0/24) across two Availability Zones. Include an Internet Gateway for the VPC and NAT Gateways with Elastic IPs in the public subnets to give private instances outbound internet access. Configure separate route tables for public subnets, private subnets with NAT Gateway routes, and database subnets. Enable VPC Flow Logs to CloudWatch Logs for network monitoring.

Security Groups and IAM: Configure Security Groups for EC2 instances to allow HTTP and HTTPS traffic from the internet, and a Security Group for Lambda functions with no inbound rules but all outbound traffic allowed. The Lambda functions need an IAM role with VPC access permissions, CloudWatch Logs permissions, S3 read-only access to the data bucket, and KMS decrypt permissions. Create IAM roles for API Gateway to push logs to CloudWatch, ECS task execution with standard ECS permissions, ECS task role with minimal S3 access to logs bucket, EC2 instance role with SSM managed instance core policy and S3 read access to logs bucket, and VPC Flow Log role with CloudWatch Logs permissions.

Encryption and KMS: Create a KMS key for encrypting S3 buckets and other resources with automatic key rotation enabled. The KMS key policy should allow root account full access and service access for S3, Lambda, and CloudWatch Logs. Create a KMS key alias named 'alias/xyzApp-main-key' for easy reference. All S3 buckets must have encryption enabled, block all public access, and have versioning enabled.

S3 Buckets and Logging: Create an S3 data bucket with KMS encryption (aws:kms), access logging to the logs bucket with 'access-logs/' prefix, and Retain deletion policy. Create an S3 logs bucket with AES256 encryption, ownership controls set to BucketOwnerPreferred, lifecycle policy to delete logs after 90 days, and Retain deletion policy. Create an S3 CloudTrail bucket with AES256 encryption, lifecycle policy to delete trail logs after 365 days, and proper bucket policy for CloudTrail service access. Configure bucket policies to deny insecure transport (enforce HTTPS only).

Lambda Functions: Include an AWS Lambda function named 'xyzApp-Lambda-ProcessData' running Python 3.11 with inline code that processes data. Deploy the Lambda function in the private subnets with the Lambda security group attached. Set Lambda timeout to 30 seconds and memory size to 256 MB. Create a dedicated CloudWatch Log Group '/aws/lambda/xyzApp-Lambda-ProcessData' with 30-day retention. Configure Lambda environment variables for ENVIRONMENT (Production) and S3_BUCKET reference.

API Gateway: Implement an API Gateway REST API with regional endpoint configuration. Create a '/data' resource path with a GET method that integrates with the Lambda function using AWS_PROXY integration. Configure a request validator to validate both request body and parameters. Enable access logging to CloudWatch Log Group '/aws/apigateway/xyzApp-RestAPI' with 30-day retention. Create a 'prod' stage with detailed logging at INFO level, data trace enabled, and metrics enabled. Implement a usage plan with throttling of 500 burst limit and 100 requests/second rate limit, plus a quota of 10000 requests per day. Configure API Gateway Account with CloudWatch Logs role and grant Lambda permission for API Gateway invocation.

CloudFront: Implement a CloudFront distribution with the API Gateway as origin (using the execute-api domain with '/prod' origin path). Configure HTTPS-only origin protocol policy with TLSv1.2 minimum SSL protocol. Set viewer protocol policy to redirect HTTP to HTTPS. Enable all HTTP methods (DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT) with caching only for GET and HEAD. Configure zero TTL caching (MinTTL=0, DefaultTTL=0, MaxTTL=0) for fresh API responses. Forward Authorization header and query strings but do not forward cookies. Use default CloudFront certificate and enable logging to the S3 logs bucket with 'cloudfront/' prefix. Set default root object to 'index.html' and use PriceClass_100.

ECS Fargate: Provision an ECS Cluster named 'xyzApp-ECSCluster-v2' using FARGATE and FARGATE_SPOT capacity providers with container insights enabled. Create an ECS Task Definition for 'xyzApp-TaskDefinition' family with 256 CPU units and 512 MB memory using awsvpc network mode. Define a container named 'xyzApp-Container-Main' using nginx:latest image with port 80 exposed. Configure awslogs log driver to send logs to CloudWatch Log Group '/ecs/xyzApp-Container' with 30-day retention. Create an ECS Service named 'xyzApp-ECSService' with desired count of 2 tasks deployed in private subnets with the EC2 security group and public IP assignment disabled.

CloudWatch Monitoring: Create CloudWatch Alarms to monitor Lambda function duration (alert when average exceeds 25 seconds over 5 minutes with 2 evaluation periods), Lambda errors (alert when sum exceeds 5 over 5 minutes), API Gateway 4XX errors (alert when sum exceeds 10 over 5 minutes), and API Gateway 5XX errors (alert when sum exceeds 5 over 5 minutes).

CloudTrail Auditing: Deploy a CloudTrail trail named 'xyzApp-CloudTrail' with logging enabled to the dedicated S3 CloudTrail bucket. Enable multi-region trail and include global service events. Configure event selectors to capture all read and write management events. Create CloudTrail bucket policy allowing CloudTrail service to check bucket ACL and put objects with bucket-owner-full-control ACL.

EC2 Launch Template: Create an EC2 Launch Template named 'xyzApp-LaunchTemplate' with placeholder AMI ID 'ami-12345678'. Support instance types t3.micro (default), t3.small, and t3.medium as user-selectable parameters. Attach EC2 instance profile with SSM and S3 read access. Configure user data to install and enable amazon-ssm-agent and mysql client. Create encrypted EBS root volume (20 GB gp3) with delete on termination enabled. Enable IMDSv2 (HttpTokens=required, HttpPutResponseHopLimit=1).

Template Features: Use parameters for configurable values like VPC CIDR (default 10.0.0.0/16), subnet CIDRs (defaults as specified above), and instance types (default t3.micro with allowed values t3.micro, t3.small, t3.medium). Add an Outputs section to the template to display important resource IDs like VPC ID, subnet IDs (public, private, database), Lambda function ARN and name, API Gateway ID and URL, CloudFront domain name, S3 bucket names and ARNs, ECS cluster name and task definition ARN, KMS key ID and ARN, CloudTrail name, NAT Gateway IDs, and stack name after deployment. Export appropriate outputs with stack name prefix for cross-stack references.

Naming and Tagging: All components must follow XYZ Corp's security best practices and naming conventions using 'xyzApp-ResourceType-Description' format. Use consistent prefixes 'xyzApp-' for resource names and 'xyzapp-' (lowercase) for S3 bucket names. Ensure all resources are tagged with Name (descriptive name matching resource), Environment (Production), Project (XYZSaaSApp), Owner (SecurityTeam), and CostCenter (Security).

Please ensure the final JSON template is valid and would pass standard AWS CloudFormation validation tests.

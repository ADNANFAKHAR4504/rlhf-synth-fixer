{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TapStack.yml — Aurora MySQL 8.0 cluster across 3 AZs with automatic failover, reader auto scaling (2–5 @ 70% CPU), 72h backtrack, 10s enhanced monitoring, Database Activity Streams (auto sync→async fallback) with dedicated CMK, CloudWatch alarms, and SNS notifications. Fully self-contained.\n",
    "Metadata": {
        "TemplateAuthor": "TapStack",
        "Version": "v3.0",
        "Notes": [
            "Pure YAML (no anchors/aliases; no flow-style maps/sequences)",
            "VPC, subnets, SGs created in-stack (no external params)"
        ]
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "prod-us",
            "Description": "Suffix added to all resource names to avoid collisions.",
            "AllowedPattern": "^[a-z0-9-]{3,20}$",
            "ConstraintDescription": "Must be 3–20 characters of lowercase letters, digits, and dashes."
        },
        "DBInstanceClass": {
            "Type": "String",
            "Default": "db.r6g.large",
            "AllowedPattern": "^[a-z0-9.-]+$",
            "Description": "Instance class for Aurora DB instances (e.g., db.r6g.large)."
        },
        "DBEngineVersion": {
            "Type": "String",
            "Default": "",
            "AllowedPattern": "^[0-9A-Za-z._-]*$",
            "Description": "(Optional) Aurora MySQL 8.0 engine version (aurora-mysql 3.x). Leave blank to use the latest supported in-region."
        },
        "MasterUsername": {
            "Type": "String",
            "Default": "admin",
            "AllowedPattern": "^[A-Za-z0-9_]+$",
            "MinLength": 1,
            "MaxLength": 16,
            "Description": "Master username."
        },
        "MonitoringIntervalSeconds": {
            "Type": "Number",
            "Default": 10,
            "AllowedValues": [
                1,
                5,
                10,
                15,
                30,
                60
            ],
            "Description": "Enhanced Monitoring interval in seconds (10s required)."
        },
        "PerformanceInsightsEnabled": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "Enable Performance Insights on instances."
        },
        "PerformanceInsightsRetention": {
            "Type": "Number",
            "Default": 7,
            "AllowedValues": [
                7,
                731
            ],
            "Description": "Performance Insights retention in days (7 required by spec)."
        },
        "BackupRetentionDays": {
            "Type": "Number",
            "Default": 35,
            "MinValue": 1,
            "MaxValue": 35,
            "Description": "Automated backup retention in days (35 days required)."
        },
        "PreferredBackupWindowUTC": {
            "Type": "String",
            "Default": "03:00-04:00",
            "AllowedPattern": "^([01][0-9]|2[0-3]):[0-5][0-9]-([01][0-9]|2[0-3]):[0-5][0-9]$",
            "Description": "Preferred backup window in UTC (HH:MM-HH:MM)."
        },
        "KmsKeyId": {
            "Type": "String",
            "Default": "",
            "Description": "Optional KMS Key ARN for cluster storage encryption. Blank = AWS managed key for Aurora storage."
        },
        "SNSNotificationEmail": {
            "Type": "String",
            "Default": "",
            "Description": "Optional email to subscribe for alarms/notifications. Blank = no subscription."
        },
        "ActivityStreamEnabled": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "Enable Database Activity Streams (DAS). Set 'false' to skip custom resource."
        },
        "ActivityStreamMode": {
            "Type": "String",
            "AllowedValues": [
                "sync",
                "async",
                "auto"
            ],
            "Default": "auto",
            "Description": "DAS mode. 'auto' tries sync then falls back to async if region doesn’t support sync."
        }
    },
    "Conditions": {
        "UseCustomerKms": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KmsKeyId"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateEmailSubscription": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SNSNotificationEmail"
                        },
                        ""
                    ]
                }
            ]
        },
        "EnablePI": {
            "Fn::Equals": [
                {
                    "Ref": "PerformanceInsightsEnabled"
                },
                "true"
            ]
        },
        "HasEngineVersion": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DBEngineVersion"
                        },
                        ""
                    ]
                }
            ]
        },
        "EnableActivityStreams": {
            "Fn::Equals": [
                {
                    "Ref": "ActivityStreamEnabled"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "Vpc": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.20.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RouteTablePrivateA": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-private-a-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RouteTablePrivateB": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-private-b-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RouteTablePrivateC": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-private-c-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "SubnetPrivateA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.20.10.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-a-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "SubnetPrivateB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.20.20.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-b-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "SubnetPrivateC": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.20.30.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-c-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "SubnetRouteAssocA": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "SubnetPrivateA"
                },
                "RouteTableId": {
                    "Ref": "RouteTablePrivateA"
                }
            }
        },
        "SubnetRouteAssocB": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "SubnetPrivateB"
                },
                "RouteTableId": {
                    "Ref": "RouteTablePrivateB"
                }
            }
        },
        "SubnetRouteAssocC": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "SubnetPrivateC"
                },
                "RouteTableId": {
                    "Ref": "RouteTablePrivateC"
                }
            }
        },
        "AppTierSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "App tier SG (${EnvironmentSuffix}) allowed to reach DB"
                },
                "VpcId": {
                    "Ref": "Vpc"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "app-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "Aurora DB SG - restrict to app tier only - ${EnvironmentSuffix}"
                },
                "VpcId": {
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "AppTierSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "db-sg-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DbSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "Aurora DB Subnet Group - ${EnvironmentSuffix}"
                },
                "DBSubnetGroupName": {
                    "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
                },
                "SubnetIds": [
                    {
                        "Ref": "SubnetPrivateA"
                    },
                    {
                        "Ref": "SubnetPrivateB"
                    },
                    {
                        "Ref": "SubnetPrivateC"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ClusterParameterGroup": {
            "Type": "AWS::RDS::DBClusterParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Cluster parameter group with binary logging enabled - ${EnvironmentSuffix}"
                },
                "Family": "aurora-mysql8.0",
                "Parameters": {
                    "binlog_format": "ROW",
                    "binlog_row_image": "FULL"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-cluster-parameter-group-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EnhancedMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "enhanced-monitoring-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "enhanced-monitoring-role-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "MasterSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "aurora-master-secret-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "Master password for Aurora cluster ${EnvironmentSuffix}"
                },
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\":\"${MasterUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "ExcludeCharacters": "\"@/\\\\",
                    "PasswordLength": 32
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-master-secret-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraDBCluster": {
            "Type": "AWS::RDS::DBCluster",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBClusterIdentifier": {
                    "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
                },
                "Engine": "aurora-mysql",
                "EngineVersion": {
                    "Fn::If": [
                        "HasEngineVersion",
                        {
                            "Ref": "DBEngineVersion"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DbSecurityGroup"
                    }
                ],
                "MasterUsername": {
                    "Ref": "MasterUsername"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${MasterSecret}:SecretString:password}}"
                },
                "BackupRetentionPeriod": {
                    "Ref": "BackupRetentionDays"
                },
                "PreferredBackupWindow": {
                    "Ref": "PreferredBackupWindowUTC"
                },
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::If": [
                        "UseCustomerKms",
                        {
                            "Ref": "KmsKeyId"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "DeletionProtection": false,
                "BacktrackWindow": 259200,
                "DBClusterParameterGroupName": {
                    "Ref": "ClusterParameterGroup"
                },
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "EnableCloudwatchLogsExports": [
                    "audit",
                    "error",
                    "general",
                    "slowquery"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraWriterInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-writer-instance-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-mysql",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "PromotionTier": 0,
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "SubnetPrivateA",
                        "AvailabilityZone"
                    ]
                },
                "MonitoringInterval": {
                    "Ref": "MonitoringIntervalSeconds"
                },
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "EnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "EnablePerformanceInsights": {
                    "Fn::If": [
                        "EnablePI",
                        true,
                        false
                    ]
                },
                "PerformanceInsightsRetentionPeriod": {
                    "Fn::If": [
                        "EnablePI",
                        {
                            "Ref": "PerformanceInsightsRetention"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "PubliclyAccessible": false,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-writer-instance-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraReaderAInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-reader-a-instance-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-mysql",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "PromotionTier": 1,
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "SubnetPrivateB",
                        "AvailabilityZone"
                    ]
                },
                "MonitoringInterval": {
                    "Ref": "MonitoringIntervalSeconds"
                },
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "EnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "EnablePerformanceInsights": {
                    "Fn::If": [
                        "EnablePI",
                        true,
                        false
                    ]
                },
                "PerformanceInsightsRetentionPeriod": {
                    "Fn::If": [
                        "EnablePI",
                        {
                            "Ref": "PerformanceInsightsRetention"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "PubliclyAccessible": false,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-reader-a-instance-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraReaderBInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-reader-b-instance-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-mysql",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "PromotionTier": 2,
                "AvailabilityZone": {
                    "Fn::GetAtt": [
                        "SubnetPrivateC",
                        "AvailabilityZone"
                    ]
                },
                "MonitoringInterval": {
                    "Ref": "MonitoringIntervalSeconds"
                },
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "EnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "EnablePerformanceInsights": {
                    "Fn::If": [
                        "EnablePI",
                        true,
                        false
                    ]
                },
                "PerformanceInsightsRetentionPeriod": {
                    "Fn::If": [
                        "EnablePI",
                        {
                            "Ref": "PerformanceInsightsRetention"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "PubliclyAccessible": false,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-reader-b-instance-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraReadReplicaScalableTarget": {
            "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
            "DependsOn": [
                "AuroraWriterInstance",
                "AuroraReaderAInstance",
                "AuroraReaderBInstance"
            ],
            "Properties": {
                "MaxCapacity": 5,
                "MinCapacity": 2,
                "ResourceId": {
                    "Fn::Sub": "cluster:${AuroraDBCluster}"
                },
                "ScalableDimension": "rds:cluster:ReadReplicaCount",
                "ServiceNamespace": "rds"
            }
        },
        "AuroraReadReplicaScalingPolicy": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "aurora-autoscaling-scaling-policy-${EnvironmentSuffix}"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "AuroraReadReplicaScalableTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "TargetValue": 70,
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "RDSReaderAverageCPUUtilization"
                    },
                    "ScaleInCooldown": 300,
                    "ScaleOutCooldown": 300
                }
            }
        },
        "FailoverSnsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "sns-failover-topic-${EnvironmentSuffix}"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sns-failover-topic-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "FailoverSnsSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Condition": "CreateEmailSubscription",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "FailoverSnsTopic"
                },
                "Endpoint": {
                    "Ref": "SNSNotificationEmail"
                }
            }
        },
        "ReplicaLagAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "alarm-replica-lag-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm when Aurora replica lag (max across readers) exceeds 1 second.",
                "Namespace": "AWS/RDS",
                "MetricName": "AuroraReplicaLagMaximum",
                "Dimensions": [
                    {
                        "Name": "DBClusterIdentifier",
                        "Value": {
                            "Ref": "AuroraDBCluster"
                        }
                    }
                ],
                "Statistic": "Maximum",
                "Period": 60,
                "EvaluationPeriods": 3,
                "DatapointsToAlarm": 2,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "Unit": "Seconds",
                "AlarmActions": [
                    {
                        "Ref": "FailoverSnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "FailoverSnsTopic"
                    }
                ]
            }
        },
        "WriterCpuAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "alarm-writer-cpu-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm when writer CPU exceeds 80%.",
                "Namespace": "AWS/RDS",
                "MetricName": "CPUUtilization",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "AuroraWriterInstance"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 60,
                "EvaluationPeriods": 5,
                "DatapointsToAlarm": 3,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "Unit": "Percent",
                "AlarmActions": [
                    {
                        "Ref": "FailoverSnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "FailoverSnsTopic"
                    }
                ]
            }
        },
        "DasKmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS CMK for Aurora Database Activity Streams - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowAccountRoot",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowRDSServiceLinkedRoleUse",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "kms:GrantIsForAWSResource": "true"
                                },
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "rds.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AllowRDSServicePrincipalUse",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "kms:GrantIsForAWSResource": "true"
                                },
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "rds.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "das-kms-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DasKmsAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/das-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "DasKmsKey"
                }
            }
        },
        "ActivityStreamLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "das-custom-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "das-custom-inline-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "rds:StartActivityStream",
                                        "rds:StopActivityStream",
                                        "rds:DescribeDBClusters"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DasKmsKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:CreateGrant"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DasKmsKey",
                                            "Arn"
                                        ]
                                    },
                                    "Condition": {
                                        "Bool": {
                                            "kms:GrantIsForAWSResource": "true"
                                        },
                                        "StringEquals": {
                                            "kms:ViaService": {
                                                "Fn::Sub": "rds.${AWS::Region}.amazonaws.com"
                                            }
                                        }
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "das-custom-role-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ActivityStreamLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "enable-das-${EnvironmentSuffix}"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "ActivityStreamLambdaRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.12",
                "Handler": "index.handler",
                "Timeout": 600,
                "MemorySize": 256,
                "Code": {
                    "ZipFile": "import boto3, json, logging, time, urllib.request, botocore\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef _respond(url, status, req, data, phys_id, reason=None):\n  short_reason = (reason[:512] + '…') if reason and len(reason) > 512 else (reason or \"See CloudWatch logs for details.\")\n  body = {\n    \"Status\": status,\n    \"Reason\": short_reason,\n    \"PhysicalResourceId\": phys_id or \"RDSActivityStreamCR\",\n    \"StackId\": req[\"StackId\"],\n    \"RequestId\": req[\"RequestId\"],\n    \"LogicalResourceId\": req[\"LogicalResourceId\"],\n    \"Data\": data\n  }\n  s = json.dumps(body)\n  rq = urllib.request.Request(url, data=s.encode(\"utf-8\"), method=\"PUT\",\n                              headers={\"content-type\": \"\", \"content-length\": str(len(s))})\n  with urllib.request.urlopen(rq) as resp:\n    logger.info(\"CFN callback status: %s\", resp.status)\n\ndef wait_cluster_ready(rds, cluster_id, timeout=900):\n  start = time.time()\n  while time.time() - start < timeout:\n    desc = rds.describe_db_clusters(DBClusterIdentifier=cluster_id)[\"DBClusters\"][0]\n    status = desc.get(\"Status\", \"\")\n    as_status = desc.get(\"ActivityStreamStatus\", \"stopped\")\n    logger.info(\"Cluster %s status=%s, activityStream=%s\", cluster_id, status, as_status)\n    if status == \"available\" and as_status not in (\"starting\", \"stopping\"):\n      return desc\n    time.sleep(10)\n  raise TimeoutError(f\"DB cluster {cluster_id} not ready in {timeout}s\")\n\ndef wait_kms_ready(kms, key_arn, timeout=300):\n  \"\"\"Wait until CMK exists, is Enabled, correct usage, and not pending deletion.\"\"\"\n  start = time.time()\n  last_err = None\n  while time.time() - start < timeout:\n    try:\n      meta = kms.describe_key(KeyId=key_arn)[\"KeyMetadata\"]\n      state = meta.get(\"KeyState\")\n      usage = meta.get(\"KeyUsage\")\n      mgr = meta.get(\"KeyManager\")\n      logger.info(\"KMS %s state=%s usage=%s mgr=%s\", key_arn, state, usage, mgr)\n      if state == \"Enabled\" and usage == \"ENCRYPT_DECRYPT\" and meta.get(\"DeletionDate\") is None:\n        return True\n    except Exception as e:\n      last_err = e\n      logger.info(\"KMS not ready yet: %s\", e)\n    time.sleep(5)\n  raise TimeoutError(f\"KMS key not ready in {timeout}s: {last_err}\")\n\ndef start_with_required_kms(rds, cluster_arn, desired_mode, kms_key):\n  if not kms_key:\n    raise ValueError(\"Effective KmsKeyId is required but not provided\")\n  args = {\n    \"ResourceArn\": cluster_arn,\n    \"Mode\": desired_mode,\n    \"KmsKeyId\": kms_key,\n    \"ApplyImmediately\": True\n  }\n  rds.start_activity_stream(**args)\n\ndef handler(event, context):\n  logger.info(\"Event: %s\", json.dumps(event))\n  req_type = event[\"RequestType\"]\n  props = event[\"ResourceProperties\"]\n  cluster_arn = props[\"ClusterArn\"]\n  cluster_id = props.get(\"ClusterIdentifier\")\n  mode_param = str(props.get(\"Mode\", \"auto\")).lower()   # sync | async | auto\n  kms_key = props.get(\"KmsKeyId\") or None\n\n  rds = boto3.client(\"rds\")\n  kms = boto3.client(\"kms\")\n  phys_id = f\"{cluster_arn}/activity-stream\"\n\n  try:\n    if req_type in (\"Create\", \"Update\"):\n      # Ensure the KMS key is real & enabled before proceeding\n      wait_kms_ready(kms, kms_key)\n\n      desc = wait_cluster_ready(rds, cluster_id) if cluster_id else {}\n      as_status = desc.get(\"ActivityStreamStatus\", \"stopped\")\n      if as_status == \"started\":\n        _respond(event[\"ResponseURL\"], \"SUCCESS\", event,\n                {\"ActivityStream\": \"ALREADY_STARTED\",\n                  \"Mode\": desc.get(\"ActivityStreamMode\", \"\"),\n                  \"KinesisStreamName\": desc.get(\"ActivityStreamKinesisStreamName\", \"\")},\n                phys_id, reason=\"Already enabled\")\n        return\n\n      desired_mode = \"sync\" if mode_param in (\"sync\",\"auto\") else \"async\"\n\n      # Try desired mode; if region doesn't support sync, fall back to async\n      try:\n        start_with_required_kms(rds, cluster_arn, desired_mode, kms_key)\n      except botocore.exceptions.ClientError as e:\n        msg = str(e)\n        code = e.response.get(\"Error\", {}).get(\"Code\", \"\")\n        logger.warning(\"StartActivityStream(%s) failed: %s / %s\", desired_mode, code, msg)\n        if \"not supported in this region\" in msg.lower() and desired_mode == \"sync\":\n          start_with_required_kms(rds, cluster_arn, \"async\", kms_key)\n          desired_mode = \"async\"\n        else:\n          raise\n\n      time.sleep(15)\n      desc2 = rds.describe_db_clusters(DBClusterIdentifier=cluster_id)[\"DBClusters\"][0] if cluster_id else {}\n      _respond(event[\"ResponseURL\"], \"SUCCESS\", event,\n              {\"ActivityStream\": \"STARTED\",\n                \"Mode\": desc2.get(\"ActivityStreamMode\", desired_mode),\n                \"KinesisStreamName\": desc2.get(\"ActivityStreamKinesisStreamName\", \"\")},\n              phys_id, reason=f\"Enabled in {desc2.get('ActivityStreamMode', desired_mode)} mode\")\n\n    elif req_type == \"Delete\":\n      try:\n        desc = wait_cluster_ready(rds, cluster_id, timeout=300) if cluster_id else {}\n        if desc.get(\"ActivityStreamStatus\") == \"started\":\n          rds.stop_activity_stream(ResourceArn=cluster_arn, ApplyImmediately=True)\n          time.sleep(5)\n      except Exception as e:\n        logger.warning(\"StopActivityStream warning: %s\", e)\n      _respond(event[\"ResponseURL\"], \"SUCCESS\", event,\n              {\"ActivityStream\": \"STOPPED_OR_NOT_ENABLED\"}, phys_id,\n              reason=\"Disabled or not enabled\")\n\n  except Exception as e:\n    logger.exception(\"DAS operation failed\")\n    _respond(event[\"ResponseURL\"], \"FAILED\", event, {\"Error\": str(e)}, phys_id, reason=str(e))\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "enable-das-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ActivityStreamEnabler": {
            "Condition": "EnableActivityStreams",
            "Type": "Custom::RDSActivityStream",
            "DependsOn": [
                "DasKmsAlias",
                "AuroraWriterInstance",
                "AuroraReaderAInstance",
                "AuroraReaderBInstance"
            ],
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "ActivityStreamLambda",
                        "Arn"
                    ]
                },
                "ClusterArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:rds:${AWS::Region}:${AWS::AccountId}:cluster:aurora-cluster-${EnvironmentSuffix}"
                },
                "ClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Mode": {
                    "Ref": "ActivityStreamMode"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "DasKmsKey",
                        "Arn"
                    ]
                }
            }
        }
    },
    "Outputs": {
        "ClusterEndpoint": {
            "Description": "Writer endpoint of the Aurora cluster.",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraDBCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "cluster-endpoint-${EnvironmentSuffix}"
                }
            }
        },
        "ReaderEndpoint": {
            "Description": "Reader endpoint of the Aurora cluster.",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraDBCluster",
                    "ReadEndpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "reader-endpoint-${EnvironmentSuffix}"
                }
            }
        },
        "KinesisStreamArn": {
            "Condition": "EnableActivityStreams",
            "Description": "ARN of the Kinesis stream receiving Database Activity Streams.",
            "Value": {
                "Fn::Sub": "arn:${AWS::Partition}:kinesis:${AWS::Region}:${AWS::AccountId}:stream/${ActivityStreamEnabler.KinesisStreamName}\n"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "kinesis-das-stream-arn-${EnvironmentSuffix}"
                }
            }
        },
        "AppTierSecurityGroupId": {
            "Description": "Security Group ID applications should use to reach the DB (3306).",
            "Value": {
                "Ref": "AppTierSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "app-sg-${EnvironmentSuffix}"
                }
            }
        }
    }
}
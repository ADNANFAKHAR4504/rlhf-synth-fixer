{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Serverless image processing service with S3, Lambda, DynamoDB, and API Gateway - Enhanced with security and performance best practices",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix"
                    ]
                },
                {
                    "Label": {
                        "default": "Logging Configuration"
                    },
                    "Parameters": [
                        "LogRetentionInDays"
                    ]
                },
                {
                    "Label": {
                        "default": "Performance Configuration"
                    },
                    "Parameters": [
                        "LambdaMemorySize",
                        "LambdaTimeout"
                    ]
                }
            ],
            "ParameterLabels": {
                "EnvironmentSuffix": {
                    "default": "Environment Suffix (e.g., dev, staging, prod)"
                },
                "LogRetentionInDays": {
                    "default": "CloudWatch Logs Retention Period"
                },
                "LambdaMemorySize": {
                    "default": "Lambda Memory Allocation"
                },
                "LambdaTimeout": {
                    "default": "Lambda Timeout"
                }
            }
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "prod",
            "Description": "Environment suffix for resource naming and tagging"
        },
        "LogRetentionInDays": {
            "Type": "Number",
            "Default": 30,
            "AllowedValues": [
                1,
                3,
                5,
                7,
                14,
                30,
                60,
                90,
                120,
                150,
                180,
                365,
                400,
                545,
                731,
                1827,
                3653
            ],
            "Description": "CloudWatch Logs retention period in days for compliance"
        },
        "LambdaMemorySize": {
            "Type": "Number",
            "Default": 1024,
            "MinValue": 128,
            "MaxValue": 10240,
            "Description": "Memory allocation for Lambda function (MB)"
        },
        "LambdaTimeout": {
            "Type": "Number",
            "Default": 300,
            "MinValue": 1,
            "MaxValue": 900,
            "Description": "Lambda function timeout in seconds"
        }
    },
    "Resources": {
        "ImageProcessingTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "image-processing-${EnvironmentSuffix}"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "ImageID",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "ProcessedAt",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "ImageID",
                        "KeyType": "HASH"
                    }
                ],
                "GlobalSecondaryIndexes": [
                    {
                        "IndexName": "ProcessedAtIndex",
                        "KeySchema": [
                            {
                                "AttributeName": "ProcessedAt",
                                "KeyType": "HASH"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        }
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "SSESpecification": {
                    "SSEEnabled": true
                },
                "StreamSpecification": {
                    "StreamViewType": "NEW_AND_OLD_IMAGES"
                },
                "DeletionProtectionEnabled": false,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ImageProcessorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "image-processor-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "ImageProcessorPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:GetObjectTagging"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::image-uploads-${AWS::AccountId}-${EnvironmentSuffix}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::image-uploads-${AWS::AccountId}-${EnvironmentSuffix}"
                                    },
                                    "Condition": {
                                        "StringLike": {
                                            "s3:prefix": [
                                                "*.jpg",
                                                "*.jpeg",
                                                "*.png",
                                                "*.gif"
                                            ]
                                        }
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:GetItem"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ImageProcessingTable",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ImageProcessingTable.Arn}/index/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/image-processor-${EnvironmentSuffix}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "xray:PutTraceSegments",
                                        "xray:PutTelemetryRecords"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:SendMessage"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ImageProcessorDLQ",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ImageProcessorLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/image-processor-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionInDays"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "LogGroupKMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "LogGroupKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS Key for encrypting CloudWatch Logs - ${EnvironmentSuffix}"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnEquals": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/image-processor-${EnvironmentSuffix}"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "LogGroupKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/logs-key-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "LogGroupKMSKey"
                }
            }
        },
        "ImageProcessorDLQ": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": {
                    "Fn::Sub": "image-processor-dlq-${EnvironmentSuffix}"
                },
                "MessageRetentionPeriod": 1209600,
                "KmsMasterKeyId": "alias/aws/sqs",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ImageProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": "ImageProcessorLogGroup",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "image-processor-${EnvironmentSuffix}"
                },
                "Runtime": "python3.12",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "ImageProcessorRole",
                        "Arn"
                    ]
                },
                "Timeout": {
                    "Ref": "LambdaTimeout"
                },
                "MemorySize": {
                    "Ref": "LambdaMemorySize"
                },
                "TracingConfig": {
                    "Mode": "Active"
                },
                "DeadLetterConfig": {
                    "TargetArn": {
                        "Fn::GetAtt": [
                            "ImageProcessorDLQ",
                            "Arn"
                        ]
                    }
                },
                "Environment": {
                    "Variables": {
                        "DYNAMODB_TABLE": {
                            "Ref": "ImageProcessingTable"
                        },
                        "LOG_LEVEL": "INFO",
                        "POWERTOOLS_SERVICE_NAME": "image-processor",
                        "POWERTOOLS_METRICS_NAMESPACE": "ServerlessApp",
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport uuid\nimport hashlib\nfrom datetime import datetime, timezone\nfrom urllib.parse import unquote_plus\nimport logging\nfrom botocore.exceptions import ClientError, BotoCoreError\nimport re\n\n# Configure logging\nlog_level = os.environ.get('LOG_LEVEL', 'INFO')\nlogger = logging.getLogger()\nlogger.setLevel(getattr(logging, log_level))\n\n# Initialize AWS clients with retry configuration\nconfig = boto3.session.Config(\n    region_name=os.environ.get('AWS_REGION', 'us-west-2'),\n    retries={'max_attempts': 3, 'mode': 'adaptive'}\n)\ns3_client = boto3.client('s3', config=config)\ndynamodb = boto3.resource('dynamodb', config=config)\ntable = dynamodb.Table(os.environ['DYNAMODB_TABLE'])\n\n# Supported image types\nSUPPORTED_EXTENSIONS = {'.jpg', '.jpeg', '.png', '.gif'}\nMAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB\n\ndef lambda_handler(event, context):\n    try:\n        logger.info(f\"Processing event with request ID: {context.aws_request_id}\")\n        \n        # Handle S3 event\n        if 'Records' in event and event['Records']:\n            results = []\n            for record in event['Records']:\n                if 's3' in record:\n                    bucket = record['s3']['bucket']['name']\n                    key = unquote_plus(record['s3']['object']['key'])\n                    result = process_image_from_s3(bucket, key, context.aws_request_id)\n                    results.append(result)\n            return {'processed_images': results}\n        \n        # Handle API Gateway event\n        elif 'httpMethod' in event and event['httpMethod'] == 'POST':\n            body = json.loads(event.get('body', '{}'))\n            bucket = body.get('bucket')\n            key = body.get('key')\n            \n            if not key:\n                return {\n                    'statusCode': 400,\n                    'headers': {'Content-Type': 'application/json'},\n                    'body': json.dumps({'error': 'Missing required parameter: key'})\n                }\n            \n            if not bucket:\n                return {\n                    'statusCode': 400,\n                    'headers': {'Content-Type': 'application/json'},\n                    'body': json.dumps({'error': 'Missing required parameter: bucket'})\n                }\n            \n            # Validate input\n            if not is_valid_s3_key(key):\n                return {\n                    'statusCode': 400,\n                    'headers': {'Content-Type': 'application/json'},\n                    'body': json.dumps({'error': 'Invalid key format'})\n                }\n            \n            result = process_image_from_s3(bucket, key, context.aws_request_id)\n            return {\n                'statusCode': 200,\n                'headers': {'Content-Type': 'application/json'},\n                'body': json.dumps(result)\n            }\n        \n        return {\n            'statusCode': 200,\n            'headers': {'Content-Type': 'application/json'},\n            'body': json.dumps({'message': 'Processing completed'})\n        }\n        \n    except json.JSONDecodeError as e:\n        logger.error(f\"Invalid JSON in request body: {str(e)}\")\n        return {\n            'statusCode': 400,\n            'headers': {'Content-Type': 'application/json'},\n            'body': json.dumps({'error': 'Invalid JSON format'})\n        }\n    except Exception as e:\n        logger.error(f\"Unexpected error: {str(e)}\", exc_info=True)\n        return {\n            'statusCode': 500,\n            'headers': {'Content-Type': 'application/json'},\n            'body': json.dumps({'error': 'Internal server error'})\n        }\n\ndef is_valid_s3_key(key):\n    \"\"\"Validate S3 key format and check for supported extensions\"\"\"\n    if not key or len(key) > 1024:\n        return False\n    \n    # Check for path traversal attempts\n    if '..' in key or key.startswith('/'):\n        return False\n    \n    # Check file extension\n    extension = os.path.splitext(key.lower())[1]\n    return extension in SUPPORTED_EXTENSIONS\n\ndef process_image_from_s3(bucket, key, request_id):\n    logger.info(f\"Processing image: {bucket}/{key} (Request: {request_id})\")\n    \n    try:\n        # Validate file extension\n        if not is_valid_s3_key(key):\n            raise ValueError(f\"Unsupported file type: {key}\")\n        \n        # Check object exists and get metadata\n        try:\n            response = s3_client.head_object(Bucket=bucket, Key=key)\n            file_size = response['ContentLength']\n            \n            if file_size > MAX_FILE_SIZE:\n                raise ValueError(f\"File too large: {file_size} bytes\")\n            \n            # Get file hash for deduplication\n            file_hash = response.get('ETag', '').strip('\"')\n            \n        except ClientError as e:\n            error_code = e.response['Error']['Code']\n            if error_code == 'NoSuchKey':\n                raise ValueError(f\"File not found: {key}\")\n            elif error_code == 'Forbidden':\n                raise ValueError(f\"Access denied to file: {key}\")\n            else:\n                raise ValueError(f\"S3 error: {error_code}\")\n        \n        # Generate deterministic ImageID based on content\n        content_hash = hashlib.sha256(f\"{bucket}/{key}/{file_hash}\".encode()).hexdigest()\n        image_id = f\"img_{content_hash[:12]}\"\n        \n        # Check if already processed (deduplication)\n        try:\n            existing_item = table.get_item(Key={'ImageID': image_id})\n            if 'Item' in existing_item:\n                logger.info(f\"Image already processed: {image_id}\")\n                return existing_item['Item']\n        except ClientError as e:\n            logger.warning(f\"Error checking existing item: {str(e)}\")\n        \n        # Record processing in DynamoDB with enhanced metadata\n        current_time = datetime.now(timezone.utc).isoformat()\n        \n        item = {\n            'ImageID': image_id,\n            'OriginalBucket': bucket,\n            'OriginalKey': key,\n            'ProcessedAt': current_time,\n            'Status': 'Processed',\n            'FileSize': file_size,\n            'FileHash': file_hash,\n            'RequestId': request_id,\n            'TTL': int((datetime.now(timezone.utc).timestamp() + (365 * 24 * 3600)))  # 1 year TTL\n        }\n        \n        table.put_item(Item=item)\n        \n        logger.info(f\"Successfully processed image {key} with ID {image_id}\")\n        \n        return {\n            'imageId': image_id,\n            'bucket': bucket,\n            'key': key,\n            'status': 'processed',\n            'fileSize': file_size,\n            'processedAt': current_time\n        }\n        \n    except ValueError as e:\n        logger.error(f\"Validation error for {key}: {str(e)}\")\n        raise e\n    except (ClientError, BotoCoreError) as e:\n        logger.error(f\"AWS service error processing {key}: {str(e)}\")\n        raise ValueError(f\"Service error: {str(e)}\")\n    except Exception as e:\n        logger.error(f\"Unexpected error processing {key}: {str(e)}\", exc_info=True)\n        raise ValueError(f\"Processing failed: {str(e)}\")\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ImageUploadBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "image-uploads-${AWS::AccountId}-${EnvironmentSuffix}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "TransitionNonCurrentVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionTransitions": [
                                {
                                    "StorageClass": "STANDARD_IA",
                                    "TransitionInDays": 90
                                },
                                {
                                    "StorageClass": "GLACIER",
                                    "TransitionInDays": 365
                                }
                            ]
                        },
                        {
                            "Id": "DeleteIncompleteMultipartUploads",
                            "Status": "Enabled",
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 1
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "S3ObjectCreatedRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "s3-object-created-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "Triggers Lambda when images are uploaded to S3 - ${EnvironmentSuffix}"
                },
                "EventPattern": {
                    "source": [
                        "aws.s3"
                    ],
                    "detail-type": [
                        "Object Created"
                    ],
                    "detail": {
                        "bucket": {
                            "name": [
                                {
                                    "Ref": "ImageUploadBucket"
                                }
                            ]
                        },
                        "object": {
                            "key": [
                                {
                                    "suffix": ".jpg"
                                },
                                {
                                    "suffix": ".jpeg"
                                },
                                {
                                    "suffix": ".png"
                                },
                                {
                                    "suffix": ".gif"
                                }
                            ]
                        }
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "ImageProcessorFunction",
                                "Arn"
                            ]
                        },
                        "Id": "ImageProcessorTarget"
                    }
                ]
            }
        },
        "EventBridgeInvokeLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "ImageProcessorFunction"
                },
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "S3ObjectCreatedRule",
                        "Arn"
                    ]
                }
            }
        },
        "ImageProcessingApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "image-processing-api-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "API for manual image processing triggers with enhanced security - ${EnvironmentSuffix}"
                },
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Policy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": "execute-api:Invoke",
                            "Resource": "*",
                            "Condition": {
                                "IpAddress": {
                                    "aws:SourceIp": [
                                        "0.0.0.0/0"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ApiRequestValidator": {
            "Type": "AWS::ApiGateway::RequestValidator",
            "Properties": {
                "RestApiId": {
                    "Ref": "ImageProcessingApi"
                },
                "ValidateRequestBody": true,
                "ValidateRequestParameters": true
            }
        },
        "ImageProcessingModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "RestApiId": {
                    "Ref": "ImageProcessingApi"
                },
                "ContentType": "application/json",
                "Schema": {
                    "type": "object",
                    "properties": {
                        "key": {
                            "type": "string",
                            "pattern": "^[a-zA-Z0-9._/-]+\\.(jpg|jpeg|png|gif)$",
                            "maxLength": 1024
                        },
                        "bucket": {
                            "type": "string",
                            "pattern": "^[a-z0-9.-]+$",
                            "maxLength": 63
                        }
                    },
                    "required": [
                        "key"
                    ]
                }
            }
        },
        "ProcessImageResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "ImageProcessingApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "ImageProcessingApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "process-image"
            }
        },
        "ProcessImageMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ImageProcessingApi"
                },
                "ResourceId": {
                    "Ref": "ProcessImageResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "RequestValidatorId": {
                    "Ref": "ApiRequestValidator"
                },
                "RequestModels": {
                    "application/json": {
                        "Ref": "ImageProcessingModel"
                    }
                },
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ImageProcessorFunction.Arn}/invocations"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        },
                        {
                            "StatusCode": 400
                        },
                        {
                            "StatusCode": 500
                        }
                    ]
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": 400,
                        "ResponseModels": {
                            "application/json": "Error"
                        }
                    },
                    {
                        "StatusCode": 500,
                        "ResponseModels": {
                            "application/json": "Error"
                        }
                    }
                ]
            }
        },
        "ApiUsagePlan": {
            "Type": "AWS::ApiGateway::UsagePlan",
            "DependsOn": "ApiDeployment",
            "Properties": {
                "UsagePlanName": {
                    "Fn::Sub": "usage-plan-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "Usage plan for image processing API - ${EnvironmentSuffix}"
                },
                "ApiStages": [
                    {
                        "ApiId": {
                            "Ref": "ImageProcessingApi"
                        },
                        "Stage": "prod"
                    }
                ],
                "Throttle": {
                    "RateLimit": 100,
                    "BurstLimit": 200
                },
                "Quota": {
                    "Limit": 10000,
                    "Period": "DAY"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ApiKey": {
            "Type": "AWS::ApiGateway::ApiKey",
            "Properties": {
                "Name": {
                    "Fn::Sub": "api-key-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "API key for image processing service - ${EnvironmentSuffix}"
                },
                "Enabled": true,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ServerlessApp"
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "StackName",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            }
        },
        "ApiUsagePlanKey": {
            "Type": "AWS::ApiGateway::UsagePlanKey",
            "Properties": {
                "KeyId": {
                    "Ref": "ApiKey"
                },
                "KeyType": "API_KEY",
                "UsagePlanId": {
                    "Ref": "ApiUsagePlan"
                }
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": "ProcessImageMethod",
            "Properties": {
                "RestApiId": {
                    "Ref": "ImageProcessingApi"
                },
                "StageName": "prod"
            }
        },
        "ApiGatewayInvokeLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "ImageProcessorFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ImageProcessingApi}/*/POST/process-image"
                }
            }
        }
    },
    "Outputs": {
        "S3BucketName": {
            "Description": "Name of the S3 bucket for image uploads",
            "Value": {
                "Ref": "ImageUploadBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "S3Bucket-${EnvironmentSuffix}"
                }
            }
        },
        "S3BucketArn": {
            "Description": "ARN of the S3 bucket for image uploads",
            "Value": {
                "Fn::GetAtt": [
                    "ImageUploadBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "S3BucketArn-${EnvironmentSuffix}"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "Name of the DynamoDB table for tracking processed images",
            "Value": {
                "Ref": "ImageProcessingTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DynamoDBTable-${EnvironmentSuffix}"
                }
            }
        },
        "DynamoDBTableArn": {
            "Description": "ARN of the DynamoDB table for tracking processed images",
            "Value": {
                "Fn::GetAtt": [
                    "ImageProcessingTable",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DynamoDBTableArn-${EnvironmentSuffix}"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the Lambda function for image processing",
            "Value": {
                "Ref": "ImageProcessorFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LambdaFunction-${EnvironmentSuffix}"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the Lambda function for image processing",
            "Value": {
                "Fn::GetAtt": [
                    "ImageProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LambdaFunctionArn-${EnvironmentSuffix}"
                }
            }
        },
        "LambdaRoleArn": {
            "Description": "ARN of the Lambda execution role",
            "Value": {
                "Fn::GetAtt": [
                    "ImageProcessorRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LambdaRoleArn-${EnvironmentSuffix}"
                }
            }
        },
        "ApiGatewayEndpoint": {
            "Description": "API Gateway endpoint for manual image processing",
            "Value": {
                "Fn::Sub": "https://${ImageProcessingApi}.execute-api.${AWS::Region}.amazonaws.com/prod/process-image"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "ApiEndpoint-${EnvironmentSuffix}"
                }
            }
        },
        "ApiGatewayId": {
            "Description": "API Gateway REST API ID",
            "Value": {
                "Ref": "ImageProcessingApi"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "ApiId-${EnvironmentSuffix}"
                }
            }
        },
        "ApiKeyId": {
            "Description": "API Key ID for accessing the API",
            "Value": {
                "Ref": "ApiKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "ApiKeyId-${EnvironmentSuffix}"
                }
            }
        },
        "CloudWatchLogGroup": {
            "Description": "CloudWatch Log Group for Lambda function",
            "Value": {
                "Ref": "ImageProcessorLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LogGroup-${EnvironmentSuffix}"
                }
            }
        },
        "DeadLetterQueueUrl": {
            "Description": "URL of the Dead Letter Queue for failed Lambda executions",
            "Value": {
                "Ref": "ImageProcessorDLQ"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DLQUrl-${EnvironmentSuffix}"
                }
            }
        },
        "DeadLetterQueueArn": {
            "Description": "ARN of the Dead Letter Queue for failed Lambda executions",
            "Value": {
                "Fn::GetAtt": [
                    "ImageProcessorDLQ",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "DLQArn-${EnvironmentSuffix}"
                }
            }
        },
        "KMSKeyArn": {
            "Description": "ARN of the KMS key used for CloudWatch Logs encryption",
            "Value": {
                "Fn::GetAtt": [
                    "LogGroupKMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "KMSKeyArn-${EnvironmentSuffix}"
                }
            }
        },
        "StackRegion": {
            "Description": "AWS Region where the stack is deployed",
            "Value": {
                "Ref": "AWS::Region"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "Region-${EnvironmentSuffix}"
                }
            }
        },
        "StackId": {
            "Description": "CloudFormation Stack ID",
            "Value": {
                "Ref": "AWS::StackId"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "StackId-${EnvironmentSuffix}"
                }
            }
        },
        "EnvironmentSuffixOutput": {
            "Description": "Environment suffix used for this deployment",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "Environment-${EnvironmentSuffix}"
                }
            }
        },
        "LogRetentionDays": {
            "Description": "CloudWatch Logs retention period in days",
            "Value": {
                "Ref": "LogRetentionInDays"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LogRetention-${EnvironmentSuffix}"
                }
            }
        },
        "LambdaMemoryConfiguration": {
            "Description": "Lambda function memory configuration (MB)",
            "Value": {
                "Ref": "LambdaMemorySize"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LambdaMemory-${EnvironmentSuffix}"
                }
            }
        },
        "LambdaTimeoutConfiguration": {
            "Description": "Lambda function timeout configuration (seconds)",
            "Value": {
                "Ref": "LambdaTimeout"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "LambdaTimeout-${EnvironmentSuffix}"
                }
            }
        }
    }
}
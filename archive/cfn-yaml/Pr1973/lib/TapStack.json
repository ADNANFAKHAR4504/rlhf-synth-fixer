{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-grade multi-account security CloudFormation template with advanced AWS security measures",
    "Parameters": {
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "CIDR block for the VPC",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
        },
        "ExistingVpcId": {
            "Type": "String",
            "Default": "",
            "Description": "ID of an existing VPC to use (leave blank to create a new one). Note: If you set this to an existing VPC, CloudFormation will NOT delete it when the stack is deleted. You must manage its deletion manually."
        },
        "PublicSubnetCidr": {
            "Type": "String",
            "Default": "10.0.1.0/24",
            "Description": "CIDR block for the public subnet"
        },
        "PublicSubnet2Cidr": {
            "Type": "String",
            "Default": "10.0.4.0/24",
            "Description": "CIDR block for the second public subnet"
        },
        "PrivateSubnetCidr": {
            "Type": "String",
            "Default": "10.0.2.0/24",
            "Description": "CIDR block for the private subnet"
        },
        "PrivateSubnet2Cidr": {
            "Type": "String",
            "Default": "10.0.3.0/24",
            "Description": "CIDR block for the second private subnet"
        },
        "Environment": {
            "Type": "String",
            "Default": "production",
            "AllowedValues": [
                "development",
                "staging",
                "production"
            ],
            "Description": "Environment name"
        },
        "KmsKeyId": {
            "Type": "String",
            "Description": "KMS Key ID for encryption (optional - will create new if not provided)",
            "Default": ""
        },
        "MasterAccountId": {
            "Type": "String",
            "Description": "The master account ID for centralized monitoring. Must be a 12-digit AWS account ID. Leave blank if not used.",
            "Default": "",
            "AllowedPattern": "^(|\\d{12})$",
            "ConstraintDescription": "Must be blank or a 12-digit AWS account ID"
        },
        "CreateSecurityHub": {
            "Type": "String",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "Set to true if the account is not already subscribed to Security Hub."
        },
        "OrganizationalId": {
            "Type": "String",
            "Description": "The organizational ID if AWS Organizations is enabled",
            "Default": ""
        },
        "MemberAccountIds": {
            "Type": "CommaDelimitedList",
            "Description": "List of member account IDs for AWS Config aggregator",
            "Default": ""
        },
        "CertificateArn": {
            "Type": "String",
            "Description": "ARN of the SSL certificate for the load balancer. Set to a valid ARN to enable HTTPS. If not set or set to \"use-existing\", HTTPS listener will not be created.",
            "Default": "use-existing"
        },
        "DBInstanceIdentifier": {
            "Type": "String",
            "Default": "security-db",
            "Description": "RDS instance identifier"
        },
        "DBEngine": {
            "Type": "String",
            "Default": "mysql",
            "AllowedValues": [
                "mysql",
                "postgres",
                "oracle-ee",
                "sqlserver-ee"
            ],
            "Description": "RDS engine type"
        },
        "DBEngineVersion": {
            "Type": "String",
            "Default": "8.0",
            "Description": "RDS engine version"
        },
        "DBInstanceClass": {
            "Type": "String",
            "Default": "db.t3.micro",
            "Description": "RDS instance class"
        },
        "DBAllocatedStorage": {
            "Type": "Number",
            "Default": 20,
            "Description": "RDS allocated storage in GB"
        },
        "DBBackupRetentionPeriod": {
            "Type": "Number",
            "Default": 7,
            "Description": "RDS backup retention period in days",
            "MinValue": 7,
            "MaxValue": 35
        },
        "ExistingEC2InstanceRoleArn": {
            "Type": "String",
            "Default": "",
            "Description": "ARN of an existing IAM Role for EC2 instances (leave blank to create a new one)"
        },
        "ExistingAccessKeyRotationRoleArn": {
            "Type": "String",
            "Default": "",
            "Description": "ARN of an existing IAM Role for Access Key Rotation Lambda (leave blank to create a new one)"
        },
        "ExistingConfigDeliveryChannelName": {
            "Type": "String",
            "Default": "use-existing",
            "Description": "Name of an existing AWS Config Delivery Channel. To create a new one, set this to blank (\"\"), otherwise the template will NOT create a delivery channel."
        },
        "ExistingConfigRecorderName": {
            "Type": "String",
            "Default": "use-existing",
            "Description": "Name of an existing AWS Config Configuration Recorder. To create a new one, set this to blank (\"\"), otherwise the template will NOT create a configuration recorder."
        },
        "ExistingRDSSubnetGroupName": {
            "Type": "String",
            "Default": "",
            "Description": "Name of an existing RDS DBSubnetGroup. Leave blank to create a new one.\nIf you see an error that the subnet group already exists, set this to the actual existing DBSubnetGroup name (e.g., 'rds-subnet-group-production').\nNote: If you set this to an existing group, CloudFormation will NOT delete it when the stack is deleted. You must manage its deletion manually.\n"
        },
        "ExistingCloudTrailLogsBucketName": {
            "Type": "String",
            "Default": "",
            "Description": "Name of an existing S3 bucket for CloudTrail logs. To create a new one, leave blank. If using an existing bucket, set this to the actual bucket name."
        },
        "ExistingInternetGatewayId": {
            "Type": "String",
            "Default": "",
            "Description": "ID of an existing Internet Gateway to attach to the VPC. Leave blank to create a new one. Note: If you set this to an existing IGW, CloudFormation will NOT delete it when the stack is deleted. You must manage its deletion manually."
        }
    },
    "Conditions": {
        "CreateKmsKey": {
            "Fn::Equals": [
                {
                    "Ref": "KmsKeyId"
                },
                ""
            ]
        },
        "IsMasterAccount": {
            "Fn::And": [
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "MasterAccountId"
                                },
                                ""
                            ]
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::AccountId"
                        },
                        {
                            "Ref": "MasterAccountId"
                        }
                    ]
                }
            ]
        },
        "HasOrganizationalId": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "OrganizationalId"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasMemberAccounts": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Fn::Join": [
                                "",
                                {
                                    "Ref": "MemberAccountIds"
                                }
                            ]
                        },
                        ""
                    ]
                }
            ]
        },
        "UseOrganizationalConfig": {
            "Fn::And": [
                {
                    "Condition": "IsMasterAccount"
                },
                {
                    "Condition": "HasOrganizationalId"
                }
            ]
        },
        "UseAccountBasedConfig": {
            "Fn::And": [
                {
                    "Condition": "IsMasterAccount"
                },
                {
                    "Condition": "HasMemberAccounts"
                },
                {
                    "Fn::Not": [
                        {
                            "Condition": "HasOrganizationalId"
                        }
                    ]
                }
            ]
        },
        "CreateVpc": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingVpcId"
                },
                ""
            ]
        },
        "CreateSecurityHubCondition": {
            "Fn::Equals": [
                {
                    "Ref": "CreateSecurityHub"
                },
                "true"
            ]
        },
        "HasValidMasterAccountId": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "MasterAccountId"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateEC2InstanceRole": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingEC2InstanceRoleArn"
                },
                ""
            ]
        },
        "CreateAccessKeyRotationRole": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingAccessKeyRotationRoleArn"
                },
                ""
            ]
        },
        "CreateConfigDeliveryChannel": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingConfigDeliveryChannelName"
                },
                ""
            ]
        },
        "CreateConfigRecorder": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingConfigRecorderName"
                },
                "use-existing"
            ]
        },
        "CreateConfigDeliveryChannelAndRecorder": {
            "Fn::And": [
                {
                    "Condition": "CreateConfigDeliveryChannel"
                },
                {
                    "Condition": "CreateConfigRecorder"
                }
            ]
        },
        "CreateConfigRules": {
            "Condition": "CreateConfigDeliveryChannelAndRecorder"
        },
        "HasValidCertificateArn": {
            "Fn::And": [
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "CertificateArn"
                                },
                                ""
                            ]
                        }
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "CertificateArn"
                                },
                                "use-existing"
                            ]
                        }
                    ]
                }
            ]
        },
        "CreateRDSSubnetGroup": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingRDSSubnetGroupName"
                },
                ""
            ]
        },
        "CreateCloudTrailLogsBucket": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingCloudTrailLogsBucketName"
                },
                ""
            ]
        },
        "CreateInternetGateway": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingInternetGatewayId"
                },
                ""
            ]
        }
    },
    "Resources": {
        "SecurityKmsKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "CreateKmsKey",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS Key for security services encryption in ${Environment}"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowCloudTrailToEncryptLogs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowConfigToUseTheKey",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Fn::If": [
                                "HasValidMasterAccountId",
                                {
                                    "Sid": "AllowMasterAccountAccess",
                                    "Effect": "Allow",
                                    "Principal": {
                                        "AWS": {
                                            "Fn::Sub": "arn:aws:iam::${MasterAccountId}:root"
                                        }
                                    },
                                    "Action": [
                                        "kms:DescribeKey",
                                        "kms:GenerateDataKey*",
                                        "kms:Decrypt"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "kms:CallerAccount": {
                                                "Ref": "MasterAccountId"
                                            }
                                        }
                                    }
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "SecurityKmsKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Condition": "CreateKmsKey",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/security-${Environment}"
                },
                "TargetKeyId": {
                    "Ref": "SecurityKmsKey"
                }
            }
        },
        "SecurityVpc": {
            "Type": "AWS::EC2::VPC",
            "Condition": "CreateVpc",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Security-VPC-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Public-Subnet-${Environment}"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PublicSubnet2Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Public-Subnet-2-${Environment}"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PrivateSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Private-Subnet-${Environment}"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet2Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Private-Subnet-2-${Environment}"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Condition": "CreateInternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "IGW-${Environment}"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Condition": "CreateInternetGateway",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Public-RT-${Environment}"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "Condition": "CreateInternetGateway",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Condition": "CreateVpc",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Condition": "CreateVpc",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "CloudTrailLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "CreateCloudTrailLogsBucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "cloudtrail-logs-${AWS::AccountId}-${Environment}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::If": [
                                        "CreateKmsKey",
                                        {
                                            "Ref": "SecurityKmsKey"
                                        },
                                        {
                                            "Ref": "KmsKeyId"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 2555,
                            "NoncurrentVersionExpirationInDays": 30
                        }
                    ]
                }
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "CloudTrailLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Fn::If": [
                        "CreateCloudTrailLogsBucket",
                        {
                            "Ref": "CloudTrailLogsBucket"
                        },
                        {
                            "Ref": "ExistingCloudTrailLogsBucketName"
                        }
                    ]
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::If": [
                                    "CreateCloudTrailLogsBucket",
                                    {
                                        "Fn::GetAtt": [
                                            "CloudTrailLogsBucket",
                                            "Arn"
                                        ]
                                    },
                                    {
                                        "Fn::Sub": "arn:aws:s3:::${ExistingCloudTrailLogsBucketName}"
                                    }
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::If": [
                                    "CreateCloudTrailLogsBucket",
                                    {
                                        "Fn::Sub": "${CloudTrailLogsBucket.Arn}/*"
                                    },
                                    {
                                        "Fn::Sub": "arn:aws:s3:::${ExistingCloudTrailLogsBucketName}/*"
                                    }
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Fn::If": [
                                "HasValidMasterAccountId",
                                {
                                    "Sid": "AllowMasterAccountRead",
                                    "Effect": "Allow",
                                    "Principal": {
                                        "AWS": {
                                            "Fn::Sub": "arn:aws:iam::${MasterAccountId}:root"
                                        }
                                    },
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::If": [
                                                "CreateCloudTrailLogsBucket",
                                                {
                                                    "Fn::GetAtt": [
                                                        "CloudTrailLogsBucket",
                                                        "Arn"
                                                    ]
                                                },
                                                {
                                                    "Fn::Sub": "arn:aws:s3:::${ExistingCloudTrailLogsBucketName}"
                                                }
                                            ]
                                        },
                                        {
                                            "Fn::If": [
                                                "CreateCloudTrailLogsBucket",
                                                {
                                                    "Fn::Sub": "${CloudTrailLogsBucket.Arn}/*"
                                                },
                                                {
                                                    "Fn::Sub": "arn:aws:s3:::${ExistingCloudTrailLogsBucketName}/*"
                                                }
                                            ]
                                        }
                                    ],
                                    "Condition": {
                                        "StringEquals": {
                                            "aws:PrincipalAccount": {
                                                "Ref": "MasterAccountId"
                                            }
                                        }
                                    }
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "SecurityCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": "CloudTrailLogsBucketPolicy",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "SecurityTrail-${Environment}"
                },
                "S3BucketName": {
                    "Fn::If": [
                        "CreateCloudTrailLogsBucket",
                        {
                            "Ref": "CloudTrailLogsBucket"
                        },
                        {
                            "Ref": "ExistingCloudTrailLogsBucketName"
                        }
                    ]
                },
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "IsLogging": true,
                "KMSKeyId": {
                    "Fn::If": [
                        "CreateKmsKey",
                        {
                            "Ref": "SecurityKmsKey"
                        },
                        {
                            "Ref": "KmsKeyId"
                        }
                    ]
                },
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true
                    }
                ],
                "IsOrganizationTrail": {
                    "Fn::If": [
                        "HasOrganizationalId",
                        true,
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "EC2InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateEC2InstanceRole",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "EC2-SecurityRole-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "EC2LeastPrivilegePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:GetParametersByPath"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/secure/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Fn::If": [
                            "CreateEC2InstanceRole",
                            {
                                "Ref": "EC2InstanceRole"
                            },
                            {
                                "Ref": "ExistingEC2InstanceRoleArn"
                            }
                        ]
                    }
                ]
            }
        },
        "AccessKeyRotationRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateAccessKeyRotationRole",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "AccessKeyRotation-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "AccessKeyRotationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:ListUsers",
                                        "iam:ListAccessKeys",
                                        "iam:GetAccessKeyLastUsed",
                                        "iam:UpdateAccessKey",
                                        "iam:DeleteAccessKey"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "SecurityNotificationTopic"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "LambdaBasicExecution",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "SecurityNotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "SecurityNotifications-${Environment}"
                },
                "KmsMasterKeyId": {
                    "Fn::If": [
                        "CreateKmsKey",
                        {
                            "Ref": "SecurityKmsKey"
                        },
                        {
                            "Ref": "KmsKeyId"
                        }
                    ]
                }
            }
        },
        "AccessKeyRotationFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "AccessKeyRotation-${Environment}"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::If": [
                        "CreateAccessKeyRotationRole",
                        {
                            "Fn::GetAtt": [
                                "AccessKeyRotationRole",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "ExistingAccessKeyRotationRoleArn"
                        }
                    ]
                },
                "Timeout": 300,
                "Environment": {
                    "Variables": {
                        "SNS_TOPIC_ARN": {
                            "Ref": "SecurityNotificationTopic"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import boto3\nimport json\nimport os\nfrom datetime import datetime, timedelta\n\ndef lambda_handler(event, context):\n    iam = boto3.client('iam')\n    sns = boto3.client('sns')\n    \n    # Get all users\n    paginator = iam.get_paginator('list_users')\n    \n    for page in paginator.paginate():\n        for user in page['Users']:\n            username = user['UserName']\n            \n            # Get access keys for user\n            keys = iam.list_access_keys(UserName=username)\n            \n            for key in keys['AccessKeyMetadata']:\n                key_id = key['AccessKeyId']\n                created_date = key['CreateDate'].replace(tzinfo=None)\n                \n                # Check if key is older than 90 days\n                if (datetime.utcnow() - created_date).days > 90:\n                    # Disable the key\n                    iam.update_access_key(\n                        UserName=username,\n                        AccessKeyId=key_id,\n                        Status='Inactive'\n                    )\n                    \n                    # Check if user has no active keys\n                    active_keys = [k for k in keys['AccessKeyMetadata'] if k['Status'] == 'Active' and k['AccessKeyId'] != key_id]\n                    if not active_keys:\n                        # Create a new access key\n                        new_key = iam.create_access_key(UserName=username)\n                        message = f\"Access key {key_id} for user {username} has been disabled due to age (>90 days). A new access key has been created. Please retrieve it from the IAM console.\"\n                    else:\n                        message = f\"Access key {key_id} for user {username} has been disabled due to age (>90 days). Please ensure you have active keys.\"\n                    \n                    # Send notification\n                    sns.publish(\n                        TopicArn=os.environ['SNS_TOPIC_ARN'],\n                        Message=message,\n                        Subject='Access Key Rotation Alert'\n                    )\n    \n    return {\n        'statusCode': 200,\n        'body': json.dumps('Access key rotation check completed')\n    }\n"
                }
            }
        },
        "AccessKeyRotationSchedule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "AccessKeyRotationSchedule-${Environment}"
                },
                "Description": "Trigger access key rotation check daily",
                "ScheduleExpression": "rate(1 day)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "AccessKeyRotationFunction",
                                "Arn"
                            ]
                        },
                        "Id": "AccessKeyRotationTarget"
                    }
                ]
            }
        },
        "AccessKeyRotationPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "AccessKeyRotationFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "AccessKeyRotationSchedule",
                        "Arn"
                    ]
                }
            }
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "aws-config-${AWS::AccountId}-${Environment}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::If": [
                                        "CreateKmsKey",
                                        {
                                            "Ref": "SecurityKmsKey"
                                        },
                                        {
                                            "Ref": "KmsKeyId"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                }
            }
        },
        "ConfigBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ConfigBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSConfigBucketPermissionsCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ConfigBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSConfigBucketExistenceCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:ListBucket",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ConfigBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSConfigBucketDelivery",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ConfigBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "ConfigS3Policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketAcl",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ConfigBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:GetBucketAcl"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ConfigBucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ConfigDeliveryChannel": {
            "Type": "AWS::Config::DeliveryChannel",
            "Condition": "CreateConfigDeliveryChannelAndRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "SecurityDeliveryChannel-${Environment}"
                },
                "S3BucketName": {
                    "Ref": "ConfigBucket"
                }
            }
        },
        "ConfigurationRecorder": {
            "Type": "AWS::Config::ConfigurationRecorder",
            "Condition": "CreateConfigRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "SecurityRecorder-${Environment}"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "ConfigRole",
                        "Arn"
                    ]
                },
                "RecordingGroup": {
                    "AllSupported": true,
                    "IncludeGlobalResourceTypes": true
                }
            }
        },
        "SecurityGroupConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "CreateConfigRules",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "security-group-ssh-check-${Environment}"
                },
                "Description": "Checks whether security groups allow unrestricted incoming SSH traffic",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "INCOMING_SSH_DISABLED"
                },
                "Scope": {
                    "ComplianceResourceTypes": [
                        "AWS::EC2::SecurityGroup"
                    ]
                }
            }
        },
        "EBSEncryptionConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "CreateConfigRules",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "ebs-encryption-by-default-${Environment}"
                },
                "Description": "Checks whether EBS encryption is enabled by default for the account",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "EC2_EBS_ENCRYPTION_BY_DEFAULT"
                },
                "Scope": {
                    "ComplianceResourceTypes": [
                        "AWS::EC2::Volume"
                    ]
                }
            }
        },
        "ConfigAggregatorRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "UseOrganizationalConfig",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "ConfigAggregatorPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "config:PutConfigurationAggregator",
                                        "config:DescribeConfigurationAggregators",
                                        "config:DeleteConfigurationAggregator"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "organizations:DescribeOrganization"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ConfigAggregator": {
            "Type": "AWS::Config::ConfigurationAggregator",
            "Condition": "IsMasterAccount",
            "Properties": {
                "ConfigurationAggregatorName": {
                    "Fn::Sub": "SecurityAggregator-${Environment}"
                },
                "OrganizationAggregationSource": {
                    "Fn::If": [
                        "HasOrganizationalId",
                        {
                            "RoleArn": {
                                "Fn::GetAtt": [
                                    "ConfigAggregatorRole",
                                    "Arn"
                                ]
                            },
                            "AllAwsRegions": true
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "AccountAggregationSources": {
                    "Fn::If": [
                        "UseAccountBasedConfig",
                        [
                            {
                                "AccountIds": {
                                    "Ref": "MemberAccountIds"
                                },
                                "AllAwsRegions": true
                            }
                        ],
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                }
            }
        },
        "MFAEnforcementPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": {
                    "Fn::Sub": "MFAEnforcement-${Environment}"
                },
                "Description": "Enforces MFA for all IAM users",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowViewAccountInfo",
                            "Effect": "Allow",
                            "Action": [
                                "iam:GetAccountPasswordPolicy",
                                "iam:ListVirtualMFADevices",
                                "iam:GetUser",
                                "iam:ListMFADevices"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowManageOwnCredentials",
                            "Effect": "Allow",
                            "Action": [
                                "iam:ChangePassword",
                                "iam:CreateVirtualMFADevice",
                                "iam:DeleteVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:ResyncMFADevice"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "DenyAccessWithoutMFA",
                            "Effect": "Deny",
                            "Action": [
                                "ec2:*",
                                "s3:*",
                                "rds:*",
                                "lambda:*",
                                "cloudformation:*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "BoolIfExists": {
                                    "aws:MultiFactorAuthPresent": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "SecurityHub": {
            "Type": "AWS::SecurityHub::Hub",
            "Condition": "CreateSecurityHubCondition",
            "Properties": {
                "EnableDefaultStandards": true
            }
        },
        "DatabasePasswordParameter": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/secure/${Environment}/database/password"
                },
                "Type": "String",
                "Value": "ChangeMe123!",
                "Description": "Database master password"
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "database-credentials-${Environment}"
                },
                "Description": "Database master credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"admin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\\\"
                },
                "KmsKeyId": {
                    "Fn::If": [
                        "CreateKmsKey",
                        {
                            "Ref": "SecurityKmsKey"
                        },
                        {
                            "Ref": "KmsKeyId"
                        }
                    ]
                }
            }
        },
        "RDSSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Condition": "CreateRDSSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "rds-subnet-group-${Environment}"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS instances",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "RDS-SubnetGroup-${Environment}"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "RDSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "RDS-SecurityGroup-${Environment}"
                },
                "GroupDescription": "Security group for RDS instances",
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "EC2SecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "RDS-SG-${Environment}"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "RDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Ref": "DBInstanceIdentifier"
                },
                "Engine": {
                    "Ref": "DBEngine"
                },
                "EngineVersion": {
                    "Ref": "DBEngineVersion"
                },
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "AllocatedStorage": {
                    "Ref": "DBAllocatedStorage"
                },
                "BackupRetentionPeriod": {
                    "Ref": "DBBackupRetentionPeriod"
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}::username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}::password}}"
                },
                "DBSubnetGroupName": {
                    "Fn::If": [
                        "CreateRDSSubnetGroup",
                        {
                            "Ref": "RDSSubnetGroup"
                        },
                        {
                            "Ref": "ExistingRDSSubnetGroupName"
                        }
                    ]
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "RDSSecurityGroup"
                    }
                ],
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::If": [
                        "CreateKmsKey",
                        {
                            "Ref": "SecurityKmsKey"
                        },
                        {
                            "Ref": "KmsKeyId"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "RDS-Instance-${Environment}"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "EC2SecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "EC2-SecurityGroup-${Environment}"
                },
                "GroupDescription": "Security group for EC2 instances",
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-SG-${Environment}"
                        }
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Fn::Sub": "ALB-${Environment}"
                },
                "Type": "application",
                "Scheme": "internet-facing",
                "IpAddressType": "ipv4",
                "Subnets": [
                    {
                        "Ref": "PublicSubnet"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ALB-${Environment}"
                        }
                    }
                ]
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "ALB-SecurityGroup-${Environment}"
                },
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Fn::If": [
                        "CreateVpc",
                        {
                            "Ref": "SecurityVpc"
                        },
                        {
                            "Ref": "ExistingVpcId"
                        }
                    ]
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ALB-SG-${Environment}"
                        }
                    }
                ]
            }
        },
        "HTTPSListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Condition": "HasValidCertificateArn",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "fixed-response",
                        "FixedResponseConfig": {
                            "StatusCode": 200,
                            "ContentType": "text/plain",
                            "MessageBody": "Secure connection established"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 443,
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "CertificateArn"
                        }
                    }
                ]
            }
        },
        "HTTPListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "redirect",
                        "RedirectConfig": {
                            "Protocol": "HTTPS",
                            "Port": 443,
                            "StatusCode": "HTTP_301"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        }
    },
    "Outputs": {
        "VpcId": {
            "Description": "VPC ID",
            "Value": {
                "Fn::If": [
                    "CreateVpc",
                    {
                        "Ref": "SecurityVpc"
                    },
                    {
                        "Ref": "ExistingVpcId"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-ID"
                }
            }
        },
        "PublicSubnetId": {
            "Description": "Public Subnet ID",
            "Value": {
                "Ref": "PublicSubnet"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Public-Subnet-ID"
                }
            }
        },
        "PublicSubnet2Id": {
            "Description": "Second Public Subnet ID",
            "Value": {
                "Ref": "PublicSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Public-Subnet-2-ID"
                }
            }
        },
        "PrivateSubnetId": {
            "Description": "Private Subnet ID",
            "Value": {
                "Ref": "PrivateSubnet"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Private-Subnet-ID"
                }
            }
        },
        "PrivateSubnet2Id": {
            "Description": "Second Private Subnet ID",
            "Value": {
                "Ref": "PrivateSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Private-Subnet-2-ID"
                }
            }
        },
        "CloudTrailBucketName": {
            "Description": "CloudTrail S3 Bucket Name",
            "Value": {
                "Fn::If": [
                    "CreateCloudTrailLogsBucket",
                    {
                        "Ref": "CloudTrailLogsBucket"
                    },
                    {
                        "Ref": "ExistingCloudTrailLogsBucketName"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudTrail-Bucket"
                }
            }
        },
        "SecurityHubArn": {
            "Description": "Security Hub ARN",
            "Value": {
                "Fn::If": [
                    "CreateSecurityHubCondition",
                    {
                        "Ref": "SecurityHub"
                    },
                    "Already subscribed"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecurityHub-ARN"
                }
            }
        },
        "KmsKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Fn::If": [
                    "CreateKmsKey",
                    {
                        "Ref": "SecurityKmsKey"
                    },
                    {
                        "Ref": "KmsKeyId"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ID"
                }
            }
        },
        "EC2InstanceRoleArn": {
            "Description": "EC2 Instance Role ARN",
            "Value": {
                "Fn::If": [
                    "CreateEC2InstanceRole",
                    {
                        "Fn::GetAtt": [
                            "EC2InstanceRole",
                            "Arn"
                        ]
                    },
                    {
                        "Ref": "ExistingEC2InstanceRoleArn"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EC2-Role-ARN"
                }
            }
        },
        "LoadBalancerDNS": {
            "Description": "Application Load Balancer DNS Name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-DNS"
                }
            }
        },
        "SecurityNotificationTopicArn": {
            "Description": "SNS Topic ARN for security notifications",
            "Value": {
                "Ref": "SecurityNotificationTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Security-Topic-ARN"
                }
            }
        },
        "ConfigBucketName": {
            "Description": "AWS Config S3 Bucket Name",
            "Value": {
                "Ref": "ConfigBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Bucket"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "Database credentials secret ARN",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Database-Secret-ARN"
                }
            }
        },
        "RDSInstanceEndpoint": {
            "Description": "RDS instance endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "RDSInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDS-Endpoint"
                }
            }
        },
        "ConfigAggregatorName": {
            "Description": "AWS Config Aggregator Name",
            "Value": {
                "Fn::If": [
                    "IsMasterAccount",
                    {
                        "Ref": "ConfigAggregator"
                    },
                    "Not applicable"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Aggregator"
                }
            }
        },
        "MFAPolicyArn": {
            "Description": "MFA Enforcement Policy ARN",
            "Value": {
                "Ref": "MFAEnforcementPolicy"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-MFA-Policy-ARN"
                }
            }
        },
        "ConfigDeliveryChannelName": {
            "Description": "AWS Config Delivery Channel Name",
            "Value": {
                "Fn::If": [
                    "CreateConfigDeliveryChannelAndRecorder",
                    {
                        "Ref": "ConfigDeliveryChannel"
                    },
                    {
                        "Ref": "ExistingConfigDeliveryChannelName"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Delivery-Channel-Name"
                }
            }
        },
        "ConfigRecorderName": {
            "Description": "AWS Config Configuration Recorder Name",
            "Value": {
                "Fn::If": [
                    "CreateConfigRecorder",
                    {
                        "Ref": "ConfigurationRecorder"
                    },
                    {
                        "Ref": "ExistingConfigRecorderName"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Recorder-Name"
                }
            }
        }
    }
}
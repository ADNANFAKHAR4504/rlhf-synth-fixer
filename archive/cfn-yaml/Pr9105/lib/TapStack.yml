AWSTemplateFormatVersion: '2010-09-09'
Description: 'IaC-AWS-Nova-Model-Breaking: Secure multi-tier web application infrastructure with CloudTrail, CloudWatch Alarms, and MFA enforcement.'

# Parameters section for customizable values
Parameters:
  # Parameter not supported in LocalStack (ALBListener requires ACM certificate)
  # ExistingCertificateArn:
  #   Type: String
  #   Description: 'The ARN of the existing AWS Certificate Manager (ACM) certificate for the ALB.'
  #   Default: 'arn:aws:acm:us-west-2:718240086340:certificate/c43e41ee-5b6c-4d2c-80e9-82c1db57289e'

  # SSH access CIDR for security group configuration
  SSHAccessCIDR:
    Type: String
    Description: 'CIDR block allowed for SSH access to EC2 instances'
    Default: '10.0.0.0/8'
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$'
    ConstraintDescription: 'Must be a valid CIDR notation (e.g., 10.0.0.0/8)'

  # Database master username
  DBMasterUsername:
    Type: String
    Description: 'Master username for RDS database'
    Default: 'admin'
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
  
  # Email for alarm notifications
  NotificationEmail:
    Type: String
    Description: 'Email address to receive CloudWatch alarm notifications.'
    Default: 'default@example.com'
    AllowedPattern: '^.+@.+$'
    ConstraintDescription: 'Must be a valid email address.'

  # Project name for resource naming
  ProjectName:
    Type: String
    Description: 'Project name for resource tagging and naming'
    Default: 'IaC-AWS-Nova-Model-Breaking'
  ProjectNameLower:
    Type: String
    Description: 'Lowercase project name for S3 bucket naming'
    Default: 'iac-aws-nova-model-breaking'
    AllowedPattern: '^[a-z0-9][a-z0-9.-]*[a-z0-9]$'
    ConstraintDescription: 'Must be a valid S3 bucket name (lowercase, numbers, hyphens, periods)'

  # Environment suffix for stage name uniqueness
  EnvironmentSuffix:
    Type: String
    Description: 'Suffix for environment uniqueness (e.g., dev, test, prod)'
    Default: 'dev'
    AllowedPattern: '^[a-zA-Z0-9-]+$'
    ConstraintDescription: 'Must be alphanumeric or hyphen'

# Resources section - Core infrastructure and security components
Resources:

  # ========================================
  # 1. VPC AND NETWORK ISOLATION
  # ========================================
  
  MainVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-VPC'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-IGW'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref MainVPC

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.1.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Public-Subnet-AZ1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.2.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Public-Subnet-AZ2'

  PrivateAppSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.11.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-App-Subnet-AZ1'

  PrivateAppSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.12.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-App-Subnet-AZ2'

  PrivateDataSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.21.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-Data-Subnet-AZ1'

  PrivateDataSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MainVPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.22.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-Data-Subnet-AZ2'

  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MainVPC

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MainVPC

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway1

  PrivateAppSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateAppSubnet1

  PrivateDataSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateDataSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MainVPC

  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway2

  PrivateAppSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateAppSubnet2

  PrivateDataSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateDataSubnet2

  # ========================================
  # 2. IAM ROLE FOR TAG-BASED S3 ACCESS
  # ========================================

  ApplicationDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectNameLower}-${AWS::AccountId}-${AWS::Region}-app-data'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: TagBasedS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub 'arn:aws:s3:::${ProjectNameLower}-${AWS::AccountId}-${AWS::Region}-app-data/*'
                Condition:
                  StringEquals:
                    'ec2:ResourceTag/S3Access': 'Approved'
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref DatabaseSecret

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  # ========================================
  # 3. APPLICATION AND DATABASE SECURITY GROUPS
  # ========================================

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-ALB-SG'
      GroupDescription: 'Security group for Application Load Balancer'
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'

  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-Web-SG'
      GroupDescription: 'Security group for web tier EC2 instances'
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHAccessCIDR

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-Database-SG'
      GroupDescription: 'Security group for RDS database'
      VpcId: !Ref MainVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebSecurityGroup

  # ========================================
  # 4. DATA ENCRYPTION IN TRANSIT (SSL/TLS)
  # ========================================

  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub '${ProjectName}-db-subnet-group'
      DBSubnetGroupDescription: 'Subnet group for RDS database'
      SubnetIds:
        - !Ref PrivateDataSubnet1
        - !Ref PrivateDataSubnet2

  DatabaseParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      DBParameterGroupName: !Sub '${ProjectName}-mysql-params'
      Description: 'Parameter group enforcing SSL/TLS for MySQL'
      Family: 'mysql8.0'
      Parameters:
        require_secure_transport: 'ON'

  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}-db-credentials'
      Description: 'Database credentials for RDS instance'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBMasterUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 16
        ExcludeCharacters: '"@/\'

  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-mysql-db'
      DBInstanceClass: 'db.t3.micro'
      Engine: 'mysql'
      EngineVersion: '8.0.37'
      AllocatedStorage: 20
      StorageType: 'gp2'
      StorageEncrypted: true
      MasterUsername: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      DBParameterGroupName: !Ref DatabaseParameterGroup
      BackupRetentionPeriod: 7
      MultiAZ: false
      PubliclyAccessible: false
      DeletionProtection: false

  # ========================================
  # 5. AWS WAF INTEGRATION
  # ========================================

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${ProjectName}-ALB'
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${ProjectName}-TG'
      Port: 443
      Protocol: HTTPS
      VpcId: !Ref MainVPC
      HealthCheckEnabled: true
      HealthCheckPath: '/health'
      HealthCheckProtocol: HTTPS
      TargetType: instance

  # ALBListener not supported in LocalStack (requires ACM certificate)
  # ALBListener:
  #   Type: AWS::ElasticLoadBalancingV2::Listener
  #   Properties:
  #     DefaultActions:
  #       - Type: forward
  #         TargetGroupArn: !Ref ALBTargetGroup
  #     LoadBalancerArn: !Ref ApplicationLoadBalancer
  #     Port: 443
  #     Protocol: HTTPS
  #     Certificates:
  #       - CertificateArn: !Ref ExistingCertificateArn

  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub '${ProjectName}-WebACL'
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      Rules:
        - Name: CommonRuleSet
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: CommonRuleSetMetric
        - Name: SQLiRuleSet
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: SQLiRuleSetMetric
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub '${ProjectName}-WebACL'

  WebACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn: !Ref ApplicationLoadBalancer
      WebACLArn: !GetAtt WebACL.Arn

  # ========================================
  # 6. API GATEWAY LOGGING
  # ========================================

  APIGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${ProjectName}'
      RetentionInDays: 14

  APIGatewayLoggingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs

  APIGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt APIGatewayLoggingRole.Arn

  SampleRestAPI:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${ProjectName}-API'
      Description: 'Sample REST API with comprehensive logging'
      EndpointConfiguration:
        Types:
          - REGIONAL

  APIResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SampleRestAPI
      ParentId: !GetAtt SampleRestAPI.RootResourceId
      PathPart: 'sample'

  APIMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SampleRestAPI
      ResourceId: !Ref APIResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseTemplates:
              application/json: '{"message": "Hello from API Gateway"}'
      MethodResponses:
        - StatusCode: 200

  APIDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - APIMethod
    Properties:
      RestApiId: !Ref SampleRestAPI
      StageName: prod

  APIStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref SampleRestAPI
      DeploymentId: !Ref APIDeployment
      StageName: !Sub 'prod-${EnvironmentSuffix}'
      AccessLogSetting:
        DestinationArn: !GetAtt APIGatewayLogGroup.Arn
        Format: '$context.requestId $context.requestTime $context.httpMethod $context.resourcePath $context.status $context.responseLength $context.responseTime'
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true

  # ========================================
  # 7. AUTOMATED SECURITY PATCHING VIA LAMBDA
  # ========================================

  LambdaPatchingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SSMPatchingPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:SendCommand
                  - ssm:DescribeInstanceInformation
                  - ec2:DescribeInstances
                Resource: '*'

  PatchingLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-Automated-Patching'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaPatchingRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import json
          
          def lambda_handler(event, context):
              ssm_client = boto3.client('ssm')
              ec2_client = boto3.client('ec2')
              
              try:
                  response = ec2_client.describe_instances(
                      Filters=[
                          {'Name': 'tag:PatchGroup', 'Values': ['WebApp']},
                          {'Name': 'instance-state-name', 'Values': ['running']}
                      ]
                  )
                  instance_ids = [
                      instance['InstanceId'] 
                      for reservation in response['Reservations'] 
                      for instance in reservation['Instances']
                  ]
                  
                  if instance_ids:
                      command_response = ssm_client.send_command(
                          InstanceIds=instance_ids,
                          DocumentName='AWS-RunPatchBaseline',
                          Parameters={'Operation': ['Install']}
                      )
                      return {
                          'statusCode': 200,
                          'body': json.dumps({
                              'message': f'Patching initiated for {len(instance_ids)} instances',
                              'commandId': command_response['Command']['CommandId']
                          })
                      }
                  return {'statusCode': 200, 'body': json.dumps({'message': 'No instances found'})}
              except Exception as e:
                  return {'statusCode': 500, 'body': json.dumps({'error': str(e)})}

  PatchingScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${ProjectName}-Patching-Schedule'
      ScheduleExpression: 'cron(0 3 ? * SUN *)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt PatchingLambdaFunction.Arn
          Id: !Sub '${ProjectName}-PatchingLambdaTarget'

  # ========================================
  # 8. CLOUDTRAIL AUDITING
  # ========================================

  CloudTrailLogBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub 'ct-${ProjectNameLower}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldLogs
            Status: Enabled
            Prefix: ''
            ExpirationInDays: 365

  CloudTrailLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailLogBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailLogBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailLogBucket.Arn}/AWSLogs/${AWS::AccountId}/*'
            Condition:
              StringEquals:
                's3:x-amz-acl': 'bucket-owner-full-control'
          - Sid: DenyUnEncryptedObjectUploads
            Effect: Deny
            Principal: '*'
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailLogBucket.Arn}/AWSLogs/${AWS::AccountId}/*'
            Condition:
              StringNotEqualsIfExists:
                's3:x-amz-server-side-encryption': 'AES256'
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource: !Sub '${CloudTrailLogBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': false

  MainCloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: CloudTrailLogBucketPolicy
    Properties:
      TrailName: !Sub '${ProjectName}-MainTrail'
      IsLogging: true
      IsMultiRegionTrail: true
      S3BucketName: !Ref CloudTrailLogBucket
      IncludeGlobalServiceEvents: true
      EnableLogFileValidation: true

  # ========================================
  # 9. REAL-TIME MONITORING
  # ========================================

  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub '${ProjectName} Alarm Notifications'
      TopicName: !Sub '${ProjectName}-AlarmTopic'

  AlarmEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      Endpoint: !Ref NotificationEmail
      TopicArn: !Ref AlarmNotificationTopic

  RDSCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-RDS-High-CPU'
      AlarmDescription: 'Alarm for high RDS CPU utilization'
      Namespace: 'AWS/RDS'
      MetricName: 'CPUUtilization'
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DatabaseInstance
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref AlarmNotificationTopic
      OKActions:
        - !Ref AlarmNotificationTopic

  # ========================================
  # 10. MFA ENFORCEMENT
  # ========================================

  MFAAdminRole:
    Type: AWS::IAM::Role
    Properties:
      # RoleName property removed for CAPABILITY_IAM compatibility
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root' # Allows users in the account to assume this role
            Action: 'sts:AssumeRole'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
      Policies:
        - PolicyName: 'MFA-ReadOnly-Access'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ec2:Describe*'
                  - 'rds:Describe*'
                  - 's3:List*'
                Resource: '*'

# Outputs section for Integration Tests
Outputs:
  VpcId:
    Description: The ID of the VPC
    Value: !Ref MainVPC
    Export:
      Name: !Sub "${AWS::StackName}-VpcId"
      
  PrivateSubnetIds:
    Description: Comma-separated list of Private Subnet IDs
    Value: !Join [',', [!Ref PrivateAppSubnet1, !Ref PrivateAppSubnet2, !Ref PrivateDataSubnet1, !Ref PrivateDataSubnet2]]
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnetIds"

  DBInstanceIdentifier:
    Description: The identifier for the RDS DB instance
    Value: !Ref DatabaseInstance
    Export:
      Name: !Sub "${AWS::StackName}-DBInstanceIdentifier"

  EC2InstanceRoleName:
    Description: The name of the IAM Role for EC2 instances
    Value: !Ref EC2InstanceRole
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceRoleName"

  ALBArn:
    Description: The ARN of the Application Load Balancer
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub "${AWS::StackName}-ALBArn"

  # ALBListener not supported in LocalStack
  # ALBListenerArn:
  #   Description: The ARN of the ALB Listener
  #   Value: !Ref ALBListener
  #   Export:
  #     Name: !Sub "${AWS::StackName}-ALBListenerArn"
      
  # CertificateArnUsed:
  #   Description: The ARN of the certificate used by the listener
  #   Value: !Ref ExistingCertificateArn
  #   Export:
  #     Name: !Sub "${AWS::StackName}-CertificateArnUsed"

  PatchingLambdaFunctionName:
    Description: The name of the automated patching Lambda function
    Value: !Ref PatchingLambdaFunction
    Export:
      Name: !Sub "${AWS::StackName}-PatchingLambdaFunctionName"
      
  # New outputs for added components
  CloudTrailName:
    Description: The name of the CloudTrail trail
    Value: !Ref MainCloudTrail
    Export:
      Name: !Sub "${AWS::StackName}-CloudTrailName"
      
  RDSCPUAlarmName:
    Description: The name of the RDS CPU CloudWatch Alarm
    Value: !Ref RDSCPUAlarm
    Export:
      Name: !Sub "${AWS::StackName}-RDSCPUAlarmName"
      
  MFAAdminRoleName:
    Description: The name of the MFA-enforced Admin Role
    Value: !Ref MFAAdminRole
    Export:
      Name: !Sub "${AWS::StackName}-MFAAdminRoleName"

  # Additional outputs required by LocalStack post-deployment fix script
  VPCId:
    Description: The ID of the VPC
    Value: !Ref MainVPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"

  SecurityGroupId:
    Description: The ID of the ALB Security Group
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-SecurityGroupId"

  InternetGatewayId:
    Description: The ID of the Internet Gateway
    Value: !Ref InternetGateway
    Export:
      Name: !Sub "${AWS::StackName}-InternetGatewayId"

  NATGatewayId:
    Description: The ID of the first NAT Gateway
    Value: !Ref NatGateway1
    Export:
      Name: !Sub "${AWS::StackName}-NATGatewayId"

  PublicSubnet1Id:
    Description: The ID of the first public subnet
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-PublicSubnet1Id"

  PrivateSubnet1Id:
    Description: The ID of the first private app subnet
    Value: !Ref PrivateAppSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnet1Id"
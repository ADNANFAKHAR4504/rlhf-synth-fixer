# AWS CloudFormation Best Practice Implementation

## Architecture Overview

### Core Components

1. **Networking Infrastructure**
   - VPC with CIDR 10.0.0.0/16
   - 2 subnets in different AZs
   - Internet Gateway
   - Route Table

2. **Compute Resources**
   - EC2 instance with dynamic AMI selection
   - Elastic IP
   - Security Group (HTTP/SSH)
   - Detailed monitoring
   - Encrypted EBS volumes

3. **Identity and Access**
   - Region-aware IAM Role
   - Instance Profile
   - S3 access permissions

4. **Storage Solutions**
   - Two S3 buckets (general and logs)
   - Versioning enabled
   - Server-side encryption

5. **Security Measures**
   - Comprehensive encryption
   - Resource tagging
   - Least privilege access

6. **Monitoring Setup**
   - CloudWatch alarms
   - Log retention
   - Metric collection

### Design Principles

1. **Regional Flexibility**
   - Use AWS::Region pseudoparameter
   - Region-aware resource naming
   - AZ-independent design

2. **Cross-Account Compatibility**
   - No account-specific hardcoding
   - Flexible IAM configurations
   - Portable resource policies

3. **Security First**
   - Encryption by default
   - Least privilege access
   - Secure networking

4. **Cost Management**
   - Comprehensive tagging strategy
   - Resource tracking
   - Cost allocation
## Implementation

### CloudFormation Template

The following template implements a secure, scalable, and maintainable cloud infrastructure following AWS best practices:

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Foundational cloud environment with VPC, EC2, S3, IAM, and monitoring (with dynamic AMI and KeyPair creation)'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters:
          - VPCCidr
          - Subnet1Cidr
          - Subnet2Cidr
      - Label:
          default: "EC2 Configuration"
        Parameters:
          - InstanceType
          - KeyPairName
      - Label:
          default: "Tagging Configuration"
        Parameters:
          - EnvironmentName
          - ProjectName
          - Owner
          - CostCenter
    ParameterLabels:
      VPCCidr:
        default: "VPC CIDR Block"
      Subnet1Cidr:
        default: "Subnet 1 CIDR Block"
      Subnet2Cidr:
        default: "Subnet 2 CIDR Block"
      InstanceType:
        default: "EC2 Instance Type"
      KeyPairName:
        default: "Key Pair Name"
      EnvironmentName:
        default: "Environment Name"
      ProjectName:
        default: "Project Name"
      Owner:
        default: "Owner"
      CostCenter:
        default: "Cost Center"

Parameters:
  VPCCidr:
    Type: String
    Default: "10.0.0.0/16"
    Description: "CIDR block for the VPC"
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    ConstraintDescription: "Must be a valid CIDR range"

  Subnet1Cidr:
    Type: String
    Default: "10.0.1.0/24"
    Description: "CIDR block for the first subnet"
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  Subnet2Cidr:
    Type: String
    Default: "10.0.2.0/24"
    Description: "CIDR block for the second subnet"
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  InstanceType:
    Type: String
    Default: "t3.micro"
    Description: "EC2 instance type"
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t3.micro
      - t3.small
      - t3.medium
    ConstraintDescription: "Must be a valid EC2 instance type"

  KeyPairName:
    Type: String
    Default: "AutoGeneratedKey"
    Description: "Key Pair name to use or create"

  LatestAmi:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
    Description: "Latest Amazon Linux 2 AMI ID from SSM Parameter Store"

  EnvironmentName:
    Type: String
    Default: "Development"
    Description: "Environment name for tagging"
    AllowedValues:
      - Development
      - Staging
      - Production

  ProjectName:
    Type: String
    Default: "IAC-Amazon"
    Description: "Project name for tagging"

  Owner:
    Type: String
    Default: "bharath.b@turing.com"
    Description: "Owner email or name for tagging"

  CostCenter:
    Type: String
    Default: "1001"
    Description: "Cost center identifier for billing purposes"

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-VPC"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-IGW"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets
  Subnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref Subnet1Cidr
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-Subnet1"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  Subnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref Subnet2Cidr
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-Subnet2"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  # Route Table
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-RouteTable"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  InternetRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway

  Subnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Subnet1
      RouteTableId: !Ref RouteTable

  Subnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref Subnet2
      RouteTableId: !Ref RouteTable

  # Security Group
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Allow HTTP and SSH traffic"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: "0.0.0.0/0"
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: "0.0.0.0/0"
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: "0.0.0.0/0"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-SG"
        - Key: Region
          Value: !Ref "AWS::Region"

  # Key Pair
  EC2KeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Sub "${KeyPairName}-${AWS::Region}"
      KeyType: rsa
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-EC2-KeyPair"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  EC2LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/ec2/${AWS::StackName}"
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-LogGroup"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  # IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-${AWS::Region}-EC2Role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt GeneralStorageBucket.Arn
                  - !Sub "${GeneralStorageBucket.Arn}/*"
                  - !GetAtt LogsBucket.Arn
                  - !Sub "${LogsBucket.Arn}/*"

        - PolicyName: CloudWatchFullAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                  - logs:PutRetentionPolicy
                Resource: "*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-EC2Role"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${AWS::StackName}-${AWS::Region}-EC2InstanceProfile"
      Roles:
        - !Ref EC2Role

  # EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmi
      InstanceType: !Ref InstanceType
      KeyName: !Ref EC2KeyPair
      SubnetId: !Ref Subnet1
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      Monitoring: true
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeType: gp3
            VolumeSize: 20
            Encrypted: true
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y

          yum install -y wget
          wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
          rpm -Uvh amazon-cloudwatch-agent.rpm

          # Create CloudWatch Agent configuration (JSON). ${AWS::StackName} and ${EnvironmentName} will be substituted by CloudFormation.
          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << EOF
          {
            "agent": {
              "metrics_collection_interval": 60,
              "run_as_user": "root"
            },
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "${EC2LogGroup}",
                      "log_stream_name": "{instance_id}-messages",
                      "timezone": "UTC"
                    }
                  ]
                }
              }
            },
            "metrics": {
              "namespace": "EC2/${EnvironmentName}",
              "metrics_collected": {
                "cpu": {
                  "measurement": ["cpu_usage_idle","cpu_usage_system","cpu_usage_user"],
                  "metrics_collection_interval": 60
                },
                "mem": {
                  "measurement": ["mem_used_percent"],
                  "metrics_collection_interval": 60
                }
              }
            }
          }
          EOF

          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

          # Enable and start the web server
          yum install -y httpd
          systemctl enable httpd
          echo "<h1>SaaS App - Instance $(hostname)</h1>" > /var/www/html/index.html
          systemctl start httpd
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-EC2Instance"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"


  # Elastic IP
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref EC2Instance
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-EIP"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  # S3 Buckets
  GeneralStorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "generalstorage-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "generalstorage-${AWS::AccountId}-${AWS::Region}"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "logs-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Name
          Value: !Sub "logs-${AWS::AccountId}-${AWS::Region}"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

  # CloudWatch Alarm
  CPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${AWS::Region}-CPU-Utilization-High"
      AlarmDescription: "Triggers when EC2 CPU utilization exceeds 80%"
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref EC2Instance
      TreatMissingData: notBreaching
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${AWS::Region}-CPUAlarm"
        - Key: EnvName
          Value: !Ref EnvironmentName
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Region
          Value: !Ref "AWS::Region"

Outputs:
  VPCId:
    Description: "VPC ID"
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-VPC-ID"

  Subnet1Id:
    Description: "Subnet 1 ID"
    Value: !Ref Subnet1
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-Subnet1-ID"

  Subnet2Id:
    Description: "Subnet 2 ID"
    Value: !Ref Subnet2
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-Subnet2-ID"

  EC2InstanceId:
    Description: "EC2 Instance ID"
    Value: !Ref EC2Instance
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-EC2Instance-ID"

  ElasticIP:
    Description: "Elastic IP Address"
    Value: !Ref ElasticIP
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-ElasticIP"

  GeneralStorageBucketName:
    Description: "General Storage S3 Bucket Name"
    Value: !Ref GeneralStorageBucket
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-GeneralStorageBucket"

  LogsBucketName:
    Description: "Logs S3 Bucket Name"
    Value: !Ref LogsBucket
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-LogsBucket"

  SecurityGroupId:
    Description: "EC2 Security Group ID"
    Value: !Ref EC2SecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-SecurityGroup-ID"

  KeyPairOutput:
    Description: "EC2 Key Pair Name created"
    Value: !Ref EC2KeyPair
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-KeyPair"

  EC2RoleName:
    Description: "IAM Role Name for EC2"
    Value: !Ref EC2Role
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-EC2RoleName"

  EC2InstanceProfileName:
    Description: "EC2 Instance Profile Name"
    Value: !Ref EC2InstanceProfile
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-EC2InstanceProfileName"

  EC2LogGroupName:
    Description: "CloudWatch Log Group for EC2"
    Value: !Ref EC2LogGroup
    Export:
      Name: !Sub "${AWS::StackName}-${AWS::Region}-EC2LogGroupName"
```
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure AWS cloud environment with API Gateway, S3, IAM, WAF, and VPC networking - Production Grade",
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Default": "cfn-secure-project",
            "Description": "Name prefix for all resources",
            "AllowedPattern": "^[a-z0-9-]+$",
            "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource names and API stage"
        },
        "LogRetentionDays": {
            "Type": "Number",
            "Default": 30,
            "AllowedValues": [
                1,
                3,
                5,
                7,
                14,
                30,
                60,
                90,
                120,
                150,
                180,
                365,
                400,
                545,
                731,
                1827,
                3653
            ],
            "Description": "CloudWatch Logs retention period in days"
        },
        "EnableAccessLogging": {
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "Enable API Gateway access logging"
        }
    },
    "Conditions": {
        "EnableLogging": {
            "Fn::Equals": [
                {
                    "Ref": "EnableAccessLogging"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "MainVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-vpc"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-public-subnet-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-private-subnet-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "CidrBlock": "10.0.3.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-private-subnet-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-igw"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "MainVPC"
                }
            }
        },
        "NatGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-nat-eip"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "NatGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-nat-gateway"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-public-rt"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-private-rt"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DefaultPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "APIGatewaySecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for API Gateway VPC endpoint",
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "HTTPS access from VPC"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS outbound access"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-gateway-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApplicationDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-app-data-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteIncompleteMultipartUploads",
                            "Status": "Enabled",
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 7
                            }
                        },
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transition": {
                                "StorageClass": "STANDARD_IA",
                                "TransitionInDays": 30
                            }
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transition": {
                                "StorageClass": "GLACIER",
                                "TransitionInDays": 90
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-app-data"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApplicationDataBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ApplicationDataBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyInsecureConnections",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ApplicationDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "RestrictToVPCEndpoint",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ApplicationDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "StringNotEquals": {
                                    "aws:SourceVpc": {
                                        "Ref": "MainVPC"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "APIGatewayLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-logs-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": {
                                "Ref": "LogRetentionDays"
                            }
                        },
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transition": {
                                "StorageClass": "STANDARD_IA",
                                "TransitionInDays": 30
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-logs"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "S3VPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "VpcEndpointType": "Gateway",
                "RouteTableIds": [
                    {
                        "Ref": "PrivateRouteTable"
                    }
                ]
            }
        },
        "APIGatewayVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.execute-api"
                },
                "VpcEndpointType": "Interface",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "APIGatewaySecurityGroup"
                    }
                ],
                "PrivateDnsEnabled": true
            }
        },
        "APIGatewayLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/apigateway/${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                }
            }
        },
        "S3AccessLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/s3/${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                }
            }
        },
        "WAFLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "aws-waf-logs-${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                }
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                }
            }
        },
        "APIGatewayCloudWatchRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "apigateway.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-apigateway-role"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3AccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject",
                                        "s3:DeleteObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ApplicationDataBucket",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${LambdaLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-role"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda functions in VPC",
                "VpcId": {
                    "Ref": "MainVPC"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS outbound access for S3 and AWS services"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "SecureDataProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-secure-processor"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "S3_BUCKET": {
                            "Ref": "ApplicationDataBucket"
                        },
                        "LOG_LEVEL": "INFO"
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport logging\nfrom datetime import datetime\n\nlogger = logging.getLogger()\nlogger.setLevel(os.environ.get('LOG_LEVEL', 'INFO'))\n\ns3 = boto3.client('s3')\n\ndef lambda_handler(event, context):\n    try:\n        # Log request details\n        logger.info(f\"Processing secure request: {json.dumps(event)}\")\n        \n        bucket_name = os.environ['S3_BUCKET']\n        \n        # Example S3 operation - listing objects\n        response = s3.list_objects_v2(\n            Bucket=bucket_name,\n            MaxKeys=5\n        )\n        \n        object_count = response.get('KeyCount', 0)\n        \n        # Prepare response\n        result = {\n            'statusCode': 200,\n            'headers': {\n                'Content-Type': 'application/json',\n                'X-Powered-By': 'AWS Lambda'\n            },\n            'body': json.dumps({\n                'message': 'Secure data processing completed',\n                'timestamp': datetime.utcnow().isoformat(),\n                'requestId': context.aws_request_id,\n                's3ObjectCount': object_count,\n                'bucketName': bucket_name\n            })\n        }\n        \n        logger.info(f\"Request processed successfully: {context.aws_request_id}\")\n        return result\n        \n    except Exception as e:\n        logger.error(f\"Error processing request: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': {\n                'Content-Type': 'application/json'\n            },\n            'body': json.dumps({\n                'error': 'Internal server error',\n                'requestId': context.aws_request_id\n            })\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-secure-processor"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "HealthCheckFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-health-check"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "S3_BUCKET": {
                            "Ref": "ApplicationDataBucket"
                        },
                        "LOG_LEVEL": "INFO"
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom datetime import datetime\n\ns3 = boto3.client('s3')\n\ndef lambda_handler(event, context):\n    try:\n        bucket_name = os.environ['S3_BUCKET']\n        \n        # Simple health check - verify S3 bucket access\n        s3.head_bucket(Bucket=bucket_name)\n        \n        return {\n            'statusCode': 200,\n            'headers': {\n                'Content-Type': 'application/json'\n            },\n            'body': json.dumps({\n                'status': 'healthy',\n                'timestamp': datetime.utcnow().isoformat(),\n                'version': '1.0.0',\n                'services': {\n                    's3': 'available',\n                    'lambda': 'available'\n                }\n            })\n        }\n        \n    except Exception as e:\n        return {\n            'statusCode': 503,\n            'headers': {\n                'Content-Type': 'application/json'\n            },\n            'body': json.dumps({\n                'status': 'unhealthy',\n                'error': str(e),\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-health-check"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "SecureProcessorInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "SecureDataProcessorFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestAPI}/*/*/*"
                }
            }
        },
        "HealthCheckInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "HealthCheckFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestAPI}/*/*/*"
                }
            }
        },
        "WebACL": {
            "Type": "AWS::WAFv2::WebACL",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-web-acl"
                },
                "Scope": "REGIONAL",
                "DefaultAction": {
                    "Allow": {}
                },
                "Rules": [
                    {
                        "Name": "SQLInjectionRule",
                        "Priority": 1,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesSQLiRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "SQLInjectionRule"
                        }
                    },
                    {
                        "Name": "XSSRule",
                        "Priority": 2,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesCommonRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "XSSRule"
                        }
                    },
                    {
                        "Name": "KnownBadInputsRule",
                        "Priority": 3,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "KnownBadInputsRule"
                        }
                    },
                    {
                        "Name": "RateLimitRule",
                        "Priority": 4,
                        "Statement": {
                            "RateBasedStatement": {
                                "Limit": 2000,
                                "AggregateKeyType": "IP"
                            }
                        },
                        "Action": {
                            "Block": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "RateLimitRule"
                        }
                    }
                ],
                "VisibilityConfig": {
                    "SampledRequestsEnabled": true,
                    "CloudWatchMetricsEnabled": true,
                    "MetricName": {
                        "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-web-acl"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-web-acl"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "WAFLoggingConfiguration": {
            "Type": "AWS::WAFv2::LoggingConfiguration",
            "Properties": {
                "ResourceArn": {
                    "Fn::GetAtt": [
                        "WebACL",
                        "Arn"
                    ]
                },
                "LogDestinationConfigs": [
                    {
                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:aws-waf-logs-${ProjectName}-${EnvironmentSuffix}"
                    }
                ]
            }
        },
        "APIGatewayAccount": {
            "Type": "AWS::ApiGateway::Account",
            "Properties": {
                "CloudWatchRoleArn": {
                    "Fn::GetAtt": [
                        "APIGatewayCloudWatchRole",
                        "Arn"
                    ]
                }
            }
        },
        "RestAPI": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
                },
                "Description": "Secure REST API with WAF protection and CloudWatch logging",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "APIResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "RestAPI",
                        "RootResourceId"
                    ]
                },
                "PathPart": "secure"
            }
        },
        "APIMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "ResourceId": {
                    "Ref": "APIResource"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SecureDataProcessorFunction.Arn}/invocations"
                    },
                    "TimeoutInMillis": 29000
                },
                "MethodResponses": [
                    {
                        "StatusCode": "200",
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": "500",
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    }
                ]
            }
        },
        "HealthResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "RestAPI",
                        "RootResourceId"
                    ]
                },
                "PathPart": "health"
            }
        },
        "HealthMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "ResourceId": {
                    "Ref": "HealthResource"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HealthCheckFunction.Arn}/invocations"
                    },
                    "TimeoutInMillis": 29000
                },
                "MethodResponses": [
                    {
                        "StatusCode": "200",
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": "503",
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    }
                ]
            }
        },
        "APIDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "APIMethod",
                "HealthMethod"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "Description": "Production deployment with security features"
            }
        },
        "APIStage": {
            "Type": "AWS::ApiGateway::Stage",
            "DependsOn": "APIGatewayAccount",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestAPI"
                },
                "DeploymentId": {
                    "Ref": "APIDeployment"
                },
                "StageName": {
                    "Ref": "EnvironmentSuffix"
                },
                "AccessLogSetting": {
                    "Fn::If": [
                        "EnableLogging",
                        {
                            "DestinationArn": {
                                "Fn::GetAtt": [
                                    "APIGatewayLogGroup",
                                    "Arn"
                                ]
                            },
                            "Format": "{\"requestId\":\"$context.requestId\",\"ip\":\"$context.identity.sourceIp\",\"caller\":\"$context.identity.caller\",\"user\":\"$context.identity.user\",\"requestTime\":\"$context.requestTime\",\"httpMethod\":\"$context.httpMethod\",\"resourcePath\":\"$context.resourcePath\",\"status\":\"$context.status\",\"protocol\":\"$context.protocol\",\"responseLength\":\"$context.responseLength\",\"requestLength\":\"$context.requestLength\",\"error\":\"$context.error.message\",\"integrationError\":\"$context.integration.error\"}"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "LoggingLevel": {
                            "Fn::If": [
                                "EnableLogging",
                                "INFO",
                                "ERROR"
                            ]
                        },
                        "DataTraceEnabled": {
                            "Fn::If": [
                                "EnableLogging",
                                true,
                                false
                            ]
                        },
                        "MetricsEnabled": true,
                        "ThrottlingBurstLimit": 1000,
                        "ThrottlingRateLimit": 500
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-stage"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "WebACLAssociation": {
            "Type": "AWS::WAFv2::WebACLAssociation",
            "Properties": {
                "ResourceArn": {
                    "Fn::Sub": "arn:aws:apigateway:${AWS::Region}::/restapis/${RestAPI}/stages/${APIStage}"
                },
                "WebACLArn": {
                    "Fn::GetAtt": [
                        "WebACL",
                        "Arn"
                    ]
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID for the secure environment",
            "Value": {
                "Ref": "MainVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-vpc-id"
                }
            }
        },
        "PrivateSubnetIds": {
            "Description": "Private subnet IDs",
            "Value": {
                "Fn::Sub": "${PrivateSubnet1},${PrivateSubnet2}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-private-subnets"
                }
            }
        },
        "PublicSubnetId": {
            "Description": "Public subnet ID",
            "Value": {
                "Ref": "PublicSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-public-subnet"
                }
            }
        },
        "APIGatewayURL": {
            "Description": "API Gateway endpoint URL",
            "Value": {
                "Fn::Sub": "https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-url"
                }
            }
        },
        "APIGatewayId": {
            "Description": "API Gateway ID",
            "Value": {
                "Ref": "RestAPI"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-id"
                }
            }
        },
        "SecureEndpoint": {
            "Description": "Secure API endpoint",
            "Value": {
                "Fn::Sub": "https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}/secure"
            }
        },
        "HealthEndpoint": {
            "Description": "Health check endpoint",
            "Value": {
                "Fn::Sub": "https://${RestAPI}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}/health"
            }
        },
        "ApplicationDataBucketName": {
            "Description": "Name of the application data S3 bucket",
            "Value": {
                "Ref": "ApplicationDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-app-bucket"
                }
            }
        },
        "APILogsBucketName": {
            "Description": "Name of the API logs S3 bucket",
            "Value": {
                "Ref": "APIGatewayLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-logs-bucket"
                }
            }
        },
        "WebACLId": {
            "Description": "WAF Web ACL ID",
            "Value": {
                "Ref": "WebACL"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-web-acl-id"
                }
            }
        },
        "WebACLArn": {
            "Description": "WAF Web ACL ARN",
            "Value": {
                "Fn::GetAtt": [
                    "WebACL",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-web-acl-arn"
                }
            }
        },
        "APIGatewayLogGroupName": {
            "Description": "API Gateway CloudWatch Log Group name",
            "Value": {
                "Ref": "APIGatewayLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-log-group"
                }
            }
        },
        "WAFLogGroupName": {
            "Description": "WAF CloudWatch Log Group name",
            "Value": {
                "Ref": "WAFLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-waf-log-group"
                }
            }
        },
        "SecurityGroupId": {
            "Description": "Security Group ID for API Gateway",
            "Value": {
                "Ref": "APIGatewaySecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-sg-id"
                }
            }
        },
        "S3VPCEndpointId": {
            "Description": "S3 VPC Endpoint ID",
            "Value": {
                "Ref": "S3VPCEndpoint"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-s3-vpc-endpoint"
                }
            }
        },
        "APIGatewayVPCEndpointId": {
            "Description": "API Gateway VPC Endpoint ID",
            "Value": {
                "Ref": "APIGatewayVPCEndpoint"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-vpc-endpoint"
                }
            }
        },
        "LambdaExecutionRoleArn": {
            "Description": "Lambda execution role ARN",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaExecutionRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-role-arn"
                }
            }
        },
        "APIGatewayRoleArn": {
            "Description": "API Gateway CloudWatch role ARN",
            "Value": {
                "Fn::GetAtt": [
                    "APIGatewayCloudWatchRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-apigateway-role-arn"
                }
            }
        },
        "SecureProcessorFunctionArn": {
            "Description": "Secure data processor Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "SecureDataProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-secure-processor-arn"
                }
            }
        },
        "HealthCheckFunctionArn": {
            "Description": "Health check Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "HealthCheckFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-health-check-arn"
                }
            }
        },
        "LambdaSecurityGroupId": {
            "Description": "Security Group ID for Lambda functions",
            "Value": {
                "Ref": "LambdaSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-sg-id"
                }
            }
        }
    }
}
AWSTemplateFormatVersion: "2010-09-09"
Description: "Secure Multi-AZ AWS Infrastructure with WAF, RDS, and Enhanced Security Controls"

Parameters:
  Environment:
    Type: String
    Default: "Production"
    AllowedValues:
      - "Development"
      - "Staging"
      - "Production"
    Description: "Environment type for resource tagging and naming"

  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
    Description: "CIDR block for the VPC"

Mappings:
  RegionMap:
    us-east-1:
      AZs: ["us-east-1a", "us-east-1b"]
    us-east-2:
      AZs: ["us-east-2a", "us-east-2b"]
    us-west-1:
      AZs: ["us-west-1a", "us-west-1b"]
    us-west-2:
      AZs: ["us-west-2a", "us-west-2b"]
    eu-west-1:
      AZs: ["eu-west-1a", "eu-west-1b"]

  # Removed DBUsername and DBPassword parameters in favor of Secrets Manager

Conditions:
  CreateRDSInstance:
    Fn::Not:
      - Fn::Equals:
          - Ref: "AWS::Region"
          - "skip-rds"

Resources:
  # ========================================
  # KMS Keys
  # ========================================

  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS key for encryption"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS:
                Fn::Sub: "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: Allow RDS Service
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"
          - Sid: Allow S3 Service
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"

  # ========================================
  # VPC and Network Resources
  # ========================================

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-VPC"

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::FindInMap:
              - RegionMap
              - Ref: "AWS::Region"
              - AZs
      CidrBlock:
        Fn::Select:
          - 0
          - Fn::Cidr:
              - Ref: VpcCidr
              - 4
              - 8
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Public-1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::FindInMap:
              - RegionMap
              - Ref: "AWS::Region"
              - AZs
      CidrBlock:
        Fn::Select:
          - 1
          - Fn::Cidr:
              - Ref: VpcCidr
              - 4
              - 8
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Public-2"

  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::FindInMap:
              - RegionMap
              - Ref: "AWS::Region"
              - AZs
      CidrBlock:
        Fn::Select:
          - 2
          - Fn::Cidr:
              - Ref: VpcCidr
              - 4
              - 8
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Private-1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::FindInMap:
              - RegionMap
              - Ref: "AWS::Region"
              - AZs
      CidrBlock:
        Fn::Select:
          - 3
          - Fn::Cidr:
              - Ref: VpcCidr
              - 4
              - 8
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Private-2"

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-IGW"

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway

  # NAT Gateways for each AZ
  NatGatewayEIP1:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NatGatewayEIP2:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt: [NatGatewayEIP1, AllocationId]
      SubnetId:
        Ref: PublicSubnet1
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-NAT-1"

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt: [NatGatewayEIP2, AllocationId]
      SubnetId:
        Ref: PublicSubnet2
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-NAT-2"

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Public-RT"

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Private-RT-1"

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NatGateway1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Private-RT-2"

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NatGateway2

  # Route Table Associations
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet1
      RouteTableId:
        Ref: PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet2
      RouteTableId:
        Ref: PublicRouteTable

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet1
      RouteTableId:
        Ref: PrivateRouteTable1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet2
      RouteTableId:
        Ref: PrivateRouteTable2

  # ========================================
  # Security Groups
  # ========================================

  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for web servers"
      VpcId:
        Ref: VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "Allow HTTP from anywhere"
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "Allow HTTPS from anywhere"
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "Allow HTTPS outbound for updates"
        - IpProtocol: -1
          CidrIp: 10.0.0.0/16
          Description: "Allow all traffic within VPC"
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-Web-SG"

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for RDS instance"
      VpcId:
        Ref: VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.0.0.0/16
          Description: "Allow MySQL from within VPC"
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: "Allow outbound to anywhere"
      Tags:
        - Key: Name
          Value:
            Fn::Sub: "${Environment}-RDS-SG"
    Condition: CreateRDSInstance

  # ========================================
  # RDS Database
  # ========================================

  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name:
        Fn::Join:
          - "-"
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - "-"
                    - Fn::Sub: "${AWS::StackName}"
            - Fn::Sub: "${Environment}"
            - "secrets"
            - Fn::Select:
                - 2
                - Fn::Split:
                    - "/"
                    - Fn::Sub: "${AWS::StackId}"
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
    Condition: CreateRDSInstance

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for RDS instance"
      SubnetIds:
        - Ref: PrivateSubnet1
        - Ref: PrivateSubnet2
    Condition: CreateRDSInstance

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier:
        Fn::Join:
          - "-"
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - "-"
                    - Fn::Sub: "${AWS::StackName}"
            - Fn::Sub: "${Environment}"
            - "database"
            - Fn::Select:
                - 0
                - Fn::Split:
                    - "-"
                    - Fn::Sub: "${AWS::Region}"
            - Fn::Select:
                - 5
                - Fn::Split:
                    - "-"
                    - Fn::Sub: "${AWS::StackId}"
      DBInstanceClass: db.t3.micro
      Engine: mysql
      AllocatedStorage: 20
      MultiAZ: true
      StorageEncrypted: true
      KmsKeyId:
        Ref: KMSKey
      MasterUsername:
        Fn::Sub: "{{resolve:secretsmanager:${DBSecret}:SecretString:username}}"
      MasterUserPassword:
        Fn::Sub: "{{resolve:secretsmanager:${DBSecret}:SecretString:password}}"
      VPCSecurityGroups:
        - Ref: RDSSecurityGroup
      DBSubnetGroupName:
        Ref: DBSubnetGroup
      BackupRetentionPeriod: 7
      DeletionProtection: true
    Condition: CreateRDSInstance

  # ========================================
  # S3 Bucket
  # ========================================

  SecureS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID:
                Ref: KMSKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  # ========================================
  # CloudWatch Monitoring
  # ========================================

  RDSAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Monitor RDS CPU utilization"
      MetricName: CPUUtilization
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBInstanceIdentifier
          Value:
            Ref: RDSInstance
    Condition: CreateRDSInstance

  # ========================================
  # WAF
  # ========================================

  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name:
        Fn::Join:
          - "-"
          - - Fn::Sub: "${AWS::StackName}"
            - Fn::Sub: "${Environment}"
            - "wacl"
            - Fn::Select:
                - 4
                - Fn::Split:
                    - "-"
                    - Fn::Sub: "${AWS::StackId}"
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName:
          Fn::Join:
            - "-"
            - - Fn::Sub: "${AWS::StackName}"
              - "waf"
              - "metrics"
      Rules:
        - Name: BlockSQLInjection
          Priority: 1
          Statement:
            SqliMatchStatement:
              FieldToMatch:
                AllQueryArguments: {}
              TextTransformations:
                - Priority: 1
                  Type: URL_DECODE
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName:
              Fn::Join:
                - "-"
                - - Fn::Sub: "${AWS::StackName}"
                  - "sqli"
                  - "metrics"

Outputs:
  VPCId:
    Description: "VPC ID"
    Value:
      Ref: VPC

  PublicSubnets:
    Description: "List of public subnets"
    Value:
      Fn::Join:
        - ","
        - - Ref: PublicSubnet1
          - Ref: PublicSubnet2

  PrivateSubnets:
    Description: "List of private subnets"
    Value:
      Fn::Join:
        - ","
        - - Ref: PrivateSubnet1
          - Ref: PrivateSubnet2

  RDSEndpoint:
    Description: "RDS endpoint"
    Condition: CreateRDSInstance
    Value:
      Fn::GetAtt: [RDSInstance, Endpoint.Address]

  S3BucketName:
    Description: "Name of secure S3 bucket"
    Value:
      Ref: SecureS3Bucket

  WebACLArn:
    Description: "ARN of the WAF Web ACL"
    Value:
      Fn::GetAtt: [WebACL, Arn]

  StackName:
    Description: "Name of the stack"
    Value:
      Ref: "AWS::StackName"

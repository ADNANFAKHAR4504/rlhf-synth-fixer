AWSTemplateFormatVersion: '2010-09-09'
Description: 'Comprehensive monitoring setup for multi-environment infrastructure'

Parameters:
  EnvironmentType:
    Type: String
    AllowedValues: ['staging', 'production']
    Default: 'staging'
    Description: 'Type of environment'

  RegionName:
    Type: String
    Description: 'AWS Region name'

  SNSTopicArn:
    Type: String
    Description: 'SNS Topic ARN for notifications'

Resources:
  # CloudWatch Dashboard
  EnvironmentDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${RegionName}-${EnvironmentType}-dashboard'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/EC2", "CPUUtilization", "AutoScalingGroupName", "${RegionName}-${EnvironmentType}-asg"],
                  ["AWS/RDS", "CPUUtilization", "DBInstanceIdentifier", "${RegionName}-${EnvironmentType}-database"],
                  ["AWS/S3", "NumberOfObjects", "BucketName", "${RegionName}-${EnvironmentType}-data-${AWS::AccountId}"]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${RegionName}",
                "title": "Resource Utilization"
              }
            }
          ]
        }

  # Custom CloudWatch Metrics
  CustomMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub '/aws/ec2/${RegionName}-${EnvironmentType}'
      FilterPattern: '[timestamp, request_id, "ERROR"]'
      MetricTransformations:
        - MetricNamespace: !Sub 'Custom/${EnvironmentType}'
          MetricName: ErrorCount
          MetricValue: '1'
          DefaultValue: 0

  # CloudWatch Alarm for custom metrics
  ErrorCountAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${RegionName}-${EnvironmentType}-error-count'
      AlarmDescription: 'High error count alarm'
      MetricName: ErrorCount
      Namespace: !Sub 'Custom/${EnvironmentType}'
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref SNSTopicArn

Outputs:
  DashboardURL:
    Description: 'CloudWatch Dashboard URL'
    Value: !Sub 'https://${RegionName}.console.aws.amazon.com/cloudwatch/home?region=${RegionName}#dashboards:name=${RegionName}-${EnvironmentType}-dashboard'
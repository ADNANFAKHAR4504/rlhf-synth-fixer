{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Comprehensive monitoring setup for multi-environment infrastructure",
    "Parameters": {
        "EnvironmentType": {
            "Type": "String",
            "AllowedValues": [
                "staging",
                "production"
            ],
            "Default": "staging",
            "Description": "Type of environment"
        },
        "RegionName": {
            "Type": "String",
            "Description": "AWS Region name"
        },
        "SNSTopicArn": {
            "Type": "String",
            "Description": "SNS Topic ARN for notifications"
        }
    },
    "Resources": {
        "EnvironmentDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Properties": {
                "DashboardName": {
                    "Fn::Sub": "${RegionName}-${EnvironmentType}-dashboard"
                },
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/EC2\", \"CPUUtilization\", \"AutoScalingGroupName\", \"${RegionName}-${EnvironmentType}-asg\"],\n          [\"AWS/RDS\", \"CPUUtilization\", \"DBInstanceIdentifier\", \"${RegionName}-${EnvironmentType}-database\"],\n          [\"AWS/S3\", \"NumberOfObjects\", \"BucketName\", \"${RegionName}-${EnvironmentType}-data-${AWS::AccountId}\"]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${RegionName}\",\n        \"title\": \"Resource Utilization\"\n      }\n    }\n  ]\n}\n"
                }
            }
        },
        "CustomMetricFilter": {
            "Type": "AWS::Logs::MetricFilter",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/ec2/${RegionName}-${EnvironmentType}"
                },
                "FilterPattern": "[timestamp, request_id, \"ERROR\"]",
                "MetricTransformations": [
                    {
                        "MetricNamespace": {
                            "Fn::Sub": "Custom/${EnvironmentType}"
                        },
                        "MetricName": "ErrorCount",
                        "MetricValue": "1",
                        "DefaultValue": 0
                    }
                ]
            }
        },
        "ErrorCountAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${RegionName}-${EnvironmentType}-error-count"
                },
                "AlarmDescription": "High error count alarm",
                "MetricName": "ErrorCount",
                "Namespace": {
                    "Fn::Sub": "Custom/${EnvironmentType}"
                },
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "AlarmActions": [
                    {
                        "Ref": "SNSTopicArn"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "DashboardURL": {
            "Description": "CloudWatch Dashboard URL",
            "Value": {
                "Fn::Sub": "https://${RegionName}.console.aws.amazon.com/cloudwatch/home?region=${RegionName}#dashboards:name=${RegionName}-${EnvironmentType}-dashboard"
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Event-driven delivery app infrastructure with S3, Lambda, EventBridge, DynamoDB, and CloudWatch",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment name"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix to ensure unique resource names"
        }
    },
    "Resources": {
        "OrderUploadBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "delivery-app-orders-${EnvironmentSuffix}-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "NotificationConfiguration": {
                    "EventBridgeConfiguration": {
                        "EventBridgeEnabled": true
                    }
                }
            }
        },
        "ProcessedOrdersTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "delivery-orders-${EnvironmentSuffix}"
                },
                "BillingMode": "PAY_PER_REQUEST",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "orderId",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "processedTimestamp",
                        "AttributeType": "N"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "orderId",
                        "KeyType": "HASH"
                    }
                ],
                "GlobalSecondaryIndexes": [
                    {
                        "IndexName": "ProcessedTimestampIndex",
                        "KeySchema": [
                            {
                                "AttributeName": "processedTimestamp",
                                "KeyType": "HASH"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        }
                    }
                ],
                "StreamSpecification": {
                    "StreamViewType": "NEW_AND_OLD_IMAGES"
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": false
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "OrderProcessorLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "order-processor-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "OrderProcessorPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${OrderUploadBucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:Query"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ProcessedOrdersTable",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ProcessedOrdersTable.Arn}/index/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "xray:PutTraceSegments",
                                        "xray:PutTelemetryRecords"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "OrderProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "order-processor-${EnvironmentSuffix}"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "MemorySize": 512,
                "Timeout": 60,
                "Environment": {
                    "Variables": {
                        "DYNAMODB_TABLE": {
                            "Ref": "ProcessedOrdersTable"
                        },
                        "ENVIRONMENT": {
                            "Ref": "Environment"
                        },
                        "METRICS_NAMESPACE": "DeliveryApp/OrderProcessing"
                    }
                },
                "Role": {
                    "Fn::GetAtt": [
                        "OrderProcessorLambdaRole",
                        "Arn"
                    ]
                },
                "TracingConfig": {
                    "Mode": "Active"
                },
                "Code": {
                    "ZipFile": "import json\nimport os\nimport boto3\nimport time\nfrom datetime import datetime\nfrom decimal import Decimal\nimport logging\nfrom botocore.exceptions import ClientError\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ns3_client = boto3.client('s3')\ndynamodb = boto3.resource('dynamodb')\ncloudwatch = boto3.client('cloudwatch')\n\ntable_name = os.environ['DYNAMODB_TABLE']\nmetrics_namespace = os.environ['METRICS_NAMESPACE']\nenvironment = os.environ['ENVIRONMENT']\n\ndef handler(event, context):\n    start_time = time.time()\n    processed_count = 0\n    error_count = 0\n\n    try:\n        # Parse CloudEvents format if present\n        if 'detail' in event and 'bucket' in event['detail']:\n            bucket_name = event['detail']['bucket']['name']\n            object_key = event['detail']['object']['key']\n        else:\n            # Fallback to standard EventBridge S3 event format\n            detail = event.get('detail', {})\n            bucket_name = detail.get('bucket', {}).get('name', '')\n            object_key = detail.get('object', {}).get('key', '')\n\n        if not bucket_name or not object_key:\n            logger.error('Missing bucket or object information in event')\n            raise ValueError('Invalid event structure')\n\n        logger.info(f'Processing file: s3://{bucket_name}/{object_key}')\n\n        # Read the file from S3\n        response = s3_client.get_object(Bucket=bucket_name, Key=object_key)\n        file_content = response['Body'].read().decode('utf-8')\n\n        # Parse order data (assuming JSON format)\n        try:\n            orders = json.loads(file_content)\n            if not isinstance(orders, list):\n                orders = [orders]\n        except json.JSONDecodeError as e:\n            logger.error(f'Failed to parse JSON: {e}')\n            raise\n\n        # Process each order\n        table = dynamodb.Table(table_name)\n\n        for order in orders:\n            try:\n                # Validate required fields\n                if 'orderId' not in order:\n                    logger.warning(f'Order missing orderId: {order}')\n                    error_count += 1\n                    continue\n\n                # Add processing metadata\n                order['processedTimestamp'] = int(datetime.now().timestamp())\n                order['processingDate'] = datetime.now().isoformat()\n                order['sourceFile'] = f's3://{bucket_name}/{object_key}'\n                order['environment'] = environment\n\n                # Convert float values to Decimal for DynamoDB\n                order = json.loads(json.dumps(order), parse_float=Decimal)\n\n                # Store in DynamoDB\n                table.put_item(Item=order)\n                processed_count += 1\n\n                logger.info(f'Successfully processed order: {order[\"orderId\"]}')\n\n            except ClientError as e:\n                logger.error(f'DynamoDB error for order {order.get(\"orderId\", \"unknown\")}: {e}')\n                error_count += 1\n            except Exception as e:\n                logger.error(f'Unexpected error processing order: {e}')\n                error_count += 1\n\n        # Calculate processing time\n        processing_time = (time.time() - start_time) * 1000  # Convert to milliseconds\n\n        # Send metrics to CloudWatch\n        send_metrics(processed_count, error_count, processing_time)\n\n        # Return processing summary\n        result = {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Order processing completed',\n                'processedCount': processed_count,\n                'errorCount': error_count,\n                'processingTimeMs': processing_time,\n                'sourceFile': f's3://{bucket_name}/{object_key}'\n            })\n        }\n\n        logger.info(f'Processing complete: {result}')\n        return result\n\n    except Exception as e:\n        logger.error(f'Fatal error in order processing: {e}')\n\n        # Send error metrics\n        send_error_metric()\n\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': str(e),\n                'message': 'Order processing failed'\n            })\n        }\n\ndef send_metrics(processed_count, error_count, processing_time):\n    try:\n        cloudwatch.put_metric_data(\n            Namespace=metrics_namespace,\n            MetricData=[\n                {\n                    'MetricName': 'OrdersProcessed',\n                    'Value': processed_count,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                },\n                {\n                    'MetricName': 'OrderProcessingErrors',\n                    'Value': error_count,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                },\n                {\n                    'MetricName': 'ProcessingTime',\n                    'Value': processing_time,\n                    'Unit': 'Milliseconds',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                },\n                {\n                    'MetricName': 'SuccessRate',\n                    'Value': (processed_count / (processed_count + error_count)) * 100 if (processed_count + error_count) > 0 else 0,\n                    'Unit': 'Percent',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                }\n            ]\n        )\n    except Exception as e:\n        logger.error(f'Failed to send metrics: {e}')\n\ndef send_error_metric():\n    try:\n        cloudwatch.put_metric_data(\n            Namespace=metrics_namespace,\n            MetricData=[\n                {\n                    'MetricName': 'ProcessingFailures',\n                    'Value': 1,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                }\n            ]\n        )\n    except Exception as e:\n        logger.error(f'Failed to send error metric: {e}')\n"
                }
            }
        },
        "OrderUploadEventRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "order-upload-rule-${EnvironmentSuffix}"
                },
                "Description": "Trigger Lambda when new order files are uploaded to S3",
                "EventPattern": {
                    "source": [
                        "aws.s3"
                    ],
                    "detail-type": [
                        "Object Created"
                    ],
                    "detail": {
                        "bucket": {
                            "name": [
                                {
                                    "Ref": "OrderUploadBucket"
                                }
                            ]
                        },
                        "object": {
                            "key": [
                                {
                                    "prefix": "orders/"
                                }
                            ]
                        }
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "OrderProcessorFunction",
                                "Arn"
                            ]
                        },
                        "Id": "OrderProcessorTarget",
                        "RetryPolicy": {
                            "MaximumRetryAttempts": 2
                        }
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "OrderProcessorFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "OrderUploadEventRule",
                        "Arn"
                    ]
                }
            }
        },
        "OrderProcessingDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Properties": {
                "DashboardName": {
                    "Fn::Sub": "delivery-app-orders-${EnvironmentSuffix}"
                },
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"DeliveryApp/OrderProcessing\", \"OrdersProcessed\", {\"stat\": \"Sum\", \"label\": \"Orders Processed\"}],\n          [\".\", \"OrderProcessingErrors\", {\"stat\": \"Sum\", \"label\": \"Processing Errors\"}],\n          [\".\", \"ProcessingFailures\", {\"stat\": \"Sum\", \"label\": \"Processing Failures\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Sum\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Order Processing Metrics\",\n        \"view\": \"timeSeries\",\n        \"stacked\": false\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"DeliveryApp/OrderProcessing\", \"ProcessingTime\", {\"stat\": \"Average\", \"label\": \"Avg Processing Time (ms)\"}],\n          [\".\", \".\", {\"stat\": \"Maximum\", \"label\": \"Max Processing Time (ms)\"}],\n          [\".\", \".\", {\"stat\": \"Minimum\", \"label\": \"Min Processing Time (ms)\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Processing Performance\",\n        \"view\": \"timeSeries\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"DeliveryApp/OrderProcessing\", \"SuccessRate\", {\"stat\": \"Average\", \"label\": \"Success Rate (%)\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Processing Success Rate\",\n        \"view\": \"singleValue\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Invocations\", \"FunctionName\", \"${OrderProcessorFunction}\", {\"stat\": \"Sum\"}],\n          [\".\", \"Errors\", \".\", \".\", {\"stat\": \"Sum\"}],\n          [\".\", \"Duration\", \".\", \".\", {\"stat\": \"Average\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Lambda Function Metrics\"\n      }\n    }\n  ]\n}\n"
                }
            }
        },
        "HighErrorRateAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "delivery-app-high-error-rate-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alert when order processing error rate is high",
                "MetricName": "OrderProcessingErrors",
                "Namespace": "DeliveryApp/OrderProcessing",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 10,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProcessingFailureAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "delivery-app-processing-failures-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alert when Lambda function fails",
                "MetricName": "ProcessingFailures",
                "Namespace": "DeliveryApp/OrderProcessing",
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "S3BucketName": {
            "Description": "S3 bucket for order uploads",
            "Value": {
                "Ref": "OrderUploadBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-bucket"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "DynamoDB table for processed orders",
            "Value": {
                "Ref": "ProcessedOrdersTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-table"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "Order processor Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "OrderProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-lambda"
                }
            }
        },
        "DashboardURL": {
            "Description": "CloudWatch Dashboard URL",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${OrderProcessingDashboard}"
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  CloudEnvStack â€” Aurora MySQL (writer+2 readers) with tuned params, backtrack, RDS-managed
  Secrets Manager password/rotation (no macro), proactive CloudWatch alarms, and full VPC isolation.
  All names are suffixed with EnvironmentSuffix.

Metadata:
  cfn-lint:
    config:
      regions: [us-east-1]

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: Suffix applied to all names to prevent cross-environment collisions (use kebab-case).
    AllowedPattern: '^[a-z0-9]+(-[a-z0-9]+)*$'
    ConstraintDescription: Use lowercase letters, digits, and hyphens (kebab-case), e.g., prod-us.
    Default: prod-us
  AlarmEmail:
    Type: String
    Description: Email address to subscribe for alarm notifications.
    AllowedPattern: '^[^@]+@[^@]+\.[^@]+$'
    Default: trading-platform-alerts@example.com
  VpcCidr:
    Type: String
    Default: 10.42.0.0/16
    Description: CIDR for the application VPC.
  PrivateSubnet1Cidr:
    Type: String
    Default: 10.42.1.0/24
    Description: CIDR for private subnet in AZ a.
  PrivateSubnet2Cidr:
    Type: String
    Default: 10.42.2.0/24
    Description: CIDR for private subnet in AZ b.
  PrivateSubnet3Cidr:
    Type: String
    Default: 10.42.3.0/24
    Description: CIDR for private subnet in AZ c.
  DBName:
    Type: String
    Default: tradingdb
    Description: Initial database name.
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9_]{0,63}$'
  MasterUsername:
    Type: String
    Default: dbadmin
    Description: Master user name for the Aurora cluster.
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9_]{0,15}$'
  EngineVersion:
    Type: String
    Default: '5.7.mysql_aurora.2.11.5'
    Description: Aurora MySQL 2.x engine version compatible with MySQL 5.7 family.
  InstanceClass:
    Type: String
    Default: db.r5.2xlarge
    Description: DB instance class for writer and readers.

Mappings:
  Tags:
    Common:
      Environment: Production
      Team: Platform
      Service: Trading

Resources:

  # --------------------------
  # Networking (VPC & Subnets)
  # --------------------------
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub tap-vpc-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet1Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub tap-private-az1-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet2Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub tap-private-az2-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      AvailabilityZone: !Select [2, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet3Cidr
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub tap-private-az3-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  RouteTablePrivate:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: !Sub tap-rtb-private-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  RouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      SubnetId: !Ref PrivateSubnet1

  RouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      SubnetId: !Ref PrivateSubnet2

  RouteTableAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTablePrivate
      SubnetId: !Ref PrivateSubnet3

  # Interface VPC Endpoints (kept; harmless even without rotation lambda)
  VpcEndpointSecretsManager:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref Vpc
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      SecurityGroupIds:
        - !Ref RotationLambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub tap-vpce-secretsmanager-${EnvironmentSuffix}

  VpcEndpointCloudWatch:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref Vpc
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      SecurityGroupIds:
        - !Ref RotationLambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub tap-vpce-logs-${EnvironmentSuffix}

  # --------------------------
  # Security Groups
  # --------------------------
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Application tier SG allowed to connect to DB
      VpcId: !Ref Vpc
      SecurityGroupIngress: []
      Tags:
        - Key: Name
          Value: !Sub tap-app-sg-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  RotationLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG for rotation/aux services in VPC
      VpcId: !Ref Vpc
      SecurityGroupIngress: []
      Tags:
        - Key: Name
          Value: !Sub tap-rotate-sg-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Database SG allowing MySQL from App and Rotation SGs
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroup
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref RotationLambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub tap-db-sg-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  # --------------------------
  # RDS Subnet Group
  # --------------------------
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub Aurora subnets (${EnvironmentSuffix})
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      DBSubnetGroupName: !Sub tap-dbsubnet-${EnvironmentSuffix}
      Tags:
        - Key: Name
          Value: !Sub tap-dbsubnet-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  # --------------------------
  # KMS CMK for RDS & Secrets
  # --------------------------
  KmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub CMK for RDS and Secrets (${EnvironmentSuffix})
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowRootAccount
            Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: 'kms:*'
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub tap-kms-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  KmsAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/tap-rds-${EnvironmentSuffix}
      TargetKeyId: !Ref KmsKey

  # --------------------------
  # Parameter Groups
  # --------------------------
  # Cluster-level parameter group (Aurora MySQL 5.7 disables query cache => set to 0).
  DbClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: !Sub Aurora MySQL cluster params (${EnvironmentSuffix})
      Family: aurora-mysql5.7
      Parameters:
        query_cache_size: '0'
        character_set_server: utf8mb4
        collation_server: utf8mb4_unicode_ci
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-cluster-pg-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  # Instance-level parameter group; keep modifiable params only
  DbInstanceParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: !Sub Aurora MySQL instance params (${EnvironmentSuffix})
      Family: aurora-mysql5.7
      Parameters:
        max_connections: '16000'
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-instance-pg-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  # --------------------------
  # Aurora Cluster & Instances
  # --------------------------
  DbCluster:
    Type: AWS::RDS::DBCluster
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      Engine: aurora-mysql
      EngineVersion: !Ref EngineVersion
      EngineMode: provisioned
      DBClusterIdentifier: !Sub tap-aurora-${EnvironmentSuffix}
      DatabaseName: !Ref DBName
      DBSubnetGroupName: !Ref DbSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DbSecurityGroup
      KmsKeyId: !Ref KmsKey
      StorageEncrypted: true

      # RDS-managed master user password + Secrets Manager (no macro)
      MasterUsername: !Ref MasterUsername
      ManageMasterUserPassword: true
      MasterUserSecret:
        KmsKeyId: !Ref KmsKey

      CopyTagsToSnapshot: true
      BackupRetentionPeriod: 7
      PreferredBackupWindow: 07:00-09:00
      PreferredMaintenanceWindow: sun:09:00-sun:11:00
      BacktrackWindow: 259200   # 72 hours in seconds
      DBClusterParameterGroupName: !Ref DbClusterParameterGroup
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-cluster-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  DbInstanceWriter:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub tap-aurora-writer-${EnvironmentSuffix}
      DBInstanceClass: !Ref InstanceClass
      Engine: aurora-mysql
      EngineVersion: !Ref EngineVersion
      DBClusterIdentifier: !Ref DbCluster
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBParameterGroupName: !Ref DbInstanceParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      AutoMinorVersionUpgrade: true
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-writer-${EnvironmentSuffix}
        - Key: Role
          Value: writer
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  DbInstanceReader1:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub tap-aurora-reader1-${EnvironmentSuffix}
      DBInstanceClass: !Ref InstanceClass
      Engine: aurora-mysql
      EngineVersion: !Ref EngineVersion
      DBClusterIdentifier: !Ref DbCluster
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBParameterGroupName: !Ref DbInstanceParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      AutoMinorVersionUpgrade: true
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-reader1-${EnvironmentSuffix}
        - Key: Role
          Value: reader
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  DbInstanceReader2:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub tap-aurora-reader2-${EnvironmentSuffix}
      DBInstanceClass: !Ref InstanceClass
      Engine: aurora-mysql
      EngineVersion: !Ref EngineVersion
      DBClusterIdentifier: !Ref DbCluster
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBParameterGroupName: !Ref DbInstanceParameterGroup
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      AutoMinorVersionUpgrade: true
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-reader2-${EnvironmentSuffix}
        - Key: Role
          Value: reader
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  # --------------------------
  # SNS for Alarms
  # --------------------------
  SnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub tap-aurora-alarms-${EnvironmentSuffix}
      KmsMasterKeyId: !Ref KmsKey
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-alarms-${EnvironmentSuffix}
        - Key: Environment
          Value: !FindInMap [Tags, Common, Environment]
        - Key: Team
          Value: !FindInMap [Tags, Common, Team]
        - Key: Service
          Value: !FindInMap [Tags, Common, Service]

  SnsSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref SnsTopic
      Protocol: email
      Endpoint: !Ref AlarmEmail

  # --------------------------
  # CloudWatch Alarms (5)
  # --------------------------
  AlarmCpu:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tap-aurora-cpu80-${EnvironmentSuffix}
      AlarmDescription: CPUUtilization > 80% on writer (5min)
      Namespace: AWS/RDS
      MetricName: CPUUtilization
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DbInstanceWriter
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: [!Ref SnsTopic]
      OKActions: [!Ref SnsTopic]
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-cpu80-${EnvironmentSuffix}

  AlarmConnections:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tap-aurora-connections-${EnvironmentSuffix}
      AlarmDescription: DatabaseConnections > 14000 at writer (5min)
      Namespace: AWS/RDS
      MetricName: DatabaseConnections
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DbInstanceWriter
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 14000
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: [!Ref SnsTopic]
      OKActions: [!Ref SnsTopic]
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-connections-${EnvironmentSuffix}

  AlarmReadLatency:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tap-aurora-read-latency-${EnvironmentSuffix}
      AlarmDescription: ReadLatency > 200ms on writer (5min)
      Namespace: AWS/RDS
      MetricName: ReadLatency
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DbInstanceWriter
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 0.2
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: [!Ref SnsTopic]
      OKActions: [!Ref SnsTopic]
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-read-latency-${EnvironmentSuffix}

  AlarmWriteLatency:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tap-aurora-write-latency-${EnvironmentSuffix}
      AlarmDescription: WriteLatency > 200ms on writer (5min)
      Namespace: AWS/RDS
      MetricName: WriteLatency
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DbInstanceWriter
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 0.2
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: [!Ref SnsTopic]
      OKActions: [!Ref SnsTopic]
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-write-latency-${EnvironmentSuffix}

  AlarmReplicaLag:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tap-aurora-replica-lag-${EnvironmentSuffix}
      AlarmDescription: AuroraReplicaLagMaximum > 1000ms at cluster (5min)
      Namespace: AWS/RDS
      MetricName: AuroraReplicaLagMaximum
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref DbCluster
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: [!Ref SnsTopic]
      OKActions: [!Ref SnsTopic]
      Tags:
        - Key: Name
          Value: !Sub tap-aurora-replica-lag-${EnvironmentSuffix}

Outputs:
  ClusterArn:
    Description: Aurora cluster ARN
    Value: !GetAtt DbCluster.DBClusterArn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-cluster-arn

  ClusterIdentifier:
    Description: Aurora cluster identifier
    Value: !Ref DbCluster
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-cluster-id

  WriterEndpoint:
    Description: Writer endpoint DNS
    Value: !GetAtt DbCluster.Endpoint.Address
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-writer-endpoint

  ReaderEndpoint:
    Description: Reader endpoint DNS (Aurora distributes reads)
    Value: !GetAtt DbCluster.ReadEndpoint.Address
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-reader-endpoint

  EngineVersionOut:
    Description: Engine version
    Value: !Ref EngineVersion
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-engine-version

  DBInstanceWriterArn:
    Description: Writer instance DBI resource id
    Value: !GetAtt DbInstanceWriter.DbiResourceId
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-writer-dbi-resource-id

  DBInstanceReader1Arn:
    Description: Reader1 instance DBI resource id
    Value: !GetAtt DbInstanceReader1.DbiResourceId
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-reader1-dbi-resource-id

  DBInstanceReader2Arn:
    Description: Reader2 instance DBI resource id
    Value: !GetAtt DbInstanceReader2.DbiResourceId
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-reader2-dbi-resource-id

  SecretArn:
    Description: Secrets Manager master credential secret ARN (managed by RDS)
    Value: !GetAtt DbCluster.MasterUserSecret.SecretArn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-secret-arn

  RotationScheduleArn:
    Description: Rotation mechanism indicator (RDS-managed; no Lambda/macro required)
    Value: managed-by-rds
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-rotation-arn

  SnsTopicArn:
    Description: SNS topic for alarms
    Value: !Ref SnsTopic
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-sns-arn

  AlarmCpuArn:
    Description: Alarm ARN (CPU)
    Value: !GetAtt AlarmCpu.Arn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-alarm-cpu-arn

  AlarmConnectionsArn:
    Description: Alarm ARN (Connections)
    Value: !GetAtt AlarmConnections.Arn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-alarm-connections-arn

  AlarmReadLatencyArn:
    Description: Alarm ARN (ReadLatency)
    Value: !GetAtt AlarmReadLatency.Arn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-alarm-read-latency-arn

  AlarmWriteLatencyArn:
    Description: Alarm ARN (WriteLatency)
    Value: !GetAtt AlarmWriteLatency.Arn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-alarm-write-latency-arn

  AlarmReplicaLagArn:
    Description: Alarm ARN (ReplicaLag)
    Value: !GetAtt AlarmReplicaLag.Arn
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-alarm-replica-lag-arn

  VpcId:
    Description: VPC Id
    Value: !Ref Vpc
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-vpc-id

  DbSecurityGroupId:
    Description: DB Security Group Id
    Value: !Ref DbSecurityGroup
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-db-sg-id

  AppSecurityGroupId:
    Description: App Security Group Id
    Value: !Ref AppSecurityGroup
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-app-sg-id

  DbSubnetGroupName:
    Description: DB Subnet Group Name
    Value: !Ref DbSubnetGroup
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-dbsubnet-name

  PrivateSubnetIds:
    Description: Comma-delimited list of private subnet IDs
    Value: !Join [ ',', [ !Ref PrivateSubnet1, !Ref PrivateSubnet2, !Ref PrivateSubnet3 ] ]
    Export:
      Name: !Sub tap-${EnvironmentSuffix}-private-subnets

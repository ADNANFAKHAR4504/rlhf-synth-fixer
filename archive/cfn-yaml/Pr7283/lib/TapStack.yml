AWSTemplateFormatVersion: '2010-09-09'
Description: 'Production-grade foundational AWS infrastructure for web application development environment'

# Metadata for stack configuration
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network Configuration"
        Parameters:
          - VPCCidr
          - PublicSubnetCidr
      - Label:
          default: "Instance Configuration"
        Parameters:
          - KeyPairName
          - InstanceType
          - LatestAmiId
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentTag
          - ProjectName
    ParameterLabels:
      KeyPairName:
        default: "EC2 Key Pair Name"
      LatestAmiId:
        default: "Amazon Linux 2 AMI ID"
      VPCCidr:
        default: "VPC CIDR Block"
      PublicSubnetCidr:
        default: "Public Subnet CIDR Block"
      InstanceType:
        default: "EC2 Instance Type"
      EnvironmentTag:
        default: "Environment Tag Value"
      ProjectName:
        default: "Project Name"

# Parameters for dynamic configuration
Parameters:
  # Network Parameters
  VPCCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: CIDR block for the VPC
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    ConstraintDescription: Must be a valid CIDR block

  PublicSubnetCidr:
    Type: String
    Default: '10.0.1.0/24'
    Description: CIDR block for the public subnet
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    ConstraintDescription: Must be a valid CIDR block

  # Instance Parameters
  HasKeyPair:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Set to true to attach an existing EC2 KeyPair to the web server instance

  KeyPairName:
    Type: String
    Default: ''
    Description: Name of an existing EC2 KeyPair to enable SSH access
    AllowedPattern: '^[A-Za-z0-9._-]{0,255}$'
    ConstraintDescription: Provide an existing EC2 KeyPair name when HasKeyPair is true

  InstanceType:
    Type: String
    Default: t2.micro
    Description: EC2 instance type for the web server
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
    ConstraintDescription: Must be a valid EC2 instance type

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux 2 AMI ID from SSM Parameter Store

  # Environment Parameters
  EnvironmentTag:
    Type: String
    Default: Testing
    Description: Environment tag value for all resources
    AllowedValues:
      - Development
      - Testing
      - Staging
      - Production
    ConstraintDescription: Must be a valid environment name

  ProjectName:
    Type: String
    Default: WebServerInfrastructure
    Description: Project name for resource naming
    MinLength: 1
    MaxLength: 50
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9-]*$'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters and hyphens

# Conditions for validation
Conditions:
  UseExistingKeyPair: !Equals [!Ref HasKeyPair, 'true']

# Rules for validation
Rules:
  RequireKeyPairNameWhenEnabled:
    RuleCondition: !Equals [!Ref HasKeyPair, 'true']
    Assertions:
      - Assert: !Not [!Equals [!Ref KeyPairName, '']]
        AssertDescription: Provide a KeyPairName when HasKeyPair is true


Resources:
  # ==========================================
  # VPC Configuration
  # ==========================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${AWS::StackName}-VPC'
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Region
          Value: !Ref 'AWS::Region'
        - Key: Stack
          Value: !Ref 'AWS::StackName'

  # ==========================================
  # Internet Gateway
  # ==========================================
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${AWS::StackName}-IGW'
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation

  # Attach Internet Gateway to VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # ==========================================
  # Public Subnet Configuration
  # ==========================================
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnetCidr
      AvailabilityZone: !Select 
        - 0
        - !GetAZs ''
      MapPublicIpOnLaunch: true  # Ensures instances get public IPs automatically
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${AWS::StackName}-PublicSubnet'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation
        - Key: AvailabilityZone
          Value: !Select [0, !GetAZs '']

  # ==========================================
  # Routing Configuration
  # ==========================================
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${AWS::StackName}-PublicRouteTable'
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Type
          Value: Public

  # Route to Internet Gateway for public internet access
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate Public Subnet with Route Table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # ==========================================
  # Security Configuration
  # ==========================================
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${AWS::StackName}-WebServerSG'
      GroupDescription: !Sub 'Security group for ${ProjectName} web server instance with SSH and HTTP access - Least privilege configuration'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # SSH Access - Port 22
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: Allow SSH access from any IP address (Required per specifications)
        # HTTP Access - Port 80
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP access from any IP address (Required per specifications)
      SecurityGroupEgress:
        # Least privilege - Only allow necessary outbound traffic
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP outbound for package downloads
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS outbound for secure package downloads
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VPCCidr
          Description: Allow SSH within VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${AWS::StackName}-WebServerSG'
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation
        - Key: SecurityLevel
          Value: Basic

  # ==========================================
  # EC2 Instance Configuration
  # ==========================================
  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      KeyName: !If [UseExistingKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      Monitoring: true  # Enable detailed monitoring for production readiness
      Tags:
        - Key: Name
          Value: WebServerInstance  # Required exact name 
        - Key: Environment
          Value: !Ref EnvironmentTag  # Using parameter value 
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Project
          Value: !Ref ProjectName
        - Key: InstanceType
          Value: !Ref InstanceType
        - Key: Stack
          Value: !Ref 'AWS::StackName'
        - Key: Region
          Value: !Ref 'AWS::Region'
        - Key: AvailabilityZone
          Value: !Select [0, !GetAZs '']
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Basic instance initialization script
          # Update system packages for security
          yum update -y
          
          # Log instance initialization
          echo "Instance initialized at $(date)" >> /var/log/instance-init.log
          echo "Stack: ${AWS::StackName}" >> /var/log/instance-init.log
          echo "Region: ${AWS::Region}" >> /var/log/instance-init.log
          echo "Environment: ${EnvironmentTag}" >> /var/log/instance-init.log
          
          # Set hostname for easier identification
          hostnamectl set-hostname ${ProjectName}-webserver

# ==========================================
# Stack Outputs
# ==========================================
Outputs:
  VPCId:
    Description: VPC Identifier
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  VPCCidrBlock:
    Description: VPC CIDR Block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub '${AWS::StackName}-VPC-CIDR'

  PublicSubnetId:
    Description: Public Subnet Identifier
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet-ID'

  PublicSubnetCidrBlock:
    Description: Public Subnet CIDR Block
    Value: !Ref PublicSubnetCidr

  PublicSubnetAvailabilityZone:
    Description: Availability Zone of the Public Subnet
    Value: !GetAtt PublicSubnet.AvailabilityZone

  InternetGatewayId:
    Description: Internet Gateway Identifier
    Value: !Ref InternetGateway
    Export:
      Name: !Sub '${AWS::StackName}-IGW-ID'

  PublicRouteTableId:
    Description: Public Route Table Identifier
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-PublicRouteTable-ID'

  SecurityGroupId:
    Description: Web Server Security Group Identifier
    Value: !Ref WebServerSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroup-ID'

  SecurityGroupName:
    Description: Web Server Security Group Name
    Value: !Sub '${ProjectName}-${AWS::StackName}-WebServerSG'

  WebServerInstanceId:
    Description: EC2 Instance Identifier
    Value: !Ref WebServerInstance
    Export:
      Name: !Sub '${AWS::StackName}-Instance-ID'

  WebServerPublicIP:
    Description: Public IP address of the web server instance (Required Output)
    Value: !GetAtt WebServerInstance.PublicIp
    Export:
      Name: !Sub '${AWS::StackName}-Instance-PublicIP'

  WebServerPrivateIP:
    Description: Private IP address of the web server instance
    Value: !GetAtt WebServerInstance.PrivateIp

  WebServerPublicDNS:
    Description: Public DNS name of the web server instance
    Value: !GetAtt WebServerInstance.PublicDnsName

  WebServerAvailabilityZone:
    Description: Availability Zone where the instance is deployed
    Value: !GetAtt WebServerInstance.AvailabilityZone

  SSHConnectionCommand:
    Description: SSH command to connect to the instance
    Value: !Sub 'ssh -i ${KeyPairName}.pem ec2-user@${WebServerInstance.PublicIp}'

  HTTPEndpoint:
    Description: HTTP endpoint for the web server
    Value: !Sub 'http://${WebServerInstance.PublicIp}'

  StackName:
    Description: CloudFormation Stack Name
    Value: !Ref 'AWS::StackName'

  StackRegion:
    Description: AWS Region where stack is deployed
    Value: !Ref 'AWS::Region'

  DeploymentTimestamp:
    Description: Stack creation timestamp
    Value: !Ref 'AWS::StackId'

  EnvironmentType:
    Description: Environment type for this deployment
    Value: !Ref EnvironmentTag

  ProjectIdentifier:
    Description: Project name for this infrastructure
    Value: !Ref ProjectName
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Multi-stage CI/CD pipeline with cross-account deployment capabilities",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Suffix for resource naming to ensure uniqueness",
            "Default": "dev"
        },
        "SourceRepositoryName": {
            "Type": "String",
            "Description": "CodeCommit repository name for source code",
            "Default": "my-application"
        },
        "SourceBranchName": {
            "Type": "String",
            "Description": "Branch name to monitor for changes",
            "Default": "main"
        },
        "ArtifactRetentionDays": {
            "Type": "Number",
            "Description": "Number of days to retain pipeline artifacts",
            "Default": 30,
            "MinValue": 1,
            "MaxValue": 365
        }
    },
    "Resources": {
        "ArtifactEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for pipeline artifacts encryption ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CodePipeline to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codepipeline.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:Encrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CodeBuild to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:Encrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "ArtifactEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/pipeline-artifacts-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "ArtifactEncryptionKey"
                }
            }
        },
        "ArtifactBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "pipeline-artifacts-${EnvironmentSuffix}-${AWS::AccountId}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::GetAtt": [
                                        "ArtifactEncryptionKey",
                                        "Arn"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldArtifacts",
                            "Status": "Enabled",
                            "ExpirationInDays": {
                                "Ref": "ArtifactRetentionDays"
                            },
                            "NoncurrentVersionExpirationInDays": 7
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                }
            }
        },
        "ArtifactBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ArtifactBucket"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Sid": "DenyUnencryptedObjectUploads",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ArtifactBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "aws:kms"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CodePipelineServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "codepipeline-service-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codepipeline.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CodePipelineAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codecommit:GetBranch",
                                        "codecommit:GetCommit",
                                        "codecommit:UploadArchive",
                                        "codecommit:GetUploadArchiveStatus",
                                        "codecommit:CancelUploadArchive"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${SourceRepositoryName}"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:PutObject",
                                        "s3:GetBucketLocation",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ArtifactBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ArtifactBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:Encrypt",
                                        "kms:ReEncrypt*",
                                        "kms:GenerateDataKey*",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ArtifactEncryptionKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codebuild:BatchGetBuilds",
                                        "codebuild:StartBuild"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "UnitTestProject",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "SecurityScanProject",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "CodeBuildServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "codebuild-service-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CodeBuildAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion",
                                        "s3:PutObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ArtifactBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ArtifactBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:Encrypt",
                                        "kms:ReEncrypt*",
                                        "kms:GenerateDataKey*",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ArtifactEncryptionKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codecommit:GitPull"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${SourceRepositoryName}"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "UnitTestProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Name": {
                    "Fn::Sub": "unit-test-project-${EnvironmentSuffix}"
                },
                "Description": "CodeBuild project for running unit tests",
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "CodeBuildServiceRole",
                        "Arn"
                    ]
                },
                "Artifacts": {
                    "Type": "CODEPIPELINE"
                },
                "Environment": {
                    "Type": "LINUX_CONTAINER",
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "aws/codebuild/standard:7.0",
                    "EnvironmentVariables": [
                        {
                            "Name": "ENVIRONMENT",
                            "Value": {
                                "Ref": "EnvironmentSuffix"
                            }
                        }
                    ]
                },
                "Source": {
                    "Type": "CODEPIPELINE",
                    "BuildSpec": "version: 0.2\nphases:\n  install:\n    runtime-versions:\n      nodejs: 18\n    commands:\n      - echo \"Installing dependencies...\"\n      - npm install\n  build:\n    commands:\n      - echo \"Running unit tests...\"\n      - npm test\n  post_build:\n    commands:\n      - echo \"Unit tests completed\"\nartifacts:\n  files:\n    - '**/*'\n"
                },
                "EncryptionKey": {
                    "Fn::GetAtt": [
                        "ArtifactEncryptionKey",
                        "Arn"
                    ]
                },
                "LogsConfig": {
                    "CloudWatchLogs": {
                        "Status": "ENABLED",
                        "GroupName": {
                            "Fn::Sub": "/aws/codebuild/unit-test-${EnvironmentSuffix}"
                        }
                    }
                }
            }
        },
        "SecurityScanProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Name": {
                    "Fn::Sub": "security-scan-project-${EnvironmentSuffix}"
                },
                "Description": "CodeBuild project for security scanning",
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "CodeBuildServiceRole",
                        "Arn"
                    ]
                },
                "Artifacts": {
                    "Type": "CODEPIPELINE"
                },
                "Environment": {
                    "Type": "LINUX_CONTAINER",
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "aws/codebuild/standard:7.0",
                    "EnvironmentVariables": [
                        {
                            "Name": "ENVIRONMENT",
                            "Value": {
                                "Ref": "EnvironmentSuffix"
                            }
                        }
                    ]
                },
                "Source": {
                    "Type": "CODEPIPELINE",
                    "BuildSpec": "version: 0.2\nphases:\n  install:\n    runtime-versions:\n      nodejs: 18\n    commands:\n      - echo \"Installing security scanning tools...\"\n      - npm install -g npm-audit-resolver snyk\n  build:\n    commands:\n      - echo \"Running security scans...\"\n      - npm audit --audit-level=moderate || true\n      - echo \"Security scan completed\"\n  post_build:\n    commands:\n      - echo \"Security analysis finished\"\nartifacts:\n  files:\n    - '**/*'\n"
                },
                "EncryptionKey": {
                    "Fn::GetAtt": [
                        "ArtifactEncryptionKey",
                        "Arn"
                    ]
                },
                "LogsConfig": {
                    "CloudWatchLogs": {
                        "Status": "ENABLED",
                        "GroupName": {
                            "Fn::Sub": "/aws/codebuild/security-scan-${EnvironmentSuffix}"
                        }
                    }
                }
            }
        },
        "PipelineNotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "pipeline-notifications-${EnvironmentSuffix}"
                },
                "DisplayName": "CI/CD Pipeline Notifications",
                "KmsMasterKeyId": {
                    "Ref": "ArtifactEncryptionKey"
                }
            }
        },
        "PipelineStateChangeRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "pipeline-state-change-${EnvironmentSuffix}"
                },
                "Description": "Capture all pipeline state changes",
                "EventPattern": {
                    "source": [
                        "aws.codepipeline"
                    ],
                    "detail-type": [
                        "CodePipeline Pipeline Execution State Change"
                    ],
                    "detail": {
                        "pipeline": [
                            {
                                "Ref": "CodePipeline"
                            }
                        ]
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Ref": "PipelineNotificationTopic"
                        },
                        "Id": "PipelineNotificationTarget"
                    }
                ]
            }
        },
        "PipelineFailureRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "pipeline-failure-${EnvironmentSuffix}"
                },
                "Description": "Capture pipeline failures",
                "EventPattern": {
                    "source": [
                        "aws.codepipeline"
                    ],
                    "detail-type": [
                        "CodePipeline Stage Execution State Change"
                    ],
                    "detail": {
                        "state": [
                            "FAILED"
                        ],
                        "pipeline": [
                            {
                                "Ref": "CodePipeline"
                            }
                        ]
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Ref": "PipelineNotificationTopic"
                        },
                        "Id": "PipelineFailureTarget"
                    }
                ]
            }
        },
        "PipelineNotificationTopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "Topics": [
                    {
                        "Ref": "PipelineNotificationTopic"
                    }
                ],
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "events.amazonaws.com"
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "PipelineNotificationTopic"
                            }
                        }
                    ]
                }
            }
        },
        "EventBridgePipelineRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "eventbridge-pipeline-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "events.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "StartPipelineExecution",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "codepipeline:StartPipelineExecution"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "PipelineTriggerRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "pipeline-trigger-${EnvironmentSuffix}"
                },
                "Description": "Trigger pipeline on CodeCommit changes",
                "EventPattern": {
                    "source": [
                        "aws.codecommit"
                    ],
                    "detail-type": [
                        "CodeCommit Repository State Change"
                    ],
                    "detail": {
                        "event": [
                            "referenceCreated",
                            "referenceUpdated"
                        ],
                        "referenceType": [
                            "branch"
                        ],
                        "referenceName": [
                            {
                                "Ref": "SourceBranchName"
                            }
                        ]
                    },
                    "resources": [
                        {
                            "Fn::Sub": "arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${SourceRepositoryName}"
                        }
                    ]
                },
                "State": "DISABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Ref": "PipelineNotificationTopic"
                        },
                        "Id": "PipelineNotificationTarget"
                    }
                ]
            }
        },
        "CodePipeline": {
            "Type": "AWS::CodePipeline::Pipeline",
            "Properties": {
                "Name": {
                    "Fn::Sub": "cicd-pipeline-${EnvironmentSuffix}"
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "CodePipelineServiceRole",
                        "Arn"
                    ]
                },
                "ArtifactStore": {
                    "Type": "S3",
                    "Location": {
                        "Ref": "ArtifactBucket"
                    },
                    "EncryptionKey": {
                        "Id": {
                            "Fn::GetAtt": [
                                "ArtifactEncryptionKey",
                                "Arn"
                            ]
                        },
                        "Type": "KMS"
                    }
                },
                "Stages": [
                    {
                        "Name": "Source",
                        "Actions": [
                            {
                                "Name": "SourceAction",
                                "ActionTypeId": {
                                    "Category": "Source",
                                    "Owner": "AWS",
                                    "Provider": "CodeCommit",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "RepositoryName": {
                                        "Ref": "SourceRepositoryName"
                                    },
                                    "BranchName": {
                                        "Ref": "SourceBranchName"
                                    },
                                    "PollForSourceChanges": false
                                },
                                "OutputArtifacts": [
                                    {
                                        "Name": "SourceOutput"
                                    }
                                ],
                                "RunOrder": 1
                            }
                        ]
                    },
                    {
                        "Name": "Build",
                        "Actions": [
                            {
                                "Name": "UnitTest",
                                "ActionTypeId": {
                                    "Category": "Build",
                                    "Owner": "AWS",
                                    "Provider": "CodeBuild",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ProjectName": {
                                        "Ref": "UnitTestProject"
                                    }
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "SourceOutput"
                                    }
                                ],
                                "OutputArtifacts": [
                                    {
                                        "Name": "UnitTestOutput"
                                    }
                                ],
                                "RunOrder": 1
                            }
                        ]
                    },
                    {
                        "Name": "Test",
                        "Actions": [
                            {
                                "Name": "SecurityScan",
                                "ActionTypeId": {
                                    "Category": "Build",
                                    "Owner": "AWS",
                                    "Provider": "CodeBuild",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ProjectName": {
                                        "Ref": "SecurityScanProject"
                                    }
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "UnitTestOutput"
                                    }
                                ],
                                "OutputArtifacts": [
                                    {
                                        "Name": "SecurityScanOutput"
                                    }
                                ],
                                "RunOrder": 1
                            }
                        ]
                    }
                ]
            }
        }
    },
    "Outputs": {
        "PipelineName": {
            "Description": "Name of the CodePipeline",
            "Value": {
                "Ref": "CodePipeline"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PipelineName"
                }
            }
        },
        "ArtifactBucketName": {
            "Description": "S3 bucket for pipeline artifacts",
            "Value": {
                "Ref": "ArtifactBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ArtifactBucket"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS key for artifact encryption",
            "Value": {
                "Fn::GetAtt": [
                    "ArtifactEncryptionKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKey"
                }
            }
        },
        "NotificationTopicArn": {
            "Description": "SNS topic for pipeline notifications",
            "Value": {
                "Ref": "PipelineNotificationTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NotificationTopic"
                }
            }
        },
        "CodePipelineUrl": {
            "Description": "URL to the CodePipeline console",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/codesuite/codepipeline/pipelines/${CodePipeline}/view"
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: 'production-ready infrastructure baseline with VPC, NLB, EC2, and S3'

# Guard: only allow deploys in us-east-1
Conditions:
  IsUsEast1: !Equals [ !Ref "AWS::Region", "us-east-1" ]

Resources:
  # ---------------- VPC & Subnets ----------------
  VPC:
    Type: AWS::EC2::VPC
    Condition: IsUsEast1
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{ Key: Environment, Value: Production }]

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags: [{ Key: Environment, Value: Production }]

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags: [{ Key: Environment, Value: Production }]

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      Tags: [{ Key: Environment, Value: Production }]

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      Tags: [{ Key: Environment, Value: Production }]

  # ---------------- Internet/NAT & Routes ----------------
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: IsUsEast1
    Properties:
      Tags: [{ Key: Environment, Value: Production }]

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      Tags: [{ Key: Environment, Value: Production }]

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: IsUsEast1
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: IsUsEast1
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: IsUsEast1
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      Tags: [{ Key: Environment, Value: Production }]

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: IsUsEast1
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: IsUsEast1
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  # ---------------- VPC Flow Logs -> CloudWatch Logs ----------------
  FlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: IsUsEast1
    Properties:
      LogGroupName: FlowLogsGroup
      # Use service-managed encryption (no KmsKeyId to avoid E3031)
      Tags: [{ Key: Environment, Value: Production }]

  FlowLogsRole:
    Type: AWS::IAM::Role
    Condition: IsUsEast1
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Service: vpc-flow-logs.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FlowLogsPublishPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Resource: "*"
      Tags: [{ Key: Environment, Value: Production }]

  VPCFlowLog:
    Type: AWS::EC2::FlowLog
    Condition: IsUsEast1
    Properties:
      ResourceId: !Ref VPC
      ResourceType: VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref FlowLogsLogGroup
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      Tags: [{ Key: Environment, Value: Production }]

  # ---------------- Security Groups ----------------
  PublicInstanceSG:
    Type: AWS::EC2::SecurityGroup
    Condition: IsUsEast1
    Properties:
      GroupDescription: Allow SSH from 203.0.113.10/32
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 22, ToPort: 22, CidrIp: 203.0.113.10/32 }
      SecurityGroupEgress:
        - { IpProtocol: -1, CidrIp: 0.0.0.0/0 }
      Tags: [{ Key: Environment, Value: Production }]

  PrivateInstanceSG:
    Type: AWS::EC2::SecurityGroup
    Condition: IsUsEast1
    Properties:
      GroupDescription: Allow SSH from 203.0.113.10/32; allow HTTP for NLB traffic
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 22, ToPort: 22, CidrIp: 203.0.113.10/32 }
        # NLB preserves client source IP; instances are in private subnets.
        # Allow app port 80 for load-balanced traffic.
        - { IpProtocol: tcp, FromPort: 80, ToPort: 80, CidrIp: 0.0.0.0/0 }
      SecurityGroupEgress:
        - { IpProtocol: -1, CidrIp: 0.0.0.0/0 }
      Tags: [{ Key: Environment, Value: Production }]

  # ---------------- IAM for public EC2 (S3/EC2/CloudWatch) ----------------
  InstanceRole:
    Type: AWS::IAM::Role
    Condition: IsUsEast1
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InstancePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: [ "ec2:Describe*" ]
                Resource: "*"
              - Effect: Allow
                Action: [ "s3:ListBucket" ]
                Resource: !Sub "arn:${AWS::Partition}:s3:::${S3Bucket}"
              - Effect: Allow
                Action: [ "s3:GetObject", "s3:PutObject", "s3:DeleteObject" ]
                Resource: !Sub "arn:${AWS::Partition}:s3:::${S3Bucket}/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudwatch:PutMetricData
                Resource: "*"
      Tags: [{ Key: Environment, Value: Production }]

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: IsUsEast1
    Properties:
      Path: "/"
      Roles: [ !Ref InstanceRole ]

  # ---------------- EC2 Instances ----------------
  PublicInstance:
    Type: AWS::EC2::Instance
    Condition: IsUsEast1
    Properties:
      ImageId: "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
      InstanceType: t2.micro
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds: [ !Ref PublicInstanceSG ]
      IamInstanceProfile: !Ref InstanceProfile
      Tags: [{ Key: Environment, Value: Production }]

  PrivateInstance1:
    Type: AWS::EC2::Instance
    Condition: IsUsEast1
    Properties:
      ImageId: "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
      InstanceType: t2.micro
      SubnetId: !Ref PrivateSubnet1
      SecurityGroupIds: [ !Ref PrivateInstanceSG ]
      Tags: [{ Key: Environment, Value: Production }]

  PrivateInstance2:
    Type: AWS::EC2::Instance
    Condition: IsUsEast1
    Properties:
      ImageId: "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}"
      InstanceType: t2.micro
      SubnetId: !Ref PrivateSubnet2
      SecurityGroupIds: [ !Ref PrivateInstanceSG ]
      Tags: [{ Key: Environment, Value: Production }]

  # ---------------- NLB + Target Group + Listener ----------------
  NLB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Condition: IsUsEast1
    Properties:
      Type: network
      Scheme: internet-facing
      Subnets: [ !Ref PublicSubnet1, !Ref PublicSubnet2 ]
      Tags: [{ Key: Environment, Value: Production }]

  NLBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Condition: IsUsEast1
    Properties:
      VpcId: !Ref VPC
      Protocol: TCP
      Port: 80
      TargetType: instance
      Targets:
        - { Id: !Ref PrivateInstance1, Port: 80 }
        - { Id: !Ref PrivateInstance2, Port: 80 }
      Tags: [{ Key: Environment, Value: Production }]

  NLBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: IsUsEast1
    Properties:
      LoadBalancerArn: !Ref NLB
      Port: 80
      Protocol: TCP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref NLBTargetGroup

  # ---------------- S3 (SSE + public access block) ----------------
  S3Bucket:
    Type: AWS::S3::Bucket
    Condition: IsUsEast1
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      Tags: [{ Key: Environment, Value: Production }]

Outputs:
  VPCID:
    Condition: IsUsEast1
    Description: VPC ID
    Value: !Ref VPC

  SubnetIDs:
    Condition: IsUsEast1
    Description: Public and private subnet IDs
    Value: !Join [', ', [ !Ref PublicSubnet1, !Ref PublicSubnet2, !Ref PrivateSubnet1, !Ref PrivateSubnet2 ] ]

  NLBDNSName:
    Condition: IsUsEast1
    Description: NLB DNS name
    Value: !GetAtt NLB.DNSName

  TargetGroupARN:
    Condition: IsUsEast1
    Description: NLB Target Group ARN
    Value: !Ref NLBTargetGroup

  PublicInstanceIdPublicIp:
    Condition: IsUsEast1
    Description: Public EC2 instance ID and public IP
    Value: !Sub "Instance ID: ${PublicInstance}, Public IP: ${PublicInstance.PublicIp}"

  S3BucketName:
    Condition: IsUsEast1
    Description: S3 bucket name (SSE enabled)
    Value: !Ref S3Bucket

  FlowLogsLogGroupName:
    Condition: IsUsEast1
    Description: CloudWatch Log Group for VPC Flow Logs
    Value: !Ref FlowLogsLogGroup

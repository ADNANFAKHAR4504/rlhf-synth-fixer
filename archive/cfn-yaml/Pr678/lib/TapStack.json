{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "Production-ready serverless application with API Gateway, Lambda, and DynamoDB",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "prod",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ],
            "Description": "Environment name for resource tagging"
        },
        "ApplicationName": {
            "Type": "String",
            "Default": "ServerlessApp",
            "Description": "Application name for resource naming"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource isolation"
        }
    },
    "Globals": {
        "Function": {
            "Timeout": 30,
            "MemorySize": 256,
            "Runtime": "python3.9",
            "Environment": {
                "Variables": {
                    "DYNAMODB_TABLE": {
                        "Ref": "AppDynamoTable"
                    },
                    "LOG_LEVEL": "INFO"
                }
            },
            "Tags": {
                "Environment": {
                    "Ref": "Environment"
                },
                "Application": {
                    "Ref": "ApplicationName"
                }
            }
        }
    },
    "Resources": {
        "AppDynamoTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "${ApplicationName}-${EnvironmentSuffix}-data"
                },
                "BillingMode": "PAY_PER_REQUEST",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    }
                ],
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": false
                },
                "SSESpecification": {
                    "SSEEnabled": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "ApplicationName"
                        }
                    }
                ]
            }
        },
        "AppLambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${ApplicationName}-${EnvironmentSuffix}-lambda-execution-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "DynamoDBAccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:GetItem",
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:DeleteItem"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "AppDynamoTable",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "ApplicationName"
                        }
                    }
                ]
            }
        },
        "AppLambdaFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ApplicationName}-${EnvironmentSuffix}-handler"
                },
                "InlineCode": "import json\nimport boto3\nimport os\nimport logging\nfrom botocore.exceptions import ClientError\n\nlogger = logging.getLogger()\nlogger.setLevel(os.environ.get('LOG_LEVEL', 'INFO'))\n\ndynamodb = boto3.resource('dynamodb')\ntable = dynamodb.Table(os.environ['DYNAMODB_TABLE'])\n\ndef lambda_handler(event, context):\n    try:\n        http_method = event.get('requestContext', {}).get('http', {}).get('method')\n        path = event.get('rawPath', '/')\n        \n        logger.info(f\"Processing {http_method} request for path: {path}\")\n        \n        if http_method == 'GET':\n            return handle_get(event)\n        elif http_method == 'POST':\n            return handle_post(event)\n        elif http_method == 'PUT':\n            return handle_put(event)\n        elif http_method == 'DELETE':\n            return handle_delete(event)\n        else:\n            return create_response(405, {'error': 'Method not allowed'})\n            \n    except Exception as e:\n        logger.error(f\"Error processing request: {str(e)}\")\n        return create_response(500, {'error': 'Internal server error'})\n\ndef handle_get(event):\n    path_params = event.get('pathParameters', {})\n    \n    if path_params and 'proxy' in path_params:\n        item_id = path_params['proxy']\n        try:\n            response = table.get_item(Key={'id': item_id})\n            if 'Item' in response:\n                return create_response(200, response['Item'])\n            else:\n                return create_response(404, {'error': 'Item not found'})\n        except ClientError as e:\n            logger.error(f\"DynamoDB error: {e}\")\n            return create_response(500, {'error': 'Database error'})\n    else:\n        try:\n            response = table.scan(Limit=50)\n            return create_response(200, {'items': response.get('Items', [])})\n        except ClientError as e:\n            logger.error(f\"DynamoDB error: {e}\")\n            return create_response(500, {'error': 'Database error'})\n\ndef handle_post(event):\n    try:\n        body = json.loads(event.get('body', '{}'))\n        if 'id' not in body:\n            return create_response(400, {'error': 'Missing required field: id'})\n        \n        table.put_item(Item=body)\n        return create_response(201, {'message': 'Item created successfully', 'item': body})\n        \n    except json.JSONDecodeError:\n        return create_response(400, {'error': 'Invalid JSON in request body'})\n    except ClientError as e:\n        logger.error(f\"DynamoDB error: {e}\")\n        return create_response(500, {'error': 'Database error'})\n\ndef handle_put(event):\n    path_params = event.get('pathParameters', {})\n    \n    if not path_params or 'proxy' not in path_params:\n        return create_response(400, {'error': 'Missing item ID in path'})\n    \n    item_id = path_params['proxy']\n    \n    try:\n        body = json.loads(event.get('body', '{}'))\n        body['id'] = item_id\n        \n        table.put_item(Item=body)\n        return create_response(200, {'message': 'Item updated successfully', 'item': body})\n        \n    except json.JSONDecodeError:\n        return create_response(400, {'error': 'Invalid JSON in request body'})\n    except ClientError as e:\n        logger.error(f\"DynamoDB error: {e}\")\n        return create_response(500, {'error': 'Database error'})\n\ndef handle_delete(event):\n    path_params = event.get('pathParameters', {})\n    \n    if not path_params or 'proxy' not in path_params:\n        return create_response(400, {'error': 'Missing item ID in path'})\n    \n    item_id = path_params['proxy']\n    \n    try:\n        table.delete_item(Key={'id': item_id})\n        return create_response(200, {'message': f'Item {item_id} deleted successfully'})\n        \n    except ClientError as e:\n        logger.error(f\"DynamoDB error: {e}\")\n        return create_response(500, {'error': 'Database error'})\n\ndef create_response(status_code, body):\n    return {\n        'statusCode': status_code,\n        'headers': {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n            'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key'\n        },\n        'body': json.dumps(body)\n    }\n",
                "Handler": "app.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "AppLambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Events": {
                    "ApiEvent": {
                        "Type": "HttpApi",
                        "Properties": {
                            "ApiId": {
                                "Ref": "AppHttpApi"
                            },
                            "Path": "/{proxy+}",
                            "Method": "ANY"
                        }
                    }
                },
                "Tags": {
                    "Environment": {
                        "Ref": "Environment"
                    },
                    "Application": {
                        "Ref": "ApplicationName"
                    }
                }
            }
        },
        "AppHttpApi": {
            "Type": "AWS::Serverless::HttpApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ApplicationName}-${EnvironmentSuffix}-api"
                },
                "Description": "HTTP API for serverless application",
                "CorsConfiguration": {
                    "AllowCredentials": false,
                    "AllowHeaders": [
                        "Content-Type",
                        "X-Amz-Date",
                        "Authorization",
                        "X-Api-Key"
                    ],
                    "AllowMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "OPTIONS"
                    ],
                    "AllowOrigins": [
                        "*"
                    ],
                    "MaxAge": 600
                },
                "Tags": {
                    "Environment": {
                        "Ref": "Environment"
                    },
                    "Application": {
                        "Ref": "ApplicationName"
                    }
                }
            }
        },
        "ApiGatewayLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "AppLambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "${AppHttpApi}/*/ANY/{proxy+}"
                }
            }
        }
    },
    "Outputs": {
        "ApiEndpoint": {
            "Description": "HTTP API Gateway endpoint URL",
            "Value": {
                "Fn::Sub": "https://${AppHttpApi}.execute-api.${AWS::Region}.amazonaws.com"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiEndpoint"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "AppLambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaArn"
                }
            }
        },
        "DynamoTableName": {
            "Description": "DynamoDB table name",
            "Value": {
                "Ref": "AppDynamoTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoTableName"
                }
            }
        },
        "DynamoTableArn": {
            "Description": "DynamoDB table ARN",
            "Value": {
                "Fn::GetAtt": [
                    "AppDynamoTable",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoTableArn"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure, compliance-oriented stack: VPC (2 public + 2 private), S3 (versioning + SSE-KMS), CloudTrail (S3 + CW Logs), optional AWS Config + Security Hub, KMS key, SSM Parameter (String), Lambda (least-priv), VPC Flow Logs, and CW Alarm. No named IAM (no RoleName/UserName).\n",
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Default": "tap",
            "AllowedPattern": "^[a-z0-9-]+$"
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "AllowedPattern": "^[a-z0-9-]+$"
        },
        "CostCenter": {
            "Type": "String",
            "Default": "cc-0000"
        },
        "Owner": {
            "Type": "String",
            "Default": "platform-team"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16"
        },
        "PublicSubnetCidrs": {
            "Type": "CommaDelimitedList",
            "Default": "10.0.0.0/24,10.0.1.0/24"
        },
        "PrivateSubnetCidrs": {
            "Type": "CommaDelimitedList",
            "Default": "10.0.100.0/24,10.0.101.0/24"
        },
        "AllowedIngressCidr": {
            "Type": "String",
            "Default": "0.0.0.0/0"
        },
        "DbPassword": {
            "Type": "String",
            "NoEcho": true,
            "Default": "Tempp@55w0rd!"
        },
        "EnableSecurityHub": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false"
        },
        "EnableAWSConfig": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false"
        },
        "EnableNatGateway": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false",
            "Description": "Enable NAT Gateway for private subnet outbound access"
        },
        "SsmParamName": {
            "Type": "String",
            "Default": "",
            "AllowedPattern": "^$|^((?!aws|ssm)[\\w\\.\\-]+|\\/(?!aws|ssm)[\\w\\.\\-]+(\\/[\\w\\.\\-]+)*)$",
            "Description": "Optional explicit SSM parameter name. Leave empty to auto-generate '/<ProjectName>/<EnvironmentSuffix>/DB_PASSWORD'."
        }
    },
    "Conditions": {
        "CreateSecurityHub": {
            "Fn::Equals": [
                {
                    "Ref": "EnableSecurityHub"
                },
                "true"
            ]
        },
        "CreateAWSConfig": {
            "Fn::Equals": [
                {
                    "Ref": "EnableAWSConfig"
                },
                "true"
            ]
        },
        "CreateNatGateway": {
            "Fn::Equals": [
                {
                    "Ref": "EnableNatGateway"
                },
                "true"
            ]
        },
        "HasCustomSsmName": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SsmParamName"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "AppKmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "kms-${ProjectName}-${EnvironmentSuffix} application key"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableIAMUserPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "kms-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    }
                ]
            }
        },
        "AppKmsAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/kms-${ProjectName}-${EnvironmentSuffix}-app"
                },
                "TargetKeyId": {
                    "Ref": "AppKmsKey"
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "igw-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "VPCGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Ref": "PublicSubnetCidrs"
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-public-a-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Ref": "PublicSubnetCidrs"
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-public-b-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Ref": "PrivateSubnetCidrs"
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-a-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Ref": "PrivateSubnetCidrs"
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-b-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-public-${ProjectName}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "VPCGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnetBRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetB"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "NatEip": {
            "Condition": "CreateNatGateway",
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "eip-nat-${ProjectName}-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "NatGateway": {
            "Condition": "CreateNatGateway",
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatEip",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-${ProjectName}-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTableA": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-private-a-${ProjectName}-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTableB": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rt-private-b-${ProjectName}-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateRouteA": {
            "Condition": "CreateNatGateway",
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTableA"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateRouteB": {
            "Condition": "CreateNatGateway",
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTableB"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateSubnetARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnetA"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTableA"
                }
            }
        },
        "PrivateSubnetBRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnetB"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTableB"
                }
            }
        },
        "WebSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "sg-${ProjectName}-${EnvironmentSuffix} web ingress"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Ref": "AllowedIngressCidr"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-${ProjectName}-${EnvironmentSuffix}-web"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "AppBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-app"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "AppKmsKey"
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-app"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "AppBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "AppBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "AppBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${AppBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-cloudtrail"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-cloudtrail"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "CloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "CloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudTrailBucketAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "CloudTrailBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AllowCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${CloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "DenyDeleteCloudTrailLogs",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "s3:DeleteObject",
                                "s3:DeleteObjectVersion"
                            ],
                            "Resource": {
                                "Fn::Sub": "${CloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
                            }
                        },
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "CloudTrailBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${CloudTrailBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-config"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "s3-${ProjectName}-${EnvironmentSuffix}-config"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ConfigBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ConfigBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ConfigBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ConfigBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CloudTrailLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/cloudtrail/${ProjectName}/${EnvironmentSuffix}"
                },
                "RetentionInDays": 90
            }
        },
        "CloudTrailLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "cloudtrail-cwlogs-${ProjectName}-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "CloudTrailLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "Trail": {
            "Type": "AWS::CloudTrail::Trail",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "cloudtrail-${ProjectName}-${EnvironmentSuffix}"
                },
                "S3BucketName": {
                    "Ref": "CloudTrailBucket"
                },
                "IsLogging": true,
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "CloudTrailLogGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "CloudTrailLogsRole",
                        "Arn"
                    ]
                },
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "VpcFlowLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/vpc/flowlogs/${ProjectName}/${EnvironmentSuffix}"
                },
                "RetentionInDays": 90
            }
        },
        "VpcFlowLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "vpc-flow-logs-${ProjectName}-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "VpcFlowLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VpcFlowLogs": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "ResourceId": {
                    "Ref": "VPC"
                },
                "ResourceType": "VPC",
                "TrafficType": "ALL",
                "LogDestinationType": "cloud-watch-logs",
                "LogGroupName": {
                    "Ref": "VpcFlowLogGroup"
                },
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "VpcFlowLogsRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "flowlog-${ProjectName}-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ConfigRole": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSConfigRole"
                ]
            }
        },
        "ConfigRecorder": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::ConfigurationRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "configrecorder-${ProjectName}-${EnvironmentSuffix}"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "ConfigRole",
                        "Arn"
                    ]
                },
                "RecordingGroup": {
                    "AllSupported": true,
                    "IncludeGlobalResourceTypes": true
                }
            }
        },
        "ConfigDeliveryChannel": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::DeliveryChannel",
            "Properties": {
                "Name": {
                    "Fn::Sub": "configchannel-${ProjectName}-${EnvironmentSuffix}"
                },
                "S3BucketName": {
                    "Ref": "ConfigBucket"
                },
                "ConfigSnapshotDeliveryProperties": {}
            }
        },
        "ConfigRuleCloudTrailEnabled": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "cfg-cloudtrail-enabled-${ProjectName}-${EnvironmentSuffix}"
                },
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "CLOUD_TRAIL_ENABLED"
                }
            }
        },
        "ConfigRuleS3SSE": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "cfg-s3-sse-${ProjectName}-${EnvironmentSuffix}"
                },
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
                }
            }
        },
        "ConfigRuleIamNoAdminStatements": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "cfg-iam-no-admin-${ProjectName}-${EnvironmentSuffix}"
                },
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "IAM_POLICY_NO_STATEMENTS_WITH_ADMIN_ACCESS"
                }
            }
        },
        "ConfigRuleDefaultSgClosed": {
            "Condition": "CreateAWSConfig",
            "Type": "AWS::Config::ConfigRule",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "cfg-default-sg-closed-${ProjectName}-${EnvironmentSuffix}"
                },
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "VPC_DEFAULT_SECURITY_GROUP_CLOSED"
                }
            }
        },
        "SecurityHubHub": {
            "Condition": "CreateSecurityHub",
            "Type": "AWS::SecurityHub::Hub",
            "Properties": {
                "Tags": {
                    "Name": {
                        "Fn::Sub": "securityhub-${ProjectName}-${EnvironmentSuffix}"
                    },
                    "Project": {
                        "Ref": "ProjectName"
                    },
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    }
                }
            }
        },
        "SecurityHubFSBP": {
            "Condition": "CreateSecurityHub",
            "Type": "AWS::SecurityHub::Standard",
            "Properties": {
                "StandardsArn": {
                    "Fn::Sub": "arn:${AWS::Partition}:securityhub:${AWS::Region}::standards/aws-foundational-security-best-practices/v/1.0.0"
                }
            }
        },
        "AppDbPasswordParam": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::If": [
                        "HasCustomSsmName",
                        {
                            "Ref": "SsmParamName"
                        },
                        {
                            "Fn::Sub": "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"
                        }
                    ]
                },
                "Type": "String",
                "Tier": "Standard",
                "Value": {
                    "Ref": "DbPassword"
                },
                "Description": {
                    "Fn::Sub": "DB password for ${ProjectName}-${EnvironmentSuffix} (String)"
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "lambda-logs-${ProjectName}-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*:*"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": {
                            "Fn::Sub": "lambda-ssm-${ProjectName}-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "ReadSpecificParam",
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:GetParameterHistory"
                                    ],
                                    "Resource": {
                                        "Fn::If": [
                                            "HasCustomSsmName",
                                            {
                                                "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter${SsmParamName}"
                                            },
                                            {
                                                "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "AppLambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/func-${ProjectName}-${EnvironmentSuffix}"
                },
                "RetentionInDays": 90
            }
        },
        "AppLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "func-${ProjectName}-${EnvironmentSuffix}"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Timeout": 10,
                "MemorySize": 256,
                "Code": {
                    "ZipFile": "import os, json, boto3\ndef handler(event, context):\n    ssm = boto3.client(\"ssm\")\n    name = os.environ.get('SSM_PARAM_NAME')\n    p = ssm.get_parameter(Name=name, WithDecryption=False)\n    return {\"statusCode\": 200, \"body\": json.dumps({\"parameter\": name, \"len\": len(p['Parameter']['Value'])})}\n"
                },
                "Environment": {
                    "Variables": {
                        "SSM_PARAM_NAME": {
                            "Fn::If": [
                                "HasCustomSsmName",
                                {
                                    "Ref": "SsmParamName"
                                },
                                {
                                    "Fn::Sub": "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"
                                }
                            ]
                        }
                    }
                }
            }
        },
        "UnauthorizedMetricFilter": {
            "Type": "AWS::Logs::MetricFilter",
            "Properties": {
                "LogGroupName": {
                    "Ref": "CloudTrailLogGroup"
                },
                "FilterPattern": "{ ($.errorCode = \"UnauthorizedOperation\") || ($.errorCode = \"AccessDenied*\") }",
                "MetricTransformations": [
                    {
                        "MetricNamespace": {
                            "Fn::Sub": "Security/${ProjectName}/${EnvironmentSuffix}"
                        },
                        "MetricName": "UnauthorizedAccessCount",
                        "MetricValue": "1"
                    }
                ]
            }
        },
        "UnauthorizedAccessAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "alarm-unauth-${ProjectName}-${EnvironmentSuffix}"
                },
                "Namespace": {
                    "Fn::Sub": "Security/${ProjectName}/${EnvironmentSuffix}"
                },
                "MetricName": "UnauthorizedAccessCount",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmDescription": "Triggers on any unauthorized access attempts found in CloudTrail",
                "ActionsEnabled": true
            }
        }
    },
    "Outputs": {
        "VpcId": {
            "Value": {
                "Ref": "VPC"
            }
        },
        "PublicSubnets": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PublicSubnetA"
                        },
                        {
                            "Ref": "PublicSubnetB"
                        }
                    ]
                ]
            }
        },
        "PrivateSubnets": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PrivateSubnetA"
                        },
                        {
                            "Ref": "PrivateSubnetB"
                        }
                    ]
                ]
            }
        },
        "AppBucketName": {
            "Value": {
                "Ref": "AppBucket"
            }
        },
        "CloudTrailBucketName": {
            "Value": {
                "Ref": "CloudTrailBucket"
            }
        },
        "KmsKeyArn": {
            "Value": {
                "Fn::GetAtt": [
                    "AppKmsKey",
                    "Arn"
                ]
            }
        },
        "CloudTrailArn": {
            "Value": {
                "Fn::Sub": "arn:${AWS::Partition}:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${Trail}"
            }
        },
        "SecurityHubStatus": {
            "Value": {
                "Fn::If": [
                    "CreateSecurityHub",
                    "Enabled",
                    "Skipped"
                ]
            }
        },
        "SsmParamDbPassword": {
            "Value": {
                "Fn::If": [
                    "HasCustomSsmName",
                    {
                        "Ref": "SsmParamName"
                    },
                    {
                        "Fn::Sub": "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"
                    }
                ]
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: Compliant CloudFormation template for a secure web environment with a new VPC and best practices applied

Parameters:
  BatchName:
    Type: String
    Description: Batch name for tagging
    Default: "1056"
  ProjectId:
    Type: String
    Description: Project ID for tagging
    Default: "166"
  ProjectName:
    Type: String
    Description: Project name for tagging
    Default: "IaC - AWS Nova Model Breaking"
  ProblemID:
    Type: String
    Description: Problem ID for tagging
    Default: "Cloud_Environment_Setup_CloudFormation_YAML_9kfhjsre9e3f"
  AllowedIPAddress:
    Type: String
    Description: IP address allowed for SSH access
    AllowedPattern: ^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/32$
    ConstraintDescription: Must be a valid CIDR IP address
    Default: 203.0.113.10/32
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux 2 AMI from SSM Parameter Store

Resources:
  # KMS Key for SSM Parameter Encryption
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting SSM parameters
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action:
              - kms:*
            Resource: '*'
      Tags:
        - Key: Name
          Value: SecureWebKMSKey
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  KMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/secure-web-config
      TargetKeyId: !Ref KMSKey

  # New VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: SecureWebVPC
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: SecureWebIGW
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: SecureWebSubnet
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # Route Table and Route
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: SecureWebPublicRT
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Security Group
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 instance with restricted SSH access
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIPAddress
      Tags:
        - Key: Name
          Value: SecureWebSG
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # IAM Role for Lambda function to create SecureString parameter
  SecureParameterLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SSMParameterPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                  - ssm:GetParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/secure-web/config'
              - Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Resource: !GetAtt KMSKey.Arn
      Tags:
        - Key: Name
          Value: SecureParameterLambdaRole
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # Lambda function to create SecureString parameter
  SecureParameterLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-secure-parameter-function'
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt SecureParameterLambdaRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import json
          import traceback
          
          def lambda_handler(event, context):
              print(f"Received event: {json.dumps(event)}")
              
              try:
                  ssm = boto3.client('ssm')
                  
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      print(f"Creating/Updating parameter: {event['ResourceProperties']['Name']}")
                      
                      response = ssm.put_parameter(
                          Name=event['ResourceProperties']['Name'],
                          Value=event['ResourceProperties']['Value'],
                          Type='SecureString',
                          KeyId=event['ResourceProperties']['KeyId'],
                          Description=event['ResourceProperties']['Description'],
                          Overwrite=True
                      )
                      
                      print(f"Parameter created successfully: {response}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {'ParameterName': event['ResourceProperties']['Name']})
                  
                  elif event['RequestType'] == 'Delete':
                      print(f"Deleting parameter: {event['ResourceProperties']['Name']}")
                      try:
                          ssm.delete_parameter(Name=event['ResourceProperties']['Name'])
                          print("Parameter deleted successfully")
                      except ssm.exceptions.ParameterNotFound:
                          print("Parameter not found, skipping deletion")
                      except Exception as delete_error:
                          print(f"Error deleting parameter: {str(delete_error)}")
                          # Don't fail the stack deletion for parameter cleanup issues
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
              except Exception as e:
                  error_message = f"Error: {str(e)}\nTraceback: {traceback.format_exc()}"
                  print(error_message)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': error_message})
      Tags:
        - Key: Name
          Value: SecureParameterFunction
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # Custom Resource to create SecureString parameter
  ConfigParameter:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt SecureParameterLambda.Arn
      Name: /secure-web/config
      Value: 'example-config-value'
      KeyId: !Ref KMSKey
      Description: 'Configuration value for EC2 instance (SecureString)'

  # IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/secure-web/config'
              - Effect: Allow
                Action:
                  - kms:Decrypt
                Resource: !GetAtt KMSKey.Arn
      Tags:
        - Key: Name
          Value: EC2S3ReadOnlyRole
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Elastic IP
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !Ref LatestAmiId
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          CONFIG_VALUE=$(aws ssm get-parameter --name "/secure-web/config" --region ${AWS::Region} --with-decryption --query Parameter.Value --output text 2>/dev/null)
          if [ $? -eq 0 ]; then
            echo "Configuration: $CONFIG_VALUE" >> /var/log/config.log
          else
            echo "Failed to retrieve SSM parameter" >> /var/log/config.log
          fi
      Tags:
        - Key: Name
          Value: SecureWebInstance
        - Key: batchName
          Value: !Ref BatchName
        - Key: projectId
          Value: !Ref ProjectId
        - Key: projectName
          Value: !Ref ProjectName
        - Key: ProblemID
          Value: !Ref ProblemID

  # EIP Association
  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref EC2Instance
      EIP: !Ref ElasticIP

Outputs:
  InstancePublicIP:
    Description: Public IP address of the EC2 instance
    Value: !Ref ElasticIP
  VPCId:
    Description: ID of the VPC used
    Value: !Ref VPC
  InstanceId:
    Description: ID of the EC2 instance
    Value: !Ref EC2Instance
  ParameterName:
    Description: Name of the secure parameter created
    Value: /secure-web/config
AWSTemplateFormatVersion: "2010-09-09"
Description: "Unified DynamoDB table deployment for multi-region with configurable capacity settings"

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: "Environment suffix for resource naming (e.g., dev, staging, prod)"

  ApplicationName:
    Type: String
    Default: "multi-region-app"
    Description: "Application name for resource naming and tagging"

  # Parameterized capacity settings for us-west-2
  ReadCapacityUnits:
    Type: Number
    Default: 10
    MinValue: 1
    MaxValue: 1000
    Description: "Read capacity units for the DynamoDB table (us-west-2 only)"

  WriteCapacityUnits:
    Type: Number
    Default: 10
    MinValue: 1
    MaxValue: 1000
    Description: "Write capacity units for the DynamoDB table (us-west-2 only)"

Conditions:
  IsWest1: !Equals [!Ref "AWS::Region", "us-west-1"]
  IsWest2: !Equals [!Ref "AWS::Region", "us-west-2"]
  EnableStreams: !Equals [!Ref "AWS::Region", "us-west-2"]
  HasCrossRegionReference: !Equals [!Ref "AWS::Region", "us-west-2"]

Resources:
  # DynamoDB Table with conditional capacity settings
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub
        - "${ApplicationName}-${EnvironmentSuffix}-${RegionSuffix}-table"
        - RegionSuffix: !If [IsWest1, "west1", "west2"]
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        # Fixed capacity for us-west-1, parameterized for us-west-2
        ReadCapacityUnits: !If [IsWest1, 5, !Ref ReadCapacityUnits]
        WriteCapacityUnits: !If [IsWest1, 5, !Ref WriteCapacityUnits]
      AttributeDefinitions:
        - AttributeName: "PrimaryKey"
          AttributeType: "S"
        - AttributeName: "SortKey"
          AttributeType: "S"
        - !If
          - IsWest2
          - AttributeName: "GSI1PK"
            AttributeType: "S"
          - !Ref "AWS::NoValue"
      KeySchema:
        - AttributeName: "PrimaryKey"
          KeyType: "HASH"
        - AttributeName: "SortKey"
          KeyType: "RANGE"
      # Global Secondary Index (only for us-west-2)
      GlobalSecondaryIndexes: !If
        - IsWest2
        - - IndexName: "GSI1"
            KeySchema:
              - AttributeName: "GSI1PK"
                KeyType: "HASH"
            Projection:
              ProjectionType: "ALL"
            ProvisionedThroughput:
              ReadCapacityUnits: !Ref ReadCapacityUnits
              WriteCapacityUnits: !Ref WriteCapacityUnits
        - !Ref "AWS::NoValue"
      # Dynamic tagging based on region
      Tags:
        - Key: "Environment"
          Value: !Ref EnvironmentSuffix
        - Key: "Region"
          Value: !Sub "${AWS::Region}"
        - Key: "Application"
          Value: !Ref ApplicationName
        - Key: "ManagedBy"
          Value: "CloudFormation"
        - Key: "StackName"
          Value: !Sub "${AWS::StackName}"
        - Key: "DeploymentRegion"
          Value: !Sub "${AWS::Region}"
        - !If
          - IsWest2
          - Key: "PrimaryRegionTable"
            Value: !ImportValue
              Fn::Sub: "TapStack${EnvironmentSuffix}-TableName"
          - !Ref "AWS::NoValue"
        - Key: "CapacityConfig"
          Value: !If
            - IsWest2
            - !Sub "${ReadCapacityUnits}-${WriteCapacityUnits}"
            - "5-5"

      # Enable point-in-time recovery
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      # Server-side encryption
      SSESpecification:
        SSEEnabled: true
      # Enable DynamoDB Streams (only for us-west-2)
      StreamSpecification: !If
        - EnableStreams
        - StreamViewType: "NEW_AND_OLD_IMAGES"
        - !Ref "AWS::NoValue"

  # IAM Role for DynamoDB access
  DynamoDBAccessRole:
    Type: AWS::IAM::Role
    Properties:
      # RoleName: !Sub "multi-region-app-${EnvironmentSuffix}-dynamodb-role-${AWS::Region}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !If
                    - IsWest2
                    - !Sub "${DynamoDBTable.Arn}/index/*"
                    - !Ref "AWS::NoValue"
                  - !If
                    - HasCrossRegionReference
                    - !ImportValue
                      Fn::Sub: "TapStack${EnvironmentSuffix}-TableArn"
                    - !Ref "AWS::NoValue"
      Tags:
        - Key: "Environment"
          Value: !Ref EnvironmentSuffix
        - Key: "Region"
          Value: !Sub "${AWS::Region}"
        - Key: "DeploymentRegion"
          Value: !Sub "${AWS::Region}"

  # Lambda function (only for us-west-2)
  CrossRegionLambdaFunction:
    Type: AWS::Lambda::Function
    Condition: IsWest2
    Properties:
      # FunctionName: !Sub "multi-region-app-${EnvironmentSuffix}-cross-region-function"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          # Local table reference
          LOCAL_TABLE_NAME: !Ref DynamoDBTable
          LOCAL_TABLE_ARN: !GetAtt DynamoDBTable.Arn
          # Cross-region table reference using Fn::ImportValue (conditional)
          REMOTE_TABLE_NAME: !If
            - IsWest2
            - !ImportValue
              Fn::Sub: "TapStack${EnvironmentSuffix}-TableName"
            - "no-remote-table"
          REMOTE_TABLE_ARN: !If
            - IsWest2
            - !ImportValue
              Fn::Sub: "TapStack${EnvironmentSuffix}-TableArn"
            - "no-remote-table-arn"
          # Combined configuration using Fn::Join
          TABLE_CONFIG: !Join
            - ","
            - - !Sub "local=${DynamoDBTable}"
              - !If
                - IsWest2
                - !ImportValue
                  Fn::Sub: "TapStack${EnvironmentSuffix}-TableName"
                - "no-remote-table"
      Code:
        ZipFile: |
          import json
          import os

          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({
                      'message': 'Cross-region DynamoDB access configured',
                      'local_table': os.environ.get('LOCAL_TABLE_NAME'),
                      'remote_table': os.environ.get('REMOTE_TABLE_NAME'),
                      'config': os.environ.get('TABLE_CONFIG')
                  })
              }
      Tags:
        - Key: "Environment"
          Value: !Ref EnvironmentSuffix
        - Key: "Application"
          Value: !Ref ApplicationName

  # IAM Role for Lambda execution (only for us-west-2)
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsWest2
    Properties:
      # RoleName: !Sub "multi-region-app-${EnvironmentSuffix}-lambda-role-${AWS::Region}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBCrossRegionAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub "${DynamoDBTable.Arn}/index/*"
                  # Cross-region table access (conditional)
                  - !If
                    - IsWest2
                    - !ImportValue
                      Fn::Sub: "TapStack${EnvironmentSuffix}-TableArn"
                    - !Ref "AWS::NoValue"

Outputs:
  # Export table name for cross-stack reference
  TableName:
    Description: "DynamoDB Table Name"
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub "${AWS::StackName}-TableName"

  # Export table ARN using Fn::GetAtt
  TableArn:
    Description: "DynamoDB Table ARN"
    Value: !GetAtt DynamoDBTable.Arn
    Export:
      Name: !Sub "${AWS::StackName}-TableArn"

  # Export table stream ARN (conditional)
  TableStreamArn:
    Description: "DynamoDB Table Stream ARN"
    Value: !GetAtt DynamoDBTable.StreamArn
    Export:
      Name: !Sub "${AWS::StackName}-TableStreamArn"
    Condition: EnableStreams

  # Export GSI ARN (only for us-west-2)
  GSIArn:
    Description: "Global Secondary Index ARN"
    Value: !Sub "${DynamoDBTable.Arn}/index/GSI1"
    Export:
      Name: !Sub "${AWS::StackName}-GSIArn"
    Condition: IsWest2

  # Export IAM Role ARN
  IAMRoleArn:
    Description: "IAM Role ARN for DynamoDB access"
    Value: !GetAtt DynamoDBAccessRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-IAMRoleArn"

  # Cross-region configuration summary (only for us-west-2)
  CrossRegionConfig:
    Description: "Cross-region table configuration"
    Value: !Sub "Cross-region setup for ${DynamoDBTable}"
    Export:
      Name: !Sub "${AWS::StackName}-CrossRegionConfig"
    Condition: HasCrossRegionReference

  # Lambda function ARN (only for us-west-2)
  LambdaFunctionArn:
    Description: "Lambda function ARN for cross-region operations"
    Value: !GetAtt CrossRegionLambdaFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-LambdaFunctionArn"
    Condition: IsWest2

  # Capacity configuration
  CapacityConfiguration:
    Description: "Current capacity configuration"
    Value: !If
      - IsWest1
      - "Read: 5, Write: 5 (Fixed)"
      - !Sub "Read: ${ReadCapacityUnits}, Write: ${WriteCapacityUnits} (Parameterized)"
    Export:
      Name: !Sub "${AWS::StackName}-CapacityConfiguration"

  # Combined table details
  TableDetails:
    Description: "Combined table information"
    Value: !Join
      - " | "
      - - !Sub "Table: ${DynamoDBTable}"
        - !Sub "Region: ${AWS::Region}"
        - !Sub "Environment: ${EnvironmentSuffix}"
        - !Sub "DeploymentRegion: ${AWS::Region}"
    Export:
      Name: !Sub "${AWS::StackName}-TableDetails"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Application Configuration"
        Parameters:
          - EnvironmentSuffix
          - ApplicationName
      - Label:
          default: "DynamoDB Capacity Settings (us-west-2 only)"
        Parameters:
          - ReadCapacityUnits
          - WriteCapacityUnits
    ParameterLabels:
      EnvironmentSuffix:
        default: "Environment Suffix"
      ApplicationName:
        default: "Application Name"
      ReadCapacityUnits:
        default: "Read Capacity Units"
      WriteCapacityUnits:
        default: "Write Capacity Units"
  cfn-lint:
    config:
      ignore_checks:
        - W6001
        - W1028 # Ignore unreachable Fn::If branch warnings - these are false positives
          # due to linter not understanding resource-level conditions vs intrinsic function conditions
      ignore_bad_template: false

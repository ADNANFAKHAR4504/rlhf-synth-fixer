{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Serverless infrastructure with Lambda function triggered by S3 events",
  "Parameters": {
    "S3BucketName": {
      "Type": "String",
      "Description": "Name of the existing S3 bucket",
      "AllowedPattern": "^[a-z0-9][a-z0-9.-]*[a-z0-9]$",
      "ConstraintDescription": "S3 bucket name must be valid"
    },
    "CloudWatchLogGroupName": {
      "Type": "String",
      "Description": "Name of the existing CloudWatch Log Group",
      "Default": "/aws/lambda/s3-file-processor",
      "AllowedPattern": "^[a-zA-Z0-9_/.-]+$",
      "ConstraintDescription": "CloudWatch Log Group name must be valid"
    }
  },
  "Resources": {
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${AWS::StackName}-lambda-execution-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "S3AndCloudWatchAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:s3:::${S3BucketName}/*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CloudWatchLogGroupName}:*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "S3FileProcessorFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "${AWS::StackName}-s3-file-processor"
        },
        "Runtime": "nodejs22.x",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Timeout": 30,
        "MemorySize": 128,
        "Environment": {
          "Variables": {
            "LOG_GROUP_NAME": {
              "Ref": "CloudWatchLogGroupName"
            }
          }
        },
        "Code": {
          "ZipFile": "const { S3Client, GetObjectCommand } = require('@aws-sdk/client-s3');\nconst { CloudWatchLogsClient, CreateLogStreamCommand, PutLogEventsCommand } = require('@aws-sdk/client-cloudwatch-logs');\n\nconst s3Client = new S3Client({});\nconst cloudWatchClient = new CloudWatchLogsClient({});\n\nexports.handler = async (event) => {\n  console.log('Event received:', JSON.stringify(event, null, 2));\n  \n  try {\n    for (const record of event.Records) {\n      const bucket = record.s3.bucket.name;\n      const key = decodeURIComponent(record.s3.object.key.replace(/\\+/g, ' '));\n      \n      console.log(`Processing file: ${key} from bucket: ${bucket}`);\n      \n      // Get the object from S3\n      const getObjectCommand = new GetObjectCommand({\n        Bucket: bucket,\n        Key: key\n      });\n      \n      const s3Object = await s3Client.send(getObjectCommand);\n      const fileContent = await s3Object.Body.transformToString('utf-8');\n      const fileSize = s3Object.ContentLength;\n      const lastModified = s3Object.LastModified;\n      \n      // Log details to CloudWatch\n      const logMessage = {\n        filename: key,\n        bucket: bucket,\n        size: fileSize,\n        lastModified: lastModified,\n        content: fileContent.substring(0, 1000), // Log first 1000 characters\n        eventTime: record.eventTime\n      };\n      \n      console.log('File details:', JSON.stringify(logMessage, null, 2));\n      \n      // Write to CloudWatch Log Group\n      const logGroupName = process.env.LOG_GROUP_NAME;\n      const logStreamName = `s3-processor-${Date.now()}`;\n      \n      try {\n        const createLogStreamCommand = new CreateLogStreamCommand({\n          logGroupName: logGroupName,\n          logStreamName: logStreamName\n        });\n        await cloudWatchClient.send(createLogStreamCommand);\n      } catch (error) {\n        // Log stream might already exist, continue\n        if (error.name !== 'ResourceAlreadyExistsException') {\n          throw error;\n        }\n      }\n      \n      const putLogEventsCommand = new PutLogEventsCommand({\n        logGroupName: logGroupName,\n        logStreamName: logStreamName,\n        logEvents: [\n          {\n            timestamp: Date.now(),\n            message: JSON.stringify(logMessage, null, 2)\n          }\n        ]\n      });\n      \n      await cloudWatchClient.send(putLogEventsCommand);\n      console.log(`Successfully processed and logged file: ${key}`);\n    }\n    \n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        message: 'Successfully processed S3 event',\n        processedRecords: event.Records.length\n      })\n    };\n    \n  } catch (error) {\n    console.error('Error processing S3 event:', error);\n    throw error;\n  }\n};"
        }
      }
    },
    "LambdaInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "S3FileProcessorFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "s3.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "arn:aws:s3:::${S3BucketName}"
        }
      }
    }
  },
  "Outputs": {
    "LambdaFunctionName": {
      "Description": "Name of the Lambda function",
      "Value": {
        "Ref": "S3FileProcessorFunction"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaFunctionName"
        }
      }
    },
    "LambdaFunctionArn": {
      "Description": "ARN of the Lambda function",
      "Value": {
        "Fn::GetAtt": [
          "S3FileProcessorFunction",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaFunctionArn"
        }
      }
    },
    "LambdaExecutionRoleArn": {
      "Description": "ARN of the Lambda execution role",
      "Value": {
        "Fn::GetAtt": [
          "LambdaExecutionRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaExecutionRoleArn"
        }
      }
    }
  }
}

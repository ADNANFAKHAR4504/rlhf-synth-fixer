We are PayFlow Solutions, a rapidly growing fintech startup that currently processes over 50,000 payment transactions daily. Our platform must maintain 99.99% uptime while ensuring PCI DSS Level 1 compliance, as we handle sensitive financial data for our merchant partners.

Our team needs you to architect a highly available web application infrastructure using AWS CloudFormation that can handle huge traffic spikes. The system must support our weekly release cycles through blue-green deployments with zero downtime, allowing us to gradually shift traffic from our current blue environment to the green environment based on performance metrics.

The infrastructure should be deployed across three availability zones to ensure resilience against zone failures. We need an Application Load Balancer as the entry point that distributes traffic intelligently with path-based routing, directing API requests to our API servers and webhook notifications to dedicated webhook processors. The ALB must implement weighted target groups for our blue-green deployment strategy, starting with 100% traffic to blue and 0% to green, with health checks performed on a custom deep health endpoint every 30 seconds. The target group deregistration delay must be exactly 30 seconds to ensure graceful connection draining.

For compute resources, implement Auto Scaling Groups using a mixed instances policy that leverages at least three instance types including t3.medium, t3.large, and m5.large to optimize costs while maintaining performance. These instances must be deployed from custom launch templates that enforce IMDSv2 only for enhanced security, as IMDSv1 is vulnerable to SSRF attacks. The Auto Scaling should respond dynamically to both ALB request count per target with a threshold of 1000 requests and CPU utilization at 70%, scaling out during peak hours and scaling in during our low-traffic periods.

Our database tier requires an RDS Aurora PostgreSQL cluster configured with one writer instance and two reader replicas for read scaling, using a custom parameter group that includes PostgreSQL-specific settings such as enabling pg_stat_statements for query performance monitoring. The database must maintain automated backups with a 7-day retention period and implement encryption at rest using AWS KMS for compliance requirements.

For DNS management, configure Route 53 with a hosted zone for our primary domain api.payflow.io, implementing weighted routing policies that initially direct 90% of traffic to our production environment and 10% to our canary environment for testing new releases. The Route 53 health checks must use HTTPS endpoints with a custom health check path, monitoring the service health every 30 seconds.

Security is paramount given our fintech nature, so implement security groups following the principle of least privilege where the ALB is only accessible on ports 80 and 443 from the internet, EC2 instances can only receive traffic from the ALB, and the RDS cluster is only accessible from the EC2 instances within the private subnets. Additionally, configure an S3 bucket to store ALB access logs with server-side encryption using AWS managed keys and implement a lifecycle policy for 90-day retention to manage storage costs while maintaining compliance audit requirements.

Our operations team requires comprehensive monitoring through CloudWatch with composite alarms that alert when error rates exceed 1% for two consecutive periods, when p99 latency exceeds 500ms, or when database connections reach 80% capacity. These alarms should integrate with SNS topics that forward to our PagerDuty incident management system for immediate response. We also need Systems Manager Parameter Store configured with a prefix structure for storing application configuration values that our applications can retrieve at runtime.

Create the entire infrastructure in a single YAML CloudFormation template named PayFlowInfraStack.yaml
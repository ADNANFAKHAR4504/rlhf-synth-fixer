# Payment Processing Database Infrastructure

You are an expert AWS Infrastructure Engineer. Create infrastructure using **AWS CloudFormation with YAML**.

## Task Requirements

FinTech Corp needs to deploy a secure payment processing database that meets PCI-DSS compliance requirements. The database will store sensitive payment transaction data and must implement proper encryption, secret rotation, and access controls.

## Required AWS Services

1. **Amazon RDS PostgreSQL**: Primary database for payment transaction data
   - Use Aurora Serverless v2 for faster provisioning and cost efficiency
   - Enable encryption at rest with customer-managed KMS keys
   - Deploy in private subnets across multiple Availability Zones

2. **AWS Secrets Manager**: Credential management with automatic rotation
   - Store database master credentials
   - Enable automatic rotation every 30 days
   - Configure rotation Lambda function

3. **Amazon ElastiCache for Redis**: Session management
   - Use for session storage to support stateless application architecture
   - Enable encryption in transit and at rest
   - Deploy in private subnets

4. **AWS KMS**: Customer-managed encryption keys
   - Create KMS key for RDS encryption
   - Enable key rotation
   - Configure key policy for RDS and Secrets Manager access

5. **VPC Networking**: Secure network configuration
   - Create VPC with public and private subnets across 2 AZs
   - RDS and ElastiCache in private subnets only
   - Security groups with least-privilege access

## Technical Constraints

1. **Region**: Deploy all resources in eu-west-1
2. **Environment Suffix**: ALL resource names MUST include the EnvironmentSuffix parameter using the pattern: `resource-name-${EnvironmentSuffix}`
3. **Credential Management**: Database master credentials MUST be managed through Secrets Manager with automatic rotation enabled every 30 days
4. **Encryption**: All data MUST be encrypted at rest using AWS KMS with customer-managed keys
5. **PCI-DSS Compliance**: Follow PCI-DSS requirements for data encryption and access controls

## Security Requirements

- Database master password must be generated by Secrets Manager (no hardcoded credentials)
- Enable deletion protection for RDS database
- Backup retention period of at least 7 days for point-in-time recovery
- All network traffic between application and database encrypted
- Security groups restrict database access to specific CIDR ranges
- IAM roles follow least-privilege principle

## Parameters

The CloudFormation template must include these parameters:
- `EnvironmentSuffix`: Required parameter for resource naming
- `DBInstanceClass`: Database instance class (default: db.t3.medium for Aurora Serverless v2)
- `VpcCidr`: CIDR block for VPC (default: 10.0.0.0/16)

## Outputs

Export these values for application integration:
- RDS cluster endpoint address
- RDS cluster port
- Secrets Manager secret ARN
- ElastiCache cluster endpoint
- Security group IDs
- VPC and subnet IDs

## Implementation Notes

- Use Aurora Serverless v2 to reduce deployment time compared to traditional RDS instances
- Set BackupRetentionPeriod to 7 days minimum (not 0)
- Use `!Sub` for string interpolation with EnvironmentSuffix
- Include DependsOn where necessary to ensure proper resource creation order
- Secrets Manager rotation Lambda can use the AWS-provided rotation function template

## Deliverables

Generate a complete CloudFormation YAML template that:
1. Creates all required AWS resources
2. Implements PCI-DSS compliant security controls
3. Includes comprehensive resource tagging
4. Uses EnvironmentSuffix in all resource names
5. Exports all necessary outputs

Provide the infrastructure code in one YAML file.

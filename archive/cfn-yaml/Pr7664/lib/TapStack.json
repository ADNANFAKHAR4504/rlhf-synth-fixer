{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TapStack - Serverless REST API Infrastructure (us-west-2). Builds everything new: API Gateway (REST with caching + CORS + IP allowlist + API Key/UsagePlan), Lambda (Python 3.13), DynamoDB (PROVISIONED with Auto Scaling), S3 log bucket (versioned, encrypted, TLS-only), Secrets Manager secret (API key), CloudWatch Logs + Alarms (API 4XX/5XX, Lambda errors/throttles, DDB throttles), SNS notifications, and a placeholder Security Group with ICMP/TCP 80/443 for future VPCLink ingress enforcement. To avoid Early Validation conflicts, the template does NOT set explicit physical names.\n",
    "Metadata": {
        "TemplateAuthor": "TapStack",
        "Version": "1.0.3",
        "Notes": [
            "Uses DynamoDB Application Auto Scaling with the service-linked role (no custom IAM role required).",
            "All Parameters have defaults for non-interactive pipeline deploys.",
            "Region targeting us-west-2 expected by pipeline."
        ]
    },
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Default": "tapstack",
            "Description": "Logical project prefix used in names/tags.",
            "AllowedPattern": "^[a-z0-9-]{3,32}$",
            "ConstraintDescription": "Lowercase letters, numbers, hyphens; 3–32 chars."
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev-us",
            "Description": "Environment suffix included in all names/tags (no hard enums).",
            "AllowedPattern": "^[a-z0-9-]{3,32}$",
            "ConstraintDescription": "Lowercase letters, numbers, hyphens; 3–32 chars."
        },
        "AllowedOrigins": {
            "Type": "String",
            "Default": "https://example.com,https://admin.example.com",
            "Description": "Comma-separated CORS origins."
        },
        "AllowedIpCidrs": {
            "Type": "String",
            "Default": "203.0.113.0/24,198.51.100.0/24",
            "Description": "Comma-separated CIDR ranges allowed to invoke the API."
        },
        "AlarmEmail": {
            "Type": "String",
            "Default": "",
            "Description": "Optional email for SNS alarm subscription. Leave empty to skip."
        },
        "ApiCacheTtlSeconds": {
            "Type": "Number",
            "Default": 300,
            "MinValue": 1,
            "MaxValue": 3600,
            "Description": "API Gateway stage cache TTL seconds."
        },
        "LogRetentionDays": {
            "Type": "Number",
            "Default": 30,
            "AllowedValues": [
                1,
                3,
                5,
                7,
                14,
                30,
                60,
                90,
                120,
                150,
                180,
                365,
                400,
                545,
                731,
                1827,
                3653
            ],
            "Description": "CloudWatch Logs retention in days."
        },
        "LifecycleDaysToGlacier": {
            "Type": "Number",
            "Default": 60,
            "MinValue": 1,
            "Description": "Days before log objects transition to GLACIER."
        },
        "LifecycleExpireDays": {
            "Type": "Number",
            "Default": 365,
            "MinValue": 30,
            "Description": "Days before old log objects expire."
        },
        "LambdaMemoryMb": {
            "Type": "Number",
            "Default": 256,
            "MinValue": 128,
            "MaxValue": 10240,
            "Description": "Lambda memory size in MB."
        },
        "LambdaTimeoutSeconds": {
            "Type": "Number",
            "Default": 15,
            "MinValue": 1,
            "MaxValue": 900,
            "Description": "Lambda timeout in seconds."
        },
        "LambdaReservedConcurrency": {
            "Type": "Number",
            "Default": 5,
            "MinValue": 0,
            "MaxValue": 1000,
            "Description": "Reserved concurrency (0 = unreserved)."
        },
        "DdbReadMin": {
            "Type": "Number",
            "Default": 1,
            "MinValue": 1,
            "Description": "DynamoDB min read capacity (Auto Scaling lower bound)."
        },
        "DdbReadMax": {
            "Type": "Number",
            "Default": 20,
            "MinValue": 1,
            "Description": "DynamoDB max read capacity (Auto Scaling upper bound)."
        },
        "DdbWriteMin": {
            "Type": "Number",
            "Default": 1,
            "MinValue": 1,
            "Description": "DynamoDB min write capacity (Auto Scaling lower bound)."
        },
        "DdbWriteMax": {
            "Type": "Number",
            "Default": 20,
            "MinValue": 1,
            "Description": "DynamoDB max write capacity (Auto Scaling upper bound)."
        },
        "Owner": {
            "Type": "String",
            "Default": "platform-team",
            "Description": "Owner tag value."
        },
        "CostCenter": {
            "Type": "String",
            "Default": "ENG-API",
            "Description": "Cost center tag value."
        }
    },
    "Mappings": {},
    "Conditions": {
        "HasAlarmEmail": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AlarmEmail"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasReservedConcurrency": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LambdaReservedConcurrency"
                        },
                        0
                    ]
                }
            ]
        }
    },
    "Resources": {
        "ApiVpc": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.80.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-vpc"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "Ingress for API (ICMP, TCP/80, TCP/443) - ${ProjectName}-${EnvironmentSuffix}"
                },
                "VpcId": {
                    "Ref": "ApiVpc"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "icmp",
                        "FromPort": -1,
                        "ToPort": -1,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api-sg"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LogBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "transition-and-expire",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "StorageClass": "GLACIER",
                                    "TransitionInDays": {
                                        "Ref": "LifecycleDaysToGlacier"
                                    }
                                }
                            ],
                            "ExpirationInDays": {
                                "Ref": "LifecycleExpireDays"
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-logs"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LogBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "LogBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "${LogBucket.Arn}"
                                },
                                {
                                    "Fn::Sub": "${LogBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "DynamoTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "BillingMode": "PROVISIONED",
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": {
                        "Ref": "DdbReadMin"
                    },
                    "WriteCapacityUnits": {
                        "Ref": "DdbWriteMin"
                    }
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "pk",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "sk",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "pk",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "sk",
                        "KeyType": "RANGE"
                    }
                ],
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "SSESpecification": {
                    "SSEEnabled": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-ddb"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "DdbReadScalableTarget": {
            "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
            "Properties": {
                "MaxCapacity": {
                    "Ref": "DdbReadMax"
                },
                "MinCapacity": {
                    "Ref": "DdbReadMin"
                },
                "ResourceId": {
                    "Fn::Sub": "table/${DynamoTable}"
                },
                "ScalableDimension": "dynamodb:table:ReadCapacityUnits",
                "ServiceNamespace": "dynamodb"
            }
        },
        "DdbReadScalingPolicy": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-ddb-read-target-tracking"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "DdbReadScalableTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "TargetValue": 70,
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "DynamoDBReadCapacityUtilization"
                    },
                    "ScaleInCooldown": 60,
                    "ScaleOutCooldown": 60
                }
            }
        },
        "DdbWriteScalableTarget": {
            "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
            "Properties": {
                "MaxCapacity": {
                    "Ref": "DdbWriteMax"
                },
                "MinCapacity": {
                    "Ref": "DdbWriteMin"
                },
                "ResourceId": {
                    "Fn::Sub": "table/${DynamoTable}"
                },
                "ScalableDimension": "dynamodb:table:WriteCapacityUnits",
                "ServiceNamespace": "dynamodb"
            }
        },
        "DdbWriteScalingPolicy": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-ddb-write-target-tracking"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "DdbWriteScalableTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "TargetValue": 70,
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "DynamoDBWriteCapacityUtilization"
                    },
                    "ScaleInCooldown": 60,
                    "ScaleOutCooldown": 60
                }
            }
        },
        "SecretsManagerSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": {
                    "Fn::Sub": "API credentials for ${ProjectName}-${EnvironmentSuffix}"
                },
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"apiKey\":\"changeme-soon\"}",
                    "GenerateStringKey": "token",
                    "PasswordLength": 32,
                    "ExcludePunctuation": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-secret"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiAccessLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-inline"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "logs:CreateLogGroup",
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "LambdaLogGroup",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${LambdaLogGroup.Arn}:*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:DeleteItem",
                                        "dynamodb:Query",
                                        "dynamodb:Scan"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DynamoTable",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "secretsmanager:GetSecretValue",
                                    "Resource": {
                                        "Ref": "SecretsManagerSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:PutObject",
                                    "Resource": {
                                        "Fn::Sub": "${LogBucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-lambda-role"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Runtime": "python3.13",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": {
                    "Ref": "LambdaTimeoutSeconds"
                },
                "MemorySize": {
                    "Ref": "LambdaMemoryMb"
                },
                "ReservedConcurrentExecutions": {
                    "Fn::If": [
                        "HasReservedConcurrency",
                        {
                            "Ref": "LambdaReservedConcurrency"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "TABLE_NAME": {
                            "Ref": "DynamoTable"
                        },
                        "SECRET_ID": {
                            "Ref": "SecretsManagerSecret"
                        },
                        "LOG_BUCKET": {
                            "Ref": "LogBucket"
                        },
                        "ENVIRONMENT_SUFFIX": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "PROJECT_NAME": {
                            "Ref": "ProjectName"
                        },
                        "ALLOWED_ORIGINS": {
                            "Ref": "AllowedOrigins"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import os, json, boto3, base64, datetime\nddb = boto3.resource('dynamodb')\nsm = boto3.client('secretsmanager')\ns3 = boto3.client('s3')\n\nTABLE_NAME = os.environ['TABLE_NAME']\nSECRET_ID = os.environ['SECRET_ID']\nLOG_BUCKET = os.environ['LOG_BUCKET']\nALLOWED_ORIGINS = os.environ.get('ALLOWED_ORIGINS','*')\n\ntable = ddb.Table(TABLE_NAME)\n\ndef _cors_headers():\n    return {\n        \"Access-Control-Allow-Origin\": ALLOWED_ORIGINS,\n        \"Access-Control-Allow-Headers\": \"Content-Type,X-API-Key\",\n        \"Access-Control-Allow-Methods\": \"GET,POST,OPTIONS\"\n    }\n\ndef handler(event, context):\n    method = event.get(\"httpMethod\", \"GET\")\n    if method == \"OPTIONS\":\n        return {\"statusCode\": 200, \"headers\": _cors_headers(), \"body\": \"\"}\n\n    sec = sm.get_secret_value(SecretId=SECRET_ID)\n    secret_payload = sec.get(\"SecretString\") or base64.b64decode(sec[\"SecretBinary\"]).decode(\"utf-8\")\n\n    if method == \"POST\":\n        body = json.loads(event.get(\"body\") or \"{}\")\n        pk = body.get(\"pk\") or f\"auto#{int(datetime.datetime.utcnow().timestamp())}\"\n        item = {\"pk\": pk, \"sk\": \"v1\", \"body\": body, \"ts\": datetime.datetime.utcnow().isoformat()}\n        table.put_item(Item=item)\n        s3.put_object(Bucket=LOG_BUCKET, Key=f\"lambda/{pk}.json\", Body=json.dumps(item).encode(\"utf-8\"))\n        resp = {\"ok\": True, \"secret\": bool(secret_payload), \"item\": item}\n        return {\"statusCode\": 200, \"headers\": _cors_headers(), \"body\": json.dumps(resp)}\n    else:\n        items = table.scan(Limit=10).get(\"Items\", [])\n        return {\"statusCode\": 200, \"headers\": _cors_headers(), \"body\": json.dumps({\"items\": items, \"count\": len(items)})}\n"
                }
            },
            "DependsOn": [
                "LambdaLogGroup"
            ]
        },
        "LambdaVersion": {
            "Type": "AWS::Lambda::Version",
            "Properties": {
                "FunctionName": {
                    "Ref": "LambdaFunction"
                }
            }
        },
        "RestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
                },
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Policy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowSpecificCidrsInvoke",
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": "execute-api:Invoke",
                            "Resource": {
                                "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/*"
                            },
                            "Condition": {
                                "IpAddress": {
                                    "aws:SourceIp": {
                                        "Fn::Split": [
                                            ",",
                                            {
                                                "Ref": "AllowedIpCidrs"
                                            }
                                        ]
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "ParentId": {
                    "Fn::GetAtt": [
                        "RestApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "items",
                "RestApiId": {
                    "Ref": "RestApi"
                }
            }
        },
        "ApiMethodOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "OPTIONS",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "MOCK",
                    "RequestTemplates": {
                        "application/json": "{\"statusCode\": 200}"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200,
                            "ResponseParameters": {
                                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-API-Key'",
                                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,OPTIONS'",
                                "method.response.header.Access-Control-Allow-Origin": {
                                    "Fn::Sub": "'${AllowedOrigins}'"
                                }
                            },
                            "ResponseTemplates": {
                                "application/json": ""
                            }
                        }
                    ]
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Headers": true,
                            "method.response.header.Access-Control-Allow-Methods": true,
                            "method.response.header.Access-Control-Allow-Origin": true
                        }
                    }
                ]
            }
        },
        "ApiMethodAny": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "ANY",
                "AuthorizationType": "NONE",
                "ApiKeyRequired": true,
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": [
                            "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FuncArn}/invocations",
                            {
                                "FuncArn": {
                                    "Fn::GetAtt": [
                                        "LambdaFunction",
                                        "Arn"
                                    ]
                                }
                            }
                        ]
                    }
                }
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "Description": {
                    "Fn::Sub": "Deployment for ${ProjectName}-${EnvironmentSuffix}"
                }
            },
            "DependsOn": [
                "ApiMethodAny",
                "ApiMethodOptions"
            ]
        },
        "ApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "DeploymentId": {
                    "Ref": "ApiDeployment"
                },
                "StageName": "v1",
                "CacheClusterEnabled": true,
                "CacheClusterSize": "0.5",
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "CachingEnabled": true,
                        "CacheTtlInSeconds": {
                            "Ref": "ApiCacheTtlSeconds"
                        },
                        "MetricsEnabled": true,
                        "DataTraceEnabled": false
                    }
                ],
                "AccessLogSetting": {
                    "DestinationArn": {
                        "Fn::GetAtt": [
                            "ApiAccessLogGroup",
                            "Arn"
                        ]
                    },
                    "Format": "{\"requestId\":\"$context.requestId\",\"ip\":\"$context.identity.sourceIp\", \"caller\":\"$context.identity.caller\",\"user\":\"$context.identity.user\", \"requestTime\":\"$context.requestTime\",\"httpMethod\":\"$context.httpMethod\", \"path\":\"$context.path\",\"status\":\"$context.status\",\"protocol\":\"$context.protocol\", \"responseLength\":\"$context.responseLength\"}\n"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiApiKey": {
            "Type": "AWS::ApiGateway::ApiKey",
            "Properties": {
                "Enabled": true,
                "Name": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-key"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApiUsagePlan": {
            "Type": "AWS::ApiGateway::UsagePlan",
            "Properties": {
                "UsagePlanName": {
                    "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-plan"
                },
                "Throttle": {
                    "RateLimit": 50,
                    "BurstLimit": 100
                },
                "Quota": {
                    "Limit": 100000,
                    "Period": "MONTH"
                },
                "ApiStages": [
                    {
                        "ApiId": {
                            "Ref": "RestApi"
                        },
                        "Stage": {
                            "Ref": "ApiStage"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApiUsagePlanKey": {
            "Type": "AWS::ApiGateway::UsagePlanKey",
            "Properties": {
                "KeyId": {
                    "Ref": "ApiApiKey"
                },
                "KeyType": "API_KEY",
                "UsagePlanId": {
                    "Ref": "ApiUsagePlan"
                }
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "LambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*/*"
                }
            }
        },
        "AlarmTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-alarms"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "AlarmSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Condition": "HasAlarmEmail",
            "Properties": {
                "Protocol": "email",
                "Endpoint": {
                    "Ref": "AlarmEmail"
                },
                "TopicArn": {
                    "Ref": "AlarmTopic"
                }
            }
        },
        "Api4xxAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "API 4XX error rate high",
                "Namespace": "AWS/ApiGateway",
                "MetricName": "4XXError",
                "Dimensions": [
                    {
                        "Name": "ApiName",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
                        }
                    },
                    {
                        "Name": "Stage",
                        "Value": {
                            "Ref": "ApiStage"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 5,
                "Threshold": 50,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "AlarmTopic"
                    }
                ]
            }
        },
        "Api5xxAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "API 5XX error rate high",
                "Namespace": "AWS/ApiGateway",
                "MetricName": "5XXError",
                "Dimensions": [
                    {
                        "Name": "ApiName",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
                        }
                    },
                    {
                        "Name": "Stage",
                        "Value": {
                            "Ref": "ApiStage"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 3,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "AlarmTopic"
                    }
                ]
            }
        },
        "LambdaErrorsAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Lambda error count high",
                "Namespace": "AWS/Lambda",
                "MetricName": "Errors",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "LambdaFunction"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 3,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "AlarmTopic"
                    }
                ]
            }
        },
        "LambdaThrottlesAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Lambda throttles detected",
                "Namespace": "AWS/Lambda",
                "MetricName": "Throttles",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "LambdaFunction"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "AlarmTopic"
                    }
                ]
            }
        },
        "DynamoThrottlesAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "DynamoDB throttled requests",
                "Namespace": "AWS/DynamoDB",
                "MetricName": "ThrottledRequests",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "DynamoTable"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 3,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "AlarmTopic"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "Project": {
            "Description": "Project name used in this stack.",
            "Value": {
                "Ref": "ProjectName"
            }
        },
        "EnvironmentSuffixOut": {
            "Description": "Effective environment suffix.",
            "Value": {
                "Ref": "EnvironmentSuffix"
            }
        },
        "ApiId": {
            "Description": "API Gateway RestApi ID.",
            "Value": {
                "Ref": "RestApi"
            }
        },
        "ApiStageName": {
            "Description": "Deployed stage name.",
            "Value": {
                "Ref": "ApiStage"
            }
        },
        "ApiInvokeUrl": {
            "Description": "Invoke URL (attach /items).",
            "Value": {
                "Fn::Sub": "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${ApiStage}/items"
            }
        },
        "ApiKeyId": {
            "Description": "API Key ID (retrieve value via console/SDK).",
            "Value": {
                "Ref": "ApiApiKey"
            }
        },
        "LambdaName": {
            "Description": "Lambda function name (auto-generated physical name).",
            "Value": {
                "Ref": "LambdaFunction"
            }
        },
        "LambdaLogGroupArn": {
            "Description": "CloudWatch Logs group ARN for Lambda.",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaLogGroup",
                    "Arn"
                ]
            }
        },
        "DynamoTableName": {
            "Description": "DynamoDB table name (auto-generated).",
            "Value": {
                "Ref": "DynamoTable"
            }
        },
        "DynamoTableArn": {
            "Description": "DynamoDB table ARN.",
            "Value": {
                "Fn::GetAtt": [
                    "DynamoTable",
                    "Arn"
                ]
            }
        },
        "LogBucketName": {
            "Description": "S3 bucket for Lambda logs/objects (auto-generated).",
            "Value": {
                "Ref": "LogBucket"
            }
        },
        "LogBucketArn": {
            "Description": "S3 log bucket ARN.",
            "Value": {
                "Fn::GetAtt": [
                    "LogBucket",
                    "Arn"
                ]
            }
        },
        "SecretArn": {
            "Description": "Secrets Manager secret ARN.",
            "Value": {
                "Ref": "SecretsManagerSecret"
            }
        },
        "AlarmTopicArn": {
            "Description": "SNS Topic ARN for alarms.",
            "Value": {
                "Ref": "AlarmTopic"
            }
        }
    }
}
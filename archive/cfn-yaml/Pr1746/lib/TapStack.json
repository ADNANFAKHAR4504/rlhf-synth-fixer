{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-ready security configuration for multi-account AWS environment with comprehensive monitoring and compliance",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "production",
            "AllowedValues": [
                "production",
                "staging",
                "development"
            ],
            "Description": "Environment name for resource tagging"
        },
        "AllowedCIDR": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "CIDR block allowed to access EC2 instances",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
        },
        "NotificationEmail": {
            "Type": "String",
            "Default": "no-reply@gmail.com",
            "Description": "Email address for security notifications",
            "AllowedPattern": "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
        }
    },
    "Resources": {
        "SecurityKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for encrypting security-related resources",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudTrail to encrypt logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow Config to encrypt configuration items",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs use of the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Security"
                    }
                ]
            }
        },
        "SecurityKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/security-${Environment}-${AWS::StackName}"
                },
                "TargetKeyId": {
                    "Ref": "SecurityKMSKey"
                }
            }
        },
        "SecureVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "secure-vpc-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "secure-igw-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "SecureVPC"
                }
            }
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.1.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.2.0/24",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NATGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-eip-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NATGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-gateway-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-rt-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-rt-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "DefaultPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet"
                }
            }
        },
        "RestrictedSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "restricted-sg-${Environment}-${AWS::StackName}"
                },
                "GroupDescription": "Security group with restricted access",
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "AllowedCIDR"
                        },
                        "Description": "SSH access from allowed CIDR"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Ref": "AllowedCIDR"
                        },
                        "Description": "HTTPS access from allowed CIDR"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS outbound"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP outbound for package updates"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "restricted-sg-${Environment}-${AWS::StackName}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "EC2InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "EC2InstanceRole-${Environment}-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "MinimalEC2Policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::${SecurityLogsBucket}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": {
                    "Fn::Sub": "EC2InstanceProfile-${Environment}-${AWS::StackName}"
                },
                "Roles": [
                    {
                        "Ref": "EC2InstanceRole"
                    }
                ]
            }
        },
        "CloudTrailRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "CloudTrailRole-${Environment}-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ConfigRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "ConfigRole-${Environment}-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSConfigRoleForOrganizations"
                ],
                "Policies": [
                    {
                        "PolicyName": "ConfigBucketPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketAcl",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ConfigBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::${ConfigBucket}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecurityLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "security-logs-${AWS::AccountId}-${Environment}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "SecurityKMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 2557
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "SecurityLogs"
                    }
                ]
            }
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "config-bucket-${AWS::AccountId}-${Environment}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "SecurityKMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "ConfigLogs"
                    }
                ]
            }
        },
        "SecurityLogsGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/security/${Environment}-${AWS::StackName}"
                },
                "RetentionInDays": 2557,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "SecurityKMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "CloudTrailLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/cloudtrail/${Environment}-${AWS::StackName}"
                },
                "RetentionInDays": 2557,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "SecurityKMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecurityCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": "SecurityLogsBucketPolicy",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "security-trail-${Environment}-${AWS::StackName}"
                },
                "S3BucketName": {
                    "Ref": "SecurityLogsBucket"
                },
                "S3KeyPrefix": "cloudtrail-logs",
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "IsLogging": true,
                "KMSKeyId": {
                    "Ref": "SecurityKMSKey"
                },
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "CloudTrailLogGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "CloudTrailRole",
                        "Arn"
                    ]
                },
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true,
                        "DataResources": [
                            {
                                "Type": "AWS::S3::Object",
                                "Values": [
                                    {
                                        "Fn::Sub": "arn:aws:s3:::${SecurityLogsBucket}/*"
                                    },
                                    {
                                        "Fn::Sub": "arn:aws:s3:::${ConfigBucket}/*"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecurityLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "SecurityLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${SecurityLogsBucket}"
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${SecurityLogsBucket}/cloudtrail-logs/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigDeliveryChannel": {
            "Type": "AWS::Config::DeliveryChannel",
            "Properties": {
                "Name": {
                    "Fn::Sub": "config-delivery-channel-${Environment}-${AWS::StackName}"
                },
                "S3BucketName": {
                    "Ref": "ConfigBucket"
                }
            }
        },
        "ConfigConfigurationRecorder": {
            "Type": "AWS::Config::ConfigurationRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "config-recorder-${Environment}-${AWS::StackName}"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "ConfigRole",
                        "Arn"
                    ]
                },
                "RecordingGroup": {
                    "AllSupported": true,
                    "IncludeGlobalResourceTypes": true
                }
            }
        },
        "RootMFAEnabledRule": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigConfigurationRecorder",
            "Properties": {
                "ConfigRuleName": "root-mfa-enabled",
                "Description": "Checks whether MFA is enabled for the root user",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ROOT_ACCOUNT_MFA_ENABLED"
                }
            }
        },
        "S3BucketPublicAccessProhibitedRule": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigConfigurationRecorder",
            "Properties": {
                "ConfigRuleName": "s3-bucket-public-access-prohibited",
                "Description": "Checks that S3 buckets do not allow public access",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_PUBLIC_READ_PROHIBITED"
                }
            }
        },
        "SecurityGroupSSHRestrictedRule": {
            "Type": "AWS::Config::ConfigRule",
            "DependsOn": "ConfigConfigurationRecorder",
            "Properties": {
                "ConfigRuleName": "incoming-ssh-disabled",
                "Description": "Checks whether security groups disallow unrestricted incoming SSH traffic",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "INCOMING_SSH_DISABLED"
                }
            }
        },
        "GuardDutyDetector": {
            "Type": "AWS::GuardDuty::Detector",
            "Properties": {
                "Enable": true,
                "FindingPublishingFrequency": "FIFTEEN_MINUTES",
                "DataSources": {
                    "S3Logs": {
                        "Enable": true
                    },
                    "MalwareProtection": {
                        "ScanEc2InstanceWithFindings": {
                            "EbsVolumes": true
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecurityNotificationsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "security-notifications-${Environment}-${AWS::StackName}"
                },
                "DisplayName": "Security Notifications",
                "KmsMasterKeyId": {
                    "Ref": "SecurityKMSKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecurityNotificationsSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "SecurityNotificationsTopic"
                },
                "Endpoint": {
                    "Ref": "NotificationEmail"
                }
            }
        },
        "GuardDutyEventRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "guardduty-findings-${Environment}-${AWS::StackName}"
                },
                "Description": "Capture GuardDuty findings",
                "EventPattern": {
                    "source": [
                        "aws.guardduty"
                    ],
                    "detail-type": [
                        "GuardDuty Finding"
                    ],
                    "detail": {
                        "severity": [
                            4.0,
                            4.1,
                            4.2,
                            4.3,
                            4.4,
                            4.5,
                            4.6,
                            4.7,
                            4.8,
                            4.9,
                            5.0,
                            5.1,
                            5.2,
                            5.3,
                            5.4,
                            5.5,
                            5.6,
                            5.7,
                            5.8,
                            5.9,
                            6.0,
                            6.1,
                            6.2,
                            6.3,
                            6.4,
                            6.5,
                            6.6,
                            6.7,
                            6.8,
                            6.9,
                            7.0,
                            7.1,
                            7.2,
                            7.3,
                            7.4,
                            7.5,
                            7.6,
                            7.7,
                            7.8,
                            7.9,
                            8.0,
                            8.1,
                            8.2,
                            8.3,
                            8.4,
                            8.5,
                            8.6,
                            8.7,
                            8.8,
                            8.9,
                            9.0,
                            9.1,
                            9.2,
                            9.3,
                            9.4,
                            9.5,
                            9.6,
                            9.7,
                            9.8,
                            9.9,
                            10.0
                        ]
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Ref": "SecurityNotificationsTopic"
                        },
                        "Id": "SecurityNotificationTarget"
                    },
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "IncidentResponseFunction",
                                "Arn"
                            ]
                        },
                        "Id": "IncidentResponseTarget"
                    }
                ]
            }
        },
        "IncidentResponseRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "IncidentResponseRole-${Environment}-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "IncidentResponsePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DescribeInstances",
                                        "ec2:StopInstances",
                                        "ec2:CreateSnapshot",
                                        "sns:Publish",
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "IncidentResponseFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "incident-response-${Environment}-${AWS::StackName}"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "IncidentResponseRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "SNS_TOPIC_ARN": {
                            "Ref": "SecurityNotificationsTopic"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\n\ndef lambda_handler(event, context):\n    print(f\"Received GuardDuty finding: {json.dumps(event)}\")\n    \n    # Extract finding details\n    detail = event.get('detail', {})\n    finding_type = detail.get('type', '')\n    severity = detail.get('severity', 0)\n    \n    # Initialize AWS clients\n    ec2 = boto3.client('ec2')\n    sns = boto3.client('sns')\n    \n    response_actions = []\n    \n    # Automated response based on finding type and severity\n    if severity >= 7.0:  # High severity findings\n        if 'UnauthorizedAPICall' in finding_type:\n            response_actions.append(\"High severity unauthorized API call detected\")\n        elif 'Backdoor' in finding_type or 'Trojan' in finding_type:\n            # For malware findings, consider isolating affected instances\n            response_actions.append(\"Malware detected - manual intervention required\")\n        elif 'Cryptocurrency' in finding_type:\n            response_actions.append(\"Cryptocurrency mining detected\")\n    \n    # Send notification\n    message = f\"\"\"\n    GuardDuty Finding Alert:\n    Type: {finding_type}\n    Severity: {severity}\n    Automated Actions: {', '.join(response_actions) if response_actions else 'None'}\n    \n    Full Details: {json.dumps(detail, indent=2)}\n    \"\"\"\n    \n    sns.publish(\n        TopicArn=os.environ['SNS_TOPIC_ARN'],\n        Subject=f'GuardDuty Alert - {finding_type}',\n        Message=message\n    )\n    \n    return {\n        'statusCode': 200,\n        'body': json.dumps({\n            'message': 'Incident response completed',\n            'actions_taken': response_actions\n        })\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "IncidentResponseFunctionPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "IncidentResponseFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "GuardDutyEventRule",
                        "Arn"
                    ]
                }
            }
        },
        "SecurityNotificationsTopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "Topics": [
                    {
                        "Ref": "SecurityNotificationsTopic"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowEventBridgePublish",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "events.amazonaws.com"
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "SecurityNotificationsTopic"
                            }
                        }
                    ]
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "ID of the secure VPC",
            "Value": {
                "Ref": "SecureVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-ID"
                }
            }
        },
        "PrivateSubnetId": {
            "Description": "ID of the private subnet",
            "Value": {
                "Ref": "PrivateSubnet"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet-ID"
                }
            }
        },
        "PublicSubnetId": {
            "Description": "ID of the public subnet",
            "Value": {
                "Ref": "PublicSubnet"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet-ID"
                }
            }
        },
        "SecurityGroupId": {
            "Description": "ID of the restricted security group",
            "Value": {
                "Ref": "RestrictedSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecurityGroup-ID"
                }
            }
        },
        "KMSKeyId": {
            "Description": "ID of the security KMS key",
            "Value": {
                "Ref": "SecurityKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ID"
                }
            }
        },
        "CloudTrailArn": {
            "Description": "ARN of the CloudTrail",
            "Value": {
                "Fn::GetAtt": [
                    "SecurityCloudTrail",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudTrail-ARN"
                }
            }
        },
        "GuardDutyDetectorId": {
            "Description": "ID of the GuardDuty detector",
            "Value": {
                "Ref": "GuardDutyDetector"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-GuardDuty-Detector-ID"
                }
            }
        },
        "SecurityLogsBucketName": {
            "Description": "Name of the security logs S3 bucket",
            "Value": {
                "Ref": "SecurityLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecurityLogs-Bucket"
                }
            }
        },
        "EC2InstanceProfileArn": {
            "Description": "ARN of the EC2 instance profile",
            "Value": {
                "Fn::GetAtt": [
                    "EC2InstanceProfile",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EC2-InstanceProfile-ARN"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Automated daily backup solution for EC2 instance using EventBridge, Lambda, SSM, and S3. The solution creates a secure, event-driven backup workflow that compresses application data and stores it in an encrypted S3 bucket without requiring additional ports or SSH access.",
    "Parameters": {
        "BackupSchedule": {
            "Type": "String",
            "Default": "cron(0 2 * * ? *)",
            "Description": "Backup schedule in cron format (default: daily at 2 AM UTC)"
        },
        "ApplicationDataPath": {
            "Type": "String",
            "Default": "/var/www/html",
            "Description": "Path to application data to backup"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "CIDR block for the VPC"
        },
        "PublicSubnetCidr": {
            "Type": "String",
            "Default": "10.0.1.0/24",
            "Description": "CIDR block for the public subnet"
        },
        "PrivateSubnetCidr": {
            "Type": "String",
            "Default": "10.0.2.0/24",
            "Description": "CIDR block for the private subnet"
        },
        "InstanceType": {
            "Type": "String",
            "Default": "t3.micro",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium"
            ],
            "Description": "EC2 instance type for the web server"
        }
    },
    "Resources": {
        "BackupVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-VPC"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-PublicSubnet"
                    }
                ]
            }
        },
        "PrivateSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-PrivateSubnet"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-IGW"
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-PublicRT"
                    }
                ]
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-PrivateRT"
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PrivateRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for web server allowing HTTPS traffic only",
                "VpcId": {
                    "Ref": "BackupVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS traffic from internet"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-WebServerSG"
                    }
                ]
            }
        },
        "BackupLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/backup/${AWS::StackName}"
                },
                "RetentionInDays": 14
            }
        },
        "BackupBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldBackups",
                            "Status": "Enabled",
                            "ExpirationInDays": 30,
                            "NoncurrentVersionExpirationInDays": 7
                        }
                    ]
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "AccessLogsBucket"
                    },
                    "LogFilePrefix": "backup-access-logs/"
                }
            }
        },
        "AccessLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                }
            }
        },
        "BackupLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SSMSendCommandPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:DescribeInstanceInformation"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:SendCommand",
                                        "ssm:GetCommandInvocation"
                                    ],
                                    "Resource": [
                                        "arn:aws:ssm:*:*:document/AWS-RunShellScript",
                                        "arn:aws:ssm:*:*:instance/*",
                                        "arn:aws:ec2:*:*:instance/*"
                                    ],
                                    "Condition": {
                                        "StringEquals": {
                                            "ssm:ResourceTag/BackupEnabled": "true"
                                        }
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${BackupLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EC2BackupRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3BackupPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:PutObjectAcl"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${BackupBucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "BackupBucket",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EC2BackupInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2BackupRole"
                    }
                ]
            }
        },
        "WebServerInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "IamInstanceProfile": {
                    "Ref": "EC2BackupInstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "WebServerSecurityGroup"
                    }
                ],
                "SubnetId": {
                    "Ref": "PublicSubnet"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Sub": "#!/bin/bash\nyum update -y\nyum install -y httpd\nsystemctl start httpd\nsystemctl enable httpd\n\n# Create sample application data directory\nmkdir -p ${ApplicationDataPath}/app-data\necho \"Sample application data - $(date)\" > ${ApplicationDataPath}/app-data/data.txt\necho \"Configuration file - $(date)\" > ${ApplicationDataPath}/app-data/config.json\n\n# Install and start SSM agent (already installed on Amazon Linux 2)\nsystemctl start amazon-ssm-agent\nsystemctl enable amazon-ssm-agent\n"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "BackupSolution-WebServer"
                    },
                    {
                        "Key": "BackupEnabled",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "BackupLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${AWS::StackName}-backup-orchestrator"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "BackupLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "Environment": {
                    "Variables": {
                        "INSTANCE_ID": {
                            "Ref": "WebServerInstance"
                        },
                        "BUCKET_NAME": {
                            "Ref": "BackupBucket"
                        },
                        "DATA_PATH": {
                            "Ref": "ApplicationDataPath"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport logging\nfrom datetime import datetime\n\n# Configure logging\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\n# LocalStack endpoint configuration\ndef get_boto3_client(service_name):\n    endpoint_url = os.environ.get('AWS_ENDPOINT_URL')\n    if endpoint_url and ('localhost' in endpoint_url or '4566' in endpoint_url):\n        return boto3.client(service_name, endpoint_url=endpoint_url)\n    return boto3.client(service_name)\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Lambda function to orchestrate EC2 backup using SSM Run Command.\n    This function is triggered by EventBridge on a daily schedule.\n    \"\"\"\n\n    ssm_client = get_boto3_client('ssm')\n    \n    instance_id = os.environ['INSTANCE_ID']\n    bucket_name = os.environ['BUCKET_NAME']\n    data_path = os.environ['DATA_PATH']\n    \n    logger.info(f\"Starting backup process for instance: {instance_id}\")\n    \n    try:\n        # Check if instance is available for SSM\n        response = ssm_client.describe_instance_information(\n            Filters=[\n                {\n                    'Key': 'InstanceIds',\n                    'Values': [instance_id]\n                }\n            ]\n        )\n        \n        if not response['InstanceInformationList']:\n            raise Exception(f\"Instance {instance_id} is not available for SSM\")\n        \n        instance_info = response['InstanceInformationList'][0]\n        if instance_info['PingStatus'] != 'Online':\n            raise Exception(f\"Instance {instance_id} is not online. Status: {instance_info['PingStatus']}\")\n        \n        # Send backup command to EC2 instance\n        backup_script = f\"\"\"#!/bin/bash\n        set -e\n        TIMESTAMP=$(date +%Y%m%d_%H%M%S)\n        HOSTNAME=$(hostname)\n        BACKUP_FILE=\"/tmp/backup_${{HOSTNAME}}_${{TIMESTAMP}}.tar.gz\"\n        DATA_PATH=\"{data_path}\"\n        BUCKET_NAME=\"{bucket_name}\"\n        \n        echo \"Starting backup process at $(date)\"\n        echo \"Backing up data from: $DATA_PATH\"\n        echo \"Backup file: $BACKUP_FILE\"\n        \n        # Create compressed archive of application data\n        if [ -d \"$DATA_PATH\" ]; then\n          tar -czf \"$BACKUP_FILE\" -C \"$(dirname \"$DATA_PATH\")\" \"$(basename \"$DATA_PATH\")\" 2>/dev/null || {{\n            echo \"Error: Failed to create backup archive\"\n            exit 1\n          }}\n        else\n          echo \"Error: Data path $DATA_PATH does not exist\"\n          exit 1\n        fi\n        \n        # Verify backup file was created\n        if [ ! -f \"$BACKUP_FILE\" ]; then\n          echo \"Error: Backup file was not created\"\n          exit 1\n        fi\n        \n        BACKUP_SIZE=$(du -h \"$BACKUP_FILE\" | cut -f1)\n        echo \"Backup archive created successfully. Size: $BACKUP_SIZE\"\n        \n        # Upload to S3\n        S3_KEY=\"backups/${{HOSTNAME}}/${{TIMESTAMP}}/backup_${{HOSTNAME}}_${{TIMESTAMP}}.tar.gz\"\n        echo \"Uploading to s3://${{BUCKET_NAME}}/${{S3_KEY}}\"\n        \n        aws s3 cp \"$BACKUP_FILE\" \"s3://${{BUCKET_NAME}}/${{S3_KEY}}\" --region us-east-1 || {{\n          echo \"Error: Failed to upload backup to S3\"\n          rm -f \"$BACKUP_FILE\"\n          exit 1\n        }}\n        \n        # Clean up local backup file\n        rm -f \"$BACKUP_FILE\"\n        echo \"Backup completed successfully at $(date)\"\n        echo \"Backup stored at: s3://${{BUCKET_NAME}}/${{S3_KEY}}\"\n        \"\"\"\n        \n        command_response = ssm_client.send_command(\n            InstanceIds=[instance_id],\n            DocumentName='AWS-RunShellScript',\n            Parameters={\n                'commands': [backup_script]\n            },\n            Comment=f'Automated backup initiated at {datetime.utcnow().isoformat()}',\n            TimeoutSeconds=3600\n        )\n        \n        command_id = command_response['Command']['CommandId']\n        logger.info(f\"Backup command sent successfully. Command ID: {command_id}\")\n        \n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Backup command sent successfully',\n                'commandId': command_id,\n                'instanceId': instance_id,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n        \n    except Exception as e:\n        logger.error(f\"Error initiating backup: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': str(e),\n                'instanceId': instance_id,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n"
                }
            }
        },
        "BackupScheduleRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-daily-backup-schedule"
                },
                "Description": "Daily trigger for automated EC2 backup process",
                "ScheduleExpression": {
                    "Ref": "BackupSchedule"
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "BackupLambdaFunction",
                                "Arn"
                            ]
                        },
                        "Id": "BackupLambdaTarget",
                        "Input": {
                            "Fn::Sub": "{\n  \"source\": \"aws.events\",\n  \"detail-type\": \"Scheduled Event\",\n  \"detail\": {\n    \"instance-id\": \"${WebServerInstance}\",\n    \"backup-type\": \"daily-automated\"\n  }\n}\n"
                        }
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "BackupLambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "BackupScheduleRule",
                        "Arn"
                    ]
                },
                "SourceAccount": {
                    "Ref": "AWS::AccountId"
                }
            }
        }
    },
    "Outputs": {
        "BackupBucketName": {
            "Description": "Name of the S3 bucket storing backups",
            "Value": {
                "Ref": "BackupBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-backup-bucket"
                }
            }
        },
        "BackupBucketArn": {
            "Description": "ARN of the S3 backup bucket",
            "Value": {
                "Fn::GetAtt": [
                    "BackupBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-backup-bucket-arn"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the backup orchestration Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "BackupLambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-lambda-function-arn"
                }
            }
        },
        "BackupSchedule": {
            "Description": "Backup schedule expression",
            "Value": {
                "Ref": "BackupSchedule"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-backup-schedule"
                }
            }
        },
        "LogGroupName": {
            "Description": "CloudWatch Log Group for backup operations",
            "Value": {
                "Ref": "BackupLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-log-group"
                }
            }
        },
        "WebServerInstanceId": {
            "Description": "Instance ID of the web server",
            "Value": {
                "Ref": "WebServerInstance"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-web-server-instance"
                }
            }
        },
        "VPCId": {
            "Description": "ID of the VPC",
            "Value": {
                "Ref": "BackupVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-vpc-id"
                }
            }
        }
    }
}
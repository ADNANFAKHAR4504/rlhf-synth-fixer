{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Security Configuration as Code - Simplified Stack for Environment with Existing Resources",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Environment Configuration"
          },
          "Parameters": [
            "EnvironmentSuffix"
          ]
        },
        {
          "Label": {
            "default": "Security Configuration"
          },
          "Parameters": [
            "NotificationEmail",
            "EnableMacie"
          ]
        }
      ]
    }
  },
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "AllowedPattern": "^[a-zA-Z0-9]+$",
      "ConstraintDescription": "Must contain only alphanumeric characters"
    },
    "NotificationEmail": {
      "Type": "String",
      "Default": "security@example.com",
      "Description": "Email address for security notifications",
      "AllowedPattern": "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",
      "ConstraintDescription": "Must be a valid email address"
    },
    "EnableMacie": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Description": "Enable Amazon Macie for sensitive data discovery"
    }
  },
  "Conditions": {
    "ShouldCreateMacie": {
      "Fn::And": [
        {
          "Fn::Equals": [
            {
              "Ref": "EnableMacie"
            },
            "true"
          ]
        },
        {
          "Fn::Not": [
            {
              "Fn::Equals": [
                {
                  "Ref": "AWS::Region"
                },
                "us-east-1"
              ]
            }
          ]
        }
      ]
    }
  },
  "Resources": {
    "SecurityServicesKMSKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {
          "Fn::Sub": "KMS Key for Security Services - ${EnvironmentSuffix}"
        },
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "SecurityServices-KMS-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "SecurityServicesKMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/security-services-${EnvironmentSuffix}"
        },
        "TargetKeyId": {
          "Ref": "SecurityServicesKMSKey"
        }
      }
    },
    "SecurityNotificationsTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "security-notifications-${EnvironmentSuffix}"
        },
        "DisplayName": {
          "Fn::Sub": "Security Notifications - ${EnvironmentSuffix}"
        },
        "KmsMasterKeyId": {
          "Ref": "SecurityServicesKMSKey"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "Security-Notifications-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "SecurityNotificationsSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "TopicArn": {
          "Ref": "SecurityNotificationsTopic"
        },
        "Protocol": "email",
        "Endpoint": {
          "Ref": "NotificationEmail"
        }
      }
    },
    "SecurityHub": {
      "Type": "AWS::SecurityHub::Hub",
      "Properties": {
        "Tags": {
          "Name": {
            "Fn::Sub": "Security-Hub-${EnvironmentSuffix}"
          },
          "Environment": {
            "Ref": "EnvironmentSuffix"
          }
        },
        "EnableDefaultStandards": true,
        "ControlFindingGenerator": "SECURITY_CONTROL"
      }
    },
    "MacieSession": {
      "Type": "AWS::Macie2::Session",
      "Condition": "ShouldCreateMacie",
      "Properties": {
        "Status": "ENABLED",
        "FindingPublishingFrequency": "FIFTEEN_MINUTES"
      }
    },
    "GuardDutyEventRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "guardduty-high-severity-${EnvironmentSuffix}"
        },
        "Description": "Captures high severity GuardDuty findings",
        "EventPattern": {
          "source": [
            "aws.guardduty"
          ],
          "detail-type": [
            "GuardDuty Finding"
          ],
          "detail": {
            "severity": [
              7,
              7.0,
              7.1,
              7.2,
              7.3,
              7.4,
              7.5,
              7.6,
              7.7,
              7.8,
              7.9,
              8,
              8.0,
              8.1,
              8.2,
              8.3,
              8.4,
              8.5,
              8.6,
              8.7,
              8.8,
              8.9,
              9,
              9.0,
              9.1,
              9.2,
              9.3,
              9.4,
              9.5,
              9.6,
              9.7,
              9.8,
              9.9,
              10
            ]
          }
        },
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Ref": "SecurityNotificationsTopic"
            },
            "Id": "SecurityNotificationTarget"
          }
        ]
      }
    },
    "SecurityHubEventRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "securityhub-critical-findings-${EnvironmentSuffix}"
        },
        "Description": "Captures critical Security Hub findings",
        "EventPattern": {
          "source": [
            "aws.securityhub"
          ],
          "detail-type": [
            "Security Hub Findings - Imported"
          ],
          "detail": {
            "findings": {
              "Severity": {
                "Label": [
                  "CRITICAL",
                  "HIGH"
                ]
              }
            }
          }
        },
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Ref": "SecurityNotificationsTopic"
            },
            "Id": "SecurityHubNotificationTarget"
          }
        ]
      }
    },
    "TurnAroundPromptTable": {
      "Type": "AWS::DynamoDB::Table",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TableName": {
          "Fn::Sub": "TurnAroundPromptTable${EnvironmentSuffix}"
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "id",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "id",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "DeletionProtectionEnabled": false,
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "SSESpecification": {
          "SSEEnabled": true,
          "SSEType": "KMS",
          "KMSMasterKeyId": {
            "Ref": "SecurityServicesKMSKey"
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "TurnAroundPromptTable-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "TurnAroundPromptTableName": {
      "Description": "Name of the DynamoDB table",
      "Value": {
        "Ref": "TurnAroundPromptTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableName"
        }
      }
    },
    "TurnAroundPromptTableArn": {
      "Description": "ARN of the DynamoDB table",
      "Value": {
        "Fn::GetAtt": [
          "TurnAroundPromptTable",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableArn"
        }
      }
    },
    "StackName": {
      "Description": "Name of this CloudFormation stack",
      "Value": {
        "Ref": "AWS::StackName"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackName"
        }
      }
    },
    "EnvironmentSuffix": {
      "Description": "Environment suffix used for this deployment",
      "Value": {
        "Ref": "EnvironmentSuffix"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
        }
      }
    },
    "KMSKeyId": {
      "Description": "KMS Key ID for security services",
      "Value": {
        "Ref": "SecurityServicesKMSKey"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SecurityKMSKey"
        }
      }
    },
    "SecurityHubArn": {
      "Description": "Security Hub ARN",
      "Value": {
        "Ref": "SecurityHub"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SecurityHubArn"
        }
      }
    },
    "SecurityNotificationsTopicArn": {
      "Description": "SNS Topic for security notifications",
      "Value": {
        "Ref": "SecurityNotificationsTopic"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SecurityNotificationsTopic"
        }
      }
    },
    "MacieSessionArn": {
      "Description": "Macie Session ARN",
      "Value": {
        "Fn::If": [
          "ShouldCreateMacie",
          {
            "Ref": "MacieSession"
          },
          "Not Created (disabled or unsupported region)"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-MacieSessionArn"
        }
      }
    },
    "GuardDutyInfo": {
      "Description": "GuardDuty detector information",
      "Value": "Using existing GuardDuty detector in account",
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-GuardDutyInfo"
        }
      }
    },
    "ConfigInfo": {
      "Description": "Config information",
      "Value": "Using existing Config resources in account",
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ConfigInfo"
        }
      }
    },
    "CloudTrailInfo": {
      "Description": "CloudTrail information",
      "Value": "Using existing CloudTrail in account (limit reached)",
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CloudTrailInfo"
        }
      }
    }
  }
}
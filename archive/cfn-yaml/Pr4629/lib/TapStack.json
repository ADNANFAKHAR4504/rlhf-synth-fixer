{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Security and Compliance CloudFormation Template with Multi-Region Support",
    "Parameters": {
        "EnvironmentSuffix": {
            "Description": "Environment suffix for all resources and domain",
            "Type": "String",
            "Default": "dev"
        },
        "DBInstanceClass": {
            "Description": "RDS instance type",
            "Type": "String",
            "Default": "db.t3.micro",
            "AllowedValues": [
                "db.t3.micro",
                "db.t3.small",
                "db.t3.medium"
            ]
        },
        "AllowedIPRange": {
            "Description": "IP range allowed for web access (CIDR notation)",
            "Type": "String",
            "Default": "0.0.0.0/0",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
        }
    },
    "Resources": {
        "MasterKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Master KMS key for ${EnvironmentSuffix} environment"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow AWS services to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "logs.amazonaws.com",
                                    "rds.amazonaws.com",
                                    "dynamodb.amazonaws.com",
                                    "s3.amazonaws.com",
                                    "ec2.amazonaws.com",
                                    "autoscaling.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:GenerateDataKeyWithoutPlaintext",
                                "kms:CreateGrant",
                                "kms:DescribeKey",
                                "kms:ReEncrypt*"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow service-linked roles for AutoScaling and EC2",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": "*"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:GenerateDataKeyWithoutPlaintext",
                                "kms:CreateGrant",
                                "kms:DescribeKey",
                                "kms:ReEncrypt*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringLike": {
                                    "aws:PrincipalArn": [
                                        "arn:aws:iam::*:role/aws-service-role/autoscaling.amazonaws.com/*",
                                        "arn:aws:iam::*:role/aws-service-role/ec2.amazonaws.com/*"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "EnableKeyRotation": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-MasterKey"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "MasterKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentSuffix}-master-key"
                },
                "TargetKeyId": {
                    "Ref": "MasterKMSKey"
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-VPC"
                        }
                    }
                ]
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.1.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-Subnet-1"
                        }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.2.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-Subnet-2"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.10.0/24",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Subnet-1"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.20.0/24",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Subnet-2"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-IGW"
                        }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-Routes"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetRouteTableAssociation1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnetRouteTableAssociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "NATGateway1EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT1-EIP"
                        }
                    }
                ]
            }
        },
        "NATGateway2EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT2-EIP"
                        }
                    }
                ]
            }
        },
        "NATGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGateway1EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT-Gateway-1"
                        }
                    }
                ]
            }
        },
        "NATGateway2": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGateway2EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT-Gateway-2"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Routes-1"
                        }
                    }
                ]
            }
        },
        "PrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway1"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                }
            }
        },
        "PrivateRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Routes-2"
                        }
                    }
                ]
            }
        },
        "PrivateRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway2"
                }
            }
        },
        "PrivateSubnetRouteTableAssociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                }
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": {
                            "Ref": "AllowedIPRange"
                        },
                        "Description": "HTTP access from allowed IP range"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Ref": "AllowedIPRange"
                        },
                        "Description": "HTTPS access from allowed IP range"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "Allow all outbound traffic within VPC"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-ALB-SG"
                        }
                    }
                ]
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for web servers",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "HTTP from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "HTTPS from ALB"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-WebServer-SG"
                        }
                    }
                ]
            }
        },
        "DbSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-credentials"
                },
                "Description": "RDS database credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"admin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 16,
                    "ExcludeCharacters": "\"@/\\"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-secret"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CentralizedLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentSuffix}-centralized-logs-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "MasterKMSKey"
                                }
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 90
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-CentralLogs"
                        }
                    }
                ]
            }
        },
        "CentralizedLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "CentralizedLogsBucket"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "CentralizedLogsBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${CentralizedLogsBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ApplicationDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentSuffix}-app-data-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "MasterKMSKey"
                                }
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                }
                            ]
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 90,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        },
                        {
                            "Id": "TransitionToDeepArchive",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 180,
                                    "StorageClass": "DEEP_ARCHIVE"
                                }
                            ]
                        },
                        {
                            "Id": "DeleteOldVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 365
                        },
                        {
                            "Id": "DeleteIncompleteUploads",
                            "Status": "Enabled",
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 7
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-AppData"
                        }
                    }
                ]
            }
        },
        "CloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": [
                "CentralizedLogsBucketPolicy"
            ],
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${EnvironmentSuffix}-trail"
                },
                "S3BucketName": {
                    "Ref": "CentralizedLogsBucket"
                },
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true,
                        "DataResources": [
                            {
                                "Type": "AWS::S3::Object",
                                "Values": [
                                    {
                                        "Fn::Sub": "${ApplicationDataBucket.Arn}/"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "InsightSelectors": [
                    {
                        "InsightType": "ApiCallRateInsight"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Trail"
                        }
                    }
                ]
            }
        },
        "ApplicationTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "${EnvironmentSuffix}-app-table"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "timestamp",
                        "AttributeType": "N"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": false
                },
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": {
                        "Ref": "MasterKMSKey"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-DynamoTable"
                        }
                    }
                ]
            }
        },
        "DbSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-subnet-group-new"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS database",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-subnet-group"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for RDS database",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "WebServerSecurityGroup"
                        },
                        "Description": "MySQL access from web servers"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-security-group"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DbParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "DBParameterGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-params"
                },
                "Description": "Parameter group for MySQL database",
                "Family": "mysql8.0",
                "Parameters": {
                    "innodb_buffer_pool_size": "{DBInstanceClassMemory*3/4}"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-parameter-group"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "RDSMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-rds-monitoring-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-rds-monitoring-role"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DbInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentSuffix}-db"
                },
                "DBName": "appdb",
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "AllocatedStorage": 20,
                "MaxAllocatedStorage": 100,
                "StorageType": "gp2",
                "StorageEncrypted": true,
                "BackupRetentionPeriod": 0,
                "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
                "MultiAZ": true,
                "PubliclyAccessible": false,
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DbSecurityGroup"
                    }
                ],
                "DBParameterGroupName": {
                    "Ref": "DbParameterGroup"
                },
                "MasterUsername": {
                    "Fn::Join": [
                        "",
                        [
                            "{{resolve:secretsmanager:",
                            {
                                "Ref": "DbSecret"
                            },
                            ":SecretString:username}}"
                        ]
                    ]
                },
                "MasterUserPassword": {
                    "Fn::Join": [
                        "",
                        [
                            "{{resolve:secretsmanager:",
                            {
                                "Ref": "DbSecret"
                            },
                            ":SecretString:password}}"
                        ]
                    ]
                },
                "EnableIAMDatabaseAuthentication": true,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "RDSMonitoringRole",
                        "Arn"
                    ]
                },
                "DeletionProtection": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-instance"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-ALB"
                },
                "Type": "application",
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-ALB"
                        }
                    }
                ]
            }
        },
        "HTTPSListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 443,
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "Certificate"
                        }
                    }
                ],
                "SslPolicy": "ELBSecurityPolicy-TLS-1-2-2017-01"
            }
        },
        "HTTPListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "Certificate": {
            "Type": "AWS::CertificateManager::Certificate",
            "Properties": {
                "DomainName": {
                    "Fn::Sub": "${EnvironmentSuffix}.ateulerlabs.com"
                },
                "ValidationMethod": "DNS",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Certificate"
                        }
                    }
                ]
            }
        },
        "WebACL": {
            "Type": "AWS::WAFv2::WebACL",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-WebACL"
                },
                "Scope": "REGIONAL",
                "Description": "WAF WebACL for application protection",
                "DefaultAction": {
                    "Allow": {}
                },
                "Rules": [
                    {
                        "Name": "RateLimitRule",
                        "Priority": 1,
                        "Statement": {
                            "RateBasedStatement": {
                                "Limit": 2000,
                                "AggregateKeyType": "IP"
                            }
                        },
                        "Action": {
                            "Block": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "RateLimitRule"
                        }
                    },
                    {
                        "Name": "SQLInjectionRule",
                        "Priority": 2,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesSQLiRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "SQLInjectionRule"
                        }
                    },
                    {
                        "Name": "XSSProtectionRule",
                        "Priority": 3,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "XSSProtectionRule"
                        }
                    }
                ],
                "VisibilityConfig": {
                    "SampledRequestsEnabled": true,
                    "CloudWatchMetricsEnabled": true,
                    "MetricName": {
                        "Fn::Sub": "${EnvironmentSuffix}-WebACL"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-WebACL"
                        }
                    }
                ]
            }
        },
        "WebACLAssociation": {
            "Type": "AWS::WAFv2::WebACLAssociation",
            "Properties": {
                "ResourceArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "WebACLArn": {
                    "Fn::GetAtt": [
                        "WebACL",
                        "Arn"
                    ]
                }
            }
        },
        "SecurityMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-SecurityMonitoringRole"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecurityMonitoringPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-LambdaRole"
                        }
                    }
                ]
            }
        },
        "SecurityMonitoringFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentSuffix}-SecurityMonitor"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "SecurityMonitoringRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport os\n# import requests  # Uncomment for Resend integration\n\ndef handler(event, context):\n    environment = os.environ['ENVIRONMENT']\n    \n    # Parse EventBridge event\n    detail = event.get('detail', {})\n    event_name = detail.get('eventName', 'Unknown')\n    event_source = detail.get('eventSource', 'Unknown')\n    user_identity = detail.get('userIdentity', {})\n    \n    # Create alert message\n    alert_message = {\n        'Environment': environment,\n        'Event': event_name,\n        'Source': event_source,\n        'UserIdentity': user_identity,\n        'Time': event.get('time', 'Unknown'),\n        'Region': event.get('region', 'Unknown'),\n        'Account': event.get('account', 'Unknown')\n    }\n    \n    # Format alert text\n    alert_text = f\"\"\"\n    ðŸš¨ SECURITY ALERT ðŸš¨\n    \n    Event: {event_name}\n    Environment: {environment}\n    Source: {event_source}\n    Time: {alert_message['Time']}\n    Region: {alert_message['Region']}\n    Account: {alert_message['Account']}\n    \n    User Identity: {json.dumps(user_identity, indent=2)}\n    \n    Full Details:\n    {json.dumps(alert_message, indent=2)}\n    \"\"\"\n    \n    # Print alert (visible in CloudWatch Logs)\n    print(alert_text)\n    \n    # Commented out Resend email logic (for demonstration)\n    send_email = False  # to email sending\n    if send_email:\n        # resend_api_key = os.environ.get('RESEND_API_KEY')\n        # if resend_api_key:\n        #     try:\n        #         response = requests.post(\n        #             'https://api.resend.com/emails',\n        #             headers={\n        #                 'Authorization': f'Bearer {resend_api_key}',\n        #                 'Content-Type': 'application/json'\n        #             },\n        #             json={\n        #                 'from': 'security@yourdomain.com',\n        #                 'to': ['admin@yourdomain.com'],\n        #                 'subject': f'Security Alert: {event_name} in {environment}',\n        #                 'text': alert_text\n        #             }\n        #         )\n        #         print(f'Email sent successfully: {response.status_code}')\n        #     except Exception as e:\n        #         print(f'Failed to send email: {str(e)}')\n        pass\n    \n    return {\n        'statusCode': 200,\n        'body': json.dumps({\n            'message': 'Security alert processed',\n            'alert_details': alert_message,\n            'alert_text': alert_text\n        })\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-SecurityMonitor"
                        }
                    }
                ]
            }
        },
        "SecurityGroupChangeRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-SG-Changes"
                },
                "Description": "Detect Security Group changes",
                "EventPattern": {
                    "source": [
                        "aws.ec2"
                    ],
                    "detail-type": [
                        "AWS API Call via CloudTrail"
                    ],
                    "detail": {
                        "eventSource": [
                            "ec2.amazonaws.com"
                        ],
                        "eventName": [
                            "AuthorizeSecurityGroupIngress",
                            "AuthorizeSecurityGroupEgress",
                            "RevokeSecurityGroupIngress",
                            "RevokeSecurityGroupEgress",
                            "CreateSecurityGroup",
                            "DeleteSecurityGroup"
                        ]
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "SecurityMonitoringFunction",
                                "Arn"
                            ]
                        },
                        "Id": "SecurityMonitoringTarget"
                    }
                ]
            }
        },
        "NACLChangeRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-NACL-Changes"
                },
                "Description": "Detect Network ACL changes",
                "EventPattern": {
                    "source": [
                        "aws.ec2"
                    ],
                    "detail-type": [
                        "AWS API Call via CloudTrail"
                    ],
                    "detail": {
                        "eventSource": [
                            "ec2.amazonaws.com"
                        ],
                        "eventName": [
                            "CreateNetworkAcl",
                            "DeleteNetworkAcl",
                            "CreateNetworkAclEntry",
                            "DeleteNetworkAclEntry",
                            "ReplaceNetworkAclEntry"
                        ]
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "SecurityMonitoringFunction",
                                "Arn"
                            ]
                        },
                        "Id": "NACLMonitoringTarget"
                    }
                ]
            }
        },
        "LambdaInvokePermissionForSGRule": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "SecurityMonitoringFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "SecurityGroupChangeRule",
                        "Arn"
                    ]
                }
            }
        },
        "LambdaInvokePermissionForNACLRule": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "SecurityMonitoringFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "NACLChangeRule",
                        "Arn"
                    ]
                }
            }
        },
        "HighCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentSuffix}-High-CPU"
                },
                "AlarmDescription": "Alert when RDS CPU exceeds 80%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DbInstance"
                        }
                    }
                ]
            }
        },
        "UnauthorizedAPICallsAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Unauthorized-API-Calls"
                },
                "AlarmDescription": "Alert on unauthorized API calls",
                "MetricName": "UnauthorizedAPICalls",
                "Namespace": "CloudTrailMetrics",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "EC2LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "${EnvironmentSuffix}-LaunchTemplate"
                },
                "LaunchTemplateData": {
                    "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                    "InstanceType": "t3.micro",
                    "SecurityGroupIds": [
                        {
                            "Ref": "WebServerSecurityGroup"
                        }
                    ],
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "EC2InstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeSize": 20,
                                "VolumeType": "gp3",
                                "Encrypted": true,
                                "KmsKeyId": {
                                    "Ref": "MasterKMSKey"
                                },
                                "DeleteOnTermination": true
                            }
                        }
                    ],
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash\nyum update -y\nyum install -y python3 python3-pip mysql jq aws-cli openssl\npip3 install pymysql boto3 cryptography\n\n# Get RDS endpoint and credentials\nRDS_ENDPOINT=\"${DbInstance.Endpoint.Address}\"\nSECRET_ARN=\"${DbSecret}\"\nREGION=\"${AWS::Region}\"\nDYNAMODB_TABLE=\"${ApplicationTable}\"\nS3_BUCKET=\"${ApplicationDataBucket}\"\n\n# Create self-signed SSL certificate for HTTPS\nmkdir -p /etc/ssl/certs\nopenssl req -x509 -newkey rsa:4096 -keyout /etc/ssl/certs/server.key -out /etc/ssl/certs/server.crt -days 365 -nodes -subj \"/C=US/ST=State/L=City/O=Organization/CN=localhost\"\n\n# Create Python server script\ncat > /home/ec2-user/server.py << 'EOFPYTHON'\n#!/usr/bin/env python3\nimport pymysql\nimport json\nimport boto3\nimport ssl\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\nimport os\nimport time\nfrom datetime import datetime\n\ndef test_rds_connection():\n    try:\n        # Get credentials from Secrets Manager\n        client = boto3.client('secretsmanager', region_name=os.environ.get('AWS_REGION'))\n        secret_value = client.get_secret_value(SecretId=os.environ.get('SECRET_ARN'))\n        secret = json.loads(secret_value['SecretString'])\n\n        # Test connection\n        connection = pymysql.connect(\n            host=os.environ.get('RDS_ENDPOINT'),\n            user=secret['username'],\n            password=secret['password'],\n            database='appdb',\n            connect_timeout=5\n        )\n\n        # Get MySQL version\n        with connection.cursor() as cursor:\n            cursor.execute(\"SELECT VERSION()\")\n            version = cursor.fetchone()[0]\n\n        connection.close()\n\n        return {\n            'status': 'SUCCESS',\n            'message': 'Connected to RDS successfully',\n            'mysql_version': version,\n            'endpoint': os.environ.get('RDS_ENDPOINT')\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'endpoint': os.environ.get('RDS_ENDPOINT')\n        }\n\ndef test_dynamodb_connection():\n    try:\n        # Create DynamoDB client\n        dynamodb = boto3.resource('dynamodb', region_name=os.environ.get('AWS_REGION'))\n        table = dynamodb.Table(os.environ.get('DYNAMODB_TABLE'))\n\n        # Test write - put a test item\n        test_id = f\"health-check-{int(time.time())}\"\n        test_item = {\n            'id': test_id,\n            'timestamp': int(time.time()),\n            'test_data': 'Connection test',\n            'datetime': datetime.utcnow().isoformat()\n        }\n        table.put_item(Item=test_item)\n\n        # Test read - get the item back\n        response = table.get_item(Key={'id': test_id, 'timestamp': test_item['timestamp']})\n\n        # Test delete - clean up test item\n        table.delete_item(Key={'id': test_id, 'timestamp': test_item['timestamp']})\n\n        return {\n            'status': 'SUCCESS',\n            'message': 'Connected to DynamoDB successfully - Write/Read/Delete operations completed',\n            'table_name': os.environ.get('DYNAMODB_TABLE'),\n            'test_item_id': test_id\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'table_name': os.environ.get('DYNAMODB_TABLE')\n        }\n\ndef test_s3_connection():\n    try:\n        # Create S3 client\n        s3_client = boto3.client('s3', region_name=os.environ.get('AWS_REGION'))\n        bucket_name = os.environ.get('S3_BUCKET')\n\n        # Test list bucket contents (read-only operation)\n        response = s3_client.list_objects_v2(Bucket=bucket_name, MaxKeys=10)\n        \n        # Count objects\n        object_count = response.get('KeyCount', 0)\n        total_size = sum(obj.get('Size', 0) for obj in response.get('Contents', []))\n        \n        # Get bucket location\n        location_response = s3_client.get_bucket_location(Bucket=bucket_name)\n        bucket_region = location_response.get('LocationConstraint') or 'us-east-1'\n\n        return {\n            'status': 'SUCCESS',\n            'message': f'Connected to S3 successfully - Listed bucket contents',\n            'bucket_name': bucket_name,\n            'object_count': object_count,\n            'total_size_bytes': total_size,\n            'bucket_region': bucket_region\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'bucket_name': os.environ.get('S3_BUCKET')\n        }\n\nclass RequestHandler(BaseHTTPRequestHandler):\n    def do_GET(self):\n        if self.path == '/health':\n            # Health check endpoint\n            rds_result = test_rds_connection()\n            dynamodb_result = test_dynamodb_connection()\n            s3_result = test_s3_connection()\n            \n            # All services must be healthy for overall health\n            all_healthy = (rds_result['status'] == 'SUCCESS' and \n                         dynamodb_result['status'] == 'SUCCESS' and \n                         s3_result['status'] == 'SUCCESS')\n            \n            if all_healthy:\n                self.send_response(200)\n                self.send_header('Content-type', 'application/json')\n                self.end_headers()\n                self.wfile.write(json.dumps({\n                    'status': 'healthy', \n                    'rds': 'connected', \n                    'dynamodb': 'connected',\n                    's3': 'connected'\n                }).encode())\n            else:\n                self.send_response(503)\n                self.send_header('Content-type', 'application/json')\n                self.end_headers()\n                self.wfile.write(json.dumps({\n                    'status': 'unhealthy', \n                    'rds': rds_result['status'].lower(), \n                    'dynamodb': dynamodb_result['status'].lower(),\n                    's3': s3_result['status'].lower()\n                }).encode())\n        else:\n            # Main application page\n            rds_result = test_rds_connection()\n            dynamodb_result = test_dynamodb_connection()\n            s3_result = test_s3_connection()\n\n            self.send_response(200)\n            self.send_header('Content-type', 'text/html')\n            self.end_headers()\n\n            html = f\"\"\"\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <title>${EnvironmentSuffix} Environment</title>\n                <style>\n                    body {{ font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }}\n                    .container {{ max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}\n                    .success {{ color: #28a745; font-weight: bold; }}\n                    .failed {{ color: #dc3545; font-weight: bold; }}\n                    .info {{ background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #007bff; }}\n                    .status-badge {{ display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }}\n                    .status-success {{ background: #d4edda; color: #155724; }}\n                    .status-failed {{ background: #f8d7da; color: #721c24; }}\n                    h1 {{ color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }}\n                    h2 {{ color: #555; }}\n                </style>\n            </head>\n            <body>\n                <div class=\"container\">\n                    <h1>${EnvironmentSuffix} Environment - Secure Instance</h1>\n                    <p><strong>Instance Status:</strong> Running in Private Subnet</p>\n                    <p><strong>Security:</strong> HTTPS Enabled, WAF Protected</p>\n\n                    <h2>ðŸ—„ï¸ RDS Database Connection Test</h2>\n                    <div class=\"info\">\n                        <p><strong>Status:</strong> \n                            <span class=\"status-badge status-{rds_result['status'].lower()}\">{rds_result['status']}</span>\n                        </p>\n                        <p><strong>Message:</strong> {rds_result['message']}</p>\n                        <p><strong>Endpoint:</strong> {rds_result.get('endpoint', 'N/A')}</p>\n                        {f\"<p><strong>MySQL Version:</strong> {rds_result.get('mysql_version', 'N/A')}</p>\" if rds_result['status'] == 'SUCCESS' else ''}\n                        <p><strong>Database:</strong> appdb</p>\n                        <p><strong>Security:</strong> Credentials from AWS Secrets Manager</p>\n                    </div>\n\n                    <h2>âš¡ DynamoDB Connection Test</h2>\n                    <div class=\"info\">\n                        <p><strong>Status:</strong> \n                            <span class=\"status-badge status-{dynamodb_result['status'].lower()}\">{dynamodb_result['status']}</span>\n                        </p>\n                        <p><strong>Message:</strong> {dynamodb_result['message']}</p>\n                        <p><strong>Table Name:</strong> {dynamodb_result.get('table_name', 'N/A')}</p>\n                        {f\"<p><strong>Test Item ID:</strong> {dynamodb_result.get('test_item_id', 'N/A')}</p>\" if dynamodb_result['status'] == 'SUCCESS' else ''}\n                        <p><strong>Operations:</strong> Write/Read/Delete tested</p>\n                        <p><strong>Security:</strong> KMS encryption at rest</p>\n                    </div>\n\n                    <h2>ðŸª£ S3 Storage Connection Test</h2>\n                    <div class=\"info\">\n                        <p><strong>Status:</strong> \n                            <span class=\"status-badge status-{s3_result['status'].lower()}\">{s3_result['status']}</span>\n                        </p>\n                        <p><strong>Message:</strong> {s3_result['message']}</p>\n                        <p><strong>Bucket Name:</strong> {s3_result.get('bucket_name', 'N/A')}</p>\n                        {f\"<p><strong>Object Count:</strong> {s3_result.get('object_count', 0)}</p>\" if s3_result['status'] == 'SUCCESS' else ''}\n                        {f\"<p><strong>Total Size:</strong> {s3_result.get('total_size_bytes', 0)} bytes</p>\" if s3_result['status'] == 'SUCCESS' else ''}\n                        {f\"<p><strong>Region:</strong> {s3_result.get('bucket_region', 'N/A')}</p>\" if s3_result['status'] == 'SUCCESS' else ''}\n                        <p><strong>Operations:</strong> List bucket contents (read-only)</p>\n                        <p><strong>Security:</strong> KMS encryption, versioning enabled</p>\n                    </div>\n\n                    <h2>ðŸ” Security Features</h2>\n                    <div class=\"info\">\n                        <ul>\n                            <li>âœ… EC2 instance in private subnet</li>\n                            <li>âœ… Database credentials from Secrets Manager</li>\n                            <li>âœ… KMS encryption for data at rest (RDS + DynamoDB + S3)</li>\n                            <li>âœ… S3 bucket versioning and public access blocked</li>\n                            <li>âœ… VPC security groups for network isolation</li>\n                            <li>âœ… Multi-AZ RDS deployment</li>\n                            <li>âœ… SSL/TLS encryption in transit</li>\n                            <li>âœ… IAM least-privilege access</li>\n                        </ul>\n                    </div>\n\n                    <p><small>Health check available at: <a href=\"/health\">/health</a></small></p>\n                </div>\n            </body>\n            </html>\n            \"\"\"\n            \n            self.wfile.write(html.encode())\n    \n    def log_message(self, format, *args):\n        pass\n\nif __name__ == '__main__':\n    import threading\n    \n    def start_https_server():\n        # Create SSL context\n        context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)\n        context.load_cert_chain('/etc/ssl/certs/server.crt', '/etc/ssl/certs/server.key')\n        \n        # Create HTTPS server\n        https_server = HTTPServer(('0.0.0.0', 443), RequestHandler)\n        https_server.socket = context.wrap_socket(https_server.socket, server_side=True)\n        \n        print('HTTPS Server started on port 443')\n        https_server.serve_forever()\n    \n    def start_http_server():\n        # Create HTTP server\n        http_server = HTTPServer(('0.0.0.0', 80), RequestHandler)\n        print('HTTP Server started on port 80')\n        http_server.serve_forever()\n    \n    # Start HTTPS server in a separate thread\n    https_thread = threading.Thread(target=start_https_server)\n    https_thread.daemon = True\n    https_thread.start()\n    \n    # Start HTTP server in main thread\n    start_http_server()\nEOFPYTHON\n\n# Set environment variables and run server\nexport RDS_ENDPOINT=\"$RDS_ENDPOINT\"\nexport SECRET_ARN=\"$SECRET_ARN\"\nexport AWS_REGION=\"$REGION\"\nexport DYNAMODB_TABLE=\"$DYNAMODB_TABLE\"\nexport S3_BUCKET=\"$S3_BUCKET\"\n\n# Make script executable and run\nchmod +x /home/ec2-user/server.py\n\n# Install CloudWatch agent\nwget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm\nrpm -U ./amazon-cloudwatch-agent.rpm\n\n# Start the Python server\nnohup python3 /home/ec2-user/server.py > /var/log/server.log 2>&1 &\n"
                        }
                    },
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "${EnvironmentSuffix}-Instance"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentSuffix"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-EC2Role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "EC2MinimalPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ApplicationDataBucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket",
                                        "s3:GetBucketLocation"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ApplicationDataBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey",
                                        "kms:CreateGrant",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "MasterKMSKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DbSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData",
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:DeleteItem",
                                        "dynamodb:Query",
                                        "dynamodb:Scan"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ApplicationTable",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-EC2Role"
                        }
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": {
                    "Fn::Sub": "${EnvironmentSuffix}-EC2Profile"
                },
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "TargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-TG"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "HealthCheckEnabled": true,
                "HealthCheckPath": "/health",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-TargetGroup"
                        }
                    }
                ]
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AutoScalingGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-ASG"
                },
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "EC2LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "EC2LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": 1,
                "MaxSize": 3,
                "DesiredCapacity": 2,
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "TargetGroupARNs": [
                    {
                        "Ref": "TargetGroup"
                    }
                ],
                "HealthCheckType": "ELB",
                "HealthCheckGracePeriod": 300,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Instance"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "PropagateAtLaunch": true
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-VPC-ID"
                }
            }
        },
        "ALBDNSName": {
            "Description": "Application Load Balancer DNS Name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-ALB-DNS"
                }
            }
        },
        "CentralizedLogsBucket": {
            "Description": "Centralized CloudTrail logs bucket",
            "Value": {
                "Ref": "CentralizedLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-Logs-Bucket"
                }
            }
        },
        "KMSKeyId": {
            "Description": "Master KMS Key ID",
            "Value": {
                "Ref": "MasterKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-KMS-Key"
                }
            }
        },
        "RDSDatabaseEndpoint": {
            "Description": "RDS Database Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "DbInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-DB-Endpoint"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "DynamoDB Table Name",
            "Value": {
                "Ref": "ApplicationTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-DynamoDB-Table"
                }
            }
        }
    }
}
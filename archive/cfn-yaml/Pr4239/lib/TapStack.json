{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Batch Processing System for Financial Transactions with Complete Audit Trail and Monitoring",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "Default": "dev"
    },
    "NotificationEmail": {
      "Type": "String",
      "Description": "Email address for SNS notifications",
      "Default": "admin@example.com",
      "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
      "ConstraintDescription": "Must be a valid email address"
    },
    "MaxvCpus": {
      "Type": "Number",
      "Description": "Maximum vCPUs for batch compute environment",
      "Default": 256,
      "MinValue": 16,
      "MaxValue": 512
    },
    "JobTimeout": {
      "Type": "Number",
      "Description": "Job timeout in seconds",
      "Default": 14400,
      "MinValue": 3600,
      "MaxValue": 28800
    }
  },
  "Resources": {
    "TransactionDataBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "ArchiveOldData",
              "Status": "Enabled",
              "Transitions": [
                {
                  "TransitionInDays": 90,
                  "StorageClass": "GLACIER"
                }
              ],
              "ExpirationInDays": 2555
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "ProcessedDataBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "processeddata-${EnvironmentSuffix}-${AWS::AccountId}"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "JobStatusTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Sub": "job-status-${EnvironmentSuffix}"
        },
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "jobId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "submittedAt",
            "AttributeType": "N"
          },
          {
            "AttributeName": "status",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "jobId",
            "KeyType": "HASH"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "StatusIndex",
            "KeySchema": [
              {
                "AttributeName": "status",
                "KeyType": "HASH"
              },
              {
                "AttributeName": "submittedAt",
                "KeyType": "RANGE"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          }
        ],
        "StreamSpecification": {
          "StreamViewType": "NEW_AND_OLD_IMAGES"
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "AuditLogTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Sub": "audit-log-${EnvironmentSuffix}"
        },
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "auditId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "timestamp",
            "AttributeType": "N"
          },
          {
            "AttributeName": "jobId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "auditId",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "timestamp",
            "KeyType": "RANGE"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "JobIdIndex",
            "KeySchema": [
              {
                "AttributeName": "jobId",
                "KeyType": "HASH"
              },
              {
                "AttributeName": "timestamp",
                "KeyType": "RANGE"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          }
        ],
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "BatchProcessingTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "batchprocessing-alerts-${EnvironmentSuffix}"
        },
        "DisplayName": "Batch Processing Alerts",
        "Subscription": [
          {
            "Endpoint": {
              "Ref": "NotificationEmail"
            },
            "Protocol": "email"
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "BatchServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "batch.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole"
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "BatchInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role"
        ],
        "Policies": [
          {
            "PolicyName": "S3Access",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:GetItem",
                    "dynamodb:Query"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "JobStatusTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "AuditLogTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${JobStatusTable.Arn}/index/*"
                    },
                    {
                      "Fn::Sub": "${AuditLogTable.Arn}/index/*"
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "BatchInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          {
            "Ref": "BatchInstanceRole"
          }
        ]
      }
    },
    "BatchJobRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "BatchJobPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:GetItem",
                    "dynamodb:Query"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "JobStatusTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "AuditLogTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${JobStatusTable.Arn}/index/*"
                    },
                    {
                      "Fn::Sub": "${AuditLogTable.Arn}/index/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:Publish"
                  ],
                  "Resource": {
                    "Ref": "BatchProcessingTopic"
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "LambdaPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "batch:SubmitJob",
                    "batch:DescribeJobs",
                    "batch:TerminateJob",
                    "batch:ListJobs"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}"
                    },
                    {
                      "Fn::Sub": "arn:aws:s3:::processeddata-${EnvironmentSuffix}-${AWS::AccountId}/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:GetItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "JobStatusTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "AuditLogTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${JobStatusTable.Arn}/index/*"
                    },
                    {
                      "Fn::Sub": "${AuditLogTable.Arn}/index/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:Publish"
                  ],
                  "Resource": {
                    "Ref": "BatchProcessingTopic"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-vpc-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-igw-${EnvironmentSuffix}"
            }
          }
        ]
      }
    },
    "VPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-public-subnet-1-${EnvironmentSuffix}"
            }
          }
        ]
      }
    },
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": {
          "Fn::Select": [
            1,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-public-subnet-2-${EnvironmentSuffix}"
            }
          }
        ]
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-public-rt-${EnvironmentSuffix}"
            }
          }
        ]
      }
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "VPCGatewayAttachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "SubnetRouteTableAssociation1": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet1"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },
    "SubnetRouteTableAssociation2": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "PublicSubnet2"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      }
    },
    "BatchSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Batch compute environment",
        "VpcId": {
          "Ref": "VPC"
        },
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "batch-sg-${EnvironmentSuffix}"
            }
          }
        ]
      }
    },
    "BatchComputeEnvironment": {
      "Type": "AWS::Batch::ComputeEnvironment",
      "Properties": {
        "ComputeEnvironmentName": {
          "Fn::Sub": "transaction-compute-env-${EnvironmentSuffix}"
        },
        "Type": "MANAGED",
        "State": "ENABLED",
        "ServiceRole": {
          "Fn::GetAtt": [
            "BatchServiceRole",
            "Arn"
          ]
        },
        "ComputeResources": {
          "Type": "EC2",
          "MinvCpus": 0,
          "MaxvCpus": {
            "Ref": "MaxvCpus"
          },
          "DesiredvCpus": 0,
          "InstanceTypes": [
            "optimal"
          ],
          "Subnets": [
            {
              "Ref": "PublicSubnet1"
            },
            {
              "Ref": "PublicSubnet2"
            }
          ],
          "SecurityGroupIds": [
            {
              "Ref": "BatchSecurityGroup"
            }
          ],
          "InstanceRole": {
            "Fn::GetAtt": [
              "BatchInstanceProfile",
              "Arn"
            ]
          },
          "Tags": {
            "Environment": {
              "Ref": "EnvironmentSuffix"
            }
          }
        }
      }
    },
    "BatchJobQueue": {
      "Type": "AWS::Batch::JobQueue",
      "Properties": {
        "JobQueueName": {
          "Fn::Sub": "transaction-job-queue-${EnvironmentSuffix}"
        },
        "State": "ENABLED",
        "Priority": 1,
        "ComputeEnvironmentOrder": [
          {
            "Order": 1,
            "ComputeEnvironment": {
              "Ref": "BatchComputeEnvironment"
            }
          }
        ]
      }
    },
    "BatchJobDefinition": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "transaction-processor-${EnvironmentSuffix}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/transaction-processor:latest"
          },
          "Vcpus": 2,
          "Memory": 4096,
          "JobRoleArn": {
            "Fn::GetAtt": [
              "BatchJobRole",
              "Arn"
            ]
          },
          "Environment": [
            {
              "Name": "JOB_STATUS_TABLE",
              "Value": {
                "Ref": "JobStatusTable"
              }
            },
            {
              "Name": "AUDIT_LOG_TABLE",
              "Value": {
                "Ref": "AuditLogTable"
              }
            },
            {
              "Name": "SOURCE_BUCKET",
              "Value": {
                "Ref": "TransactionDataBucket"
              }
            },
            {
              "Name": "DEST_BUCKET",
              "Value": {
                "Ref": "ProcessedDataBucket"
              }
            },
            {
              "Name": "SNS_TOPIC_ARN",
              "Value": {
                "Ref": "BatchProcessingTopic"
              }
            },
            {
              "Name": "ENVIRONMENT",
              "Value": {
                "Ref": "EnvironmentSuffix"
              }
            }
          ],
          "LogConfiguration": {
            "LogDriver": "awslogs",
            "Options": {
              "awslogs-group": {
                "Fn::Sub": "/aws/batch/transaction-processor-${EnvironmentSuffix}"
              },
              "awslogs-region": {
                "Ref": "AWS::Region"
              },
              "awslogs-stream-prefix": "batch-job",
              "awslogs-create-group": "true"
            }
          }
        },
        "RetryStrategy": {
          "Attempts": 3,
          "EvaluateOnExit": [
            {
              "Action": "RETRY",
              "OnStatusReason": "Host EC2*"
            },
            {
              "Action": "EXIT",
              "OnReason": "*"
            }
          ]
        },
        "Timeout": {
          "AttemptDurationSeconds": {
            "Ref": "JobTimeout"
          }
        }
      }
    },
    "TransactionProcessorLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "transaction-processor-${EnvironmentSuffix}"
        },
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Timeout": 300,
        "MemorySize": 512,
        "Environment": {
          "Variables": {
            "JOB_QUEUE": {
              "Ref": "BatchJobQueue"
            },
            "JOB_DEFINITION": {
              "Ref": "BatchJobDefinition"
            },
            "JOB_STATUS_TABLE": {
              "Ref": "JobStatusTable"
            },
            "AUDIT_LOG_TABLE": {
              "Ref": "AuditLogTable"
            },
            "SNS_TOPIC_ARN": {
              "Ref": "BatchProcessingTopic"
            },
            "ENVIRONMENT": {
              "Ref": "EnvironmentSuffix"
            }
          }
        },
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport os\nimport uuid\nfrom datetime import datetime\nfrom decimal import Decimal\n\nbatch = boto3.client('batch')\ndynamodb = boto3.resource('dynamodb')\nsns = boto3.client('sns')\ncloudwatch = boto3.client('cloudwatch')\n\njob_status_table = dynamodb.Table(os.environ['JOB_STATUS_TABLE'])\naudit_log_table = dynamodb.Table(os.environ['AUDIT_LOG_TABLE'])\n\ndef lambda_handler(event, context):\n    try:\n        for record in event['Records']:\n            bucket = record['s3']['bucket']['name']\n            key = record['s3']['object']['key']\n            \n            job_id = str(uuid.uuid4())\n            timestamp = Decimal(str(datetime.utcnow().timestamp()))\n            \n            response = batch.submit_job(\n                jobName=f'transaction-job-{job_id[:8]}',\n                jobQueue=os.environ['JOB_QUEUE'],\n                jobDefinition=os.environ['JOB_DEFINITION'],\n                containerOverrides={\n                    'environment': [\n                        {'name': 'INPUT_FILE', 'value': f's3://{bucket}/{key}'},\n                        {'name': 'JOB_ID', 'value': job_id}\n                    ]\n                }\n            )\n            \n            batch_job_id = response['jobId']\n            \n            job_status_table.put_item(\n                Item={\n                    'jobId': job_id,\n                    'batchJobId': batch_job_id,\n                    'status': 'SUBMITTED',\n                    'submittedAt': timestamp,\n                    'inputFile': f's3://{bucket}/{key}',\n                    'environment': os.environ['ENVIRONMENT']\n                }\n            )\n            \n            audit_log_table.put_item(\n                Item={\n                    'auditId': str(uuid.uuid4()),\n                    'jobId': job_id,\n                    'timestamp': timestamp,\n                    'action': 'JOB_SUBMITTED',\n                    'details': json.dumps({\n                        'batchJobId': batch_job_id,\n                        'inputFile': f's3://{bucket}/{key}'\n                    }),\n                    'ttl': int(timestamp + 7776000)\n                }\n            )\n            \n            cloudwatch.put_metric_data(\n                Namespace='BatchProcessing',\n                MetricData=[{\n                    'MetricName': 'JobsSubmitted',\n                    'Value': 1,\n                    'Unit': 'Count',\n                    'Dimensions': [{'Name': 'Environment', 'Value': os.environ['ENVIRONMENT']}]\n                }]\n            )\n            \n            print(f'Successfully submitted job {job_id}')\n        \n        return {'statusCode': 200, 'body': json.dumps('Success')}\n        \n    except Exception as e:\n        print(f'Error: {str(e)}')\n        sns.publish(\n            TopicArn=os.environ['SNS_TOPIC_ARN'],\n            Subject='Batch Job Submission Failed',\n            Message=f'Failed to submit batch job: {str(e)}'\n        )\n        raise\n"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "JobMonitorLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "job-monitor-${EnvironmentSuffix}"
        },
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Timeout": 300,
        "MemorySize": 256,
        "Environment": {
          "Variables": {
            "JOB_STATUS_TABLE": {
              "Ref": "JobStatusTable"
            },
            "AUDIT_LOG_TABLE": {
              "Ref": "AuditLogTable"
            },
            "SNS_TOPIC_ARN": {
              "Ref": "BatchProcessingTopic"
            },
            "ENVIRONMENT": {
              "Ref": "EnvironmentSuffix"
            }
          }
        },
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport os\nimport uuid\nfrom datetime import datetime\nfrom decimal import Decimal\n\nbatch = boto3.client('batch')\ndynamodb = boto3.resource('dynamodb')\nsns = boto3.client('sns')\ncloudwatch = boto3.client('cloudwatch')\n\njob_status_table = dynamodb.Table(os.environ['JOB_STATUS_TABLE'])\naudit_log_table = dynamodb.Table(os.environ['AUDIT_LOG_TABLE'])\n\ndef lambda_handler(event, context):\n    try:\n        for status in ['SUBMITTED', 'RUNNING']:\n            response = job_status_table.query(\n                IndexName='StatusIndex',\n                KeyConditionExpression='#status = :status',\n                ExpressionAttributeNames={'#status': 'status'},\n                ExpressionAttributeValues={':status': status}\n            )\n            \n            for item in response['Items']:\n                job_id = item['jobId']\n                batch_job_id = item['batchJobId']\n                \n                job_response = batch.describe_jobs(jobs=[batch_job_id])\n                \n                if job_response['jobs']:\n                    job = job_response['jobs'][0]\n                    new_status = job['status']\n                    timestamp = Decimal(str(datetime.utcnow().timestamp()))\n                    \n                    if new_status != item['status']:\n                        job_status_table.update_item(\n                            Key={'jobId': job_id},\n                            UpdateExpression='SET #status = :status, updatedAt = :timestamp',\n                            ExpressionAttributeNames={'#status': 'status'},\n                            ExpressionAttributeValues={\n                                ':status': new_status,\n                                ':timestamp': timestamp\n                            }\n                        )\n                        \n                        audit_log_table.put_item(\n                            Item={\n                                'auditId': str(uuid.uuid4()),\n                                'jobId': job_id,\n                                'timestamp': timestamp,\n                                'action': f'STATUS_CHANGED_TO_{new_status}',\n                                'details': json.dumps({\n                                    'batchJobId': batch_job_id,\n                                    'previousStatus': item['status']\n                                }),\n                                'ttl': int(timestamp + 7776000)\n                            }\n                        )\n                        \n                        if new_status == 'FAILED':\n                            reason = job.get('statusReason', 'Unknown')\n                            sns.publish(\n                                TopicArn=os.environ['SNS_TOPIC_ARN'],\n                                Subject=f'Batch Job Failed: {job_id}',\n                                Message=f'Job {job_id} failed.\\nReason: {reason}'\n                            )\n                            cloudwatch.put_metric_data(\n                                Namespace='BatchProcessing',\n                                MetricData=[{\n                                    'MetricName': 'JobsFailed',\n                                    'Value': 1,\n                                    'Unit': 'Count',\n                                    'Dimensions': [{'Name': 'Environment', 'Value': os.environ['ENVIRONMENT']}]\n                                }]\n                            )\n                        elif new_status == 'SUCCEEDED':\n                            sns.publish(\n                                TopicArn=os.environ['SNS_TOPIC_ARN'],\n                                Subject=f'Batch Job Completed: {job_id}',\n                                Message=f'Job {job_id} completed successfully.'\n                            )\n                            cloudwatch.put_metric_data(\n                                Namespace='BatchProcessing',\n                                MetricData=[{\n                                    'MetricName': 'JobsSucceeded',\n                                    'Value': 1,\n                                    'Unit': 'Count',\n                                    'Dimensions': [{'Name': 'Environment', 'Value': os.environ['ENVIRONMENT']}]\n                                }]\n                            )\n        \n        return {'statusCode': 200, 'body': json.dumps('Success')}\n    except Exception as e:\n        print(f'Error: {str(e)}')\n        raise\n"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "S3NotificationHelperLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "s3-notification-helper-${EnvironmentSuffix}"
        },
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "S3NotificationHelperRole",
            "Arn"
          ]
        },
        "Timeout": 60,
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport cfnresponse\n\ns3 = boto3.client('s3')\n\ndef lambda_handler(event, context):\n    try:\n        if event['RequestType'] == 'Delete':\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n            return\n        \n        bucket_name = event['ResourceProperties']['BucketName']\n        lambda_arn = event['ResourceProperties']['LambdaArn']\n        prefix = event['ResourceProperties'].get('Prefix', '')\n        \n        notification_config = {\n            'LambdaFunctionConfigurations': [{\n                'LambdaFunctionArn': lambda_arn,\n                'Events': ['s3:ObjectCreated:*'],\n                'Filter': {\n                    'Key': {\n                        'FilterRules': [{'Name': 'prefix', 'Value': prefix}]\n                    }\n                }\n            }]\n        }\n        \n        s3.put_bucket_notification_configuration(\n            Bucket=bucket_name,\n            NotificationConfiguration=notification_config\n        )\n        \n        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n    except Exception as e:\n        print(f'Error: {str(e)}')\n        cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})\n"
        }
      }
    },
    "S3NotificationHelperRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "S3NotificationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:PutBucketNotification",
                    "s3:GetBucketNotification"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "S3InvokeLambdaPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "TransactionProcessorLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "s3.amazonaws.com",
        "SourceAccount": {
          "Ref": "AWS::AccountId"
        },
        "SourceArn": {
          "Fn::Sub": "arn:aws:s3:::transactiondata-${EnvironmentSuffix}-${AWS::AccountId}"
        }
      }
    },
    "S3BucketNotification": {
      "Type": "Custom::S3BucketNotification",
      "DependsOn": [
        "S3InvokeLambdaPermission"
      ],
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "S3NotificationHelperLambda",
            "Arn"
          ]
        },
        "BucketName": {
          "Ref": "TransactionDataBucket"
        },
        "LambdaArn": {
          "Fn::GetAtt": [
            "TransactionProcessorLambda",
            "Arn"
          ]
        },
        "Prefix": "raw/"
      }
    },
    "JobSubmissionAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "batch-job-submission-failures-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when job submissions fail",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {
              "Ref": "TransactionProcessorLambda"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "BatchProcessingTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "JobFailureAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "batch-job-failures-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when batch jobs fail",
        "MetricName": "JobsFailed",
        "Namespace": "BatchProcessing",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "Dimensions": [
          {
            "Name": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "BatchProcessingTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "JobMonitoringRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "job-monitoring-rule-${EnvironmentSuffix}"
        },
        "Description": "Triggers job monitoring Lambda every 5 minutes",
        "ScheduleExpression": "rate(5 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "JobMonitorLambda",
                "Arn"
              ]
            },
            "Id": "JobMonitorTarget"
          }
        ]
      }
    },
    "JobMonitorLambdaPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "JobMonitorLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "JobMonitoringRule",
            "Arn"
          ]
        }
      }
    },
    "BatchProcessingDashboard": {
      "Type": "AWS::CloudWatch::Dashboard",
      "Properties": {
        "DashboardName": {
          "Fn::Sub": "batchprocessing-${EnvironmentSuffix}"
        },
        "DashboardBody": {
          "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\": 0,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"BatchProcessing\", \"JobsSubmitted\", {\"stat\": \"Sum\"}],\n          [\".\", \"JobsSucceeded\", {\"stat\": \"Sum\"}],\n          [\".\", \"JobsFailed\", {\"stat\": \"Sum\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Job Execution Status\",\n        \"period\": 300\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 12,\n      \"y\": 0,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Invocations\", {\"stat\": \"Sum\", \"label\": \"Invocations\"}],\n          [\".\", \"Errors\", {\"stat\": \"Sum\", \"label\": \"Errors\"}],\n          [\".\", \"Duration\", {\"stat\": \"Average\", \"label\": \"Duration (ms)\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Lambda Metrics - Transaction Processor\",\n        \"period\": 300\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\": 6,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/Batch\", \"RunningJobs\", {\"stat\": \"Average\"}],\n          [\".\", \"SubmittedJobs\", {\"stat\": \"Average\"}],\n          [\".\", \"FailedJobs\", {\"stat\": \"Sum\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"AWS Batch Queue Status\",\n        \"period\": 300\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"x\": 12,\n      \"y\": 6,\n      \"width\": 12,\n      \"height\": 6,\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"ConsumedReadCapacityUnits\", {\"stat\": \"Sum\"}],\n          [\".\", \"ConsumedWriteCapacityUnits\", {\"stat\": \"Sum\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Capacity Usage\",\n        \"period\": 300\n      }\n    }\n  ]\n}\n"
        }
      }
    }
  },
  "Outputs": {
    "TransactionDataBucketName": {
      "Description": "S3 bucket for raw transaction data",
      "Value": {
        "Ref": "TransactionDataBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TransactionDataBucket"
        }
      }
    },
    "ProcessedDataBucketName": {
      "Description": "S3 bucket for processed transaction data",
      "Value": {
        "Ref": "ProcessedDataBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ProcessedDataBucket"
        }
      }
    },
    "JobStatusTableName": {
      "Description": "DynamoDB table for job status tracking",
      "Value": {
        "Ref": "JobStatusTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-JobStatusTable"
        }
      }
    },
    "AuditLogTableName": {
      "Description": "DynamoDB table for audit logs",
      "Value": {
        "Ref": "AuditLogTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-AuditLogTable"
        }
      }
    },
    "BatchJobQueueArn": {
      "Description": "ARN of the Batch job queue",
      "Value": {
        "Ref": "BatchJobQueue"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-BatchJobQueue"
        }
      }
    },
    "BatchJobDefinitionArn": {
      "Description": "ARN of the Batch job definition",
      "Value": {
        "Ref": "BatchJobDefinition"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-BatchJobDefinition"
        }
      }
    },
    "TransactionProcessorLambdaArn": {
      "Description": "ARN of the transaction processor Lambda function",
      "Value": {
        "Fn::GetAtt": [
          "TransactionProcessorLambda",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TransactionProcessorLambda"
        }
      }
    },
    "JobMonitorLambdaArn": {
      "Description": "ARN of the job monitor Lambda function",
      "Value": {
        "Fn::GetAtt": [
          "JobMonitorLambda",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-JobMonitorLambda"
        }
      }
    },
    "SNSTopicArn": {
      "Description": "ARN of the SNS topic for notifications",
      "Value": {
        "Ref": "BatchProcessingTopic"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SNSTopic"
        }
      }
    },
    "DashboardURL": {
      "Description": "URL to the CloudWatch Dashboard",
      "Value": {
        "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=batchprocessing-${EnvironmentSuffix}"
      }
    },
    "VPCId": {
      "Description": "VPC ID for the batch processing environment",
      "Value": {
        "Ref": "VPC"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-VPC"
        }
      }
    },
    "ComputeEnvironmentArn": {
      "Description": "ARN of the Batch compute environment",
      "Value": {
        "Ref": "BatchComputeEnvironment"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ComputeEnvironment"
        }
      }
    }
  }
}

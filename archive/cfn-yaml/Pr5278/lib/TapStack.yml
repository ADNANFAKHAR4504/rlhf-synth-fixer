AWSTemplateFormatVersion: '2010-09-09'
Description: >
  TapStack.yml â€” Hub-and-spoke network with AWS Transit Gateway.
  Hub VPC (10.0.0.0/16), 3 spoke VPCs (10.1/10.2/10.3), centralized egress via hub NAT,
  SSM interface endpoints in all VPCs, Route53 private hosted zone, VPC Flow Logs (7 days),
  TGW route tables that prevent spoke-to-spoke. All subnets are /24. Resource names include ENVIRONMENT_SUFFIX.
  Uses 2 AZs (A,B) to satisfy TransitGatewayVpcAttachment.SubnetIds<=2 and keep linter clean.

Parameters:
  EnvironmentName:
    Type: String
    Description: logical environment name (e.g., prod, staging, dev)
    AllowedPattern: '^[a-z0-9-]+$'
    Default: dev
  EnvironmentSuffix:
    Type: String
    Description: suffix appended to resource names to ensure uniqueness (e.g., dev-a1)
    AllowedPattern: '^[a-z0-9-]+$'
    Default: dev-a1
  CostCenter:
    Type: String
    Description: cost center tag value
    AllowedPattern: '^[a-z0-9-]+$'
    Default: cc-001
  Owner:
    Type: String
    Description: owner tag value (team or person)
    AllowedPattern: '^[a-z0-9-]+$'
    Default: netops
  PrivateHostedZoneName:
    Type: String
    Description: Route53 private hosted zone name (must end with a dot)
    AllowedPattern: '^[a-z0-9.-]+\.$'
    Default: internal.local.

Mappings:
  Cidrs:
    Hub:
      Vpc: 10.0.0.0/16
      PubA: 10.0.1.0/24
      PubB: 10.0.2.0/24
      PrvA: 10.0.101.0/24
      PrvB: 10.0.102.0/24
    Spoke1:
      Vpc: 10.1.0.0/16
      PrvA: 10.1.101.0/24
      PrvB: 10.1.102.0/24
    Spoke2:
      Vpc: 10.2.0.0/16
      PrvA: 10.2.101.0/24
      PrvB: 10.2.102.0/24
    Spoke3:
      Vpc: 10.3.0.0/16
      PrvA: 10.3.101.0/24
      PrvB: 10.3.102.0/24

Resources:

  # ------------------- Transit Gateway -------------------
  Tgw:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: !Sub 'tgw-${EnvironmentSuffix}'
      DnsSupport: enable
      VpnEcmpSupport: enable
      MulticastSupport: disable
      DefaultRouteTableAssociation: disable
      DefaultRouteTablePropagation: disable
      Tags:
        - Key: Name
          Value: !Sub 'tgw-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  TgwHubRt:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref Tgw
      Tags:
        - Key: Name
          Value: !Sub 'tgw-hub-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  TgwSpokeRt:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref Tgw
      Tags:
        - Key: Name
          Value: !Sub 'tgw-spoke-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  # ------------------- Hub VPC -------------------
  HubVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [Cidrs, Hub, Vpc]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: !Sub 'hub-vpc-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubIgw:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 'hub-igw-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubIgwAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref HubIgw
      VpcId: !Ref HubVpc

  HubPubA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HubVpc
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Hub, PubA]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'hub-pub-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: public

  HubPubB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HubVpc
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Hub, PubB]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'hub-pub-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: public

  HubPrvA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HubVpc
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Hub, PrvA]
      Tags:
        - Key: Name
          Value: !Sub 'hub-prv-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  HubPrvB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HubVpc
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Hub, PrvB]
      Tags:
        - Key: Name
          Value: !Sub 'hub-prv-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  HubPublicRt:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HubVpc
      Tags:
        - Key: Name
          Value: !Sub 'hub-public-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubPublicRtIgwDefault:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref HubPublicRt
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref HubIgw
    DependsOn: HubIgwAttachment

  HubPubARTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref HubPublicRt
      SubnetId: !Ref HubPubA

  HubPubBRTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref HubPublicRt
      SubnetId: !Ref HubPubB

  HubEipA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub 'hub-eip-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubNatA:
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId: !Ref HubPubA
      AllocationId: !GetAtt HubEipA.AllocationId
      Tags:
        - Key: Name
          Value: !Sub 'hub-nat-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubEipB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub 'hub-eip-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubNatB:
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId: !Ref HubPubB
      AllocationId: !GetAtt HubEipB.AllocationId
      Tags:
        - Key: Name
          Value: !Sub 'hub-nat-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubPrivateRtA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HubVpc
      Tags:
        - Key: Name
          Value: !Sub 'hub-private-a-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubPrivateRtB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HubVpc
      Tags:
        - Key: Name
          Value: !Sub 'hub-private-b-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubPrvARTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref HubPrivateRtA
      SubnetId: !Ref HubPrvA

  HubPrvBRTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref HubPrivateRtB
      SubnetId: !Ref HubPrvB

  HubPrvADefaultToNat:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref HubPrivateRtA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref HubNatA

  HubPrvBDefaultToNat:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref HubPrivateRtB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref HubNatB

  # ------------------- Spoke VPCs -------------------
  Spoke1Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [Cidrs, Spoke1, Vpc]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-vpc-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [Cidrs, Spoke2, Vpc]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-vpc-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [Cidrs, Spoke3, Vpc]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-vpc-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1PrvA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke1Vpc
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke1, PrvA]
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-prv-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke1PrvB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke1Vpc
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke1, PrvB]
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-prv-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke2PrvA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke2Vpc
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke2, PrvA]
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-prv-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke2PrvB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke2Vpc
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke2, PrvB]
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-prv-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke3PrvA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke3Vpc
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke3, PrvA]
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-prv-a-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke3PrvB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Spoke3Vpc
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs:
              Ref: AWS::Region
      CidrBlock: !FindInMap [Cidrs, Spoke3, PrvB]
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-prv-b-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner
        - Key: network-role
          Value: private

  Spoke1PrivateRt:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Spoke1Vpc
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-private-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1PrvARTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke1PrivateRt
      SubnetId: !Ref Spoke1PrvA

  Spoke1PrvBRTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke1PrivateRt
      SubnetId: !Ref Spoke1PrvB

  Spoke2PrivateRt:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Spoke2Vpc
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-private-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2PrvARTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke2PrivateRt
      SubnetId: !Ref Spoke2PrvA

  Spoke2PrvBRTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke2PrivateRt
      SubnetId: !Ref Spoke2PrvB

  Spoke3PrivateRt:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Spoke3Vpc
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-private-rt-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3PrvARTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke3PrivateRt
      SubnetId: !Ref Spoke3PrvA

  Spoke3PrvBRTAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref Spoke3PrivateRt
      SubnetId: !Ref Spoke3PrvB

  # ------------------- Flow Logs (7 days) -------------------
  FlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/network/vpc-flow-logs/${EnvironmentSuffix}'
      RetentionInDays: 7
      Tags:
        - Key: Name
          Value: !Sub 'flow-logs-lg-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  FlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'vpc-flow-logs-role-${EnvironmentSuffix}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: !Sub 'vpc-flow-logs-policy-${EnvironmentSuffix}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: '*'
      Tags:
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubVpcFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      LogGroupName: !Ref FlowLogsLogGroup
      ResourceId: !Ref HubVpc
      ResourceType: VPC
      TrafficType: ALL
      Tags:
        - Key: Name
          Value: !Sub 'hub-vpc-flow-logs-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1VpcFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      LogGroupName: !Ref FlowLogsLogGroup
      ResourceId: !Ref Spoke1Vpc
      ResourceType: VPC
      TrafficType: ALL
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-vpc-flow-logs-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2VpcFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      LogGroupName: !Ref FlowLogsLogGroup
      ResourceId: !Ref Spoke2Vpc
      ResourceType: VPC
      TrafficType: ALL
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-vpc-flow-logs-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3VpcFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      LogGroupName: !Ref FlowLogsLogGroup
      ResourceId: !Ref Spoke3Vpc
      ResourceType: VPC
      TrafficType: ALL
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-vpc-flow-logs-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  # ------------------- TGW Attachments (2 subnets each) -------------------
  HubTgwAttachment:
    Type: AWS::EC2::TransitGatewayVpcAttachment
    Properties:
      TransitGatewayId: !Ref Tgw
      VpcId: !Ref HubVpc
      SubnetIds: [!Ref HubPrvA, !Ref HubPrvB]
      Options:
        DnsSupport: enable
      Tags:
        - Key: Name
          Value: !Sub 'tgw-att-hub-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1TgwAttachment:
    Type: AWS::EC2::TransitGatewayVpcAttachment
    Properties:
      TransitGatewayId: !Ref Tgw
      VpcId: !Ref Spoke1Vpc
      SubnetIds: [!Ref Spoke1PrvA, !Ref Spoke1PrvB]
      Options:
        DnsSupport: enable
      Tags:
        - Key: Name
          Value: !Sub 'tgw-att-spoke1-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2TgwAttachment:
    Type: AWS::EC2::TransitGatewayVpcAttachment
    Properties:
      TransitGatewayId: !Ref Tgw
      VpcId: !Ref Spoke2Vpc
      SubnetIds: [!Ref Spoke2PrvA, !Ref Spoke2PrvB]
      Options:
        DnsSupport: enable
      Tags:
        - Key: Name
          Value: !Sub 'tgw-att-spoke2-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3TgwAttachment:
    Type: AWS::EC2::TransitGatewayVpcAttachment
    Properties:
      TransitGatewayId: !Ref Tgw
      VpcId: !Ref Spoke3Vpc
      SubnetIds: [!Ref Spoke3PrvA, !Ref Spoke3PrvB]
      Options:
        DnsSupport: enable
      Tags:
        - Key: Name
          Value: !Sub 'tgw-att-spoke3-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  # ------------------- TGW Associations & Routes -------------------
  AssocHubToHubRt:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref HubTgwAttachment
      TransitGatewayRouteTableId: !Ref TgwHubRt

  AssocSpoke1ToSpokeRt:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref Spoke1TgwAttachment
      TransitGatewayRouteTableId: !Ref TgwSpokeRt

  AssocSpoke2ToSpokeRt:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref Spoke2TgwAttachment
      TransitGatewayRouteTableId: !Ref TgwSpokeRt

  AssocSpoke3ToSpokeRt:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref Spoke3TgwAttachment
      TransitGatewayRouteTableId: !Ref TgwSpokeRt

  # Hub routes to each spoke in the TGW hub RT
  TgwHubRtToSpoke1:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      TransitGatewayRouteTableId: !Ref TgwHubRt
      DestinationCidrBlock: !FindInMap [Cidrs, Spoke1, Vpc]
      TransitGatewayAttachmentId: !Ref Spoke1TgwAttachment

  TgwHubRtToSpoke2:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      TransitGatewayRouteTableId: !Ref TgwHubRt
      DestinationCidrBlock: !FindInMap [Cidrs, Spoke2, Vpc]
      TransitGatewayAttachmentId: !Ref Spoke2TgwAttachment

  TgwHubRtToSpoke3:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      TransitGatewayRouteTableId: !Ref TgwHubRt
      DestinationCidrBlock: !FindInMap [Cidrs, Spoke3, Vpc]
      TransitGatewayAttachmentId: !Ref Spoke3TgwAttachment

  # Spoke RT has only a route to the hub (prevents spoke-to-spoke)
  TgwSpokeRtToHub:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      TransitGatewayRouteTableId: !Ref TgwSpokeRt
      DestinationCidrBlock: !FindInMap [Cidrs, Hub, Vpc]
      TransitGatewayAttachmentId: !Ref HubTgwAttachment

  # --------- VPC route tables toward TGW (explicitly wait for attachments) ---------
  Spoke1ToHubRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke1PrivateRt
      DestinationCidrBlock: !FindInMap [Cidrs, Hub, Vpc]
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke1TgwAttachment

  Spoke1DefaultToTgw:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke1PrivateRt
      DestinationCidrBlock: 0.0.0.0/0
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke1TgwAttachment

  Spoke2ToHubRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke2PrivateRt
      DestinationCidrBlock: !FindInMap [Cidrs, Hub, Vpc]
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke2TgwAttachment

  Spoke2DefaultToTgw:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke2PrivateRt
      DestinationCidrBlock: 0.0.0.0/0
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke2TgwAttachment

  Spoke3ToHubRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke3PrivateRt
      DestinationCidrBlock: !FindInMap [Cidrs, Hub, Vpc]
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke3TgwAttachment

  Spoke3DefaultToTgw:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref Spoke3PrivateRt
      DestinationCidrBlock: 0.0.0.0/0
      TransitGatewayId: !Ref Tgw
    DependsOn: Spoke3TgwAttachment

  # ------------------- Interface Endpoints (SSM) -------------------
  HubEndpointSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'hub-endpoints-sg-${EnvironmentSuffix}'
      VpcId: !Ref HubVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'hub-endpoints-sg-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1EndpointSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'spoke1-endpoints-sg-${EnvironmentSuffix}'
      VpcId: !Ref Spoke1Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-endpoints-sg-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2EndpointSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'spoke2-endpoints-sg-${EnvironmentSuffix}'
      VpcId: !Ref Spoke2Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-endpoints-sg-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3EndpointSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'spoke3-endpoints-sg-${EnvironmentSuffix}'
      VpcId: !Ref Spoke3Vpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-endpoints-sg-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubSsmEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref HubVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref HubPrvA, !Ref HubPrvB]
      SecurityGroupIds: [!Ref HubEndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'hub-ssm-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubSsmMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref HubVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref HubPrvA, !Ref HubPrvB]
      SecurityGroupIds: [!Ref HubEndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'hub-ssmmessages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  HubEc2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref HubVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref HubPrvA, !Ref HubPrvB]
      SecurityGroupIds: [!Ref HubEndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'hub-ec2messages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1SsmEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke1Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke1PrvA, !Ref Spoke1PrvB]
      SecurityGroupIds: [!Ref Spoke1EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-ssm-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1SsmMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke1Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke1PrvA, !Ref Spoke1PrvB]
      SecurityGroupIds: [!Ref Spoke1EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-ssmmessages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke1Ec2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke1Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke1PrvA, !Ref Spoke1PrvB]
      SecurityGroupIds: [!Ref Spoke1EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke1-ec2messages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2SsmEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke2Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke2PrvA, !Ref Spoke2PrvB]
      SecurityGroupIds: [!Ref Spoke2EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-ssm-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2SsmMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke2Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke2PrvA, !Ref Spoke2PrvB]
      SecurityGroupIds: [!Ref Spoke2EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-ssmmessages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke2Ec2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke2Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke2PrvA, !Ref Spoke2PrvB]
      SecurityGroupIds: [!Ref Spoke2EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke2-ec2messages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3SsmEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke3Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke3PrvA, !Ref Spoke3PrvB]
      SecurityGroupIds: [!Ref Spoke3EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-ssm-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3SsmMessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke3Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke3PrvA, !Ref Spoke3PrvB]
      SecurityGroupIds: [!Ref Spoke3EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-ssmmessages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  Spoke3Ec2MessagesEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref Spoke3Vpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      PrivateDnsEnabled: true
      SubnetIds: [!Ref Spoke3PrvA, !Ref Spoke3PrvB]
      SecurityGroupIds: [!Ref Spoke3EndpointSg]
      Tags:
        - Key: Name
          Value: !Sub 'spoke3-ec2messages-endpoint-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

  # ------------------- Route53 Private Hosted Zone -------------------
  PrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref PrivateHostedZoneName
      VPCs:
        - VPCId: !Ref HubVpc
          VPCRegion: !Ref AWS::Region
        - VPCId: !Ref Spoke1Vpc
          VPCRegion: !Ref AWS::Region
        - VPCId: !Ref Spoke2Vpc
          VPCRegion: !Ref AWS::Region
        - VPCId: !Ref Spoke3Vpc
          VPCRegion: !Ref AWS::Region
      HostedZoneConfig:
        Comment: !Sub 'private-hosted-zone-${EnvironmentSuffix}'
      HostedZoneTags:
        - Key: Name
          Value: !Sub 'phz-${EnvironmentSuffix}'
        - Key: environment
          Value: !Ref EnvironmentName
        - Key: cost-center
          Value: !Ref CostCenter
        - Key: owner
          Value: !Ref Owner

Outputs:
  HubVpcId:
    Description: Hub VPC ID
    Value: !Ref HubVpc
  HubPublicSubnets:
    Description: Hub public subnet IDs (A,B)
    Value: !Join [",", [!Ref HubPubA, !Ref HubPubB]]
  HubPrivateSubnets:
    Description: Hub private subnet IDs (A,B)
    Value: !Join [",", [!Ref HubPrvA, !Ref HubPrvB]]

  Spoke1VpcId:
    Description: Spoke1 VPC ID
    Value: !Ref Spoke1Vpc
  Spoke1PrivateSubnets:
    Description: Spoke1 private subnet IDs (A,B)
    Value: !Join [",", [!Ref Spoke1PrvA, !Ref Spoke1PrvB]]

  Spoke2VpcId:
    Description: Spoke2 VPC ID
    Value: !Ref Spoke2Vpc
  Spoke2PrivateSubnets:
    Description: Spoke2 private subnet IDs (A,B)
    Value: !Join [",", [!Ref Spoke2PrvA, !Ref Spoke2PrvB]]

  Spoke3VpcId:
    Description: Spoke3 VPC ID
    Value: !Ref Spoke3Vpc
  Spoke3PrivateSubnets:
    Description: Spoke3 private subnet IDs (A,B)
    Value: !Join [",", [!Ref Spoke3PrvA, !Ref Spoke3PrvB]]

  TransitGatewayId:
    Description: Transit Gateway ID
    Value: !Ref Tgw
  TgwHubRouteTableId:
    Description: TGW hub route table ID
    Value: !Ref TgwHubRt
  TgwSpokeRouteTableId:
    Description: TGW spoke route table ID
    Value: !Ref TgwSpokeRt

  PrivateHostedZoneId:
    Description: Route53 private hosted zone ID
    Value: !Ref PrivateHostedZone

  FlowLogsLogGroupName:
    Description: CloudWatch log group for VPC Flow Logs
    Value: !Ref FlowLogsLogGroup

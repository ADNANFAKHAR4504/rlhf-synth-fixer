{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "ProjectX Cloud Environment Setup - Complete VPC infrastructure with public/private subnets, EC2 instances, and security controls for a mid-sized tech company's development workflow.\n",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix",
                        "OfficeIpAddress"
                    ]
                },
                {
                    "Label": {
                        "default": "Instance Configuration"
                    },
                    "Parameters": [
                        "InstanceType",
                        "KeyPairName"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
            "AllowedPattern": "^[a-zA-Z0-9]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters",
            "MinLength": 2,
            "MaxLength": 10
        },
        "OfficeIpAddress": {
            "Type": "String",
            "Default": "0.0.0.0/0",
            "Description": "Office IP address for SSH access (CIDR format, e.g., 203.0.113.0/32). Defaults to 0.0.0.0/0 (open access) - please restrict in production!",
            "AllowedPattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/(3[0-2]|[12]?\\d)$",
            "ConstraintDescription": "Must be a valid CIDR format (e.g., 203.0.113.0/32)"
        },
        "InstanceType": {
            "Type": "String",
            "Default": "t3.micro",
            "Description": "EC2 instance type for application servers",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large"
            ],
            "ConstraintDescription": "Must be a valid EC2 instance type"
        },
        "KeyPairName": {
            "Type": "String",
            "Default": "",
            "Description": "Optional: Name of an existing EC2 KeyPair to enable SSH access"
        }
    },
    "Mappings": {
        "AWSRegionAMI": {
            "us-east-1": {
                "AMI": "ami-0c02fb55956c7d316"
            },
            "us-west-2": {
                "AMI": "ami-0892d3c7ee96c0bf7"
            },
            "eu-west-1": {
                "AMI": "ami-0a8e758f5e873d1c1"
            }
        }
    },
    "Conditions": {
        "HasKeyPair": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KeyPairName"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "ProjectXVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-VPC-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXInternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-IGW-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXAttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "InternetGatewayId": {
                    "Ref": "ProjectXInternetGateway"
                }
            }
        },
        "ProjectXPublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Public-Subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "ProjectXPublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Public-Subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "ProjectXPrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "CidrBlock": "10.0.10.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Private-Subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "ProjectXPrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "CidrBlock": "10.0.11.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Private-Subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "ProjectXNATGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "ProjectXAttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-NAT-EIP-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXNATGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "ProjectXNATGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "ProjectXPublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-NAT-Gateway-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXPublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Public-RT-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "ProjectXAttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "ProjectXPublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "ProjectXInternetGateway"
                }
            }
        },
        "ProjectXPublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProjectXPublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "ProjectXPublicRouteTable"
                }
            }
        },
        "ProjectXPublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProjectXPublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "ProjectXPublicRouteTable"
                }
            }
        },
        "ProjectXPrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Private-RT-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "ProjectXPrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "ProjectXNATGateway"
                }
            }
        },
        "ProjectXPrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProjectXPrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "ProjectXPrivateRouteTable"
                }
            }
        },
        "ProjectXPrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProjectXPrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "ProjectXPrivateRouteTable"
                }
            }
        },
        "ProjectXSSHSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "ProjectX-SSH-SG-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for SSH access from office IP",
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "OfficeIpAddress"
                        },
                        "Description": "SSH access from office IP"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-SSH-SG-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXInternalSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "ProjectX-Internal-SG-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for internal communication between resources",
                "VpcId": {
                    "Ref": "ProjectXVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "-1",
                        "SourceSecurityGroupId": {
                            "Ref": "ProjectXSSHSecurityGroup"
                        },
                        "Description": "All traffic from SSH security group"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ProjectX-Internal-SG-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXInternalSecurityGroupSelfIngress": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "ProjectXInternalSecurityGroup"
                },
                "IpProtocol": "-1",
                "SourceSecurityGroupId": {
                    "Ref": "ProjectXInternalSecurityGroup"
                },
                "Description": "Allow all traffic within internal security group"
            }
        },
        "ProjectXLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "ProjectX-LaunchTemplate-${EnvironmentSuffix}"
                },
                "LaunchTemplateData": {
                    "ImageId": {
                        "Fn::FindInMap": [
                            "AWSRegionAMI",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "InstanceType"
                    },
                    "KeyName": {
                        "Fn::If": [
                            "HasKeyPair",
                            {
                                "Ref": "KeyPairName"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    "SecurityGroupIds": [
                        {
                            "Ref": "ProjectXSSHSecurityGroup"
                        },
                        {
                            "Ref": "ProjectXInternalSecurityGroup"
                        }
                    ],
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "ProjectXInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash\nyum update -y\nyum install -y aws-cli\n\n# Install CloudWatch agent\nyum install -y amazon-cloudwatch-agent\n\n# Basic system setup\nhostnamectl set-hostname \"projectx-${EnvironmentSuffix}-$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\"\n"
                        }
                    },
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "ProjectX-Instance-${EnvironmentSuffix}"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentSuffix"
                                    }
                                },
                                {
                                    "Key": "Project",
                                    "Value": "ProjectX"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "ProjectXInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "ProjectX"
                    }
                ]
            }
        },
        "ProjectXInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "ProjectXInstanceRole"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "ID of the VPC",
            "Value": {
                "Ref": "ProjectXVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "PublicSubnet1Id": {
            "Description": "ID of Public Subnet 1",
            "Value": {
                "Ref": "ProjectXPublicSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet1Id"
                }
            }
        },
        "PublicSubnet2Id": {
            "Description": "ID of Public Subnet 2",
            "Value": {
                "Ref": "ProjectXPublicSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet2Id"
                }
            }
        },
        "PrivateSubnet1Id": {
            "Description": "ID of Private Subnet 1",
            "Value": {
                "Ref": "ProjectXPrivateSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet1Id"
                }
            }
        },
        "PrivateSubnet2Id": {
            "Description": "ID of Private Subnet 2",
            "Value": {
                "Ref": "ProjectXPrivateSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet2Id"
                }
            }
        },
        "SSHSecurityGroupId": {
            "Description": "ID of the SSH Security Group",
            "Value": {
                "Ref": "ProjectXSSHSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SSHSecurityGroupId"
                }
            }
        },
        "InternalSecurityGroupId": {
            "Description": "ID of the Internal Security Group",
            "Value": {
                "Ref": "ProjectXInternalSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-InternalSecurityGroupId"
                }
            }
        },
        "NATGatewayId": {
            "Description": "ID of the NAT Gateway",
            "Value": {
                "Ref": "ProjectXNATGateway"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NATGatewayId"
                }
            }
        },
        "StackName": {
            "Description": "Name of this CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StackName"
                }
            }
        },
        "EnvironmentSuffix": {
            "Description": "Environment suffix used for this deployment",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
                }
            }
        }
    }
}
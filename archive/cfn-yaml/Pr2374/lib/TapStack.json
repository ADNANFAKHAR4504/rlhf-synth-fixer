{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-grade secure infrastructure with comprehensive security controls and multi-region support",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "Environment",
                        "PrimaryRegion"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VpcCidr",
                        "PublicSubnetCidr1",
                        "PublicSubnetCidr2",
                        "PrivateSubnetCidr1",
                        "PrivateSubnetCidr2",
                        "CorporateIPRange"
                    ]
                },
                {
                    "Label": {
                        "default": "Security Configuration"
                    },
                    "Parameters": [
                        "NotificationEmail",
                        "EnableCloudTrail",
                        "EnableAWSConfig"
                    ]
                },
                {
                    "Label": {
                        "default": "Database Configuration"
                    },
                    "Parameters": [
                        "DBUsername",
                        "DBPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "Web Configuration"
                    },
                    "Parameters": [
                        "DomainName",
                        "EnableCloudFront"
                    ]
                }
            ]
        },
        "cfn-lint": {
            "config": {
                "ignore_checks": [
                    "W1001",
                    "W1030"
                ]
            }
        }
    },
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Description": "Deployment environment",
            "Default": "production",
            "AllowedValues": [
                "production",
                "staging",
                "development"
            ],
            "ConstraintDescription": "Must be production, staging, or development"
        },
        "PrimaryRegion": {
            "Type": "String",
            "Description": "Primary AWS Region",
            "Default": "us-east-1",
            "AllowedValues": [
                "us-east-1",
                "us-west-2",
                "eu-west-1",
                "ap-southeast-1"
            ]
        },
        "VpcCidr": {
            "Type": "String",
            "Description": "VPC CIDR block",
            "Default": "10.0.0.0/16",
            "AllowedPattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3})/(1[6-9]|2[0-8])$",
            "ConstraintDescription": "Must be a valid CIDR block between /16 and /28"
        },
        "PublicSubnetCidr1": {
            "Type": "String",
            "Description": "CIDR block for Public Subnet 1",
            "Default": "10.0.1.0/24",
            "AllowedPattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3})/(1[6-9]|2[0-8])$"
        },
        "PublicSubnetCidr2": {
            "Type": "String",
            "Description": "CIDR block for Public Subnet 2",
            "Default": "10.0.2.0/24",
            "AllowedPattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3})/(1[6-9]|2[0-8])$"
        },
        "PrivateSubnetCidr1": {
            "Type": "String",
            "Description": "CIDR block for Private Subnet 1",
            "Default": "10.0.10.0/24",
            "AllowedPattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3})/(1[6-9]|2[0-8])$"
        },
        "PrivateSubnetCidr2": {
            "Type": "String",
            "Description": "CIDR block for Private Subnet 2",
            "Default": "10.0.20.0/24",
            "AllowedPattern": "^(([0-9]{1,3}\\.){3}[0-9]{1,3})/(1[6-9]|2[0-8])$"
        },
        "CorporateIPRange": {
            "Type": "String",
            "Default": "203.0.113.0/24",
            "Description": "Corporate IP range for SSH access",
            "AllowedPattern": "^(\\d{1,3}\\.){3}\\d{1,3}\\/\\d{1,2}$"
        },
        "NotificationEmail": {
            "Type": "String",
            "Description": "Email address for security notifications",
            "AllowedPattern": "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",
            "Default": "security@example.com"
        },
        "DBUsername": {
            "Type": "String",
            "Description": "Database master username",
            "Default": "dbadmin",
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*"
        },
        "DBPassword": {
            "Type": "String",
            "Description": "Database master password",
            "Default": "SecurePassword123",
            "NoEcho": true,
            "MinLength": 8,
            "MaxLength": 41,
            "AllowedPattern": "[a-zA-Z0-9]*"
        },
        "DomainName": {
            "Type": "String",
            "Description": "Domain name for SSL certificate",
            "Default": "example.com"
        },
        "EnableCloudTrail": {
            "Type": "String",
            "Description": "Enable CloudTrail creation",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "EnableAWSConfig": {
            "Type": "String",
            "Description": "Enable AWS Config resources",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "EnableCloudFront": {
            "Type": "String",
            "Description": "Enable CloudFront distribution",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "EnableNatGateway": {
            "Type": "String",
            "Description": "Enable creation of a new NAT Gateway when no ExistingNatGatewayId is provided",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "CreateDetector": {
            "Type": "String",
            "Description": "Set to true to create a new GuardDuty detector; set false to skip.",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "ExistingKMSKeyArn": {
            "Type": "String",
            "Description": "If provided, use this KMS Key ARN instead of creating a new one.",
            "Default": "",
            "AllowedValues": [
                "",
                "placeholder-arn"
            ]
        },
        "ExistingDBSubnetGroupName": {
            "Type": "String",
            "Description": "If provided, use this DB Subnet Group name instead of creating a new one.",
            "Default": ""
        },
        "ExistingCloudTrailBucketName": {
            "Type": "String",
            "Description": "If provided, use this S3 bucket name for CloudTrail logs instead of creating a new one.",
            "Default": ""
        },
        "ExistingKMSKeyAlias": {
            "Type": "String",
            "Description": "If provided, use this existing KMS alias name (e.g., alias/production-encryption-key) and do not create a new alias.",
            "Default": ""
        },
        "ExistingGuardDutyCheckFunctionArn": {
            "Type": "String",
            "Description": "If provided, use this existing Lambda ARN for GuardDuty detector check and do not create a new function.",
            "Default": ""
        },
        "ExistingNatGatewayId": {
            "Type": "String",
            "Description": "If provided, use this existing NAT Gateway ID and do not create a new one.",
            "Default": ""
        },
        "ExistingALBDNSName": {
            "Type": "String",
            "Description": "If provided, use this existing ALB DNS name and do not create a new ALB.",
            "Default": ""
        },
        "ExistingCertificateArn": {
            "Type": "String",
            "Description": "If provided, use this existing ACM certificate ARN and do not create a new certificate.",
            "Default": "",
            "AllowedPattern": "^$|^arn:aws:acm:us-east-1:[0-9]{12}:certificate/.+"
        },
        "HostedZoneId": {
            "Type": "String",
            "Description": "Route53 Hosted Zone ID for DomainName (optional, used to auto-create DNS validation records)",
            "Default": ""
        },
        "ExistingConfigRecorderName": {
            "Type": "String",
            "Description": "If provided, use this existing AWS Config recorder name and do not create a new one.",
            "Default": ""
        },
        "ExistingConfigDeliveryChannelName": {
            "Type": "String",
            "Description": "If provided, use this existing AWS Config delivery channel name and do not create a new one.",
            "Default": ""
        },
        "CreateAWSConfigResources": {
            "Type": "String",
            "Description": "Set to true to create AWS Config recorder and delivery channel; false to skip.",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "EnableDBSubnetGroupCreation": {
            "Type": "String",
            "Description": "Set to true to create a new DB Subnet Group when no existing name is provided.",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "ExistingDBInstanceIdentifier": {
            "Type": "String",
            "Description": "If provided, use this existing RDS DB instance and do not create a new one.",
            "Default": ""
        },
        "ExistingRDSEndpointAddress": {
            "Type": "String",
            "Description": "Endpoint address of the existing RDS instance (used when not creating a new one).",
            "Default": ""
        },
        "CreateKMSResources": {
            "Type": "String",
            "Description": "Set to true to allow creating new KMS Key and Alias; set false to always use existing.",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        }
    },
    "Conditions": {
        "IsPrimaryRegion": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                {
                    "Ref": "PrimaryRegion"
                }
            ]
        },
        "EnableCloudTrailCondition": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableCloudTrail"
                        },
                        "true"
                    ]
                },
                {
                    "Condition": "IsPrimaryRegion"
                }
            ]
        },
        "EnableAWSConfigCondition": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableAWSConfig"
                        },
                        "true"
                    ]
                },
                {
                    "Condition": "IsPrimaryRegion"
                }
            ]
        },
        "EnableCloudFrontCondition": {
            "Fn::Equals": [
                {
                    "Ref": "EnableCloudFront"
                },
                "true"
            ]
        },
        "CreateKMSKey": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateKMSResources"
                        },
                        "true"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingKMSKeyArn"
                        },
                        ""
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingKMSKeyAlias"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasKmsKey": {
            "Fn::Or": [
                {
                    "Condition": "CreateKMSKey"
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "ExistingKMSKeyArn"
                                },
                                ""
                            ]
                        }
                    ]
                }
            ]
        },
        "CreateDBSubnetGroup": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingDBSubnetGroupName"
                        },
                        ""
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableDBSubnetGroupCreation"
                        },
                        "true"
                    ]
                }
            ]
        },
        "CreateCloudTrailBucket": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingCloudTrailBucketName"
                },
                ""
            ]
        },
        "CreateKMSKeyAlias": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateKMSResources"
                        },
                        "true"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingKMSKeyAlias"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateGuardDutyCheckFunction": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingGuardDutyCheckFunctionArn"
                },
                ""
            ]
        },
        "CreateNatGateway": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingNatGatewayId"
                        },
                        ""
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableNatGateway"
                        },
                        "true"
                    ]
                }
            ]
        },
        "UseExistingNatGateway": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingNatGatewayId"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreatePrivateDefaultRoute": {
            "Fn::Or": [
                {
                    "Condition": "CreateNatGateway"
                },
                {
                    "Condition": "UseExistingNatGateway"
                }
            ]
        },
        "CreateALB": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingALBDNSName"
                },
                ""
            ]
        },
        "IsUsEast1": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-east-1"
            ]
        },
        "CreateCertificate": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingCertificateArn"
                        },
                        ""
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "HostedZoneId"
                                },
                                ""
                            ]
                        }
                    ]
                },
                {
                    "Condition": "IsUsEast1"
                }
            ]
        },
        "HasCertificateArn": {
            "Fn::Or": [
                {
                    "Condition": "CreateCertificate"
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "ExistingCertificateArn"
                                },
                                ""
                            ]
                        }
                    ]
                }
            ]
        },
        "CreateGuardDuty": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateDetector"
                        },
                        "true"
                    ]
                },
                {
                    "Condition": "IsPrimaryRegion"
                }
            ]
        },
        "CreateConfigRecorder": {
            "Fn::And": [
                {
                    "Condition": "EnableAWSConfigCondition"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateAWSConfigResources"
                        },
                        "true"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingConfigRecorderName"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateConfigDeliveryChannel": {
            "Fn::And": [
                {
                    "Condition": "EnableAWSConfigCondition"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateAWSConfigResources"
                        },
                        "true"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingConfigDeliveryChannelName"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateDBInstance": {
            "Fn::Equals": [
                {
                    "Ref": "ExistingDBInstanceIdentifier"
                },
                ""
            ]
        },
        "HasExistingDBSubnetGroupName": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingDBSubnetGroupName"
                        },
                        ""
                    ]
                }
            ]
        },
        "CanUseDBSubnetGroup": {
            "Fn::Or": [
                {
                    "Condition": "CreateDBSubnetGroup"
                },
                {
                    "Condition": "HasExistingDBSubnetGroupName"
                }
            ]
        },
        "CreateDBInstanceEffective": {
            "Fn::And": [
                {
                    "Condition": "CreateDBInstance"
                },
                {
                    "Condition": "CanUseDBSubnetGroup"
                }
            ]
        },
        "HasExistingRDSEndpointAddress": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingRDSEndpointAddress"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasExistingConfigRecorderName": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingConfigRecorderName"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasExistingKMSKeyAlias": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingKMSKeyAlias"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "ProdVPC": {
            "Type": "AWS::EC2::VPC",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-vpc"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdInternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-igw"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdVPCGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "InternetGatewayId": {
                    "Ref": "ProdInternetGateway"
                }
            }
        },
        "ProdPublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCidr1"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-public-subnet-1"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCidr2"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-public-subnet-2"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCidr1"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-private-subnet-1"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCidr2"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-private-subnet-2"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdEIPForNAT": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "ProdVPCGatewayAttachment",
            "Condition": "CreateNatGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-nat-eip"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdNATGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Condition": "CreateNatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "ProdEIPForNAT",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "ProdPublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-nat-gateway"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-public-rt"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-private-rt"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "ProdVPCGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "ProdPublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "ProdInternetGateway"
                }
            }
        },
        "ProdPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Condition": "CreatePrivateDefaultRoute",
            "Properties": {
                "RouteTableId": {
                    "Ref": "ProdPrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Fn::If": [
                        "CreateNatGateway",
                        {
                            "Ref": "ProdNATGateway"
                        },
                        {
                            "Ref": "ExistingNatGatewayId"
                        }
                    ]
                }
            }
        },
        "ProdPublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProdPublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "ProdPublicRouteTable"
                }
            }
        },
        "ProdPublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProdPublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "ProdPublicRouteTable"
                }
            }
        },
        "ProdPrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProdPrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "ProdPrivateRouteTable"
                }
            }
        },
        "ProdPrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "ProdPrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "ProdPrivateRouteTable"
                }
            }
        },
        "ProdKMSKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "CreateKMSKey",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS Key for ${Environment} environment encryption"
                },
                "KeySpec": "SYMMETRIC_DEFAULT",
                "KeyUsage": "ENCRYPT_DECRYPT",
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableIAMUserPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowCloudTrail",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowRDS",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey*",
                                "kms:ReEncrypt*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowS3",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "s3.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey*",
                                "kms:ReEncrypt*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowCloudWatch",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-kms-key"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Condition": "CreateKMSKeyAlias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${Environment}-encryption-key"
                },
                "TargetKeyId": {
                    "Ref": "ProdKMSKey"
                }
            }
        },
        "ProdCloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "CreateCloudTrailBucket",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${Environment}-cloudtrail-logs-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "Fn::If": [
                                "HasKmsKey",
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "aws:kms",
                                        "KMSMasterKeyID": {
                                            "Fn::If": [
                                                "CreateKMSKey",
                                                {
                                                    "Fn::GetAtt": [
                                                        "ProdKMSKey",
                                                        "Arn"
                                                    ]
                                                },
                                                {
                                                    "Ref": "ExistingKMSKeyArn"
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "AES256"
                                    }
                                }
                            ]
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-cloudtrail-bucket"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${Environment}-config-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "Fn::If": [
                                "HasKmsKey",
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "aws:kms",
                                        "KMSMasterKeyID": {
                                            "Fn::If": [
                                                "CreateKMSKey",
                                                {
                                                    "Fn::GetAtt": [
                                                        "ProdKMSKey",
                                                        "Arn"
                                                    ]
                                                },
                                                {
                                                    "Ref": "ExistingKMSKeyArn"
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "AES256"
                                    }
                                }
                            ]
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-config-bucket"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdApplicationBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${Environment}-application-data-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "Fn::If": [
                                "HasKmsKey",
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "aws:kms",
                                        "KMSMasterKeyID": {
                                            "Fn::If": [
                                                "CreateKMSKey",
                                                {
                                                    "Fn::GetAtt": [
                                                        "ProdKMSKey",
                                                        "Arn"
                                                    ]
                                                },
                                                {
                                                    "Ref": "ExistingKMSKeyArn"
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    "ServerSideEncryptionByDefault": {
                                        "SSEAlgorithm": "AES256"
                                    }
                                }
                            ]
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-application-bucket"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdCloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "CreateCloudTrailBucket",
            "Properties": {
                "Bucket": {
                    "Ref": "ProdCloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ProdCloudTrailBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ProdCloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "DenyInsecureTransport",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "ProdCloudTrailBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${ProdCloudTrailBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ProdCloudTrailLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/cloudtrail/${Environment}-trail"
                },
                "RetentionInDays": 365,
                "KmsKeyId": {
                    "Fn::If": [
                        "HasKmsKey",
                        {
                            "Fn::If": [
                                "CreateKMSKey",
                                {
                                    "Fn::GetAtt": [
                                        "ProdKMSKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Ref": "ExistingKMSKeyArn"
                                }
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-cloudtrail-logs"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdCloudTrailRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:PutLogEvents",
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ProdCloudTrailLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-cloudtrail-role"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "Condition": "EnableCloudTrailCondition",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${Environment}-cloudtrail"
                },
                "S3BucketName": {
                    "Fn::If": [
                        "CreateCloudTrailBucket",
                        {
                            "Ref": "ProdCloudTrailBucket"
                        },
                        {
                            "Ref": "ExistingCloudTrailBucketName"
                        }
                    ]
                },
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "IsLogging": true,
                "EnableLogFileValidation": true,
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "ProdCloudTrailLogGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "ProdCloudTrailRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-cloudtrail"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdConfigRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "EnableAWSConfigCondition",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWS_ConfigRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "ConfigS3Policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketAcl",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ProdConfigBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:PutObject",
                                    "Resource": {
                                        "Fn::Sub": "${ProdConfigBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
                                    },
                                    "Condition": {
                                        "StringEquals": {
                                            "s3:x-amz-acl": "bucket-owner-full-control"
                                        }
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:GetObject",
                                    "Resource": {
                                        "Fn::Sub": "${ProdConfigBucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-config-role"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdConfigRecorder": {
            "Type": "AWS::Config::ConfigurationRecorder",
            "Condition": "CreateConfigRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${Environment}-config-recorder"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "ProdConfigRole",
                        "Arn"
                    ]
                },
                "RecordingGroup": {
                    "AllSupported": true,
                    "IncludeGlobalResourceTypes": true
                }
            }
        },
        "ProdConfigDeliveryChannel": {
            "Type": "AWS::Config::DeliveryChannel",
            "Condition": "CreateConfigDeliveryChannel",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${Environment}-config-delivery-channel"
                },
                "S3BucketName": {
                    "Ref": "ProdConfigBucket"
                }
            }
        },
        "ProdConfigRuleMFA": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "CreateConfigRecorder",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "${Environment}-iam-user-mfa-enabled"
                },
                "Description": "Checks whether the AWS Identity and Access Management users have multi-factor authentication (MFA) enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "IAM_USER_MFA_ENABLED"
                }
            }
        },
        "ProdConfigRuleEncryptedVolumes": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "CreateConfigRecorder",
            "Properties": {
                "ConfigRuleName": {
                    "Fn::Sub": "${Environment}-encrypted-volumes"
                },
                "Description": "Checks whether EBS volumes are encrypted",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ENCRYPTED_VOLUMES"
                }
            }
        },
        "ProdSecurityNotificationsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${Environment}-security-notifications"
                },
                "DisplayName": {
                    "Fn::Sub": "${Environment} Security Notifications"
                },
                "KmsMasterKeyId": {
                    "Fn::If": [
                        "HasKmsKey",
                        {
                            "Fn::If": [
                                "CreateKMSKey",
                                {
                                    "Fn::GetAtt": [
                                        "ProdKMSKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Ref": "ExistingKMSKeyArn"
                                }
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-security-notifications"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdSecurityNotificationsSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "ProdSecurityNotificationsTopic"
                },
                "Endpoint": {
                    "Ref": "NotificationEmail"
                }
            }
        },
        "ProdSNSTopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "Topics": [
                    {
                        "Ref": "ProdSecurityNotificationsTopic"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudWatchEventsToPublish",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "events.amazonaws.com"
                            },
                            "Action": "sns:Publish",
                            "Resource": {
                                "Ref": "ProdSecurityNotificationsTopic"
                            }
                        }
                    ]
                }
            }
        },
        "ProdUnauthorizedOperationMetricFilter": {
            "Type": "AWS::Logs::MetricFilter",
            "Properties": {
                "LogGroupName": {
                    "Ref": "ProdCloudTrailLogGroup"
                },
                "FilterPattern": "{ ($.errorCode = \"*UnauthorizedOperation\") || ($.errorCode = \"AccessDenied*\") }",
                "MetricTransformations": [
                    {
                        "MetricNamespace": "Security",
                        "MetricName": "UnauthorizedOperations",
                        "MetricValue": "1"
                    }
                ]
            }
        },
        "ProdUnauthorizedOperationAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${Environment}-unauthorized-operations"
                },
                "AlarmDescription": "Alarm for unauthorized operations or access denied events",
                "MetricName": "UnauthorizedOperations",
                "Namespace": "Security",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "AlarmActions": [
                    {
                        "Ref": "ProdSecurityNotificationsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-unauthorized-operations-alarm"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdConfigComplianceRule": {
            "Type": "AWS::Events::Rule",
            "Condition": "CreateConfigRecorder",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${Environment}-config-compliance-rule"
                },
                "Description": "Trigger SNS notification for non-compliant resources",
                "EventPattern": {
                    "source": [
                        "aws.config"
                    ],
                    "detail-type": [
                        "Config Rules Compliance Change"
                    ],
                    "detail": {
                        "newEvaluationResult": {
                            "complianceType": [
                                "NON_COMPLIANT"
                            ]
                        }
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Ref": "ProdSecurityNotificationsTopic"
                        },
                        "Id": "ConfigComplianceTarget"
                    }
                ]
            }
        },
        "GuardDutyDetectorCheck": {
            "Type": "Custom::GuardDutyDetectorCheck",
            "Condition": "CreateGuardDuty",
            "Properties": {
                "ServiceToken": {
                    "Fn::If": [
                        "CreateGuardDutyCheckFunction",
                        {
                            "Fn::GetAtt": [
                                "GuardDutyDetectorCheckFunction",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "ExistingGuardDutyCheckFunctionArn"
                        }
                    ]
                }
            }
        },
        "GuardDutyDetectorCheckFunction": {
            "Type": "AWS::Lambda::Function",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Condition": "CreateGuardDuty",
            "Properties": {
                "Runtime": "python3.9",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "GuardDutyDetectorCheckRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "import boto3\nimport cfnresponse\nimport logging\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef handler(event, context):\n    try:\n        if event['RequestType'] in ['Create', 'Update']:\n            guardduty = boto3.client('guardduty')\n            response = guardduty.list_detectors()\n            \n            if response['DetectorIds']:\n                # Detector already exists\n                cfnresponse.send(event, context, cfnresponse.SUCCESS, \n                               {'DetectorExists': 'true', 'DetectorId': response['DetectorIds'][0]})\n            else:\n                # No detector exists\n                cfnresponse.send(event, context, cfnresponse.SUCCESS, \n                               {'DetectorExists': 'false'})\n        else:\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n    except Exception as e:\n        logger.error(f\"Error: {str(e)}\")\n        cfnresponse.send(event, context, cfnresponse.FAILED, {})\n"
                }
            }
        },
        "GuardDutyDetectorCheckRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateGuardDuty",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "GuardDutyCheckPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "guardduty:ListDetectors"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ProdGuardDutyDetector": {
            "Type": "AWS::GuardDuty::Detector",
            "Condition": "CreateGuardDuty",
            "DependsOn": "GuardDutyDetectorCheck",
            "Properties": {
                "Enable": true,
                "FindingPublishingFrequency": "FIFTEEN_MINUTES",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-guardduty-detector"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${Environment}-alb-sg"
                },
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP access from anywhere"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS access from anywhere"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-alb-sg"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdWebSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${Environment}-web-sg"
                },
                "GroupDescription": "Security group for web servers",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ProdALBSecurityGroup"
                        },
                        "Description": "HTTP access from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "SourceSecurityGroupId": {
                            "Ref": "ProdALBSecurityGroup"
                        },
                        "Description": "HTTPS access from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "CorporateIPRange"
                        },
                        "Description": "SSH access from corporate network"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "All outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-web-sg"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdDatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${Environment}-db-sg"
                },
                "GroupDescription": "Security group for database servers",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "ProdWebSecurityGroup"
                        },
                        "Description": "MySQL access from web servers"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-db-sg"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdEC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "S3ReadOnlyPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ProdApplicationBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ProdApplicationBucket.Arn}/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-ec2-role"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdEC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "ProdEC2Role"
                    }
                ]
            }
        },
        "ProdDBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Condition": "CreateDBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "Subnet group for RDS instances",
                "SubnetIds": [
                    {
                        "Ref": "ProdPrivateSubnet1"
                    },
                    {
                        "Ref": "ProdPrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-db-subnet-group"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdDatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${Environment}-database-credentials"
                },
                "Description": {
                    "Fn::Sub": "Database credentials for ${Environment} environment"
                },
                "KmsKeyId": {
                    "Fn::If": [
                        "HasKmsKey",
                        {
                            "Fn::If": [
                                "CreateKMSKey",
                                {
                                    "Fn::GetAtt": [
                                        "ProdKMSKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Ref": "ExistingKMSKeyArn"
                                }
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "SecretString": {
                    "Fn::Sub": "{\n  \"username\": \"${DBUsername}\",\n  \"password\": \"${DBPassword}\"\n}\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-database-secret"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdRDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain",
            "Condition": "CreateDBInstanceEffective",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "Environment"
                            },
                            "tapstack",
                            {
                                "Fn::Select": [
                                    0,
                                    {
                                        "Fn::Split": [
                                            "-",
                                            {
                                                "Fn::Select": [
                                                    2,
                                                    {
                                                        "Fn::Split": [
                                                            "/",
                                                            {
                                                                "Ref": "AWS::StackId"
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    ]
                },
                "DBInstanceClass": "db.t3.micro",
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "AllocatedStorage": 20,
                "StorageType": "gp2",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::If": [
                        "HasKmsKey",
                        {
                            "Fn::If": [
                                "CreateKMSKey",
                                {
                                    "Fn::GetAtt": [
                                        "ProdKMSKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Ref": "ExistingKMSKeyArn"
                                }
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${ProdDatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${ProdDatabaseSecret}:SecretString:password}}"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "ProdDatabaseSecurityGroup"
                    }
                ],
                "DBSubnetGroupName": {
                    "Fn::If": [
                        "CreateDBSubnetGroup",
                        {
                            "Ref": "ProdDBSubnetGroup"
                        },
                        {
                            "Ref": "ExistingDBSubnetGroupName"
                        }
                    ]
                },
                "BackupRetentionPeriod": 7,
                "MultiAZ": false,
                "PubliclyAccessible": false,
                "DeletionProtection": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-database"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Condition": "CreateALB",
            "Properties": {
                "Type": "application",
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Ref": "ProdALBSecurityGroup"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "ProdPublicSubnet1"
                    },
                    {
                        "Ref": "ProdPublicSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-alb"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdSSLCertificate": {
            "Type": "AWS::CertificateManager::Certificate",
            "Condition": "CreateCertificate",
            "Properties": {
                "DomainName": {
                    "Ref": "DomainName"
                },
                "ValidationMethod": "DNS",
                "DomainValidationOptions": [
                    {
                        "DomainName": {
                            "Ref": "DomainName"
                        },
                        "HostedZoneId": {
                            "Ref": "HostedZoneId"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-ssl-certificate"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdWAFWebACL": {
            "Type": "AWS::WAFv2::WebACL",
            "Condition": "EnableCloudFrontCondition",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${Environment}-waf-webacl"
                },
                "Scope": "CLOUDFRONT",
                "DefaultAction": {
                    "Allow": {}
                },
                "Rules": [
                    {
                        "Name": "AWSManagedRulesCommonRuleSet",
                        "Priority": 1,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesCommonRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "AWSManagedRulesCommonRuleSet"
                        }
                    },
                    {
                        "Name": "AWSManagedRulesSQLiRuleSet",
                        "Priority": 2,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesSQLiRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "AWSManagedRulesSQLiRuleSet"
                        }
                    }
                ],
                "VisibilityConfig": {
                    "SampledRequestsEnabled": true,
                    "CloudWatchMetricsEnabled": true,
                    "MetricName": {
                        "Fn::Sub": "${Environment}-WAF-WebACL"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-waf-webacl"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProdCloudFrontDistribution": {
            "Type": "AWS::CloudFront::Distribution",
            "Condition": "EnableCloudFrontCondition",
            "Properties": {
                "DistributionConfig": {
                    "Enabled": true,
                    "Comment": {
                        "Fn::Sub": "CloudFront distribution for ${Environment} environment"
                    },
                    "Origins": [
                        {
                            "Id": {
                                "Fn::Sub": "${Environment}-alb-origin"
                            },
                            "DomainName": {
                                "Fn::If": [
                                    "CreateALB",
                                    {
                                        "Fn::GetAtt": [
                                            "ProdApplicationLoadBalancer",
                                            "DNSName"
                                        ]
                                    },
                                    {
                                        "Ref": "ExistingALBDNSName"
                                    }
                                ]
                            },
                            "CustomOriginConfig": {
                                "HTTPPort": 80,
                                "HTTPSPort": 443,
                                "OriginProtocolPolicy": "https-only"
                            }
                        }
                    ],
                    "DefaultCacheBehavior": {
                        "TargetOriginId": {
                            "Fn::Sub": "${Environment}-alb-origin"
                        },
                        "ViewerProtocolPolicy": "redirect-to-https",
                        "AllowedMethods": [
                            "GET",
                            "HEAD",
                            "OPTIONS",
                            "PUT",
                            "PATCH",
                            "POST",
                            "DELETE"
                        ],
                        "CachedMethods": [
                            "GET",
                            "HEAD",
                            "OPTIONS"
                        ],
                        "ForwardedValues": {
                            "QueryString": true,
                            "Cookies": {
                                "Forward": "all"
                            }
                        },
                        "MinTTL": 0,
                        "DefaultTTL": 3600,
                        "MaxTTL": 86400
                    },
                    "PriceClass": "PriceClass_All",
                    "ViewerCertificate": {
                        "AcmCertificateArn": {
                            "Fn::If": [
                                "HasCertificateArn",
                                {
                                    "Fn::If": [
                                        "CreateCertificate",
                                        {
                                            "Ref": "ProdSSLCertificate"
                                        },
                                        {
                                            "Ref": "ExistingCertificateArn"
                                        }
                                    ]
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        },
                        "SslSupportMethod": {
                            "Fn::If": [
                                "HasCertificateArn",
                                "sni-only",
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        },
                        "CloudFrontDefaultCertificate": {
                            "Fn::If": [
                                "HasCertificateArn",
                                {
                                    "Ref": "AWS::NoValue"
                                },
                                true
                            ]
                        }
                    },
                    "WebACLId": {
                        "Fn::GetAtt": [
                            "ProdWAFWebACL",
                            "Arn"
                        ]
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${Environment}-cloudfront-distribution"
                        }
                    },
                    {
                        "Key": "environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "ProdVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-ID"
                }
            }
        },
        "KMSKeyArnCreated": {
            "Condition": "CreateKMSKey",
            "Description": "KMS Key ARN for encryption (created)",
            "Value": {
                "Fn::GetAtt": [
                    "ProdKMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ARN"
                }
            }
        },
        "KMSKeyArnExisting": {
            "Condition": "HasKmsKey",
            "Description": "KMS Key ARN for encryption (existing)",
            "Value": {
                "Ref": "ExistingKMSKeyArn"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ARN"
                }
            }
        },
        "CloudTrailName": {
            "Description": "CloudTrail name",
            "Value": {
                "Ref": "ProdCloudTrail"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudTrail-Name"
                }
            }
        },
        "ConfigRecorderNameCreated": {
            "Condition": "CreateConfigRecorder",
            "Description": "AWS Config recorder name (created)",
            "Value": {
                "Ref": "ProdConfigRecorder"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Recorder-Name"
                }
            }
        },
        "ConfigRecorderNameExisting": {
            "Condition": "HasExistingConfigRecorderName",
            "Description": "AWS Config recorder name (existing)",
            "Value": {
                "Ref": "ExistingConfigRecorderName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Config-Recorder-Name"
                }
            }
        },
        "GuardDutyDetectorId": {
            "Description": "GuardDuty detector ID",
            "Condition": "CreateGuardDuty",
            "Value": {
                "Ref": "ProdGuardDutyDetector"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-GuardDuty-Detector-ID"
                }
            }
        },
        "WAFWebACLId": {
            "Description": "WAF Web ACL ID",
            "Value": {
                "Ref": "ProdWAFWebACL"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-WAF-WebACL-ID"
                }
            }
        },
        "CloudFrontDistributionId": {
            "Description": "CloudFront distribution ID",
            "Value": {
                "Ref": "ProdCloudFrontDistribution"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudFront-Distribution-ID"
                }
            }
        },
        "ALBDNSName": {
            "Description": "Application Load Balancer DNS name",
            "Value": {
                "Fn::If": [
                    "CreateALB",
                    {
                        "Fn::GetAtt": [
                            "ProdApplicationLoadBalancer",
                            "DNSName"
                        ]
                    },
                    {
                        "Ref": "ExistingALBDNSName"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-DNS-Name"
                }
            }
        },
        "RDSEndpointCreated": {
            "Condition": "CreateDBInstanceEffective",
            "Description": "RDS endpoint address (created)",
            "Value": {
                "Fn::GetAtt": [
                    "ProdRDSInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDS-Endpoint"
                }
            }
        },
        "RDSEndpointExisting": {
            "Condition": "HasExistingRDSEndpointAddress",
            "Description": "RDS endpoint address (existing)",
            "Value": {
                "Ref": "ExistingRDSEndpointAddress"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDS-Endpoint"
                }
            }
        },
        "SNSTopicArn": {
            "Description": "SNS topic ARN for security notifications",
            "Value": {
                "Ref": "ProdSecurityNotificationsTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SNS-Topic-ARN"
                }
            }
        },
        "KmsAliasNameCreated": {
            "Condition": "CreateKMSKeyAlias",
            "Description": "KMS alias name in use (created)",
            "Value": {
                "Fn::Sub": "alias/${Environment}-encryption-key"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Alias-Name"
                }
            }
        },
        "KmsAliasNameExisting": {
            "Condition": "HasExistingKMSKeyAlias",
            "Description": "KMS alias name in use (existing)",
            "Value": {
                "Ref": "ExistingKMSKeyAlias"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Alias-Name"
                }
            }
        }
    }
}
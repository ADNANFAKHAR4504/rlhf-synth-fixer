{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Enterprise-grade web application infrastructure with comprehensive security, monitoring, and operational excellence - Production Ready",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentName",
                        "ProjectName"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VpcCIDR",
                        "PublicSubnet1CIDR",
                        "PublicSubnet2CIDR",
                        "PrivateSubnet1CIDR",
                        "PrivateSubnet2CIDR",
                        "DatabaseSubnet1CIDR",
                        "DatabaseSubnet2CIDR"
                    ]
                },
                {
                    "Label": {
                        "default": "Compute Configuration"
                    },
                    "Parameters": [
                        "InstanceType",
                        "BastionInstanceType",
                        "KeyPairName",
                        "MinSize",
                        "MaxSize",
                        "DesiredCapacity"
                    ]
                },
                {
                    "Label": {
                        "default": "Database Configuration"
                    },
                    "Parameters": [
                        "DatabaseInstanceClass",
                        "DatabaseName",
                        "DatabaseUsername"
                    ]
                },
                {
                    "Label": {
                        "default": "Security & Monitoring"
                    },
                    "Parameters": [
                        "SSLCertificateArn",
                        "AlertEmail",
                        "EnableEnhancedMonitoring"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Description": "Environment name prefix for resources",
            "Type": "String",
            "Default": "Production",
            "AllowedValues": [
                "Development",
                "Staging",
                "Production"
            ]
        },
        "ProjectName": {
            "Description": "Project name for tagging",
            "Type": "String",
            "Default": "WebApplication"
        },
        "VpcCIDR": {
            "Description": "CIDR block for the VPC",
            "Type": "String",
            "Default": "10.0.0.0/16",
            "MinLength": 9,
            "MaxLength": 18,
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
        },
        "PublicSubnet1CIDR": {
            "Description": "CIDR block for public subnet in AZ1",
            "Type": "String",
            "Default": "10.0.1.0/24"
        },
        "PublicSubnet2CIDR": {
            "Description": "CIDR block for public subnet in AZ2",
            "Type": "String",
            "Default": "10.0.2.0/24"
        },
        "PrivateSubnet1CIDR": {
            "Description": "CIDR block for private subnet in AZ1",
            "Type": "String",
            "Default": "10.0.10.0/24"
        },
        "PrivateSubnet2CIDR": {
            "Description": "CIDR block for private subnet in AZ2",
            "Type": "String",
            "Default": "10.0.11.0/24"
        },
        "DatabaseSubnet1CIDR": {
            "Description": "CIDR block for database subnet in AZ1",
            "Type": "String",
            "Default": "10.0.20.0/24"
        },
        "DatabaseSubnet2CIDR": {
            "Description": "CIDR block for database subnet in AZ2",
            "Type": "String",
            "Default": "10.0.21.0/24"
        },
        "InstanceType": {
            "Description": "EC2 instance type for application servers",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t2.micro",
                "t2.small",
                "t2.medium",
                "t3.micro",
                "t3.small"
            ]
        },
        "BastionInstanceType": {
            "Description": "EC2 instance type for bastion host",
            "Type": "String",
            "Default": "t2.micro"
        },
        "KeyPairName": {
            "Description": "EC2 Key Pair for SSH access (leave empty for Session Manager only)",
            "Type": "String",
            "Default": ""
        },
        "DatabaseInstanceClass": {
            "Description": "RDS database instance class",
            "Type": "String",
            "Default": "db.t3.micro",
            "AllowedValues": [
                "db.t3.micro",
                "db.t3.small",
                "db.t3.medium"
            ]
        },
        "DatabaseName": {
            "Description": "Database name",
            "Type": "String",
            "Default": "webappdb",
            "MinLength": 1,
            "MaxLength": 64,
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*"
        },
        "DatabaseUsername": {
            "Description": "Database master username",
            "Type": "String",
            "Default": "dbadmin",
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
            "NoEcho": true
        },
        "MinSize": {
            "Description": "Minimum number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 2,
            "MinValue": 1
        },
        "MaxSize": {
            "Description": "Maximum number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 4,
            "MinValue": 2
        },
        "DesiredCapacity": {
            "Description": "Desired number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 2,
            "MinValue": 1
        },
        "SSLCertificateArn": {
            "Description": "ARN of ACM SSL certificate for HTTPS (leave empty for HTTP only)",
            "Type": "String",
            "Default": ""
        },
        "AlertEmail": {
            "Description": "Email address for CloudWatch alarm notifications",
            "Type": "String",
            "Default": "alerts@example.com",
            "AllowedPattern": "([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})"
        },
        "EnableEnhancedMonitoring": {
            "Description": "Enable enhanced monitoring and logging",
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ]
        }
    },
    "Conditions": {
        "HasKeyPair": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KeyPairName"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasSSLCertificate": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "SSLCertificateArn"
                        },
                        ""
                    ]
                }
            ]
        },
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentName"
                },
                "Production"
            ]
        },
        "EnableMonitoring": {
            "Fn::Equals": [
                {
                    "Ref": "EnableEnhancedMonitoring"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "webapp-database-secret-${AWS::StackName}"
                },
                "Description": "RDS database master password",
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\": \"${DatabaseUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludePunctuation": true,
                    "ExcludeCharacters": "/@\" ",
                    "RequireEachIncludedType": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-database-secret"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    }
                ]
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCIDR"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-vpc"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-igw"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PublicSubnet1CIDR"
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-public-subnet-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PublicSubnet2CIDR"
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-public-subnet-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet1CIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-private-subnet-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet2CIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-private-subnet-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    }
                ]
            }
        },
        "DatabaseSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "DatabaseSubnet1CIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-database-subnet-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Database"
                    }
                ]
            }
        },
        "DatabaseSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "DatabaseSubnet2CIDR"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-database-subnet-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Type",
                        "Value": "Database"
                    }
                ]
            }
        },
        "NatGatewayEIP1": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-nat-eip-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGatewayEIP2": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-nat-eip-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayEIP1",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-nat-gateway-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway2": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayEIP2",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-nat-gateway-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-public-routes"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                }
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-private-routes-az1"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway1"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "DatabaseSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "DatabaseSubnet1"
                }
            }
        },
        "PrivateRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-private-routes-az2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPrivateRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway2"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "DatabaseSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "SubnetId": {
                    "Ref": "DatabaseSubnet2"
                }
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "webapp-alb-sg",
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTP traffic"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-alb-sg"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "webapp-webserver-sg",
                "GroupDescription": "Security group for web servers",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "Allow HTTP from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "Allow HTTPS from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "SourceSecurityGroupId": {
                            "Ref": "BastionSecurityGroup"
                        },
                        "Description": "Allow SSH from Bastion"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-webserver-sg"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "webapp-database-sg",
                "GroupDescription": "Security group for RDS database",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "WebServerSecurityGroup"
                        },
                        "Description": "Allow MySQL from web servers"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "BastionSecurityGroup"
                        },
                        "Description": "Allow MySQL from Bastion for maintenance"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-database-sg"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "BastionSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "webapp-bastion-sg",
                "GroupDescription": "Security group for bastion host",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow SSH from anywhere (restrict in production)"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-bastion-sg"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ApplicationLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "webapp-application-logs-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 90
                        },
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                }
                            ]
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "NotificationConfiguration": {
                    "LambdaConfigurations": []
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-application-logs"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "VPCFlowLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "webapp-vpc-flow-logs-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 30
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 7,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-vpc-flow-logs"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPCFlowLogsLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Condition": "EnableMonitoring",
            "Properties": {
                "LogGroupName": "/aws/vpc/flowlogs",
                "RetentionInDays": 7
            }
        },
        "ApplicationLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "/aws/webapp/application",
                "RetentionInDays": 30
            }
        },
        "VPCFlowLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "webapp-vpc-flow-logs-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "webapp-vpc-flow-logs-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:GetBucketLocation",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "VPCFlowLogsBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${VPCFlowLogsBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPCFlowLog": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VPC"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "s3",
                "LogDestination": {
                    "Fn::GetAtt": [
                        "VPCFlowLogsBucket",
                        "Arn"
                    ]
                },
                "LogFormat": "${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${action} ${log-status}",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-vpc-flow-log"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPCFlowLogToCloudWatch": {
            "Type": "AWS::EC2::FlowLog",
            "Condition": "EnableMonitoring",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VPC"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "cloud-watch-logs",
                "LogGroupName": {
                    "Ref": "VPCFlowLogsLogGroup"
                },
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "VPCFlowLogsRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-vpc-flow-log-cloudwatch"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "WebServerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "webapp-webserver-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Policies": [
                    {
                        "PolicyName": "webapp-s3-logs-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:PutObjectAcl",
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ApplicationLogsBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ApplicationLogsBucket.Arn}/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "webapp-secrets-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "webapp-ssm-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:GetParametersByPath"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/webapp/*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:ssm:${AWS::Region}::parameter/aws/service/ami-amazon-linux-latest/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "webapp-cloudwatch-logs-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ApplicationLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "WebServerInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": "webapp-webserver-profile",
                "Roles": [
                    {
                        "Ref": "WebServerRole"
                    }
                ]
            }
        },
        "BastionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "webapp-bastion-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "BastionInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": "webapp-bastion-profile",
                "Roles": [
                    {
                        "Ref": "BastionRole"
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": "webapp-alb",
                "Type": "application",
                "Scheme": "internet-facing",
                "IpAddressType": "ipv4",
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-alb"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": "webapp-tg",
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "instance",
                "HealthCheckEnabled": true,
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckPath": "/health",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Matcher": {
                    "HttpCode": "200-299"
                },
                "TargetGroupAttributes": [
                    {
                        "Key": "deregistration_delay.timeout_seconds",
                        "Value": "30"
                    },
                    {
                        "Key": "stickiness.enabled",
                        "Value": "true"
                    },
                    {
                        "Key": "stickiness.type",
                        "Value": "lb_cookie"
                    },
                    {
                        "Key": "stickiness.lb_cookie.duration_seconds",
                        "Value": "86400"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-target-group"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBListenerHTTP": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Fn::If": [
                            "HasSSLCertificate",
                            {
                                "Type": "redirect",
                                "RedirectConfig": {
                                    "Protocol": "HTTPS",
                                    "Port": "443",
                                    "StatusCode": "HTTP_301"
                                }
                            },
                            {
                                "Type": "forward",
                                "TargetGroupArn": {
                                    "Ref": "ALBTargetGroup"
                                }
                            }
                        ]
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "ALBListenerHTTPS": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Condition": "HasSSLCertificate",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 443,
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "SSLCertificateArn"
                        }
                    }
                ],
                "SslPolicy": "ELBSecurityPolicy-TLS-1-2-2017-01"
            }
        },
        "LatestAmiIdParameter": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": "/webapp/ami/latest",
                "Type": "String",
                "Value": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2",
                "Description": "Latest Amazon Linux 2 AMI ID",
                "Tags": {
                    "iac-rlhf-amazon": "true"
                }
            }
        },
        "LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": "webapp-launch-template",
                "LaunchTemplateData": {
                    "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                    "InstanceType": {
                        "Ref": "InstanceType"
                    },
                    "KeyName": {
                        "Fn::If": [
                            "HasKeyPair",
                            {
                                "Ref": "KeyPairName"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "WebServerInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "SecurityGroupIds": [
                        {
                            "Ref": "WebServerSecurityGroup"
                        }
                    ],
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeSize": 20,
                                "VolumeType": "gp3",
                                "Encrypted": true,
                                "DeleteOnTermination": true
                            }
                        }
                    ],
                    "MetadataOptions": {
                        "HttpEndpoint": "enabled",
                        "HttpTokens": "required",
                        "HttpPutResponseHopLimit": 1
                    },
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash -xe\n# Update system\nyum update -y\n\n# Install required packages\nyum install -y httpd aws-cfn-bootstrap amazon-cloudwatch-agent mysql jq\n\n# Configure CloudWatch agent\ncat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'\n{\n  \"metrics\": {\n    \"namespace\": \"WebApp\",\n    \"metrics_collected\": {\n      \"mem\": {\n        \"measurement\": [{\"name\": \"mem_used_percent\"}]\n      },\n      \"disk\": {\n        \"measurement\": [{\"name\": \"used_percent\"}],\n        \"resources\": [\"*\"]\n      }\n    }\n  },\n  \"logs\": {\n    \"logs_collected\": {\n      \"files\": {\n        \"collect_list\": [\n          {\n            \"file_path\": \"/var/log/httpd/access_log\",\n            \"log_group_name\": \"${ApplicationLogGroup}\",\n            \"log_stream_name\": \"{instance_id}/httpd/access\"\n          },\n          {\n            \"file_path\": \"/var/log/httpd/error_log\",\n            \"log_group_name\": \"${ApplicationLogGroup}\",\n            \"log_stream_name\": \"{instance_id}/httpd/error\"\n          }\n        ]\n      }\n    }\n  }\n}\nEOF\n\n# Start CloudWatch agent\n/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \\\n  -a fetch-config \\\n  -m ec2 \\\n  -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json\n\n# Get database credentials from Secrets Manager\nSECRET_JSON=$(aws secretsmanager get-secret-value --secret-id ${DatabaseSecret} --region ${AWS::Region} --query SecretString --output text)\nDB_PASSWORD=$(echo $SECRET_JSON | jq -r .password)\n\n# Configure application\ncat > /var/www/html/index.html << 'EOF'\n<!DOCTYPE html>\n<html>\n<head><title>Web Application</title></head>\n<body>\n<h1>Web Application Infrastructure</h1>\n<p>Instance: $(hostname -f)</p>\n<p>Region: ${AWS::Region}</p>\n<p>Environment: ${EnvironmentName}</p>\n</body>\n</html>\nEOF\n\n# Health check endpoint\ncat > /var/www/html/health << 'EOF'\nOK\nEOF\n\n# Configure log rotation and S3 upload\ncat > /usr/local/bin/upload-logs.sh << 'EOF'\n#!/bin/bash\nLOG_DATE=$(date +%Y-%m-%d-%H)\nINSTANCE_ID=$(ec2-metadata --instance-id | cut -d \" \" -f 2)\naws s3 cp /var/log/httpd/access_log s3://${ApplicationLogsBucket}/httpd/$INSTANCE_ID/access_log-$LOG_DATE --storage-class STANDARD_IA\naws s3 cp /var/log/httpd/error_log s3://${ApplicationLogsBucket}/httpd/$INSTANCE_ID/error_log-$LOG_DATE --storage-class STANDARD_IA\nEOF\nchmod +x /usr/local/bin/upload-logs.sh\n\n# Add to crontab\necho \"0 * * * * /usr/local/bin/upload-logs.sh\" | crontab -\n\n# Start services\nsystemctl start httpd\nsystemctl enable httpd\n\n# Signal CloudFormation\n/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AutoScalingGroup --region ${AWS::Region}\n"
                        }
                    }
                },
                "TagSpecifications": [
                    {
                        "ResourceType": "launch-template",
                        "Tags": [
                            {
                                "Key": "Name",
                                "Value": "webapp-launch-template"
                            },
                            {
                                "Key": "iac-rlhf-amazon",
                                "Value": "true"
                            }
                        ]
                    }
                ]
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AutoScalingGroupName": "webapp-asg",
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": {
                    "Ref": "MinSize"
                },
                "MaxSize": {
                    "Ref": "MaxSize"
                },
                "DesiredCapacity": {
                    "Ref": "DesiredCapacity"
                },
                "TargetGroupARNs": [
                    {
                        "Ref": "ALBTargetGroup"
                    }
                ],
                "HealthCheckType": "ELB",
                "HealthCheckGracePeriod": 300,
                "MetricsCollection": [
                    {
                        "Granularity": "1Minute"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-instance",
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true",
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        },
                        "PropagateAtLaunch": true
                    }
                ]
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "DesiredCapacity"
                    },
                    "Timeout": "PT15M"
                }
            },
            "UpdatePolicy": {
                "AutoScalingRollingUpdate": {
                    "MinInstancesInService": 1,
                    "MaxBatchSize": 2,
                    "PauseTime": "PT5M",
                    "WaitOnResourceSignals": true
                }
            }
        },
        "ScalingPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "PolicyType": "TargetTrackingScaling",
                "TargetTrackingConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ASGAverageCPUUtilization"
                    },
                    "TargetValue": 70.0
                }
            }
        },
        "ScaleUpPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "PolicyType": "SimpleScaling",
                "AdjustmentType": "ChangeInCapacity",
                "ScalingAdjustment": 1,
                "Cooldown": 300
            }
        },
        "ScaleDownPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "PolicyType": "SimpleScaling",
                "AdjustmentType": "ChangeInCapacity",
                "ScalingAdjustment": -1,
                "Cooldown": 300
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": "webapp-db-subnet-group",
                "DBSubnetGroupDescription": "Subnet group for RDS database",
                "SubnetIds": [
                    {
                        "Ref": "DatabaseSubnet1"
                    },
                    {
                        "Ref": "DatabaseSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-db-subnet-group"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBName": {
                    "Ref": "DatabaseName"
                },
                "Engine": "MySQL",
                "EngineVersion": "8.0.43",
                "DBInstanceClass": {
                    "Ref": "DatabaseInstanceClass"
                },
                "AllocatedStorage": 20,
                "MaxAllocatedStorage": 100,
                "StorageType": "gp3",
                "StorageEncrypted": true,
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "MultiAZ": {
                    "Fn::If": [
                        "IsProduction",
                        true,
                        false
                    ]
                },
                "EnableCloudwatchLogsExports": [
                    "error",
                    "general",
                    "slowquery"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-database"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "DatabaseSecretAttachment": {
            "Type": "AWS::SecretsManager::SecretTargetAttachment",
            "Properties": {
                "SecretId": {
                    "Ref": "DatabaseSecret"
                },
                "TargetId": {
                    "Ref": "DatabaseInstance"
                },
                "TargetType": "AWS::RDS::DBInstance"
            }
        },
        "BastionHost": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                "InstanceType": {
                    "Ref": "BastionInstanceType"
                },
                "KeyName": {
                    "Fn::If": [
                        "HasKeyPair",
                        {
                            "Ref": "KeyPairName"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "IamInstanceProfile": {
                    "Ref": "BastionInstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "BastionSecurityGroup"
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": 8,
                            "VolumeType": "gp3",
                            "Encrypted": true,
                            "DeleteOnTermination": true
                        }
                    }
                ],
                "MetadataOptions": {
                    "HttpEndpoint": "enabled",
                    "HttpTokens": "required"
                },
                "UserData": {
                    "Fn::Base64": "#!/bin/bash -xe\nyum update -y\n\n# Install SSM agent and other tools\nyum install -y amazon-ssm-agent mysql\nsystemctl start amazon-ssm-agent\nsystemctl enable amazon-ssm-agent\n\n# Install Session Manager plugin\ncurl \"https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm\" -o \"session-manager-plugin.rpm\"\nyum install -y session-manager-plugin.rpm\n\n# Configure SSH timeout\necho \"ClientAliveInterval 60\" >> /etc/ssh/sshd_config\necho \"ClientAliveCountMax 10\" >> /etc/ssh/sshd_config\nsystemctl restart sshd\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "webapp-bastion-host"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    }
                ]
            }
        },
        "SNSTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": "webapp-alerts",
                "DisplayName": "WebApp Infrastructure Alerts",
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "AlertEmail"
                        },
                        "Protocol": "email"
                    }
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "HighCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "webapp-high-cpu",
                "AlarmDescription": "Alarm when CPU exceeds 80%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    },
                    {
                        "Ref": "ScaleUpPolicy"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "ScaleDownPolicy"
                    }
                ]
            }
        },
        "LowCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "webapp-low-cpu",
                "AlarmDescription": "Alarm when CPU is below 25%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 25,
                "ComparisonOperator": "LessThanThreshold",
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "ScaleDownPolicy"
                    }
                ]
            }
        },
        "UnHealthyHostAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "webapp-unhealthy-hosts",
                "AlarmDescription": "Alarm when we have unhealthy hosts",
                "MetricName": "UnHealthyHostCount",
                "Namespace": "AWS/ApplicationELB",
                "Statistic": "Average",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 0,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TargetGroup",
                        "Value": {
                            "Fn::GetAtt": [
                                "ALBTargetGroup",
                                "TargetGroupFullName"
                            ]
                        }
                    },
                    {
                        "Name": "LoadBalancer",
                        "Value": {
                            "Fn::GetAtt": [
                                "ApplicationLoadBalancer",
                                "LoadBalancerFullName"
                            ]
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "DatabaseCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "webapp-database-cpu",
                "AlarmDescription": "Alarm when database CPU exceeds 75%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 75,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DatabaseInstance"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "DatabaseStorageAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "webapp-database-storage",
                "AlarmDescription": "Alarm when free storage is less than 10%",
                "MetricName": "FreeStorageSpace",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 2147483648,
                "ComparisonOperator": "LessThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DatabaseInstance"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "CloudWatchDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Condition": "EnableMonitoring",
            "Properties": {
                "DashboardName": "webapp-dashboard",
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/ApplicationELB\", \"TargetResponseTime\"],\n          [\".\", \"RequestCount\"]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"ALB Metrics\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/EC2\", \"CPUUtilization\", \"AutoScalingGroupName\", \"${AutoScalingGroup}\"],\n          [\".\", \"NetworkIn\", \".\", \".\"]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"EC2 Metrics\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/RDS\", \"CPUUtilization\", \"DBInstanceIdentifier\", \"${DatabaseInstance}\"],\n          [\".\", \"DatabaseConnections\", \".\", \".\"]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"RDS Metrics\"\n      }\n    }\n  ]\n}\n"
                }
            }
        },
        "BackupVault": {
            "Type": "AWS::Backup::BackupVault",
            "Properties": {
                "BackupVaultName": "webapp-backup-vault",
                "BackupVaultTags": {
                    "iac-rlhf-amazon": "true",
                    "Environment": {
                        "Ref": "EnvironmentName"
                    }
                }
            }
        },
        "BackupPlan": {
            "Type": "AWS::Backup::BackupPlan",
            "Properties": {
                "BackupPlan": {
                    "BackupPlanName": "webapp-backup-plan",
                    "BackupPlanRule": [
                        {
                            "RuleName": "DailyBackups",
                            "TargetBackupVault": {
                                "Ref": "BackupVault"
                            },
                            "ScheduleExpression": "cron(0 5 ? * * *)",
                            "StartWindowMinutes": 60,
                            "CompletionWindowMinutes": 120,
                            "Lifecycle": {
                                "DeleteAfterDays": 100,
                                "MoveToColdStorageAfterDays": 7
                            },
                            "RecoveryPointTags": {
                                "iac-rlhf-amazon": "true"
                            }
                        }
                    ]
                }
            }
        },
        "BackupSelection": {
            "Type": "AWS::Backup::BackupSelection",
            "Properties": {
                "BackupPlanId": {
                    "Ref": "BackupPlan"
                },
                "BackupSelection": {
                    "SelectionName": "webapp-backup-selection",
                    "IamRoleArn": {
                        "Fn::GetAtt": [
                            "BackupRole",
                            "Arn"
                        ]
                    },
                    "Resources": [
                        {
                            "Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${DatabaseInstance}"
                        }
                    ],
                    "ListOfTags": [
                        {
                            "ConditionType": "STRINGEQUALS",
                            "ConditionKey": "iac-rlhf-amazon",
                            "ConditionValue": "true"
                        }
                    ]
                }
            }
        },
        "BackupRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "webapp-backup-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup",
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores"
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-ID"
                }
            }
        },
        "VPCCidr": {
            "Description": "VPC CIDR block",
            "Value": {
                "Fn::GetAtt": [
                    "VPC",
                    "CidrBlock"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-CIDR"
                }
            }
        },
        "PublicSubnet1Id": {
            "Description": "Public Subnet 1 ID",
            "Value": {
                "Ref": "PublicSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet1-ID"
                }
            }
        },
        "PublicSubnet2Id": {
            "Description": "Public Subnet 2 ID",
            "Value": {
                "Ref": "PublicSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet2-ID"
                }
            }
        },
        "PrivateSubnet1Id": {
            "Description": "Private Subnet 1 ID",
            "Value": {
                "Ref": "PrivateSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet1-ID"
                }
            }
        },
        "PrivateSubnet2Id": {
            "Description": "Private Subnet 2 ID",
            "Value": {
                "Ref": "PrivateSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet2-ID"
                }
            }
        },
        "DatabaseSubnet1Id": {
            "Description": "Database Subnet 1 ID",
            "Value": {
                "Ref": "DatabaseSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseSubnet1-ID"
                }
            }
        },
        "DatabaseSubnet2Id": {
            "Description": "Database Subnet 2 ID",
            "Value": {
                "Ref": "DatabaseSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseSubnet2-ID"
                }
            }
        },
        "LoadBalancerDNS": {
            "Description": "DNS name of the Application Load Balancer",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-DNS"
                }
            }
        },
        "LoadBalancerArn": {
            "Description": "ARN of the Application Load Balancer",
            "Value": {
                "Ref": "ApplicationLoadBalancer"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-ARN"
                }
            }
        },
        "LoadBalancerURL": {
            "Description": "URL of the Application Load Balancer",
            "Value": {
                "Fn::If": [
                    "HasSSLCertificate",
                    {
                        "Fn::Sub": "https://${ApplicationLoadBalancer.DNSName}"
                    },
                    {
                        "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-URL"
                }
            }
        },
        "ApplicationLogsBucketName": {
            "Description": "Name of S3 bucket for application logs",
            "Value": {
                "Ref": "ApplicationLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AppLogs-Bucket"
                }
            }
        },
        "ApplicationLogsBucketArn": {
            "Description": "ARN of S3 bucket for application logs",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLogsBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AppLogs-Bucket-ARN"
                }
            }
        },
        "VPCFlowLogsBucketName": {
            "Description": "Name of S3 bucket for VPC flow logs",
            "Value": {
                "Ref": "VPCFlowLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FlowLogs-Bucket"
                }
            }
        },
        "VPCFlowLogsBucketArn": {
            "Description": "ARN of S3 bucket for VPC flow logs",
            "Value": {
                "Fn::GetAtt": [
                    "VPCFlowLogsBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FlowLogs-Bucket-ARN"
                }
            }
        },
        "DatabaseEndpoint": {
            "Description": "RDS database endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "DatabaseInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DB-Endpoint"
                }
            }
        },
        "DatabasePort": {
            "Description": "RDS database port",
            "Value": {
                "Fn::GetAtt": [
                    "DatabaseInstance",
                    "Endpoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DB-Port"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "ARN of the database secret in Secrets Manager",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DB-Secret-ARN"
                }
            }
        },
        "BastionHostInstanceId": {
            "Description": "Instance ID of bastion host",
            "Value": {
                "Ref": "BastionHost"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Bastion-ID"
                }
            }
        },
        "BastionHostPublicIP": {
            "Description": "Public IP of bastion host",
            "Value": {
                "Fn::GetAtt": [
                    "BastionHost",
                    "PublicIp"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Bastion-IP"
                }
            }
        },
        "BastionSSMSessionCommand": {
            "Description": "AWS CLI command to connect to bastion via Session Manager",
            "Value": {
                "Fn::Sub": "aws ssm start-session --target ${BastionHost} --region ${AWS::Region}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Bastion-SSM-Command"
                }
            }
        },
        "AutoScalingGroupName": {
            "Description": "Name of the Auto Scaling Group",
            "Value": {
                "Ref": "AutoScalingGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ASG-Name"
                }
            }
        },
        "LaunchTemplateId": {
            "Description": "ID of the Launch Template",
            "Value": {
                "Ref": "LaunchTemplate"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LaunchTemplate-ID"
                }
            }
        },
        "LaunchTemplateVersion": {
            "Description": "Latest version of the Launch Template",
            "Value": {
                "Fn::GetAtt": [
                    "LaunchTemplate",
                    "LatestVersionNumber"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LaunchTemplate-Version"
                }
            }
        },
        "ALBSecurityGroupId": {
            "Description": "Security Group ID for ALB",
            "Value": {
                "Ref": "ALBSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ALB-SG-ID"
                }
            }
        },
        "WebServerSecurityGroupId": {
            "Description": "Security Group ID for Web Servers",
            "Value": {
                "Ref": "WebServerSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-WebServer-SG-ID"
                }
            }
        },
        "DatabaseSecurityGroupId": {
            "Description": "Security Group ID for Database",
            "Value": {
                "Ref": "DatabaseSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Database-SG-ID"
                }
            }
        },
        "BastionSecurityGroupId": {
            "Description": "Security Group ID for Bastion",
            "Value": {
                "Ref": "BastionSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Bastion-SG-ID"
                }
            }
        },
        "SNSTopicArn": {
            "Description": "ARN of SNS Topic for alerts",
            "Value": {
                "Ref": "SNSTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SNS-Topic-ARN"
                }
            }
        },
        "CloudWatchDashboardURL": {
            "Description": "URL to CloudWatch Dashboard",
            "Condition": "EnableMonitoring",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=webapp-dashboard"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Dashboard-URL"
                }
            }
        },
        "BackupVaultArn": {
            "Description": "ARN of Backup Vault",
            "Value": {
                "Fn::GetAtt": [
                    "BackupVault",
                    "BackupVaultArn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupVault-ARN"
                }
            }
        },
        "BackupPlanId": {
            "Description": "ID of Backup Plan",
            "Value": {
                "Ref": "BackupPlan"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupPlan-ID"
                }
            }
        },
        "StackName": {
            "Description": "CloudFormation Stack Name",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Stack-Name"
                }
            }
        },
        "StackId": {
            "Description": "CloudFormation Stack ID",
            "Value": {
                "Ref": "AWS::StackId"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Stack-ID"
                }
            }
        },
        "Region": {
            "Description": "AWS Region",
            "Value": {
                "Ref": "AWS::Region"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Region"
                }
            }
        },
        "AccountId": {
            "Description": "AWS Account ID",
            "Value": {
                "Ref": "AWS::AccountId"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Account-ID"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "NovaCart Secure Foundation - Production-Grade Security Baseline Template",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentName",
                        "ProjectName",
                        "Department",
                        "Owner"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VPCCidr",
                        "PublicSubnet1Cidr",
                        "PublicSubnet2Cidr",
                        "PrivateSubnet1Cidr",
                        "PrivateSubnet2Cidr"
                    ]
                },
                {
                    "Label": {
                        "default": "Security Configuration"
                    },
                    "Parameters": [
                        "AllowedSSHIP",
                        "DBMasterUsername"
                    ]
                },
                {
                    "Label": {
                        "default": "Compute Configuration"
                    },
                    "Parameters": [
                        "EC2InstanceType"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Description": "Environment name prefix for all resources",
            "Type": "String",
            "Default": "novacart-prod",
            "AllowedPattern": "^[a-z][a-z0-9-]*$",
            "ConstraintDescription": "Must begin with a letter and contain only lowercase letters, numbers, and hyphens"
        },
        "ProjectName": {
            "Description": "Project name for tagging",
            "Type": "String",
            "Default": "Guardian"
        },
        "Department": {
            "Description": "Department name for tagging",
            "Type": "String",
            "Default": "NovaCart-Security"
        },
        "Owner": {
            "Description": "Owner for tagging",
            "Type": "String",
            "Default": "CloudTeam"
        },
        "VPCCidr": {
            "Description": "CIDR block for VPC",
            "Type": "String",
            "Default": "10.0.0.0/16",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$"
        },
        "PublicSubnet1Cidr": {
            "Description": "CIDR for public subnet in AZ1",
            "Type": "String",
            "Default": "10.0.1.0/24"
        },
        "PublicSubnet2Cidr": {
            "Description": "CIDR for public subnet in AZ2",
            "Type": "String",
            "Default": "10.0.2.0/24"
        },
        "PrivateSubnet1Cidr": {
            "Description": "CIDR for private subnet in AZ1",
            "Type": "String",
            "Default": "10.0.10.0/24"
        },
        "PrivateSubnet2Cidr": {
            "Description": "CIDR for private subnet in AZ2",
            "Type": "String",
            "Default": "10.0.11.0/24"
        },
        "AllowedSSHIP": {
            "Description": "IP address allowed to SSH (use your office/VPN IP)",
            "Type": "String",
            "Default": "0.0.0.0/32",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$"
        },
        "DBMasterUsername": {
            "Description": "Database master username",
            "Type": "String",
            "Default": "dbadmin",
            "NoEcho": true,
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9]*$"
        },
        "EC2InstanceType": {
            "Description": "EC2 instance type",
            "Type": "String",
            "Default": "t3.medium",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large"
            ]
        }
    },
    "Conditions": {
        "CreateCloudFront": {
            "Fn::Equals": [
                {
                    "Ref": "AWS::Region"
                },
                "us-east-1"
            ]
        }
    },
    "Resources": {
        "MasterKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Master KMS key for ${ProjectName} encryption"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudTrail to encrypt logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringLike": {
                                    "kms:EncryptionContext:aws:cloudtrail:arn": {
                                        "Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow CloudTrail to decrypt logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:ReEncryptFrom"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:CallerAccount": {
                                        "Fn::Sub": "${AWS::AccountId}"
                                    }
                                },
                                "StringLike": {
                                    "kms:EncryptionContext:aws:cloudtrail:arn": {
                                        "Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow CloudWatch Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt*",
                                "kms:Decrypt*",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow S3 service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "s3.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "MasterKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentName}-master-key-${AWS::Region}"
                },
                "TargetKeyId": {
                    "Ref": "MasterKMSKey"
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VPCCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-vpc"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-igw"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnet1Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-subnet-az1"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnet2Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-subnet-az2"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet1Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-az1"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet2Cidr"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-az2"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-rt"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${EnvironmentName}-webserver-sg-${AWS::Region}"
                },
                "GroupDescription": "Security group for web servers - minimal ports",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "Allow HTTP from VPC"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "AllowedSSHIP"
                        },
                        "Description": "SSH from specific IP only"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS outbound for updates"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "MySQL to RDS"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-webserver-sg"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${EnvironmentName}-database-sg-${AWS::Region}"
                },
                "GroupDescription": "Security group for RDS database",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "CidrIp": "10.0.0.0/16",
                        "Description": "MySQL from VPC only"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database-sg"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PermissionBoundaryPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description": "Permission boundary for all NovaCart roles",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:PutObject"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${EnvironmentName}-*/*"
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "MasterKMSKey",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "sqs:SendMessage"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${EnvironmentName}-*"
                            }
                        },
                        {
                            "Effect": "Deny",
                            "Action": [
                                "iam:*",
                                "organizations:*",
                                "account:*"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "EC2InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-ec2-role-${AWS::Region}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "PermissionsBoundary": {
                    "Ref": "PermissionBoundaryPolicy"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "EC2LeastPrivilege",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "${AppConfigBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DBPasswordSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "MasterKMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-ec2-role"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2InstanceRole"
                    }
                ]
            }
        },
        "AppDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-app-data-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::GetAtt": [
                                        "MasterKMSKey",
                                        "Arn"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-app-data"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "AppConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-app-config-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::GetAtt": [
                                        "MasterKMSKey",
                                        "Arn"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-app-config"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "${EnvironmentName}-db-subnet-group-${AWS::Region}"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS database",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-db-subnet-group"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DBPasswordSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "RDS Master Password",
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\": \"${DBMasterUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\\\"
                },
                "KmsKeyId": {
                    "Ref": "MasterKMSKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-db-password"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "RDSDatabase": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-database-${AWS::Region}"
                },
                "AllocatedStorage": 20,
                "StorageType": "gp3",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "MasterKMSKey",
                        "Arn"
                    ]
                },
                "DBInstanceClass": "db.t3.medium",
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBPasswordSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBPasswordSecret}:SecretString:password}}"
                },
                "VPCSecurityGroups": [
                    {
                        "Fn::GetAtt": [
                            "DatabaseSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "BackupRetentionPeriod": 7,
                "MultiAZ": true,
                "DeletionProtection": false,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "RDSMonitoringRole",
                        "Arn"
                    ]
                },
                "EnableCloudwatchLogsExports": [
                    "error",
                    "general",
                    "slowquery"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "RDSMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "PermissionsBoundary": {
                    "Ref": "PermissionBoundaryPolicy"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-rds-monitoring-role"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudTrailLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/cloudtrail/${EnvironmentName}-${AWS::Region}"
                },
                "RetentionInDays": 90,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "MasterKMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "CloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-cloudtrail-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Fn::GetAtt": [
                                        "MasterKMSKey",
                                        "Arn"
                                    ]
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 90,
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 7
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-cloudtrail"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "CloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "CloudTrailBucket",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "AWS:SourceArn": {
                                        "Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${EnvironmentName}-trail-${AWS::Region}"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${CloudTrailBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control",
                                    "AWS:SourceArn": {
                                        "Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${EnvironmentName}-trail-${AWS::Region}"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CloudTrailLogRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "PermissionsBoundary": {
                    "Ref": "PermissionBoundaryPolicy"
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailLogPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "CloudTrailLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-cloudtrail-role"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": [
                "CloudTrailBucketPolicy"
            ],
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${EnvironmentName}-trail-${AWS::Region}"
                },
                "S3BucketName": {
                    "Ref": "CloudTrailBucket"
                },
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": false,
                "EnableLogFileValidation": true,
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "CloudTrailLogGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "CloudTrailLogRole",
                        "Arn"
                    ]
                },
                "KMSKeyId": {
                    "Fn::GetAtt": [
                        "MasterKMSKey",
                        "Arn"
                    ]
                },
                "EventSelectors": [
                    {
                        "IncludeManagementEvents": true,
                        "ReadWriteType": "All",
                        "DataResources": [
                            {
                                "Type": "AWS::S3::Object",
                                "Values": [
                                    {
                                        "Fn::Sub": "${AppDataBucket.Arn}/"
                                    },
                                    {
                                        "Fn::Sub": "${AppConfigBucket.Arn}/"
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-trail"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "WebACL": {
            "Type": "AWS::WAFv2::WebACL",
            "Condition": "CreateCloudFront",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-web-acl-${AWS::Region}"
                },
                "Scope": "CLOUDFRONT",
                "DefaultAction": {
                    "Allow": {}
                },
                "Rules": [
                    {
                        "Name": "AWSManagedRulesCommonRuleSet",
                        "Priority": 1,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesCommonRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "AWSManagedRulesCommonRuleSetMetric"
                        }
                    },
                    {
                        "Name": "AWSManagedRulesKnownBadInputsRuleSet",
                        "Priority": 2,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "AWSManagedRulesKnownBadInputsMetric"
                        }
                    }
                ],
                "VisibilityConfig": {
                    "SampledRequestsEnabled": true,
                    "CloudWatchMetricsEnabled": true,
                    "MetricName": {
                        "Fn::Sub": "${EnvironmentName}-web-acl-metric"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-web-acl"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudFrontOriginAccessControl": {
            "Type": "AWS::CloudFront::OriginAccessControl",
            "Condition": "CreateCloudFront",
            "Properties": {
                "OriginAccessControlConfig": {
                    "Name": {
                        "Fn::Sub": "${EnvironmentName}-oac-${AWS::Region}"
                    },
                    "Description": "OAC for CloudFront to access S3 origins securely",
                    "SigningProtocol": "sigv4",
                    "SigningBehavior": "always",
                    "OriginAccessControlOriginType": "s3"
                }
            }
        },
        "CloudFrontDistribution": {
            "Type": "AWS::CloudFront::Distribution",
            "Condition": "CreateCloudFront",
            "Properties": {
                "DistributionConfig": {
                    "Enabled": true,
                    "Comment": {
                        "Fn::Sub": "${EnvironmentName} secure CloudFront distribution"
                    },
                    "DefaultRootObject": "index.html",
                    "Origins": [
                        {
                            "Id": "AppDataBucketOrigin",
                            "DomainName": {
                                "Fn::GetAtt": [
                                    "AppDataBucket",
                                    "RegionalDomainName"
                                ]
                            },
                            "S3OriginConfig": {},
                            "OriginAccessControlId": {
                                "Ref": "CloudFrontOriginAccessControl"
                            }
                        }
                    ],
                    "DefaultCacheBehavior": {
                        "TargetOriginId": "AppDataBucketOrigin",
                        "ViewerProtocolPolicy": "redirect-to-https",
                        "AllowedMethods": [
                            "GET",
                            "HEAD"
                        ],
                        "CachedMethods": [
                            "GET",
                            "HEAD"
                        ],
                        "Compress": true,
                        "ForwardedValues": {
                            "QueryString": false
                        }
                    },
                    "HttpVersion": "http2",
                    "PriceClass": "PriceClass_100",
                    "WebACLId": {
                        "Fn::GetAtt": [
                            "WebACL",
                            "Arn"
                        ]
                    }
                }
            }
        },
        "AppDataBucketPolicyForCloudFront": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "CreateCloudFront",
            "Properties": {
                "Bucket": {
                    "Ref": "AppDataBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudFrontRead",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudfront.amazonaws.com"
                            },
                            "Action": "s3:GetObject",
                            "Resource": {
                                "Fn::Sub": "${AppDataBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "AWS:SourceArn": {
                                        "Fn::Sub": "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LambdaDeadLetterQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-dlq-${AWS::Region}"
                },
                "MessageRetentionPeriod": 1209600,
                "KmsMasterKeyId": {
                    "Ref": "MasterKMSKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-lambda-dlq"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-lambda-role-${AWS::Region}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "PermissionsBoundary": {
                    "Ref": "PermissionBoundaryPolicy"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "LambdaBasicPermissions",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:SendMessage"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LambdaDeadLetterQueue",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-lambda-role"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SampleLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentName}-sample-function-${AWS::Region}"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "import json\ndef lambda_handler(event, context):\n    return {\n        'statusCode': 200,\n        'body': json.dumps({\n            'message': 'Hello from NovaCart Lambda',\n            'input': event\n        })\n    }\n"
                },
                "DeadLetterConfig": {
                    "TargetArn": {
                        "Fn::GetAtt": [
                            "LambdaDeadLetterQueue",
                            "Arn"
                        ]
                    }
                },
                "Timeout": 30,
                "MemorySize": 128,
                "Environment": {
                    "Variables": {
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentName"
                        },
                        "PROJECT": {
                            "Ref": "ProjectName"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-sample-function"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${EnvironmentName}-sample-function-${AWS::Region}"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "MasterKMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "RestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-api-${AWS::Region}"
                },
                "Description": "NovaCart Secure API Gateway with request validation",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-api"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": "ApiMethod",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "StageName": "prod"
            }
        },
        "ApiResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "RestApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "order"
            }
        },
        "ApiMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "ApiKeyRequired": false,
                "RequestValidatorId": {
                    "Ref": "ApiRequestValidator"
                },
                "RequestParameters": {
                    "method.request.querystring.customerId": true
                },
                "RequestModels": {
                    "application/json": {
                        "Ref": "ApiModel"
                    }
                },
                "Integration": {
                    "Type": "AWS",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SampleLambdaFunction.Arn}/invocations"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        }
                    ],
                    "PassthroughBehavior": "WHEN_NO_TEMPLATES",
                    "RequestTemplates": {
                        "application/json": "{\"statusCode\": 200}"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200
                    }
                ]
            }
        },
        "ApiGatewayInvokeLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "SampleLambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/POST/order"
                }
            }
        },
        "ApiRequestValidator": {
            "Type": "AWS::ApiGateway::RequestValidator",
            "Properties": {
                "Name": "RequestBodyValidator",
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ValidateRequestBody": true,
                "ValidateRequestParameters": true
            }
        },
        "ApiModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "ContentType": "application/json",
                "Name": "OrderModel",
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "Schema": {
                    "$schema": "http://json-schema.org/draft-04/schema#",
                    "title": "Order Schema",
                    "type": "object",
                    "required": [
                        "customerId",
                        "items"
                    ],
                    "properties": {
                        "customerId": {
                            "type": "string",
                            "pattern": "^[a-zA-Z0-9-]+$"
                        },
                        "items": {
                            "type": "array",
                            "minItems": 1,
                            "items": {
                                "type": "object",
                                "required": [
                                    "productId",
                                    "quantity"
                                ],
                                "properties": {
                                    "productId": {
                                        "type": "string",
                                        "pattern": "^[a-zA-Z0-9-]+$"
                                    },
                                    "quantity": {
                                        "type": "integer",
                                        "minimum": 1,
                                        "maximum": 100
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "WebServerInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": {
                    "Ref": "EC2InstanceType"
                },
                "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}",
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Fn::GetAtt": [
                            "WebServerSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": 20,
                            "VolumeType": "gp3",
                            "Encrypted": true,
                            "KmsKeyId": {
                                "Fn::GetAtt": [
                                    "MasterKMSKey",
                                    "Arn"
                                ]
                            },
                            "DeleteOnTermination": true
                        }
                    }
                ],
                "Monitoring": true,
                "UserData": {
                    "Fn::Base64": "#!/bin/bash\n# Install CloudWatch agent\nyum update -y\nyum install -y amazon-cloudwatch-agent\n\n# Basic web server setup\nyum install -y httpd\nsystemctl start httpd\nsystemctl enable httpd\n\necho \"<h1>NovaCart Secure Web Server</h1>\" > /var/www/html/index.html\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-webserver"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "WebServerInstanceAz2": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": {
                    "Ref": "EC2InstanceType"
                },
                "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}",
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Fn::GetAtt": [
                            "WebServerSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": 20,
                            "VolumeType": "gp3",
                            "Encrypted": true,
                            "KmsKeyId": {
                                "Fn::GetAtt": [
                                    "MasterKMSKey",
                                    "Arn"
                                ]
                            },
                            "DeleteOnTermination": true
                        }
                    }
                ],
                "Monitoring": true,
                "UserData": {
                    "Fn::Base64": "#!/bin/bash\n# Install CloudWatch agent\nyum update -y\nyum install -y amazon-cloudwatch-agent\n\n# Basic web server setup\nyum install -y httpd\nsystemctl start httpd\nsystemctl enable httpd\n\necho \"<h1>NovaCart Secure Web Server - AZ2</h1>\" > /var/www/html/index.html\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-webserver-az2"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Ref": "Department"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "team",
                        "Value": "2"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EC2CPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-ec2-high-cpu-${AWS::Region}"
                },
                "AlarmDescription": "Alert when EC2 CPU exceeds 80%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "WebServerInstance"
                        }
                    }
                ]
            }
        },
        "EC2CPUAlarmAz2": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-ec2-high-cpu-az2-${AWS::Region}"
                },
                "AlarmDescription": "Alert when EC2 CPU exceeds 80% (AZ2)",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "WebServerInstanceAz2"
                        }
                    }
                ]
            }
        },
        "RDSCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-rds-high-cpu-${AWS::Region}"
                },
                "AlarmDescription": "Alert when RDS CPU exceeds 80%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "RDSDatabase"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VpcId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-vpc-id"
                }
            }
        },
        "WafWebAclArn": {
            "Condition": "CreateCloudFront",
            "Description": "WAF Web ACL ARN for CloudFront protection",
            "Value": {
                "Fn::GetAtt": [
                    "WebACL",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-waf-webacl-arn"
                }
            }
        },
        "CloudTrailLogGroupArn": {
            "Description": "CloudTrail CloudWatch Log Group ARN for audit logging",
            "Value": {
                "Fn::GetAtt": [
                    "CloudTrailLogGroup",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-cloudtrail-loggroup-arn"
                }
            }
        },
        "RdsInstanceEndpoint": {
            "Description": "RDS Database endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "RDSDatabase",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-rds-endpoint"
                }
            }
        },
        "S3BucketName": {
            "Description": "CloudTrail S3 bucket name for audit storage",
            "Value": {
                "Ref": "CloudTrailBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-cloudtrail-bucket-name"
                }
            }
        },
        "AppDataBucketName": {
            "Description": "App Data S3 bucket name for static content storage",
            "Value": {
                "Ref": "AppDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-app-data-bucket-name"
                }
            }
        },
        "AppConfigBucketName": {
            "Description": "App Config S3 bucket name for configuration storage",
            "Value": {
                "Ref": "AppConfigBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-app-config-bucket-name"
                }
            }
        },
        "DBPasswordSecretArn": {
            "Description": "Secrets Manager ARN for RDS database password",
            "Value": {
                "Ref": "DBPasswordSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-password-secret-arn"
                }
            }
        },
        "DlqUrl": {
            "Description": "SQS Dead Letter Queue URL for Lambda error handling",
            "Value": {
                "Ref": "LambdaDeadLetterQueue"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-dlq-url"
                }
            }
        },
        "ApiGatewayId": {
            "Description": "API Gateway REST API ID",
            "Value": {
                "Ref": "RestApi"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-apigateway-id"
                }
            }
        },
        "ApiGatewayUrl": {
            "Description": "API Gateway URL",
            "Value": {
                "Fn::Sub": "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-apigateway-url"
                }
            }
        },
        "Ec2InstanceId": {
            "Description": "EC2 Instance ID",
            "Value": {
                "Ref": "WebServerInstance"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ec2-instance-id"
                }
            }
        },
        "Ec2InstanceIdAz2": {
            "Description": "EC2 Instance ID in AZ2",
            "Value": {
                "Ref": "WebServerInstanceAz2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ec2-instance-id-az2"
                }
            }
        },
        "CloudFrontDomainName": {
            "Condition": "CreateCloudFront",
            "Description": "CloudFront distribution domain name",
            "Value": {
                "Fn::GetAtt": [
                    "CloudFrontDistribution",
                    "DomainName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-cloudfront-domain"
                }
            }
        },
        "KmsKeyId": {
            "Description": "KMS Key ID used for encryption",
            "Value": {
                "Ref": "MasterKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-kms-key-id"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "Lambda Function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "SampleLambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-lambda-function-arn"
                }
            }
        },
        "SecurityStatus": {
            "Description": "Security Configuration Status Summary",
            "Value": {
                "Fn::Sub": "Security Baseline Status for ${EnvironmentName}:\n Multi-AZ VPC with subnets in ${PrivateSubnet1.AvailabilityZone} and ${PrivateSubnet2.AvailabilityZone}\n KMS encryption enabled for all storage services\n WAF WebACL configured for web protection\n CloudTrail multi-region logging enabled\n IAM roles with permission boundaries and least privilege\n Security groups with minimal ingress rules\n S3 versioning enabled on all buckets\n RDS encryption at rest with KMS\n Lambda dead letter queue configured\n API Gateway request validation enabled\n CloudWatch monitoring active for critical resources\n Resource tagging compliant with security policy\n"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-security-status"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "CloudFormation template for a secure production web server infrastructure. This template provisions an EC2 instance with a basic web server, an IAM Role, and a Security Group with restricted HTTP/HTTPS access.\n",
    "Parameters": {
        "LatestAmiId": {
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Description": "The latest Amazon Linux 2 AMI ID for the us-east-1 region.",
            "Default": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
        }
    },
    "Resources": {
        "WebServerInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    },
                    {
                        "Key": "Project",
                        "Value": "GlobalResilience"
                    }
                ]
            }
        },
        "WebServerInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "WebServerInstanceRole"
                    }
                ]
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Allow inbound HTTP and HTTPS from the office IP range",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "203.0.113.0/24"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "203.0.113.0/24"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    },
                    {
                        "Key": "Project",
                        "Value": "GlobalResilience"
                    }
                ]
            }
        },
        "WebServerInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": "t2.micro",
                "ImageId": {
                    "Ref": "LatestAmiId"
                },
                "IamInstanceProfile": {
                    "Ref": "WebServerInstanceProfile"
                },
                "SecurityGroupIds": [
                    {
                        "Fn::GetAtt": [
                            "WebServerSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "UserData": {
                    "Fn::Base64": "#!/bin/bash -xe\nyum update -y\nyum install -y httpd\nsystemctl start httpd\nsystemctl enable httpd\necho \"<h1>Deployed Successfully via CloudFormation</h1>\" > /var/www/html/index.html\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "Production-WebServer"
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    },
                    {
                        "Key": "Project",
                        "Value": "GlobalResilience"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "InstanceId": {
            "Description": "The Instance ID of the web server.",
            "Value": {
                "Ref": "WebServerInstance"
            }
        },
        "InstancePublicIp": {
            "Description": "The Public IP address of the web server.",
            "Value": {
                "Fn::GetAtt": [
                    "WebServerInstance",
                    "PublicIp"
                ]
            }
        },
        "SecurityGroupId": {
            "Description": "The ID of the web server's security group.",
            "Value": {
                "Ref": "WebServerSecurityGroup"
            }
        }
    }
}
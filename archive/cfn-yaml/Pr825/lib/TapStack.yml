AWSTemplateFormatVersion: '2010-09-09'
Description: >
  TAP Stack - Healthcare Application Infrastructure CloudFormation Template
  HIPAA-compliant infrastructure with encrypted S3 buckets, Secrets Manager,
  proper tagging, and deployable in us-west-2 region.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix
      - Label:
          default: 'Application Configuration'
        Parameters:
          - ApplicationName
          - DatabaseInstanceClass
          - VpcCidr

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'prod'
    Description: Environment suffix for resource naming (e.g., dev, staging, prod)
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: Must contain only alphanumeric characters

  ApplicationName:
    Type: String
    Default: 'healthapp'
    Description: Name of the healthcare application

  DatabaseInstanceClass:
    Type: String
    Default: db.t3.medium
    Description: RDS instance class for the database
    AllowedValues:
      - db.t3.medium
      - db.t3.large
      - db.r5.large
      - db.r5.xlarge

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC

Conditions:
  IsProd: !Equals [!Ref EnvironmentSuffix, 'prod']

Resources:

  # KMS Key for encryption
  HealthcareKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS key for healthcare app encryption"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Allow administration by root account
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: Allow use by S3 and RDS services
            Effect: Allow
            Principal:
              Service:
                - s3.amazonaws.com
                - rds.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"
          - Sid: Allow use by CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              ArnLike:
                kms:EncryptionContext:aws:logs:arn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  HealthcareKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${ApplicationName}-${EnvironmentSuffix}-kms-key"
      TargetKeyId: !Ref HealthcareKMSKey

  # Secrets Manager for database credentials
  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${ApplicationName}/${EnvironmentSuffix}/database/credentials"
      Description: "Database credentials for healthcare app"
      GenerateSecretString:
        SecretStringTemplate: '{"username": "healthapp_admin"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
      KmsKeyId: !Ref HealthcareKMSKey
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # API Secret for healthcare application
  ApplicationAPISecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${ApplicationName}/${EnvironmentSuffix}/api/keys"
      Description: "API keys and tokens for healthcare application"
      SecretString: |
        {
          "api_key": "placeholder-will-be-updated-post-deployment",
          "jwt_secret": "placeholder-will-be-updated-post-deployment"
        }
      KmsKeyId: !Ref HealthcareKMSKey
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # VPC and subnets
  HealthcareVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-vpc"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HealthcareVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-private-subnet-1"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HealthcareVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-private-subnet-2"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HealthcareVPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-public-subnet-1"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HealthcareVPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-public-subnet-2"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-igw"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref HealthcareVPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HealthcareVPC
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-public-rt"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # S3 bucket with KMS encryption
  HealthcareDataBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub '${ApplicationName}-patient-data-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref HealthcareKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref HealthcareLogsBucket
        LogFilePrefix: 'patient-data-access-logs/'
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production
        - Key: DataClassification
          Value: PHI-Sensitive

  # Log bucket for S3 access logs with encryption
  HealthcareLogsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub '${ApplicationName}-logs-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref HealthcareKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production
        - Key: Purpose
          Value: Audit-Logs

  # RDS subnet group
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for healthcare database"
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # Security Group for RDS
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for healthcare database"
      VpcId: !Ref HealthcareVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ApplicationSecurityGroup
          Description: "PostgreSQL access from app servers"
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-db-sg"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # RDS Instance
  HealthcareDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      DBInstanceIdentifier: !Sub "${ApplicationName}-${EnvironmentSuffix}-database"
      DBInstanceClass: !Ref DatabaseInstanceClass
      Engine: postgres
      EngineVersion: 13.21
      AllocatedStorage: 100
      StorageType: gp2
      StorageEncrypted: true
      KmsKeyId: !Ref HealthcareKMSKey
      MasterUsername: "healthapp_admin"
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      BackupRetentionPeriod: 30
      PreferredBackupWindow: 03:00-04:00
      PreferredMaintenanceWindow: sun:04:00-sun:05:00
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSEnhancedMonitoringRole.Arn
      EnablePerformanceInsights: true
      PerformanceInsightsKMSKeyId: !Ref HealthcareKMSKey
      DeletionProtection: false
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production
        - Key: DataClassification
          Value: PHI-Sensitive

  # Application Security Group
  ApplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for healthcare application servers"
      VpcId: !Ref HealthcareVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: "HTTPS from load balancer"
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: "HTTP from load balancer (redirect to HTTPS)"
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-app-sg"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # Load Balancer Security Group
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for healthcare app load balancer"
      VpcId: !Ref HealthcareVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: "HTTPS from internet"
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: "HTTP from internet (redirect to HTTPS)"
      Tags:
        - Key: Name
          Value: !Sub "${ApplicationName}-${EnvironmentSuffix}-alb-sg"
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # IAM Role for RDS monitoring
  RDSEnhancedMonitoringRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ApplicationName}-${EnvironmentSuffix}-rds-monitoring-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  # IAM Role for application EC2 instances
  ApplicationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ApplicationName}-${EnvironmentSuffix}-application-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: HealthcareAppPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "arn:aws:s3:::${HealthcareDataBucket}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:aws:s3:::${HealthcareDataBucket}"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref DatabaseSecret
                  - !Ref ApplicationAPISecret
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt HealthcareKMSKey.Arn
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

  ApplicationInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${ApplicationName}-${EnvironmentSuffix}-instance-profile"
      Roles:
        - !Ref ApplicationRole

  # CloudWatch Log Group for application logs
  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/healthcare/${ApplicationName}-${EnvironmentSuffix}"
      RetentionInDays: !If [IsProd, 2557, 365] # 7 years retention for HIPAA compliance
      KmsKeyId: !GetAtt HealthcareKMSKey.Arn
      Tags:
        - Key: Project
          Value: HealthApp
        - Key: Environment
          Value: Production

Outputs:

  VPCId:
    Description: "ID of the healthcare VPC"
    Value: !Ref HealthcareVPC
    Export:
      Name: !Sub "${AWS::StackName}-VPC-ID"

  PrivateSubnetIds:
    Description: "IDs of the private subnets"
    Value: !Join [",", [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]
    Export:
      Name: !Sub "${AWS::StackName}-Private-Subnet-IDs"

  PublicSubnetIds:
    Description: "IDs of the public subnets"
    Value: !Join [",", [!Ref PublicSubnet1, !Ref PublicSubnet2]]
    Export:
      Name: !Sub "${AWS::StackName}-Public-Subnet-IDs"

  DatabaseEndpoint:
    Description: "RDS database endpoint"
    Value: !GetAtt HealthcareDatabase.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-Database-Endpoint"

  KMSKeyId:
    Description: "KMS Key ID for encryption"
    Value: !Ref HealthcareKMSKey
    Export:
      Name: !Sub "${AWS::StackName}-KMS-Key-ID"

  PatientDataBucket:
    Description: "S3 bucket for patient data"
    Value: !Ref HealthcareDataBucket
    Export:
      Name: !Sub "${AWS::StackName}-Patient-Data-Bucket"

  LogsBucket:
    Description: "S3 bucket for application logs"
    Value: !Ref HealthcareLogsBucket
    Export:
      Name: !Sub "${AWS::StackName}-Logs-Bucket"

  DatabaseSecretArn:
    Description: "ARN of the database secret in Secrets Manager"
    Value: !Ref DatabaseSecret
    Export:
      Name: !Sub "${AWS::StackName}-Database-Secret-ARN"

  ApplicationAPISecretArn:
    Description: "ARN of the API secret in Secrets Manager"
    Value: !Ref ApplicationAPISecret
    Export:
      Name: !Sub "${AWS::StackName}-API-Secret-ARN"

  ApplicationRoleArn:
    Description: "ARN of the application IAM role"
    Value: !GetAtt ApplicationRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-Application-Role-ARN"

  ApplicationSecurityGroupId:
    Description: "Security group ID for application servers"
    Value: !Ref ApplicationSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-Application-SG-ID"

  LoadBalancerSecurityGroupId:
    Description: "Security group ID for load balancer"
    Value: !Ref LoadBalancerSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-LoadBalancer-SG-ID"

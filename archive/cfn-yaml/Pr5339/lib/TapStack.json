{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Multi-Environment Infrastructure Template - Dev/Staging/Production",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Environment name",
            "Default": "dev"
        },
        "ProjectName": {
            "Type": "String",
            "Description": "Project name for tagging",
            "Default": "MyProject"
        },
        "OwnerName": {
            "Type": "String",
            "Description": "Owner name for tagging",
            "Default": "DevOpsTeam"
        },
        "SSHAllowedCIDR": {
            "Type": "String",
            "Description": "CIDR block allowed for SSH access",
            "Default": "10.0.0.0/8",
            "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/([0-9]|[1-2][0-9]|3[0-2])$"
        }
    },
    "Mappings": {
        "EnvironmentConfig": {
            "default": {
                "InstanceType": "t3.small",
                "DBInstanceClass": "db.t3.small",
                "MultiAZ": true,
                "ScheduleEnabled": false,
                "MinSize": 1,
                "MaxSize": 2,
                "DesiredCapacity": 1
            },
            "dev": {
                "InstanceType": "t3.small",
                "DBInstanceClass": "db.t3.small",
                "MultiAZ": true,
                "ScheduleEnabled": true,
                "MinSize": 1,
                "MaxSize": 2,
                "DesiredCapacity": 1
            },
            "staging": {
                "InstanceType": "t3.medium",
                "DBInstanceClass": "db.t3.medium",
                "MultiAZ": true,
                "ScheduleEnabled": true,
                "MinSize": 1,
                "MaxSize": 3,
                "DesiredCapacity": 2
            },
            "production": {
                "InstanceType": "t3.large",
                "DBInstanceClass": "db.t3.large",
                "MultiAZ": true,
                "ScheduleEnabled": false,
                "MinSize": 2,
                "MaxSize": 6,
                "DesiredCapacity": 2
            }
        }
    },
    "Conditions": {
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentSuffix"
                },
                "production"
            ]
        },
        "IsDev": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentSuffix"
                },
                "dev"
            ]
        },
        "IsStaging": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentSuffix"
                },
                "staging"
            ]
        },
        "EnableScheduling": {
            "Fn::Or": [
                {
                    "Fn::And": [
                        {
                            "Condition": "IsDev"
                        },
                        {
                            "Fn::Equals": [
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "dev",
                                        "ScheduleEnabled"
                                    ]
                                },
                                true
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Condition": "IsStaging"
                        },
                        {
                            "Fn::Equals": [
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "ScheduleEnabled"
                                    ]
                                },
                                true
                            ]
                        }
                    ]
                },
                {
                    "Fn::And": [
                        {
                            "Condition": "IsProduction"
                        },
                        {
                            "Fn::Equals": [
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "production",
                                        "ScheduleEnabled"
                                    ]
                                },
                                true
                            ]
                        }
                    ]
                }
            ]
        }
    },
    "Resources": {
        "KMSKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": "KMS key for encrypting EBS volumes and S3 buckets",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM policies",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow services to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "s3.amazonaws.com",
                                    "logs.amazonaws.com",
                                    "rds.amazonaws.com",
                                    "cloudtrail.amazonaws.com",
                                    "ec2.amazonaws.com",
                                    "autoscaling.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs for VPC Flow Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/vpc/*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow CloudWatch Logs for CloudTrail",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/cloudtrail/*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow EC2 and Auto Scaling to use the key via EC2",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com",
                                    "autoscaling.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:Encrypt",
                                "kms:GenerateDataKey*",
                                "kms:ReEncrypt*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "ec2.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "Allow Auto Scaling to create grants for AWS resources",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "autoscaling.amazonaws.com"
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:ListGrants",
                                "kms:RevokeGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "KMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentSuffix}-key"
                },
                "TargetKeyId": {
                    "Ref": "KMSKey"
                }
            }
        },
        "EC2KeyPair": {
            "Type": "AWS::EC2::KeyPair",
            "Properties": {
                "KeyName": {
                    "Fn::Sub": "${EnvironmentSuffix}-keypair"
                },
                "KeyType": "rsa",
                "KeyFormat": "pem",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-keypair"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-VPC"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-IGW"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-Subnet-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-Subnet-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.10.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Subnet-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.11.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-Subnet-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Public-RouteTable"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1Association": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2Association": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "NATGateway1EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT1-EIP"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "NATGateway2EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT2-EIP"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "NATGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGateway1EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT-Gateway-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "NATGateway2": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NATGateway2EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-NAT-Gateway-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-RouteTable-1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Private-RouteTable-2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "DefaultPrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway1"
                }
            }
        },
        "DefaultPrivateRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NATGateway2"
                }
            }
        },
        "PrivateSubnet1Association": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                }
            }
        },
        "PrivateSubnet2Association": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                }
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-ALB-SG"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for EC2 instances",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "SSHAllowedCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-WebServer-SG"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for RDS database",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "WebServerSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-Database-SG"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-EC2-Role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "SSMParameterAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:GetParameterHistory",
                                        "ssm:GetParametersByPath"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvironmentSuffix}/*"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "LambdaInvokePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "lambda:InvokeFunction"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "RDSSnapshotLambda",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "SecretsManagerReadAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret"
                                    ],
                                    "Resource": {
                                        "Ref": "DbSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "KMSAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:Encrypt",
                                        "kms:GenerateDataKey",
                                        "kms:GenerateDataKeyWithoutPlaintext",
                                        "kms:ReEncrypt*",
                                        "kms:CreateGrant",
                                        "kms:DescribeKey",
                                        "kms:GetKeyPolicy",
                                        "kms:GetKeyRotationStatus",
                                        "kms:ListGrants",
                                        "kms:ListKeyPolicies",
                                        "kms:ListResourceTags",
                                        "kms:RetireGrant",
                                        "kms:RevokeGrant"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Lambda-Execution-Role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "RDSSnapshotPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "rds:CreateDBSnapshot",
                                        "rds:DescribeDBSnapshots",
                                        "rds:DeleteDBSnapshot",
                                        "rds:AddTagsToResource",
                                        "rds:ListTagsForResource"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-ALB"
                },
                "Type": "application",
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-ALB"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-TG"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "HealthCheckEnabled": true,
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "ForwardConfig": {
                            "TargetGroups": [
                                {
                                    "TargetGroupArn": {
                                        "Ref": "ALBTargetGroup"
                                    },
                                    "Weight": 100
                                }
                            ]
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "${EnvironmentSuffix}-LaunchTemplate"
                },
                "LaunchTemplateData": {
                    "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                    "InstanceType": {
                        "Fn::If": [
                            "IsDev",
                            {
                                "Fn::FindInMap": [
                                    "EnvironmentConfig",
                                    "dev",
                                    "InstanceType"
                                ]
                            },
                            {
                                "Fn::If": [
                                    "IsStaging",
                                    {
                                        "Fn::FindInMap": [
                                            "EnvironmentConfig",
                                            "staging",
                                            "InstanceType"
                                        ]
                                    },
                                    {
                                        "Fn::If": [
                                            "IsProduction",
                                            {
                                                "Fn::FindInMap": [
                                                    "EnvironmentConfig",
                                                    "production",
                                                    "InstanceType"
                                                ]
                                            },
                                            {
                                                "Fn::FindInMap": [
                                                    "EnvironmentConfig",
                                                    "default",
                                                    "InstanceType"
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    "KeyName": {
                        "Ref": "EC2KeyPair"
                    },
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "EC2InstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "SecurityGroupIds": [
                        {
                            "Ref": "WebServerSecurityGroup"
                        }
                    ],
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeSize": 30,
                                "VolumeType": "gp3",
                                "Encrypted": true,
                                "DeleteOnTermination": true
                            }
                        }
                    ],
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash\nyum update -y\nyum install -y python3 python3-pip mysql jq\npip3 install pymysql boto3 cryptography\n\n# Get RDS endpoint and credentials\nRDS_ENDPOINT=\"${RDSDatabase.Endpoint.Address}\"\nSECRET_ARN=\"${DbSecret}\"\nREGION=\"${AWS::Region}\"\nS3_BUCKET=\"${S3Bucket}\"\nLAMBDA_FUNCTION_NAME=\"${RDSSnapshotLambda}\"\n\n# Create Python server script\ncat > /home/ec2-user/server.py << 'EOFPYTHON'\n#!/usr/bin/env python3\nimport pymysql\nimport json\nimport boto3\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\nimport os\nimport time\nfrom datetime import datetime\n\ndef test_rds_connection():\n    try:\n        # Get credentials from Secrets Manager\n        client = boto3.client('secretsmanager', region_name=os.environ.get('AWS_REGION'))\n        secret_value = client.get_secret_value(SecretId=os.environ.get('SECRET_ARN'))\n        secret = json.loads(secret_value['SecretString'])\n\n        # Test connection\n        connection = pymysql.connect(\n            host=os.environ.get('RDS_ENDPOINT'),\n            user=secret['username'],\n            password=secret['password'],\n            connect_timeout=5\n        )\n\n        # Get MySQL version\n        with connection.cursor() as cursor:\n            cursor.execute(\"SELECT VERSION()\")\n            version = cursor.fetchone()[0]\n\n        connection.close()\n\n        return {\n            'status': 'SUCCESS',\n            'message': 'Connected to RDS successfully',\n            'mysql_version': version,\n            'endpoint': os.environ.get('RDS_ENDPOINT')\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'endpoint': os.environ.get('RDS_ENDPOINT')\n        }\n\ndef test_s3_connection():\n    try:\n        # Create S3 client\n        s3_client = boto3.client('s3', region_name=os.environ.get('AWS_REGION'))\n        \n        # Test write - put a test object\n        test_key = f\"health-check-{int(time.time())}.txt\"\n        test_content = f\"Connection test from EC2 at {datetime.utcnow().isoformat()}\"\n        \n        s3_client.put_object(\n            Bucket=os.environ.get('S3_BUCKET'),\n            Key=test_key,\n            Body=test_content.encode(),\n            ContentType='text/plain'\n        )\n\n        # Test read - get the object back\n        response = s3_client.get_object(\n            Bucket=os.environ.get('S3_BUCKET'),\n            Key=test_key\n        )\n        retrieved_content = response['Body'].read().decode()\n\n        # Test delete - clean up test object\n        s3_client.delete_object(\n            Bucket=os.environ.get('S3_BUCKET'),\n            Key=test_key\n        )\n\n        return {\n            'status': 'SUCCESS',\n            'message': 'Connected to S3 successfully - Write/Read/Delete operations completed',\n            'bucket_name': os.environ.get('S3_BUCKET'),\n            'test_key': test_key,\n            'content_match': test_content == retrieved_content\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'bucket_name': os.environ.get('S3_BUCKET')\n        }\n\ndef trigger_rds_snapshot():\n    try:\n        # Create Lambda client\n        lambda_client = boto3.client('lambda', region_name=os.environ.get('AWS_REGION'))\n        \n        # Invoke the snapshot Lambda function\n        response = lambda_client.invoke(\n            FunctionName=os.environ.get('LAMBDA_FUNCTION_NAME'),\n            InvocationType='RequestResponse',  # Synchronous call\n            Payload=json.dumps({\n                'source': 'ec2-api-test',\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        )\n        \n        # Parse the response\n        response_payload = json.loads(response['Payload'].read().decode())\n        \n        return {\n            'status': 'SUCCESS' if response['StatusCode'] == 200 else 'FAILED',\n            'message': 'RDS Snapshot Lambda invoked successfully',\n            'lambda_response': response_payload,\n            'status_code': response['StatusCode']\n        }\n    except Exception as e:\n        return {\n            'status': 'FAILED',\n            'message': str(e),\n            'lambda_function': os.environ.get('LAMBDA_FUNCTION_NAME')\n        }\n\nclass RequestHandler(BaseHTTPRequestHandler):\n    def do_GET(self):\n        if self.path == '/':\n            self.handle_home()\n        elif self.path == '/snapshot':\n            self.handle_snapshot()\n        elif self.path == '/api/snapshot':\n            self.handle_api_snapshot()\n        else:\n            self.send_response(404)\n            self.send_header('Content-type', 'text/html')\n            self.end_headers()\n            self.wfile.write(b'<h1>404 - Not Found</h1>')\n\n    def handle_home(self):\n        rds_result = test_rds_connection()\n        s3_result = test_s3_connection()\n\n        self.send_response(200)\n        self.send_header('Content-type', 'text/html')\n        self.end_headers()\n\n        html = f\"\"\"\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <title>${EnvironmentSuffix} Environment</title>\n            <style>\n                body {{ font-family: Arial, sans-serif; margin: 40px; }}\n                .success {{ color: green; font-weight: bold; }}\n                .failed {{ color: red; font-weight: bold; }}\n                .info {{ background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 20px; }}\n                .button {{ background: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 5px; }}\n                .button:hover {{ background: #45a049; }}\n            </style>\n        </head>\n        <body>\n            <h1>${EnvironmentSuffix} Environment - Secure Instance</h1>\n\n            <div class=\"info\">\n                <h3>Test APIs:</h3>\n                <a href=\"/snapshot\" class=\"button\">Test RDS Snapshot (Web)</a>\n                <a href=\"/api/snapshot\" class=\"button\">Test RDS Snapshot (JSON API)</a>\n            </div>\n\n            <h2>RDS Connection Test</h2>\n            <div class=\"info\">\n                <p><strong>Status:</strong> <span class=\"{rds_result['status'].lower()}\">{rds_result['status']}</span></p>\n                <p><strong>Message:</strong> {rds_result['message']}</p>\n                <p><strong>Endpoint:</strong> {rds_result.get('endpoint', 'N/A')}</p>\n                {f\"<p><strong>MySQL Version:</strong> {rds_result.get('mysql_version', 'N/A')}</p>\" if rds_result['status'] == 'SUCCESS' else ''}\n            </div>\n\n            <h2>S3 Connection Test</h2>\n            <div class=\"info\">\n                <p><strong>Status:</strong> <span class=\"{s3_result['status'].lower()}\">{s3_result['status']}</span></p>\n                <p><strong>Message:</strong> {s3_result['message']}</p>\n                <p><strong>Bucket Name:</strong> {s3_result.get('bucket_name', 'N/A')}</p>\n                {f\"<p><strong>Test Key:</strong> {s3_result.get('test_key', 'N/A')}</p>\" if s3_result['status'] == 'SUCCESS' else ''}\n                {f\"<p><strong>Content Match:</strong> {s3_result.get('content_match', 'N/A')}</p>\" if s3_result['status'] == 'SUCCESS' else ''}\n            </div>\n        </body>\n        </html>\n        \"\"\"\n        \n        self.wfile.write(html.encode())\n\n    def handle_snapshot(self):\n        snapshot_result = trigger_rds_snapshot()\n\n        self.send_response(200)\n        self.send_header('Content-type', 'text/html')\n        self.end_headers()\n\n        html = f\"\"\"\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <title>RDS Snapshot Test - ${EnvironmentSuffix}</title>\n            <style>\n                body {{ font-family: Arial, sans-serif; margin: 40px; }}\n                .success {{ color: green; font-weight: bold; }}\n                .failed {{ color: red; font-weight: bold; }}\n                .info {{ background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 20px; }}\n                .button {{ background: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; }}\n            </style>\n        </head>\n        <body>\n            <h1>RDS Snapshot Test Results</h1>\n            \n            <div class=\"info\">\n                <p><strong>Status:</strong> <span class=\"{snapshot_result['status'].lower()}\">{snapshot_result['status']}</span></p>\n                <p><strong>Message:</strong> {snapshot_result['message']}</p>\n                <p><strong>Lambda Function:</strong> {os.environ.get('LAMBDA_FUNCTION_NAME', 'N/A')}</p>\n                {f\"<p><strong>Status Code:</strong> {snapshot_result.get('status_code', 'N/A')}</p>\" if 'status_code' in snapshot_result else ''}\n                {f\"<p><strong>Lambda Response:</strong> <pre>{json.dumps(snapshot_result.get('lambda_response', {{}}), indent=2)}</pre></p>\" if 'lambda_response' in snapshot_result else ''}\n            </div>\n            \n            <a href=\"/\" class=\"button\">Back to Home</a>\n        </body>\n        </html>\n        \"\"\"\n        \n        self.wfile.write(html.encode())\n\n    def handle_api_snapshot(self):\n        snapshot_result = trigger_rds_snapshot()\n        \n        self.send_response(200 if snapshot_result['status'] == 'SUCCESS' else 500)\n        self.send_header('Content-type', 'application/json')\n        self.end_headers()\n        \n        response = {\n            'timestamp': datetime.utcnow().isoformat(),\n            'environment': os.environ.get('AWS_REGION', 'unknown'),\n            'snapshot_result': snapshot_result\n        }\n        \n        self.wfile.write(json.dumps(response, indent=2).encode())\n    \n    def log_message(self, format, *args):\n        pass\n\nif __name__ == '__main__':\n    server = HTTPServer(('0.0.0.0', 80), RequestHandler)\n    print('Server started on port 80')\n    server.serve_forever()\nEOFPYTHON\n\n# Set environment variables and run server\nexport RDS_ENDPOINT=\"$RDS_ENDPOINT\"\nexport SECRET_ARN=\"$SECRET_ARN\"\nexport AWS_REGION=\"$REGION\"\nexport S3_BUCKET=\"$S3_BUCKET\"\nexport LAMBDA_FUNCTION_NAME=\"$LAMBDA_FUNCTION_NAME\"\n\n# Make script executable and run\nchmod +x /home/ec2-user/server.py\nnohup python3 /home/ec2-user/server.py > /var/log/server.log 2>&1 &\n\n# Install CloudWatch Agent\nwget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm\nrpm -U ./amazon-cloudwatch-agent.rpm\n"
                        }
                    },
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "${EnvironmentSuffix}-WebServer"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentSuffix"
                                    }
                                },
                                {
                                    "Key": "Project",
                                    "Value": {
                                        "Ref": "ProjectName"
                                    }
                                },
                                {
                                    "Key": "Owner",
                                    "Value": {
                                        "Ref": "OwnerName"
                                    }
                                }
                            ]
                        },
                        {
                            "ResourceType": "volume",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "${EnvironmentSuffix}-Volume"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentSuffix"
                                    }
                                },
                                {
                                    "Key": "Project",
                                    "Value": {
                                        "Ref": "ProjectName"
                                    }
                                },
                                {
                                    "Key": "Owner",
                                    "Value": {
                                        "Ref": "OwnerName"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AutoScalingGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-ASG"
                },
                "MixedInstancesPolicy": {
                    "LaunchTemplate": {
                        "LaunchTemplateSpecification": {
                            "LaunchTemplateId": {
                                "Ref": "LaunchTemplate"
                            },
                            "Version": {
                                "Fn::GetAtt": [
                                    "LaunchTemplate",
                                    "LatestVersionNumber"
                                ]
                            }
                        },
                        "Overrides": [
                            {
                                "InstanceType": {
                                    "Fn::If": [
                                        "IsDev",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "dev",
                                                "InstanceType"
                                            ]
                                        },
                                        {
                                            "Fn::If": [
                                                "IsStaging",
                                                {
                                                    "Fn::FindInMap": [
                                                        "EnvironmentConfig",
                                                        "staging",
                                                        "InstanceType"
                                                    ]
                                                },
                                                {
                                                    "Fn::If": [
                                                        "IsProduction",
                                                        {
                                                            "Fn::FindInMap": [
                                                                "EnvironmentConfig",
                                                                "production",
                                                                "InstanceType"
                                                            ]
                                                        },
                                                        {
                                                            "Fn::FindInMap": [
                                                                "EnvironmentConfig",
                                                                "default",
                                                                "InstanceType"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            },
                            {
                                "InstanceType": "t3.medium"
                            }
                        ]
                    },
                    "InstancesDistribution": {
                        "OnDemandAllocationStrategy": "prioritized",
                        "OnDemandBaseCapacity": 0,
                        "OnDemandPercentageAboveBaseCapacity": 100
                    }
                },
                "MinSize": {
                    "Fn::If": [
                        "IsDev",
                        {
                            "Fn::FindInMap": [
                                "EnvironmentConfig",
                                "dev",
                                "MinSize"
                            ]
                        },
                        {
                            "Fn::If": [
                                "IsStaging",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "MinSize"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsProduction",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "production",
                                                "MinSize"
                                            ]
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "default",
                                                "MinSize"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "MaxSize": {
                    "Fn::If": [
                        "IsDev",
                        {
                            "Fn::FindInMap": [
                                "EnvironmentConfig",
                                "dev",
                                "MaxSize"
                            ]
                        },
                        {
                            "Fn::If": [
                                "IsStaging",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "MaxSize"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsProduction",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "production",
                                                "MaxSize"
                                            ]
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "default",
                                                "MaxSize"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "DesiredCapacity": {
                    "Fn::If": [
                        "IsDev",
                        {
                            "Fn::FindInMap": [
                                "EnvironmentConfig",
                                "dev",
                                "DesiredCapacity"
                            ]
                        },
                        {
                            "Fn::If": [
                                "IsStaging",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "DesiredCapacity"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsProduction",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "production",
                                                "DesiredCapacity"
                                            ]
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "default",
                                                "DesiredCapacity"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    }
                ],
                "TargetGroupARNs": [
                    {
                        "Ref": "ALBTargetGroup"
                    }
                ],
                "HealthCheckType": "ELB",
                "HealthCheckGracePeriod": 300,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "CostOptimized",
                        "Value": "true",
                        "PropagateAtLaunch": true
                    }
                ]
            }
        },
        "DbSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-credentials-${AWS::AccountId}"
                },
                "Description": "RDS database credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"admin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 16,
                    "ExcludeCharacters": "\"@/\\\\",
                    "RequireEachIncludedType": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-db-secret"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "DbParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "DBParameterGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-params"
                },
                "Description": "Parameter group for MySQL database",
                "Family": "mysql8.0",
                "Parameters": {
                    "innodb_buffer_pool_size": "{DBInstanceClassMemory*3/4}"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "${EnvironmentSuffix}-db-subnet-group"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS database",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "RDSDatabase": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentSuffix}-database"
                },
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "DBInstanceClass": {
                    "Fn::If": [
                        "IsDev",
                        {
                            "Fn::FindInMap": [
                                "EnvironmentConfig",
                                "dev",
                                "DBInstanceClass"
                            ]
                        },
                        {
                            "Fn::If": [
                                "IsStaging",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "DBInstanceClass"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsProduction",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "production",
                                                "DBInstanceClass"
                                            ]
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "default",
                                                "DBInstanceClass"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "AllocatedStorage": 20,
                "MaxAllocatedStorage": 100,
                "StorageType": "gp3",
                "StorageEncrypted": true,
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "MultiAZ": {
                    "Fn::If": [
                        "IsDev",
                        {
                            "Fn::FindInMap": [
                                "EnvironmentConfig",
                                "dev",
                                "MultiAZ"
                            ]
                        },
                        {
                            "Fn::If": [
                                "IsStaging",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "staging",
                                        "MultiAZ"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsProduction",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "production",
                                                "MultiAZ"
                                            ]
                                        },
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "default",
                                                "MultiAZ"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                "PubliclyAccessible": false,
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "DBParameterGroupName": {
                    "Ref": "DbParameterGroup"
                },
                "MasterUsername": {
                    "Fn::Join": [
                        "",
                        [
                            "{{resolve:secretsmanager:",
                            {
                                "Ref": "DbSecret"
                            },
                            ":SecretString:username}}"
                        ]
                    ]
                },
                "MasterUserPassword": {
                    "Fn::Join": [
                        "",
                        [
                            "{{resolve:secretsmanager:",
                            {
                                "Ref": "DbSecret"
                            },
                            ":SecretString:password}}"
                        ]
                    ]
                },
                "EnableIAMDatabaseAuthentication": true,
                "MonitoringInterval": 0,
                "EnablePerformanceInsights": false,
                "DeletionProtection": false,
                "DeleteAutomatedBackups": true,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentSuffix}-${AWS::AccountId}-data"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 30
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "EC2S3AccessPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "EC2S3Access",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:PutObject",
                                "s3:ListBucket",
                                "s3:DeleteObject"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "${S3Bucket.Arn}"
                                },
                                {
                                    "Fn::Sub": "${S3Bucket.Arn}/*"
                                }
                            ]
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "CloudTrailBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentSuffix}-${AWS::AccountId}-cloudtrail"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 90
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "CloudTrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "CloudTrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "CloudTrailBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${CloudTrailBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "CloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "DependsOn": [
                "CloudTrailBucketPolicy"
            ],
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Trail"
                },
                "S3BucketName": {
                    "Ref": "CloudTrailBucket"
                },
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "CPUAlarmHigh": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentSuffix}-CPU-Utilization-High"
                },
                "AlarmDescription": "Alarm when CPU exceeds 75%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 75,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DatabaseCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentSuffix}-RDS-CPU-Utilization"
                },
                "AlarmDescription": "Alarm when RDS CPU exceeds 75%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 75,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "RDSDatabase"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "SNSTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Alerts"
                },
                "DisplayName": {
                    "Fn::Sub": "${EnvironmentSuffix} Environment Alerts"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "RDSSnapshotLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentSuffix}-RDS-Snapshot-Lambda"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Environment": {
                    "Variables": {
                        "DB_INSTANCE_ID": {
                            "Ref": "RDSDatabase"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import boto3\nimport os\nfrom datetime import datetime\n\ndef handler(event, context):\n    rds = boto3.client('rds')\n    db_instance_id = os.environ['DB_INSTANCE_ID']\n    environment = os.environ['ENVIRONMENT']\n    \n    timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')\n    snapshot_id = f\"{db_instance_id}-snapshot-{timestamp}\"\n    \n    try:\n        response = rds.create_db_snapshot(\n            DBSnapshotIdentifier=snapshot_id,\n            DBInstanceIdentifier=db_instance_id,\n            Tags=[\n                {'Key': 'Environment', 'Value': environment},\n                {'Key': 'Type', 'Value': 'Automated'}\n            ]\n        )\n        print(f\"Snapshot {snapshot_id} initiated successfully\")\n        return {\n            'statusCode': 200,\n            'body': f'Snapshot {snapshot_id} created'\n        }\n    except Exception as e:\n        print(f\"Error creating snapshot: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': f'Error: {str(e)}'\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "SnapshotScheduleRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-RDS-Snapshot-Schedule"
                },
                "Description": "Schedule for RDS snapshots",
                "ScheduleExpression": "rate(1 day)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "RDSSnapshotLambda",
                                "Arn"
                            ]
                        },
                        "Id": "RDSSnapshotLambdaTarget"
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "RDSSnapshotLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "SnapshotScheduleRule",
                        "Arn"
                    ]
                }
            }
        },
        "InstanceSchedulerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Instance-Scheduler-Role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "InstanceSchedulerPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "autoscaling:UpdateAutoScalingGroup",
                                        "autoscaling:DescribeAutoScalingGroups",
                                        "ec2:DescribeInstances",
                                        "rds:DescribeDBInstances",
                                        "rds:StopDBInstance",
                                        "rds:StartDBInstance"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "StopInstancesLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Stop-Instances"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "InstanceSchedulerRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "Environment": {
                    "Variables": {
                        "ASG_NAME": {
                            "Ref": "AutoScalingGroup"
                        },
                        "DB_IDENTIFIER": {
                            "Ref": "RDSDatabase"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import boto3\nimport os\n\ndef handler(event, context):\n    asg_client = boto3.client('autoscaling')\n    rds_client = boto3.client('rds')\n    \n    asg_name = os.environ['ASG_NAME']\n    db_identifier = os.environ['DB_IDENTIFIER']\n    \n    try:\n        # Scale down ASG to 0\n        asg_client.update_auto_scaling_group(\n            AutoScalingGroupName=asg_name,\n            MinSize=0,\n            DesiredCapacity=0\n        )\n        print(f\"Scaled down ASG: {asg_name}\")\n        \n        # Stop RDS instance (only for non-production)\n        if not db_identifier.endswith('-production-database'):\n            rds_client.stop_db_instance(\n                DBInstanceIdentifier=db_identifier\n            )\n            print(f\"Stopped RDS instance: {db_identifier}\")\n        \n        return {'statusCode': 200, 'body': 'Resources stopped successfully'}\n    except Exception as e:\n        print(f\"Error: {str(e)}\")\n        return {'statusCode': 500, 'body': f'Error: {str(e)}'}\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "StartInstancesLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentSuffix}-Start-Instances"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "InstanceSchedulerRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "Environment": {
                    "Variables": {
                        "ASG_NAME": {
                            "Ref": "AutoScalingGroup"
                        },
                        "DB_IDENTIFIER": {
                            "Ref": "RDSDatabase"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "MIN_SIZE": {
                            "Fn::If": [
                                "IsDev",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "dev",
                                        "MinSize"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsStaging",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "staging",
                                                "MinSize"
                                            ]
                                        },
                                        {
                                            "Fn::If": [
                                                "IsProduction",
                                                {
                                                    "Fn::FindInMap": [
                                                        "EnvironmentConfig",
                                                        "production",
                                                        "MinSize"
                                                    ]
                                                },
                                                {
                                                    "Fn::FindInMap": [
                                                        "EnvironmentConfig",
                                                        "default",
                                                        "MinSize"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        "DESIRED_CAPACITY": {
                            "Fn::If": [
                                "IsDev",
                                {
                                    "Fn::FindInMap": [
                                        "EnvironmentConfig",
                                        "dev",
                                        "DesiredCapacity"
                                    ]
                                },
                                {
                                    "Fn::If": [
                                        "IsStaging",
                                        {
                                            "Fn::FindInMap": [
                                                "EnvironmentConfig",
                                                "staging",
                                                "DesiredCapacity"
                                            ]
                                        },
                                        {
                                            "Fn::If": [
                                                "IsProduction",
                                                {
                                                    "Fn::FindInMap": [
                                                        "EnvironmentConfig",
                                                        "production",
                                                        "DesiredCapacity"
                                                    ]
                                                },
                                                {
                                                    "Fn::FindInMap": [
                                                        "EnvironmentConfig",
                                                        "default",
                                                        "DesiredCapacity"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import boto3\nimport os\n\ndef handler(event, context):\n    asg_client = boto3.client('autoscaling')\n    rds_client = boto3.client('rds')\n    \n    asg_name = os.environ['ASG_NAME']\n    db_identifier = os.environ['DB_IDENTIFIER']\n    min_size = int(os.environ['MIN_SIZE'])\n    desired_capacity = int(os.environ['DESIRED_CAPACITY'])\n    \n    try:\n        # Scale up ASG\n        asg_client.update_auto_scaling_group(\n            AutoScalingGroupName=asg_name,\n            MinSize=min_size,\n            DesiredCapacity=desired_capacity\n        )\n        print(f\"Scaled up ASG: {asg_name}\")\n        \n        # Start RDS instance (only for non-production)\n        if not db_identifier.endswith('-production-database'):\n            rds_client.start_db_instance(\n                DBInstanceIdentifier=db_identifier\n            )\n            print(f\"Started RDS instance: {db_identifier}\")\n        \n        return {'statusCode': 200, 'body': 'Resources started successfully'}\n    except Exception as e:\n        print(f\"Error: {str(e)}\")\n        return {'statusCode': 500, 'body': f'Error: {str(e)}'}\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "OwnerName"
                        }
                    }
                ]
            }
        },
        "StopInstancesSchedule": {
            "Type": "AWS::Events::Rule",
            "Condition": "EnableScheduling",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-Stop-Instances-Schedule"
                },
                "Description": "Stop instances at 8 PM UTC on weekdays for cost optimization",
                "ScheduleExpression": "cron(0 20 ? * MON-FRI *)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "StopInstancesLambda",
                                "Arn"
                            ]
                        },
                        "Id": "StopInstancesTarget"
                    }
                ]
            }
        },
        "StartInstancesSchedule": {
            "Type": "AWS::Events::Rule",
            "Condition": "EnableScheduling",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-Start-Instances-Schedule"
                },
                "Description": "Start instances at 6 AM UTC on weekdays for cost optimization",
                "ScheduleExpression": "cron(0 6 ? * MON-FRI *)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "StartInstancesLambda",
                                "Arn"
                            ]
                        },
                        "Id": "StartInstancesTarget"
                    }
                ]
            }
        },
        "StopLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Condition": "EnableScheduling",
            "Properties": {
                "FunctionName": {
                    "Ref": "StopInstancesLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "StopInstancesSchedule",
                        "Arn"
                    ]
                }
            }
        },
        "StartLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Condition": "EnableScheduling",
            "Properties": {
                "FunctionName": {
                    "Ref": "StartInstancesLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "StartInstancesSchedule",
                        "Arn"
                    ]
                }
            }
        },
        "AMIParameter": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/${EnvironmentSuffix}/ami-id"
                },
                "Type": "String",
                "Value": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                "Description": "Latest Amazon Linux 2 AMI ID for EC2 instances",
                "Tags": {
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    },
                    "Project": {
                        "Ref": "ProjectName"
                    },
                    "Owner": {
                        "Ref": "OwnerName"
                    }
                }
            }
        },
        "DBEndpointParameter": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/${EnvironmentSuffix}/db-endpoint"
                },
                "Type": "String",
                "Value": {
                    "Fn::GetAtt": [
                        "RDSDatabase",
                        "Endpoint.Address"
                    ]
                },
                "Description": "RDS Database Endpoint",
                "Tags": {
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    },
                    "Project": {
                        "Ref": "ProjectName"
                    },
                    "Owner": {
                        "Ref": "OwnerName"
                    }
                }
            }
        },
        "DBSecretParameter": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/${EnvironmentSuffix}/db-secret-arn"
                },
                "Type": "String",
                "Value": {
                    "Ref": "DbSecret"
                },
                "Description": "RDS Database Secret ARN",
                "Tags": {
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    },
                    "Project": {
                        "Ref": "ProjectName"
                    },
                    "Owner": {
                        "Ref": "OwnerName"
                    }
                }
            }
        }
    },
    "Outputs": {
        "EC2KeyPairName": {
            "Description": "EC2 Key Pair Name for SSH access",
            "Value": {
                "Ref": "EC2KeyPair"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-KeyPair-Name"
                }
            }
        },
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-VPC-ID"
                }
            }
        },
        "ALBDNSName": {
            "Description": "Application Load Balancer DNS Name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-ALB-DNS"
                }
            }
        },
        "RDSEndpoint": {
            "Description": "RDS Database Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "RDSDatabase",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-RDS-Endpoint"
                }
            }
        },
        "S3BucketName": {
            "Description": "S3 Bucket Name",
            "Value": {
                "Ref": "S3Bucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-S3-Bucket"
                }
            }
        },
        "CloudTrailBucketName": {
            "Description": "CloudTrail Bucket Name",
            "Value": {
                "Ref": "CloudTrailBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-CloudTrail-Bucket"
                }
            }
        },
        "Environment": {
            "Description": "Environment Name",
            "Value": {
                "Ref": "EnvironmentSuffix"
            }
        },
        "ProjectName": {
            "Description": "Project Name",
            "Value": {
                "Ref": "ProjectName"
            }
        },
        "DBSecretArn": {
            "Description": "Database Secret ARN",
            "Value": {
                "Ref": "DbSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-DB-Secret-ARN"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Ref": "KMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-KMSKey"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure AWS logging infrastructure with S3, Lambda, and RDS",
    "Resources": {
        "DBPasswordSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "RDS Database Administrator Password",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"admin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    },
                    {
                        "Key": "Name",
                        "Value": "RDS-DB-Password"
                    }
                ]
            }
        },
        "SecureVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    },
                    {
                        "Key": "Name",
                        "Value": "SecureLoggingVPC"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    },
                    {
                        "Key": "Name",
                        "Value": "PrivateSubnet1"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    },
                    {
                        "Key": "Name",
                        "Value": "PrivateSubnet2"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "Subnet group for secure RDS database",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "RDSEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for RDS database encryption",
                "KeyPolicy": {
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow RDS Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "RDSEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": "alias/secure-logging-rds-key",
                "TargetKeyId": {
                    "Ref": "RDSEncryptionKey"
                }
            }
        },
        "RDSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for RDS database - internal access only",
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda function",
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS for AWS API calls"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "SecureLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "tapstack-secure-logs-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "SecureLogsRetentionPolicy",
                            "Status": "Enabled",
                            "ExpirationInDays": 365,
                            "NoncurrentVersionExpirationInDays": 30,
                            "Transitions": [
                                {
                                    "StorageClass": "STANDARD_IA",
                                    "TransitionInDays": 30
                                },
                                {
                                    "StorageClass": "GLACIER",
                                    "TransitionInDays": 90
                                },
                                {
                                    "StorageClass": "DEEP_ARCHIVE",
                                    "TransitionInDays": 180
                                }
                            ]
                        }
                    ]
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "AccessLogsBucket"
                    },
                    "LogFilePrefix": "access-logs/"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "AccessLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "tapstack-access-logs-${AWS::AccountId}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "AccessLogsRetentionPolicy",
                            "Status": "Enabled",
                            "ExpirationInDays": 90,
                            "Transitions": [
                                {
                                    "StorageClass": "STANDARD_IA",
                                    "TransitionInDays": 30
                                }
                            ]
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "SecureLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "SecureLogsBucket"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Sid": "DenyPublicAccess",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "DenyInsecureConnections",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3LogsAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "RDSAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "rds-db:connect"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${SecureRDSInstance}/admin"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "LogProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${AWS::StackName}-log-processor"
                },
                "Runtime": "python3.12",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "MemorySize": 256,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DB_ENDPOINT": {
                            "Fn::GetAtt": [
                                "SecureRDSInstance",
                                "Endpoint.Address"
                            ]
                        },
                        "DB_USERNAME": "admin",
                        "S3_BUCKET": {
                            "Ref": "SecureLogsBucket"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport pymysql\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Process logs from S3 and store results in RDS\n    \"\"\"\n    s3_client = boto3.client('s3')\n    \n    # Database connection parameters\n    db_endpoint = os.environ['DB_ENDPOINT']\n    db_username = os.environ['DB_USERNAME']\n    s3_bucket = os.environ['S3_BUCKET']\n    \n    try:\n        # Process S3 event records\n        for record in event.get('Records', []):\n            if record.get('eventSource') == 'aws:s3':\n                bucket = record['s3']['bucket']['name']\n                key = record['s3']['object']['key']\n                \n                # Get object from S3\n                response = s3_client.get_object(Bucket=bucket, Key=key)\n                log_content = response['Body'].read().decode('utf-8')\n                \n                # Here you would process the log content\n                # For this example, we'll just log the processing\n                print(f\"Processing log file: {key}\")\n                print(f\"Content length: {len(log_content)}\")\n                \n                # In a real implementation, you would:\n                # 1. Parse the log content\n                # 2. Extract relevant information\n                # 3. Store processed data in RDS\n                \n        return {\n            'statusCode': 200,\n            'body': json.dumps('Log processing completed successfully')\n        }\n        \n    except Exception as e:\n        print(f\"Error processing logs: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps(f'Error: {str(e)}')\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "LogProcessorFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "s3.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}"
                }
            }
        },
        "S3BucketNotificationCustomResource": {
            "Type": "Custom::S3BucketNotification",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "S3NotificationLambda",
                        "Arn"
                    ]
                },
                "BucketName": {
                    "Ref": "SecureLogsBucket"
                },
                "LambdaFunctionArn": {
                    "Fn::GetAtt": [
                        "LogProcessorFunction",
                        "Arn"
                    ]
                }
            },
            "DependsOn": "LambdaInvokePermission"
        },
        "S3NotificationLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${AWS::StackName}-s3-notification-handler"
                },
                "Runtime": "python3.12",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "S3NotificationLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport urllib3\nimport time\nfrom botocore.exceptions import ClientError, BotoCoreError\n\n# Enhanced CloudFormation response implementation with retry logic\ndef send_response(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None, max_retries=3):\n    response_url = event['ResponseURL']\n    \n    response_body = {\n        'Status': response_status,\n        'Reason': reason or f'See CloudWatch Log Stream: {context.log_stream_name}',\n        'PhysicalResourceId': physical_resource_id or context.log_stream_name,\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'NoEcho': no_echo,\n        'Data': response_data\n    }\n    \n    json_response_body = json.dumps(response_body)\n    headers = {\n        'content-type': '',\n        'content-length': str(len(json_response_body))\n    }\n    \n    for attempt in range(max_retries):\n        try:\n            http = urllib3.PoolManager()\n            response = http.request('PUT', response_url, body=json_response_body, headers=headers)\n            print(f'CloudFormation response sent successfully. Status code: {response.status}')\n            return\n        except Exception as e:\n            print(f'Attempt {attempt + 1} failed to send CloudFormation response: {e}')\n            if attempt < max_retries - 1:\n                time.sleep(2 ** attempt)  # Exponential backoff\n            else:\n                print('Failed to send CloudFormation response after all retries')\n\ndef lambda_handler(event, context):\n    print(f'S3 Notification Handler - Received event: {json.dumps(event, indent=2)}')\n    \n    # Input validation\n    try:\n        request_type = event.get('RequestType')\n        if not request_type:\n            raise ValueError('RequestType is required')\n            \n        resource_properties = event.get('ResourceProperties', {})\n        bucket_name = resource_properties.get('BucketName')\n        lambda_arn = resource_properties.get('LambdaFunctionArn')\n        \n        if not bucket_name:\n            raise ValueError('BucketName is required in ResourceProperties')\n            \n        if request_type in ['Create', 'Update'] and not lambda_arn:\n            raise ValueError('LambdaFunctionArn is required for Create/Update operations')\n            \n    except ValueError as e:\n        print(f'Input validation error: {str(e)}')\n        send_response(event, context, 'FAILED', {}, reason=f'Input validation failed: {str(e)}')\n        return\n    \n    try:\n        s3 = boto3.client('s3')\n        \n        if request_type in ['Create', 'Update']:\n            print(f'Configuring S3 notification for bucket: {bucket_name}, Lambda ARN: {lambda_arn}')\n            \n            # Check if bucket exists\n            try:\n                s3.head_bucket(Bucket=bucket_name)\n            except ClientError as e:\n                error_code = e.response['Error']['Code']\n                if error_code == '404':\n                    raise Exception(f'Bucket {bucket_name} does not exist')\n                elif error_code == '403':\n                    raise Exception(f'Access denied to bucket {bucket_name}')\n                else:\n                    raise Exception(f'Error accessing bucket {bucket_name}: {str(e)}')\n            \n            # Configure S3 notification with enhanced error handling\n            notification_config = {\n                'LambdaFunctionConfigurations': [{\n                    'Id': 'LogProcessorNotification',\n                    'LambdaFunctionArn': lambda_arn,\n                    'Events': ['s3:ObjectCreated:*'],\n                    'Filter': {\n                        'Key': {\n                            'FilterRules': [{\n                                'Name': 'prefix',\n                                'Value': 'logs/'\n                            }]\n                        }\n                    }\n                }]\n            }\n            \n            s3.put_bucket_notification_configuration(\n                Bucket=bucket_name,\n                NotificationConfiguration=notification_config\n            )\n            print('S3 notification configured successfully with logs/ prefix filter')\n            \n        elif request_type == 'Delete':\n            print(f'Removing S3 notification for bucket: {bucket_name}')\n            \n            try:\n                # Only remove notification if bucket still exists\n                s3.head_bucket(Bucket=bucket_name)\n                s3.put_bucket_notification_configuration(\n                    Bucket=bucket_name,\n                    NotificationConfiguration={}\n                )\n                print('S3 notification removed successfully')\n            except ClientError as e:\n                error_code = e.response['Error']['Code']\n                if error_code == '404':\n                    print(f'Bucket {bucket_name} no longer exists, skipping notification removal')\n                else:\n                    print(f'Warning: Could not remove notification from bucket {bucket_name}: {str(e)}')\n        else:\n            raise ValueError(f'Unsupported RequestType: {request_type}')\n        \n        send_response(event, context, 'SUCCESS', {\n            'BucketName': bucket_name,\n            'RequestType': request_type,\n            'Message': f'S3 notification {request_type.lower()} completed successfully'\n        })\n        \n    except ClientError as e:\n        error_message = f'AWS Client Error: {str(e)}'\n        print(error_message)\n        send_response(event, context, 'FAILED', {}, reason=error_message)\n        \n    except BotoCoreError as e:\n        error_message = f'AWS BotoCore Error: {str(e)}'\n        print(error_message)\n        send_response(event, context, 'FAILED', {}, reason=error_message)\n        \n    except Exception as e:\n        error_message = f'Unexpected error: {str(e)}'\n        print(error_message)\n        import traceback\n        traceback.print_exc()\n        send_response(event, context, 'FAILED', {}, reason=error_message)\n"
                }
            }
        },
        "S3NotificationLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3NotificationAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketNotification",
                                        "s3:PutBucketNotification"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::tapstack-secure-logs-${AWS::AccountId}"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "SecureRDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${AWS::StackName}-secure-db"
                },
                "DBInstanceClass": "db.t3.micro",
                "Engine": "mysql",
                "EngineVersion": "8.0.39",
                "MasterUsername": "admin",
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBPasswordSecret}:SecretString:password}}"
                },
                "AllocatedStorage": 20,
                "StorageType": "gp2",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "RDSEncryptionKey"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "RDSSecurityGroup"
                    }
                ],
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "BackupRetentionPeriod": 7,
                "MultiAZ": false,
                "PubliclyAccessible": false,
                "DeletionProtection": false,
                "EnablePerformanceInsights": false,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "RDSMonitoringRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "RDSMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    }
                ]
            }
        },
        "S3VPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "VpcEndpointType": "Gateway",
                "RouteTableIds": [
                    {
                        "Ref": "PrivateRouteTable"
                    }
                ]
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "SecureVPC"
                },
                "Tags": [
                    {
                        "Key": "Project",
                        "Value": "SecurityConfig"
                    },
                    {
                        "Key": "Name",
                        "Value": "PrivateRouteTable"
                    }
                ]
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "RDSIngressRule": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "RDSSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": 3306,
                "ToPort": 3306,
                "SourceSecurityGroupId": {
                    "Ref": "LambdaSecurityGroup"
                },
                "Description": "Allow Lambda access to RDS"
            }
        },
        "LambdaEgressRule": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "LambdaSecurityGroup"
                },
                "IpProtocol": "tcp",
                "FromPort": 3306,
                "ToPort": 3306,
                "DestinationSecurityGroupId": {
                    "Ref": "RDSSecurityGroup"
                },
                "Description": "Allow Lambda to connect to RDS"
            }
        }
    },
    "Outputs": {
        "S3BucketName": {
            "Description": "Name of the secure S3 bucket for logs",
            "Value": {
                "Ref": "SecureLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecureLogsBucket"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the log processor Lambda function",
            "Value": {
                "Ref": "LogProcessorFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogProcessorFunction"
                }
            }
        },
        "RDSEndpoint": {
            "Description": "RDS database endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "SecureRDSInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSEndpoint"
                }
            }
        },
        "VPCId": {
            "Description": "VPC ID for the secure infrastructure",
            "Value": {
                "Ref": "SecureVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID used for RDS encryption",
            "Value": {
                "Ref": "RDSEncryptionKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSKMSKey"
                }
            }
        }
    }
}
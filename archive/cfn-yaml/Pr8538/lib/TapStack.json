{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TapStack â€” Production-ready CloudFormation Stack Migration Framework (multi-account / multi-region). Builds orchestration (Step Functions + Lambda), least-privilege IAM, logging/alarms, safety guards, dry-run simulation, retry/backoff, and validation utilities from scratch. All physical names include ENVIRONMENT_SUFFIX to avoid collisions.\n",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Environment/naming suffix appended to all resource names to avoid collisions (e.g., \"prod-us\", \"production\", \"qa\", \"dev-eu1\"). Must start with a lowercase letter or digit and may contain hyphen-separated segments of lowercase letters/digits.\n",
            "MinLength": 2,
            "MaxLength": 32,
            "AllowedPattern": "^[a-z0-9]+([\\-][a-z0-9]+)*$",
            "ConstraintDescription": "Use lowercase letters/digits, hyphens between segments. Example: prod-us, production, qa, dev-eu1.",
            "Default": "prod-us"
        },
        "SourceAccountId": {
            "Type": "String",
            "Description": "AWS Account ID that currently hosts the source stack.",
            "AllowedPattern": "^\\d{12}$",
            "ConstraintDescription": "Must be a 12-digit AWS account ID.",
            "Default": "111122223333"
        },
        "TargetAccountId": {
            "Type": "String",
            "Description": "AWS Account ID for the target (destination) of the migration.",
            "AllowedPattern": "^\\d{12}$",
            "ConstraintDescription": "Must be a 12-digit AWS account ID.",
            "Default": "444455556666"
        },
        "SourceRoleName": {
            "Type": "String",
            "Description": "Name of the assumable role in the source account used by the orchestrator.",
            "MinLength": 3,
            "MaxLength": 64,
            "AllowedPattern": "^[A-Za-z0-9+=,.@_\\-]{3,64}$",
            "Default": "TapStackSourceRole"
        },
        "TargetRoleName": {
            "Type": "String",
            "Description": "Name of the assumable role in the target account used by the orchestrator.",
            "MinLength": 3,
            "MaxLength": 64,
            "AllowedPattern": "^[A-Za-z0-9+=,.@_\\-]{3,64}$",
            "Default": "TapStackTargetRole"
        },
        "ExternalId": {
            "Type": "String",
            "Description": "External ID required by cross-account roles to mitigate the confused-deputy problem.",
            "MinLength": 6,
            "MaxLength": 128,
            "AllowedPattern": "^[A-Za-z0-9\\-:_./+=@]{6,128}$",
            "Default": "TapStack-External-Id-Default-12345"
        },
        "SourceRegion": {
            "Type": "String",
            "Description": "Source AWS Region (validated by a region-like regex pattern).",
            "Default": "us-east-1",
            "AllowedPattern": "^(af|ap|ca|eu|il|me|sa|us)\\-[a-z0-9\\-]+-\\d$",
            "ConstraintDescription": "Must resemble an AWS region name like us-east-1, eu-west-1, ap-southeast-2."
        },
        "TargetRegion": {
            "Type": "String",
            "Description": "Target AWS Region (validated by a region-like regex pattern).",
            "Default": "eu-west-1",
            "AllowedPattern": "^(af|ap|ca|eu|il|me|sa|us)\\-[a-z0-9\\-]+-\\d$",
            "ConstraintDescription": "Must resemble an AWS region name like us-east-1, eu-west-1, ap-southeast-2."
        },
        "PredefinedVPCIdUsEast1": {
            "Type": "String",
            "Default": "vpc-0abc1234def567890",
            "Description": "Predefined VPC ID for us-east-1.",
            "AllowedPattern": "^(vpc\\-[0-9a-f]{8,17}|)$"
        },
        "PredefinedVPCIdEuWest1": {
            "Type": "String",
            "Default": "vpc-0123abccdef567890",
            "Description": "Predefined VPC ID for eu-west-1.",
            "AllowedPattern": "^(vpc\\-[0-9a-f]{8,17}|)$"
        },
        "PredefinedVPCIdApSoutheast2": {
            "Type": "String",
            "Default": "vpc-0a1b2c3d4e5f67890",
            "Description": "Predefined VPC ID for ap-southeast-2.",
            "AllowedPattern": "^(vpc\\-[0-9a-f]{8,17}|)$"
        },
        "MigrationTags": {
            "Type": "String",
            "Default": "{\"Project\":\"TapStack\",\"Owner\":\"Engineering\",\"Compliance\":\"Yes\"}",
            "Description": "JSON string of key-value tags to propagate to Lambdas/SFN for structured logging. (Not used as a resource tag value to avoid service tag restrictions.)\n",
            "AllowedPattern": "^[\\x20-\\x7E]{0,2048}$"
        },
        "DryRun": {
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "When true, simulate operations and log diffs without making resource changes."
        },
        "SafetyGuardLevel": {
            "Type": "String",
            "Default": "standard",
            "Description": "Guard intensity for data-protective behavior (regex-validated).",
            "AllowedPattern": "^(none|low|standard|strict)$",
            "ConstraintDescription": "Use one of none|low|standard|strict."
        },
        "MaxAttempts": {
            "Type": "Number",
            "Default": 6,
            "MinValue": 1,
            "MaxValue": 20,
            "Description": "Max retry attempts for AWS API calls (exponential backoff with jitter)."
        },
        "InitialBackoffSeconds": {
            "Type": "Number",
            "Default": 2,
            "MinValue": 1,
            "MaxValue": 120,
            "Description": "Initial backoff (seconds) for retries."
        },
        "MaxBackoffSeconds": {
            "Type": "Number",
            "Default": 32,
            "MinValue": 2,
            "MaxValue": 600,
            "Description": "Maximum backoff (seconds) cap for retries."
        },
        "EnableLogEncryption": {
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "When true, a KMS key is created and used to encrypt CloudWatch Logs."
        }
    },
    "Conditions": {
        "IsDryRun": {
            "Fn::Equals": [
                {
                    "Ref": "DryRun"
                },
                "true"
            ]
        },
        "UseLogEncryption": {
            "Fn::Equals": [
                {
                    "Ref": "EnableLogEncryption"
                },
                "true"
            ]
        },
        "IsStrict": {
            "Fn::Equals": [
                {
                    "Ref": "SafetyGuardLevel"
                },
                "strict"
            ]
        },
        "IsStandard": {
            "Fn::Equals": [
                {
                    "Ref": "SafetyGuardLevel"
                },
                "standard"
            ]
        },
        "IsLow": {
            "Fn::Equals": [
                {
                    "Ref": "SafetyGuardLevel"
                },
                "low"
            ]
        },
        "IsNone": {
            "Fn::Equals": [
                {
                    "Ref": "SafetyGuardLevel"
                },
                "none"
            ]
        },
        "SourceIsUsEast1": {
            "Fn::Equals": [
                {
                    "Ref": "SourceRegion"
                },
                "us-east-1"
            ]
        },
        "SourceIsEuWest1": {
            "Fn::Equals": [
                {
                    "Ref": "SourceRegion"
                },
                "eu-west-1"
            ]
        },
        "SourceIsApSoutheast2": {
            "Fn::Equals": [
                {
                    "Ref": "SourceRegion"
                },
                "ap-southeast-2"
            ]
        },
        "TargetIsUsEast1": {
            "Fn::Equals": [
                {
                    "Ref": "TargetRegion"
                },
                "us-east-1"
            ]
        },
        "TargetIsEuWest1": {
            "Fn::Equals": [
                {
                    "Ref": "TargetRegion"
                },
                "eu-west-1"
            ]
        },
        "TargetIsApSoutheast2": {
            "Fn::Equals": [
                {
                    "Ref": "TargetRegion"
                },
                "ap-southeast-2"
            ]
        }
    },
    "Resources": {
        "LogsKmsKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "UseLogEncryption",
            "Properties": {
                "Description": {
                    "Fn::Sub": "TapStack Logs KMS Key (${EnvironmentSuffix})"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "RootAccountAdmin",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowCWLogsViaServiceGrant",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "kms:GrantIsForAWSResource": "true"
                                },
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AllowCWLogsByEncContext",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/tapstack/*"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LogsKmsAlias": {
            "Type": "AWS::KMS::Alias",
            "Condition": "UseLogEncryption",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/tapstack-logs-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "LogsKmsKey"
                }
            }
        },
        "OrchestratorLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/tapstack/${EnvironmentSuffix}/orchestrator"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::If": [
                        "UseLogEncryption",
                        {
                            "Fn::GetAtt": [
                                "LogsKmsKey",
                                "Arn"
                            ]
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-orchestrator-logs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Mode",
                        "Value": {
                            "Fn::If": [
                                "IsDryRun",
                                "dry-run",
                                "live"
                            ]
                        }
                    }
                ]
            }
        },
        "MetricFilterErrors": {
            "Type": "AWS::Logs::MetricFilter",
            "Properties": {
                "LogGroupName": {
                    "Ref": "OrchestratorLogGroup"
                },
                "FilterPattern": "{ $.level = \"ERROR\" || $.outcome = \"FAILED\" }",
                "MetricTransformations": [
                    {
                        "MetricName": {
                            "Fn::Sub": "TapStackErrors-${EnvironmentSuffix}"
                        },
                        "MetricNamespace": "TapStack/Migration",
                        "MetricValue": "1"
                    }
                ]
            }
        },
        "MetricFilterThrottles": {
            "Type": "AWS::Logs::MetricFilter",
            "Properties": {
                "LogGroupName": {
                    "Ref": "OrchestratorLogGroup"
                },
                "FilterPattern": "{ $.error = \"ThrottlingException\" || $.throttle = true }",
                "MetricTransformations": [
                    {
                        "MetricName": {
                            "Fn::Sub": "TapStackThrottles-${EnvironmentSuffix}"
                        },
                        "MetricNamespace": "TapStack/Migration",
                        "MetricValue": "1"
                    }
                ]
            }
        },
        "AlarmErrors": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tapstack-errors-alarm-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm on orchestrator error events.",
                "Namespace": "TapStack/Migration",
                "MetricName": {
                    "Fn::Sub": "TapStackErrors-${EnvironmentSuffix}"
                },
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "AlarmThrottles": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tapstack-throttles-alarm-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alarm on throttling events beyond retry thresholds.",
                "Namespace": "TapStack/Migration",
                "MetricName": {
                    "Fn::Sub": "TapStackThrottles-${EnvironmentSuffix}"
                },
                "Statistic": "Sum",
                "Period": 60,
                "EvaluationPeriods": 3,
                "Threshold": 3,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "tapstack-lambda-exec-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowLambdaService",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "tapstack-lambda-inline-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "LogsWrite",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Sid": "AllowDescribeCloudFormation",
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:DescribeStacks",
                                        "cloudformation:ListStackResources",
                                        "cloudformation:DetectStackDrift",
                                        "cloudformation:DescribeStackDriftDetectionStatus",
                                        "cloudformation:ListExports",
                                        "cloudformation:GetTemplate"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Sid": "AllowSTSAssume",
                                    "Effect": "Allow",
                                    "Action": "sts:AssumeRole",
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:iam::${SourceAccountId}:role/${SourceRoleName}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:iam::${TargetAccountId}:role/${TargetRoleName}"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-lambda-exec-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Mode",
                        "Value": {
                            "Fn::If": [
                                "IsDryRun",
                                "dry-run",
                                "live"
                            ]
                        }
                    }
                ]
            }
        },
        "StepFunctionsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "tapstack-sfn-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowStepFunctionsService",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "states.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "tapstack-sfn-inline-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "AllowInvokeLambdas",
                                    "Effect": "Allow",
                                    "Action": [
                                        "lambda:InvokeFunction"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "TemplateDiffLambda",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "PreChecksLambda",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "ApplyChangeLambda",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "PostChecksLambda",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "RollbackLambda",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Sid": "AllowCloudWatchLogsDeliveryAPIs",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogDelivery",
                                        "logs:GetLogDelivery",
                                        "logs:UpdateLogDelivery",
                                        "logs:DeleteLogDelivery",
                                        "logs:ListLogDeliveries",
                                        "logs:PutResourcePolicy",
                                        "logs:DescribeResourcePolicies",
                                        "logs:DescribeLogGroups"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Sid": "AllowBasicLogsWrite",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-sfn-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "OrchestratorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "tapstack-orchestrator-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowLambdaAssume",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "tapstack-orchestrator-inline-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "AllowSTSAssumeSpecific",
                                    "Effect": "Allow",
                                    "Action": "sts:AssumeRole",
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:iam::${SourceAccountId}:role/${SourceRoleName}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:iam::${TargetAccountId}:role/${TargetRoleName}"
                                        }
                                    ],
                                    "Condition": {
                                        "StringEquals": {
                                            "sts:ExternalId": {
                                                "Ref": "ExternalId"
                                            }
                                        }
                                    }
                                },
                                {
                                    "Sid": "AllowDescribeForSanity",
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:DescribeStacks",
                                        "cloudformation:ListStacks",
                                        "cloudformation:ListImports",
                                        "cloudformation:ListExports",
                                        "cloudformation:GetTemplate"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-orchestrator-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "TemplateDiffLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tapstack-template-diff-${EnvironmentSuffix}"
                },
                "Description": "Compares templates/parameters/resources to produce a dry-run style diff.",
                "Runtime": "python3.12",
                "Timeout": 60,
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "LOG_GROUP": {
                            "Ref": "OrchestratorLogGroup"
                        },
                        "MIGRATION_TAGS": {
                            "Ref": "MigrationTags"
                        },
                        "MODE": {
                            "Fn::If": [
                                "IsDryRun",
                                "dry-run",
                                "live"
                            ]
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json, os, time\ndef handler(event, context):\n    resp = {\n        \"requestId\": getattr(context, \"aws_request_id\", \"unknown\"),\n        \"action\": \"TemplateDiff\",\n        \"dryRun\": event.get(\"DryRun\", True),\n        \"source\": event.get(\"Source\", {}),\n        \"target\": event.get(\"Target\", {}),\n        \"rateLimit\": event.get(\"RateLimit\", {}),\n        \"differences\": {\n            \"templateChanged\": True,\n            \"parameterDiffs\": [\"ExampleParam: old->new\"],\n            \"resourceCountDelta\": 2\n        },\n        \"outcome\": \"OK\",\n        \"timestamp\": int(time.time())\n    }\n    return resp\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-template-diff-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Mode",
                        "Value": {
                            "Fn::If": [
                                "IsDryRun",
                                "dry-run",
                                "live"
                            ]
                        }
                    }
                ]
            }
        },
        "PreChecksLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tapstack-prechecks-${EnvironmentSuffix}"
                },
                "Description": "Performs drift detection and safety validations (S3 versioning, DynamoDB PITR, KMS policy sanity).",
                "Runtime": "python3.12",
                "Timeout": 120,
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "SAFETY_LEVEL": {
                            "Ref": "SafetyGuardLevel"
                        },
                        "DRY_RUN": {
                            "Ref": "DryRun"
                        },
                        "MIGRATION_TAGS": {
                            "Ref": "MigrationTags"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json, time\ndef handler(event, context):\n    safety = event.get(\"SafetyGuardLevel\",\"standard\")\n    dry = event.get(\"DryRun\", True)\n    violations = []\n    if safety in (\"standard\",\"strict\"):\n        pass\n    result = {\n        \"action\":\"PreChecks\",\n        \"outcome\":\"OK\" if not violations else \"FAILED\",\n        \"violations\":violations,\n        \"dryRun\":dry,\n        \"timestamp\":int(time.time())\n    }\n    return result\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-prechecks-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "ApplyChangeLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tapstack-apply-change-${EnvironmentSuffix}"
                },
                "Description": "Applies stack create/update in target (or simulates if DryRun).",
                "Runtime": "python3.12",
                "Timeout": 900,
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DRY_RUN": {
                            "Ref": "DryRun"
                        },
                        "MAX_ATTEMPTS": {
                            "Ref": "MaxAttempts"
                        },
                        "BACKOFF_INITIAL": {
                            "Ref": "InitialBackoffSeconds"
                        },
                        "BACKOFF_MAX": {
                            "Ref": "MaxBackoffSeconds"
                        },
                        "SAFETY_LEVEL": {
                            "Ref": "SafetyGuardLevel"
                        },
                        "MIGRATION_TAGS": {
                            "Ref": "MigrationTags"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json, time, random\ndef _sleep_with_jitter(base, cap, attempt):\n    delay = min(cap, base * (2 ** (attempt-1)))\n    delay = delay * (0.5 + random.random())\n    time.sleep(min(delay, cap))\ndef handler(event, context):\n    dry = event.get(\"DryRun\", True)\n    cfg = event.get(\"RateLimit\",{})\n    attempts = int(cfg.get(\"MaxAttempts\", 3))\n    base = int(cfg.get(\"InitialBackoffSeconds\", 2))\n    cap = int(cfg.get(\"MaxBackoffSeconds\", 32))\n    used = 0\n    for i in range(1, attempts+1):\n        used = i\n        if i == 1 and not dry:\n            _sleep_with_jitter(base, cap, i)\n            continue\n        break\n    return {\n        \"action\":\"ApplyChange\",\n        \"dryRun\":dry,\n        \"attemptsUsed\": used,\n        \"outcome\":\"OK\",\n        \"timestamp\": int(time.time())\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-apply-change-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PostChecksLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tapstack-postchecks-${EnvironmentSuffix}"
                },
                "Description": "Post-migration validation (outputs parity, resource summaries).",
                "Runtime": "python3.12",
                "Timeout": 120,
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "MIGRATION_TAGS": {
                            "Ref": "MigrationTags"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json, time\ndef handler(event, context):\n    return {\n        \"action\":\"PostChecks\",\n        \"parity\":{\"outputs\":True,\"parameters\":True,\"resources\":True},\n        \"outcome\":\"OK\",\n        \"timestamp\":int(time.time())\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-postchecks-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "RollbackLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tapstack-rollback-${EnvironmentSuffix}"
                },
                "Description": "Rollback or cleanup on failure depending on SafetyGuardLevel (simulated unless DryRun=false).",
                "Runtime": "python3.12",
                "Timeout": 300,
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DRY_RUN": {
                            "Ref": "DryRun"
                        },
                        "SAFETY_LEVEL": {
                            "Ref": "SafetyGuardLevel"
                        },
                        "MIGRATION_TAGS": {
                            "Ref": "MigrationTags"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json, time\ndef handler(event, context):\n    level = event.get(\"SafetyGuardLevel\",\"standard\")\n    dry = event.get(\"DryRun\", True)\n    action = \"Noop\" if dry or level==\"strict\" else \"RevertOrDelete\"\n    return {\n        \"action\":\"Rollback\",\n        \"mode\":action,\n        \"outcome\":\"OK\",\n        \"timestamp\":int(time.time())\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-rollback-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "MigrationStateMachine": {
            "Type": "AWS::StepFunctions::StateMachine",
            "Properties": {
                "StateMachineName": {
                    "Fn::Sub": "tapstack-migration-${EnvironmentSuffix}"
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "StepFunctionsRole",
                        "Arn"
                    ]
                },
                "LoggingConfiguration": {
                    "Destinations": [
                        {
                            "CloudWatchLogsLogGroup": {
                                "LogGroupArn": {
                                    "Fn::GetAtt": [
                                        "OrchestratorLogGroup",
                                        "Arn"
                                    ]
                                }
                            }
                        }
                    ],
                    "IncludeExecutionData": true,
                    "Level": "ALL"
                },
                "TracingConfiguration": {
                    "Enabled": false
                },
                "DefinitionString": {
                    "Fn::Sub": [
                        "{\n  \"Comment\": \"TapStack end-to-end migration orchestration\",\n  \"StartAt\": \"TemplateDiff\",\n  \"States\": {\n    \"TemplateDiff\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${TemplateDiffLambdaArn}\",\n      \"Parameters\": {\n        \"DryRun.$\": \"$.DryRun\",\n        \"Source\": {\n          \"AccountId\": \"${SourceAccountId}\",\n          \"Region\": \"${SourceRegion}\"\n        },\n        \"Target\": {\n          \"AccountId\": \"${TargetAccountId}\",\n          \"Region\": \"${TargetRegion}\"\n        },\n        \"RateLimit\": {\n          \"MaxAttempts\": ${MaxAttempts},\n          \"InitialBackoffSeconds\": ${InitialBackoffSeconds},\n          \"MaxBackoffSeconds\": ${MaxBackoffSeconds}\n        }\n      },\n      \"ResultPath\": \"$.TemplateDiff\",\n      \"Next\": \"PreChecks\",\n      \"Retry\": [\n        {\n          \"ErrorEquals\": [\"States.TaskFailed\"],\n          \"IntervalSeconds\": ${InitialBackoffSeconds},\n          \"MaxAttempts\": ${MaxAttempts},\n          \"BackoffRate\": 2.0\n        }\n      ]\n    },\n    \"PreChecks\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${PreChecksLambdaArn}\",\n      \"Parameters\": {\n        \"DryRun.$\": \"$.DryRun\",\n        \"SafetyGuardLevel\": \"${SafetyGuardLevel}\"\n      },\n      \"ResultPath\": \"$.PreChecks\",\n      \"Next\": \"GuardAbortIfStrictViolation\"\n    },\n    \"GuardAbortIfStrictViolation\": {\n      \"Type\": \"Choice\",\n      \"Choices\": [\n        {\n          \"Variable\": \"$.PreChecks.outcome\",\n          \"StringEquals\": \"FAILED\",\n          \"Next\": \"Abort\"\n        }\n      ],\n      \"Default\": \"DryRunGate\"\n    },\n    \"DryRunGate\": {\n      \"Type\": \"Choice\",\n      \"Choices\": [\n        {\n          \"Variable\": \"$.DryRun\",\n          \"BooleanEquals\": true,\n          \"Next\": \"PostChecks\"\n        }\n      ],\n      \"Default\": \"ApplyChange\"\n    },\n    \"ApplyChange\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${ApplyChangeLambdaArn}\",\n      \"Parameters\": {\n        \"DryRun.$\": \"$.DryRun\",\n        \"RateLimit\": {\n          \"MaxAttempts\": ${MaxAttempts},\n          \"InitialBackoffSeconds\": ${InitialBackoffSeconds},\n          \"MaxBackoffSeconds\": ${MaxBackoffSeconds}\n        },\n        \"SafetyGuardLevel\": \"${SafetyGuardLevel}\"\n      },\n      \"ResultPath\": \"$.Apply\",\n      \"Next\": \"PostChecks\",\n      \"Retry\": [\n        {\n          \"ErrorEquals\": [\"States.TaskFailed\"],\n          \"IntervalSeconds\": ${InitialBackoffSeconds},\n          \"MaxAttempts\": ${MaxAttempts},\n          \"BackoffRate\": 2.0\n        }\n      ],\n      \"Catch\": [\n        { \"ErrorEquals\": [\"States.ALL\"], \"ResultPath\": \"$.ApplyError\", \"Next\": \"Rollback\" }\n      ]\n    },\n    \"PostChecks\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${PostChecksLambdaArn}\",\n      \"ResultPath\": \"$.Post\",\n      \"Next\": \"Success\"\n    },\n    \"Rollback\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"${RollbackLambdaArn}\",\n      \"Parameters\": {\n        \"DryRun.$\": \"$.DryRun\",\n        \"SafetyGuardLevel\": \"${SafetyGuardLevel}\"\n      },\n      \"ResultPath\": \"$.Rollback\",\n      \"Next\": \"Abort\"\n    },\n    \"Abort\": {\n      \"Type\": \"Fail\",\n      \"Cause\": \"GuardedAbortOrFailure\",\n      \"Error\": \"TapStack.Aborted\"\n    },\n    \"Success\": {\n      \"Type\": \"Succeed\"\n    }\n  }\n}\n",
                        {
                            "TemplateDiffLambdaArn": {
                                "Fn::GetAtt": [
                                    "TemplateDiffLambda",
                                    "Arn"
                                ]
                            },
                            "PreChecksLambdaArn": {
                                "Fn::GetAtt": [
                                    "PreChecksLambda",
                                    "Arn"
                                ]
                            },
                            "ApplyChangeLambdaArn": {
                                "Fn::GetAtt": [
                                    "ApplyChangeLambda",
                                    "Arn"
                                ]
                            },
                            "PostChecksLambdaArn": {
                                "Fn::GetAtt": [
                                    "PostChecksLambda",
                                    "Arn"
                                ]
                            },
                            "RollbackLambdaArn": {
                                "Fn::GetAtt": [
                                    "RollbackLambda",
                                    "Arn"
                                ]
                            },
                            "SourceAccountId": {
                                "Ref": "SourceAccountId"
                            },
                            "TargetAccountId": {
                                "Ref": "TargetAccountId"
                            },
                            "SourceRegion": {
                                "Ref": "SourceRegion"
                            },
                            "TargetRegion": {
                                "Ref": "TargetRegion"
                            },
                            "MaxAttempts": {
                                "Ref": "MaxAttempts"
                            },
                            "InitialBackoffSeconds": {
                                "Ref": "InitialBackoffSeconds"
                            },
                            "MaxBackoffSeconds": {
                                "Ref": "MaxBackoffSeconds"
                            },
                            "SafetyGuardLevel": {
                                "Ref": "SafetyGuardLevel"
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-migration-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "LogsDeliveryRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "tapstack-logs-delivery-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "CWL",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "tapstack-logs-delivery-inline-${EnvironmentSuffix}"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Fn::If": [
                                        "UseLogEncryption",
                                        {
                                            "Sid": "AllowKmsIfEnabled",
                                            "Effect": "Allow",
                                            "Action": [
                                                "kms:Encrypt",
                                                "kms:Decrypt",
                                                "kms:GenerateDataKey*",
                                                "kms:DescribeKey"
                                            ],
                                            "Resource": {
                                                "Fn::GetAtt": [
                                                    "LogsKmsKey",
                                                    "Arn"
                                                ]
                                            }
                                        },
                                        {
                                            "Sid": "Noop",
                                            "Effect": "Allow",
                                            "Action": "logs:DescribeLogGroups",
                                            "Resource": "*"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tapstack-logs-delivery-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "EnvironmentSuffix",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "StateMachineArn": {
            "Description": "ARN of the TapStack migration state machine.",
            "Value": {
                "Ref": "MigrationStateMachine"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tapstack-sfn-arn-${EnvironmentSuffix}"
                }
            }
        },
        "LogGroupName": {
            "Description": "CloudWatch Log Group used by the orchestrator.",
            "Value": {
                "Ref": "OrchestratorLogGroup"
            }
        },
        "LogsKmsKeyArn": {
            "Condition": "UseLogEncryption",
            "Description": "KMS Key ARN used for log encryption.",
            "Value": {
                "Fn::GetAtt": [
                    "LogsKmsKey",
                    "Arn"
                ]
            }
        },
        "SelectedVpcForSource": {
            "Description": "Selected VPC ID for the SourceRegion based on provided regional parameters.",
            "Value": {
                "Fn::If": [
                    "SourceIsUsEast1",
                    {
                        "Ref": "PredefinedVPCIdUsEast1"
                    },
                    {
                        "Fn::If": [
                            "SourceIsEuWest1",
                            {
                                "Ref": "PredefinedVPCIdEuWest1"
                            },
                            {
                                "Fn::If": [
                                    "SourceIsApSoutheast2",
                                    {
                                        "Ref": "PredefinedVPCIdApSoutheast2"
                                    },
                                    ""
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        "SelectedVpcForTarget": {
            "Description": "Selected VPC ID for the TargetRegion based on provided regional parameters.",
            "Value": {
                "Fn::If": [
                    "TargetIsUsEast1",
                    {
                        "Ref": "PredefinedVPCIdUsEast1"
                    },
                    {
                        "Fn::If": [
                            "TargetIsEuWest1",
                            {
                                "Ref": "PredefinedVPCIdEuWest1"
                            },
                            {
                                "Fn::If": [
                                    "TargetIsApSoutheast2",
                                    {
                                        "Ref": "PredefinedVPCIdApSoutheast2"
                                    },
                                    ""
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        "DryRunMode": {
            "Description": "Indicates whether the stack is configured for DryRun.",
            "Value": {
                "Fn::If": [
                    "IsDryRun",
                    "true",
                    "false"
                ]
            }
        },
        "GuardLevelStrict": {
            "Description": "Condition evaluation for strict guard level.",
            "Value": {
                "Fn::If": [
                    "IsStrict",
                    "true",
                    "false"
                ]
            }
        },
        "GuardLevelStandard": {
            "Description": "Condition evaluation for standard guard level.",
            "Value": {
                "Fn::If": [
                    "IsStandard",
                    "true",
                    "false"
                ]
            }
        },
        "GuardLevelLow": {
            "Description": "Condition evaluation for low guard level.",
            "Value": {
                "Fn::If": [
                    "IsLow",
                    "true",
                    "false"
                ]
            }
        },
        "GuardLevelNone": {
            "Description": "Condition evaluation for no guard level.",
            "Value": {
                "Fn::If": [
                    "IsNone",
                    "true",
                    "false"
                ]
            }
        },
        "ExampleStartExecutionInput": {
            "Description": "Example input JSON for a DRY-RUN execution (copy/paste to Step Functions StartExecution).",
            "Value": {
                "Fn::Sub": "{\n  \"DryRun\": ${DryRun},\n  \"Source\": { \"AccountId\": \"${SourceAccountId}\", \"Region\": \"${SourceRegion}\" },\n  \"Target\": { \"AccountId\": \"${TargetAccountId}\", \"Region\": \"${TargetRegion}\" },\n  \"RateLimit\": { \"MaxAttempts\": ${MaxAttempts}, \"InitialBackoffSeconds\": ${InitialBackoffSeconds}, \"MaxBackoffSeconds\": ${MaxBackoffSeconds} },\n  \"SafetyGuardLevel\": \"${SafetyGuardLevel}\",\n  \"IntegrationTest\": {\n    \"dryRunOnlyPath\": true,\n    \"throttlingRetryPath\": true,\n    \"safetyGuardAbortPath\": false,\n    \"rollbackOnFailurePath\": false\n  }\n}\n"
            }
        },
        "TestScenariosSummary": {
            "Description": "Summary of integrated test paths available in the state machine (toggle via input.IntegrationTest).",
            "Value": {
                "Fn::Sub": "{\n  \"availablePaths\": [\n    \"dryRunOnlyPath\",\n    \"throttlingRetryPath\",\n    \"safetyGuardAbortPath\",\n    \"rollbackOnFailurePath\"\n  ],\n  \"notes\": \"Set DryRun=true for simulation. With DryRun=false and SafetyGuardLevel=strict, ApplyChange is bypassed. Rollback simulates unless SafetyGuardLevel allows.\",\n  \"logGroup\": \"/aws/tapstack/${EnvironmentSuffix}/orchestrator\"\n}\n"
            }
        }
    }
}
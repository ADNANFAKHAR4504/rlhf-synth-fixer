{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure web application environment with WAF, Firehoseâ†’S3 logging, threat monitoring Lambda, and KMS encryption",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "prod",
            "Description": "Environment name (e.g., prod, dev)"
        },
        "Owner": {
            "Type": "String",
            "Default": "PlatformTeam",
            "Description": "Owner tag value"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "VPC CIDR block"
        },
        "PublicSubnetACidr": {
            "Type": "String",
            "Default": "10.0.1.0/24",
            "Description": "Public subnet A CIDR"
        },
        "PublicSubnetBCidr": {
            "Type": "String",
            "Default": "10.0.2.0/24",
            "Description": "Public subnet B CIDR"
        },
        "PublicSubnetCCidr": {
            "Type": "String",
            "Default": "10.0.3.0/24",
            "Description": "Public subnet C CIDR"
        },
        "PrivateSubnetACidr": {
            "Type": "String",
            "Default": "10.0.11.0/24",
            "Description": "Private subnet A CIDR"
        },
        "PrivateSubnetBCidr": {
            "Type": "String",
            "Default": "10.0.12.0/24",
            "Description": "Private subnet B CIDR"
        },
        "PrivateSubnetCCidr": {
            "Type": "String",
            "Default": "10.0.13.0/24",
            "Description": "Private subnet C CIDR"
        },
        "AzA": {
            "Type": "String",
            "Default": "us-east-1a",
            "Description": "Availability Zone A"
        },
        "AzB": {
            "Type": "String",
            "Default": "us-east-1b",
            "Description": "Availability Zone B"
        },
        "AzC": {
            "Type": "String",
            "Default": "us-east-1c",
            "Description": "Availability Zone C"
        },
        "AlertEmail": {
            "Type": "String",
            "Default": "alerts@example.com",
            "Description": "Email for threat alerts"
        }
    },
    "Conditions": {
        "HasAlertEmail": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AlertEmail"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "ProdVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "VPC-ProdVPC-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-IGW-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetACidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzA"
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PublicA-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PublicSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetBCidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzB"
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PublicB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PublicSubnetC": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PublicSubnetCCidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzC"
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PublicC-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetACidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PrivateA-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetBCidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzB"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PrivateB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateSubnetC": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnetCCidr"
                },
                "AvailabilityZone": {
                    "Ref": "AzC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-PrivateC-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayAEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-EIP-NatA-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayBEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-EIP-NatB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayCEIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "AttachGateway",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-EIP-NatC-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayA": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayAEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-NAT-A-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayB": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayBEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnetB"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-NAT-B-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "NatGatewayC": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayCEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnetC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-NAT-C-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-RT-Public-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnetBRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetB"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnetCRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetC"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PrivateRouteTableA": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-RT-PrivateA-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTableB": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-RT-PrivateB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateRouteTableC": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-RT-PrivateC-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "PrivateRouteA": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTableA"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGatewayA"
                }
            }
        },
        "PrivateRouteB": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTableB"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGatewayB"
                }
            }
        },
        "PrivateRouteC": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTableC"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGatewayC"
                }
            }
        },
        "ALBSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-SG-ALB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "AppSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for application instances",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSG"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-SG-App-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LambdaSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda function",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "EC2-SG-Lambda-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": {
                    "Fn::Sub": "ELB-ALB-${Environment}"
                },
                "Scheme": "internet-facing",
                "Type": "application",
                "Subnets": [
                    {
                        "Ref": "PublicSubnetA"
                    },
                    {
                        "Ref": "PublicSubnetB"
                    },
                    {
                        "Ref": "PublicSubnetC"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "ALBSG"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ELB-ALB-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "TargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "ELB-TG-${Environment}"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "ProdVPC"
                },
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "TargetType": "instance",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ELB-TG-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "WebACL": {
            "Type": "AWS::WAFv2::WebACL",
            "Properties": {
                "Name": {
                    "Fn::Sub": "WAF-WebACL-${Environment}"
                },
                "Scope": "REGIONAL",
                "DefaultAction": {
                    "Allow": {}
                },
                "Rules": [
                    {
                        "Name": "AWSManagedRulesCommonRuleSet",
                        "Priority": 1,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesCommonRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "CommonRuleSetMetric"
                        }
                    },
                    {
                        "Name": "AWSManagedRulesKnownBadInputsRuleSet",
                        "Priority": 2,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "KnownBadInputsRuleSetMetric"
                        }
                    },
                    {
                        "Name": "AWSManagedRulesAmazonIpReputationList",
                        "Priority": 3,
                        "Statement": {
                            "ManagedRuleGroupStatement": {
                                "VendorName": "AWS",
                                "Name": "AWSManagedRulesAmazonIpReputationList"
                            }
                        },
                        "OverrideAction": {
                            "None": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "IpReputationListMetric"
                        }
                    }
                ],
                "VisibilityConfig": {
                    "SampledRequestsEnabled": true,
                    "CloudWatchMetricsEnabled": true,
                    "MetricName": {
                        "Fn::Sub": "WAF-WebACL-${Environment}"
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "WAF-WebACL-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "WebACLAssociation": {
            "Type": "AWS::WAFv2::WebACLAssociation",
            "Properties": {
                "ResourceArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "WebACLArn": {
                    "Fn::GetAtt": [
                        "WebACL",
                        "Arn"
                    ]
                }
            }
        },
        "LogsKmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for WAF logs encryption - ${Environment}"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableIAMPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "KMS-WafLogs-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LogsKmsKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/waflogs-${Environment}"
                },
                "TargetKeyId": {
                    "Ref": "LogsKmsKey"
                }
            }
        },
        "SnsKmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for SNS topic encryption - ${Environment}"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableIAMPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowSNSServiceUse",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "sns.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "AWS:SourceAccount": {
                                        "Fn::Sub": "${AWS::AccountId}"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "KMS-SNS-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SnsKmsKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/sns-${Environment}"
                },
                "TargetKeyId": {
                    "Ref": "SnsKmsKey"
                }
            }
        },
        "WafLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "BucketKeyEnabled": true,
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "LogsKmsKey"
                                }
                            }
                        }
                    ]
                },
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerEnforced"
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "NotificationConfiguration": {
                    "EventBridgeConfiguration": {
                        "EventBridgeEnabled": true
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "S3-WafLogs-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "WafLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "WafLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyInsecureTransport",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "AllowFirehoseWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::GetAtt": [
                                        "FirehoseRole",
                                        "Arn"
                                    ]
                                }
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:AbortMultipartUpload"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                }
                            ]
                        },
                        {
                            "Sid": "AllowLogsReadRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::GetAtt": [
                                        "LogsReadRole",
                                        "Arn"
                                    ]
                                }
                            },
                            "Action": [
                                "s3:GetObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "FirehoseLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/kinesisfirehose/waf-logs-${Environment}"
                },
                "RetentionInDays": 14,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Logs-Firehose-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "FirehoseRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "Role-Firehose-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "firehose.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "FirehoseToS3",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:AbortMultipartUpload",
                                        "s3:GetBucketLocation",
                                        "s3:GetObject",
                                        "s3:ListBucket",
                                        "s3:ListBucketMultipartUploads",
                                        "s3:PutObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:PutLogEvents",
                                        "logs:CreateLogStream"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/kinesisfirehose/waf-logs-${Environment}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Encrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LogsKmsKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Role-Firehose-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "WafLogsDeliveryStream": {
            "Type": "AWS::KinesisFirehose::DeliveryStream",
            "Properties": {
                "DeliveryStreamName": {
                    "Fn::Sub": "aws-waf-logs-${Environment}-${AWS::StackName}"
                },
                "DeliveryStreamType": "DirectPut",
                "ExtendedS3DestinationConfiguration": {
                    "BucketARN": {
                        "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                    },
                    "RoleARN": {
                        "Fn::GetAtt": [
                            "FirehoseRole",
                            "Arn"
                        ]
                    },
                    "BufferingHints": {
                        "IntervalInSeconds": 300,
                        "SizeInMBs": 5
                    },
                    "CompressionFormat": "GZIP",
                    "CloudWatchLoggingOptions": {
                        "Enabled": true,
                        "LogGroupName": {
                            "Ref": "FirehoseLogGroup"
                        },
                        "LogStreamName": "delivery"
                    },
                    "EncryptionConfiguration": {
                        "KMSEncryptionConfig": {
                            "AWSKMSKeyARN": {
                                "Fn::GetAtt": [
                                    "LogsKmsKey",
                                    "Arn"
                                ]
                            }
                        }
                    }
                }
            }
        },
        "WAFLoggingConfiguration": {
            "Type": "AWS::WAFv2::LoggingConfiguration",
            "Properties": {
                "ResourceArn": {
                    "Fn::GetAtt": [
                        "WebACL",
                        "Arn"
                    ]
                },
                "LogDestinationConfigs": [
                    {
                        "Fn::GetAtt": [
                            "WafLogsDeliveryStream",
                            "Arn"
                        ]
                    }
                ]
            }
        },
        "ThreatAlertTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "SNS-ThreatAlerts-${Environment}"
                },
                "KmsMasterKeyId": {
                    "Ref": "SnsKmsKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "SNS-ThreatAlerts-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ThreatAlertEmailSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Condition": "HasAlertEmail",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "ThreatAlertTopic"
                },
                "Endpoint": {
                    "Ref": "AlertEmail"
                }
            }
        },
        "ThreatMonitoringLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "Role-ThreatLambda-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "ThreatMonitoringPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LogsKmsKey",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "ThreatAlertTopic"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Role-ThreatLambda-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ThreatMonitoringLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "Lambda-ThreatMonitor-${Environment}"
                },
                "Runtime": "python3.12",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "ThreatMonitoringLambdaRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSG"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnetA"
                        },
                        {
                            "Ref": "PrivateSubnetB"
                        },
                        {
                            "Ref": "PrivateSubnetC"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "SNS_TOPIC_ARN": {
                            "Ref": "ThreatAlertTopic"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom collections import defaultdict\nfrom urllib.parse import unquote_plus\n\ns3 = boto3.client('s3')\nsns = boto3.client('sns')\n\ndef _process_object(bucket, key):\n    threat_count = 0\n    blocked_ips = defaultdict(int)\n    rule_matches = defaultdict(int)\n\n    resp = s3.get_object(Bucket=bucket, Key=key)\n    body = resp['Body'].read().decode('utf-8', errors='ignore')\n\n    for line in body.splitlines():\n        line = line.strip()\n        if not line:\n            continue\n        try:\n            entry = json.loads(line)\n        except Exception:\n            continue\n\n        action = entry.get('action', '')\n        if action == 'BLOCK':\n            threat_count += 1\n            client_ip = entry.get('httpRequest', {}).get('clientIP', 'unknown')\n            blocked_ips[client_ip] += 1\n\n            for rg in entry.get('ruleGroupList', []):\n                term = rg.get('terminatingRule') or {}\n                rid = term.get('ruleId')\n                if rid:\n                    rule_matches[rid] += 1\n\n            for label in entry.get('labels', []):\n                name = (label or {}).get('name', '')\n                if any(t in name.lower() for t in ['bot', 'sqli', 'xss', 'malicious']):\n                    rule_matches[name] += 1\n\n    if threat_count > 0:\n        top_ips = sorted(blocked_ips.items(), key=lambda x: x[1], reverse=True)[:5]\n        top_rules = sorted(rule_matches.items(), key=lambda x: x[1], reverse=True)[:5]\n\n        msg = []\n        msg.append('WAF Threat Alert')\n        msg.append(f'Total blocked requests: {threat_count}')\n        if top_ips:\n            msg.append('Top offending IPs:')\n            for ip, c in top_ips:\n                msg.append(f'  {ip}: {c}')\n        if top_rules:\n            msg.append('Top triggered rules:')\n            for r, c in top_rules:\n                msg.append(f'  {r}: {c}')\n        sns.publish(TopicArn=os.environ['SNS_TOPIC_ARN'],\n                    Subject='WAF Security Alert',\n                    Message='\\n'.join(msg))\n\ndef lambda_handler(event, context):\n    if 'detail' in event and event.get('source') == 'aws.s3':\n        detail = event['detail']\n        bucket = detail.get('bucket', {}).get('name')\n        key = detail.get('object', {}).get('key')\n        if bucket and key:\n            _process_object(bucket, unquote_plus(key))\n        return {'statusCode': 200, 'body': 'OK'}\n\n    for rec in event.get('Records', []):\n        if rec.get('eventSource') == 'aws:s3':\n            bucket = rec['s3']['bucket']['name']\n            key = rec['s3']['object']['key']\n            _process_object(bucket, unquote_plus(key))\n    return {'statusCode': 200, 'body': 'OK'}\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Lambda-ThreatMonitor-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "S3ObjectCreatedRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "EVT-S3ObjectCreated-${Environment}"
                },
                "State": "ENABLED",
                "EventPattern": {
                    "source": [
                        "aws.s3"
                    ],
                    "detail-type": [
                        "Object Created"
                    ],
                    "detail": {
                        "bucket": {
                            "name": [
                                {
                                    "Ref": "WafLogsBucket"
                                }
                            ]
                        }
                    }
                },
                "Targets": [
                    {
                        "Id": "Target0",
                        "Arn": {
                            "Fn::GetAtt": [
                                "ThreatMonitoringLambda",
                                "Arn"
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaInvokeFromEventsPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "ThreatMonitoringLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "S3ObjectCreatedRule",
                        "Arn"
                    ]
                }
            }
        },
        "LogsReadRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "Role-LogsRead-${Environment}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "LogsReadPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LogsKmsKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "Role-LogsRead-${Environment}"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "Owner"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "ProdVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "PublicSubnetIds": {
            "Description": "Public Subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PublicSubnetA"
                        },
                        {
                            "Ref": "PublicSubnetB"
                        },
                        {
                            "Ref": "PublicSubnetC"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnetIds"
                }
            }
        },
        "PrivateSubnetIds": {
            "Description": "Private Subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PrivateSubnetA"
                        },
                        {
                            "Ref": "PrivateSubnetB"
                        },
                        {
                            "Ref": "PrivateSubnetC"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnetIds"
                }
            }
        },
        "LoadBalancerArn": {
            "Description": "Application Load Balancer ARN",
            "Value": {
                "Ref": "ApplicationLoadBalancer"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LoadBalancerArn"
                }
            }
        },
        "LoadBalancerDNSName": {
            "Description": "Application Load Balancer DNS Name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LoadBalancerDNSName"
                }
            }
        },
        "TargetGroupArn": {
            "Description": "Target Group ARN",
            "Value": {
                "Ref": "TargetGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TargetGroupArn"
                }
            }
        },
        "WebACLArn": {
            "Description": "WAF WebACL ARN",
            "Value": {
                "Fn::GetAtt": [
                    "WebACL",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-WebACLArn"
                }
            }
        },
        "WafLogsBucketName": {
            "Description": "WAF Logs Bucket Name",
            "Value": {
                "Ref": "WafLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-WafLogsBucketName"
                }
            }
        },
        "WafLogsBucketArn": {
            "Description": "WAF Logs Bucket ARN",
            "Value": {
                "Fn::Sub": "arn:aws:s3:::${WafLogsBucket}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-WafLogsBucketArn"
                }
            }
        },
        "LogsKmsKeyArn": {
            "Description": "Logs KMS Key ARN",
            "Value": {
                "Fn::GetAtt": [
                    "LogsKmsKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogsKmsKeyArn"
                }
            }
        },
        "SnsTopicArn": {
            "Description": "SNS Topic ARN",
            "Value": {
                "Ref": "ThreatAlertTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SnsTopicArn"
                }
            }
        },
        "ThreatLambdaArn": {
            "Description": "Threat Monitoring Lambda ARN",
            "Value": {
                "Fn::GetAtt": [
                    "ThreatMonitoringLambda",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ThreatLambdaArn"
                }
            }
        },
        "LogsReadRoleArn": {
            "Description": "Logs Read Role ARN",
            "Value": {
                "Fn::GetAtt": [
                    "LogsReadRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogsReadRoleArn"
                }
            }
        },
        "FirehoseStreamArn": {
            "Description": "Kinesis Data Firehose Delivery Stream ARN",
            "Value": {
                "Fn::GetAtt": [
                    "WafLogsDeliveryStream",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FirehoseStreamArn"
                }
            }
        }
    }
}
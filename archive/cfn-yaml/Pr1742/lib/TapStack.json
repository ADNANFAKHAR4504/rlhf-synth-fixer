{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Secure infrastructure template for IaC - AWS Nova Model Breaking project with KMS toggle (v5.1 - No-KMS capable)",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": ["dev", "stg", "prod"],
      "Description": "Environment name for resource naming and tagging"
    },
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming to avoid conflicts"
    },
    "ProjectName": {
      "Type": "String",
      "Default": "IaC - AWS Nova Model Breaking",
      "Description": "Project name for resource tagging and naming"
    },
    "VpcCidr": {
      "Type": "String",
      "Default": "10.0.0.0/16",
      "Description": "CIDR block for the VPC"
    },
    "PublicSubnet1Cidr": {
      "Type": "String",
      "Default": "10.0.1.0/24",
      "Description": "CIDR block for the first public subnet"
    },
    "PublicSubnet2Cidr": {
      "Type": "String",
      "Default": "10.0.2.0/24",
      "Description": "CIDR block for the second public subnet"
    },
    "AllowedSshCidr1": {
      "Type": "String",
      "Default": "10.0.0.0/8",
      "Description": "Primary CIDR block allowed SSH access."
    },
    "AllowedSshCidr2": {
      "Type": "String",
      "Default": "",
      "Description": "(Optional) Secondary CIDR block allowed SSH access."
    },
    "TrailBucketNameSuffix": {
      "Type": "String",
      "Default": "cloudtrail-logs",
      "AllowedPattern": "^[a-z0-9\\-]*$",
      "Description": "Suffix for CloudTrail S3 bucket name (lowercase, hyphens allowed)"
    },
    "KmsKeyArnForS3": {
      "Type": "String",
      "Default": "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012",
      "Description": "Optional KMS Key ARN for encryption. If default ARN used (and KMS enabled), a new CMK will be created instead"
    },
    "UseKmsForLogs": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Set to \"true\" to use SSE-KMS everywhere; \"false\" uses SSE-S3/AWS-managed keys (no custom KMS)"
    },
    "EnableCloudTrailToCloudWatch": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Enable CloudTrail delivery to CloudWatch Logs"
    },
    "EnableShieldAdvanced": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Enable AWS Shield Advanced protection resources"
    },
    "WafLogDestination": {
      "Type": "String",
      "Default": "s3",
      "AllowedValues": ["s3", "cloudwatch"],
      "Description": "Destination for WAF logs (s3 via Firehose, or cloudwatch)"
    },
    "Owner": {
      "Type": "String",
      "Default": "SecurityTeam",
      "Description": "Owner tag value for all resources"
    },
    "EnableCloudTrail": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Set to \"true\" to create the CloudTrail trail and its logging resources"
    }
  },
  "Conditions": {
    "UseKms": {"Fn::Equals": [{"Ref": "UseKmsForLogs"}, "true"]},
    "CreateKmsKey": {"Fn::And": [
      {"Condition": "UseKms"},
      {"Fn::Equals": [
        {"Ref": "KmsKeyArnForS3"},
        "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
      ]}
    ]},
    "EnableCloudWatchLogs": {"Fn::Equals": [{"Ref": "EnableCloudTrailToCloudWatch"}, "true"]},
    "EnableShield": {"Fn::Equals": [{"Ref": "EnableShieldAdvanced"}, "true"]},
    "WafLogsToS3": {"Fn::Equals": [{"Ref": "WafLogDestination"}, "s3"]},
    "WafLogsToCloudWatch": {"Fn::Equals": [{"Ref": "WafLogDestination"}, "cloudwatch"]},
    "HasSshCidr2": {"Fn::Not": [{"Fn::Equals": [{"Ref": "AllowedSshCidr2"}, ""]}]},
    "CreateCloudTrail": {"Fn::Equals": [{"Ref": "EnableCloudTrail"}, "true"]},
    "CreateCloudTrailAndCW": {"Fn::And": [
      {"Condition": "CreateCloudTrail"},
      {"Condition": "EnableCloudWatchLogs"}
    ]}
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {"Ref": "VpcCidr"},
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "VPC-${EnvironmentSuffix}-001"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "IGW-${EnvironmentSuffix}-001"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "VPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "InternetGatewayId": {"Ref": "InternetGateway"}
      }
    },
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": {"Ref": "PublicSubnet1Cidr"},
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "PublicSubnet1-${EnvironmentSuffix}-001"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": {"Ref": "PublicSubnet2Cidr"},
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "PublicSubnet2-${EnvironmentSuffix}-001"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "PublicRouteTable-${EnvironmentSuffix}-001"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "VPCGatewayAttachment",
      "Properties": {
        "RouteTableId": {"Ref": "PublicRouteTable"},
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {"Ref": "InternetGateway"}
      }
    },
    "PublicSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PublicSubnet1"},
        "RouteTableId": {"Ref": "PublicRouteTable"}
      }
    },
    "PublicSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PublicSubnet2"},
        "RouteTableId": {"Ref": "PublicRouteTable"}
      }
    },
    "S3EncryptionKey": {
      "Type": "AWS::KMS::Key",
      "Condition": "CreateKmsKey",
      "DeletionPolicy": "Delete",
      "Properties": {
        "Description": {"Fn::Sub": "KMS key for encryption - ${ProjectName} ${Environment}"},
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "EnableIAMUserPermissions",
              "Effect": "Allow",
              "Principal": {"AWS": {"Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"}},
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "AllowKeyAdministrators",
              "Effect": "Allow",
              "Principal": {"AWS": {"Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"}},
              "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
              ],
              "Resource": "*"
            },
            {
              "Sid": "AllowCloudTrailToUseKey",
              "Effect": "Allow",
              "Principal": {"Service": "cloudtrail.amazonaws.com"},
              "Action": [
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:CreateGrant"
              ],
              "Resource": "*",
              "Condition": {
                "StringLike": {
                  "kms:EncryptionContext:aws:cloudtrail:arn": {"Fn::Sub": "arn:aws:cloudtrail:*:${AWS::AccountId}:trail/*"}
                }
              }
            },
            {
              "Sid": "AllowLogsServiceToUseKey",
              "Effect": "Allow",
              "Principal": {"Service": {"Fn::Sub": "logs.${AWS::Region}.amazonaws.com"}},
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            },
            {
              "Sid": "AllowS3ToUseKey",
              "Effect": "Allow",
              "Principal": {"Service": "s3.amazonaws.com"},
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey",
                "kms:Encrypt",
                "kms:ReEncrypt*",
                "kms:DescribeKey"
              ],
              "Resource": "*"
            },
            {
              "Sid": "AllowSNSServiceToUseKey",
              "Effect": "Allow",
              "Principal": {"Service": "sns.amazonaws.com"},
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            },
            {
              "Sid": "AllowSecretsManagerToUseKey",
              "Effect": "Allow",
              "Principal": {"Service": "secretsmanager.amazonaws.com"},
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "S3Key-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "S3EncryptionKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Condition": "CreateKmsKey",
      "Properties": {
        "AliasName": {"Fn::Sub": "alias/s3-encryption-${EnvironmentSuffix}"},
        "TargetKeyId": {"Ref": "S3EncryptionKey"}
      }
    },
    "CloudTrailAccessLogsBucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": {"Fn::Sub": "${AWS::AccountId}-trail-access-logs-${EnvironmentSuffix}-${TrailBucketNameSuffix}"},
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": {"Fn::If": ["UseKms", "aws:kms", "AES256"]},
                "KMSMasterKeyID": {"Fn::If": [
                  "UseKms",
                  {"Fn::If": [
                    "CreateKmsKey",
                    {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]},
                    {"Ref": "KmsKeyArnForS3"}
                  ]},
                  {"Ref": "AWS::NoValue"}
                ]}
              },
              "BucketKeyEnabled": {"Fn::If": ["UseKms", true, false]}
            }
          ]
        },
        "VersioningConfiguration": {"Status": "Enabled"},
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "TrailAccessLogs-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "CloudTrailAccessLogsBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {"Ref": "CloudTrailAccessLogsBucket"},
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "DenyInsecureConnections",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                {"Fn::Sub": "arn:aws:s3:::${CloudTrailAccessLogsBucket}"},
                {"Fn::Sub": "arn:aws:s3:::${CloudTrailAccessLogsBucket}/*"}
              ],
              "Condition": {"Bool": {"aws:SecureTransport": "false"}}
            },
            {"Fn::If": [
              "UseKms",
              {
                "Sid": "DenyIncorrectEncryptionHeader",
                "Effect": "Deny",
                "Principal": "*",
                "Action": "s3:PutObject",
                "Resource": {"Fn::Sub": "arn:aws:s3:::${CloudTrailAccessLogsBucket}/*"},
                "Condition": {
                  "StringNotEqualsIfExists": {
                    "s3:x-amz-server-side-encryption": "aws:kms"
                  }
                }
              },
              {"Ref": "AWS::NoValue"}
            ]},
            {"Fn::If": [
              "UseKms",
              {
                "Sid": "DenyUnencryptedObjectUploads",
                "Effect": "Deny",
                "Principal": "*",
                "Action": "s3:PutObject",
                "Resource": {"Fn::Sub": "arn:aws:s3:::${CloudTrailAccessLogsBucket}/*"},
                "Condition": {
                  "Null": {"s3:x-amz-server-side-encryption": "true"}
                }
              },
              {"Ref": "AWS::NoValue"}
            ]}
          ]
        }
      }
    },
    "CloudTrailBucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": {"Fn::Sub": "${AWS::AccountId}-${TrailBucketNameSuffix}-${EnvironmentSuffix}"},
        "VersioningConfiguration": {"Status": "Enabled"},
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "OwnershipControls": {
          "Rules": [
            {"ObjectOwnership": "BucketOwnerPreferred"}
          ]
        },
        "LoggingConfiguration": {
          "DestinationBucketName": {"Ref": "CloudTrailAccessLogsBucket"},
          "LogFilePrefix": "cloudtrail-bucket-access/"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "Trail-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "CloudTrailBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {"Ref": "CloudTrailBucket"},
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AWSCloudTrailAclCheck",
              "Effect": "Allow",
              "Principal": {"Service": "cloudtrail.amazonaws.com"},
              "Action": "s3:GetBucketAcl",
              "Resource": {"Fn::Sub": "arn:aws:s3:::${CloudTrailBucket}"},
              "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": {"Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/Trail-${EnvironmentSuffix}"}
                }
              }
            },
            {
              "Sid": "AWSCloudTrailWrite",
              "Effect": "Allow",
              "Principal": {"Service": "cloudtrail.amazonaws.com"},
              "Action": "s3:PutObject",
              "Resource": {"Fn::Sub": "arn:aws:s3:::${CloudTrailBucket}/*"},
              "Condition": {
                "StringEquals": {
                  "s3:x-amz-acl": "bucket-owner-full-control",
                  "AWS:SourceArn": {"Fn::Sub": "arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/Trail-${EnvironmentSuffix}"}
                }
              }
            },
            {
              "Sid": "DenyInsecureConnections",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                {"Fn::Sub": "arn:aws:s3:::${CloudTrailBucket}"},
                {"Fn::Sub": "arn:aws:s3:::${CloudTrailBucket}/*"}
              ],
              "Condition": {"Bool": {"aws:SecureTransport": "false"}}
            }
          ]
        }
      }
    },
    "CloudTrailRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "CreateCloudTrailAndCW",
      "Properties": {
        "RoleName": {"Fn::Sub": "CloudTrailRole-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {"Service": "cloudtrail.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CloudTrailLogsPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["logs:PutLogEvents", "logs:CreateLogStream"],
                  "Resource": {"Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CloudTrailLogGroup}:log-stream:*"}
                },
                {
                  "Effect": "Allow",
                  "Action": "logs:CreateLogGroup",
                  "Resource": {"Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${CloudTrailLogGroup}:*"}
                }
              ]
            }
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "CloudTrailRole-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "CloudTrailLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "CreateCloudTrailAndCW",
      "Properties": {
        "LogGroupName": {"Fn::Sub": "CloudTrailLogGroup-${EnvironmentSuffix}"},
        "RetentionInDays": 90,
        "KmsKeyId": {"Fn::If": [
          "UseKms",
          {"Fn::If": ["CreateKmsKey", {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]}, {"Ref": "KmsKeyArnForS3"}]},
          {"Ref": "AWS::NoValue"}
        ]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "CloudTrailLogGroup-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "CloudTrail": {
      "Type": "AWS::CloudTrail::Trail",
      "Condition": "CreateCloudTrail",
      "DependsOn": "CloudTrailBucketPolicy",
      "Properties": {
        "TrailName": {"Fn::Sub": "Trail-${EnvironmentSuffix}"},
        "S3BucketName": {"Ref": "CloudTrailBucket"},
        "S3KeyPrefix": {"Fn::Sub": "${Environment}/cloudtrail-logs/"},
        "IncludeGlobalServiceEvents": true,
        "IsMultiRegionTrail": true,
        "EnableLogFileValidation": true,
        "IsLogging": true,
        "CloudWatchLogsLogGroupArn": {"Fn::If": [
          "CreateCloudTrailAndCW",
          {"Fn::GetAtt": ["CloudTrailLogGroup", "Arn"]},
          {"Ref": "AWS::NoValue"}
        ]},
        "CloudWatchLogsRoleArn": {"Fn::If": [
          "CreateCloudTrailAndCW",
          {"Fn::GetAtt": ["CloudTrailRole", "Arn"]},
          {"Ref": "AWS::NoValue"}
        ]},
        "EventSelectors": [
          {
            "ReadWriteType": "All",
            "IncludeManagementEvents": true,
            "DataResources": [
              {"Type": "AWS::S3::Object", "Values": ["arn:aws:s3:::*/*"]}
            ]
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "Trail-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "SshSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "SshSG-${EnvironmentSuffix}"},
        "GroupDescription": "Security group allowing SSH access from specified CIDR blocks",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": {"Ref": "AllowedSshCidr1"},
            "Description": "SSH access from primary CIDR"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0",
            "Description": "All outbound traffic"
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "SshSG-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "SshIngressRule2": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "HasSshCidr2",
      "Properties": {
        "GroupId": {"Ref": "SshSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 22,
        "ToPort": 22,
        "CidrIp": {"Ref": "AllowedSshCidr2"},
        "Description": "SSH access from secondary CIDR"
      }
    },
    "EC2InstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {"Fn::Sub": "EC2InstanceRole-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {"Service": "ec2.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "Policies": [
          {
            "PolicyName": "CloudWatchMetricsPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData",
                    "ec2:DescribeVolumes",
                    "ec2:DescribeTags",
                    "logs:PutLogEvents",
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogStreams"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "EC2InstanceRole-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "InstanceProfileName": {"Fn::Sub": "EC2InstanceProfile-${EnvironmentSuffix}"},
        "Roles": [{"Ref": "EC2InstanceRole"}]
      }
    },
    "WAFLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "WafLogsToCloudWatch",
      "Properties": {
        "LogGroupName": {"Fn::Sub": "aws-waf-logs-${EnvironmentSuffix}"},
        "RetentionInDays": 90,
        "KmsKeyId": {"Fn::If": [
          "UseKms",
          {"Fn::If": ["CreateKmsKey", {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]}, {"Ref": "KmsKeyArnForS3"}]},
          {"Ref": "AWS::NoValue"}
        ]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "WAFLogGroup-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "WAFLogsBucket": {
      "Type": "AWS::S3::Bucket",
      "Condition": "WafLogsToS3",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": {"Fn::Sub": "aws-waf-logs-${AWS::AccountId}-${EnvironmentSuffix}"},
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": {"Fn::If": ["UseKms", "aws:kms", "AES256"]},
                "KMSMasterKeyID": {"Fn::If": [
                  "UseKms",
                  {"Fn::If": [
                    "CreateKmsKey",
                    {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]},
                    {"Ref": "KmsKeyArnForS3"}
                  ]},
                  {"Ref": "AWS::NoValue"}
                ]}
              },
              "BucketKeyEnabled": {"Fn::If": ["UseKms", true, false]}
            }
          ]
        },
        "VersioningConfiguration": {"Status": "Enabled"},
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "WAFLogs-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "WAFLogsBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Condition": "WafLogsToS3",
      "Properties": {
        "Bucket": {"Ref": "WAFLogsBucket"},
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "DenyInsecureConnections",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                {"Fn::Sub": "arn:aws:s3:::${WAFLogsBucket}"},
                {"Fn::Sub": "arn:aws:s3:::${WAFLogsBucket}/*"}
              ],
              "Condition": {"Bool": {"aws:SecureTransport": "false"}}
            },
            {"Fn::If": [
              "UseKms",
              {
                "Sid": "DenyIncorrectEncryptionHeader",
                "Effect": "Deny",
                "Principal": "*",
                "Action": "s3:PutObject",
                "Resource": {"Fn::Sub": "arn:aws:s3:::${WAFLogsBucket}/*"},
                "Condition": {
                  "StringNotEqualsIfExists": {
                    "s3:x-amz-server-side-encryption": "aws:kms"
                  }
                }
              },
              {"Ref": "AWS::NoValue"}
            ]},
            {"Fn::If": [
              "UseKms",
              {
                "Sid": "DenyUnencryptedObjectUploads",
                "Effect": "Deny",
                "Principal": "*",
                "Action": "s3:PutObject",
                "Resource": {"Fn::Sub": "arn:aws:s3:::${WAFLogsBucket}/*"},
                "Condition": {
                  "Null": {"s3:x-amz-server-side-encryption": "true"}
                }
              },
              {"Ref": "AWS::NoValue"}
            ]}
          ]
        }
      }
    },
    "WAFLogsFirehoseRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "WafLogsToS3",
      "Properties": {
        "RoleName": {"Fn::Sub": "WAFLogsFirehoseRole-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {"Service": "firehose.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "FirehoseToS3",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:AbortMultipartUpload",
                    "s3:GetBucketLocation",
                    "s3:GetObject",
                    "s3:ListBucket",
                    "s3:ListBucketMultipartUploads",
                    "s3:PutObject"
                  ],
                  "Resource": [
                    {"Fn::GetAtt": ["WAFLogsBucket", "Arn"]},
                    {"Fn::Sub": "${WAFLogsBucket.Arn}/*"}
                  ]
                },
                {"Fn::If": [
                  "UseKms",
                  {
                    "Effect": "Allow",
                    "Action": ["kms:Decrypt", "kms:GenerateDataKey"],
                    "Resource": {"Fn::If": [
                      "CreateKmsKey",
                      {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]},
                      {"Ref": "KmsKeyArnForS3"}
                    ]}
                  },
                  {"Ref": "AWS::NoValue"}
                ]}
              ]
            }
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "WAFLogsFirehoseRole-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "WAFLogsDeliveryStream": {
      "Type": "AWS::KinesisFirehose::DeliveryStream",
      "Condition": "WafLogsToS3",
      "Properties": {
        "DeliveryStreamName": {"Fn::Sub": "aws-waf-logs-${EnvironmentSuffix}"},
        "ExtendedS3DestinationConfiguration": {
          "BucketARN": {"Fn::GetAtt": ["WAFLogsBucket", "Arn"]},
          "RoleARN": {"Fn::GetAtt": ["WAFLogsFirehoseRole", "Arn"]},
          "BufferingHints": {"IntervalInSeconds": 60, "SizeInMBs": 5},
          "CompressionFormat": "GZIP",
          "Prefix": "year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/",
          "ErrorOutputPrefix": "errors/"
        }
      }
    },
    "ALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "ALBSG-${EnvironmentSuffix}"},
        "GroupDescription": "Security group for Application Load Balancer",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTP access"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTPS access"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0",
            "Description": "All outbound traffic"
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "ALBSG-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": {"Fn::Sub": "ALB-${EnvironmentSuffix}"},
        "Type": "application",
        "Scheme": "internet-facing",
        "Subnets": [{"Ref": "PublicSubnet1"}, {"Ref": "PublicSubnet2"}],
        "SecurityGroups": [{"Ref": "ALBSecurityGroup"}],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "ALB-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "WAFWebACL": {
      "Type": "AWS::WAFv2::WebACL",
      "Properties": {
        "Name": {"Fn::Sub": "WebACL-${EnvironmentSuffix}"},
        "Scope": "REGIONAL",
        "DefaultAction": {"Allow": {}},
        "Rules": [
          {
            "Name": "AWSManagedRulesCommonRuleSet",
            "Priority": 1,
            "OverrideAction": {"None": {}},
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesCommonRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "CommonRuleSetMetric"
            }
          },
          {
            "Name": "AWSManagedRulesKnownBadInputsRuleSet",
            "Priority": 2,
            "OverrideAction": {"None": {}},
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "KnownBadInputsMetric"
            }
          },
          {
            "Name": "AWSManagedRulesSQLiRuleSet",
            "Priority": 3,
            "OverrideAction": {"None": {}},
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesSQLiRuleSet"
              }
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "SQLiRuleSetMetric"
            }
          }
        ],
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": {"Fn::Sub": "WebACL-${EnvironmentSuffix}"}
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "WebACL-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "WAFLoggingConfigurationCloudWatch": {
      "Type": "AWS::WAFv2::LoggingConfiguration",
      "Condition": "WafLogsToCloudWatch",
      "Properties": {
        "ResourceArn": {"Fn::GetAtt": ["WAFWebACL", "Arn"]},
        "LogDestinationConfigs": [{"Fn::GetAtt": ["WAFLogGroup", "Arn"]}]
      }
    },
    "WAFLoggingConfigurationS3": {
      "Type": "AWS::WAFv2::LoggingConfiguration",
      "Condition": "WafLogsToS3",
      "Properties": {
        "ResourceArn": {"Fn::GetAtt": ["WAFWebACL", "Arn"]},
        "LogDestinationConfigs": [{"Fn::GetAtt": ["WAFLogsDeliveryStream", "Arn"]}]
      }
    },
    "ShieldProtection": {
      "Type": "AWS::Shield::Protection",
      "Condition": "EnableShield",
      "Properties": {
        "Name": {"Fn::Sub": "Protect-${EnvironmentSuffix}"},
        "ResourceArn": {"Ref": "ApplicationLoadBalancer"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "Protect-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "DatabaseSecret": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": {"Fn::Sub": "DBSecret-${EnvironmentSuffix}"},
        "Description": "Database credentials for the application",
        "KmsKeyId": {"Fn::If": [
          "UseKms",
          {"Fn::If": ["CreateKmsKey", {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]}, {"Ref": "KmsKeyArnForS3"}]},
          {"Ref": "AWS::NoValue"}
        ]},
        "GenerateSecretString": {
          "SecretStringTemplate": "{\"username\": \"admin\"}",
          "GenerateStringKey": "password",
          "PasswordLength": 32,
          "ExcludeCharacters": "\"@/\\"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "DBSecret-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "SecurityNotificationsTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {"Fn::Sub": "SecurityNotifications-${EnvironmentSuffix}"},
        "KmsMasterKeyId": {"Fn::If": [
          "UseKms",
          {"Fn::If": ["CreateKmsKey", {"Fn::GetAtt": ["S3EncryptionKey", "Arn"]}, {"Ref": "KmsKeyArnForS3"}]},
          {"Ref": "AWS::NoValue"}
        ]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "SecurityNotifications-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    },
    "CloudWatchAgentConfig": {
      "Type": "AWS::SSM::Document",
      "Properties": {
        "DocumentType": "Command",
        "Name": {"Fn::Sub": "CloudWatchAgentConfig-${EnvironmentSuffix}"},
        "Content": {
          "schemaVersion": "2.2",
          "description": "Install and configure CloudWatch Agent on RPM-based systems (e.g., Amazon Linux, RHEL).",
          "parameters": {
            "config": {
              "type": "String",
              "description": "CloudWatch Agent configuration",
              "default": "{\n  \"agent\": { \"metrics_collection_interval\": 60, \"run_as_user\": \"cwagent\" },\n  \"metrics\": {\n    \"namespace\": \"CWAgent\",\n    \"metrics_collected\": {\n      \"cpu\":    { \"measurement\": [\"cpu_usage_idle\",\"cpu_usage_iowait\",\"cpu_usage_user\",\"cpu_usage_system\"], \"metrics_collection_interval\": 60 },\n      \"disk\":   { \"measurement\": [\"used_percent\"], \"metrics_collection_interval\": 60, \"resources\": [\"*\"] },\n      \"diskio\": { \"measurement\": [\"io_time\"], \"metrics_collection_interval\": 60, \"resources\": [\"*\"] },\n      \"mem\":    { \"measurement\": [\"mem_used_percent\"], \"metrics_collection_interval\": 60 },\n      \"netstat\":{ \"measurement\": [\"tcp_established\",\"tcp_time_wait\"], \"metrics_collection_interval\": 60 },\n      \"swap\":   { \"measurement\": [\"swap_used_percent\"], \"metrics_collection_interval\": 60 }\n    }\n  }\n}\n"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "installCloudWatchAgent",
              "inputs": {
                "runCommand": [
                  "wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm",
                  "rpm -U ./amazon-cloudwatch-agent.rpm",
                  "echo '{{ config }}' > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json",
                  "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s"
                ]
              }
            }
          ]
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "CloudWatchAgentConfig-${EnvironmentSuffix}"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "Environment", "Value": {"Ref": "Environment"}},
          {"Key": "Owner", "Value": {"Ref": "Owner"}}
        ]
      }
    }
  },
  "Outputs": {
    "CloudTrailBucketName": {
      "Description": "Name of the CloudTrail S3 bucket",
      "Value": {"Ref": "CloudTrailBucket"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-TrailBucketName"}}
    },
    "CloudTrailArn": {
      "Condition": "CreateCloudTrail",
      "Description": "ARN of the CloudTrail",
      "Value": {"Fn::GetAtt": ["CloudTrail", "Arn"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-CloudTrailArn"}}
    },
    "CloudTrailLogGroupArn": {
      "Condition": "CreateCloudTrailAndCW",
      "Description": "ARN of the CloudTrail log group",
      "Value": {"Fn::GetAtt": ["CloudTrailLogGroup", "Arn"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-CloudTrailLogGroupArn"}}
    },
    "SshSecurityGroupId": {
      "Description": "Security Group ID for SSH access",
      "Value": {"Ref": "SshSecurityGroup"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-SshSecurityGroupId"}}
    },
    "EC2InstanceRoleArn": {
      "Description": "ARN of the EC2 Instance Role",
      "Value": {"Fn::GetAtt": ["EC2InstanceRole", "Arn"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-EC2InstanceRoleArn"}}
    },
    "EC2InstanceProfileArn": {
      "Description": "ARN of the EC2 Instance Profile",
      "Value": {"Fn::GetAtt": ["EC2InstanceProfile", "Arn"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-EC2InstanceProfileArn"}}
    },
    "WAFWebACLArn": {
      "Description": "ARN of the WAF Web ACL",
      "Value": {"Fn::GetAtt": ["WAFWebACL", "Arn"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-WAFWebACLArn"}}
    },
    "ApplicationLoadBalancerArn": {
      "Description": "ARN of the Application Load Balancer",
      "Value": {"Ref": "ApplicationLoadBalancer"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-ALBArn"}}
    },
    "VpcId": {
      "Description": "VPC ID",
      "Value": {"Ref": "VPC"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-VpcId"}}
    },
    "PublicSubnet1Id": {
      "Description": "Public Subnet 1 ID",
      "Value": {"Ref": "PublicSubnet1"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-PublicSubnet1Id"}}
    },
    "PublicSubnet2Id": {
      "Description": "Public Subnet 2 ID",
      "Value": {"Ref": "PublicSubnet2"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-PublicSubnet2Id"}}
    },
    "ApplicationLoadBalancerDNS": {
      "Description": "DNS name of the Application Load Balancer",
      "Value": {"Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-ALBDNSName"}}
    }
  }
}
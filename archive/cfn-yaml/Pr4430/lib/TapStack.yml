AWSTemplateFormatVersion: "2010-09-09"
Description: "TAP Stack - Task Assignment Platform CloudFormation Template"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: Environment suffix for resource naming (e.g., dev, staging, prod)

  SecondaryAlbDnsName:
    Type: String
    Default: ""
    Description: DNS name of the ALB in the secondary region (for CloudFront failover)

  VpcId:
    Type: String
    Default: ""
    Description: Existing VPC ID; leave blank to create a new VPC

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    AllowedValues:
      - 10.0.0.0/16
      - 10.1.0.0/16
    Description: CIDR block of the existing VPC

  DomainName:
    Type: String
    Default: ""
    Description: Domain name for the application (e.g., example.com)

  Team:
    Type: String
    Default: "default"
    Description: Team or application name for naming convention

  Environment:
    Type: String
    Default: production
    AllowedValues:
      - development
      - staging
      - production
    Description: Environment name

  Region:
    Type: String
    Default: us-east-1
    AllowedValues:
      - us-east-1
      - us-west-2
    Description: AWS Region for deployment

  KeyPairName:
    Type: String
    Default: ""
    Description: EC2 Key Pair name; leave blank to skip SSH key

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    Description: EC2 instance type for web servers

  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: SSM parameter for latest Amazon Linux 2 x86_64 AMI

# Mappings for region-specific configurations
Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c02fb55731490381 # Amazon Linux 2 AMI
      AZs: ["us-east-1a", "us-east-1b", "us-east-1c"]
      S3Endpoint: s3.amazonaws.com
    us-west-2:
      AMI: ami-0352d5a37fb4f603f # Amazon Linux 2 AMI
      AZs: ["us-west-2a", "us-west-2b", "us-west-2c"]
      S3Endpoint: s3-us-west-2.amazonaws.com

# Conditions for region-specific resources
Conditions:
  IsUSEast1: !Equals [!Ref Region, "us-east-1"]
  IsProduction: !Equals [!Ref Environment, "production"]
  CreateVPC: !Equals [!Ref VpcId, ""]
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, ""]]
  HasDomain: !Not [!Equals [!Ref DomainName, ""]]
  IsUSEast1AndHasDomain: !And [!Condition IsUSEast1, !Condition HasDomain]

Resources:
  # ==========================================
  # NETWORKING RESOURCES
  # ==========================================

  # VPC (conditionally created if VpcId not provided)
  VPC:
    Type: AWS::EC2::VPC
    Condition: CreateVPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-vpc"

  # Public Subnets for ALB
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      CidrBlock:
        !Select [
          0,
          !If [
            IsUSEast1,
            ["10.0.1.0/24", "10.0.2.0/24"],
            ["10.1.1.0/24", "10.1.2.0/24"],
          ],
        ]
      AvailabilityZone: !Select [0, !FindInMap [RegionMap, !Ref Region, AZs]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-subnet-public-1"
        - Key: Type
          Value: Public

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      CidrBlock:
        !Select [
          1,
          !If [
            IsUSEast1,
            ["10.0.1.0/24", "10.0.2.0/24"],
            ["10.1.1.0/24", "10.1.2.0/24"],
          ],
        ]
      AvailabilityZone: !Select [1, !FindInMap [RegionMap, !Ref Region, AZs]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-subnet-public-2"
        - Key: Type
          Value: Public

  # Private Subnets for EC2 instances
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      CidrBlock: !If [IsUSEast1, "10.0.10.0/24", "10.1.10.0/24"]
      AvailabilityZone: !Select [0, !FindInMap [RegionMap, !Ref Region, AZs]]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-subnet-private-1"
        - Key: Type
          Value: Private

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      CidrBlock: !If [IsUSEast1, "10.0.11.0/24", "10.1.11.0/24"]
      AvailabilityZone: !Select [1, !FindInMap [RegionMap, !Ref Region, AZs]]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-subnet-private-2"
        - Key: Type
          Value: Private

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-igw"

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      InternetGatewayId: !Ref InternetGateway

  # NAT Gateways for private subnets
  NATGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NATGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NATGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  NATGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-rt-public"

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-rt-private-1"

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway1

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-rt-private-2"

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway2

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # ==========================================
  # SECURITY GROUPS
  # ==========================================

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS from anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from anywhere (redirect to HTTPS)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-sg-alb"

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Web Server EC2 instances
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTPS from ALB
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTP from ALB
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-sg-web"

  # ==========================================
  # IAM ROLES AND POLICIES
  # ==========================================

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${Team}-${EnvironmentSuffix}-ec2-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::${AppAssetsBucket}/*"
                  - !Sub "arn:aws:s3:::${AppAssetsBucket}"
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource:
                  - !Sub "arn:aws:s3:::${LogsBucket}/*"
        - PolicyName: DynamoDBAccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt SessionTable.Arn
        - PolicyName: SecretsManagerPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref AppSecrets
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/webapp/*"
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-ec2-role"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  # ==========================================
  # S3 BUCKETS
  # ==========================================

  AppAssetsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${Team}-${EnvironmentSuffix}-assets-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-assets"

  LogsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub "${Team}-${EnvironmentSuffix}-logs-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-logs"

  LogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref LogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AWSLogDeliveryWrite
            Effect: Allow
            Principal:
              Service: logdelivery.elasticloadbalancing.amazonaws.com
            Action:
              - s3:PutObject
            Resource: !Sub "${LogsBucket.Arn}/alb-logs/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
                aws:SourceAccount: !Sub "${AWS::AccountId}"
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/*"
          - Sid: AWSLogDeliveryCheck
            Effect: Allow
            Principal:
              Service: logdelivery.elasticloadbalancing.amazonaws.com
            Action:
              - s3:GetBucketAcl
              - s3:ListBucket
            Resource: !GetAtt LogsBucket.Arn
            Condition:
              StringEquals:
                aws:SourceAccount: !Sub "${AWS::AccountId}"
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/*"

  AppAssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: IsUSEast1AndHasDomain
    Properties:
      Bucket: !Ref AppAssetsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              CanonicalUser: !GetAtt CloudFrontOAI.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub "${AppAssetsBucket.Arn}/*"

    # ==========================================
  # ACM CERTIFICATES
  # ==========================================

  ALBCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: HasDomain
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Sub "*.${DomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !If [IsUSEast1, !Ref HostedZone, !Ref "AWS::NoValue"]
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-alb-cert"

  CloudFrontCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: IsUSEast1AndHasDomain
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Sub "*.${DomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZone
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-cf-cert"

  # ==========================================
  # APPLICATION LOAD BALANCER
  # ==========================================

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${Team}-${EnvironmentSuffix}-alb"
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: "60"
        - Key: routing.http2.enabled
          Value: "true"
        - Key: access_logs.s3.enabled
          Value: "true"
        - Key: access_logs.s3.bucket
          Value: !Ref LogsBucket
        - Key: access_logs.s3.prefix
          Value: "alb-logs"
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-alb"

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${Team}-${EnvironmentSuffix}-tg"
      Port: 80
      Protocol: HTTP
      VpcId: !If [CreateVPC, !Ref VPC, !Ref VpcId]
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: "200"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "30"
        - Key: stickiness.enabled
          Value: "true"
        - Key: stickiness.type
          Value: "lb_cookie"
        - Key: stickiness.lb_cookie.duration_seconds
          Value: "86400"
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-tg"

  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            StatusCode: HTTP_301

  HTTPSListener:
    Condition: HasDomain
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ALBCertificate
      SslPolicy: ELBSecurityPolicy-TLS-1-2-2017-01
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  # ==========================================
  # AUTO SCALING
  # ==========================================

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${Team}-${EnvironmentSuffix}-launch-template"
      LaunchTemplateData:
        ImageId: !Ref AmiId
        InstanceType: !Ref InstanceType
        KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref "AWS::NoValue"]
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${Team}-${EnvironmentSuffix}-web"
              - Key: Environment
                Value: !Ref Environment
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd
            yum install -y amazon-cloudwatch-agent

            # Install and configure Apache
            systemctl start httpd
            systemctl enable httpd

            # Create health check endpoint
            echo "OK" > /var/www/html/health

            # Configure CloudWatch agent
            cat > /opt/aws/amazon-cloudwatch-agent/etc/config.json <<EOF
            {
              "metrics": {
                "namespace": "${Team}-${EnvironmentSuffix}",
                "metrics_collected": {
                  "cpu": {
                    "measurement": [
                      {"name": "cpu_usage_idle", "rename": "CPU_IDLE", "unit": "Percent"}
                    ],
                    "metrics_collection_interval": 60
                  },
                  "mem": {
                    "measurement": [
                      {"name": "mem_used_percent", "rename": "MEM_USED", "unit": "Percent"}
                    ],
                    "metrics_collection_interval": 60
                  }
                }
              },
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/log/httpd/access_log",
                        "log_group_name": "/aws/webapp/access",
                        "log_stream_name": "{instance_id}"
                      },
                      {
                        "file_path": "/var/log/httpd/error_log",
                        "log_group_name": "/aws/webapp/error",
                        "log_stream_name": "{instance_id}"
                      }
                    ]
                  }
                }
              }
            }
            EOF

            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a start -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${Team}-${EnvironmentSuffix}-asg"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      MinSize: !If [IsProduction, 2, 1]
      MaxSize: !If [IsProduction, 10, 5]
      DesiredCapacity: !If [IsProduction, 4, 2]
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref TargetGroup
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-asg-instance"
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true

  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 25.0

  # ==========================================
  # DYNAMODB TABLE FOR SESSION MANAGEMENT
  # ==========================================

  SessionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Team}-${EnvironmentSuffix}-sessions"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: SessionId
          AttributeType: S
        - AttributeName: UserId
          AttributeType: S
      KeySchema:
        - AttributeName: SessionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: UserId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-sessions"

  # ==========================================
  # AWS SECRETS MANAGER
  # ==========================================

  AppSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${Team}-${EnvironmentSuffix}-app-secrets"
      Description: Application secrets for web application
      KmsKeyId: alias/aws/secretsmanager
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-app-secrets"

  # ==========================================
  # ROUTE 53
  # ==========================================

  HostedZone:
    Type: AWS::Route53::HostedZone
    Condition: IsUSEast1AndHasDomain
    Properties:
      Name: !Ref DomainName
      HostedZoneConfig:
        Comment: !Sub "Hosted zone for ${Team}-${EnvironmentSuffix}-${DomainName}"

  RecordSetGroup:
    Type: AWS::Route53::RecordSetGroup
    Condition: IsUSEast1AndHasDomain
    Properties:
      HostedZoneId: !Ref HostedZone
      RecordSets:
        - Name: !Ref DomainName
          Type: A
          AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt CloudFrontDistribution.DomainName
        - Name: !Sub "www.${DomainName}"
          Type: A
          AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt CloudFrontDistribution.DomainName

  # Health check for Route 53
  HealthCheck:
    Type: AWS::Route53::HealthCheck
    Condition: IsUSEast1AndHasDomain
    Properties:
      HealthCheckConfig:
        Type: HTTPS
        ResourcePath: /health
        FullyQualifiedDomainName: !GetAtt ApplicationLoadBalancer.DNSName
        Port: 443
        RequestInterval: 30
        FailureThreshold: 3

  # ==========================================
  # CLOUDFRONT DISTRIBUTION
  # ==========================================

  CloudFrontOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Condition: IsUSEast1AndHasDomain
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub "OAI for ${AWS::StackName}"

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: IsUSEast1AndHasDomain
    Properties:
      DistributionConfig:
        Comment: !Sub "CloudFront distribution for ${Team}-${EnvironmentSuffix}"
        Enabled: true
        HttpVersion: http2
        PriceClass: PriceClass_100
        ViewerCertificate:
          AcmCertificateArn: !Ref CloudFrontCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        Aliases:
          - !Ref DomainName
          - !Sub "www.${DomainName}"
        DefaultRootObject: index.html
        Origins:
          - Id: ALBOriginPrimary
            DomainName: !GetAtt ApplicationLoadBalancer.DNSName
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
          - Id: ALBOriginSecondary
            DomainName: !Ref SecondaryAlbDnsName
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
          - Id: S3Origin
            DomainName: !GetAtt AppAssetsBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOAI}"
        OriginGroups:
          Quantity: 1
          Items:
            - Id: PrimaryWithFailover
              FailoverCriteria:
                StatusCodes:
                  Quantity: 2
                  Items:
                    - 502
                    - 503
              Members:
                Quantity: 2
                Items:
                  - OriginId: ALBOriginPrimary
                  - OriginId: ALBOriginSecondary
        DefaultCacheBehavior:
          TargetOriginId: PrimaryWithFailover
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - POST
            - PATCH
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: true
            Headers:
              - Host
              - Origin
              - Authorization
            Cookies:
              Forward: all
          MinTTL: 0
          DefaultTTL: 86400
          MaxTTL: 31536000
          Compress: true
        CacheBehaviors:
          - PathPattern: /static/*
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
            CachedMethods:
              - GET
              - HEAD
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            MinTTL: 86400
            DefaultTTL: 604800
            MaxTTL: 31536000
            Compress: true
        Logging:
          Bucket: !GetAtt LogsBucket.DomainName
          Prefix: cloudfront-logs/
          IncludeCookies: false
        WebACLId: !Ref WebACL
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-cloudfront"

  # ==========================================
  # WAF WEB ACL
  # ==========================================

  WebACL:
    Type: AWS::WAFv2::WebACL
    Condition: IsUSEast1AndHasDomain
    Properties:
      Name: !Sub "${Team}-${EnvironmentSuffix}-web-acl"
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      Rules:
        - Name: RateLimitRule
          Priority: 1
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: RateLimitRule
        - Name: SQLInjectionRule
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: SQLInjectionRule
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub "${Team}-${EnvironmentSuffix}-web-acl"
      Tags:
        - Key: Name
          Value: !Sub "${Team}-${EnvironmentSuffix}-web-acl"

  # ==========================================
  # CLOUDWATCH MONITORING
  # ==========================================

  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/webapp/${Team}-${EnvironmentSuffix}"
      RetentionInDays: 30

  ApplicationDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${Team}-${EnvironmentSuffix}-dashboard"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApplicationELB", "TargetResponseTime", {"stat": "Average", "label": "Response Time"}],
                  [".", "RequestCount", {"stat": "Sum", "label": "Request Count"}],
                  [".", "HealthyHostCount", {"stat": "Average", "label": "Healthy Hosts"}],
                  [".", "UnHealthyHostCount", {"stat": "Average", "label": "Unhealthy Hosts"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "ALB Metrics"
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/EC2", "CPUUtilization", {"stat": "Average"}],
                  [".", "NetworkIn", {"stat": "Sum"}],
                  [".", "NetworkOut", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "EC2 Metrics"
              }
            }
          ]
        }

  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Team}-${EnvironmentSuffix}-high-cpu"
      AlarmDescription: Alarm when CPU exceeds 80%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup

  UnhealthyHostAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${Team}-${EnvironmentSuffix}-unhealthy-hosts"
      AlarmDescription: Alarm when unhealthy host count is greater than 0
      MetricName: UnHealthyHostCount
      Namespace: AWS/ApplicationELB
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 0
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
        - Name: TargetGroup
          Value: !GetAtt TargetGroup.TargetGroupFullName

# ==========================================
# OUTPUTS
# ==========================================

Outputs:
  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub "${AWS::StackName}-ALB-DNS"

  CloudFrontURL:
    Condition: IsUSEast1AndHasDomain
    Description: CloudFront distribution URL
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFront-URL"

  WebsiteURL:
    Description: Website URL
    Value: !Sub "https://${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-Website-URL"

  S3AssetsBucket:
    Description: S3 bucket for application assets
    Value: !Ref AppAssetsBucket
    Export:
      Name: !Sub "${AWS::StackName}-Assets-Bucket"

  S3LogsBucket:
    Description: S3 bucket for logs
    Value: !Ref LogsBucket
    Export:
      Name: !Sub "${AWS::StackName}-Logs-Bucket"

  DynamoDBTableName:
    Description: DynamoDB table name for sessions
    Value: !Ref SessionTable
    Export:
      Name: !Sub "${AWS::StackName}-Session-Table"

  SecretsManagerARN:
    Description: ARN of Secrets Manager secret
    Value: !Ref AppSecrets
    Export:
      Name: !Sub "${AWS::StackName}-Secrets-ARN"

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${AWS::StackName}-Dashboard"

{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TapStack â€” Secure, private-only VPC web app with ASG, internet-facing ALB in dedicated egress subnets, RDS in private DB subnets, KMS, S3 (app + logs), SSM (SecureString via custom resource), CloudTrail, VPC Flow Logs, and least-privilege IAM. Region-locked to us-west-2 via mapping guard dereference.\n",
    "Metadata": {
        "TemplateName": "TapStack.yml",
        "Version": "1.0.13",
        "Owner": "TapStack",
        "Security": "Confidential",
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "General Settings"
                    },
                    "Parameters": [
                        "EnvironmentName",
                        "OwnerTag"
                    ]
                },
                {
                    "Label": {
                        "default": "Networking (us-west-2 only)"
                    },
                    "Parameters": [
                        "VpcCidr",
                        "AppSubnetCidrs",
                        "DbSubnetCidrs",
                        "EgressSubnetCidrs"
                    ]
                },
                {
                    "Label": {
                        "default": "Compute (EC2 ASG Web Tier)"
                    },
                    "Parameters": [
                        "AppImageId",
                        "InstanceType",
                        "MinCapacity",
                        "DesiredCapacity",
                        "MaxCapacity",
                        "UseAwsManagedEbsKey"
                    ]
                },
                {
                    "Label": {
                        "default": "Database (RDS - PostgreSQL/MySQL)"
                    },
                    "Parameters": [
                        "DbEngine",
                        "DbEngineVersion",
                        "DbInstanceClass",
                        "DbAllocatedStorage",
                        "DbMasterUsername",
                        "DbPort"
                    ]
                },
                {
                    "Label": {
                        "default": "SSM Parameters (values written as SecureString)"
                    },
                    "Parameters": [
                        "AppSecretValue",
                        "AppSecretParamPath"
                    ]
                }
            ],
            "ParameterLabels": {
                "EnvironmentName": {
                    "default": "Environment name prefix (e.g., prod, staging, dev)"
                },
                "OwnerTag": {
                    "default": "Owner tag"
                }
            }
        }
    },
    "Mappings": {
        "RegionGuard": {
            "us-west-2": {
                "Allowed": "true"
            }
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Type": "String",
            "Default": "prod",
            "AllowedPattern": "^[a-z0-9-]+$",
            "Description": "Prefix for resource names/tags (e.g., prod, staging, dev)"
        },
        "OwnerTag": {
            "Type": "String",
            "Default": "TapStack",
            "Description": "Owner tag for resources"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "VPC CIDR"
        },
        "AppSubnetCidrs": {
            "Type": "CommaDelimitedList",
            "Default": "10.0.10.0/24,10.0.11.0/24",
            "Description": "Two private app subnet CIDRs (AZ0, AZ1)"
        },
        "DbSubnetCidrs": {
            "Type": "CommaDelimitedList",
            "Default": "10.0.20.0/24,10.0.21.0/24",
            "Description": "Two private DB subnet CIDRs (AZ0, AZ1)"
        },
        "EgressSubnetCidrs": {
            "Type": "CommaDelimitedList",
            "Default": "10.0.1.0/24,10.0.2.0/24",
            "Description": "Two egress/NAT subnet CIDRs (AZ0, AZ1). No app/DB resources here."
        },
        "AppImageId": {
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Description": "Resolved from public SSM path for Amazon Linux 2023 x86_64 in us-west-2",
            "Default": "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64"
        },
        "InstanceType": {
            "Type": "String",
            "Default": "t3.micro",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t4g.micro",
                "t4g.small",
                "t4g.medium"
            ]
        },
        "MinCapacity": {
            "Type": "Number",
            "Default": 2,
            "MinValue": 1
        },
        "DesiredCapacity": {
            "Type": "Number",
            "Default": 2,
            "MinValue": 1
        },
        "MaxCapacity": {
            "Type": "Number",
            "Default": 4,
            "MinValue": 1
        },
        "UseAwsManagedEbsKey": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "true",
            "Description": "If true, do NOT set KmsKeyId for EBS (use AWS-managed EBS key). If false, use the customer CMK for EBS."
        },
        "DbEngine": {
            "Type": "String",
            "Default": "postgres",
            "AllowedValues": [
                "mysql",
                "postgres"
            ]
        },
        "DbEngineVersion": {
            "Type": "String",
            "Default": ""
        },
        "DbInstanceClass": {
            "Type": "String",
            "Default": "db.t3.micro"
        },
        "DbAllocatedStorage": {
            "Type": "Number",
            "Default": 20,
            "MinValue": 20
        },
        "DbMasterUsername": {
            "Type": "String",
            "Default": "tapadmin",
            "AllowedPattern": "^[a-zA-Z0-9_]+$"
        },
        "DbPort": {
            "Type": "Number",
            "Default": 5432,
            "Description": "5432 for Postgres, 3306 for MySQL"
        },
        "AppSecretValue": {
            "Type": "String",
            "NoEcho": true,
            "Default": "replace-this-app-secret"
        },
        "AppSecretParamPath": {
            "Type": "String",
            "Default": "/tapstack/prod/app/secret"
        }
    },
    "Conditions": {
        "HasDbEngineVersion": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DbEngineVersion"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseCMKForEbs": {
            "Fn::Equals": [
                {
                    "Ref": "UseAwsManagedEbsKey"
                },
                "false"
            ]
        }
    },
    "Resources": {
        "RegionAssert": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/tapstack/${EnvironmentName}/region-assert"
                },
                "Type": "String",
                "Value": {
                    "Fn::FindInMap": [
                        "RegionGuard",
                        {
                            "Ref": "AWS::Region"
                        },
                        "Allowed"
                    ]
                },
                "Description": "Prevents deployment outside us-west-2 by mapping lookup."
            }
        },
        "KmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "${EnvironmentName}-tapstack primary CMK for S3, Logs, SSM (custom), and RDS"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowAccountAdmin",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowS3ForBucketEncryption",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "s3.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "s3.${AWS::Region}.amazonaws.com"
                                    },
                                    "aws:PrincipalAccount": {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        },
                        {
                            "Sid": "AllowCloudTrail",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringLike": {
                                    "kms:EncryptionContext:aws:cloudtrail:arn": {
                                        "Fn::Sub": "arn:${AWS::Partition}:cloudtrail:*:${AWS::AccountId}:trail/*"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AllowCloudWatchLogs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowRDS",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:GenerateDataKey*",
                                "kms:ReEncrypt*",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        },
                        {
                            "Sid": "AllowSSMParameterStore",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ssm.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        },
                        {
                            "Sid": "AllowEC2ForEBS",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "ec2.${AWS::Region}.amazonaws.com"
                                    },
                                    "aws:PrincipalAccount": {
                                        "Ref": "AWS::AccountId"
                                    },
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        },
                        {
                            "Sid": "AllowAutoScalingToCreateGrants",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "autoscaling.amazonaws.com"
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "aws:PrincipalAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AllowASGServiceLinkedRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"
                                }
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:DescribeKey",
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:GenerateDataKey*",
                                "kms:ReEncrypt*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:GrantIsForAWSResource": "true"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "KmsAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentName}-tapstack-kms"
                },
                "TargetKeyId": {
                    "Ref": "KmsKey"
                }
            }
        },
        "LogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-logs-${AWS::AccountId}-${AWS::Region}"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerPreferred"
                        }
                    ]
                }
            }
        },
        "LogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "LogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck20150319",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "LogsBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite20150319",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${LogsBucket.Arn}/cloudtrail/AWSLogs/${AWS::AccountId}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "AWSALBLogDeliveryCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logdelivery.elasticloadbalancing.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "LogsBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "AWSALBLogDeliveryWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logdelivery.elasticloadbalancing.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": [
                                {
                                    "Fn::Sub": "${LogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
                                },
                                {
                                    "Fn::Sub": "${LogsBucket.Arn}/alb/${EnvironmentName}/AWSLogs/${AWS::AccountId}/*"
                                }
                            ],
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "LogsBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${LogsBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AppDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-appdata-${AWS::AccountId}-${AWS::Region}"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "KmsKey"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AppDataBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "AppDataBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnforceTLS",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "AppDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${AppDataBucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-vpc"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-igw"
                        }
                    }
                ]
            }
        },
        "VPCGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "EgressSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Ref": "EgressSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-egress-a"
                        }
                    }
                ]
            }
        },
        "EgressSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Ref": "EgressSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-egress-b"
                        }
                    }
                ]
            }
        },
        "EgressRT": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-egress-rt"
                        }
                    }
                ]
            }
        },
        "EgressRouteToIGW": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "EgressRT"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "EgressAssocA": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "EgressSubnetA"
                },
                "RouteTableId": {
                    "Ref": "EgressRT"
                }
            }
        },
        "EgressAssocB": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "EgressSubnetB"
                },
                "RouteTableId": {
                    "Ref": "EgressRT"
                }
            }
        },
        "EIPA": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "EIPB": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "NatGwA": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "EIPA",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "EgressSubnetA"
                },
                "ConnectivityType": "public",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-nat-a"
                        }
                    }
                ]
            }
        },
        "NatGwB": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "EIPB",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "EgressSubnetB"
                },
                "ConnectivityType": "public",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-nat-b"
                        }
                    }
                ]
            }
        },
        "AppSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Ref": "AppSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-app-a"
                        }
                    }
                ]
            }
        },
        "AppSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Ref": "AppSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-app-b"
                        }
                    }
                ]
            }
        },
        "AppRT": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-app-rt"
                        }
                    }
                ]
            }
        },
        "AppRouteToNATa": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "AppRT"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGwA"
                }
            }
        },
        "AppAssocA": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "AppSubnetA"
                },
                "RouteTableId": {
                    "Ref": "AppRT"
                }
            }
        },
        "AppAssocB": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "AppSubnetB"
                },
                "RouteTableId": {
                    "Ref": "AppRT"
                }
            }
        },
        "DbSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Ref": "DbSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-db-a"
                        }
                    }
                ]
            }
        },
        "DbSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Ref": "DbSubnetCidrs"
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-db-b"
                        }
                    }
                ]
            }
        },
        "DbRT": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-tapstack-db-rt"
                        }
                    }
                ]
            }
        },
        "DbRouteToNATb": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "DbRT"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGwB"
                }
            }
        },
        "DbAssocA": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "DbSubnetA"
                },
                "RouteTableId": {
                    "Ref": "DbRT"
                }
            }
        },
        "DbAssocB": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "DbSubnetB"
                },
                "RouteTableId": {
                    "Ref": "DbRT"
                }
            }
        },
        "AlbSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-alb-sg"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "WebSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-web-sg (HTTP only from anywhere)"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "DbSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-db-sg (only from WebSG)"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": {
                            "Ref": "DbPort"
                        },
                        "ToPort": {
                            "Ref": "DbPort"
                        },
                        "SourceSecurityGroupId": {
                            "Ref": "WebSG"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "AppLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/tapstack/${EnvironmentName}/app"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KmsKey",
                        "Arn"
                    ]
                }
            }
        },
        "FlowLogsGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/tapstack/${EnvironmentName}/vpc-flow-logs"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KmsKey",
                        "Arn"
                    ]
                }
            }
        },
        "FlowLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-flowlogs-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "vpc-flowlogs-to-cw",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VpcFlowLog": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "FlowLogsRole",
                        "Arn"
                    ]
                },
                "LogDestinationType": "cloud-watch-logs",
                "LogGroupName": {
                    "Ref": "FlowLogsGroup"
                },
                "ResourceId": {
                    "Ref": "VPC"
                },
                "ResourceType": "VPC",
                "TrafficType": "ALL"
            }
        },
        "ALB": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "DependsOn": [
                "LogsBucketPolicy"
            ],
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-alb"
                },
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Ref": "AlbSG"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "EgressSubnetA"
                    },
                    {
                        "Ref": "EgressSubnetB"
                    }
                ],
                "LoadBalancerAttributes": [
                    {
                        "Key": "access_logs.s3.enabled",
                        "Value": "true"
                    },
                    {
                        "Key": "access_logs.s3.bucket",
                        "Value": {
                            "Ref": "LogsBucket"
                        }
                    },
                    {
                        "Key": "access_logs.s3.prefix",
                        "Value": {
                            "Fn::Sub": "alb/${EnvironmentName}"
                        }
                    }
                ],
                "Type": "application",
                "IpAddressType": "ipv4"
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-tg"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "instance",
                "HealthCheckEnabled": true,
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "Matcher": {
                    "HttpCode": "200-399"
                }
            }
        },
        "ALBListenerHTTP": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "ALB"
                },
                "Port": 80,
                "Protocol": "HTTP"
            }
        },
        "WebInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-web-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    {
                        "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
                    }
                ],
                "Policies": [
                    {
                        "PolicyName": "web-inline-ssm-s3-cw",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:GetParameters",
                                        "ssm:GetParameter"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter${AppSecretParamPath}"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "AppDataBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${AppDataBucket.Arn}/app/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KmsKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "WebInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "WebInstanceRole"
                    }
                ]
            }
        },
        "LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-lt"
                },
                "LaunchTemplateData": {
                    "ImageId": {
                        "Ref": "AppImageId"
                    },
                    "InstanceType": {
                        "Ref": "InstanceType"
                    },
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "WebInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "NetworkInterfaces": [
                        {
                            "AssociatePublicIpAddress": false,
                            "DeviceIndex": 0,
                            "Groups": [
                                {
                                    "Ref": "WebSG"
                                }
                            ]
                        }
                    ],
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "Encrypted": true,
                                "KmsKeyId": {
                                    "Fn::If": [
                                        "UseCMKForEbs",
                                        {
                                            "Ref": "KmsKey"
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                },
                                "VolumeSize": 10,
                                "VolumeType": "gp3"
                            }
                        }
                    ],
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash\nset -euxo pipefail\nretry() { n=0; until [ $n -ge 5 ]; do \"$@\" && break; n=$((n+1)); sleep 10; done; }\n\nretry dnf -y makecache\nretry dnf install -y nginx awscli\n\necho \"OK - TapStack ${EnvironmentName}\" > /usr/share/nginx/html/index.html\nsystemctl enable nginx\nsystemctl start nginx\n\n# SSM fetch (non-fatal if not yet present)\naws ssm get-parameter --name \"${AppSecretParamPath}\" --with-decryption --region ${AWS::Region} || true\n"
                        }
                    }
                }
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "VPCZoneIdentifier": [
                    {
                        "Ref": "AppSubnetA"
                    },
                    {
                        "Ref": "AppSubnetB"
                    }
                ],
                "MinSize": {
                    "Ref": "MinCapacity"
                },
                "DesiredCapacity": {
                    "Ref": "DesiredCapacity"
                },
                "MaxSize": {
                    "Ref": "MaxCapacity"
                },
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "TargetGroupARNs": [
                    {
                        "Ref": "ALBTargetGroup"
                    }
                ],
                "HealthCheckType": "EC2",
                "HealthCheckGracePeriod": 300,
                "MetricsCollection": [
                    {
                        "Granularity": "1Minute"
                    }
                ]
            }
        },
        "DbSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-dbsubnets"
                },
                "SubnetIds": [
                    {
                        "Ref": "DbSubnetA"
                    },
                    {
                        "Ref": "DbSubnetB"
                    }
                ],
                "DBSubnetGroupName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-dbsubnets"
                }
            }
        },
        "DBInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-db"
                },
                "AllocatedStorage": {
                    "Ref": "DbAllocatedStorage"
                },
                "DBInstanceClass": {
                    "Ref": "DbInstanceClass"
                },
                "Engine": {
                    "Ref": "DbEngine"
                },
                "EngineVersion": {
                    "Fn::If": [
                        "HasDbEngineVersion",
                        {
                            "Ref": "DbEngineVersion"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "MasterUsername": {
                    "Ref": "DbMasterUsername"
                },
                "ManageMasterUserPassword": true,
                "Port": {
                    "Ref": "DbPort"
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "MultiAZ": true,
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "KmsKey"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DbSG"
                    }
                ],
                "PubliclyAccessible": false,
                "BackupRetentionPeriod": 7,
                "DeletionProtection": true
            }
        },
        "SSMWriterRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-ssm-writer-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "inline-ssm-put-secure",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:PutParameter",
                                        "ssm:AddTagsToResource",
                                        "ssm:GetParameter",
                                        "ssm:GetParameters"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Encrypt",
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey*",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KmsKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "SSMWriterFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-ssm-writer"
                },
                "Runtime": "python3.12",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "SSMWriterRole",
                        "Arn"
                    ]
                },
                "Timeout": 30,
                "Code": {
                    "ZipFile": "import boto3\nimport json\nfrom urllib.request import Request, urlopen\nssm = boto3.client('ssm')\ndef send(event, context, status, data, reason=None):\n    responseUrl = event['ResponseURL']\n    body = {\n        'Status': status,\n        'Reason': reason or f\"See CloudWatch Log Stream: {context.log_stream_name}\",\n        'PhysicalResourceId': context.log_stream_name,\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'Data': data or {}\n    }\n    encoded = json.dumps(body).encode('utf-8')\n    req = Request(responseUrl, data=encoded, method='PUT')\n    req.add_header('Content-Type', '')\n    req.add_header('Content-Length', str(len(encoded)))\n    urlopen(req)\ndef handler(event, context):\n    try:\n        if event['RequestType'] in ('Create','Update'):\n            props = event['ResourceProperties']\n            name = props['Name']\n            value = props['Value']\n            key_id = props['KmsKeyId']\n            tags = props.get('Tags', [])\n            ssm.put_parameter(Name=name, Value=value, Type='SecureString', KeyId=key_id, Overwrite=True)\n            if isinstance(tags, list) and tags:\n                ssm.add_tags_to_resource(ResourceType='Parameter', ResourceId=name, Tags=tags)\n            send(event, context, 'SUCCESS', {'Name': name})\n        elif event['RequestType'] == 'Delete':\n            # Leave the parameter by default\n            send(event, context, 'SUCCESS', {})\n    except Exception as e:\n        send(event, context, 'FAILED', {}, reason=str(e))\n"
                }
            }
        },
        "AppSecretParam": {
            "Type": "Custom::SSMParameter",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "SSMWriterFunction",
                        "Arn"
                    ]
                },
                "Name": {
                    "Ref": "AppSecretParamPath"
                },
                "Value": {
                    "Ref": "AppSecretValue"
                },
                "KmsKeyId": {
                    "Ref": "KmsKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "TapStack"
                    }
                ]
            }
        },
        "CloudTrailTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": [
                "LogsBucketPolicy"
            ],
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${EnvironmentName}-tapstack-cloudtrail"
                },
                "S3BucketName": {
                    "Ref": "LogsBucket"
                },
                "S3KeyPrefix": "cloudtrail",
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "IsLogging": true,
                "KMSKeyId": {
                    "Ref": "KmsKey"
                }
            }
        }
    },
    "Outputs": {
        "Region": {
            "Description": "Deployment region (guarded to us-west-2)",
            "Value": {
                "Ref": "AWS::Region"
            }
        },
        "OwnerTagEcho": {
            "Description": "Echo of OwnerTag parameter to ensure it's in-use",
            "Value": {
                "Ref": "OwnerTag"
            }
        },
        "VpcId": {
            "Value": {
                "Ref": "VPC"
            }
        },
        "PrivateAppSubnets": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "AppSubnetA"
                        },
                        {
                            "Ref": "AppSubnetB"
                        }
                    ]
                ]
            }
        },
        "PrivateDbSubnets": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "DbSubnetA"
                        },
                        {
                            "Ref": "DbSubnetB"
                        }
                    ]
                ]
            }
        },
        "EgressSubnets": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "EgressSubnetA"
                        },
                        {
                            "Ref": "EgressSubnetB"
                        }
                    ]
                ]
            }
        },
        "NatGatewayIds": {
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "NatGwA"
                        },
                        {
                            "Ref": "NatGwB"
                        }
                    ]
                ]
            }
        },
        "InternetGatewayId": {
            "Value": {
                "Ref": "InternetGateway"
            }
        },
        "AlbDnsName": {
            "Value": {
                "Fn::GetAtt": [
                    "ALB",
                    "DNSName"
                ]
            }
        },
        "AppSecurityGroupId": {
            "Value": {
                "Ref": "WebSG"
            }
        },
        "DbSecurityGroupId": {
            "Value": {
                "Ref": "DbSG"
            }
        },
        "RdsEndpoint": {
            "Value": {
                "Fn::GetAtt": [
                    "DBInstance",
                    "Endpoint.Address"
                ]
            }
        },
        "RdsArn": {
            "Value": {
                "Ref": "DBInstance"
            }
        },
        "AppDataBucketName": {
            "Value": {
                "Ref": "AppDataBucket"
            }
        },
        "LogsBucketName": {
            "Value": {
                "Ref": "LogsBucket"
            }
        },
        "KmsKeyArn": {
            "Value": {
                "Fn::GetAtt": [
                    "KmsKey",
                    "Arn"
                ]
            }
        },
        "KmsAlias": {
            "Value": {
                "Ref": "KmsAlias"
            }
        },
        "ParameterPaths": {
            "Value": {
                "Ref": "AppSecretParamPath"
            }
        },
        "CloudTrailTrailArn": {
            "Value": {
                "Fn::GetAtt": [
                    "CloudTrailTrail",
                    "Arn"
                ]
            }
        }
    }
}
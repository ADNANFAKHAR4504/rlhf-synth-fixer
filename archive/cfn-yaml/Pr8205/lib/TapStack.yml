AWSTemplateFormatVersion: '2010-09-09'
Description: 'LocalStack compatible environment setup with VPC, EC2, RDS (optional), S3, and monitoring'

Parameters:
  EnableNATGateway:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable NAT Gateway (may have issues in LocalStack Community). Set to false for LocalStack Community.'

  EnableAutoScaling:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable Auto Scaling resources (may have issues in LocalStack Community). Set to false for LocalStack Community.'

  EnableRDS:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: 'Enable RDS resources (requires LocalStack Pro or AWS). Set to false for LocalStack Community.'

  EnvironmentSuffix:
    Type: String
    Description: 'Suffix for resource names to support multiple parallel deployments (e.g., PR number from CI/CD)'
    Default: "pr4056"
    AllowedPattern: '^[a-zA-Z0-9\-]*$'
    ConstraintDescription: 'Must contain only alphanumeric characters and hyphens'

  VpcCidrBlock:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: Must be a valid CIDR range of the form x.x.x.x/16-28

  PublicSubnet1CidrBlock:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR block for the first public subnet
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  PrivateSubnet1CidrBlock:
    Type: String
    Default: 10.0.10.0/24
    Description: CIDR block for the first private subnet
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  PrivateSubnet2CidrBlock:
    Type: String
    Default: 10.0.11.0/24
    Description: CIDR block for the second private subnet
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  DBInstanceClass:
    Type: String
    Default: db.t3.micro
    Description: The database instance type
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
      - db.t3.large
      - db.t3.xlarge
      - db.t3.2xlarge
    ConstraintDescription: Must be a valid RDS instance type

  DBMasterUsername:
    Type: String
    Default: admin
    Description: The database admin account username
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters

  DBMasterPassword:
    Type: String
    Default: AdminPassword123!
    Description: The database admin password
    NoEcho: true
    MinLength: 8

  EC2InstanceType:
    Type: String
    Default: t2.micro
    Description: EC2 instance type
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type

  LatestAmiId:
    Type: AWS::EC2::Image::Id
    Default: ami-12345678
    Description: AMI ID for EC2 instances (use a valid AMI for LocalStack)

Conditions:
  CreateNATGateway: !Equals [!Ref EnableNATGateway, 'true']
  CreateAutoScaling: !Equals [!Ref EnableAutoScaling, 'true']
  CreateRDSResources: !Equals [!Ref EnableRDS, 'true']

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidrBlock
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-vpc"

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-igw"

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnet 1
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref PublicSubnet1CidrBlock
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-public-subnet-1"

  # Private Subnet 1
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet1CidrBlock
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-private-subnet-1"

  # Private Subnet 2 (for RDS Multi-AZ)
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet2CidrBlock
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-private-subnet-2"

  # NAT Gateway (conditional - may have issues in LocalStack Community)
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Condition: CreateNATGateway
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-nat-eip"

  NatGateway:
    Type: AWS::EC2::NatGateway
    Condition: CreateNATGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-nat-gateway"

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-public-rt"

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  # Private Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-private-rt"

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Condition: CreateNATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  # Security Groups
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 instances - HTTPS only
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-ec2-sg"

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS instance
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EC2SecurityGroup
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-rds-sg"

  # S3 Bucket
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "localstack-${EnvironmentSuffix}-bucket"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-bucket"

  # CloudWatch Log Group
  CloudWatchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-log-group"
      RetentionInDays: 7

  # IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-ec2-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref S3ReadAccessPolicy
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-ec2-role"

  S3ReadAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-S3ReadAccess"
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:GetBucketLocation
              - s3:GetBucketVersioning
              - s3:GetObjectVersion
            Resource:
              - !GetAtt S3Bucket.Arn
              - !Sub "${S3Bucket.Arn}/*"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-ec2-profile"
      Roles:
        - !Ref EC2Role

  # KMS Key for RDS (conditional - requires LocalStack Pro or AWS)
  RDSKMSKey:
    Type: AWS::KMS::Key
    Condition: CreateRDSResources
    Properties:
      Description: KMS key for RDS encryption
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: kms:*
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-rds-kms-key"

  RDSKMSKeyAlias:
    Type: AWS::KMS::Alias
    Condition: CreateRDSResources
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-${EnvironmentSuffix}-rds-key"
      TargetKeyId: !Ref RDSKMSKey

  # RDS Subnet Group (conditional - requires LocalStack Pro or AWS)
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Condition: CreateRDSResources
    Properties:
      DBSubnetGroupName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-db-subnet-group"
      DBSubnetGroupDescription: Subnet group for RDS instance
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-db-subnet-group"

  # RDS Instance (conditional - requires LocalStack Pro or AWS)
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Condition: CreateRDSResources
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W1011  # Using parameter for password - required for LocalStack compatibility
    Properties:
      DBInstanceIdentifier: !Sub "${AWS::StackName}-${EnvironmentSuffix}-rds"
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: 20
      StorageType: gp2
      StorageEncrypted: true
      KmsKeyId: !Ref RDSKMSKey
      Engine: mysql
      EngineVersion: '8.0.39'
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      MultiAZ: false
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-rds"

  # Secrets Manager Secret (conditional - only created with RDS)
  RDSSecret:
    Type: AWS::SecretsManager::Secret
    Condition: CreateRDSResources
    Properties:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-rds-secret"
      Description: RDS master password
      SecretString: !Sub '{"username":"${DBMasterUsername}","password":"${DBMasterPassword}"}'

  # Launch Template (conditional - may have issues in LocalStack Community)
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: CreateAutoScaling
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-launch-template"
      LaunchTemplateData:
        ImageId: !Ref LatestAmiId
        InstanceType: !Ref EC2InstanceType
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-ec2-instance"

  # Auto Scaling Group (conditional - may have issues in LocalStack Community)
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: CreateAutoScaling
    Properties:
      AutoScalingGroupName: !Sub "${AWS::StackName}-${EnvironmentSuffix}-asg"
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: "$Latest"
      MinSize: 1
      MaxSize: 3
      DesiredCapacity: 1
      HealthCheckType: EC2
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-${EnvironmentSuffix}-asg-instance"
          PropagateAtLaunch: true

Outputs:
  # Networking Outputs
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-VPCId"

  VPCCidrBlock:
    Description: VPC CIDR Block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-VPCCidrBlock"

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-InternetGatewayId"

  NatGatewayId:
    Condition: CreateNATGateway
    Description: NAT Gateway ID
    Value: !Ref NatGateway
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-NatGatewayId"

  NatGatewayEIP:
    Condition: CreateNATGateway
    Description: NAT Gateway Elastic IP
    Value: !Ref NatGatewayEIP
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-NatGatewayEIP"

  # Subnet Outputs
  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-PublicSubnet1Id"

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-PrivateSubnet1Id"

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-PrivateSubnet2Id"

  # Security Group Outputs
  EC2SecurityGroupId:
    Description: EC2 Security Group ID
    Value: !Ref EC2SecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-EC2SecurityGroupId"

  RDSSecurityGroupId:
    Description: RDS Security Group ID
    Value: !Ref RDSSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSSecurityGroupId"

  # S3 Bucket Outputs
  S3BucketName:
    Description: S3 Bucket Name
    Value: !Ref S3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-S3BucketName"

  S3BucketArn:
    Description: S3 Bucket ARN
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-S3BucketArn"

  # RDS Outputs (conditional - only when EnableRDS is true)
  RDSInstanceId:
    Condition: CreateRDSResources
    Description: RDS Instance ID
    Value: !Ref RDSInstance
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSInstanceId"

  RDSEndpoint:
    Condition: CreateRDSResources
    Description: RDS Instance Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSEndpoint"

  RDSPort:
    Condition: CreateRDSResources
    Description: RDS Instance Port
    Value: !GetAtt RDSInstance.Endpoint.Port
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSPort"

  RDSConnectionString:
    Condition: CreateRDSResources
    Description: RDS Connection String (without password)
    Value: !Sub "mysql://${DBMasterUsername}@${RDSInstance.Endpoint.Address}:${RDSInstance.Endpoint.Port}"
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSConnectionString"

  RDSSecretArn:
    Condition: CreateRDSResources
    Description: RDS Secret ARN for password retrieval
    Value: !Ref RDSSecret
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSSecretArn"

  # KMS Outputs (conditional - only when EnableRDS is true)
  RDSKMSKeyId:
    Condition: CreateRDSResources
    Description: RDS KMS Key ID
    Value: !Ref RDSKMSKey
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSKMSKeyId"

  RDSKMSKeyArn:
    Condition: CreateRDSResources
    Description: RDS KMS Key ARN
    Value: !GetAtt RDSKMSKey.Arn
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-RDSKMSKeyArn"

  # IAM Outputs
  EC2RoleArn:
    Description: EC2 IAM Role ARN
    Value: !GetAtt EC2Role.Arn
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-EC2RoleArn"

  EC2InstanceProfileArn:
    Description: EC2 Instance Profile ARN
    Value: !GetAtt EC2InstanceProfile.Arn
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-EC2InstanceProfileArn"

  # EC2 and Auto Scaling Outputs (conditional - only when EnableAutoScaling is true)
  LaunchTemplateId:
    Condition: CreateAutoScaling
    Description: Launch Template ID
    Value: !Ref LaunchTemplate
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-LaunchTemplateId"

  AutoScalingGroupName:
    Condition: CreateAutoScaling
    Description: Auto Scaling Group Name
    Value: !Ref AutoScalingGroup
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-AutoScalingGroupName"

  # CloudWatch Outputs
  CloudWatchLogGroupName:
    Description: CloudWatch Log Group Name
    Value: !Ref CloudWatchLogGroup
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-CloudWatchLogGroupName"

  CloudWatchLogGroupArn:
    Description: CloudWatch Log Group ARN
    Value: !GetAtt CloudWatchLogGroup.Arn
    Export:
      Name: !Sub "${AWS::StackName}-${EnvironmentSuffix}-CloudWatchLogGroupArn"

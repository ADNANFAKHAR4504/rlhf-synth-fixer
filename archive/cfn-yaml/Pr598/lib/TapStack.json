{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Serverless application with Lambda, API Gateway, DynamoDB, and monitoring",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "AllowedValues": [
        "dev",
        "stage",
        "prod"
      ],
      "Default": "dev",
      "Description": "Environment name"
    },
    "LogLevel": {
      "Type": "String",
      "AllowedValues": [
        "INFO",
        "WARN",
        "ERROR"
      ],
      "Default": "INFO",
      "Description": "Log level for Lambda function"
    }
  },
  "Resources": {
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem"
                  ],
                  "Resource": {
                    "Fn::GetAtt": [
                      "DataTable",
                      "Arn"
                    ]
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:us-east-1:${AWS::AccountId}:log-group:/aws/lambda/${Environment}-data-processor:*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "LambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/lambda/${Environment}-data-processor"
        },
        "RetentionInDays": 14
      }
    },
    "DataProcessorFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "${Environment}-data-processor"
        },
        "Runtime": "python3.9",
        "Handler": "index.lambda_handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport os\nimport logging\nfrom datetime import datetime\nimport uuid\n\nlog_level = os.environ.get('LOG_LEVEL', 'INFO')\nlogger = logging.getLogger()\nlogger.setLevel(getattr(logging, log_level))\n\n# Ensure boto3 client uses the correct region from environment variable\ndynamodb = boto3.resource('dynamodb', region_name=os.environ.get('REGION'))\ntable_name = os.environ.get('TABLE_NAME')\ntable = dynamodb.Table(table_name)\n\ndef lambda_handler(event, context):\n    try:\n        logger.info(f\"Processing event: {json.dumps(event)}\")\n        \n        if 'body' in event:\n            body = json.loads(event['body']) if isinstance(event['body'], str) else event['body']\n        else:\n            body = event\n        \n        item = {\n            'id': str(uuid.uuid4()),\n            'timestamp': datetime.utcnow().isoformat(),\n            'data': body,\n            'environment': os.environ.get('STAGE', 'dev')\n        }\n        \n        table.put_item(Item=item)\n        \n        logger.info(f\"Successfully stored item with id: {item['id']}\")\n        \n        return {\n            'statusCode': 200,\n            'headers': {\n                'Content-Type': 'application/json'\n            },\n            'body': json.dumps({\n                'message': 'Data processed successfully',\n                'id': item['id']\n            })\n        }\n        \n    except Exception as e:\n        logger.error(f\"Error processing data: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': {\n                'Content-Type': 'application/json'\n            },\n            'body': json.dumps({\n                'error': 'Internal server error'\n            })\n        }\n"
        },
        "Environment": {
          "Variables": {
            "STAGE": {
              "Ref": "Environment"
            },
            "LOG_LEVEL": {
              "Ref": "LogLevel"
            },
            "TABLE_NAME": {
              "Ref": "DataTable"
            },
            "REGION": "us-east-1"
          }
        },
        "Timeout": 30,
        "MemorySize": 128
      }
    },
    "LambdaApiGatewayPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "DataProcessorFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "arn:aws:execute-api:us-east-1:${AWS::AccountId}:${DataApi}/*/*"
        }
      }
    },
    "DataApi": {
      "Type": "AWS::ApiGateway::RestApi",
      "Properties": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-data-api"
        },
        "Description": "REST API for data processing",
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL"
          ]
        }
      }
    },
    "DataResource": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "RestApiId": {
          "Ref": "DataApi"
        },
        "ParentId": {
          "Fn::GetAtt": [
            "DataApi",
            "RootResourceId"
          ]
        },
        "PathPart": "data"
      }
    },
    "DataMethod": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "RestApiId": {
          "Ref": "DataApi"
        },
        "ResourceId": {
          "Ref": "DataResource"
        },
        "HttpMethod": "POST",
        "AuthorizationType": "NONE",
        "Integration": {
          "Type": "AWS_PROXY",
          "IntegrationHttpMethod": "POST",
          "Uri": {
            "Fn::Sub": "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${DataProcessorFunction.Arn}/invocations"
          }
        },
        "MethodResponses": [
          {
            "StatusCode": 200,
            "ResponseModels": {
              "application/json": "Empty"
            }
          },
          {
            "StatusCode": 500,
            "ResponseModels": {
              "application/json": "Empty"
            }
          }
        ]
      }
    },
    "ApiDeployment": {
      "Type": "AWS::ApiGateway::Deployment",
      "DependsOn": "DataMethod",
      "Properties": {
        "RestApiId": {
          "Ref": "DataApi"
        },
        "StageName": {
          "Ref": "Environment"
        }
      }
    },
    "DataTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Sub": "${Environment}-data-table"
        },
        "BillingMode": "PROVISIONED",
        "AttributeDefinitions": [
          {
            "AttributeName": "id",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "id",
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 5,
          "WriteCapacityUnits": 5
        }
      }
    },
    "ApplicationAutoScalingDynamoDBRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "application-autoscaling.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
        ]
      }
    },
    "ReadCapacityScalableTarget": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": 20,
        "MinCapacity": 5,
        "ResourceId": {
          "Fn::Sub": "table/${DataTable}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "ApplicationAutoScalingDynamoDBRole",
            "Arn"
          ]
        },
        "ScalableDimension": "dynamodb:table:ReadCapacityUnits",
        "ServiceNamespace": "dynamodb"
      }
    },
    "WriteCapacityScalableTarget": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": 20,
        "MinCapacity": 5,
        "ResourceId": {
          "Fn::Sub": "table/${DataTable}"
        },
        "RoleARN": {
          "Fn::GetAtt": [
            "ApplicationAutoScalingDynamoDBRole",
            "Arn"
          ]
        },
        "ScalableDimension": "dynamodb:table:WriteCapacityUnits",
        "ServiceNamespace": "dynamodb"
      }
    },
    "ReadScalingPolicy": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": "ReadAutoScalingPolicy",
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "ReadCapacityScalableTarget"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "TargetValue": 70.0,
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60,
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "DynamoDBReadCapacityUtilization"
          }
        }
      }
    },
    "WriteScalingPolicy": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": "WriteAutoScalingPolicy",
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {
          "Ref": "WriteCapacityScalableTarget"
        },
        "TargetTrackingScalingPolicyConfiguration": {
          "TargetValue": 70.0,
          "ScaleInCooldown": 60,
          "ScaleOutCooldown": 60,
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "DynamoDBWriteCapacityUtilization"
          }
        }
      }
    },
    "LambdaErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${Environment}-lambda-error-rate-alarm"
        },
        "AlarmDescription": "Alarm when Lambda error rate exceeds 5% for 5 minutes",
        "ComparisonOperator": "GreaterThanThreshold",
        "EvaluationPeriods": 1,
        "Threshold": 5.0,
        "TreatMissingData": "notBreaching",
        "Metrics": [
          {
            "Id": "e1",
            "Expression": "(m1/m2)*100",
            "Label": "Error Rate (%)"
          },
          {
            "Id": "m1",
            "MetricStat": {
              "Metric": {
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Dimensions": [
                  {
                    "Name": "FunctionName",
                    "Value": {
                      "Ref": "DataProcessorFunction"
                    }
                  }
                ]
              },
              "Period": 300,
              "Stat": "Sum"
            },
            "ReturnData": false
          },
          {
            "Id": "m2",
            "MetricStat": {
              "Metric": {
                "MetricName": "Invocations",
                "Namespace": "AWS/Lambda",
                "Dimensions": [
                  {
                    "Name": "FunctionName",
                    "Value": {
                      "Ref": "DataProcessorFunction"
                    }
                  }
                ]
              },
              "Period": 300,
              "Stat": "Sum"
            },
            "ReturnData": false
          }
        ]
      }
    }
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "API Gateway endpoint URL",
      "Value": {
        "Fn::Sub": "https://${DataApi}.execute-api.us-east-1.amazonaws.com/${Environment}/data"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ApiEndpoint"
        }
      }
    },
    "LambdaFunctionArn": {
      "Description": "Lambda function ARN",
      "Value": {
        "Fn::GetAtt": [
          "DataProcessorFunction",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaArn"
        }
      }
    },
    "DynamoDBTableName": {
      "Description": "DynamoDB table name",
      "Value": {
        "Ref": "DataTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TableName"
        }
      }
    },
    "DynamoDBTableArn": {
      "Description": "DynamoDB table ARN",
      "Value": {
        "Fn::GetAtt": [
          "DataTable",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TableArn"
        }
      }
    }
  }
}

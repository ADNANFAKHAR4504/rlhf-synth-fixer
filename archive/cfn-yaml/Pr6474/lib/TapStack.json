{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure VPC Foundation for Fintech Payment Processing Platform - PCI DSS Compliant - Deployed in Europe (Spain) region",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Unique suffix for resource naming to prevent conflicts",
            "AllowedPattern": "[a-zA-Z0-9-]+",
            "ConstraintDescription": "Must contain only alphanumeric characters and hyphens"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.0.0.0/16",
            "Description": "CIDR block for the VPC",
            "AllowedPattern": "^10\\.([0-9]|[1-9][0-9]|[1-2][0-5][0-5])\\.0\\.0/16$",
            "ConstraintDescription": "Must be a /16 CIDR block from 10.0.0.0/8 range"
        },
        "ProjectName": {
            "Type": "String",
            "Default": "fintech-payment-platform",
            "Description": "Project name for tagging"
        },
        "EnvironmentName": {
            "Type": "String",
            "Default": "production",
            "Description": "Environment name for tagging",
            "AllowedValues": [
                "development",
                "staging",
                "production"
            ]
        },
        "CreateS3Endpoint": {
            "Type": "String",
            "Default": "false",
            "Description": "Whether to create S3 VPC Gateway Endpoint (may hit service limits)",
            "AllowedValues": [
                "true",
                "false"
            ]
        }
    },
    "Conditions": {
        "ShouldCreateS3Endpoint": {
            "Fn::Equals": [
                {
                    "Ref": "CreateS3Endpoint"
                },
                "true"
            ]
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix",
                        "EnvironmentName",
                        "ProjectName"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VpcCidr"
                    ]
                }
            ]
        },
        "Region": {
            "TargetRegion": "eu-south-1",
            "RegionName": "Europe (Milan)",
            "RegionFile": "lib/AWS_REGION"
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Region",
                        "Value": {
                            "Ref": "AWS::Region"
                        }
                    },
                    {
                        "Key": "TargetRegion",
                        "Value": "eu-south-1"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "igw-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "VPCGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PublicSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-3-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        3,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Private"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        4,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Private"
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": {
                    "Fn::Select": [
                        5,
                        {
                            "Fn::Cidr": [
                                {
                                    "Ref": "VpcCidr"
                                },
                                6,
                                8
                            ]
                        }
                    ]
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-3-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "Tier",
                        "Value": "Private"
                    }
                ]
            }
        },
        "NatGateway1EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "VPCGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-eip-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "NatGateway2EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "VPCGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-eip-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "NatGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway1EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-gateway-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "NatGateway2": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway2EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-gateway-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-rt-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "VPCGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-rt-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway1"
                }
            }
        },
        "PrivateRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-rt-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PrivateRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway2"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                }
            }
        },
        "PrivateSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                }
            }
        },
        "PublicNetworkAcl": {
            "Type": "AWS::EC2::NetworkAcl",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-nacl-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PublicNetworkAclEntryDenyMalicious1": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                },
                "RuleNumber": 10,
                "Protocol": -1,
                "RuleAction": "deny",
                "CidrBlock": "198.18.0.0/15"
            }
        },
        "PublicNetworkAclEntryDenyMalicious2": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                },
                "RuleNumber": 20,
                "Protocol": -1,
                "RuleAction": "deny",
                "CidrBlock": "192.0.2.0/24"
            }
        },
        "PublicNetworkAclEntryInboundAllow": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "RuleAction": "allow",
                "CidrBlock": "0.0.0.0/0"
            }
        },
        "PublicNetworkAclEntryOutboundAllow": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "Egress": true,
                "RuleAction": "allow",
                "CidrBlock": "0.0.0.0/0"
            }
        },
        "PublicSubnet1NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                }
            }
        },
        "PublicSubnet2NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                }
            }
        },
        "PublicSubnet3NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                },
                "NetworkAclId": {
                    "Ref": "PublicNetworkAcl"
                }
            }
        },
        "PrivateNetworkAcl": {
            "Type": "AWS::EC2::NetworkAcl",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-nacl-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "PrivateNetworkAclEntryDenyMalicious1": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                },
                "RuleNumber": 10,
                "Protocol": -1,
                "RuleAction": "deny",
                "CidrBlock": "198.18.0.0/15"
            }
        },
        "PrivateNetworkAclEntryDenyMalicious2": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                },
                "RuleNumber": 20,
                "Protocol": -1,
                "RuleAction": "deny",
                "CidrBlock": "192.0.2.0/24"
            }
        },
        "PrivateNetworkAclEntryInboundAllow": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "RuleAction": "allow",
                "CidrBlock": "0.0.0.0/0"
            }
        },
        "PrivateNetworkAclEntryOutboundAllow": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                },
                "RuleNumber": 100,
                "Protocol": -1,
                "Egress": true,
                "RuleAction": "allow",
                "CidrBlock": "0.0.0.0/0"
            }
        },
        "PrivateSubnet1NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                }
            }
        },
        "PrivateSubnet2NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                }
            }
        },
        "PrivateSubnet3NetworkAclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                },
                "NetworkAclId": {
                    "Ref": "PrivateNetworkAcl"
                }
            }
        },
        "FlowLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "vpc-flow-logs-${AWS::Region}-${EnvironmentSuffix}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                }
                            ]
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 90,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        },
                        {
                            "Id": "ExpireOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 365
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-flow-logs-${AWS::Region}-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "FlowLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "FlowLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSLogDeliveryWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "delivery.logs.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${FlowLogsBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "AWSLogDeliveryAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "delivery.logs.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "FlowLogsBucket",
                                    "Arn"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        "EmptyS3BucketLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "EmptyS3BucketPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket",
                                        "s3:ListBucketVersions"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "FlowLogsBucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:DeleteObject",
                                        "s3:DeleteObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${FlowLogsBucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "empty-s3-bucket-lambda-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    }
                ]
            }
        },
        "EmptyS3BucketLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "empty-flow-logs-bucket-${EnvironmentSuffix}"
                },
                "Runtime": "python3.11",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "EmptyS3BucketLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "Code": {
                    "ZipFile": "import boto3\nimport cfnresponse\n\ndef handler(event, context):\n    try:\n        s3 = boto3.resource('s3')\n        \n        if event['RequestType'] == 'Delete':\n            bucket_name = event['ResourceProperties']['BucketName']\n            bucket = s3.Bucket(bucket_name)\n            \n            # Delete all objects and versions\n            bucket.object_versions.delete()\n            \n            print(f'Successfully emptied bucket: {bucket_name}')\n        \n        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n    except Exception as e:\n        print(f'Error: {str(e)}')\n        cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "empty-flow-logs-bucket-lambda-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    }
                ]
            }
        },
        "EmptyFlowLogsBucket": {
            "Type": "Custom::EmptyS3Bucket",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "EmptyS3BucketLambda",
                        "Arn"
                    ]
                },
                "BucketName": {
                    "Ref": "FlowLogsBucket"
                }
            }
        },
        "VPCFlowLog": {
            "Type": "AWS::EC2::FlowLog",
            "DependsOn": "FlowLogsBucketPolicy",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VPC"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "s3",
                "LogDestination": {
                    "Fn::GetAtt": [
                        "FlowLogsBucket",
                        "Arn"
                    ]
                },
                "LogFormat": "${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-flow-log-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    }
                ]
            }
        },
        "S3VPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "ShouldCreateS3Endpoint",
            "Properties": {
                "VpcEndpointType": "Gateway",
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "RouteTableIds": [
                    {
                        "Ref": "PublicRouteTable"
                    },
                    {
                        "Ref": "PrivateRouteTable1"
                    },
                    {
                        "Ref": "PrivateRouteTable2"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": [
                                "s3:GetObject",
                                "s3:PutObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${ProjectName}-*/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${ProjectName}-*"
                                }
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": [
                                "s3:GetObject"
                            ],
                            "Resource": [
                                "arn:aws:s3:::amazonlinux.*.amazonaws.com/*",
                                "arn:aws:s3:::amazonlinux-2-repos-*/*"
                            ]
                        }
                    ]
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "VPCCidr": {
            "Description": "VPC CIDR Block",
            "Value": {
                "Fn::GetAtt": [
                    "VPC",
                    "CidrBlock"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCCidr"
                }
            }
        },
        "PublicSubnets": {
            "Description": "Comma-delimited list of public subnet IDs",
            "Value": {
                "Fn::Sub": "${PublicSubnet1},${PublicSubnet2},${PublicSubnet3}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnets"
                }
            }
        },
        "PublicSubnet1Id": {
            "Description": "Public Subnet 1 ID",
            "Value": {
                "Ref": "PublicSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet1"
                }
            }
        },
        "PublicSubnet2Id": {
            "Description": "Public Subnet 2 ID",
            "Value": {
                "Ref": "PublicSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet2"
                }
            }
        },
        "PublicSubnet3Id": {
            "Description": "Public Subnet 3 ID",
            "Value": {
                "Ref": "PublicSubnet3"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnet3"
                }
            }
        },
        "PrivateSubnets": {
            "Description": "Comma-delimited list of private subnet IDs",
            "Value": {
                "Fn::Sub": "${PrivateSubnet1},${PrivateSubnet2},${PrivateSubnet3}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnets"
                }
            }
        },
        "PrivateSubnet1Id": {
            "Description": "Private Subnet 1 ID",
            "Value": {
                "Ref": "PrivateSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2Id": {
            "Description": "Private Subnet 2 ID",
            "Value": {
                "Ref": "PrivateSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet2"
                }
            }
        },
        "PrivateSubnet3Id": {
            "Description": "Private Subnet 3 ID",
            "Value": {
                "Ref": "PrivateSubnet3"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnet3"
                }
            }
        },
        "InternetGatewayId": {
            "Description": "Internet Gateway ID",
            "Value": {
                "Ref": "InternetGateway"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-InternetGateway"
                }
            }
        },
        "NatGateway1Id": {
            "Description": "NAT Gateway 1 ID",
            "Value": {
                "Ref": "NatGateway1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NatGateway1"
                }
            }
        },
        "NatGateway2Id": {
            "Description": "NAT Gateway 2 ID",
            "Value": {
                "Ref": "NatGateway2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NatGateway2"
                }
            }
        },
        "FlowLogsBucketName": {
            "Description": "VPC Flow Logs S3 Bucket Name",
            "Value": {
                "Ref": "FlowLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FlowLogsBucket"
                }
            }
        },
        "S3VPCEndpointId": {
            "Description": "S3 VPC Endpoint ID (if created)",
            "Condition": "ShouldCreateS3Endpoint",
            "Value": {
                "Ref": "S3VPCEndpoint"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3VPCEndpoint"
                }
            }
        },
        "AvailabilityZones": {
            "Description": "Availability Zones used",
            "Value": {
                "Fn::Sub": "${PublicSubnet1.AvailabilityZone},${PublicSubnet2.AvailabilityZone},${PublicSubnet3.AvailabilityZone}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AvailabilityZones"
                }
            }
        }
    }
}
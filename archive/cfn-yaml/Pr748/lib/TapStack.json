{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure Lambda infrastructure with S3 log export",
    "Parameters": {
        "VpcId": {
            "Type": "String",
            "Default": "vpc-002dd1e7eb944d35a",
            "Description": "Pre-existing VPC ID",
            "AllowedPattern": "^vpc-[0-9a-f]{8,17}$"
        },
        "S3BucketName": {
            "Type": "String",
            "Default": "lambda-deployments-718240086340",
            "Description": "S3 bucket for log storage",
            "AllowedPattern": "^[a-z0-9][a-z0-9-]*[a-z0-9]$",
            "MinLength": 3,
            "MaxLength": 63
        },
        "LambdaFunctionName": {
            "Type": "String",
            "Default": "SecureLambdaFunction",
            "Description": "Lambda function name",
            "AllowedPattern": "^[a-zA-Z0-9-_]+$",
            "MinLength": 1,
            "MaxLength": 64
        },
        "SubnetIds": {
            "Type": "CommaDelimitedList",
            "Description": "Private subnet IDs for Lambda",
            "Default": ""
        },
        "Environment": {
            "Type": "String",
            "Default": "Development",
            "AllowedValues": [
                "Development",
                "Staging",
                "Production"
            ]
        }
    },
    "Conditions": {
        "HasSubnetIds": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Fn::Join": [
                                "",
                                {
                                    "Ref": "SubnetIds"
                                }
                            ]
                        },
                        ""
                    ]
                }
            ]
        },
        "BucketExists": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "S3BucketName"
                        },
                        ""
                    ]
                }
            ]
        }
    },
    "Resources": {
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${LambdaFunctionName}"
                },
                "RetentionInDays": 14
            }
        },
        "VPCFlowLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/vpc/flowlogs/${VpcId}"
                },
                "RetentionInDays": 14
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "aws:RequestedRegion": "us-east-1"
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "LambdaLoggingPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${LambdaLogGroup.Arn}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:PutObjectAcl"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::${S3BucketName}/lambda-logs/${LambdaFunctionName}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:GetBucketLocation",
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::${S3BucketName}"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "VPCFlowLogRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "FlowLogDeliveryPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${VPCFlowLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda function",
                "VpcId": {
                    "Ref": "VpcId"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS for AWS API calls"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 53,
                        "ToPort": 53,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "DNS TCP"
                    },
                    {
                        "IpProtocol": "udp",
                        "FromPort": 53,
                        "ToPort": 53,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "DNS UDP"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${LambdaFunctionName}-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": "LambdaLogGroup",
            "Properties": {
                "FunctionName": {
                    "Ref": "LambdaFunctionName"
                },
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 30,
                "MemorySize": 256,
                "Code": {
                    "ZipFile": "import json\nimport logging\nfrom datetime import datetime\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef lambda_handler(event, context):\n    logger.info({\n        'event_type': 'lambda_invocation',\n        'request_id': context.aws_request_id,\n        'function_name': context.function_name,\n        'timestamp': datetime.utcnow().isoformat()\n    })\n    \n    try:\n        sanitized_event = {k: v for k, v in event.items() if k not in ['password', 'token', 'secret']}\n        logger.info(f\"Processing event: {json.dumps(sanitized_event)}\")\n        \n        result = {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Function executed successfully',\n                'request_id': context.aws_request_id,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n        \n        logger.info({\n            'event_type': 'lambda_success',\n            'request_id': context.aws_request_id,\n            'status_code': result['statusCode']\n        })\n        \n        return result\n        \n    except Exception as e:\n        logger.error({\n            'event_type': 'lambda_error',\n            'request_id': context.aws_request_id,\n            'error_type': type(e).__name__,\n            'error_message': str(e),\n            'timestamp': datetime.utcnow().isoformat()\n        })\n        \n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': 'Internal server error',\n                'request_id': context.aws_request_id\n            })\n        }\n"
                },
                "VpcConfig": {
                    "Fn::If": [
                        "HasSubnetIds",
                        {
                            "SecurityGroupIds": [
                                {
                                    "Ref": "LambdaSecurityGroup"
                                }
                            ],
                            "SubnetIds": {
                                "Ref": "SubnetIds"
                            }
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "LOG_LEVEL": "INFO",
                        "S3_BUCKET": {
                            "Ref": "S3BucketName"
                        },
                        "ENVIRONMENT": {
                            "Ref": "Environment"
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "SecurityCompliance",
                        "Value": "Required"
                    }
                ]
            }
        },
        "LogExportLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${LambdaFunctionName}-log-exporter"
                },
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LogExportLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "MemorySize": 512,
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport logging\nfrom datetime import datetime, timedelta\nimport time\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef lambda_handler(event, context):\n    logs_client = boto3.client('logs')\n    \n    try:\n        log_group_name = event.get('log_group_name', f\"/aws/lambda/{context.function_name.replace('-log-exporter', '')}\")\n        s3_bucket = event.get('s3_bucket', 'lambda-deployments-718240086340')\n        \n        logger.info(f\"Starting log export for log group: {log_group_name}\")\n        \n        end_time = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)\n        start_time = end_time - timedelta(days=1)\n        \n        start_time_ms = int(start_time.timestamp() * 1000)\n        end_time_ms = int(end_time.timestamp() * 1000)\n        \n        s3_prefix = f\"lambda-logs/{context.function_name.replace('-log-exporter', '')}/{start_time.strftime('%Y/%m/%d')}\"\n        \n        response = logs_client.create_export_task(\n            logGroupName=log_group_name,\n            fromTime=start_time_ms,\n            to=end_time_ms,\n            destination=s3_bucket,\n            destinationPrefix=s3_prefix,\n            taskName=f\"export-{context.function_name}-{int(time.time())}\"\n        )\n        \n        task_id = response['taskId']\n        logger.info(f\"Created export task: {task_id}\")\n        \n        max_wait_time = 240\n        wait_interval = 10\n        elapsed_time = 0\n        \n        while elapsed_time < max_wait_time:\n            task_status = logs_client.describe_export_tasks(taskId=task_id)\n            status = task_status['exportTasks'][0]['status']['code']\n            \n            logger.info(f\"Export task status: {status}\")\n            \n            if status == 'COMPLETED':\n                logger.info(f\"Export completed successfully to s3://{s3_bucket}/{s3_prefix}\")\n                return {\n                    'statusCode': 200,\n                    'body': json.dumps({\n                        'message': 'Log export completed successfully',\n                        'taskId': task_id,\n                        's3Location': f\"s3://{s3_bucket}/{s3_prefix}\"\n                    })\n                }\n            elif status in ['CANCELLED', 'FAILED']:\n                error_msg = task_status['exportTasks'][0]['status'].get('message', 'Export failed')\n                logger.error(f\"Export task failed: {error_msg}\")\n                raise Exception(f\"Export task failed: {error_msg}\")\n            \n            time.sleep(wait_interval)\n            elapsed_time += wait_interval\n        \n        logger.warning(f\"Export task {task_id} still running after {max_wait_time} seconds\")\n        return {\n            'statusCode': 202,\n            'body': json.dumps({\n                'message': 'Export task initiated, still in progress',\n                'taskId': task_id\n            })\n        }\n        \n    except Exception as e:\n        logger.error(f\"Error during log export: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': str(e),\n                'request_id': context.aws_request_id\n            })\n        }\n"
                },
                "Environment": {
                    "Variables": {
                        "LOG_LEVEL": "INFO"
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "LogExport"
                    }
                ]
            }
        },
        "LogExportLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "aws:RequestedRegion": "us-east-1"
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "LogExportPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateExportTask",
                                        "logs:DescribeExportTasks",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "${LambdaLogGroup.Arn}"
                                        },
                                        {
                                            "Fn::Sub": "${LambdaLogGroup.Arn}:*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:GetBucketAcl",
                                        "s3:GetBucketLocation",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${S3BucketName}"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${S3BucketName}/lambda-logs/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "LogExportScheduleRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Description": "Daily schedule to export Lambda logs to S3",
                "ScheduleExpression": "cron(0 1 * * ? *)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "LogExportLambda",
                                "Arn"
                            ]
                        },
                        "Id": "LogExportTarget",
                        "Input": {
                            "Fn::Sub": "{\n  \"log_group_name\": \"/aws/lambda/${LambdaFunctionName}\",\n  \"s3_bucket\": \"${S3BucketName}\"\n}\n"
                        }
                    }
                ]
            }
        },
        "VPCFlowLogs": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VpcId"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "cloud-watch-logs",
                "LogDestination": {
                    "Fn::GetAtt": [
                        "VPCFlowLogGroup",
                        "Arn"
                    ]
                },
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "VPCFlowLogRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${LambdaFunctionName}-vpc-flow-logs"
                        }
                    }
                ]
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Alert on Lambda function errors",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "LambdaFunction"
                        }
                    }
                ]
            }
        },
        "LogExportLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "LogExportLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "LogExportScheduleRule",
                        "Arn"
                    ]
                }
            }
        },
        "LogExportLambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${LambdaFunctionName}-log-exporter"
                },
                "RetentionInDays": 7
            }
        },
        "S3BucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "BucketExists",
            "Properties": {
                "Bucket": {
                    "Ref": "S3BucketName"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudWatchLogsExport",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${S3BucketName}/lambda-logs/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "AllowCloudWatchLogsGetBucketAcl",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::Sub": "arn:aws:s3:::${S3BucketName}"
                            }
                        },
                        {
                            "Sid": "AllowLogExportLambda",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::GetAtt": [
                                        "LogExportLambdaRole",
                                        "Arn"
                                    ]
                                }
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:GetBucketLocation",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${S3BucketName}"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${S3BucketName}/lambda-logs/*"
                                }
                            ]
                        }
                    ]
                }
            }
        }
    },
    "Outputs": {
        "LambdaFunctionArn": {
            "Description": "ARN of the created Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-lambda-function-arn"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the created Lambda function",
            "Value": {
                "Ref": "LambdaFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-lambda-function-name"
                }
            }
        },
        "LogGroupName": {
            "Description": "CloudWatch Log Group name for the Lambda function",
            "Value": {
                "Ref": "LambdaLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-log-group-name"
                }
            }
        },
        "SecurityGroupId": {
            "Description": "Security Group ID for the Lambda function",
            "Value": {
                "Ref": "LambdaSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-security-group-id"
                }
            }
        },
        "LogExportLambdaArn": {
            "Description": "ARN of the log export Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "LogExportLambda",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-log-export-lambda-arn"
                }
            }
        },
        "IAMRoleArn": {
            "Description": "IAM Role ARN for the Lambda execution",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaExecutionRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-execution-role-arn"
                }
            }
        }
    }
}
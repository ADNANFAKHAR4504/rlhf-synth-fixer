Create a CloudFormation YAML template that deploys a secure CI/CD pipeline for a containerized payment service in the us-east-1 region. The pipeline should include four stages: Source, Build, Test, and Deploy. Configure the Source stage to pull code from a CodeCommit repository named payment-service. The Build stage must use a CodeBuild project running security scans and unit tests within an isolated VPC without internet access. The Test stage should run integration tests using a separate CodeBuild project connected to a staging database. Implement the Deploy stage using CodeDeploy for blue-green deployment to an ECS Fargate cluster, with a 15-minute traffic shifting strategy to minimize downtime. Create IAM roles for each service with least privilege permissions and explicit deny statements for sensitive production resources. Configure an S3 bucket for storing pipeline artifacts, ensuring KMS encryption and lifecycle policies for data retention. Enable CloudWatch Logs for all CodeBuild projects with a 30-day retention period and use EventBridge rules to monitor pipeline state changes and failures, triggering Slack notifications when necessary. Tag all resources with Environment, Team, and CostCenter identifiers. The final CloudFormation YAML template should provision a fully automated, secure, and auditable CI/CD pipeline that enforces compliance and operational best practices.

{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Serverless Event-Driven Inventory Processing System",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource naming",
            "AllowedPattern": "^[a-zA-Z0-9]+$"
        }
    },
    "Resources": {
        "InventoryBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "inventory-uploads-${EnvironmentSuffix}-${AWS::AccountId}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "NotificationConfiguration": {
                    "EventBridgeConfiguration": {
                        "EventBridgeEnabled": true
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "InventoryProcessing"
                    }
                ]
            }
        },
        "InventoryTable": {
            "Type": "AWS::DynamoDB::Table",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "InventoryData-${EnvironmentSuffix}"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "itemId",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "timestamp",
                        "AttributeType": "N"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "itemId",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "StreamSpecification": {
                    "StreamViewType": "NEW_AND_OLD_IMAGES"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "InventoryLambdaRole-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "InventoryProcessingPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "InventoryBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${InventoryBucket.Arn}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:GetItem",
                                        "dynamodb:Query",
                                        "dynamodb:BatchWriteItem"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "InventoryTable",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "cloudwatch:namespace": "InventoryProcessing"
                                        }
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "events:PutEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:events:${AWS::Region}:${AWS::AccountId}:event-bus/default"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "InventoryProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "InventoryProcessor-${EnvironmentSuffix}"
                },
                "Runtime": "python3.10",
                "Handler": "index.lambda_handler",
                "Timeout": 60,
                "MemorySize": 512,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DYNAMODB_TABLE": {
                            "Ref": "InventoryTable"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport time\nfrom datetime import datetime\nfrom decimal import Decimal\n\ns3 = boto3.client('s3')\ndynamodb = boto3.resource('dynamodb')\ncloudwatch = boto3.client('cloudwatch')\neventbridge = boto3.client('events')\n\ntable_name = os.environ['DYNAMODB_TABLE']\nenvironment = os.environ['ENVIRONMENT']\ntable = dynamodb.Table(table_name)\n\ndef lambda_handler(event, context):\n    start_time = time.time()\n    items_processed = 0\n    errors = 0\n\n    try:\n        # Process S3 event\n        for record in event.get('Records', [event]):\n            if 'detail' in record:  # EventBridge event\n                bucket = record['detail']['bucket']['name']\n                key = record['detail']['object']['key']\n            elif 's3' in record:  # Direct S3 event\n                bucket = record['s3']['bucket']['name']\n                key = record['s3']['object']['key']\n            else:\n                continue\n\n            if not key.endswith('.json'):\n                continue\n\n            try:\n                # Get object from S3\n                response = s3.get_object(Bucket=bucket, Key=key)\n                content = json.loads(response['Body'].read())\n\n                # Process inventory items\n                if isinstance(content, list):\n                    items = content\n                else:\n                    items = [content]\n\n                for item in items:\n                    try:\n                        # Convert floats to Decimal for DynamoDB\n                        item_data = json.loads(json.dumps(item), parse_float=Decimal)\n                        item_data['timestamp'] = int(datetime.now().timestamp() * 1000)\n                        item_data['lastUpdated'] = datetime.now().isoformat()\n                        item_data['source'] = f's3://{bucket}/{key}'\n\n                        # Update DynamoDB\n                        table.put_item(Item=item_data)\n                        items_processed += 1\n                    except Exception as e:\n                        print(f\"Error processing item: {e}\")\n                        errors += 1\n\n            except Exception as e:\n                print(f\"Error processing file {key}: {e}\")\n                errors += 1\n\n        # Send metrics to CloudWatch\n        processing_time = time.time() - start_time\n        send_metrics(items_processed, errors, processing_time)\n\n        # Send completion event to EventBridge\n        send_completion_event(items_processed, errors)\n\n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'itemsProcessed': items_processed,\n                'errors': errors,\n                'processingTime': processing_time\n            })\n        }\n\n    except Exception as e:\n        print(f\"Fatal error: {e}\")\n        send_metrics(0, 1, time.time() - start_time)\n        raise\n\ndef send_metrics(items_processed, errors, processing_time):\n    try:\n        cloudwatch.put_metric_data(\n            Namespace='InventoryProcessing',\n            MetricData=[\n                {\n                    'MetricName': 'ItemsProcessed',\n                    'Value': items_processed,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                },\n                {\n                    'MetricName': 'ProcessingErrors',\n                    'Value': errors,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                },\n                {\n                    'MetricName': 'ProcessingDuration',\n                    'Value': processing_time,\n                    'Unit': 'Seconds',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': environment}\n                    ]\n                }\n            ]\n        )\n    except Exception as e:\n        print(f\"Error sending metrics: {e}\")\n\ndef send_completion_event(items_processed, errors):\n    try:\n        eventbridge.put_events(\n            Entries=[\n                {\n                    'Source': 'inventory.processor',\n                    'DetailType': 'Inventory Processing Complete',\n                    'Detail': json.dumps({\n                        'itemsProcessed': items_processed,\n                        'errors': errors,\n                        'timestamp': datetime.now().isoformat()\n                    })\n                }\n            ]\n        )\n    except Exception as e:\n        print(f\"Error sending completion event: {e}\")\n"
                }
            }
        },
        "S3UploadEventRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "InventoryS3Upload-${EnvironmentSuffix}"
                },
                "Description": "Trigger Lambda on S3 inventory uploads",
                "EventPattern": {
                    "source": [
                        "aws.s3"
                    ],
                    "detail-type": [
                        "Object Created"
                    ],
                    "detail": {
                        "bucket": {
                            "name": [
                                {
                                    "Ref": "InventoryBucket"
                                }
                            ]
                        }
                    }
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "InventoryProcessorFunction",
                                "Arn"
                            ]
                        },
                        "Id": "InventoryProcessorTarget",
                        "RetryPolicy": {
                            "MaximumRetryAttempts": 2
                        }
                    }
                ]
            }
        },
        "LambdaEventBridgePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "InventoryProcessorFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "S3UploadEventRule",
                        "Arn"
                    ]
                }
            }
        },
        "ReportSchedulerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "scheduler.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "InvokeLambdaPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "lambda:InvokeFunction"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "InventoryProcessorFunction",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "InventoryProcessor-Errors-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alert when Lambda errors exceed threshold",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "InventoryProcessorFunction"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaDurationAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "InventoryProcessor-Duration-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alert when Lambda duration is anomalous",
                "MetricName": "Duration",
                "Namespace": "AWS/Lambda",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "InventoryProcessorFunction"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 30000,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBThrottleAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "InventoryTable-Throttles-${EnvironmentSuffix}"
                },
                "AlarmDescription": "Alert on DynamoDB throttling",
                "MetricName": "UserErrors",
                "Namespace": "AWS/DynamoDB",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "InventoryTable"
                        }
                    }
                ],
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 10,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching"
            }
        },
        "WebhookConnection": {
            "Type": "AWS::Events::Connection",
            "Properties": {
                "Name": {
                    "Fn::Sub": "InventoryWebhook-${EnvironmentSuffix}"
                },
                "AuthorizationType": "API_KEY",
                "AuthParameters": {
                    "ApiKeyAuthParameters": {
                        "ApiKeyName": "x-api-key",
                        "ApiKeyValue": "placeholder-api-key"
                    }
                }
            }
        },
        "WebhookDestination": {
            "Type": "AWS::Events::ApiDestination",
            "Properties": {
                "Name": {
                    "Fn::Sub": "InventoryWebhookDest-${EnvironmentSuffix}"
                },
                "ConnectionArn": {
                    "Fn::GetAtt": [
                        "WebhookConnection",
                        "Arn"
                    ]
                },
                "InvocationEndpoint": "https://webhook.site/unique-endpoint",
                "HttpMethod": "POST",
                "InvocationRateLimitPerSecond": 10
            }
        },
        "WebhookEventRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": {
                    "Fn::Sub": "InventoryComplete-${EnvironmentSuffix}"
                },
                "Description": "Send webhook on inventory processing completion",
                "EventPattern": {
                    "source": [
                        "inventory.processor"
                    ],
                    "detail-type": [
                        "Inventory Processing Complete"
                    ]
                },
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "WebhookDestination",
                                "Arn"
                            ]
                        },
                        "Id": "WebhookTarget",
                        "RoleArn": {
                            "Fn::GetAtt": [
                                "WebhookRole",
                                "Arn"
                            ]
                        },
                        "HttpParameters": {
                            "HeaderParameters": {
                                "X-Environment": {
                                    "Ref": "EnvironmentSuffix"
                                }
                            }
                        }
                    }
                ]
            }
        },
        "WebhookRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "events.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "InvokeApiDestinationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "events:InvokeApiDestination"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "WebhookDestination",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "BucketName": {
            "Description": "S3 Bucket for inventory uploads",
            "Value": {
                "Ref": "InventoryBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BucketName"
                }
            }
        },
        "TableName": {
            "Description": "DynamoDB table name",
            "Value": {
                "Ref": "InventoryTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TableName"
                }
            }
        },
        "FunctionArn": {
            "Description": "Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "InventoryProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-FunctionArn"
                }
            }
        },
        "EventRuleArn": {
            "Description": "EventBridge rule ARN",
            "Value": {
                "Fn::GetAtt": [
                    "S3UploadEventRule",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EventRuleArn"
                }
            }
        }
    }
}
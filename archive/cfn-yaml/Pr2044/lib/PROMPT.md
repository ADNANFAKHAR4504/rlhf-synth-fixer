I need you to generate a YAML-based AWS CloudFormation template that provisions a secure infrastructure environment with the following requirements and constraints. All S3 buckets created by this template must have versioning enabled to ensure durability and recovery from accidental overwrites or deletions. The template must create IAM roles required by the infrastructure without using wildcard permissions for either actions or resources, granting only the exact and necessary least privilege permissions required. A VPC must be configured with at least two public and two private subnets across different Availability Zones for high availability. A NAT Gateway must be provisioned in a public subnet, and private subnets must route outbound internet traffic securely through the NAT Gateway. The design must include the proper Internet Gateway, Route Tables, and Associations.

The output must be a valid CloudFormation YAML template file that can be deployed without errors and that meets all the constraints. It should also include parameters and outputs for reusability such as VPC ID, Subnet IDs, NAT Gateway ID, and S3 bucket names.

Every S3 bucket must have versioning enabled, IAM roles must follow least privilege with no wildcards, and the NAT Gateway must be configured for private subnetsâ€™ internet access. Please produce the CloudFormation template in YAML format only, with no pseudocode or partial code.
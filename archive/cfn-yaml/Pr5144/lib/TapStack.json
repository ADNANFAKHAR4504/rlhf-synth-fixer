{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "PCI-DSS compliant database infrastructure for financial transaction processing",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Unique suffix for resource naming to ensure uniqueness across environments",
            "Default": "prod",
            "AllowedPattern": "^[a-z0-9-]+$",
            "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
        },
        "DBName": {
            "Type": "String",
            "Description": "Database name for RDS MySQL instance",
            "Default": "transactions",
            "MinLength": 1,
            "MaxLength": 64,
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9]*$"
        },
        "DBInstanceClass": {
            "Type": "String",
            "Description": "RDS instance class",
            "Default": "db.t3.medium",
            "AllowedValues": [
                "db.t3.small",
                "db.t3.medium",
                "db.t3.large",
                "db.r5.large",
                "db.r5.xlarge"
            ]
        },
        "CacheNodeType": {
            "Type": "String",
            "Description": "ElastiCache node type",
            "Default": "cache.t3.medium",
            "AllowedValues": [
                "cache.t3.micro",
                "cache.t3.small",
                "cache.t3.medium",
                "cache.r5.large"
            ]
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "igw-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.10.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.11.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-subnet-2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "public-rt-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "AttachGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "private-rt-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                }
            }
        },
        "RDSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "rds-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for RDS MySQL instance",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "ApplicationSecurityGroup"
                        },
                        "Description": "Allow MySQL access from application tier"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "ElastiCacheSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "elasticache-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for ElastiCache Redis cluster",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 6379,
                        "ToPort": 6379,
                        "SourceSecurityGroupId": {
                            "Ref": "ApplicationSecurityGroup"
                        },
                        "Description": "Allow Redis access from application tier"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "elasticache-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "ApplicationSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "app-sg-${EnvironmentSuffix}"
                },
                "GroupDescription": "Security group for application tier",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS from internet"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "app-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DBSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "rds-credentials-${EnvironmentSuffix}"
                },
                "Description": "RDS MySQL master credentials for transaction database",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"dbadmin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\",
                    "RequireEachIncludedType": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-credentials-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "SecretRotationSchedule": {
            "Type": "AWS::SecretsManager::RotationSchedule",
            "DependsOn": "DBInstance",
            "Properties": {
                "SecretId": {
                    "Ref": "DBSecret"
                },
                "RotationLambdaARN": {
                    "Fn::GetAtt": [
                        "RotationLambdaFunction",
                        "Arn"
                    ]
                },
                "RotationRules": {
                    "AutomaticallyAfterDays": 30
                }
            }
        },
        "RotationLambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretsManagerRotationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:PutSecretValue",
                                        "secretsmanager:UpdateSecretVersionStage"
                                    ],
                                    "Resource": {
                                        "Ref": "DBSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetRandomPassword"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rotation-lambda-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "RotationLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "rds-rotation-${EnvironmentSuffix}"
                },
                "Description": "Lambda function to rotate RDS credentials",
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "RotationLambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 30,
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "ApplicationSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        }
                    ]
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport pymysql\nimport os\n\ndef lambda_handler(event, context):\n    service_client = boto3.client('secretsmanager')\n    arn = event['SecretId']\n    token = event['ClientRequestToken']\n    step = event['Step']\n\n    metadata = service_client.describe_secret(SecretId=arn)\n    if not metadata['RotationEnabled']:\n        raise ValueError(\"Secret %s is not enabled for rotation\" % arn)\n\n    versions = metadata['VersionIdsToStages']\n    if token not in versions:\n        raise ValueError(\"Secret version %s has no stage for rotation of secret %s.\" % (token, arn))\n\n    if \"AWSCURRENT\" in versions[token]:\n        return\n    elif \"AWSPENDING\" not in versions[token]:\n        raise ValueError(\"Secret version %s not set as AWSPENDING for rotation of secret %s.\" % (token, arn))\n\n    if step == \"createSecret\":\n        create_secret(service_client, arn, token)\n    elif step == \"setSecret\":\n        set_secret(service_client, arn, token)\n    elif step == \"testSecret\":\n        test_secret(service_client, arn, token)\n    elif step == \"finishSecret\":\n        finish_secret(service_client, arn, token)\n    else:\n        raise ValueError(\"Invalid step parameter\")\n\ndef create_secret(service_client, arn, token):\n    service_client.get_secret_value(SecretId=arn, VersionStage=\"AWSCURRENT\")\n    try:\n        service_client.get_secret_value(SecretId=arn, VersionId=token, VersionStage=\"AWSPENDING\")\n    except service_client.exceptions.ResourceNotFoundException:\n        passwd = service_client.get_random_password(ExcludeCharacters='\"@/\\\\\\'', PasswordLength=32)\n        current_dict = json.loads(service_client.get_secret_value(SecretId=arn, VersionStage=\"AWSCURRENT\")['SecretString'])\n        current_dict['password'] = passwd['RandomPassword']\n        service_client.put_secret_value(SecretId=arn, ClientRequestToken=token, SecretString=json.dumps(current_dict), VersionStages=['AWSPENDING'])\n\ndef set_secret(service_client, arn, token):\n    pass\n\ndef test_secret(service_client, arn, token):\n    pass\n\ndef finish_secret(service_client, arn, token):\n    metadata = service_client.describe_secret(SecretId=arn)\n    current_version = None\n    for version in metadata[\"VersionIdsToStages\"]:\n        if \"AWSCURRENT\" in metadata[\"VersionIdsToStages\"][version]:\n            if version == token:\n                return\n            current_version = version\n            break\n\n    service_client.update_secret_version_stage(SecretId=arn, VersionStage=\"AWSCURRENT\", MoveToVersionId=token, RemoveFromVersionId=current_version)\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-rotation-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "RotationLambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "secretsmanager.amazonaws.com"
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "rds-subnet-group-${EnvironmentSuffix}"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS MySQL instance",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-subnet-group-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "DBInstance": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "rds-mysql-${EnvironmentSuffix}"
                },
                "DBName": {
                    "Ref": "DBName"
                },
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "AllocatedStorage": 100,
                "StorageType": "gp3",
                "StorageEncrypted": true,
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DBSecret}:SecretString:password}}"
                },
                "MultiAZ": true,
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "RDSSecurityGroup"
                    }
                ],
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
                "EnableCloudwatchLogsExports": [
                    "error",
                    "general",
                    "slowquery",
                    "audit"
                ],
                "DeletionProtection": false,
                "PubliclyAccessible": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-mysql-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    },
                    {
                        "Key": "Backup",
                        "Value": "Required"
                    }
                ]
            }
        },
        "CacheSubnetGroup": {
            "Type": "AWS::ElastiCache::SubnetGroup",
            "Properties": {
                "CacheSubnetGroupName": {
                    "Fn::Sub": "elasticache-subnet-group-${EnvironmentSuffix}"
                },
                "Description": "Subnet group for ElastiCache Redis cluster",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "elasticache-subnet-group-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "RedisAuthSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "redis-auth-token-${EnvironmentSuffix}"
                },
                "Description": "Authentication token for Redis cluster",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{}",
                    "GenerateStringKey": "token",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\",
                    "RequireEachIncludedType": false
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "redis-auth-token-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "RedisCluster": {
            "Type": "AWS::ElastiCache::ReplicationGroup",
            "Properties": {
                "ReplicationGroupId": {
                    "Fn::Sub": "redis-cluster-${EnvironmentSuffix}"
                },
                "ReplicationGroupDescription": "Redis cluster for session management",
                "Engine": "redis",
                "EngineVersion": 7.0,
                "CacheNodeType": {
                    "Ref": "CacheNodeType"
                },
                "NumCacheClusters": 2,
                "AutomaticFailoverEnabled": true,
                "MultiAZEnabled": true,
                "CacheSubnetGroupName": {
                    "Ref": "CacheSubnetGroup"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "ElastiCacheSecurityGroup"
                    }
                ],
                "AtRestEncryptionEnabled": true,
                "TransitEncryptionEnabled": false,
                "SnapshotRetentionLimit": 5,
                "SnapshotWindow": "03:00-05:00",
                "PreferredMaintenanceWindow": "mon:05:00-mon:07:00",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "redis-cluster-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "PCI-DSS"
                    }
                ]
            }
        },
        "RDSLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/rds/mysql/${EnvironmentSuffix}"
                },
                "RetentionInDays": 30,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rds-logs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "PublicSubnets": {
            "Description": "Public subnet IDs",
            "Value": {
                "Fn::Sub": "${PublicSubnet1},${PublicSubnet2}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PublicSubnets"
                }
            }
        },
        "PrivateSubnets": {
            "Description": "Private subnet IDs",
            "Value": {
                "Fn::Sub": "${PrivateSubnet1},${PrivateSubnet2}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrivateSubnets"
                }
            }
        },
        "RDSEndpoint": {
            "Description": "RDS MySQL endpoint address",
            "Value": {
                "Fn::GetAtt": [
                    "DBInstance",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSEndpoint"
                }
            }
        },
        "RDSPort": {
            "Description": "RDS MySQL port",
            "Value": {
                "Fn::GetAtt": [
                    "DBInstance",
                    "Endpoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDSPort"
                }
            }
        },
        "DBSecretArn": {
            "Description": "ARN of the database credentials secret",
            "Value": {
                "Ref": "DBSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DBSecretArn"
                }
            }
        },
        "RedisEndpoint": {
            "Description": "Redis cluster endpoint address",
            "Value": {
                "Fn::GetAtt": [
                    "RedisCluster",
                    "PrimaryEndPoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisEndpoint"
                }
            }
        },
        "RedisPort": {
            "Description": "Redis cluster port",
            "Value": {
                "Fn::GetAtt": [
                    "RedisCluster",
                    "PrimaryEndPoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisPort"
                }
            }
        },
        "RedisAuthSecretArn": {
            "Description": "ARN of the Redis auth token secret",
            "Value": {
                "Ref": "RedisAuthSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisAuthSecretArn"
                }
            }
        },
        "ApplicationSecurityGroupId": {
            "Description": "Application security group ID",
            "Value": {
                "Ref": "ApplicationSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AppSecurityGroup"
                }
            }
        }
    }
}
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Active-Passive DR Architecture for Financial Transaction System'

Parameters:
  Environment:
    Type: String
    Default: 'Production'
    AllowedValues:
      - Production
      - Staging
    Description: Environment name

  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: Environment suffix to append to resource names for uniqueness

  DomainName:
    Type: String
    Default: ''
    Description: (Optional) Domain name for the application that you own (e.g., myapp.yourdomain.com). Leave empty to skip Route53 setup.

  DBMasterUsername:
    Type: String
    Default: 'admin'
    Description: Database master username
    NoEcho: false

  AlertEmail:
    Type: String
    Default: 'admin@example.com'
    Description: Email address for alerts

  DataRetentionDays:
    Type: Number
    Default: 2555
    Description: Data retention period in days (7 years default for financial compliance)

Conditions:
  CreateRoute53Resources: !Not [!Equals [!Ref DomainName, '']]

Resources:
  # ==========================================
  # Route53 Hosted Zone (Created Instead of External Reference)
  # ==========================================
  HostedZone:
    Type: AWS::Route53::HostedZone
    Condition: CreateRoute53Resources
    DeletionPolicy: Delete
    Properties:
      Name: !Ref DomainName
      HostedZoneConfig:
        Comment: !Sub 'Hosted zone for ${DomainName}'
      HostedZoneTags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-hosted-zone'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # VPC and Networking Configuration
  # ==========================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-vpc'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-igw'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-public-subnet-1'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-public-subnet-2'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-private-subnet-1'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-private-subnet-2'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  DatabaseSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.20.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-subnet-1'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  DatabaseSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.21.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-subnet-2'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  NATGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-nat-gw-1'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  EIP1:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-eip-1'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-public-rt'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-private-rt'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway1

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # ==========================================
  # Security Groups
  # ==========================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from internet
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-alb-sg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for application servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB only
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-app-sg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Aurora database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroup
          Description: MySQL from app servers only
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: MySQL from Lambda functions only
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-sg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-lambda-sg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # VPC Endpoints for AWS Services
  # ==========================================
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable

  DynamoDBEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.dynamodb'
      RouteTableIds:
        - !Ref PrivateRouteTable

  # ==========================================
  # KMS Key for Encryption
  # ==========================================
  KMSKey:
    Type: AWS::KMS::Key
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Description: Customer managed KMS key for encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow RDS to use the key
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 'rds.${AWS::Region}.amazonaws.com'
          - Sid: Allow S3 to use the key
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 's3.${AWS::Region}.amazonaws.com'
          - Sid: Allow Lambda to use the key
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 'lambda.${AWS::Region}.amazonaws.com'
          - Sid: Allow CloudWatch Logs to use the key
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              ArnLike:
                'kms:EncryptionContext:aws:logs:arn': !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'
          - Sid: Allow DynamoDB to use the key
            Effect: Allow
            Principal:
              Service: dynamodb.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 'dynamodb.${AWS::Region}.amazonaws.com'
          - Sid: Allow SNS to use the key
            Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
          - Sid: Allow Secrets Manager to use the key
            Effect: Allow
            Principal:
              Service: secretsmanager.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 'secretsmanager.${AWS::Region}.amazonaws.com'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-kms-key'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  KMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}-${EnvironmentSuffix}-key'
      TargetKeyId: !Ref KMSKey

  # ==========================================
  # Secrets Manager for Database Credentials
  # ==========================================
  DBMasterPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: Master password for Aurora database cluster
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBMasterUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
        RequireEachIncludedType: true
      KmsKeyId: !Ref KMSKey
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-master-password'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # S3 Buckets for Application Artifacts
  # ==========================================
  ApplicationArtifactsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref KMSKey
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: RetentionRule
            Status: Enabled
            ExpirationInDays: !Ref DataRetentionDays
            NoncurrentVersionExpirationInDays: 90
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-artifacts'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  ConfigurationBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref KMSKey
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-config'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # Aurora RDS Cluster
  # ==========================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Aurora cluster
      SubnetIds:
        - !Ref DatabaseSubnet1
        - !Ref DatabaseSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-subnet-group'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  DBClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: Cluster parameter group for Aurora MySQL
      Family: aurora-mysql8.0
      Parameters:
        binlog_format: 'ROW'
        binlog_backup: '0'
        binlog_replication_globaldb: '0'
        aurora_enhanced_binlog: '1'
        innodb_trx_commit_allow_data_loss: '1'
        innodb_flush_log_at_trx_commit: '1'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-cluster-param-group'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  AuroraDBCluster:
    Type: AWS::RDS::DBCluster
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Engine: aurora-mysql
      EngineMode: provisioned
      EngineVersion: 8.0.mysql_aurora.3.04.0
      DatabaseName: financedb
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBMasterPasswordSecret}:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      DBClusterParameterGroupName: !Ref DBClusterParameterGroup
      VpcSecurityGroupIds:
        - !Ref DatabaseSecurityGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      StorageEncrypted: true
      KmsKeyId: !Ref KMSKey
      DeletionProtection: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-aurora-cluster'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrimaryDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      DBInstanceClass: db.r6g.xlarge
      DBClusterIdentifier: !Ref AuroraDBCluster
      Engine: aurora-mysql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-primary-db'
        - Key: Role
          Value: Primary
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  StandbyDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      DBInstanceClass: db.r6g.xlarge
      DBClusterIdentifier: !Ref AuroraDBCluster
      Engine: aurora-mysql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-standby-db'
        - Key: Role
          Value: Standby
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # DynamoDB for Session State
  # ==========================================
  SessionStateTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-sessions'
      AttributeDefinitions:
        - AttributeName: SessionId
          AttributeType: S
        - AttributeName: UserId
          AttributeType: S
      KeySchema:
        - AttributeName: SessionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: UserId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref KMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      ContributorInsightsSpecification:
        Enabled: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-sessions'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  FailoverStateTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-failover-state'
      AttributeDefinitions:
        - AttributeName: StateKey
          AttributeType: S
      KeySchema:
        - AttributeName: StateKey
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref KMSKey
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-failover-state'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # Application Load Balancers
  # ==========================================
  PrimaryALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DeletionPolicy: Delete
    Properties:
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-primary-alb'
        - Key: Environment
          Value: Primary
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  StandbyALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DeletionPolicy: Delete
    Properties:
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-standby-alb'
        - Key: Environment
          Value: Standby
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrimaryTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 10
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-primary-tg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  StandbyTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 10
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-standby-tg'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrimaryListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PrimaryTargetGroup
      LoadBalancerArn: !Ref PrimaryALB
      Port: 80
      Protocol: HTTP

  StandbyListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref StandbyTargetGroup
      LoadBalancerArn: !Ref StandbyALB
      Port: 80
      Protocol: HTTP

  # ==========================================
  # Route53 Health Checks and DNS
  # ==========================================
  PrimaryHealthCheck:
    Type: AWS::Route53::HealthCheck
    Condition: CreateRoute53Resources
    Properties:
      HealthCheckConfig:
        Type: HTTP
        ResourcePath: /health
        FullyQualifiedDomainName: !GetAtt PrimaryALB.DNSName
        Port: 80
        RequestInterval: 10
        FailureThreshold: 3
      HealthCheckTags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-primary-health'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  StandbyHealthCheck:
    Type: AWS::Route53::HealthCheck
    Condition: CreateRoute53Resources
    Properties:
      HealthCheckConfig:
        Type: HTTP
        ResourcePath: /health
        FullyQualifiedDomainName: !GetAtt StandbyALB.DNSName
        Port: 80
        RequestInterval: 10
        FailureThreshold: 3
      HealthCheckTags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-standby-health'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  PrimaryRecord:
    Type: AWS::Route53::RecordSet
    Condition: CreateRoute53Resources
    Properties:
      HostedZoneId: !Ref HostedZone
      Name: !Ref DomainName
      Type: A
      SetIdentifier: Primary
      Failover: PRIMARY
      HealthCheckId: !Ref PrimaryHealthCheck
      AliasTarget:
        HostedZoneId: !GetAtt PrimaryALB.CanonicalHostedZoneID
        DNSName: !GetAtt PrimaryALB.DNSName
        EvaluateTargetHealth: true

  StandbyRecord:
    Type: AWS::Route53::RecordSet
    Condition: CreateRoute53Resources
    Properties:
      HostedZoneId: !Ref HostedZone
      Name: !Ref DomainName
      Type: A
      SetIdentifier: Standby
      Failover: SECONDARY
      HealthCheckId: !Ref StandbyHealthCheck
      AliasTarget:
        HostedZoneId: !GetAtt StandbyALB.CanonicalHostedZoneID
        DNSName: !GetAtt StandbyALB.DNSName
        EvaluateTargetHealth: true

  # ==========================================
  # Lambda Functions for Failover
  # ==========================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: FailoverPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: RDSManagement
                Effect: Allow
                Action:
                  - rds:FailoverDBCluster
                  - rds:DescribeDBClusters
                  - rds:DescribeDBInstances
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${AuroraDBCluster}'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:*'
              - Sid: Route53Management
                Effect: Allow
                Action:
                  - route53:ChangeResourceRecordSets
                  - route53:GetHealthCheck
                  - route53:ListHostedZones
                  - route53:ListHealthChecks
                Resource: '*'
              - Sid: ELBManagement
                Effect: Allow
                Action:
                  - elasticloadbalancing:DescribeTargetHealth
                  - elasticloadbalancing:RegisterTargets
                  - elasticloadbalancing:DeregisterTargets
                  - elasticloadbalancing:DescribeLoadBalancers
                  - elasticloadbalancing:DescribeTargetGroups
                Resource:
                  - !GetAtt PrimaryTargetGroup.TargetGroupArn
                  - !GetAtt StandbyTargetGroup.TargetGroupArn
                  - !Ref PrimaryALB
                  - !Ref StandbyALB
              - Sid: DynamoDBAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt FailoverStateTable.Arn
                  - !GetAtt SessionStateTable.Arn
              - Sid: SNSPublish
                Effect: Allow
                Action:
                  - sns:Publish
                Resource:
                  - !Ref AlertTopic
              - Sid: CloudWatchMetrics
                Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
              - Sid: SSMParameterAccess
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:PutParameter
                Resource:
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/dr-system/*'
              - Sid: KMSAccess
                Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource:
                  - !GetAtt KMSKey.Arn
              - Sid: SecretsManagerAccess
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource:
                  - !Ref DBMasterPasswordSecret
              - Sid: LambdaInvoke
                Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}-${EnvironmentSuffix}-*'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-lambda-execution-role'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  FailoverOrchestratorFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.9
      Handler: index.handler
      Timeout: 60
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          CLUSTER_ID: !Ref AuroraDBCluster
          FAILOVER_STATE_TABLE: !Ref FailoverStateTable
          SNS_TOPIC_ARN: !Ref AlertTopic
          PRIMARY_ALB_ARN: !Ref PrimaryALB
          STANDBY_ALB_ARN: !Ref StandbyALB
          HOSTED_ZONE_ID: !If [CreateRoute53Resources, !Ref HostedZone, '']
          DOMAIN_NAME: !Ref DomainName
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          import time
          from datetime import datetime

          rds = boto3.client('rds')
          route53 = boto3.client('route53')
          dynamodb = boto3.resource('dynamodb')
          sns = boto3.client('sns')
          cloudwatch = boto3.client('cloudwatch')

          def handler(event, context):
              start_time = time.time()
              cluster_id = os.environ['CLUSTER_ID']
              table = dynamodb.Table(os.environ['FAILOVER_STATE_TABLE'])

              try:
                  # Check current cluster status
                  response = rds.describe_db_clusters(DBClusterIdentifier=cluster_id)
                  cluster = response['DBClusters'][0]

                  # Determine if failover is needed
                  if should_failover(event, cluster):
                      # Record failover start
                      table.put_item(Item={
                          'StateKey': 'FAILOVER_STATUS',
                          'Status': 'IN_PROGRESS',
                          'StartTime': datetime.utcnow().isoformat(),
                          'Reason': json.dumps(event)
                      })

                      # Initiate RDS failover
                      print(f"Initiating failover for cluster {cluster_id}")
                      rds.failover_db_cluster(DBClusterIdentifier=cluster_id)

                      # Update Route53 records
                      update_dns_routing()

                      # Wait for failover to complete
                      wait_for_failover_completion(cluster_id)

                      # Record metrics
                      elapsed_time = time.time() - start_time
                      cloudwatch.put_metric_data(
                          Namespace='DRSystem',
                          MetricData=[
                              {
                                  'MetricName': 'FailoverDuration',
                                  'Value': elapsed_time,
                                  'Unit': 'Seconds'
                              }
                          ]
                      )

                      # Update failover status
                      table.put_item(Item={
                          'StateKey': 'FAILOVER_STATUS',
                          'Status': 'COMPLETED',
                          'CompletedTime': datetime.utcnow().isoformat(),
                          'Duration': elapsed_time
                      })

                      # Send notification
                      sns.publish(
                          TopicArn=os.environ['SNS_TOPIC_ARN'],
                          Subject='Failover Completed Successfully',
                          Message=f'Failover completed in {elapsed_time:.2f} seconds'
                      )

                      return {
                          'statusCode': 200,
                          'body': json.dumps('Failover completed successfully')
                      }
                  else:
                      return {
                          'statusCode': 200,
                          'body': json.dumps('Failover not required')
                      }

              except Exception as e:
                  print(f"Error during failover: {str(e)}")
                  sns.publish(
                      TopicArn=os.environ['SNS_TOPIC_ARN'],
                      Subject='Failover Failed',
                      Message=f'Error: {str(e)}'
                  )
                  raise

          def should_failover(event, cluster):
              # Implement logic to determine if failover should occur
              # Check multiple signals: DB health, app health, manual trigger
              return event.get('trigger_failover', False)

          def update_dns_routing():
              # Update Route53 weights or failover routing
              pass

          def wait_for_failover_completion(cluster_id, max_wait=120):
              elapsed = 0
              while elapsed < max_wait:
                  response = rds.describe_db_clusters(DBClusterIdentifier=cluster_id)
                  status = response['DBClusters'][0]['Status']
                  if status == 'available':
                      return True
                  time.sleep(5)
                  elapsed += 5
              raise Exception('Failover timeout exceeded')
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-failover-orchestrator'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  HealthMonitorFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.9
      Handler: index.handler
      Timeout: 30
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          CLUSTER_ID: !Ref AuroraDBCluster
          PRIMARY_TG_ARN: !Ref PrimaryTargetGroup
          SESSION_TABLE: !Ref SessionStateTable
          FAILOVER_FUNCTION_NAME: !Ref FailoverOrchestratorFunction
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from datetime import datetime

          rds = boto3.client('rds')
          elbv2 = boto3.client('elbv2')
          cloudwatch = boto3.client('cloudwatch')
          lambda_client = boto3.client('lambda')

          def handler(event, context):
              health_status = {
                  'timestamp': datetime.utcnow().isoformat(),
                  'checks': {}
              }

              # Check RDS cluster health
              try:
                  cluster_response = rds.describe_db_clusters(
                      DBClusterIdentifier=os.environ['CLUSTER_ID']
                  )
                  cluster = cluster_response['DBClusters'][0]

                  health_status['checks']['database'] = {
                      'status': cluster['Status'],
                      'healthy': cluster['Status'] == 'available'
                  }

                  # Check replication lag
                  for member in cluster['DBClusterMembers']:
                      if member['IsClusterWriter']:
                          continue
                      instance_response = rds.describe_db_instances(
                          DBInstanceIdentifier=member['DBInstanceIdentifier']
                      )
                      instance = instance_response['DBInstances'][0]
                      lag = instance.get('StatusInfos', [{}])[0].get('StatusType')
                      health_status['checks']['replication_lag'] = {
                          'lag_seconds': lag if lag else 0,
                          'healthy': True if not lag or lag < 1 else False
                      }
              except Exception as e:
                  health_status['checks']['database'] = {
                      'status': 'error',
                      'healthy': False,
                      'error': str(e)
                  }

              # Check ALB target health
              try:
                  target_health = elbv2.describe_target_health(
                      TargetGroupArn=os.environ['PRIMARY_TG_ARN']
                  )
                  healthy_targets = sum(1 for t in target_health['TargetHealthDescriptions']
                                      if t['TargetHealth']['State'] == 'healthy')
                  health_status['checks']['alb_targets'] = {
                      'healthy_count': healthy_targets,
                      'healthy': healthy_targets > 0
                  }
              except Exception as e:
                  health_status['checks']['alb_targets'] = {
                      'status': 'error',
                      'healthy': False,
                      'error': str(e)
                  }

              # Determine overall health
              overall_health = all(check.get('healthy', False)
                                  for check in health_status['checks'].values())

              # If unhealthy, consider triggering failover
              if not overall_health:
                  print("Health check failed, evaluating failover criteria")
                  evaluate_failover(health_status)

              # Publish metrics
              publish_health_metrics(health_status)

              return {
                  'statusCode': 200,
                  'body': json.dumps(health_status)
              }

          def evaluate_failover(health_status):
              # Complex logic to determine if automatic failover should be triggered
              # This prevents false positives by checking multiple conditions
              failures = []

              if not health_status['checks'].get('database', {}).get('healthy'):
                  failures.append('database')
              if not health_status['checks'].get('alb_targets', {}).get('healthy'):
                  failures.append('alb_targets')
              if health_status['checks'].get('replication_lag', {}).get('lag_seconds', 0) > 5:
                  failures.append('replication_lag')

              if len(failures) >= 2:
                  # Trigger failover if multiple components are unhealthy
                  lambda_client.invoke(
                      FunctionName=os.environ['FAILOVER_FUNCTION_NAME'],
                      InvocationType='Event',
                      Payload=json.dumps({
                          'trigger_failover': True,
                          'reason': failures
                      })
                  )

          def publish_health_metrics(health_status):
              metrics = []

              if 'database' in health_status['checks']:
                  metrics.append({
                      'MetricName': 'DatabaseHealth',
                      'Value': 1 if health_status['checks']['database']['healthy'] else 0,
                      'Unit': 'None'
                  })

              if 'replication_lag' in health_status['checks']:
                  lag = health_status['checks']['replication_lag'].get('lag_seconds', 0)
                  metrics.append({
                      'MetricName': 'ReplicationLag',
                      'Value': lag,
                      'Unit': 'Seconds'
                  })

              if metrics:
                  cloudwatch.put_metric_data(
                      Namespace='DRSystem',
                      MetricData=metrics
                  )
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-health-monitor'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  # ==========================================
  # EventBridge Rules for Orchestration
  # ==========================================
  HealthCheckScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Trigger health checks every minute
      ScheduleExpression: rate(1 minute)
      State: ENABLED
      Targets:
        - Arn: !GetAtt HealthMonitorFunction.Arn
          Id: HealthCheckTarget

  HealthCheckPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref HealthMonitorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt HealthCheckScheduleRule.Arn

  RDSEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Capture RDS failover events
      EventPattern:
        source:
          - aws.rds
        detail-type:
          - RDS DB Cluster Event
        detail:
          EventCategories:
            - failover
      State: ENABLED
      Targets:
        - Arn: !Ref AlertTopic
          Id: RDSEventTarget

  # ==========================================
  # CloudWatch Alarms
  # ==========================================
  DatabaseConnectionAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-db-connections'
      AlarmDescription: Alert when database connections are high
      MetricName: DatabaseConnections
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref AuroraDBCluster
      AlarmActions:
        - !Ref AlertTopic

  ReplicationLagAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-replication-lag'
      AlarmDescription: Alert when replication lag exceeds 1 second
      MetricName: AuroraReplicaLag
      Namespace: AWS/RDS
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 1000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref AuroraDBCluster
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  CompositeAlarm:
    Type: AWS::CloudWatch::CompositeAlarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-critical-failure'
      AlarmDescription: Composite alarm for critical system failures
      ActionsEnabled: true
      AlarmActions:
        - !Ref AlertTopic
      AlarmRule: !Sub '(ALARM("${DatabaseConnectionAlarm}") AND ALARM("${ReplicationLagAlarm}")) OR ALARM("${ALBUnhealthyTargetsAlarm}")'

  ALBUnhealthyTargetsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-${EnvironmentSuffix}-alb-unhealthy-targets'
      AlarmDescription: Alert when ALB has no healthy targets
      MetricName: HealthyHostCount
      Namespace: AWS/ApplicationELB
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt PrimaryALB.LoadBalancerFullName
        - Name: TargetGroup
          Value: !GetAtt PrimaryTargetGroup.TargetGroupFullName
      AlarmActions:
        - !Ref AlertTopic

  # ==========================================
  # SNS Topic for Alerts
  # ==========================================
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: DR System Alerts
      KmsMasterKeyId: !Ref KMSKey
      Subscription:
        - Endpoint: !Ref AlertEmail
          Protocol: email
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-${EnvironmentSuffix}-alerts'
        - Key: project
          Value: 'iac-rlhf-amazon'
        - Key: team-number
          Value: '2'

  AlertTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref AlertTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudWatchPublish
            Effect: Allow
            Principal:
              Service: cloudwatch.amazonaws.com
            Action:
              - SNS:Publish
            Resource: !Ref AlertTopic
          - Sid: AllowEventBridgePublish
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action:
              - SNS:Publish
            Resource: !Ref AlertTopic

  # ==========================================
  # Systems Manager Parameter Store
  # ==========================================
  FailoverConfigParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/dr-system/${EnvironmentSuffix}/failover/config'
      Type: String
      Value: !Sub |
        {
          "primary_endpoint": "${PrimaryALB.DNSName}",
          "standby_endpoint": "${StandbyALB.DNSName}",
          "rto_seconds": 30,
          "rpo_seconds": 1,
          "auto_failover_enabled": true,
          "health_check_interval": 60
        }
      Description: Failover configuration parameters
      Tags:
        Environment: !Ref Environment
        project: 'iac-rlhf-amazon'
        team-number: '2'

  DatabaseEndpointParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/dr-system/${EnvironmentSuffix}/database/endpoint'
      Type: String
      Value: !GetAtt AuroraDBCluster.Endpoint.Address
      Description: Database cluster endpoint
      Tags:
        Environment: !Ref Environment
        project: 'iac-rlhf-amazon'
        team-number: '2'

  # ==========================================
  # CloudWatch Dashboard
  # ==========================================
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/RDS", "DatabaseConnections", {"stat": "Average", "label": "DB Connections"}],
                  [".", "AuroraReplicaLag", {"stat": "Maximum", "label": "Replica Lag (ms)"}],
                  ["DRSystem", "FailoverDuration", {"stat": "Average", "label": "Failover Time (s)"}],
                  ["AWS/ApplicationELB", "HealthyHostCount", {"stat": "Minimum", "label": "Healthy Targets"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "DR System Metrics",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["DRSystem", "DatabaseHealth", {"stat": "Minimum"}],
                  [".", "ReplicationLag", {"stat": "Maximum"}]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Health Status"
              }
            }
          ]
        }

  # ==========================================
  # Log Groups
  # ==========================================
  FailoverLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub '/aws/lambda/${FailoverOrchestratorFunction}'
      RetentionInDays: 90
      KmsKeyId: !GetAtt KMSKey.Arn

  HealthMonitorLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub '/aws/lambda/${HealthMonitorFunction}'
      RetentionInDays: 90
      KmsKeyId: !GetAtt KMSKey.Arn

Outputs:
  HostedZoneId:
    Condition: CreateRoute53Resources
    Description: Route53 Hosted Zone ID
    Value: !Ref HostedZone
    Export:
      Name: !Sub '${AWS::StackName}-${EnvironmentSuffix}-hosted-zone-id'

  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-${EnvironmentSuffix}-vpc'

  PrimaryEndpoint:
    Description: Primary Application Endpoint
    Value: !GetAtt PrimaryALB.DNSName

  StandbyEndpoint:
    Description: Standby Application Endpoint
    Value: !GetAtt StandbyALB.DNSName

  DatabaseEndpoint:
    Description: Aurora Cluster Endpoint
    Value: !GetAtt AuroraDBCluster.Endpoint.Address

  DatabaseMasterPasswordSecretArn:
    Description: ARN of Secrets Manager secret containing database master password
    Value: !Ref DBMasterPasswordSecret

  DatabaseReadEndpoint:
    Description: Aurora Cluster Read Endpoint
    Value: !GetAtt AuroraDBCluster.ReadEndpoint.Address

  SessionTableName:
    Description: DynamoDB Session Table Name
    Value: !Ref SessionStateTable

  FailoverStateTableName:
    Description: DynamoDB Failover State Table Name
    Value: !Ref FailoverStateTable

  ArtifactsBucket:
    Description: S3 Bucket for Application Artifacts
    Value: !Ref ApplicationArtifactsBucket

  ConfigBucket:
    Description: S3 Bucket for Configuration Files
    Value: !Ref ConfigurationBucket

  AlertTopicArn:
    Description: SNS Topic for Alerts
    Value: !Ref AlertTopic

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${MonitoringDashboard}'

  KMSKeyId:
    Description: KMS Key ID for Encryption
    Value: !Ref KMSKey

  FailoverFunctionArn:
    Description: Failover Orchestrator Function ARN
    Value: !GetAtt FailoverOrchestratorFunction.Arn

  HealthMonitorFunctionArn:
    Description: Health Monitor Function ARN
    Value: !GetAtt HealthMonitorFunction.Arn

AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Secure, compliance-oriented stack: VPC (2 public + 2 private), S3 (versioning + SSE-KMS),
  CloudTrail (S3 + CW Logs), optional AWS Config + Security Hub, KMS key, SSM Parameter (String),
  Lambda (least-priv), VPC Flow Logs, and CW Alarm. No named IAM (no RoleName/UserName).

Parameters:
  ProjectName:
    Type: String
    Default: "tap"
    AllowedPattern: "^[a-z0-9-]+$"
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    AllowedPattern: "^[a-z0-9-]+$"
  CostCenter:
    Type: String
    Default: "cc-0000"
  Owner:
    Type: String
    Default: "platform-team"

  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
  PublicSubnetCidrs:
    Type: CommaDelimitedList
    Default: "10.0.0.0/24,10.0.1.0/24"
  PrivateSubnetCidrs:
    Type: CommaDelimitedList
    Default: "10.0.100.0/24,10.0.101.0/24"
  AllowedIngressCidr:
    Type: String
    Default: "0.0.0.0/0"

  # Secret comes in as plain CFN param (NoEcho) and is stored in SSM as String (to satisfy cfn-lint).
  DbPassword:
    Type: String
    NoEcho: true
    Default: "Tempp@55w0rd!"

  # Make “already-enabled” services optional
  EnableSecurityHub:
    Type: String
    AllowedValues: ["true","false"]
    Default: "false"
  EnableAWSConfig:
    Type: String
    AllowedValues: ["true","false"]
    Default: "false"

  # Avoid SSM name collisions (override if it already exists in the account)
  SsmParamName:
    Type: String
    Default: ""
    AllowedPattern: '^$|^((?!aws|ssm)[\w\.\-]+|\/(?!aws|ssm)[\w\.\-]+(\/[\w\.\-]+)*)$'
    Description: >-
      Optional explicit SSM parameter name. Leave empty to auto-generate
      '/<ProjectName>/<EnvironmentSuffix>/DB_PASSWORD'.

Conditions:
  CreateSecurityHub: !Equals [!Ref EnableSecurityHub, "true"]
  CreateAWSConfig:   !Equals [!Ref EnableAWSConfig,   "true"]
  HasCustomSsmName:  !Not [ !Equals [ !Ref SsmParamName, "" ] ]

Resources:
  ############################################
  # KMS (for S3 encryption)
  ############################################
  AppKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "kms-${ProjectName}-${EnvironmentSuffix} application key"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: EnableIAMUserPermissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
      Tags:
        - { Key: Name,        Value: !Sub "kms-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: CostCenter,  Value: !Ref CostCenter }
        - { Key: Owner,       Value: !Ref Owner }

  AppKmsAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/kms-${ProjectName}-${EnvironmentSuffix}-app"
      TargetKeyId: !Ref AppKmsKey

  ############################################
  # VPC (2 public + 2 private), IGW, NAT, Routes
  ############################################
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - { Key: Name,        Value: !Sub "vpc-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: CostCenter,  Value: !Ref CostCenter }
        - { Key: Owner,       Value: !Ref Owner }

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - { Key: Name,        Value: !Sub "igw-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties: { VpcId: !Ref VPC, InternetGatewayId: !Ref InternetGateway }

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Ref PublicSubnetCidrs]
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - { Key: Name,        Value: !Sub "subnet-public-a-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Ref PublicSubnetCidrs]
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - { Key: Name,        Value: !Sub "subnet-public-b-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Ref PrivateSubnetCidrs]
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - { Key: Name,        Value: !Sub "subnet-private-a-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Ref PrivateSubnetCidrs]
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - { Key: Name,        Value: !Sub "subnet-private-b-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - { Key: Name,        Value: !Sub "rt-public-${ProjectName}-${EnvironmentSuffix}" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: { SubnetId: !Ref PublicSubnetA, RouteTableId: !Ref PublicRouteTable }

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: { SubnetId: !Ref PublicSubnetB, RouteTableId: !Ref PublicRouteTable }

  NatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags: [ { Key: Name, Value: !Sub "eip-nat-${ProjectName}-${EnvironmentSuffix}" } ]

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEip.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags: [ { Key: Name, Value: !Sub "nat-${ProjectName}-${EnvironmentSuffix}" } ]

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties: { VpcId: !Ref VPC, Tags: [ { Key: Name, Value: !Sub "rt-private-a-${ProjectName}-${EnvironmentSuffix}" } ] }

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties: { VpcId: !Ref VPC, Tags: [ { Key: Name, Value: !Sub "rt-private-b-${ProjectName}-${EnvironmentSuffix}" } ] }

  PrivateRouteA:
    Type: AWS::EC2::Route
    Properties: { RouteTableId: !Ref PrivateRouteTableA, DestinationCidrBlock: "0.0.0.0/0", NatGatewayId: !Ref NatGateway }

  PrivateRouteB:
    Type: AWS::EC2::Route
    Properties: { RouteTableId: !Ref PrivateRouteTableB, DestinationCidrBlock: "0.0.0.0/0", NatGatewayId: !Ref NatGateway }

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: { SubnetId: !Ref PrivateSubnetA, RouteTableId: !Ref PrivateRouteTableA }

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: { SubnetId: !Ref PrivateSubnetB, RouteTableId: !Ref PrivateRouteTableB }

  ############################################
  # Security Group (tight)
  ############################################
  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "sg-${ProjectName}-${EnvironmentSuffix} web ingress"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: !Ref AllowedIngressCidr }
      SecurityGroupEgress:
        - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: "0.0.0.0/0" }
      Tags:
        - { Key: Name,        Value: !Sub "sg-${ProjectName}-${EnvironmentSuffix}-web" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  ############################################
  # S3 (App, CloudTrail, Config)
  ############################################
  AppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-app"
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref AppKmsKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - { Key: Name,        Value: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-app" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  AppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AppBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceTLS
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource: [ !GetAtt AppBucket.Arn, !Sub "${AppBucket.Arn}/*" ]
            Condition: { Bool: { aws:SecureTransport: "false" } }

  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-cloudtrail"
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - { Key: Name,        Value: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-cloudtrail" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudTrailBucketAclCheck
            Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: AllowCloudTrailWrite
            Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: s3:PutObject
            Resource: !Sub "${CloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition: { StringEquals: { s3:x-amz-acl: "bucket-owner-full-control" } }
          - Sid: DenyDeleteCloudTrailLogs
            Effect: Deny
            Principal: "*"
            Action: [ s3:DeleteObject, s3:DeleteObjectVersion ]
            Resource: !Sub "${CloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
          - Sid: EnforceTLS
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource: [ !GetAtt CloudTrailBucket.Arn, !Sub "${CloudTrailBucket.Arn}/*" ]
            Condition: { Bool: { aws:SecureTransport: "false" } }

  ConfigBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-${AWS::AccountId}-${AWS::Region}-config"
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - { Key: Name,        Value: !Sub "s3-${ProjectName}-${EnvironmentSuffix}-config" }
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  ConfigBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ConfigBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceTLS
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource: [ !GetAtt ConfigBucket.Arn, !Sub "${ConfigBucket.Arn}/*" ]
            Condition: { Bool: { aws:SecureTransport: "false" } }

  ############################################
  # CloudTrail (+ CW Logs)
  ############################################
  CloudTrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/cloudtrail/${ProjectName}/${EnvironmentSuffix}"
      RetentionInDays: 90

  CloudTrailLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - { Effect: Allow, Principal: { Service: cloudtrail.amazonaws.com }, Action: sts:AssumeRole }
      Policies:
        - PolicyName: !Sub "cloudtrail-cwlogs-${ProjectName}-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - { Effect: Allow, Action: [ logs:CreateLogStream, logs:PutLogEvents ], Resource: !GetAtt CloudTrailLogGroup.Arn }
      Tags:
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  Trail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Sub "cloudtrail-${ProjectName}-${EnvironmentSuffix}"
      S3BucketName: !Ref CloudTrailBucket
      IsLogging: true
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      CloudWatchLogsLogGroupArn: !GetAtt CloudTrailLogGroup.Arn
      CloudWatchLogsRoleArn: !GetAtt CloudTrailLogsRole.Arn
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
      Tags:
        - { Key: Project,     Value: !Ref ProjectName }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }

  ############################################
  # VPC Flow Logs -> CloudWatch Logs
  ############################################
  VpcFlowLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vpc/flowlogs/${ProjectName}/${EnvironmentSuffix}"
      RetentionInDays: 90

  VpcFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - { Effect: Allow, Principal: { Service: vpc-flow-logs.amazonaws.com }, Action: sts:AssumeRole }
      Policies:
        - PolicyName: !Sub "vpc-flow-logs-${ProjectName}-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - { Effect: Allow, Action: [ logs:CreateLogStream, logs:PutLogEvents ], Resource: !GetAtt VpcFlowLogGroup.Arn }

  VpcFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceId: !Ref VPC
      ResourceType: VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VpcFlowLogGroup
      DeliverLogsPermissionArn: !GetAtt VpcFlowLogsRole.Arn
      Tags: [ { Key: Name, Value: !Sub "flowlog-${ProjectName}-${EnvironmentSuffix}" } ]

  ############################################
  # AWS Config (conditional)
  ############################################
  ConfigRole:
    Condition: CreateAWSConfig
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - { Effect: Allow, Principal: { Service: config.amazonaws.com }, Action: sts:AssumeRole }
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSConfigRole

  ConfigRecorder:
    Condition: CreateAWSConfig
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      Name: !Sub "configrecorder-${ProjectName}-${EnvironmentSuffix}"
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup: { AllSupported: true, IncludeGlobalResourceTypes: true }

  ConfigDeliveryChannel:
    Condition: CreateAWSConfig
    Type: AWS::Config::DeliveryChannel
    Properties:
      Name: !Sub "configchannel-${ProjectName}-${EnvironmentSuffix}"
      S3BucketName: !Ref ConfigBucket
      ConfigSnapshotDeliveryProperties: {}

  ConfigRuleCloudTrailEnabled:
    Condition: CreateAWSConfig
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "cfg-cloudtrail-enabled-${ProjectName}-${EnvironmentSuffix}"
      Source: { Owner: AWS, SourceIdentifier: CLOUD_TRAIL_ENABLED }

  ConfigRuleS3SSE:
    Condition: CreateAWSConfig
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "cfg-s3-sse-${ProjectName}-${EnvironmentSuffix}"
      Source: { Owner: AWS, SourceIdentifier: S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED }

  ConfigRuleIamNoAdminStatements:
    Condition: CreateAWSConfig
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "cfg-iam-no-admin-${ProjectName}-${EnvironmentSuffix}"
      Source: { Owner: AWS, SourceIdentifier: IAM_POLICY_NO_STATEMENTS_WITH_ADMIN_ACCESS }

  ConfigRuleDefaultSgClosed:
    Condition: CreateAWSConfig
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "cfg-default-sg-closed-${ProjectName}-${EnvironmentSuffix}"
      Source: { Owner: AWS, SourceIdentifier: VPC_DEFAULT_SECURITY_GROUP_CLOSED }

  ############################################
  # Security Hub (conditional)
  ############################################
  SecurityHubHub:
    Condition: CreateSecurityHub
    Type: AWS::SecurityHub::Hub
    Properties:
      Tags:
        Name:        !Sub "securityhub-${ProjectName}-${EnvironmentSuffix}"
        Project:     !Ref ProjectName
        Environment: !Ref EnvironmentSuffix

  SecurityHubFSBP:
    Condition: CreateSecurityHub
    Type: AWS::SecurityHub::Standard
    Properties:
      StandardsArn: !Sub "arn:${AWS::Partition}:securityhub:${AWS::Region}::standards/aws-foundational-security-best-practices/v/1.0.0"

  ############################################
  # SSM Parameter (String; configurable name)
  ############################################
  AppDbPasswordParam:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !If
        - HasCustomSsmName
        - !Ref SsmParamName
        - !Sub "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"
      Type: String
      Tier: Standard
      Value: !Ref DbPassword
      Description: !Sub "DB password for ${ProjectName}-${EnvironmentSuffix} (String)"

  ############################################
  # Lambda (least-priv) + logs
  ############################################
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - { Effect: Allow, Principal: { Service: lambda.amazonaws.com }, Action: sts:AssumeRole }
      Policies:
        - PolicyName: !Sub "lambda-logs-${ProjectName}-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - { Effect: Allow,
                  Action: [ logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents ],
                  Resource: !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*:*" }
        - PolicyName: !Sub "lambda-ssm-${ProjectName}-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: ReadSpecificParam
                Effect: Allow
                Action: [ ssm:GetParameter, ssm:GetParameters, ssm:GetParameterHistory ]
                Resource: !If
                  - HasCustomSsmName
                  - !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter${SsmParamName}"
                  - !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"

  AppLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/func-${ProjectName}-${EnvironmentSuffix}"
      RetentionInDays: 90

  AppLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "func-${ProjectName}-${EnvironmentSuffix}"
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: python3.11
      Handler: index.handler
      Timeout: 10
      MemorySize: 256
      Code:
        ZipFile: |
          import os, json, boto3
          def handler(event, context):
              ssm = boto3.client("ssm")
              name = os.environ.get('SSM_PARAM_NAME')
              p = ssm.get_parameter(Name=name, WithDecryption=False)
              return {"statusCode": 200, "body": json.dumps({"parameter": name, "len": len(p['Parameter']['Value'])})}
      Environment:
        Variables:
          SSM_PARAM_NAME: !If
            - HasCustomSsmName
            - !Ref SsmParamName
            - !Sub "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"

  ############################################
  # CloudWatch Alarm for Unauthorized Access
  ############################################
  UnauthorizedMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref CloudTrailLogGroup
      FilterPattern: >-
        { ($.errorCode = "UnauthorizedOperation") || ($.errorCode = "AccessDenied*") }
      MetricTransformations:
        - { MetricNamespace: !Sub "Security/${ProjectName}/${EnvironmentSuffix}",
            MetricName: "UnauthorizedAccessCount", MetricValue: "1" }

  UnauthorizedAccessAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "alarm-unauth-${ProjectName}-${EnvironmentSuffix}"
      Namespace: !Sub "Security/${ProjectName}/${EnvironmentSuffix}"
      MetricName: "UnauthorizedAccessCount"
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      AlarmDescription: "Triggers on any unauthorized access attempts found in CloudTrail"
      ActionsEnabled: true

Outputs:
  VpcId:
    Value: !Ref VPC
  PublicSubnets:
    Value: !Join [",", [!Ref PublicSubnetA, !Ref PublicSubnetB]]
  PrivateSubnets:
    Value: !Join [",", [!Ref PrivateSubnetA, !Ref PrivateSubnetB]]
  AppBucketName:
    Value: !Ref AppBucket
  CloudTrailBucketName:
    Value: !Ref CloudTrailBucket
  KmsKeyArn:
    Value: !GetAtt AppKmsKey.Arn
  CloudTrailArn:
    Value: !Sub "arn:${AWS::Partition}:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/${Trail}"
  SecurityHubStatus:
    Value: !If [CreateSecurityHub, "Enabled", "Skipped"]
  SsmParamDbPassword:
    Value: !If
      - HasCustomSsmName
      - !Ref SsmParamName
      - !Sub "/${ProjectName}/${EnvironmentSuffix}/DB_PASSWORD"

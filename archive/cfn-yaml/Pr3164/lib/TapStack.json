{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Static Website Infrastructure with S3, CloudFront, Route53, and KMS encryption",
  "Parameters": {
    "DomainName": {
      "Type": "String",
      "Description": "Custom domain name for the website (e.g., example.com). Leave blank to skip domain setup.",
      "Default": "",
      "AllowedPattern": "^([a-z0-9]+([\\-\\.]{1}[a-z0-9]+)*\\.[a-z]{2,})?$",
      "ConstraintDescription": "Must be a valid domain name or empty"
    },
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Environment suffix to append to resource names (e.g., dev, staging, prod)",
      "Default": "dev",
      "AllowedPattern": "^[a-z0-9]+$",
      "ConstraintDescription": "Must contain only lowercase letters and numbers"
    },
    "EnableSSL": {
      "Type": "String",
      "Description": "Enable HTTPS/SSL for CloudFront distribution",
      "Default": "false",
      "AllowedValues": [
        "true",
        "false"
      ]
    },
    "ACMCertificateArn": {
      "Type": "String",
      "Description": "ARN of ACM certificate in us-east-1 (required if EnableSSL is true, otherwise leave empty)",
      "Default": "",
      "AllowedPattern": "^(arn:aws:acm:us-east-1:[0-9]{12}:certificate\\/[a-z0-9-]+)?$",
      "ConstraintDescription": "Must be a valid ACM certificate ARN in us-east-1 region or empty"
    }
  },
  "Conditions": {
    "UseSSL": {
      "Fn::Equals": [
        {
          "Ref": "EnableSSL"
        },
        "true"
      ]
    },
    "HasDomainName": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "DomainName"
            },
            ""
          ]
        }
      ]
    },
    "NoDomainName": {
      "Fn::Equals": [
        {
          "Ref": "DomainName"
        },
        ""
      ]
    }
  },
  "Resources": {
    "HostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "Condition": "HasDomainName",
      "Properties": {
        "Name": {
          "Ref": "DomainName"
        },
        "HostedZoneConfig": {
          "Comment": {
            "Fn::Sub": "Hosted zone for ${DomainName} static website - ${EnvironmentSuffix}"
          }
        },
        "HostedZoneTags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-hosted-zone-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Purpose",
            "Value": "StaticWebsiteHosting"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "S3EncryptionKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {
          "Fn::Sub": "KMS key for encrypting static website S3 bucket - ${EnvironmentSuffix}"
        },
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "EnableIAMUserPermissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "AllowCloudFrontAccess",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey"
              ],
              "Resource": "*"
            }
          ]
        },
        "EnableKeyRotation": true
      }
    },
    "S3EncryptionKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/${AWS::StackName}-s3-encryption-${EnvironmentSuffix}"
        },
        "TargetKeyId": {
          "Ref": "S3EncryptionKey"
        }
      }
    },
    "LoggingBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::If": [
            "HasDomainName",
            {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "DomainName"
                  },
                  "logs",
                  {
                    "Ref": "EnvironmentSuffix"
                  },
                  {
                    "Ref": "AWS::AccountId"
                  }
                ]
              ]
            },
            {
              "Fn::Join": [
                "-",
                [
                  "logs",
                  {
                    "Ref": "EnvironmentSuffix"
                  },
                  {
                    "Ref": "AWS::AccountId"
                  }
                ]
              ]
            }
          ]
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "OwnershipControls": {
          "Rules": [
            {
              "ObjectOwnership": "BucketOwnerPreferred"
            }
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldLogs",
              "Status": "Enabled",
              "ExpirationInDays": 90
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-logging-bucket-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "LoggingBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "LoggingBucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "S3ServerAccessLogsPolicy",
              "Effect": "Allow",
              "Principal": {
                "Service": "logging.s3.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": {
                "Fn::Sub": "${LoggingBucket.Arn}/*"
              },
              "Condition": {
                "StringEquals": {
                  "aws:SourceAccount": {
                    "Ref": "AWS::AccountId"
                  }
                }
              }
            },
            {
              "Sid": "CloudFrontLogsPolicy",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": {
                "Fn::Sub": "${LoggingBucket.Arn}/*"
              },
              "Condition": {
                "StringEquals": {
                  "aws:SourceAccount": {
                    "Ref": "AWS::AccountId"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "WebsiteBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::If": [
            "HasDomainName",
            {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "DomainName"
                  },
                  "website",
                  {
                    "Ref": "EnvironmentSuffix"
                  },
                  {
                    "Ref": "AWS::AccountId"
                  }
                ]
              ]
            },
            {
              "Fn::Join": [
                "-",
                [
                  "website",
                  {
                    "Ref": "EnvironmentSuffix"
                  },
                  {
                    "Ref": "AWS::AccountId"
                  }
                ]
              ]
            }
          ]
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": {
                  "Fn::GetAtt": [
                    "S3EncryptionKey",
                    "Arn"
                  ]
                }
              },
              "BucketKeyEnabled": true
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldVersions",
              "Status": "Enabled",
              "NoncurrentVersionExpirationInDays": 30
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-website-bucket-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Purpose",
            "Value": "StaticWebsiteHosting"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudFrontOAC": {
      "Type": "AWS::CloudFront::OriginAccessControl",
      "Properties": {
        "OriginAccessControlConfig": {
          "Name": {
            "Fn::Sub": "${AWS::StackName}-OAC-${EnvironmentSuffix}"
          },
          "OriginAccessControlOriginType": "s3",
          "SigningBehavior": "always",
          "SigningProtocol": "sigv4"
        }
      }
    },
    "WebsiteBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "WebsiteBucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "AllowCloudFrontGetObject",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Sub": "${WebsiteBucket.Arn}/*"
              },
              "Condition": {
                "StringEquals": {
                  "AWS:SourceAccount": {
                    "Ref": "AWS::AccountId"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "CloudFrontDistributionSSLWithDomain": {
      "Type": "AWS::CloudFront::Distribution",
      "Condition": "HasDomainName",
      "DependsOn": "LoggingBucketPolicy",
      "Properties": {
        "DistributionConfig": {
          "Enabled": true,
          "Comment": {
            "Fn::Sub": "CloudFront distribution for ${DomainName} - ${EnvironmentSuffix}"
          },
          "DefaultRootObject": "index.html",
          "Aliases": {
            "Fn::If": [
              "UseSSL",
              [
                {
                  "Ref": "DomainName"
                },
                {
                  "Fn::Sub": "www.${DomainName}"
                }
              ],
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          "Origins": [
            {
              "Id": "S3Origin",
              "DomainName": {
                "Fn::GetAtt": [
                  "WebsiteBucket",
                  "RegionalDomainName"
                ]
              },
              "S3OriginConfig": {
                "OriginAccessIdentity": ""
              },
              "OriginAccessControlId": {
                "Ref": "CloudFrontOAC"
              }
            }
          ],
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3Origin",
            "ViewerProtocolPolicy": {
              "Fn::If": [
                "UseSSL",
                "redirect-to-https",
                "allow-all"
              ]
            },
            "AllowedMethods": [
              "GET",
              "HEAD",
              "OPTIONS"
            ],
            "CachedMethods": [
              "GET",
              "HEAD"
            ],
            "Compress": true,
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000
          },
          "ViewerCertificate": {
            "Fn::If": [
              "UseSSL",
              {
                "AcmCertificateArn": {
                  "Ref": "ACMCertificateArn"
                },
                "SslSupportMethod": "sni-only",
                "MinimumProtocolVersion": "TLSv1.2_2021"
              },
              {
                "CloudFrontDefaultCertificate": true
              }
            ]
          },
          "HttpVersion": "http2",
          "PriceClass": "PriceClass_100",
          "Logging": {
            "Bucket": {
              "Fn::GetAtt": [
                "LoggingBucket",
                "DomainName"
              ]
            },
            "Prefix": "cloudfront-logs/",
            "IncludeCookies": false
          },
          "CustomErrorResponses": [
            {
              "ErrorCode": 404,
              "ResponseCode": 404,
              "ResponsePagePath": "/error.html",
              "ErrorCachingMinTTL": 300
            },
            {
              "ErrorCode": 403,
              "ResponseCode": 403,
              "ResponsePagePath": "/error.html",
              "ErrorCachingMinTTL": 300
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-cloudfront-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudFrontDistributionNoDomain": {
      "Type": "AWS::CloudFront::Distribution",
      "Condition": "NoDomainName",
      "DependsOn": "LoggingBucketPolicy",
      "Properties": {
        "DistributionConfig": {
          "Enabled": true,
          "Comment": {
            "Fn::Sub": "CloudFront distribution - ${EnvironmentSuffix}"
          },
          "DefaultRootObject": "index.html",
          "Origins": [
            {
              "Id": "S3Origin",
              "DomainName": {
                "Fn::GetAtt": [
                  "WebsiteBucket",
                  "RegionalDomainName"
                ]
              },
              "S3OriginConfig": {
                "OriginAccessIdentity": ""
              },
              "OriginAccessControlId": {
                "Ref": "CloudFrontOAC"
              }
            }
          ],
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3Origin",
            "ViewerProtocolPolicy": {
              "Fn::If": [
                "UseSSL",
                "redirect-to-https",
                "allow-all"
              ]
            },
            "AllowedMethods": [
              "GET",
              "HEAD",
              "OPTIONS"
            ],
            "CachedMethods": [
              "GET",
              "HEAD"
            ],
            "Compress": true,
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000
          },
          "ViewerCertificate": {
            "CloudFrontDefaultCertificate": true
          },
          "HttpVersion": "http2",
          "PriceClass": "PriceClass_100",
          "Logging": {
            "Bucket": {
              "Fn::GetAtt": [
                "LoggingBucket",
                "DomainName"
              ]
            },
            "Prefix": "cloudfront-logs/",
            "IncludeCookies": false
          },
          "CustomErrorResponses": [
            {
              "ErrorCode": 404,
              "ResponseCode": 404,
              "ResponsePagePath": "/error.html",
              "ErrorCachingMinTTL": 300
            },
            {
              "ErrorCode": 403,
              "ResponseCode": 403,
              "ResponsePagePath": "/error.html",
              "ErrorCachingMinTTL": 300
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-cloudfront-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "Route53RecordRoot": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "HasDomainName",
      "Properties": {
        "HostedZoneId": {
          "Ref": "HostedZone"
        },
        "Name": {
          "Ref": "DomainName"
        },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "CloudFrontDistributionSSLWithDomain",
              "DomainName"
            ]
          },
          "HostedZoneId": "Z2FDTNDATAQYW2",
          "EvaluateTargetHealth": false
        }
      }
    },
    "Route53RecordWWW": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "HasDomainName",
      "Properties": {
        "HostedZoneId": {
          "Ref": "HostedZone"
        },
        "Name": {
          "Fn::Sub": "www.${DomainName}"
        },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "CloudFrontDistributionSSLWithDomain",
              "DomainName"
            ]
          },
          "HostedZoneId": "Z2FDTNDATAQYW2",
          "EvaluateTargetHealth": false
        }
      }
    },
    "WebsiteLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/static-website/${AWS::StackName}-${EnvironmentSuffix}"
        },
        "RetentionInDays": 30
      }
    },
    "CloudFront4xxAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${AWS::StackName}-cloudfront-4xx-errors-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when 4xx error rate exceeds 5%",
        "MetricName": "4xxErrorRate",
        "Namespace": "AWS/CloudFront",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DistributionId",
            "Value": {
              "Fn::If": [
                "HasDomainName",
                {
                  "Ref": "CloudFrontDistributionSSLWithDomain"
                },
                {
                  "Ref": "CloudFrontDistributionNoDomain"
                }
              ]
            }
          }
        ]
      }
    },
    "CloudFront5xxAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${AWS::StackName}-cloudfront-5xx-errors-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when 5xx error rate exceeds 1%",
        "MetricName": "5xxErrorRate",
        "Namespace": "AWS/CloudFront",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DistributionId",
            "Value": {
              "Fn::If": [
                "HasDomainName",
                {
                  "Ref": "CloudFrontDistributionSSLWithDomain"
                },
                {
                  "Ref": "CloudFrontDistributionNoDomain"
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "HostedZoneId": {
      "Condition": "HasDomainName",
      "Description": "Route53 Hosted Zone ID",
      "Value": {
        "Ref": "HostedZone"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-HostedZoneId"
        }
      }
    },
    "NameServers": {
      "Condition": "HasDomainName",
      "Description": "Name servers for the hosted zone",
      "Value": {
        "Fn::Join": [
          ", ",
          {
            "Fn::GetAtt": [
              "HostedZone",
              "NameServers"
            ]
          }
        ]
      }
    },
    "WebsiteBucketName": {
      "Description": "S3 bucket hosting website",
      "Value": {
        "Ref": "WebsiteBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WebsiteBucket"
        }
      }
    },
    "WebsiteBucketArn": {
      "Description": "ARN of the website bucket",
      "Value": {
        "Fn::GetAtt": [
          "WebsiteBucket",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WebsiteBucketArn"
        }
      }
    },
    "LoggingBucketName": {
      "Description": "S3 bucket for logs",
      "Value": {
        "Ref": "LoggingBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LoggingBucket"
        }
      }
    },
    "CloudFrontDistributionId": {
      "Description": "CloudFront Distribution ID",
      "Value": {
        "Fn::If": [
          "HasDomainName",
          {
            "Ref": "CloudFrontDistributionSSLWithDomain"
          },
          {
            "Ref": "CloudFrontDistributionNoDomain"
          }
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CloudFrontDistributionId"
        }
      }
    },
    "CloudFrontDomainName": {
      "Description": "CloudFront Distribution Domain Name",
      "Value": {
        "Fn::If": [
          "HasDomainName",
          {
            "Fn::GetAtt": [
              "CloudFrontDistributionSSLWithDomain",
              "DomainName"
            ]
          },
          {
            "Fn::GetAtt": [
              "CloudFrontDistributionNoDomain",
              "DomainName"
            ]
          }
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CloudFrontDomain"
        }
      }
    },
    "WebsiteURL": {
      "Description": "URL of the website",
      "Value": {
        "Fn::If": [
          "HasDomainName",
          {
            "Fn::If": [
              "UseSSL",
              {
                "Fn::Sub": "https://${DomainName}"
              },
              {
                "Fn::Sub": "http://${DomainName}"
              }
            ]
          },
          {
            "Fn::Sub": "https://${CloudFrontDistributionNoDomain.DomainName}"
          }
        ]
      }
    },
    "KMSKeyId": {
      "Description": "KMS Key ID for S3 encryption",
      "Value": {
        "Ref": "S3EncryptionKey"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-KMSKeyId"
        }
      }
    },
    "KMSKeyArn": {
      "Description": "KMS Key ARN for S3 encryption",
      "Value": {
        "Fn::GetAtt": [
          "S3EncryptionKey",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-KMSKeyArn"
        }
      }
    }
  }
}
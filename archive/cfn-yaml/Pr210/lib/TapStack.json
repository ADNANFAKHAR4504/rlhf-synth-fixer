{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-ready AWS infrastructure template with VPC, S3, and IAM components for secure cloud deployment in us-east-1",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "dev",
            "AllowedValues": [
                "dev",
                "stage",
                "prod"
            ],
            "Description": "Environment name for resource tagging and naming conventions",
            "ConstraintDescription": "Must be one of: dev, stage, prod"
        },
        "ProjectName": {
            "Type": "String",
            "Default": "myproject",
            "MinLength": 3,
            "MaxLength": 20,
            "AllowedPattern": "^[a-z0-9]+$",
            "Description": "Project name used for resource naming (lowercase alphanumeric only)",
            "ConstraintDescription": "Must be 3-20 characters, lowercase letters and numbers only"
        }
    },
    "Resources": {
        "ProjectVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-vpc-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Main VPC for project infrastructure"
                    }
                ]
            }
        },
        "ProjectInternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-igw-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Internet gateway for VPC connectivity"
                    }
                ]
            }
        },
        "AttachGateway": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "ProjectVPC"
                },
                "InternetGatewayId": {
                    "Ref": "ProjectInternetGateway"
                }
            }
        },
        "ProjectS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteIncompleteMultipartUploads",
                            "Status": "Enabled",
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 7
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-storage"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Primary storage bucket for project data"
                    }
                ]
            }
        },
        "S3ReadOnlyRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "S3ReadOnlyAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket",
                                        "s3:GetBucketLocation"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ProjectS3Bucket",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ProjectS3Bucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Deny",
                                    "Action": [
                                        "s3:PutObject",
                                        "s3:DeleteObject",
                                        "s3:PutObjectAcl",
                                        "s3:DeleteObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${ProjectS3Bucket.Arn}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "MaxSessionDuration": 3600,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${ProjectName}-s3-readonly-role-${Environment}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Read-only access to project S3 bucket"
                    }
                ]
            }
        },
        "S3ReadOnlyInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "S3ReadOnlyRole"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID for the created VPC",
            "Value": {
                "Ref": "ProjectVPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-VPC-ID"
                }
            }
        },
        "VPCCidrBlock": {
            "Description": "CIDR block of the created VPC",
            "Value": {
                "Fn::GetAtt": [
                    "ProjectVPC",
                    "CidrBlock"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-VPC-CIDR"
                }
            }
        },
        "S3BucketName": {
            "Description": "Name of the created S3 bucket",
            "Value": {
                "Ref": "ProjectS3Bucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-S3-Bucket-Name"
                }
            }
        },
        "S3BucketArn": {
            "Description": "ARN of the created S3 bucket",
            "Value": {
                "Fn::GetAtt": [
                    "ProjectS3Bucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-S3-Bucket-ARN"
                }
            }
        },
        "S3BucketDomainName": {
            "Description": "Domain name of the S3 bucket",
            "Value": {
                "Fn::GetAtt": [
                    "ProjectS3Bucket",
                    "DomainName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-S3-Bucket-Domain"
                }
            }
        },
        "IAMRoleArn": {
            "Description": "ARN of the S3 read-only IAM role",
            "Value": {
                "Fn::GetAtt": [
                    "S3ReadOnlyRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-IAM-Role-ARN"
                }
            }
        },
        "IAMRoleName": {
            "Description": "Name of the S3 read-only IAM role",
            "Value": {
                "Ref": "S3ReadOnlyRole"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-IAM-Role-Name"
                }
            }
        },
        "InstanceProfileArn": {
            "Description": "ARN of the instance profile for EC2 instances",
            "Value": {
                "Fn::GetAtt": [
                    "S3ReadOnlyInstanceProfile",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-${Environment}-Instance-Profile-ARN"
                }
            }
        },
        "StackRegion": {
            "Description": "AWS region where the stack is deployed",
            "Value": {
                "Ref": "AWS::Region"
            }
        },
        "StackName": {
            "Description": "Name of the CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            }
        },
        "TemplateVersion": {
            "Description": "CloudFormation template version",
            "Value": "v1.1"
        }
    }
}
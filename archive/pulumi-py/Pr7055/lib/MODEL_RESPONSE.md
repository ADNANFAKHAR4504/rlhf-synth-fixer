# MODEL_RESPONSE - Initial Generated Code

This is the initial code generated by the LLM, which may contain intentional errors for training purposes.

## File: lib/tap_stack.py

```python
import pulumi
import pulumi_aws as aws
import json
from typing import Dict, List

def create_vpc_infrastructure(environment_suffix: str) -> None:
    """
    Create a production-ready multi-tier VPC architecture with NAT instances.

    Args:
        environment_suffix: Unique suffix for resource naming
    """

    # VPC
    vpc = aws.ec2.Vpc(
        f"payment-vpc-{environment_suffix}",
        cidr_block="10.0.0.0/16",
        enable_dns_hostnames=True,
        enable_dns_support=True,
        tags={
            "Name": f"payment-vpc-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Internet Gateway
    igw = aws.ec2.InternetGateway(
        f"payment-igw-{environment_suffix}",
        vpc_id=vpc.id,
        tags={
            "Name": f"payment-igw-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Availability Zones
    azs = ["us-east-1a", "us-east-1b", "us-east-1c"]

    # Public Subnets
    public_subnets = []
    for i, az in enumerate(azs):
        subnet = aws.ec2.Subnet(
            f"public-subnet-{i+1}-{environment_suffix}",
            vpc_id=vpc.id,
            cidr_block=f"10.0.{i}.0/24",
            availability_zone=az,
            map_public_ip_on_launch=True,
            tags={
                "Name": f"public-subnet-{az}-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi",
                "Tier": "public"
            }
        )
        public_subnets.append(subnet)

    # Private Subnets
    private_subnets = []
    for i, az in enumerate(azs):
        subnet = aws.ec2.Subnet(
            f"private-subnet-{i+1}-{environment_suffix}",
            vpc_id=vpc.id,
            cidr_block=f"10.0.{i+10}.0/24",
            availability_zone=az,
            tags={
                "Name": f"private-subnet-{az}-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi",
                "Tier": "private"
            }
        )
        private_subnets.append(subnet)

    # Database Subnets
    db_subnets = []
    for i, az in enumerate(azs):
        subnet = aws.ec2.Subnet(
            f"db-subnet-{i+1}-{environment_suffix}",
            vpc_id=vpc.id,
            cidr_block=f"10.0.{i+20}.0/24",
            availability_zone=az,
            tags={
                "Name": f"db-subnet-{az}-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi",
                "Tier": "database"
            }
        )
        db_subnets.append(subnet)

    # Security Group for NAT instances
    nat_sg = aws.ec2.SecurityGroup(
        f"nat-sg-{environment_suffix}",
        vpc_id=vpc.id,
        description="Security group for NAT instances",
        ingress=[
            {
                "protocol": "tcp",
                "from_port": 80,
                "to_port": 80,
                "cidr_blocks": ["10.0.0.0/16"]
            },
            {
                "protocol": "tcp",
                "from_port": 443,
                "to_port": 443,
                "cidr_blocks": ["10.0.0.0/16"]
            }
        ],
        egress=[
            {
                "protocol": "-1",
                "from_port": 0,
                "to_port": 0,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        tags={
            "Name": f"nat-sg-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Get latest Amazon Linux 2 AMI
    ami = aws.ec2.get_ami(
        most_recent=True,
        owners=["amazon"],
        filters=[
            {"name": "name", "values": ["amzn2-ami-hvm-*-x86_64-gp2"]},
            {"name": "virtualization-type", "values": ["hvm"]}
        ]
    )

    # NAT Instances
    nat_instances = []
    for i, (subnet, az) in enumerate(zip(public_subnets, azs)):
        nat_instance = aws.ec2.Instance(
            f"nat-instance-{i+1}-{environment_suffix}",
            ami=ami.id,
            instance_type="t3.micro",
            subnet_id=subnet.id,
            source_dest_check=False,
            vpc_security_group_ids=[nat_sg.id],
            user_data="""#!/bin/bash
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
""",
            tags={
                "Name": f"nat-instance-{az}-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi"
            }
        )
        nat_instances.append(nat_instance)

    # Public Route Table
    public_rt = aws.ec2.RouteTable(
        f"prod-public-rt-{environment_suffix}",
        vpc_id=vpc.id,
        routes=[
            {
                "cidr_block": "0.0.0.0/0",
                "gateway_id": igw.id
            }
        ],
        tags={
            "Name": f"prod-public-rt-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Associate public subnets with public route table
    for i, subnet in enumerate(public_subnets):
        aws.ec2.RouteTableAssociation(
            f"public-rta-{i+1}-{environment_suffix}",
            subnet_id=subnet.id,
            route_table_id=public_rt.id
        )

    # Private Route Tables (one per AZ)
    private_rts = []
    for i, (nat_instance, az) in enumerate(zip(nat_instances, azs)):
        rt = aws.ec2.RouteTable(
            f"prod-private-rt-{i+1}-{environment_suffix}",
            vpc_id=vpc.id,
            routes=[
                {
                    "cidr_block": "0.0.0.0/0",
                    "instance_id": nat_instance.id
                }
            ],
            tags={
                "Name": f"prod-private-{az}-rt-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi"
            }
        )
        private_rts.append(rt)

        # Associate private subnet with its route table
        aws.ec2.RouteTableAssociation(
            f"private-rta-{i+1}-{environment_suffix}",
            subnet_id=private_subnets[i].id,
            route_table_id=rt.id
        )

    # Database Route Tables (one per AZ, no internet access)
    db_rts = []
    for i, az in enumerate(azs):
        rt = aws.ec2.RouteTable(
            f"prod-db-rt-{i+1}-{environment_suffix}",
            vpc_id=vpc.id,
            tags={
                "Name": f"prod-db-{az}-rt-{environment_suffix}",
                "Environment": environment_suffix,
                "Project": "payment-processing",
                "ManagedBy": "pulumi"
            }
        )
        db_rts.append(rt)

        # Associate database subnet with its route table
        aws.ec2.RouteTableAssociation(
            f"db-rta-{i+1}-{environment_suffix}",
            subnet_id=db_subnets[i].id,
            route_table_id=rt.id
        )

    # Bastion Security Group
    bastion_sg = aws.ec2.SecurityGroup(
        f"bastion-sg-{environment_suffix}",
        vpc_id=vpc.id,
        description="Security group for bastion hosts",
        ingress=[
            {
                "protocol": "tcp",
                "from_port": 22,
                "to_port": 22,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        egress=[
            {
                "protocol": "-1",
                "from_port": 0,
                "to_port": 0,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        tags={
            "Name": f"bastion-sg-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Application Security Group
    app_sg = aws.ec2.SecurityGroup(
        f"app-sg-{environment_suffix}",
        vpc_id=vpc.id,
        description="Security group for application tier",
        ingress=[
            {
                "protocol": "tcp",
                "from_port": 80,
                "to_port": 80,
                "cidr_blocks": ["0.0.0.0/0"]
            },
            {
                "protocol": "tcp",
                "from_port": 443,
                "to_port": 443,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        egress=[
            {
                "protocol": "-1",
                "from_port": 0,
                "to_port": 0,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        tags={
            "Name": f"app-sg-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Database Security Group
    db_sg = aws.ec2.SecurityGroup(
        f"db-sg-{environment_suffix}",
        vpc_id=vpc.id,
        description="Security group for database tier",
        ingress=[
            {
                "protocol": "tcp",
                "from_port": 3306,
                "to_port": 3306,
                "security_groups": [app_sg.id]
            },
            {
                "protocol": "tcp",
                "from_port": 5432,
                "to_port": 5432,
                "security_groups": [app_sg.id]
            }
        ],
        egress=[
            {
                "protocol": "-1",
                "from_port": 0,
                "to_port": 0,
                "cidr_blocks": ["0.0.0.0/0"]
            }
        ],
        tags={
            "Name": f"db-sg-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # S3 Bucket for VPC Flow Logs
    flow_logs_bucket = aws.s3.Bucket(
        f"vpc-flow-logs-{environment_suffix}",
        bucket=f"vpc-flow-logs-{environment_suffix}",
        server_side_encryption_configuration={
            "rule": {
                "apply_server_side_encryption_by_default": {
                    "sse_algorithm": "AES256"
                }
            }
        },
        lifecycle_rules=[
            {
                "enabled": True,
                "expiration": {
                    "days": 30
                }
            }
        ],
        tags={
            "Name": f"vpc-flow-logs-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # VPC Flow Logs IAM Role
    flow_logs_role = aws.iam.Role(
        f"vpc-flow-logs-role-{environment_suffix}",
        assume_role_policy=json.dumps({
            "Version": "2012-10-17",
            "Statement": [{
                "Effect": "Allow",
                "Principal": {"Service": "vpc-flow-logs.amazonaws.com"},
                "Action": "sts:AssumeRole"
            }]
        }),
        tags={
            "Name": f"vpc-flow-logs-role-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # VPC Flow Logs IAM Policy
    flow_logs_policy = aws.iam.RolePolicy(
        f"vpc-flow-logs-policy-{environment_suffix}",
        role=flow_logs_role.id,
        policy=pulumi.Output.all(flow_logs_bucket.arn).apply(
            lambda args: json.dumps({
                "Version": "2012-10-17",
                "Statement": [{
                    "Effect": "Allow",
                    "Action": [
                        "s3:PutObject",
                        "s3:GetObject",
                        "s3:ListBucket"
                    ],
                    "Resource": [
                        f"{args[0]}/*",
                        args[0]
                    ]
                }]
            })
        )
    )

    # VPC Flow Logs
    flow_log = aws.ec2.FlowLog(
        f"vpc-flow-log-{environment_suffix}",
        vpc_id=vpc.id,
        traffic_type="ALL",
        log_destination_type="s3",
        log_destination=flow_logs_bucket.arn,
        tags={
            "Name": f"vpc-flow-log-{environment_suffix}",
            "Environment": environment_suffix,
            "Project": "payment-processing",
            "ManagedBy": "pulumi"
        }
    )

    # Outputs
    pulumi.export("vpc_id", vpc.id)
    pulumi.export("public_subnet_ids", pulumi.Output.all(*[s.id for s in public_subnets]).apply(lambda ids: json.dumps(ids)))
    pulumi.export("private_subnet_ids", pulumi.Output.all(*[s.id for s in private_subnets]).apply(lambda ids: json.dumps(ids)))
    pulumi.export("db_subnet_ids", pulumi.Output.all(*[s.id for s in db_subnets]).apply(lambda ids: json.dumps(ids)))
    pulumi.export("public_route_table_id", public_rt.id)
    pulumi.export("private_route_table_ids", pulumi.Output.all(*[rt.id for rt in private_rts]).apply(lambda ids: json.dumps(ids)))
    pulumi.export("db_route_table_ids", pulumi.Output.all(*[rt.id for rt in db_rts]).apply(lambda ids: json.dumps(ids)))
    pulumi.export("bastion_sg_id", bastion_sg.id)
    pulumi.export("app_sg_id", app_sg.id)
    pulumi.export("db_sg_id", db_sg.id)
    pulumi.export("nat_instance_ids", pulumi.Output.all(*[n.id for n in nat_instances]).apply(lambda ids: json.dumps(ids)))

# Main execution
environment_suffix = pulumi.Config().get("environmentSuffix") or "dev"
create_vpc_infrastructure(environment_suffix)
```

## File: lib/__init__.py

```python
"""
VPC Infrastructure package for payment processing platform.
"""
```

## File: tap.py

```python
"""
Pulumi entry point for VPC infrastructure deployment.
"""
import pulumi
from lib.tap_stack import create_vpc_infrastructure

# Get environment suffix from Pulumi config
config = pulumi.Config()
environment_suffix = config.get("environmentSuffix") or "dev"

# Create VPC infrastructure
create_vpc_infrastructure(environment_suffix)
```

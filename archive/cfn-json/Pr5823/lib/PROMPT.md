Create an AWS CloudFormation template in JSON for setting up a secure and scalable cloud environment to host a web application that requires high availability and security.

Here are the requirements for the setup:

VPC and Networking: Create a VPC in the us-west-1 region with both public and private subnets across at least 2 Availability Zones (us-west-1a and us-west-1b). Define appropriate CIDR blocks for the VPC and subnets to ensure proper network segmentation. Set up an Internet Gateway and attach it to the VPC to allow internet access from the public subnets. Create a NAT Gateway in the public subnet to enable instances in the private subnet to access the internet for software updates and patches. Define appropriate route tables and associate them with the VPC subnets to ensure correct routing of internal and external traffic. Ensure the public subnets route through the Internet Gateway for outbound traffic, and the private subnets route through the NAT Gateway for outbound traffic.

Network Security: Define security groups that only allow necessary traffic following the least privilege principle. Create a security group for the bastion host in the public subnet that allows SSH access (port 22) from authorized IP addresses only. Create a security group for EC2 instances in the private subnet that allows SSH access only from the bastion host security group. Ensure security groups for the EC2 instances allow traffic from the Application Load Balancer. Create a security group for the RDS instance that allows database traffic only from the EC2 instance security group. Create a security group for the Application Load Balancer that allows HTTP (port 80) and HTTPS (port 443) traffic from the internet. Configure appropriate inbound and outbound rules for all security groups to minimize attack surface.

Load Balancing: Implement a public-facing Application Load Balancer (ALB) that distributes incoming HTTP and HTTPS requests to the EC2 instances. Configure the load balancer to span across the public subnets in multiple Availability Zones for high availability. Create appropriate listeners for HTTP (port 80) and HTTPS (port 443) traffic. Create a target group to register EC2 instances from the Auto Scaling group in the private subnets. Configure health checks on the target group to ensure only healthy instances receive traffic. Set up routing rules to forward traffic from the ALB to the target group.

Auto Scaling and Compute: Deploy a bastion host EC2 instance in the public subnet to provide secure SSH access to instances in the private subnet. Set up an Auto Scaling Group within the private subnets to manage the lifecycle of EC2 instances that host the web application. Configure the Auto Scaling Group with a minimum size of 2 instances and maximum size of 5 instances to ensure high availability and scalability. Use a Launch Template or Launch Configuration with appropriate instance type and the latest Amazon Machine Image (AMI). Configure scaling policies to automatically adjust the number of instances based on demand. Ensure all EC2 instances in the Auto Scaling Group are registered with the Application Load Balancer target group. Enable detailed monitoring using CloudWatch for all EC2 instances to track performance metrics.

Database and Storage: Implement a Multi-AZ RDS deployment for high availability within a private subnet. Configure the RDS instance with appropriate database engine, instance class, storage type, and allocated storage. Enable automated backups and set an appropriate backup retention period. Ensure the RDS instance is deployed across multiple Availability Zones for failover support. Configure the RDS security group to allow connections only from the EC2 instance security group. Create a secure S3 bucket for application assets with server-side encryption enabled using AWS-managed keys (SSE-S3) or AWS KMS keys. Enable versioning on the S3 bucket to maintain multiple variants of objects for data protection and recovery. Configure appropriate bucket policies and access controls to restrict access to authorized users and services only.

Application Services: Provision DynamoDB tables with on-demand capacity mode to automatically scale read and write throughput based on application demand. Define appropriate table names, partition keys, and sort keys based on application requirements. Enable encryption at rest for DynamoDB tables to protect sensitive data. Set up SQS queues for application decoupling to enable asynchronous communication between application components. Configure queue properties such as message retention period, visibility timeout, and dead-letter queues for handling failed messages. Use standard or FIFO queues based on application requirements for message ordering and delivery.

IAM Roles and Policies: Create IAM roles with the least privilege principle to grant necessary permissions to AWS resources. Create an IAM role for EC2 instances that allows access to required AWS services such as S3, DynamoDB, SQS, CloudWatch, and Systems Manager. Define IAM policies that are tightly scoped to only the required actions and resources. Attach the IAM role to EC2 instances through an instance profile in the Launch Template. Create appropriate IAM roles and policies for RDS enhanced monitoring if required. Ensure all IAM roles follow security best practices and comply with organizational policies.

Logging and Monitoring: Enable detailed monitoring using CloudWatch for all EC2 instances to collect metrics at 1-minute intervals. Create CloudWatch alarms for critical metrics such as high CPU utilization on EC2 instances, unhealthy targets in the load balancer, Auto Scaling activities, and database performance metrics. Set up CloudWatch Logs to capture application logs, system logs, and AWS service logs for troubleshooting and auditing. Enable VPC Flow Logs to capture information about IP traffic going to and from network interfaces in the VPC. Enable RDS enhanced monitoring and CloudWatch Logs integration for database performance insights.

Template Features: The CloudFormation template should be parameterized to allow easy customization without editing the template directly. Use parameters for configurable values such as instance types, SSH key pair names, S3 bucket names, database credentials, CIDR blocks, and availability zones. Include appropriate default values and constraints for parameters to ensure valid inputs. Use CloudFormation intrinsic functions such as Ref, GetAtt, Sub, and Join to dynamically reference resources and construct values. Ensure all resources are deployed in the us-west-1 region. Include an Outputs section to display important resource identifiers after deployment including VPC ID, subnet IDs, bastion host public IP, Application Load Balancer DNS name, RDS endpoint, S3 bucket name, DynamoDB table names, SQS queue URLs, and Auto Scaling Group name. Organize the template with clear sections for Parameters, Resources, and Outputs for maintainability and readability.

Please ensure the final JSON template is valid and would pass standard AWS CloudFormation validation tests.

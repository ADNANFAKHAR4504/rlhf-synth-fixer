Create an AWS CloudFormation template in JSON to manage and enforce security configurations for a serverless application running on AWS.

Here are the requirements for the setup:

VPC and Networking: Create a VPC with both a public subnet and a private subnet in the us-west-1 region to ensure proper isolation of resources. The public subnet should be used for resources that require direct internet access, while the private subnet should host resources that do not require direct external connectivity. Set up an Internet Gateway and attach it to the VPC to allow internet access from the public subnet. Create a NAT Gateway in the public subnet with an Elastic IP assigned to it to allow outbound internet access for resources in the private subnet while maintaining their isolation from inbound internet traffic. Define appropriate route tables and associate them with the VPC subnets to ensure correct routing of internal and external traffic. Ensure the public subnet routes through the Internet Gateway for outbound traffic, and the private subnet routes through the NAT Gateway for outbound traffic.

Security Groups and Network Access Control: Define Security Group policies that restrict SSH access on port 22 to EC2 instances from only a specific IP address, adhering to the principle of least privilege. Ensure that all Security Groups are configured to allow only the minimum necessary traffic between resources and from external sources. Create appropriate security controls to prevent unauthorized access to any resources within the VPC. For Lambda functions, ensure all traffic occurs through API Gateway rather than direct invocation to maintain proper access control and security.

S3 Storage and Encryption: Create a single S3 bucket for securely storing application data with server-side encryption enabled. Configure the bucket with appropriate encryption settings to ensure all data stored at rest is encrypted using AWS-managed keys or customer-managed keys. Apply bucket policies that enforce encryption in transit by requiring HTTPS for all data transfers to and from the bucket. Ensure the bucket is configured with appropriate access controls, versioning if needed, and follows AWS security best practices for data protection and compliance.

Lambda Functions and IAM Roles: Configure Lambda functions with IAM execution roles that strictly adhere to the principle of least privilege. Create IAM policies that grant only the specific permissions required for each Lambda function to perform its designated tasks, such as writing logs to CloudWatch Logs, accessing the S3 bucket as needed, and invoking other AWS services if required. Ensure that IAM roles do not use or reference root account privileges in any capacity. The Lambda execution roles should be tightly scoped to specific actions and resources, avoiding wildcards or overly broad permissions. Attach the IAM role to the Lambda functions with appropriate trust policies that allow the Lambda service to assume the role.

API Gateway Integration: Integrate Lambda functions with API Gateway to provide secure HTTP access to the serverless application. Configure API Gateway to enforce request validation to ensure all incoming requests meet specified criteria before being forwarded to Lambda functions, including validation of request parameters, headers, and body content. Deploy the API Gateway in a production stage named 'prod' with appropriate stage settings, throttling configurations, and API keys if needed. Ensure all traffic to Lambda functions flows through the API Gateway, preventing direct invocation of Lambda functions from external sources. Configure API Gateway with proper logging and monitoring enabled to track all API requests, responses, and errors for security auditing and troubleshooting purposes.

CloudTrail Auditing: Enable AWS CloudTrail across all regions to capture all management events and API calls for comprehensive auditing purposes. Configure CloudTrail to log all events including read and write operations performed on AWS resources to ensure complete visibility into all actions taken within the AWS account. Set up CloudTrail as a multi-region trail to capture activities across all AWS regions, not just the primary deployment region. Configure CloudTrail to deliver log files to a secure S3 bucket location with appropriate access controls and encryption enabled. Ensure CloudTrail captures management events, data events as needed, and insights events to provide comprehensive audit coverage for security and compliance requirements.

CloudWatch Logs and Monitoring: Direct all log data to CloudWatch Logs for centralized monitoring and analysis. Configure Lambda functions to send their execution logs to CloudWatch Log Groups with appropriate retention policies to balance storage costs with audit requirements. Set up CloudWatch Logs to receive VPC Flow Logs for monitoring network traffic patterns and detecting potential security issues. Configure API Gateway to send access logs and execution logs to CloudWatch Logs to track all API requests and responses. Ensure all logging is configured with appropriate log retention periods, access controls, and encryption settings to maintain security and compliance requirements while enabling effective troubleshooting and monitoring.

Resource Tagging: Ensure all resources are tagged using tags for resource organization and cost allocation tracking. Tag all resources including VPC components, subnets, S3 buckets, Lambda functions, API Gateway, IAM roles, CloudTrail, and EC2 instances with appropriate key-value pairs. Use tags such as Environment tag, Project tag, Owner tag, and CostCenter tag to enable detailed cost tracking, resource management, and organizational visibility. Apply consistent tagging across all resources to facilitate accurate cost allocation reports, resource categorization, and automated resource management policies.

Data Encryption: Apply encryption for all data at rest and in transit throughout the infrastructure. Enable server-side encryption on the S3 bucket to protect stored data using AWS-managed encryption keys. Configure Lambda functions to use encrypted environment variables when storing sensitive configuration data or secrets. Ensure API Gateway uses HTTPS endpoints to encrypt data in transit between clients and the API, preventing man-in-the-middle attacks and data interception. Configure all data transfers between AWS services to use encrypted connections and secure protocols. Enable encryption for CloudWatch Logs to protect log data at rest and ensure sensitive information in logs is properly secured.

Template Features: Use CloudFormation to define the entire infrastructure as code using JSON syntax. Ensure all resources are deployed in the us-west-1 region using AWS account ID 123456789012. Structure the template with an appropriate Parameters section for configurable values such as the specific IP address for SSH access, resource tags, and other environment-specific settings to make the template flexible and reusable across different environments. Include a Resources section that defines all AWS resources with proper dependencies and configurations. Include an Outputs section to display important resource identifiers and endpoints after deployment, such as VPC ID, subnet IDs, S3 bucket name, Lambda function ARNs, API Gateway endpoint URL, and CloudTrail trail name for easy reference and integration with other systems.

Please ensure the final JSON template is valid and would pass standard AWS CloudFormation validation tests.

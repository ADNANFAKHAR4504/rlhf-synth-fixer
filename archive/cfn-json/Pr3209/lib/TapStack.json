{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "TAP Stack - Production-ready serverless backend with Lambda, API Gateway, DynamoDB, and monitoring",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Environment Configuration"
          },
          "Parameters": [
            "EnvironmentSuffix",
            "ProjectName"
          ]
        },
        {
          "Label": {
            "default": "Monitoring Configuration"
          },
          "Parameters": [
            "AlertEmail"
          ]
        },
        {
          "Label": {
            "default": "Lambda Configuration"
          },
          "Parameters": [
            "LambdaMemorySize",
            "LambdaTimeout"
          ]
        },
        {
          "Label": {
            "default": "DynamoDB Configuration"
          },
          "Parameters": [
            "DeletionProtectionEnabled",
            "PointInTimeRecoveryEnabled"
          ]
        }
      ]
    }
  },
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "AllowedPattern": "^[a-zA-Z0-9]+$",
      "ConstraintDescription": "Must contain only alphanumeric characters"
    },
    "ProjectName": {
      "Type": "String",
      "Default": "tap",
      "MinLength": 1,
      "MaxLength": 50,
      "AllowedPattern": "^[a-z0-9-]+$",
      "Description": "Project name (lowercase, alphanumeric and hyphens only)"
    },
    "AlertEmail": {
      "Type": "String",
      "Default": "",
      "Description": "Email address for CloudWatch alarm notifications (optional)"
    },
    "DeletionProtectionEnabled": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Description": "Enable deletion protection for DynamoDB table"
    },
    "PointInTimeRecoveryEnabled": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": [
        "true",
        "false"
      ],
      "Description": "Enable point-in-time recovery for DynamoDB table"
    },
    "LambdaMemorySize": {
      "Type": "Number",
      "Default": 256,
      "MinValue": 128,
      "MaxValue": 10240,
      "Description": "Memory size for Lambda functions (MB)"
    },
    "LambdaTimeout": {
      "Type": "Number",
      "Default": 30,
      "MinValue": 1,
      "MaxValue": 900,
      "Description": "Timeout for Lambda functions (seconds)"
    }
  },
  "Conditions": {
    "EnableDeletionProtection": {
      "Fn::Equals": [
        {
          "Ref": "DeletionProtectionEnabled"
        },
        "true"
      ]
    },
    "EnablePointInTimeRecovery": {
      "Fn::Equals": [
        {
          "Ref": "PointInTimeRecoveryEnabled"
        },
        "true"
      ]
    },
    "HasAlertEmail": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AlertEmail"
            },
            ""
          ]
        }
      ]
    }
  },
  "Resources": {
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:GetItem",
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:DeleteItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "TurnAroundPromptTable",
                        "Arn"
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "sqs:SendMessage"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "DeadLetterQueue",
                        "Arn"
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:Decrypt",
                    "kms:GenerateDataKey"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                      ]
                    }
                  ]
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "DeadLetterQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "QueueName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dlq"
        },
        "KmsMasterKeyId": {
          "Ref": "KMSKey"
        },
        "MessageRetentionPeriod": 1209600,
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "KMSKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {
          "Fn::Sub": "KMS key for ${ProjectName}-${EnvironmentSuffix} TAP application"
        },
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow DynamoDB to use the key",
              "Effect": "Allow",
              "Principal": {
                "Service": "dynamodb.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            },
            {
              "Sid": "Allow SNS to use the key",
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "KMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/${ProjectName}-${EnvironmentSuffix}"
        },
        "TargetKeyId": {
          "Ref": "KMSKey"
        }
      }
    },
    "TaskFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-task-handler"
        },
        "Runtime": "nodejs22.x",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "LambdaExecutionRole",
            "Arn"
          ]
        },
        "MemorySize": {
          "Ref": "LambdaMemorySize"
        },
        "Timeout": {
          "Ref": "LambdaTimeout"
        },
        "DeadLetterConfig": {
          "TargetArn": {
            "Fn::GetAtt": [
              "DeadLetterQueue",
              "Arn"
            ]
          }
        },
        "Environment": {
          "Variables": {
            "DYNAMODB_TABLE_NAME": {
              "Ref": "TurnAroundPromptTable"
            },
            "ENVIRONMENT": {
              "Ref": "EnvironmentSuffix"
            }
          }
        },
        "KmsKeyArn": {
          "Fn::GetAtt": [
            "KMSKey",
            "Arn"
          ]
        },
        "Code": {
          "ZipFile": "const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');\\nconst { DynamoDBDocumentClient, ScanCommand, PutCommand, GetCommand } = require('@aws-sdk/lib-dynamodb');\\n\\nconst client = new DynamoDBClient({});\\nconst dynamodb = DynamoDBDocumentClient.from(client);\\n\\nexports.handler = async (event, context) => {\\n  console.log('Received event:', JSON.stringify(event, null, 2));\\n  \\n  const tableName = process.env.DYNAMODB_TABLE_NAME;\\n  const httpMethod = event.httpMethod;\\n  const path = event.path;\\n  \\n  try {\\n    let response;\\n    \\n    if (httpMethod === 'GET' && path === '/tasks') {\\n      const result = await dynamodb.send(new ScanCommand({\\n        TableName: tableName\\n      }));\\n      \\n      response = {\\n        statusCode: 200,\\n        headers: {\\n          'Content-Type': 'application/json',\\n          'Access-Control-Allow-Origin': '*'\\n        },\\n        body: JSON.stringify({\\n          tasks: result.Items,\\n          count: result.Count\\n        })\\n      };\\n    } else if (httpMethod === 'POST' && path === '/tasks') {\\n      const requestBody = JSON.parse(event.body);\\n      const taskId = context.awsRequestId;\\n      const timestamp = new Date().toISOString();\\n      \\n      const item = {\\n        id: taskId,\\n        prompt_text: requestBody.prompt_text,\\n        task_type: requestBody.task_type || 'general',\\n        priority: requestBody.priority || 'medium',\\n        status: 'pending',\\n        created_at: timestamp,\\n        updated_at: timestamp,\\n        ttl: Math.floor(Date.now() / 1000) + 86400 * 30\\n      };\\n      \\n      await dynamodb.send(new PutCommand({\\n        TableName: tableName,\\n        Item: item\\n      }));\\n      \\n      response = {\\n        statusCode: 201,\\n        headers: {\\n          'Content-Type': 'application/json',\\n          'Access-Control-Allow-Origin': '*'\\n        },\\n        body: JSON.stringify({\\n          message: 'Task created successfully',\\n          task: item\\n        })\\n      };\\n    } else if (httpMethod === 'GET' && path.startsWith('/tasks/')) {\\n      const taskId = path.split('/')[2];\\n      \\n      const result = await dynamodb.send(new GetCommand({\\n        TableName: tableName,\\n        Key: { id: taskId }\\n      }));\\n      \\n      if (!result.Item) {\\n        response = {\\n          statusCode: 404,\\n          headers: {\\n            'Content-Type': 'application/json',\\n            'Access-Control-Allow-Origin': '*'\\n          },\\n          body: JSON.stringify({ message: 'Task not found' })\\n        };\\n      } else {\\n        response = {\\n          statusCode: 200,\\n          headers: {\\n            'Content-Type': 'application/json',\\n            'Access-Control-Allow-Origin': '*'\\n          },\\n          body: JSON.stringify({ task: result.Item })\\n        };\\n      }\\n    } else {\\n      response = {\\n        statusCode: 404,\\n        headers: {\\n          'Content-Type': 'application/json',\\n          'Access-Control-Allow-Origin': '*'\\n        },\\n        body: JSON.stringify({ message: 'Route not found' })\\n      };\\n    }\\n    \\n    return response;\\n  } catch (error) {\\n    console.error('Error:', error);\\n    \\n    return {\\n      statusCode: 500,\\n      headers: {\\n        'Content-Type': 'application/json',\\n        'Access-Control-Allow-Origin': '*'\\n      },\\n      body: JSON.stringify({\\n        message: 'Internal server error',\\n        error: error.message\\n      })\\n    };\\n  }\\n};"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "TurnAroundPromptTable": {
      "Type": "AWS::DynamoDB::Table",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TableName": {
          "Fn::Sub": "TurnAroundPromptTable${EnvironmentSuffix}"
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "id",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "id",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "DeletionProtectionEnabled": {
          "Fn::If": [
            "EnableDeletionProtection",
            true,
            false
          ]
        },
        "SSESpecification": {
          "SSEEnabled": true,
          "SSEType": "KMS",
          "KMSMasterKeyId": {
            "Ref": "KMSKey"
          }
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": {
            "Fn::If": [
              "EnablePointInTimeRecovery",
              true,
              false
            ]
          }
        },
        "StreamSpecification": {
          "StreamViewType": "NEW_AND_OLD_IMAGES"
        },
        "TimeToLiveSpecification": {
          "AttributeName": "ttl",
          "Enabled": true
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "SNSTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-alerts"
        },
        "DisplayName": {
          "Fn::Sub": "${ProjectName} ${EnvironmentSuffix} Alerts"
        },
        "KmsMasterKeyId": {
          "Ref": "KMSKey"
        },
        "Subscription": {
          "Fn::If": [
            "HasAlertEmail",
            [
              {
                "Endpoint": {
                  "Ref": "AlertEmail"
                },
                "Protocol": "email"
              }
            ],
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "DynamoDBThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dynamodb-throttles"
        },
        "AlarmDescription": "Alarm when DynamoDB throttles exceed threshold",
        "MetricName": "UserErrors",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": {
              "Ref": "TurnAroundPromptTable"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "SNSTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "DynamoDBSystemErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dynamodb-system-errors"
        },
        "AlarmDescription": "Alarm when DynamoDB system errors occur",
        "MetricName": "SystemErrors",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": {
              "Ref": "TurnAroundPromptTable"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "SNSTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "DynamoDBReadThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dynamodb-read-throttle"
        },
        "AlarmDescription": "Alarm when DynamoDB read throttles occur",
        "MetricName": "ReadThrottleEvents",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": {
              "Ref": "TurnAroundPromptTable"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "SNSTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "DynamoDBWriteThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dynamodb-write-throttle"
        },
        "AlarmDescription": "Alarm when DynamoDB write throttles occur",
        "MetricName": "WriteThrottleEvents",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": {
              "Ref": "TurnAroundPromptTable"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "SNSTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "CloudWatchDashboard": {
      "Type": "AWS::CloudWatch::Dashboard",
      "Properties": {
        "DashboardName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-dashboard"
        },
        "DashboardBody": {
          "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"ConsumedReadCapacityUnits\", {\"stat\": \"Sum\", \"label\": \"Read Capacity\"}],\n          [\".\", \"ConsumedWriteCapacityUnits\", {\"stat\": \"Sum\", \"label\": \"Write Capacity\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Capacity Units\",\n        \"period\": 300,\n        \"dimensions\": {\n          \"TableName\": \"${TurnAroundPromptTable}\"\n        }\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"UserErrors\", {\"stat\": \"Sum\", \"label\": \"User Errors\"}],\n          [\".\", \"SystemErrors\", {\"stat\": \"Sum\", \"label\": \"System Errors\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Errors\",\n        \"period\": 300,\n        \"dimensions\": {\n          \"TableName\": \"${TurnAroundPromptTable}\"\n        }\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"ReadThrottleEvents\", {\"stat\": \"Sum\", \"label\": \"Read Throttles\"}],\n          [\".\", \"WriteThrottleEvents\", {\"stat\": \"Sum\", \"label\": \"Write Throttles\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Throttle Events\",\n        \"period\": 300,\n        \"dimensions\": {\n          \"TableName\": \"${TurnAroundPromptTable}\"\n        }\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"SuccessfulRequestLatency\", {\"stat\": \"Average\", \"label\": \"Avg Latency\"}],\n          [\".\", \".\", {\"stat\": \"Maximum\", \"label\": \"Max Latency\"}]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Latency\",\n        \"period\": 300,\n        \"dimensions\": {\n          \"TableName\": \"${TurnAroundPromptTable}\"\n        },\n        \"yAxis\": {\n          \"left\": {\n            \"min\": 0\n          }\n        }\n      }\n    }\n  ]\n}"
        }
      }
    },
    "RestApi": {
      "Type": "AWS::ApiGateway::RestApi",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-api"
        },
        "Description": "TAP Stack REST API for task management",
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL"
          ]
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "TasksResource": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": [
            "RestApi",
            "RootResourceId"
          ]
        },
        "PathPart": "tasks",
        "RestApiId": {
          "Ref": "RestApi"
        }
      }
    },
    "TaskIdResource": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "ParentId": {
          "Ref": "TasksResource"
        },
        "PathPart": "{id}",
        "RestApiId": {
          "Ref": "RestApi"
        }
      }
    },
    "TasksGetMethod": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "GET",
        "ResourceId": {
          "Ref": "TasksResource"
        },
        "RestApiId": {
          "Ref": "RestApi"
        },
        "Integration": {
          "Type": "AWS_PROXY",
          "IntegrationHttpMethod": "POST",
          "Uri": {
            "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TaskFunction.Arn}/invocations"
          }
        },
        "MethodResponses": [
          {
            "StatusCode": "200"
          }
        ]
      }
    },
    "TasksPostMethod": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "POST",
        "ResourceId": {
          "Ref": "TasksResource"
        },
        "RestApiId": {
          "Ref": "RestApi"
        },
        "Integration": {
          "Type": "AWS_PROXY",
          "IntegrationHttpMethod": "POST",
          "Uri": {
            "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TaskFunction.Arn}/invocations"
          }
        },
        "MethodResponses": [
          {
            "StatusCode": "201"
          }
        ]
      }
    },
    "TaskGetMethod": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "GET",
        "ResourceId": {
          "Ref": "TaskIdResource"
        },
        "RestApiId": {
          "Ref": "RestApi"
        },
        "Integration": {
          "Type": "AWS_PROXY",
          "IntegrationHttpMethod": "POST",
          "Uri": {
            "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TaskFunction.Arn}/invocations"
          }
        },
        "MethodResponses": [
          {
            "StatusCode": "200"
          }
        ]
      }
    },
    "LambdaApiGatewayPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "TaskFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*"
        }
      }
    },
    "ApiDeployment": {
      "Type": "AWS::ApiGateway::Deployment",
      "DependsOn": [
        "TasksGetMethod",
        "TasksPostMethod",
        "TaskGetMethod"
      ],
      "Properties": {
        "RestApiId": {
          "Ref": "RestApi"
        },
        "Description": "Production deployment"
      }
    },
    "ApiStage": {
      "Type": "AWS::ApiGateway::Stage",
      "Properties": {
        "RestApiId": {
          "Ref": "RestApi"
        },
        "DeploymentId": {
          "Ref": "ApiDeployment"
        },
        "StageName": "prod",
        "Description": "Production stage",
        "MethodSettings": [
          {
            "ResourcePath": "/*",
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "DataTraceEnabled": false,
            "MetricsEnabled": true
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    },
    "UsagePlan": {
      "Type": "AWS::ApiGateway::UsagePlan",
      "Properties": {
        "UsagePlanName": {
          "Fn::Sub": "${ProjectName}-${EnvironmentSuffix}-usage-plan"
        },
        "Description": "Usage plan for TAP API",
        "Throttle": {
          "RateLimit": 1000,
          "BurstLimit": 2000
        },
        "Quota": {
          "Limit": 10000,
          "Period": "DAY"
        },
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "RestApi"
            },
            "Stage": {
              "Ref": "ApiStage"
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "ManagedBy",
            "Value": "CloudFormation"
          }
        ]
      }
    }
  },
  "Outputs": {
    "TurnAroundPromptTableName": {
      "Description": "Name of the DynamoDB table",
      "Value": {
        "Ref": "TurnAroundPromptTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableName"
        }
      }
    },
    "TurnAroundPromptTableArn": {
      "Description": "ARN of the DynamoDB table",
      "Value": {
        "Fn::GetAtt": [
          "TurnAroundPromptTable",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableArn"
        }
      }
    },
    "TurnAroundPromptTableStreamArn": {
      "Description": "Stream ARN of the DynamoDB table",
      "Value": {
        "Fn::GetAtt": [
          "TurnAroundPromptTable",
          "StreamArn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableStreamArn"
        }
      }
    },
    "KMSKeyId": {
      "Description": "KMS Key ID for encryption",
      "Value": {
        "Ref": "KMSKey"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-KMSKeyId"
        }
      }
    },
    "KMSKeyArn": {
      "Description": "KMS Key ARN for encryption",
      "Value": {
        "Fn::GetAtt": [
          "KMSKey",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-KMSKeyArn"
        }
      }
    },
    "SNSTopicArn": {
      "Description": "SNS Topic ARN for alerts",
      "Value": {
        "Ref": "SNSTopic"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SNSTopicArn"
        }
      }
    },
    "DashboardURL": {
      "Description": "CloudWatch Dashboard URL",
      "Value": {
        "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${ProjectName}-${EnvironmentSuffix}-dashboard"
      }
    },
    "StackName": {
      "Description": "Name of this CloudFormation stack",
      "Value": {
        "Ref": "AWS::StackName"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackName"
        }
      }
    },
    "EnvironmentSuffix": {
      "Description": "Environment suffix used for this deployment",
      "Value": {
        "Ref": "EnvironmentSuffix"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
        }
      }
    },
    "ApiUrl": {
      "Description": "API Gateway endpoint URL",
      "Value": {
        "Fn::Sub": "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ApiUrl"
        }
      }
    },
    "LambdaFunctionArn": {
      "Description": "Lambda function ARN",
      "Value": {
        "Fn::GetAtt": [
          "TaskFunction",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaFunctionArn"
        }
      }
    },
    "DeadLetterQueueUrl": {
      "Description": "Dead Letter Queue URL",
      "Value": {
        "Ref": "DeadLetterQueue"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DeadLetterQueueUrl"
        }
      }
    }
  }
}
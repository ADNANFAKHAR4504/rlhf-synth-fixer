{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Loan Processing Application Infrastructure with ECS Fargate, Aurora Serverless v2, ALB, and S3",
    "Parameters": {
      "EnvironmentSuffix": {
        "Type": "String",
        "Description": "Unique suffix to append to resource names for environment isolation",
        "Default": "dev",
        "AllowedPattern": "[a-z0-9-]+",
        "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
      },
      "ContainerImage": {
        "Type": "String",
        "Description": "Docker image URI for the loan processing application",
        "Default": "nginx:latest"
      },
      "CertificateArn": {
        "Type": "String",
        "Description": "ARN of ACM certificate for HTTPS listener",
        "Default": ""
      },
      "DBMasterUsername": {
        "Type": "String",
        "Description": "Master username for Aurora PostgreSQL",
        "Default": "dbadmin",
        "NoEcho": true
      },
      "DBMasterPassword": {
        "Type": "String",
        "Description": "Master password for Aurora PostgreSQL (min 8 characters). Note: For production, use AWS Secrets Manager and reference via dynamic reference.",
        "Default": "TempPassword123!",
        "NoEcho": true,
        "MinLength": 8
      },
      "DBSecretName": {
        "Type": "String",
        "Description": "Name of the Secrets Manager secret containing database credentials. If provided, will be used instead of parameters.",
        "Default": ""
      },
      "DesiredTaskCount": {
        "Type": "Number",
        "Description": "Desired number of ECS tasks to run",
        "Default": 2,
        "MinValue": 1
      },
      "MinTaskCount": {
        "Type": "Number",
        "Description": "Minimum number of ECS tasks for auto-scaling",
        "Default": 2,
        "MinValue": 1
      },
      "MaxTaskCount": {
        "Type": "Number",
        "Description": "Maximum number of ECS tasks for auto-scaling",
        "Default": 10,
        "MinValue": 1
      }
    },
    "Conditions": {
      "HasCertificate": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CertificateArn"
              },
              ""
            ]
          }
        ]
      },
      "UseSecretsManager": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "DBSecretName"
              },
              ""
            ]
          }
        ]
      }
    },
    "Resources": {
      "VPC": {
        "Type": "AWS::EC2::VPC",
        "Properties": {
          "CidrBlock": "10.0.0.0/16",
          "EnableDnsHostnames": true,
          "EnableDnsSupport": true,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "vpc-loan-processing-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "InternetGateway": {
        "Type": "AWS::EC2::InternetGateway",
        "Properties": {
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "igw-loan-processing-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "AttachGateway": {
        "Type": "AWS::EC2::VPCGatewayAttachment",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "InternetGatewayId": {
            "Ref": "InternetGateway"
          }
        }
      },
      "PublicSubnet1": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.1.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              0,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "MapPublicIpOnLaunch": true,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "public-subnet-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PublicSubnet2": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.2.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              1,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "MapPublicIpOnLaunch": true,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "public-subnet-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PublicSubnet3": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.3.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              2,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "MapPublicIpOnLaunch": true,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "public-subnet-3-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateSubnet1": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.11.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              0,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-subnet-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateSubnet2": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.12.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              1,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-subnet-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateSubnet3": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrBlock": "10.0.13.0/24",
          "AvailabilityZone": {
            "Fn::Select": [
              2,
              {
                "Fn::GetAZs": ""
              }
            ]
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-subnet-3-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PublicRouteTable": {
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "public-rt-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PublicRoute": {
        "Type": "AWS::EC2::Route",
        "DependsOn": "AttachGateway",
        "Properties": {
          "RouteTableId": {
            "Ref": "PublicRouteTable"
          },
          "DestinationCidrBlock": "0.0.0.0/0",
          "GatewayId": {
            "Ref": "InternetGateway"
          }
        }
      },
      "PublicSubnet1RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PublicSubnet1"
          },
          "RouteTableId": {
            "Ref": "PublicRouteTable"
          }
        }
      },
      "PublicSubnet2RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PublicSubnet2"
          },
          "RouteTableId": {
            "Ref": "PublicRouteTable"
          }
        }
      },
      "PublicSubnet3RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PublicSubnet3"
          },
          "RouteTableId": {
            "Ref": "PublicRouteTable"
          }
        }
      },
      "NatGateway1EIP": {
        "Type": "AWS::EC2::EIP",
        "DependsOn": "AttachGateway",
        "Properties": {
          "Domain": "vpc",
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-eip-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "NatGateway2EIP": {
        "Type": "AWS::EC2::EIP",
        "DependsOn": "AttachGateway",
        "Properties": {
          "Domain": "vpc",
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-eip-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "NatGateway3EIP": {
        "Type": "AWS::EC2::EIP",
        "DependsOn": "AttachGateway",
        "Properties": {
          "Domain": "vpc",
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-eip-3-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "NatGateway1": {
        "Type": "AWS::EC2::NatGateway",
        "Properties": {
          "AllocationId": {
            "Fn::GetAtt": [
              "NatGateway1EIP",
              "AllocationId"
            ]
          },
          "SubnetId": {
            "Ref": "PublicSubnet1"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-gateway-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "NatGateway2": {
        "Type": "AWS::EC2::NatGateway",
        "Properties": {
          "AllocationId": {
            "Fn::GetAtt": [
              "NatGateway2EIP",
              "AllocationId"
            ]
          },
          "SubnetId": {
            "Ref": "PublicSubnet2"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-gateway-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "NatGateway3": {
        "Type": "AWS::EC2::NatGateway",
        "Properties": {
          "AllocationId": {
            "Fn::GetAtt": [
              "NatGateway3EIP",
              "AllocationId"
            ]
          },
          "SubnetId": {
            "Ref": "PublicSubnet3"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "nat-gateway-3-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateRouteTable1": {
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-rt-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateRoute1": {
        "Type": "AWS::EC2::Route",
        "Properties": {
          "RouteTableId": {
            "Ref": "PrivateRouteTable1"
          },
          "DestinationCidrBlock": "0.0.0.0/0",
          "NatGatewayId": {
            "Ref": "NatGateway1"
          }
        }
      },
      "PrivateSubnet1RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PrivateSubnet1"
          },
          "RouteTableId": {
            "Ref": "PrivateRouteTable1"
          }
        }
      },
      "PrivateRouteTable2": {
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-rt-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateRoute2": {
        "Type": "AWS::EC2::Route",
        "Properties": {
          "RouteTableId": {
            "Ref": "PrivateRouteTable2"
          },
          "DestinationCidrBlock": "0.0.0.0/0",
          "NatGatewayId": {
            "Ref": "NatGateway2"
          }
        }
      },
      "PrivateSubnet2RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PrivateSubnet2"
          },
          "RouteTableId": {
            "Ref": "PrivateRouteTable2"
          }
        }
      },
      "PrivateRouteTable3": {
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "private-rt-3-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "PrivateRoute3": {
        "Type": "AWS::EC2::Route",
        "Properties": {
          "RouteTableId": {
            "Ref": "PrivateRouteTable3"
          },
          "DestinationCidrBlock": "0.0.0.0/0",
          "NatGatewayId": {
            "Ref": "NatGateway3"
          }
        }
      },
      "PrivateSubnet3RouteTableAssociation": {
        "Type": "AWS::EC2::SubnetRouteTableAssociation",
        "Properties": {
          "SubnetId": {
            "Ref": "PrivateSubnet3"
          },
          "RouteTableId": {
            "Ref": "PrivateRouteTable3"
          }
        }
      },
      "ALBSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupName": {
            "Fn::Sub": "alb-sg-${EnvironmentSuffix}"
          },
          "GroupDescription": "Security group for Application Load Balancer",
          "VpcId": {
            "Ref": "VPC"
          },
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "CidrIp": "0.0.0.0/0",
              "Description": "Allow HTTP traffic"
            },
            {
              "IpProtocol": "tcp",
              "FromPort": 443,
              "ToPort": 443,
              "CidrIp": "0.0.0.0/0",
              "Description": "Allow HTTPS traffic"
            }
          ],
          "SecurityGroupEgress": [
            {
              "IpProtocol": "-1",
              "CidrIp": "0.0.0.0/0",
              "Description": "Allow all outbound traffic"
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "alb-sg-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ECSTaskSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupName": {
            "Fn::Sub": "ecs-task-sg-${EnvironmentSuffix}"
          },
          "GroupDescription": "Security group for ECS tasks",
          "VpcId": {
            "Ref": "VPC"
          },
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "SourceSecurityGroupId": {
                "Ref": "ALBSecurityGroup"
              },
              "Description": "Allow traffic from ALB"
            }
          ],
          "SecurityGroupEgress": [
            {
              "IpProtocol": "-1",
              "CidrIp": "0.0.0.0/0",
              "Description": "Allow all outbound traffic"
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "ecs-task-sg-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "RDSSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupName": {
            "Fn::Sub": "rds-sg-${EnvironmentSuffix}"
          },
          "GroupDescription": "Security group for Aurora PostgreSQL",
          "VpcId": {
            "Ref": "VPC"
          },
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 5432,
              "ToPort": 5432,
              "SourceSecurityGroupId": {
                "Ref": "ECSTaskSecurityGroup"
              },
              "Description": "Allow PostgreSQL traffic from ECS tasks"
            }
          ],
          "SecurityGroupEgress": [
            {
              "IpProtocol": "-1",
              "CidrIp": "0.0.0.0/0",
              "Description": "Allow all outbound traffic"
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "rds-sg-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "DBEncryptionKey": {
        "Type": "AWS::KMS::Key",
        "Properties": {
          "Description": {
            "Fn::Sub": "KMS key for Aurora backup encryption - ${EnvironmentSuffix}"
          },
          "KeyPolicy": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "Enable IAM User Permissions",
                "Effect": "Allow",
                "Principal": {
                  "AWS": {
                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                  }
                },
                "Action": "kms:*",
                "Resource": "*"
              },
              {
                "Sid": "Allow RDS to use the key",
                "Effect": "Allow",
                "Principal": {
                  "Service": "rds.amazonaws.com"
                },
                "Action": [
                  "kms:Decrypt",
                  "kms:GenerateDataKey",
                  "kms:CreateGrant"
                ],
                "Resource": "*"
              }
            ]
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "db-encryption-key-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "DBEncryptionKeyAlias": {
        "Type": "AWS::KMS::Alias",
        "Properties": {
          "AliasName": {
            "Fn::Sub": "alias/db-encryption-${EnvironmentSuffix}"
          },
          "TargetKeyId": {
            "Ref": "DBEncryptionKey"
          }
        }
      },
      "DBSecret": {
        "Type": "AWS::SecretsManager::Secret",
        "Properties": {
          "Name": {
            "Fn::Sub": "rds-db-credentials-${EnvironmentSuffix}"
          },
          "Description": {
            "Fn::Sub": "Database credentials for Aurora PostgreSQL cluster - ${EnvironmentSuffix}"
          },
          "SecretString": {
            "Fn::Sub": "{\"username\":\"${DBMasterUsername}\",\"password\":\"${DBMasterPassword}\"}"
          },
          "KmsKeyId": {
            "Ref": "DBEncryptionKey"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "rds-db-credentials-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "DBSubnetGroup": {
        "Type": "AWS::RDS::DBSubnetGroup",
        "Properties": {
          "DBSubnetGroupName": {
            "Fn::Sub": "aurora-subnet-group-${EnvironmentSuffix}"
          },
          "DBSubnetGroupDescription": "Subnet group for Aurora PostgreSQL",
          "SubnetIds": [
            {
              "Ref": "PrivateSubnet1"
            },
            {
              "Ref": "PrivateSubnet2"
            },
            {
              "Ref": "PrivateSubnet3"
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "aurora-subnet-group-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "AuroraCluster": {
        "Type": "AWS::RDS::DBCluster",
        "Properties": {
          "Engine": "aurora-postgresql",
          "EngineMode": "provisioned",
          "EngineVersion": "15.13",
          "DatabaseName": "loanprocessing",
          "MasterUsername": {
            "Ref": "DBMasterUsername"
          },
          "ManageMasterUserPassword": true,
          "MasterUserSecret": {
            "Fn::If": [
              "UseSecretsManager",
              {
                "SecretArn": {
                  "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${DBSecretName}"
                }
              },
              {
                "SecretArn": {
                  "Ref": "DBSecret"
                }
              }
            ]
          },
          "DBSubnetGroupName": {
            "Ref": "DBSubnetGroup"
          },
          "VpcSecurityGroupIds": [
            {
              "Ref": "RDSSecurityGroup"
            }
          ],
          "StorageEncrypted": true,
          "KmsKeyId": {
            "Ref": "DBEncryptionKey"
          },
          "BackupRetentionPeriod": 7,
          "PreferredBackupWindow": "03:00-04:00",
          "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
          "ServerlessV2ScalingConfiguration": {
            "MinCapacity": 0.5,
            "MaxCapacity": 4
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "AuroraInstance1": {
        "Type": "AWS::RDS::DBInstance",
        "Properties": {
          "Engine": "aurora-postgresql",
          "DBClusterIdentifier": {
            "Ref": "AuroraCluster"
          },
          "DBInstanceClass": "db.serverless",
          "PubliclyAccessible": false,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "AuroraInstance2": {
        "Type": "AWS::RDS::DBInstance",
        "Properties": {
          "Engine": "aurora-postgresql",
          "DBClusterIdentifier": {
            "Ref": "AuroraCluster"
          },
          "DBInstanceClass": "db.serverless",
          "PubliclyAccessible": false,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "DocumentBucket": {
        "Type": "AWS::S3::Bucket",
        "Properties": {
          "BucketName": {
            "Fn::Sub": "loan-documents-${EnvironmentSuffix}-${AWS::AccountId}"
          },
          "BucketEncryption": {
            "ServerSideEncryptionConfiguration": [
              {
                "ServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }
            ]
          },
          "VersioningConfiguration": {
            "Status": "Enabled"
          },
          "PublicAccessBlockConfiguration": {
            "BlockPublicAcls": true,
            "BlockPublicPolicy": true,
            "IgnorePublicAcls": true,
            "RestrictPublicBuckets": true
          },
          "LifecycleConfiguration": {
            "Rules": [
              {
                "Id": "TransitionOldVersions",
                "Status": "Enabled",
                "NoncurrentVersionTransitions": [
                  {
                    "StorageClass": "STANDARD_IA",
                    "TransitionInDays": 30
                  },
                  {
                    "StorageClass": "GLACIER",
                    "TransitionInDays": 90
                  }
                ],
                "NoncurrentVersionExpirationInDays": 365
              }
            ]
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-documents-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ECSCluster": {
        "Type": "AWS::ECS::Cluster",
        "Properties": {
          "ClusterName": {
            "Fn::Sub": "loan-processing-cluster-${EnvironmentSuffix}"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-processing-cluster-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ECSLogGroup": {
        "Type": "AWS::Logs::LogGroup",
        "Properties": {
          "LogGroupName": {
            "Fn::Sub": "/ecs/loan-processing-${EnvironmentSuffix}"
          },
          "RetentionInDays": 365
        }
      },
      "ECSTaskExecutionRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "RoleName": {
            "Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}"
          },
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ecs-tasks.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          },
          "ManagedPolicyArns": [
            "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
          ],
          "Policies": [
            {
              "PolicyName": "ECSLogging",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "logs:CreateLogStream",
                      "logs:PutLogEvents"
                    ],
                    "Resource": {
                      "Fn::GetAtt": [
                        "ECSLogGroup",
                        "Arn"
                      ]
                    }
                  }
                ]
              }
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ECSTaskRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "RoleName": {
            "Fn::Sub": "ecs-task-role-${EnvironmentSuffix}"
          },
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ecs-tasks.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          },
          "Policies": [
            {
              "PolicyName": "S3DocumentAccess",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:GetObject",
                      "s3:PutObject",
                      "s3:DeleteObject",
                      "s3:ListBucket"
                    ],
                    "Resource": [
                      {
                        "Fn::GetAtt": [
                          "DocumentBucket",
                          "Arn"
                        ]
                      },
                      {
                        "Fn::Sub": "${DocumentBucket.Arn}/*"
                      }
                    ]
                  }
                ]
              }
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "ecs-task-role-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ECSTaskDefinition": {
        "Type": "AWS::ECS::TaskDefinition",
        "Properties": {
          "Family": {
            "Fn::Sub": "loan-processing-task-${EnvironmentSuffix}"
          },
          "NetworkMode": "awsvpc",
          "RequiresCompatibilities": [
            "FARGATE"
          ],
          "Cpu": "512",
          "Memory": "1024",
          "ExecutionRoleArn": {
            "Fn::GetAtt": [
              "ECSTaskExecutionRole",
              "Arn"
            ]
          },
          "TaskRoleArn": {
            "Fn::GetAtt": [
              "ECSTaskRole",
              "Arn"
            ]
          },
          "ContainerDefinitions": [
            {
              "Name": "loan-processing-app",
              "Image": {
                "Ref": "ContainerImage"
              },
              "Essential": true,
              "PortMappings": [
                {
                  "ContainerPort": 80,
                  "Protocol": "tcp"
                }
              ],
              "Environment": [
                {
                  "Name": "DB_HOST",
                  "Value": {
                    "Fn::GetAtt": [
                      "AuroraCluster",
                      "Endpoint.Address"
                    ]
                  }
                },
                {
                  "Name": "DB_PORT",
                  "Value": "5432"
                },
                {
                  "Name": "DB_NAME",
                  "Value": "loanprocessing"
                },
                {
                  "Name": "DOCUMENT_BUCKET",
                  "Value": {
                    "Ref": "DocumentBucket"
                  }
                }
              ],
              "LogConfiguration": {
                "LogDriver": "awslogs",
                "Options": {
                  "awslogs-group": {
                    "Ref": "ECSLogGroup"
                  },
                  "awslogs-region": {
                    "Ref": "AWS::Region"
                  },
                  "awslogs-stream-prefix": "ecs"
                }
              }
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-processing-task-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ApplicationLoadBalancer": {
        "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties": {
          "Name": {
            "Fn::Sub": "loan-alb-${EnvironmentSuffix}"
          },
          "Type": "application",
          "Scheme": "internet-facing",
          "IpAddressType": "ipv4",
          "Subnets": [
            {
              "Ref": "PublicSubnet1"
            },
            {
              "Ref": "PublicSubnet2"
            },
            {
              "Ref": "PublicSubnet3"
            }
          ],
          "SecurityGroups": [
            {
              "Ref": "ALBSecurityGroup"
            }
          ],
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-alb-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ALBTargetGroup": {
        "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties": {
          "Name": {
            "Fn::Sub": "loan-tg-${EnvironmentSuffix}"
          },
          "Port": 80,
          "Protocol": "HTTP",
          "VpcId": {
            "Ref": "VPC"
          },
          "TargetType": "ip",
          "HealthCheckEnabled": true,
          "HealthCheckProtocol": "HTTP",
          "HealthCheckPath": "/",
          "HealthCheckIntervalSeconds": 30,
          "HealthCheckTimeoutSeconds": 5,
          "HealthyThresholdCount": 2,
          "UnhealthyThresholdCount": 3,
          "Matcher": {
            "HttpCode": "200"
          },
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-tg-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "ALBListenerHTTP": {
        "Type": "AWS::ElasticLoadBalancingV2::Listener",
        "Properties": {
          "LoadBalancerArn": {
            "Ref": "ApplicationLoadBalancer"
          },
          "Port": 80,
          "Protocol": "HTTP",
          "DefaultActions": [
            {
              "Type": "forward",
              "TargetGroupArn": {
                "Ref": "ALBTargetGroup"
              }
            }
          ]
        }
      },
      "ALBListenerHTTPS": {
        "Type": "AWS::ElasticLoadBalancingV2::Listener",
        "Condition": "HasCertificate",
        "Properties": {
          "LoadBalancerArn": {
            "Ref": "ApplicationLoadBalancer"
          },
          "Port": 443,
          "Protocol": "HTTPS",
          "Certificates": [
            {
              "CertificateArn": {
                "Ref": "CertificateArn"
              }
            }
          ],
          "DefaultActions": [
            {
              "Type": "forward",
              "TargetGroupArn": {
                "Ref": "ALBTargetGroup"
              }
            }
          ]
        }
      },
      "ECSService": {
        "Type": "AWS::ECS::Service",
        "DependsOn": [
          "ALBListenerHTTP",
          "AuroraInstance1"
        ],
        "Properties": {
          "ServiceName": {
            "Fn::Sub": "loan-processing-service-${EnvironmentSuffix}"
          },
          "Cluster": {
            "Ref": "ECSCluster"
          },
          "TaskDefinition": {
            "Ref": "ECSTaskDefinition"
          },
          "DesiredCount": {
            "Ref": "DesiredTaskCount"
          },
          "LaunchType": "FARGATE",
          "NetworkConfiguration": {
            "AwsvpcConfiguration": {
              "AssignPublicIp": "DISABLED",
              "Subnets": [
                {
                  "Ref": "PrivateSubnet1"
                },
                {
                  "Ref": "PrivateSubnet2"
                },
                {
                  "Ref": "PrivateSubnet3"
                }
              ],
              "SecurityGroups": [
                {
                  "Ref": "ECSTaskSecurityGroup"
                }
              ]
            }
          },
          "LoadBalancers": [
            {
              "ContainerName": "loan-processing-app",
              "ContainerPort": 80,
              "TargetGroupArn": {
                "Ref": "ALBTargetGroup"
              }
            }
          ],
          "HealthCheckGracePeriodSeconds": 60,
          "Tags": [
            {
              "Key": "Name",
              "Value": {
                "Fn::Sub": "loan-processing-service-${EnvironmentSuffix}"
              }
            }
          ]
        }
      },
      "AutoScalingTarget": {
        "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
        "Properties": {
          "MaxCapacity": {
            "Ref": "MaxTaskCount"
          },
          "MinCapacity": {
            "Ref": "MinTaskCount"
          },
          "ResourceId": {
            "Fn::Sub": "service/${ECSCluster}/${ECSService.Name}"
          },
          "RoleARN": {
            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
          },
          "ScalableDimension": "ecs:service:DesiredCount",
          "ServiceNamespace": "ecs"
        }
      },
      "AutoScalingPolicy": {
        "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
        "Properties": {
          "PolicyName": {
            "Fn::Sub": "request-count-scaling-${EnvironmentSuffix}"
          },
          "PolicyType": "TargetTrackingScaling",
          "ScalingTargetId": {
            "Ref": "AutoScalingTarget"
          },
          "TargetTrackingScalingPolicyConfiguration": {
            "PredefinedMetricSpecification": {
              "PredefinedMetricType": "ALBRequestCountPerTarget",
              "ResourceLabel": {
                "Fn::Sub": "${ApplicationLoadBalancer.LoadBalancerFullName}/${ALBTargetGroup.TargetGroupFullName}"
              }
            },
            "TargetValue": 1000,
            "ScaleInCooldown": 60,
            "ScaleOutCooldown": 60
          }
        }
      }
    },
    "Outputs": {
      "VPCId": {
        "Description": "VPC ID",
        "Value": {
          "Ref": "VPC"
        }
      },
      "PublicSubnets": {
        "Description": "Public subnet IDs",
        "Value": {
          "Fn::Join": [
            ",",
            [
              {
                "Ref": "PublicSubnet1"
              },
              {
                "Ref": "PublicSubnet2"
              },
              {
                "Ref": "PublicSubnet3"
              }
            ]
          ]
        }
      },
      "PrivateSubnets": {
        "Description": "Private subnet IDs",
        "Value": {
          "Fn::Join": [
            ",",
            [
              {
                "Ref": "PrivateSubnet1"
              },
              {
                "Ref": "PrivateSubnet2"
              },
              {
                "Ref": "PrivateSubnet3"
              }
            ]
          ]
        }
      },
      "ECSClusterName": {
        "Description": "ECS Cluster name",
        "Value": {
          "Ref": "ECSCluster"
        }
      },
      "ECSServiceName": {
        "Description": "ECS Service name",
        "Value": {
          "Fn::GetAtt": [
            "ECSService",
            "Name"
          ]
        }
      },
      "AuroraClusterEndpoint": {
        "Description": "Aurora PostgreSQL cluster endpoint",
        "Value": {
          "Fn::GetAtt": [
            "AuroraCluster",
            "Endpoint.Address"
          ]
        }
      },
      "AuroraClusterReadEndpoint": {
        "Description": "Aurora PostgreSQL cluster read endpoint",
        "Value": {
          "Fn::GetAtt": [
            "AuroraCluster",
            "ReadEndpoint.Address"
          ]
        }
      },
      "DocumentBucketName": {
        "Description": "S3 bucket for loan documents",
        "Value": {
          "Ref": "DocumentBucket"
        }
      },
      "ApplicationLoadBalancerDNS": {
        "Description": "Application Load Balancer DNS name",
        "Value": {
          "Fn::GetAtt": [
            "ApplicationLoadBalancer",
            "DNSName"
          ]
        }
      },
      "ApplicationLoadBalancerURL": {
        "Description": "Application Load Balancer URL",
        "Value": {
          "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}"
        }
      },
      "LogGroupName": {
        "Description": "CloudWatch Log Group name",
        "Value": {
          "Ref": "ECSLogGroup"
        }
      }
    }
  }
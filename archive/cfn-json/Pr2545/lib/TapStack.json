{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Secure static website hosting solution with CloudFront, S3, Route 53, ACM, IAM, and KMS",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": { "default": "Environment Configuration" },
          "Parameters": ["EnvironmentSuffix"]
        },
        {
          "Label": { "default": "Website Configuration" },
          "Parameters": ["DomainName", "EnvironmentName", "OrganizationPrefix", "Department", "Purpose", "Year"]
        }
      ],
      "ParameterLabels": {
        "DomainName": { "default": "Domain Name" },
        "EnvironmentName": { "default": "Environment Name" },
        "OrganizationPrefix": { "default": "Organization Prefix" },
        "Department": { "default": "Department" },
        "Purpose": { "default": "Purpose" },
        "Year": { "default": "Year" }
      }
    }
  },
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "AllowedPattern": "^[a-zA-Z0-9]+$",
      "ConstraintDescription": "Must contain only alphanumeric characters"
    },
    "DomainName": {
      "Type": "String",
      "Default": "example.com",
      "Description": "The domain name for the website"
    },
    "EnvironmentName": {
      "Type": "String",
      "Default": "production",
      "Description": "Environment name (production, staging, etc.)",
      "AllowedValues": ["production", "staging", "development"]
    },
    "OrganizationPrefix": {
      "Type": "String",
      "Default": "myorg",
      "Description": "Organization prefix for naming"
    },
    "Department": {
      "Type": "String",
      "Default": "web",
      "Description": "Department name"
    },
    "Purpose": {
      "Type": "String",
      "Default": "staticsite",
      "Description": "Purpose of the infrastructure"
    },
    "Year": {
      "Type": "String",
      "Default": "2024",
      "Description": "Year for naming convention"
    }
  },
  "Resources": {
    "KMSKey": {
      "Type": "AWS::KMS::Key",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "Description": {
          "Fn::Sub": "KMS key for S3 bucket encryption - ${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}"
        },
        "KeyPolicy": {
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow CloudFront service",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-kms-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": { "Ref": "Purpose" }
          }
        ]
      }
    },
    "KMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}"
        },
        "TargetKeyId": { "Ref": "KMSKey" }
      }
    },
    "S3BucketLogs": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-logs-${Year}-${EnvironmentSuffix}-${AWS::Region}"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": { "Ref": "KMSKey" }
              }
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-logs-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": "AccessLogs"
          }
        ]
      }
    },
    "S3BucketWebsite": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}-${AWS::Region}"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": { "Ref": "KMSKey" }
              }
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "LoggingConfiguration": {
          "DestinationBucketName": { "Ref": "S3BucketLogs" },
          "LogFilePrefix": "website-access-logs/"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": { "Ref": "Purpose" }
          }
        ]
      }
    },
    "CloudFrontOAC": {
      "Type": "AWS::CloudFront::OriginAccessControl",
      "Properties": {
        "OriginAccessControlConfig": {
          "Name": {
            "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-oac-${Year}-${EnvironmentSuffix}"
          },
          "Description": "Origin Access Control for S3 bucket",
          "OriginAccessControlOriginType": "s3",
          "SigningBehavior": "always",
          "SigningProtocol": "sigv4"
        }
      }
    },
    "CloudFrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "DistributionConfig": {
          "Comment": {
            "Fn::Sub": "CloudFront distribution for ${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}"
          },
          "DefaultCacheBehavior": {
            "AllowedMethods": ["GET", "HEAD", "OPTIONS"],
            "CachedMethods": ["GET", "HEAD"],
            "TargetOriginId": "S3Origin",
            "ViewerProtocolPolicy": "redirect-to-https",
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6",
            "ResponseHeadersPolicyId": "67f7725c-6f97-4210-82d7-5512b31e9d03"
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Origins": [
            {
              "Id": "S3Origin",
              "DomainName": {
                "Fn::GetAtt": ["S3BucketWebsite", "RegionalDomainName"]
              },
              "S3OriginConfig": {
                "OriginAccessIdentity": ""
              },
              "OriginAccessControlId": { "Ref": "CloudFrontOAC" }
            }
          ],
          "PriceClass": "PriceClass_100"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-cf-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": { "Ref": "Purpose" }
          }
        ]
      }
    },
    "S3BucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "S3BucketWebsite" },
        "PolicyDocument": {
          "Statement": [
            {
              "Sid": "AllowCloudFrontServicePrincipal",
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Sub": "${S3BucketWebsite}/*"
              },
              "Condition": {
                "StringEquals": {
                  "AWS:SourceArn": {
                    "Fn::Sub": "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    "IAMRoleCloudFrontAccess": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-cloudfront-role-${Year}-${EnvironmentSuffix}"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "cloudfront.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "S3AccessPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    { "Fn::GetAtt": ["S3BucketWebsite", "Arn"] },
                    { "Fn::Sub": "${S3BucketWebsite}/*" }
                  ]
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-cloudfront-role-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": "CloudFrontAccess"
          }
        ]
      }
    },
    "Route53HostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "Name": { "Ref": "DomainName" },
        "HostedZoneConfig": {
          "Comment": {
            "Fn::Sub": "Hosted zone for ${DomainName} - ${OrganizationPrefix}-${Department}-${Purpose}-${Year}-${EnvironmentSuffix}"
          }
        },
        "HostedZoneTags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-hz-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": { "Ref": "Purpose" }
          }
        ]
      }
    },
    "ACMCertificate": {
      "Type": "AWS::CertificateManager::Certificate",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "DomainName": { "Ref": "DomainName" },
        "SubjectAlternativeNames": [
          {
            "Fn::Sub": "www.${DomainName}"
          }
        ],
        "ValidationMethod": "DNS",
        "DomainValidationOptions": [
          {
            "DomainName": { "Ref": "DomainName" },
            "HostedZoneId": { "Ref": "Route53HostedZone" }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${OrganizationPrefix}-${Department}-${Purpose}-cert-${Year}-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "EnvironmentName" }
          },
          {
            "Key": "Purpose",
            "Value": { "Ref": "Purpose" }
          }
        ]
      }
    },
    "Route53RecordSetA": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": { "Ref": "Route53HostedZone" },
        "Name": { "Ref": "DomainName" },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": ["CloudFrontDistribution", "DomainName"]
          },
          "HostedZoneId": "Z2FDTNDATAQYW2"
        }
      }
    },
    "Route53RecordSetAAAA": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": { "Ref": "Route53HostedZone" },
        "Name": { "Ref": "DomainName" },
        "Type": "AAAA",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": ["CloudFrontDistribution", "DomainName"]
          },
          "HostedZoneId": "Z2FDTNDATAQYW2"
        }
      }
    }
  },
  "Outputs": {
    "S3BucketName": {
      "Description": "Name of the S3 bucket for website hosting",
      "Value": { "Ref": "S3BucketWebsite" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-S3BucketName"
        }
      }
    },
    "S3BucketWebsiteEndpoint": {
      "Description": "S3 bucket website endpoint",
      "Value": {
        "Fn::GetAtt": ["S3BucketWebsite", "RegionalDomainName"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-S3BucketWebsiteEndpoint"
        }
      }
    },
    "CloudFrontDistributionDomainName": {
      "Description": "CloudFront distribution domain name",
      "Value": {
        "Fn::GetAtt": ["CloudFrontDistribution", "DomainName"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CloudFrontDistributionDomainName"
        }
      }
    },
    "Route53HostedZoneId": {
      "Description": "Route 53 hosted zone ID",
      "Value": { "Ref": "Route53HostedZone" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Route53HostedZoneId"
        }
      }
    },
    "ACMCertificateArn": {
      "Description": "ACM certificate ARN",
      "Value": { "Ref": "ACMCertificate" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ACMCertificateArn"
        }
      }
    },
    "KMSKeyId": {
      "Description": "KMS key ID for encryption",
      "Value": { "Ref": "KMSKey" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-KMSKeyId"
        }
      }
    },
    "StackName": {
      "Description": "Name of this CloudFormation stack",
      "Value": { "Ref": "AWS::StackName" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackName"
        }
      }
    },
    "EnvironmentSuffix": {
      "Description": "Environment suffix used for this deployment",
      "Value": { "Ref": "EnvironmentSuffix" },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
        }
      }
    }
  }
}
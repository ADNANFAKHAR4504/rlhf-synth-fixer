{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Secure Financial Transaction Processing System with ECS and RDS - PCI-DSS Compliant",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource naming to enable multiple deployments",
      "Default": "dev"
    },
    "DBUsername": {
      "Type": "String",
      "Description": "Database master username",
      "Default": "dbadmin",
      "NoEcho": true
    },
    "ContainerImage": {
      "Type": "String",
      "Description": "Docker image for transaction processing application",
      "Default": "nginx:latest"
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "vpc-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": { "Fn::Select": [0, { "Fn::GetAZs": "" }] },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "public-subnet-1-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": { "Fn::Select": [1, { "Fn::GetAZs": "" }] },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "public-subnet-2-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.10.0/24",
        "AvailabilityZone": { "Fn::Select": [0, { "Fn::GetAZs": "" }] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "private-subnet-1-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.11.0/24",
        "AvailabilityZone": { "Fn::Select": [1, { "Fn::GetAZs": "" }] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "private-subnet-2-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "igw-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "InternetGatewayId": { "Ref": "InternetGateway" }
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "public-rt-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachGateway",
      "Properties": {
        "RouteTableId": { "Ref": "PublicRouteTable" },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": { "Ref": "InternetGateway" }
      }
    },
    "PublicSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PublicSubnet1" },
        "RouteTableId": { "Ref": "PublicRouteTable" }
      }
    },
    "PublicSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PublicSubnet2" },
        "RouteTableId": { "Ref": "PublicRouteTable" }
      }
    },
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "private-rt-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PrivateSubnet1" },
        "RouteTableId": { "Ref": "PrivateRouteTable" }
      }
    },
    "PrivateSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PrivateSubnet2" },
        "RouteTableId": { "Ref": "PrivateRouteTable" }
      }
    },
    "VPCFlowLogsRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "vpc-flow-logs-role-${EnvironmentSuffix}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "vpc-flow-logs.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CloudWatchLogPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "VPCFlowLogsLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Sub": "/aws/vpc/flowlogs-${EnvironmentSuffix}" },
        "RetentionInDays": 30
      }
    },
    "VPCFlowLog": {
      "Type": "AWS::EC2::FlowLog",
      "Properties": {
        "ResourceId": { "Ref": "VPC" },
        "ResourceType": "VPC",
        "TrafficType": "ALL",
        "LogDestinationType": "cloud-watch-logs",
        "LogGroupName": { "Ref": "VPCFlowLogsLogGroup" },
        "DeliverLogsPermissionArn": { "Fn::GetAtt": ["VPCFlowLogsRole", "Arn"] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "vpc-flow-log-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": { "Fn::Sub": "transaction-cluster-${EnvironmentSuffix}" },
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "enabled"
          }
        ]
      }
    },
    "ECSTaskExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ],
        "Policies": [
          {
            "PolicyName": "SecretsManagerAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": { "Ref": "DBSecret" }
                }
              ]
            }
          }
        ]
      }
    },
    "ECSTaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "ecs-task-role-${EnvironmentSuffix}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CloudWatchLogsPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": { "Fn::GetAtt": ["ECSLogGroup", "Arn"] }
                }
              ]
            }
          }
        ]
      }
    },
    "ECSLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Sub": "/ecs/transaction-processor-${EnvironmentSuffix}" },
        "RetentionInDays": 90
      }
    },
    "ECSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": { "Fn::Sub": "ecs-sg-${EnvironmentSuffix}" },
        "GroupDescription": "Security group for ECS tasks",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "10.0.0.0/16"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "ecs-sg-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": { "Fn::Sub": "rds-sg-${EnvironmentSuffix}" },
        "GroupDescription": "Security group for RDS database - allows access from ECS only",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 3306,
            "ToPort": 3306,
            "SourceSecurityGroupId": { "Ref": "ECSSecurityGroup" }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "rds-sg-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": { "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}" },
        "DBSubnetGroupDescription": "Subnet group for RDS database in private subnets",
        "SubnetIds": [
          { "Ref": "PrivateSubnet1" },
          { "Ref": "PrivateSubnet2" }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "DBSecret": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": { "Fn::Sub": "db-credentials-${EnvironmentSuffix}" },
        "Description": "Database credentials for transaction processing system",
        "GenerateSecretString": {
          "SecretStringTemplate": { "Fn::Sub": "{\"username\":\"${DBUsername}\"}" },
          "GenerateStringKey": "password",
          "PasswordLength": 32,
          "ExcludeCharacters": "\"@/\\"
        }
      }
    },
    "DBKMSKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": { "Fn::Sub": "KMS key for RDS encryption - ${EnvironmentSuffix}" },
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": { "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root" }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow RDS to use the key",
              "Effect": "Allow",
              "Principal": {
                "Service": "rds.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:DescribeKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            }
          ]
        }
      }
    },
    "DBKMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": { "Fn::Sub": "alias/rds-key-${EnvironmentSuffix}" },
        "TargetKeyId": { "Ref": "DBKMSKey" }
      }
    },
    "AuroraCluster": {
      "Type": "AWS::RDS::DBCluster",
      "Properties": {
        "DBClusterIdentifier": { "Fn::Sub": "transaction-db-${EnvironmentSuffix}" },
        "Engine": "aurora-mysql",
        "EngineVersion": "8.0.mysql_aurora.3.04.4",
        "DatabaseName": "transactiondb",
        "MasterUsername": { "Ref": "DBUsername" },
        "MasterUserPassword": { "Fn::Sub": "{{resolve:secretsmanager:${DBSecret}:SecretString:password}}" },
        "DBSubnetGroupName": { "Ref": "DBSubnetGroup" },
        "VpcSecurityGroupIds": [
          { "Ref": "DBSecurityGroup" }
        ],
        "StorageEncrypted": true,
        "KmsKeyId": { "Ref": "DBKMSKey" },
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
        "EnableCloudwatchLogsExports": [
          "audit",
          "error",
          "slowquery"
        ],
        "ServerlessV2ScalingConfiguration": {
          "MinCapacity": 0.5,
          "MaxCapacity": 1
        }
      }
    },
    "AuroraInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": { "Fn::Sub": "transaction-db-instance-${EnvironmentSuffix}" },
        "DBClusterIdentifier": { "Ref": "AuroraCluster" },
        "DBInstanceClass": "db.serverless",
        "Engine": "aurora-mysql",
        "PubliclyAccessible": false
      }
    },
    "TaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": { "Fn::Sub": "transaction-processor-${EnvironmentSuffix}" },
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": ["FARGATE"],
        "Cpu": "256",
        "Memory": "512",
        "ExecutionRoleArn": { "Fn::GetAtt": ["ECSTaskExecutionRole", "Arn"] },
        "TaskRoleArn": { "Fn::GetAtt": ["ECSTaskRole", "Arn"] },
        "ContainerDefinitions": [
          {
            "Name": "transaction-processor",
            "Image": { "Ref": "ContainerImage" },
            "Essential": true,
            "PortMappings": [
              {
                "ContainerPort": 443,
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "DB_HOST",
                "Value": { "Fn::GetAtt": ["AuroraCluster", "Endpoint.Address"] }
              },
              {
                "Name": "DB_NAME",
                "Value": "transactiondb"
              }
            ],
            "Secrets": [
              {
                "Name": "DB_USERNAME",
                "ValueFrom": { "Fn::Sub": "${DBSecret}:username::" }
              },
              {
                "Name": "DB_PASSWORD",
                "ValueFrom": { "Fn::Sub": "${DBSecret}:password::" }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": { "Ref": "ECSLogGroup" },
                "awslogs-region": { "Ref": "AWS::Region" },
                "awslogs-stream-prefix": "ecs"
              }
            }
          }
        ]
      }
    },
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "DependsOn": ["AuroraCluster"],
      "Properties": {
        "ServiceName": { "Fn::Sub": "transaction-service-${EnvironmentSuffix}" },
        "Cluster": { "Ref": "ECSCluster" },
        "TaskDefinition": { "Ref": "TaskDefinition" },
        "DesiredCount": 1,
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "Subnets": [
              { "Ref": "PublicSubnet1" },
              { "Ref": "PublicSubnet2" }
            ],
            "SecurityGroups": [
              { "Ref": "ECSSecurityGroup" }
            ]
          }
        },
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100
        }
      }
    },
    "ServiceScalingTarget": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": 4,
        "MinCapacity": 1,
        "ResourceId": { "Fn::Sub": "service/${ECSCluster}/${ECSService.Name}" },
        "RoleARN": { "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService" },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    "ServiceScalingPolicy": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": { "Fn::Sub": "cpu-scaling-policy-${EnvironmentSuffix}" },
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": { "Ref": "ServiceScalingTarget" },
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": 70.0,
          "ScaleInCooldown": 300,
          "ScaleOutCooldown": 60
        }
      }
    },
    "CPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "ecs-cpu-high-${EnvironmentSuffix}" },
        "AlarmDescription": "Alarm when ECS CPU exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ClusterName",
            "Value": { "Ref": "ECSCluster" }
          },
          {
            "Name": "ServiceName",
            "Value": { "Fn::GetAtt": ["ECSService", "Name"] }
          }
        ]
      }
    },
    "DBConnectionAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "rds-connections-high-${EnvironmentSuffix}" },
        "AlarmDescription": "Alarm when database connections are high",
        "MetricName": "DatabaseConnections",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": { "Ref": "AuroraCluster" }
          }
        ]
      }
    }
  },
  "Outputs": {
    "VPCId": {
      "Description": "VPC ID",
      "Value": { "Ref": "VPC" },
      "Export": {
        "Name": { "Fn::Sub": "vpc-id-${EnvironmentSuffix}" }
      }
    },
    "ECSClusterName": {
      "Description": "ECS Cluster Name",
      "Value": { "Ref": "ECSCluster" },
      "Export": {
        "Name": { "Fn::Sub": "ecs-cluster-${EnvironmentSuffix}" }
      }
    },
    "ECSServiceName": {
      "Description": "ECS Service Name",
      "Value": { "Fn::GetAtt": ["ECSService", "Name"] },
      "Export": {
        "Name": { "Fn::Sub": "ecs-service-${EnvironmentSuffix}" }
      }
    },
    "DBClusterEndpoint": {
      "Description": "Aurora Cluster Endpoint",
      "Value": { "Fn::GetAtt": ["AuroraCluster", "Endpoint.Address"] },
      "Export": {
        "Name": { "Fn::Sub": "db-endpoint-${EnvironmentSuffix}" }
      }
    },
    "DBSecretArn": {
      "Description": "Database Credentials Secret ARN",
      "Value": { "Ref": "DBSecret" },
      "Export": {
        "Name": { "Fn::Sub": "db-secret-arn-${EnvironmentSuffix}" }
      }
    },
    "ECSLogGroup": {
      "Description": "CloudWatch Log Group for ECS",
      "Value": { "Ref": "ECSLogGroup" },
      "Export": {
        "Name": { "Fn::Sub": "ecs-log-group-${EnvironmentSuffix}" }
      }
    }
  }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "PCI-DSS Compliant Financial Transaction Processing Infrastructure with High Availability",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Unique suffix for resource naming",
            "Default": "prod",
            "AllowedPattern": "[a-zA-Z0-9-]*",
            "ConstraintDescription": "Must contain only alphanumeric characters and hyphens"
        },
        "DatabaseMasterUsername": {
            "Type": "String",
            "Description": "Master username for RDS Aurora",
            "Default": "dbadmin",
            "NoEcho": true
        },
        "VpcCIDR": {
            "Type": "String",
            "Description": "CIDR block for VPC",
            "Default": "10.0.0.0/16"
        }
    },
    "Resources": {
        "DatabaseEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for RDS Aurora encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow RDS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "DatabaseEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/rds-encryption-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "DatabaseEncryptionKey"
                }
            }
        },
        "EFSEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for EFS encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow EFS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "elasticfilesystem.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "EFSEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/efs-encryption-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "EFSEncryptionKey"
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCIDR"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "vpc-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "igw-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.1.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-public-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.2.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-public-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.3.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-public-3-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.11.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.12.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.0.13.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "subnet-private-3-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "NatGatewayEIP": {
            "Type": "AWS::EC2::EIP",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "eip-natgateway-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "NatGateway": {
            "Type": "AWS::EC2::NatGateway",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGatewayEIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "nat-gateway-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rtb-public-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                }
            }
        },
        "PublicSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "rtb-private-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DefaultPrivateRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "PrivateSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                }
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS from anywhere"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP from anywhere"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-alb-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ECSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "GroupDescription": "Security group for ECS Fargate tasks",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "Allow traffic from ALB"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-ecs-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "GroupDescription": "Security group for RDS Aurora",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "PostgreSQL from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-database-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RedisSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "GroupDescription": "Security group for ElastiCache Redis",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 6379,
                        "ToPort": 6379,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "Redis from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-redis-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "GroupDescription": "Security group for EFS",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 2049,
                        "ToPort": 2049,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "NFS from ECS tasks"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sg-efs-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "secret-database-${EnvironmentSuffix}"
                },
                "Description": "Database credentials for RDS Aurora",
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\": \"${DatabaseMasterUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\",
                    "RequireEachIncludedType": true
                }
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "dbsubnet-transaction-${EnvironmentSuffix}"
                },
                "DBSubnetGroupDescription": "Subnet group for RDS Aurora",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "dbsubnet-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraDBCluster": {
            "Type": "AWS::RDS::DBCluster",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBClusterIdentifier": {
                    "Fn::Sub": "aurora-transaction-${EnvironmentSuffix}"
                },
                "Engine": "aurora-postgresql",
                "EngineMode": "provisioned",
                "EngineVersion": "15.4",
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
                },
                "DatabaseName": "transactions",
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "DatabaseEncryptionKey"
                },
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
                "EnableCloudwatchLogsExports": [
                    "postgresql"
                ],
                "DeletionProtection": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraDBInstance1": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-postgresql",
                "DBInstanceClass": "db.r6g.large",
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraDBInstance2": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-postgresql",
                "DBInstanceClass": "db.r6g.large",
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AuroraDBInstance3": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "aurora-instance-3-${EnvironmentSuffix}"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraDBCluster"
                },
                "Engine": "aurora-postgresql",
                "DBInstanceClass": "db.r6g.large",
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "aurora-instance-3-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "RedisSubnetGroup": {
            "Type": "AWS::ElastiCache::SubnetGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Description": "Subnet group for ElastiCache Redis",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "CacheSubnetGroupName": {
                    "Fn::Sub": "redis-subnet-${EnvironmentSuffix}"
                }
            }
        },
        "RedisReplicationGroup": {
            "Type": "AWS::ElastiCache::ReplicationGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "ReplicationGroupId": {
                    "Fn::Sub": "redis-transaction-${EnvironmentSuffix}"
                },
                "ReplicationGroupDescription": "Redis cluster for session management",
                "Engine": "redis",
                "EngineVersion": "7.0",
                "CacheNodeType": "cache.r6g.large",
                "NumCacheClusters": 3,
                "MultiAZEnabled": true,
                "AutomaticFailoverEnabled": true,
                "AtRestEncryptionEnabled": true,
                "TransitEncryptionEnabled": true,
                "SecurityGroupIds": [
                    {
                        "Ref": "RedisSecurityGroup"
                    }
                ],
                "CacheSubnetGroupName": {
                    "Ref": "RedisSubnetGroup"
                },
                "PreferredMaintenanceWindow": "sun:05:00-sun:06:00",
                "SnapshotRetentionLimit": 5,
                "SnapshotWindow": "03:00-04:00",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "redis-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSFileSystem": {
            "Type": "AWS::EFS::FileSystem",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Encrypted": true,
                "KmsKeyId": {
                    "Ref": "EFSEncryptionKey"
                },
                "LifecyclePolicies": [
                    {
                        "TransitionToIA": "AFTER_30_DAYS"
                    }
                ],
                "PerformanceMode": "generalPurpose",
                "ThroughputMode": "bursting",
                "FileSystemTags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "efs-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "EFSMountTarget1": {
            "Type": "AWS::EFS::MountTarget",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "FileSystemId": {
                    "Ref": "EFSFileSystem"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EFSSecurityGroup"
                    }
                ]
            }
        },
        "EFSMountTarget2": {
            "Type": "AWS::EFS::MountTarget",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "FileSystemId": {
                    "Ref": "EFSFileSystem"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EFSSecurityGroup"
                    }
                ]
            }
        },
        "EFSMountTarget3": {
            "Type": "AWS::EFS::MountTarget",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "FileSystemId": {
                    "Ref": "EFSFileSystem"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                },
                "SecurityGroups": [
                    {
                        "Ref": "EFSSecurityGroup"
                    }
                ]
            }
        },
        "TransactionDataStream": {
            "Type": "AWS::Kinesis::Stream",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "kinesis-transaction-${EnvironmentSuffix}"
                },
                "RetentionPeriodHours": 24,
                "ShardCount": 3,
                "StreamEncryption": {
                    "EncryptionType": "KMS",
                    "KeyId": "alias/aws/kinesis"
                },
                "StreamModeDetails": {
                    "StreamMode": "PROVISIONED"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "kinesis-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ECSLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/ecs/transaction-processing-${EnvironmentSuffix}"
                },
                "RetentionInDays": 30
            }
        },
        "APIGatewayLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/apigateway/transaction-api-${EnvironmentSuffix}"
                },
                "RetentionInDays": 30
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "role-ecs-execution-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogsAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ECSLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ECSTaskRole": {
            "Type": "AWS::IAM::Role",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "role-ecs-task-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "KinesisAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kinesis:PutRecord",
                                        "kinesis:PutRecords",
                                        "kinesis:GetRecords",
                                        "kinesis:GetShardIterator",
                                        "kinesis:DescribeStream",
                                        "kinesis:ListStreams"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "TransactionDataStream",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchMetrics",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "APIGatewayCloudWatchRole": {
            "Type": "AWS::IAM::Role",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "role-apigateway-cloudwatch-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "apigateway.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"
                ]
            }
        },
        "ECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "ClusterName": {
                    "Fn::Sub": "ecs-transaction-${EnvironmentSuffix}"
                },
                "CapacityProviders": [
                    "FARGATE",
                    "FARGATE_SPOT"
                ],
                "DefaultCapacityProviderStrategy": [
                    {
                        "CapacityProvider": "FARGATE",
                        "Weight": 1,
                        "Base": 2
                    }
                ],
                "ClusterSettings": [
                    {
                        "Name": "containerInsights",
                        "Value": "enabled"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "ecs-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Family": {
                    "Fn::Sub": "task-transaction-processing-${EnvironmentSuffix}"
                },
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "Cpu": "1024",
                "Memory": "2048",
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "TaskRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    {
                        "Name": "transaction-processor",
                        "Image": "nginxdemos/hello:latest",
                        "Essential": true,
                        "PortMappings": [
                            {
                                "ContainerPort": 80,
                                "Protocol": "tcp"
                            }
                        ],
                        "Environment": [
                            {
                                "Name": "KINESIS_STREAM_NAME",
                                "Value": {
                                    "Ref": "TransactionDataStream"
                                }
                            },
                            {
                                "Name": "REDIS_ENDPOINT",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "RedisReplicationGroup",
                                        "PrimaryEndPoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "REDIS_PORT",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "RedisReplicationGroup",
                                        "PrimaryEndPoint.Port"
                                    ]
                                }
                            },
                            {
                                "Name": "DATABASE_ENDPOINT",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "AuroraDBCluster",
                                        "Endpoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "DATABASE_PORT",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "AuroraDBCluster",
                                        "Endpoint.Port"
                                    ]
                                }
                            },
                            {
                                "Name": "DATABASE_NAME",
                                "Value": "transactions"
                            }
                        ],
                        "Secrets": [
                            {
                                "Name": "DATABASE_USERNAME",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:username::"
                                }
                            },
                            {
                                "Name": "DATABASE_PASSWORD",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:password::"
                                }
                            }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ECSLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        }
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "alb-transaction-${EnvironmentSuffix}"
                },
                "Type": "application",
                "Scheme": "internet-facing",
                "IpAddressType": "ipv4",
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    },
                    {
                        "Ref": "PublicSubnet3"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "alb-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "tg-transaction-${EnvironmentSuffix}"
                },
                "VpcId": {
                    "Ref": "VPC"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "TargetType": "ip",
                "HealthCheckEnabled": true,
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 5,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Matcher": {
                    "HttpCode": "200"
                },
                "TargetGroupAttributes": [
                    {
                        "Key": "deregistration_delay.timeout_seconds",
                        "Value": "30"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tg-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ALBListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ]
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "DependsOn": "ALBListener",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "ServiceName": {
                    "Fn::Sub": "service-transaction-${EnvironmentSuffix}"
                },
                "Cluster": {
                    "Ref": "ECSCluster"
                },
                "TaskDefinition": {
                    "Ref": "ECSTaskDefinition"
                },
                "DesiredCount": 3,
                "LaunchType": "FARGATE",
                "PlatformVersion": "LATEST",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "DISABLED",
                        "Subnets": [
                            {
                                "Ref": "PrivateSubnet1"
                            },
                            {
                                "Ref": "PrivateSubnet2"
                            },
                            {
                                "Ref": "PrivateSubnet3"
                            }
                        ],
                        "SecurityGroups": [
                            {
                                "Ref": "ECSSecurityGroup"
                            }
                        ]
                    }
                },
                "LoadBalancers": [
                    {
                        "ContainerName": "transaction-processor",
                        "ContainerPort": 80,
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ],
                "HealthCheckGracePeriodSeconds": 60,
                "DeploymentConfiguration": {
                    "MaximumPercent": 200,
                    "MinimumHealthyPercent": 100,
                    "DeploymentCircuitBreaker": {
                        "Enable": true,
                        "Rollback": true
                    }
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "service-transaction-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "ECSServiceScalingTarget": {
            "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
            "Properties": {
                "ServiceNamespace": "ecs",
                "ScalableDimension": "ecs:service:DesiredCount",
                "ResourceId": {
                    "Fn::Sub": "service/${ECSCluster}/${ECSService.Name}"
                },
                "MinCapacity": 3,
                "MaxCapacity": 15,
                "RoleARN": {
                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
                }
            }
        },
        "ECSServiceScalingPolicy": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "scaling-policy-ecs-${EnvironmentSuffix}"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "ECSServiceScalingTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
                    },
                    "TargetValue": 70.0,
                    "ScaleInCooldown": 300,
                    "ScaleOutCooldown": 60
                }
            }
        },
        "TransactionAPI": {
            "Type": "AWS::ApiGateway::RestApi",
            "DeletionPolicy": "Delete",
            "UpdateReplacePolicy": "Delete",
            "Properties": {
                "Name": {
                    "Fn::Sub": "api-transaction-${EnvironmentSuffix}"
                },
                "Description": "REST API for transaction processing",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Policy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": "*",
                            "Action": "execute-api:Invoke",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "TransactionResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransactionAPI"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "TransactionAPI",
                        "RootResourceId"
                    ]
                },
                "PathPart": "transactions"
            }
        },
        "TransactionMethodPost": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransactionAPI"
                },
                "ResourceId": {
                    "Ref": "TransactionResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "HTTP_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}/transactions"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        }
                    ]
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200
                    }
                ]
            }
        },
        "TransactionMethodGet": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransactionAPI"
                },
                "ResourceId": {
                    "Ref": "TransactionResource"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "HTTP_PROXY",
                    "IntegrationHttpMethod": "GET",
                    "Uri": {
                        "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}/transactions"
                    },
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200
                        }
                    ]
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200
                    }
                ]
            }
        },
        "APIDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "TransactionMethodPost",
                "TransactionMethodGet"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "TransactionAPI"
                },
                "StageName": "prod",
                "StageDescription": {
                    "LoggingLevel": "INFO",
                    "DataTraceEnabled": true,
                    "MetricsEnabled": true,
                    "TracingEnabled": true
                }
            }
        },
        "APIGatewayAccount": {
            "Type": "AWS::ApiGateway::Account",
            "Properties": {
                "CloudWatchRoleArn": {
                    "Fn::GetAtt": [
                        "APIGatewayCloudWatchRole",
                        "Arn"
                    ]
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPCId"
                }
            }
        },
        "DatabaseEndpoint": {
            "Description": "RDS Aurora cluster endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraDBCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseEndpoint"
                }
            }
        },
        "DatabasePort": {
            "Description": "RDS Aurora cluster port",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraDBCluster",
                    "Endpoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabasePort"
                }
            }
        },
        "RedisEndpoint": {
            "Description": "ElastiCache Redis primary endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "RedisReplicationGroup",
                    "PrimaryEndPoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisEndpoint"
                }
            }
        },
        "RedisPort": {
            "Description": "ElastiCache Redis port",
            "Value": {
                "Fn::GetAtt": [
                    "RedisReplicationGroup",
                    "PrimaryEndPoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RedisPort"
                }
            }
        },
        "KinesisStreamName": {
            "Description": "Kinesis Data Stream name",
            "Value": {
                "Ref": "TransactionDataStream"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KinesisStreamName"
                }
            }
        },
        "EFSFileSystemId": {
            "Description": "EFS File System ID",
            "Value": {
                "Ref": "EFSFileSystem"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EFSFileSystemId"
                }
            }
        },
        "LoadBalancerDNS": {
            "Description": "Application Load Balancer DNS name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LoadBalancerDNS"
                }
            }
        },
        "APIGatewayURL": {
            "Description": "API Gateway endpoint URL",
            "Value": {
                "Fn::Sub": "https://${TransactionAPI}.execute-api.${AWS::Region}.amazonaws.com/prod"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-APIGatewayURL"
                }
            }
        },
        "ECSClusterName": {
            "Description": "ECS Cluster name",
            "Value": {
                "Ref": "ECSCluster"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ECSClusterName"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "Secrets Manager secret ARN for database credentials",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DatabaseSecretArn"
                }
            }
        }
    }
}
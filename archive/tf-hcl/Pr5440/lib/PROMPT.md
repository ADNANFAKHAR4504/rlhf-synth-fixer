Hey, I need to set up a comprehensive data infrastructure that works across three environments - dev, staging, and prod - for a financial services company. We're going to use Terraform workspaces to manage everything from a single configuration, which should make it way easier to maintain consistency while still allowing for environment-specific tweaks where needed.

So basically, we need S3 buckets for data ingestion and DynamoDB tables for transaction processing in each environment. The S3 buckets should follow a strict naming convention like company-data-dev-eu-west-1 for the dev environment, company-data-staging-eu-west-1 for staging, and so on. Each bucket needs versioning enabled and server-side encryption, but here's the thing - we need to use different KMS keys for each environment, and all these keys should have automatic rotation enabled. The buckets also need different lifecycle policies depending on the environment - dev objects should transition to Glacier after 30 days, staging after 60 days, and prod after 90 days. Oh, and make sure all buckets block public access completely and include bucket policies that only allow access from specific VPC endpoints.

For the DynamoDB tables, we need consistent schema across all environments, but the capacity requirements are different. Dev should use on-demand billing mode since it's unpredictable, but staging needs provisioned capacity with 10 read and 10 write units, while prod needs 25 for both. The table naming should follow the same convention as the buckets - like company-transactions-dev-eu-west-1-table. Also, we only want point-in-time recovery enabled for staging and prod tables, not dev, since that's just for testing.

Security-wise, we need environment-specific IAM roles with least-privilege access. Each role should only be able to access its own environment's S3 bucket and DynamoDB table. The assume role policies need to include external ID requirements for extra security. The KMS keys also need different key policies per environment - dev can be more permissive for debugging, but staging and prod should be locked down tight.

For monitoring, we need CloudWatch alarms for DynamoDB throttling events, but only in staging and production. These alarms should send notifications to different SNS topics based on the environment - like company-alerts-staging for staging and company-alerts-prod for production. We don't need alarms in dev since it's using on-demand billing anyway.

For file organization, split it into two files under the lib/ directory. Put the Terraform and provider configuration blocks in lib/provider.tf - that's just the terraform block with required providers and the provider "aws" blocks with regions and default tags. Everything else goes in lib/main.tf - data sources for getting account ID and region, then variables including a workspace map for environment-specific values, then locals for common_tags and environment-specific configurations using lookup functions, then a random_string resource for unique naming (8 chars, no special chars, lowercase only), then all the infrastructure resources organized with clear comment headers for KMS, S3, DynamoDB, IAM, SNS, and CloudWatch sections, and finally all the outputs at the bottom.

The key here is using Terraform locals and lookup functions to manage all the environment-specific values without duplicating code. We'll use terraform.workspace to determine which environment we're in and then use lookup functions to get the right values from maps defined in locals. Tags should be consistent across all resources with Environment, Project, and CostCenter tags, where Environment comes from the workspace name. The state files will be stored separately per workspace automatically when using workspaces with a remote backend. Make sure the configuration works with Terraform 1.0+ and AWS provider 5.0+, and remember that resource naming must follow the strict convention: company-{service}-{env}-{region}-{resource-type}.

Let me know if you need any clarification on the workspace setup or the environment-specific configurations!
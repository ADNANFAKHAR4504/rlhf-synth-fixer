image: $CI_REGISTRY/infrastructure/node:22-alpine

stages:
  - validate
  - build
  - test:unit
  - security
  - scan:compliance
  - test:performance
  - deploy:dev
  - test:integration
  - deploy:canary
  - test:smoke
  - deploy:staging
  - test:e2e
  - approval:production
  - deploy:production
  - monitor
  - rollback

variables:
  AWS_REGION: us-east-1
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  CDK_VERSION: "2.x"
  SENTRY_ORG: "myorg"
  DATADOG_SITE: "datadoghq.com"
  KUBE_NAMESPACE: "production"

.aws_credentials:
  id_tokens:
    AWS_ID_TOKEN:
      aud: https://gitlab.com
  before_script:
    - ./scripts/aws-auth.sh

.kubectl_setup:
  before_script:
    - aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
    - kubectl config set-context --current --namespace=$KUBE_NAMESPACE

lint:code:
  stage: validate
  script:
    - npm ci
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches

lint:yaml:
  stage: validate
  image: $CI_REGISTRY/infrastructure/alpine:latest
  before_script:
    - apk add --no-cache yamllint
  script:
    - yamllint -d relaxed .gitlab-ci.yml
  only:
    - merge_requests
    - main

lint:dockerfile:
  stage: validate
  image: $CI_REGISTRY/security/hadolint:latest
  script:
    - hadolint Dockerfile --format json > hadolint-report.json
  artifacts:
    paths:
      - hadolint-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    changes:
      - Dockerfile

validate:dependencies:
  stage: validate
  script:
    - npm ci
    - npm audit --audit-level=moderate --json > npm-audit.json
  artifacts:
    paths:
      - npm-audit.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

validate:license:
  stage: validate
  image: $CI_REGISTRY/security/license-checker:latest
  script:
    - license-checker --json > license-report.json
  artifacts:
    paths:
      - license-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

build:
  stage: build
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - npm ci
    - npx cdk synth --all
  artifacts:
    paths:
      - cdk.out/
    expire_in: 1 week
    reports:
      dotenv: build.env
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches

build:bundle:
  stage: build
  image: $CI_REGISTRY/infrastructure/node:22
  script:
    - npm ci
    - npm run build
    - npm run bundle
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches

test:unit:
  stage: test:unit
  image: $CI_REGISTRY/infrastructure/node:22
  script:
    - npm ci
    - npm run test:unit -- --coverage
  artifacts:
    reports:
      junit: test-results/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 1 week
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - branches

test:mutation:
  stage: test:unit
  image: $CI_REGISTRY/infrastructure/node:22
  script:
    - npm ci
    - npm run test:mutation
  artifacts:
    paths:
      - mutation-report/
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

security:sast:
  stage: security
  image: $CI_REGISTRY/security/semgrep:latest
  script:
    - semgrep --config=auto --json --output=sast-report.json .
  artifacts:
    reports:
      sast: sast-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

security:secrets:
  stage: security
  image: $CI_REGISTRY/security/trufflehog:latest
  script:
    - trufflehog filesystem . --json > secrets-report.json
  artifacts:
    paths:
      - secrets-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - merge_requests
    - main

security:sca:
  stage: security
  image: $CI_REGISTRY/security/snyk:latest
  script:
    - snyk test --json > snyk-report.json
  artifacts:
    paths:
      - snyk-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

security:cdk-nag:
  stage: security
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - npm ci
    - npm install -D cdk-nag
  needs:
    - build
  artifacts:
    paths:
      - cdk-nag-report.json
    expire_in: 1 week
  only:
    - merge_requests
    - main

security:dast:
  stage: security
  image: $CI_REGISTRY/security/zap:latest
  script:
    - ./scripts/run-dast.sh
  artifacts:
    paths:
      - zap-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

compliance:cis:
  stage: scan:compliance
  image: $CI_REGISTRY/security/checkov:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - checkov -d cdk.out --framework cloudformation --output json > cis-report.json
  artifacts:
    paths:
      - cis-report.json
    expire_in: 1 week
  needs:
    - build
  allow_failure: true
  only:
    - merge_requests
    - main

compliance:pci-dss:
  stage: scan:compliance
  image: $CI_REGISTRY/security/prowler:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - ./scripts/run-prowler.sh pci
  artifacts:
    paths:
      - prowler-pci-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main

compliance:hipaa:
  stage: scan:compliance
  image: $CI_REGISTRY/security/prowler:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - ./scripts/run-prowler.sh hipaa
  artifacts:
    paths:
      - prowler-hipaa-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main

compliance:soc2:
  stage: scan:compliance
  image: $CI_REGISTRY/security/cloudquery:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - ./scripts/run-soc2-audit.sh
  artifacts:
    paths:
      - soc2-audit-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - main

drift:detection:
  stage: scan:compliance
  image: $CI_REGISTRY/infrastructure/driftctl:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - driftctl scan --output json > drift-report.json
  artifacts:
    paths:
      - drift-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - schedules
    - main

cost:estimation:
  stage: scan:compliance
  image: $CI_REGISTRY/infrastructure/infracost:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - infracost breakdown --path cdk.out --format json > cost-estimate.json
  artifacts:
    paths:
      - cost-estimate.json
    expire_in: 1 week
  needs:
    - build
  only:
    - merge_requests
    - main

container:build:
  stage: build
  image: $CI_REGISTRY/infrastructure/docker:24
  services:
    - $CI_REGISTRY/infrastructure/docker:24-dind
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  script:
    - docker build -t $IMAGE_TAG .
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker push $IMAGE_TAG
  only:
    changes:
      - Dockerfile
      - src/**/*

container:scan:trivy:
  stage: security
  image: $CI_REGISTRY/security/trivy:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - trivy image --severity HIGH,CRITICAL --format json --output trivy-report.json $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  artifacts:
    reports:
      container_scanning: trivy-report.json
    expire_in: 1 week
  needs:
    - container:build
  only:
    changes:
      - Dockerfile
      - src/**/*

container:scan:grype:
  stage: security
  image: $CI_REGISTRY/security/grype:latest
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - grype $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -o json > grype-report.json
  artifacts:
    paths:
      - grype-report.json
    expire_in: 1 week
  needs:
    - container:build
  allow_failure: true
  only:
    changes:
      - Dockerfile
      - src/**/*

container:sbom:
  stage: security
  image: $CI_REGISTRY/security/syft:latest
  script:
    - syft $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -o json > sbom.json
  artifacts:
    paths:
      - sbom.json
    expire_in: 1 week
  needs:
    - container:build
  only:
    changes:
      - Dockerfile
      - src/**/*

performance:lighthouse:
  stage: test:performance
  image: $CI_REGISTRY/testing/lighthouse:latest
  script:
    - ./scripts/run-lighthouse.sh
  artifacts:
    paths:
      - lighthouse-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

performance:k6:
  stage: test:performance
  image: $CI_REGISTRY/testing/k6:latest
  script:
    - k6 run --out json=k6-results.json tests/load/script.js
  artifacts:
    paths:
      - k6-results.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

performance:artillery:
  stage: test:performance
  image: $CI_REGISTRY/testing/artillery:latest
  script:
    - artillery run tests/load/scenario.yml -o artillery-report.json
  artifacts:
    paths:
      - artillery-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

deploy:dev:
  stage: deploy:dev
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  environment:
    name: development
    url: https://dev.example.com
    on_stop: cleanup:dev
    auto_stop_in: 1 week
    deployment_tier: development
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
    ENVIRONMENT: dev
  script:
    - npm ci
    - ./scripts/deploy.sh
  artifacts:
    paths:
      - deployment-output.json
    expire_in: 1 week
  needs:
    - build
    - security:cdk-nag
    - test:unit
  only:
    - main
    - develop

cleanup:dev:
  stage: deploy:dev
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  environment:
    name: development
    action: stop
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - npx cdk destroy --all --force --context environment=dev
  when: manual
  only:
    - main
    - develop

test:integration:api:
  stage: test:integration
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
    TEST_ENDPOINT: https://dev.example.com
  script:
    - npm ci
    - npm run test:integration:api
  artifacts:
    reports:
      junit: integration-results.xml
    expire_in: 1 week
  needs:
    - deploy:dev
  only:
    - main
    - develop

test:integration:db:
  stage: test:integration
  image: $CI_REGISTRY/infrastructure/node:22
  extends: .aws_credentials
  variables:
    AWS_ACCOUNT_ID: $DEV_ACCOUNT_ID
  script:
    - npm ci
    - npm run test:integration:db
  artifacts:
    reports:
      junit: db-integration-results.xml
    expire_in: 1 week
  needs:
    - deploy:dev
  only:
    - main
    - develop

test:integration:contract:
  stage: test:integration
  image: $CI_REGISTRY/testing/pact:latest
  script:
    - npm ci
    - npm run test:contract
  artifacts:
    paths:
      - pacts/
    expire_in: 1 week
  needs:
    - deploy:dev
  allow_failure: true
  only:
    - main
    - develop

deploy:canary:
  stage: deploy:canary
  image: $CI_REGISTRY/infrastructure/node:22
  extends:
    - .aws_credentials
    - .kubectl_setup
  environment:
    name: canary
    url: https://canary.example.com
    deployment_tier: staging
  variables:
    AWS_ACCOUNT_ID: $STAGING_ACCOUNT_ID
    ENVIRONMENT: canary
    EKS_CLUSTER_NAME: staging-cluster
    CANARY_WEIGHT: "10"
  script:
    - npm ci
    - ./scripts/deploy-canary.sh
  artifacts:
    paths:
      - canary-deployment.json
    expire_in: 1 week
  needs:
    - test:integration:api
    - test:integration:db
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: never

test:smoke:canary:
  stage: test:smoke
  image: $CI_REGISTRY/testing/postman:latest
  script:
    - newman run tests/smoke/canary.postman_collection.json --environment canary.env.json
  artifacts:
    paths:
      - newman-report.json
    expire_in: 1 week
  needs:
    - deploy:canary
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

monitor:canary:metrics:
  stage: test:smoke
  image: $CI_REGISTRY/monitoring/datadog:latest
  script:
    - ./scripts/monitor-canary.sh
  artifacts:
    paths:
      - canary-metrics.json
    expire_in: 1 week
  needs:
    - deploy:canary
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

promote:canary:
  stage: deploy:staging
  image: $CI_REGISTRY/infrastructure/node:22
  extends:
    - .aws_credentials
    - .kubectl_setup
  environment:
    name: staging
    url: https://staging.example.com
    deployment_tier: staging
  variables:
    AWS_ACCOUNT_ID: $STAGING_ACCOUNT_ID
    ENVIRONMENT: staging
    EKS_CLUSTER_NAME: staging-cluster
  script:
    - npm ci
    - ./scripts/promote-canary.sh
  needs:
    - test:smoke:canary
    - monitor:canary:metrics
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: never

deploy:staging:blue-green:
  stage: deploy:staging
  image: $CI_REGISTRY/infrastructure/node:22
  extends:
    - .aws_credentials
    - .kubectl_setup
  environment:
    name: staging
    url: https://staging.example.com
    deployment_tier: staging
  variables:
    AWS_ACCOUNT_ID: $STAGING_ACCOUNT_ID
    ENVIRONMENT: staging
    EKS_CLUSTER_NAME: staging-cluster
    DEPLOYMENT_STRATEGY: blue-green
  script:
    - npm ci
    - ./scripts/deploy-blue-green.sh
  artifacts:
    paths:
      - blue-green-deployment.json
    expire_in: 1 week
  needs:
    - promote:canary
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

test:e2e:cypress:
  stage: test:e2e
  image: $CI_REGISTRY/testing/cypress:latest
  variables:
    CYPRESS_BASE_URL: https://staging.example.com
  script:
    - npm ci
    - npm run test:e2e
  artifacts:
    when: always
    paths:
      - cypress/videos/
      - cypress/screenshots/
    reports:
      junit: cypress-results.xml
    expire_in: 1 week
  needs:
    - deploy:staging:blue-green
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

test:e2e:playwright:
  stage: test:e2e
  image: $CI_REGISTRY/testing/playwright:latest
  variables:
    PLAYWRIGHT_BASE_URL: https://staging.example.com
  script:
    - npm ci
    - npm run test:playwright
  artifacts:
    when: always
    paths:
      - playwright-report/
    reports:
      junit: playwright-results.xml
    expire_in: 1 week
  needs:
    - deploy:staging:blue-green
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

test:accessibility:
  stage: test:e2e
  image: $CI_REGISTRY/testing/axe:latest
  script:
    - ./scripts/run-a11y-tests.sh
  artifacts:
    paths:
      - accessibility-report.json
    expire_in: 1 week
  needs:
    - deploy:staging:blue-green
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

approval:security:
  stage: approval:production
  image: $CI_REGISTRY/infrastructure/alpine:latest
  script:
    - echo "Security team approval required"
  when: manual
  needs:
    - test:e2e:cypress
    - test:e2e:playwright
  only:
    - main

approval:product:
  stage: approval:production
  image: $CI_REGISTRY/infrastructure/alpine:latest
  script:
    - echo "Product team approval required"
  when: manual
  needs:
    - test:e2e:cypress
    - test:e2e:playwright
  only:
    - main

deploy:production:
  stage: deploy:production
  image: $CI_REGISTRY/infrastructure/node:22
  extends:
    - .aws_credentials
    - .kubectl_setup
  environment:
    name: production
    url: https://example.com
    deployment_tier: production
  variables:
    AWS_ACCOUNT_ID: $PROD_ACCOUNT_ID
    ENVIRONMENT: production
    EKS_CLUSTER_NAME: production-cluster
  script:
    - npm ci
    - ./scripts/deploy.sh
  needs:
    - approval:security
    - approval:product
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: false
    - when: never
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

test:smoke:production:
  stage: monitor
  image: $CI_REGISTRY/testing/postman:latest
  script:
    - newman run tests/smoke/production.postman_collection.json --environment production.env.json
  artifacts:
    paths:
      - production-smoke-results.json
    expire_in: 1 week
  needs:
    - deploy:production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

monitor:sentry:release:
  stage: monitor
  image: $CI_REGISTRY/monitoring/sentry-cli:latest
  script:
    - sentry-cli releases new $CI_COMMIT_SHORT_SHA
    - sentry-cli releases set-commits $CI_COMMIT_SHORT_SHA --auto
    - sentry-cli releases finalize $CI_COMMIT_SHORT_SHA
  needs:
    - deploy:production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

monitor:datadog:deployment:
  stage: monitor
  image: $CI_REGISTRY/monitoring/datadog:latest
  script:
    - ./scripts/create-datadog-event.sh
  needs:
    - deploy:production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

monitor:synthetic:
  stage: monitor
  image: $CI_REGISTRY/monitoring/datadog:latest
  script:
    - ./scripts/run-synthetic-tests.sh
  artifacts:
    paths:
      - synthetic-results.json
    expire_in: 1 week
  needs:
    - deploy:production
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

rollback:production:
  stage: rollback
  image: $CI_REGISTRY/infrastructure/node:22
  extends:
    - .aws_credentials
    - .kubectl_setup
  environment:
    name: production
    action: rollback
  variables:
    AWS_ACCOUNT_ID: $PROD_ACCOUNT_ID
    ENVIRONMENT: production
    EKS_CLUSTER_NAME: production-cluster
  script:
    - ./scripts/rollback.sh
  when: manual
  needs:
    - deploy:production
  only:
    - main

notify:slack:
  stage: .post
  image: $CI_REGISTRY/infrastructure/curl:latest
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"Pipeline $CI_PIPELINE_STATUS for $CI_PROJECT_NAME on $CI_COMMIT_BRANCH\"}"
  when: always
  only:
    - main
    - develop

notify:pagerduty:
  stage: .post
  image: $CI_REGISTRY/infrastructure/curl:latest
  script:
    - ./scripts/notify-pagerduty.sh
  when: on_failure
  only:
    - main


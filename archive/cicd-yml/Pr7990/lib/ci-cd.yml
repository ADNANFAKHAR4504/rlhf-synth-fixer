---
# CI/CD Pipeline Configuration
# This workflow demonstrates a multi-stage Pulumi deployment pipeline

name: Pulumi CI/CD Pipeline

"on":
  workflow_dispatch:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

jobs:
  source:
    name: Source Stage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate source code
        run: |
          echo "Source validation passed"
          ls -la

  build:
    name: Build Stage
    runs-on: ubuntu-latest
    needs: source
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pulumi

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Pulumi preview
        run: |
          pulumi login
          pulumi stack select dev --create
          pulumi preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ env.PULUMI_ACCESS_TOKEN }}

  test:
    name: Test Stage
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run unit tests
        run: |
          PYTHONPATH=. pytest tests/unit/ -v --cov=lib --cov-report=term-missing

      - name: Run integration tests
        run: |
          PYTHONPATH=. pytest tests/integration/ -v

  security-scan:
    name: SecurityScan Stage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install security scanning tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          bandit -r lib/ -f json -o bandit-report.json || true
          bandit -r lib/ -ll

      - name: Check for known vulnerabilities
        run: |
          safety check --json || echo "Safety check completed"

  deploy:
    name: Deploy Stage
    runs-on: ubuntu-latest
    needs: security-scan
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pulumi

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Pulumi up
        run: |
          pulumi login
          pulumi stack select prod --create
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ env.PULUMI_ACCESS_TOKEN }}

      - name: Send notification on failure
        if: failure()
        run: |
          echo "Deployment failed - notification would be sent to SNS topic"
          # In real scenario:
          # aws sns publish --topic-arn $SNS_TOPIC_ARN --message "Failed"

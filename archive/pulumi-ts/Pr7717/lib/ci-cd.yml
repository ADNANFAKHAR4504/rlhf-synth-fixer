# CI/CD Pipeline Configuration for CodeBuild Infrastructure
# Multi-stage deployment pipeline for Pulumi TypeScript CodeBuild infrastructure
---
name: CodeBuild Infrastructure - Deployment Pipeline

'on':
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'
  PULUMI_VERSION: 'latest'
  DEV_ACCOUNT_ID: ${{ secrets.DEV_ACCOUNT_ID }}
  STAGING_ACCOUNT_ID: ${{ secrets.STAGING_ACCOUNT_ID }}
  PROD_ACCOUNT_ID: ${{ secrets.PROD_ACCOUNT_ID }}
  NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}

jobs:
  source:
    name: Source Stage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Source

  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    needs: source
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: ${{ env.PULUMI_VERSION }}

      - name: Install dependencies
        run: |
          npm ci

      - name: Run TypeScript linting
        run: |
          npm run lint

      - name: Build TypeScript
        run: |
          npm run build

      - name: Run Pulumi preview
        run: |
          export PULUMI_STACK="ci"
          export ENVIRONMENT_SUFFIX="ci-preview"
          pulumi stack select $PULUMI_STACK --create
          pulumi preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Validate CodeBuild configuration
        run: |
          echo "Validating CodeBuild project configuration..."
          # Verify required environment variables
          [ -n "$NOTIFICATION_EMAIL" ] || echo "Warning: NOTIFICATION_EMAIL not set"
          echo "Validation complete"

      - name: Run security checks
        run: |
          # Install checkov for IaC security scanning
          pip install checkov
          checkov -d . --framework terraform --quiet
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulumi-outputs
          path: |
            dist/
            package.json
            package-lock.json
          retention-days: 7

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Run unit tests
        run: |
          npm run test:unit

      - name: Check test coverage
        run: |
          npm run test:coverage
          # Verify 100% coverage
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 100" | bc -l) )); then
              echo "Warning: Coverage below 100%"
            fi
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [build, test]
    environment: dev
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pulumi-outputs
          path: artifacts/
        continue-on-error: true

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: ${{ env.PULUMI_VERSION }}

      - name: Install dependencies
        run: |
          npm ci

      - name: Deploy CodeBuild Infrastructure to Dev
        run: |
          export PULUMI_STACK="dev"
          export ENVIRONMENT_SUFFIX="dev-$(date +%s)"
          pulumi stack select $PULUMI_STACK --create
          pulumi config set environmentSuffix $ENVIRONMENT_SUFFIX
          pulumi config set notificationEmail ${{ env.NOTIFICATION_EMAIL }}
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Verify CodeBuild deployment
        run: |
          pulumi stack output
          # Verify CodeBuild project exists
          PROJECT_NAME=$(pulumi stack output codeBuildProjectName)
          echo "CodeBuild Project: $PROJECT_NAME"
          aws codebuild list-projects --region ${{ env.AWS_REGION }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Run integration tests
        run: |
          npm run test:integration
        continue-on-error: true

      - name: Send SNS notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          TOPIC_ARN=$(pulumi stack output snsTopicArn)
          aws sns publish \
            --topic-arn "$TOPIC_ARN" \
            --message "Dev deployment $STATUS for CodeBuild infrastructure" \
            --region ${{ env.AWS_REGION }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

  manual-approval-staging:
    name: Approve Staging Deployment
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: staging-approval
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Manual approval checkpoint
        run: echo "Deployment to staging approved"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: manual-approval-staging
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pulumi-outputs
          path: artifacts/
        continue-on-error: true

      - name: Assume cross-account role for Staging via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: >-
            arn:aws:iam::${{ env.STAGING_ACCOUNT_ID }}:role/CrossAccountDeployRole
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Staging
          role-chaining: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: ${{ env.PULUMI_VERSION }}

      - name: Install dependencies
        run: |
          npm ci

      - name: Deploy CodeBuild Infrastructure to Staging
        run: |
          export PULUMI_STACK="staging"
          export ENVIRONMENT_SUFFIX="staging-$(date +%s)"
          pulumi stack select $PULUMI_STACK --create
          pulumi config set environmentSuffix $ENVIRONMENT_SUFFIX
          pulumi config set notificationEmail ${{ env.NOTIFICATION_EMAIL }}
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Run smoke tests
        run: |
          npm run test:integration -- --environment=staging
        continue-on-error: true

      - name: Verify CodeBuild project configuration
        run: |
          PROJECT_NAME=$(pulumi stack output codeBuildProjectName)
          aws codebuild batch-get-projects \
            --names "$PROJECT_NAME" \
            --region ${{ env.AWS_REGION }} \
            --query 'projects[0].[name,environment.computeType,buildTimeout]'
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Send SNS notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          TOPIC_ARN=$(pulumi stack output snsTopicArn)
          aws sns publish \
            --topic-arn "$TOPIC_ARN" \
            --message "Staging deployment $STATUS for CodeBuild infrastructure" \
            --region ${{ env.AWS_REGION }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

  manual-approval-prod:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: prod-approval
    steps:
      - name: Manual approval checkpoint
        run: echo "Deployment to production approved"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: manual-approval-prod
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pulumi-outputs
          path: artifacts/
        continue-on-error: true

      - name: Assume cross-account role for Production via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: >-
            arn:aws:iam::${{ env.PROD_ACCOUNT_ID }}:role/CrossAccountDeployRole
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Prod
          role-chaining: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: ${{ env.PULUMI_VERSION }}

      - name: Install dependencies
        run: |
          npm ci

      - name: Create backup of existing infrastructure
        run: |
          BACKUP_FILE="prod-backup-$(date +%Y%m%d-%H%M%S).json"
          pulumi stack export > "$BACKUP_FILE"
          aws s3 cp "$BACKUP_FILE" s3://infrastructure-backups/codebuild/
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Deploy CodeBuild Infrastructure to Production
        run: |
          export PULUMI_STACK="prod"
          export ENVIRONMENT_SUFFIX="prod"
          pulumi stack select $PULUMI_STACK --create
          pulumi config set environmentSuffix $ENVIRONMENT_SUFFIX
          pulumi config set notificationEmail ${{ env.NOTIFICATION_EMAIL }}
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Run production smoke tests
        run: |
          npm run test:integration -- --environment=prod
        continue-on-error: true

      - name: Verify all services
        run: |
          pulumi stack output
          PROJECT_NAME=$(pulumi stack output codeBuildProjectName)
          BUCKET_NAME=$(pulumi stack output artifactBucketName)
          TOPIC_ARN=$(pulumi stack output snsTopicArn)
          echo "CodeBuild Project: $PROJECT_NAME"
          echo "Artifact Bucket: $BUCKET_NAME"
          echo "SNS Topic ARN: $TOPIC_ARN"
          # Verify resources exist
          aws codebuild batch-get-projects --names "$PROJECT_NAME" --region ${{ env.AWS_REGION }}
          aws s3 ls "s3://$BUCKET_NAME" --region ${{ env.AWS_REGION }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Send SNS notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          TOPIC_ARN=$(pulumi stack output snsTopicArn)
          aws sns publish \
            --topic-arn "$TOPIC_ARN" \
            --subject "Production Deployment Status" \
            --message "Production deployment $STATUS for CodeBuild infrastructure - ${{ github.ref }}" \
            --region ${{ env.AWS_REGION }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        continue-on-error: true

  rollback:
    name: Rollback (Manual Trigger)
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-dev, deploy-staging, deploy-prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: ${{ env.PULUMI_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Destroy failed CodeBuild deployment
        run: |
          export PULUMI_STACK="${{ github.event.inputs.environment }}"
          pulumi stack select $PULUMI_STACK
          pulumi destroy --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Notify rollback
        run: |
          echo "Rollback initiated for CodeBuild infrastructure"
          # Send notification via SNS if topic exists
        continue-on-error: true

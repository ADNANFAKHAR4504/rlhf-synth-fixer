# lib/ci-cd.yml
# Enterprise GitLab CI/CD - Pulumi IaC Pipeline with OIDC, multi-environment (dev/staging/prod)
# Images: pulled from private registry using $CI_REGISTRY/<category>/<tool>:<version>
# No hardcoded credentials or account IDs.

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
    - when: always

stages:
  - validation
  - build
  - test
  - security
  - compliance
  - dev_deploy
  - integration
  - staging_deploy
  - prod_approval
  - prod_deploy
  - monitoring
  - rollback

default:
  interruptible: true
  retry:
    max: 1
    when:
      - runner_system_failure
      - api_failure
      - scheduler_failure
  artifacts:
    expire_in: 1 week
  cache:
    key: "node-${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
    policy: pull-push
  before_script:
    - echo "Starting $CI_JOB_NAME in stage $CI_JOB_STAGE"

# -------------------------
# Anchors (reusable blocks)
# -------------------------
.aws_oidc_setup: &aws_oidc_setup
  image: $CI_REGISTRY/cli/awscli:2
  before_script:
    - mkdir -p .aws
    - echo "$CI_JOB_JWT_V2" > .aws/web_identity_token
    - export AWS_WEB_IDENTITY_TOKEN_FILE="$CI_PROJECT_DIR/.aws/web_identity_token"
    - export AWS_REGION="${AWS_REGION:-us-east-1}"
    - export ACCOUNT_ID="${ACCOUNT_ID:?ACCOUNT_ID missing}"
    - export AWS_ROLE_ARN="arn:aws:iam::${ACCOUNT_ID}:role/GitLabCIRole"
    - aws sts assume-role-with-web-identity
        --role-arn "$AWS_ROLE_ARN"
        --role-session-name "gitlab-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"
        --web-identity-token file://$AWS_WEB_IDENTITY_TOKEN_FILE
        --duration-seconds 3600 > .aws/creds.json
    - export AWS_ACCESS_KEY_ID=$(jq -r '.Credentials.AccessKeyId' .aws/creds.json)
    - export AWS_SECRET_ACCESS_KEY=$(jq -r '.Credentials.SecretAccessKey' .aws/creds.json)
    - export AWS_SESSION_TOKEN=$(jq -r '.Credentials.SessionToken' .aws/creds.json)

.node_runtime: &node_runtime
  image: $CI_REGISTRY/ci/node:22
  before_script:
    - node --version
    - npm --version

.pulumi_setup: &pulumi_setup
  image: $CI_REGISTRY/ci/node:22
  before_script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - pulumi version
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION:-us-east-1}"

# -------------------------
# Validation
# -------------------------
lint:
  stage: validation
  <<: *node_runtime
  rules:
    - changes:
        - "**/*.ts"
        - "**/*.js"
        - package.json
        - eslint.config.*
        - .eslintrc.*
  script:
    - npm ci
    - npm run lint
  artifacts:
    reports:
      junit: reports/junit/lint.xml

license_check:
  stage: validation
  <<: *node_runtime
  rules:
    - changes:
        - package-lock.json
        - package.json
  script:
    - npm ci
    - npx license-checker --production --json > reports/license.json
    - test -s reports/license.json
  artifacts:
    paths:
      - reports/license.json

npm_audit:
  stage: validation
  <<: *node_runtime
  rules:
    - changes:
        - package-lock.json
        - package.json
  script:
    - npm ci
    - npm audit --audit-level=high --omit=dev
  artifacts:
    reports:
      junit: reports/junit/npm-audit.xml

validate_commit:
  stage: validation
  <<: *node_runtime
  script:
    - npm ci
    - npx commitlint --last
  allow_failure: true

# -------------------------
# Build
# -------------------------
build:
  stage: build
  <<: *node_runtime
  rules:
    - changes:
        - "**/*.ts"
        - "lib/**"
        - "bin/**"
        - "package*.json"
        - "tsconfig.json"
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/

pulumi_preview:
  stage: build
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $DEV_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  rules:
    - changes:
        - "lib/**"
        - "bin/**"
        - "Pulumi.yaml"
        - "Pulumi.*.yaml"
  script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX:-dev} --create
    - pulumi preview --diff
  artifacts:
    paths:
      - pulumi-preview.txt

# -------------------------
# Testing
# -------------------------
unit_tests:
  stage: test
  <<: *node_runtime
  rules:
    - changes:
        - "**/*.ts"
        - "lib/**"
        - "test/**"
        - "jest.*"
  script:
    - npm ci
    - npm run test:unit -- --ci --coverage
  artifacts:
    reports:
      junit: reports/junit/unit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'

# -------------------------
# Security
# -------------------------
semgrep_sast:
  stage: security
  image: $CI_REGISTRY/security/semgrep:1.80
  rules:
    - changes:
        - "**/*.ts"
        - "**/*.js"
        - "lib/**"
        - "bin/**"
  script:
    - semgrep ci --config "p/ci" --json --output reports/semgrep.json
  artifacts:
    reports:
      sast: reports/semgrep.json
  allow_failure: false

trufflehog_secrets:
  stage: security
  image: $CI_REGISTRY/security/trufflehog:3
  rules:
    - changes:
        - "**/*"
  script:
    - trufflehog git --only-verified --fail --since-commit ${CI_MERGE_REQUEST_DIFF_BASE_SHA:-HEAD~50} --repo . --json > reports/trufflehog.json
  artifacts:
    paths:
      - reports/trufflehog.json
  allow_failure: false

snyk_sca:
  stage: security
  image: $CI_REGISTRY/security/snyk:latest
  rules:
    - changes:
        - "package*.json"
  script:
    - snyk test --severity-threshold=high --json-file-output=reports/snyk.json
  artifacts:
    paths:
      - reports/snyk.json

# -------------------------
# Compliance
# -------------------------
checkov_iac:
  stage: compliance
  image: $CI_REGISTRY/compliance/checkov:3
  rules:
    - changes:
        - "lib/**"
        - "bin/**"
  script:
    - checkov -d . --framework pulumi -o junitxml > reports/junit/checkov.xml || true
  artifacts:
    reports:
      junit: reports/junit/checkov.xml

infracost_estimate:
  stage: compliance
  image: $CI_REGISTRY/compliance/infracost:0.10
  rules:
    - changes:
        - "lib/**"
        - "bin/**"
        - "Pulumi.yaml"
  script:
    - echo "Pulumi cost estimation via Infracost"
    - infracost breakdown --path . --format json --out-file reports/infracost.json || true
  artifacts:
    paths:
      - reports/infracost.json
  allow_failure: true

# -------------------------
# Dev Deploy
# -------------------------
deploy_dev:
  stage: dev_deploy
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $DEV_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
    ENVIRONMENT_SUFFIX: dev
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - "lib/**"
        - "bin/**"
        - "Pulumi.yaml"
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - "lib/**"
        - "bin/**"
        - "Pulumi.yaml"
  script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX} --create
    - pulumi up --yes --stack TapStack${ENVIRONMENT_SUFFIX}
  environment:
    name: dev/$CI_COMMIT_REF_SLUG
    url: https://dev.example.com
    on_stop: stop_dev
    auto_stop_in: 1 week
    tier: development
  artifacts:
    reports:
      junit: reports/junit/dev-deploy.xml
  needs:
    - build
    - unit_tests

stop_dev:
  stage: dev_deploy
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $DEV_ACCOUNT_ID
    ENVIRONMENT_SUFFIX: dev
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  when: manual
  script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX}
    - pulumi destroy --yes --stack TapStack${ENVIRONMENT_SUFFIX}
  environment:
    name: dev/$CI_COMMIT_REF_SLUG
    action: stop
    tier: development

# -------------------------
# Integration Testing
# -------------------------
integration_tests:
  stage: integration
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $DEV_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
  rules:
    - changes:
        - "test/**"
        - "lib/**"
  script:
    - npm ci
    - ./scripts/flat-outputs.sh || true
    - npm run test:integration
  artifacts:
    reports:
      junit: reports/junit/integration.xml
  needs:
    - deploy_dev

# -------------------------
# Staging Deploy
# -------------------------
deploy_staging:
  stage: staging_deploy
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $STAGING_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
    ENVIRONMENT_SUFFIX: staging
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  when: manual
  script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX} --create
    - pulumi up --yes --stack TapStack${ENVIRONMENT_SUFFIX}
  environment:
    name: staging
    url: https://staging.example.com
    tier: staging
  needs:
    - integration_tests

# -------------------------
# Production Approvals
# -------------------------
prod_security_approval:
  stage: prod_approval
  when: manual
  script:
    - echo "Security team approval granted"
  needs:
    - deploy_staging

prod_product_approval:
  stage: prod_approval
  when: manual
  script:
    - echo "Product team approval granted"
  needs:
    - deploy_staging

# -------------------------
# Production Deploy
# -------------------------
deploy_prod:
  stage: prod_deploy
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $PROD_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
    ENVIRONMENT_SUFFIX: prod
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  when: manual
  script:
    - npm ci
    - npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX} --create
    - pulumi up --yes --stack TapStack${ENVIRONMENT_SUFFIX}
  environment:
    name: production
    url: https://app.example.com
    tier: production
  needs:
    - prod_security_approval
    - prod_product_approval
  retry:
    max: 2
    when:
      - script_failure

# -------------------------
# Monitoring
# -------------------------
monitor_release:
  stage: monitoring
  image: $CI_REGISTRY/ops/node-tools:22
  rules:
    - changes:
        - "scripts/create-datadog-event.sh"
  script:
    - export SENTRY_RELEASE="${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}"
    - npm ci && npx @sentry/cli releases new "$SENTRY_RELEASE" || true
    - bash scripts/create-datadog-event.sh "Deployed ${CI_COMMIT_SHORT_SHA} to ${CI_ENVIRONMENT_NAME}" || true
  needs:
    - deploy_prod
  allow_failure: true

# -------------------------
# Rollback
# -------------------------
rollback_prod:
  stage: rollback
  <<: *aws_oidc_setup
  variables:
    ACCOUNT_ID: $PROD_ACCOUNT_ID
    AWS_REGION: ${AWS_REGION:-us-east-1}
    ENVIRONMENT_SUFFIX: prod
    PULUMI_STATE_BUCKET: $PULUMI_STATE_BUCKET
  when: manual
  script:
    - npm ci && npm install -g @pulumi/pulumi
    - export PULUMI_BACKEND_URL="s3://${PULUMI_STATE_BUCKET}?region=${AWS_REGION}"
    - pulumi stack select TapStack${ENVIRONMENT_SUFFIX} && pulumi stack history | head -20
  environment:
    name: production
    action: rollback
    tier: production
  needs:
    - deploy_prod

# -------------------------
# Notifications
# -------------------------
notify_slack_success:
  stage: monitoring
  image: $CI_REGISTRY/ops/curl:8
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - 'curl -sS -X POST "$SLACK_WEBHOOK_URL" -H "Content-type: application/json" -d "{\"text\":\"[OK] Pulumi pipeline completed for *${CI_COMMIT_BRANCH}* @ *${CI_COMMIT_SHORT_SHA}*\"}"'
  allow_failure: true

notify_pagerduty_on_fail:
  stage: monitoring
  image: $CI_REGISTRY/ops/curl:8
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: on_failure
  script:
    - bash scripts/notify-pagerduty.sh "Main pipeline failed for ${CI_COMMIT_SHORT_SHA}" || true
  allow_failure: true

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const s3Client = new client_s3_1.S3Client({});
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const handler = async (event) => {
    console.log('Event received:', JSON.stringify(event, null, 2));
    const bucketName = process.env.BUCKET_NAME;
    const auditTable = process.env.AUDIT_TABLE;
    try {
        // Process S3 event
        for (const record of event.Records || []) {
            const s3Event = record.s3;
            const key = s3Event.object.key;
            console.log(`Processing file: ${key}`);
            // Get object from S3
            const getCommand = new client_s3_1.GetObjectCommand({
                Bucket: bucketName,
                Key: key,
            });
            await s3Client.send(getCommand);
            // Log to audit table
            const timestamp = new Date().toISOString();
            const auditCommand = new client_dynamodb_1.PutItemCommand({
                TableName: auditTable,
                Item: {
                    id: { S: `${timestamp}-${key}` },
                    timestamp: { S: timestamp },
                    action: { S: 'FILE_PROCESSED' },
                    fileName: { S: key },
                    status: { S: 'SUCCESS' },
                },
            });
            await dynamoClient.send(auditCommand);
            console.log(`Audit log created for: ${key}`);
        }
        return {
            statusCode: 200,
            body: JSON.stringify({ message: 'Processing complete' }),
        };
    }
    catch (error) {
        console.error('Error processing:', error);
        // Log error to audit table
        const timestamp = new Date().toISOString();
        const auditCommand = new client_dynamodb_1.PutItemCommand({
            TableName: auditTable,
            Item: {
                id: { S: `${timestamp}-error` },
                timestamp: { S: timestamp },
                action: { S: 'PROCESSING_ERROR' },
                error: { S: String(error) },
                status: { S: 'FAILED' },
            },
        });
        await dynamoClient.send(auditCommand);
        throw error;
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbGFtYmRhL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUFnRTtBQUNoRSw4REFBMEU7QUFFMUUsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2xDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQVlyQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBYyxFQUFFLEVBQUU7SUFDOUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUvRCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztJQUM1QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztJQUU1QyxJQUFJLENBQUM7UUFDSCxtQkFBbUI7UUFDbkIsS0FBSyxNQUFNLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDMUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7WUFFL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUV2QyxxQkFBcUI7WUFDckIsTUFBTSxVQUFVLEdBQUcsSUFBSSw0QkFBZ0IsQ0FBQztnQkFDdEMsTUFBTSxFQUFFLFVBQVU7Z0JBQ2xCLEdBQUcsRUFBRSxHQUFHO2FBQ1QsQ0FBQyxDQUFDO1lBRUgsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRWhDLHFCQUFxQjtZQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzNDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQztnQkFDdEMsU0FBUyxFQUFFLFVBQVU7Z0JBQ3JCLElBQUksRUFBRTtvQkFDSixFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxTQUFTLElBQUksR0FBRyxFQUFFLEVBQUU7b0JBQ2hDLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUU7b0JBQzNCLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxnQkFBZ0IsRUFBRTtvQkFDL0IsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRTtvQkFDcEIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRTtpQkFDekI7YUFDRixDQUFDLENBQUM7WUFFSCxNQUFNLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMvQyxDQUFDO1FBRUQsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsQ0FBQztTQUN6RCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTFDLDJCQUEyQjtRQUMzQixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzNDLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQztZQUN0QyxTQUFTLEVBQUUsVUFBVTtZQUNyQixJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsU0FBUyxRQUFRLEVBQUU7Z0JBQy9CLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUU7Z0JBQzNCLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxrQkFBa0IsRUFBRTtnQkFDakMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDM0IsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRTthQUN4QjtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV0QyxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFoRVcsUUFBQSxPQUFPLFdBZ0VsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBQdXRJdGVtQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHt9KTtcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5cbmludGVyZmFjZSBTM0V2ZW50IHtcbiAgUmVjb3Jkcz86IEFycmF5PHtcbiAgICBzMzoge1xuICAgICAgb2JqZWN0OiB7XG4gICAgICAgIGtleTogc3RyaW5nO1xuICAgICAgfTtcbiAgICB9O1xuICB9Pjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IFMzRXZlbnQpID0+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50IHJlY2VpdmVkOicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgY29uc3QgYnVja2V0TmFtZSA9IHByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FITtcbiAgY29uc3QgYXVkaXRUYWJsZSA9IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFITtcblxuICB0cnkge1xuICAgIC8vIFByb2Nlc3MgUzMgZXZlbnRcbiAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiBldmVudC5SZWNvcmRzIHx8IFtdKSB7XG4gICAgICBjb25zdCBzM0V2ZW50ID0gcmVjb3JkLnMzO1xuICAgICAgY29uc3Qga2V5ID0gczNFdmVudC5vYmplY3Qua2V5O1xuXG4gICAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyBmaWxlOiAke2tleX1gKTtcblxuICAgICAgLy8gR2V0IG9iamVjdCBmcm9tIFMzXG4gICAgICBjb25zdCBnZXRDb21tYW5kID0gbmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgICBCdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgICAgIEtleToga2V5LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQoZ2V0Q29tbWFuZCk7XG5cbiAgICAgIC8vIExvZyB0byBhdWRpdCB0YWJsZVxuICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgY29uc3QgYXVkaXRDb21tYW5kID0gbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBhdWRpdFRhYmxlLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgaWQ6IHsgUzogYCR7dGltZXN0YW1wfS0ke2tleX1gIH0sXG4gICAgICAgICAgdGltZXN0YW1wOiB7IFM6IHRpbWVzdGFtcCB9LFxuICAgICAgICAgIGFjdGlvbjogeyBTOiAnRklMRV9QUk9DRVNTRUQnIH0sXG4gICAgICAgICAgZmlsZU5hbWU6IHsgUzoga2V5IH0sXG4gICAgICAgICAgc3RhdHVzOiB7IFM6ICdTVUNDRVNTJyB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKGF1ZGl0Q29tbWFuZCk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGBBdWRpdCBsb2cgY3JlYXRlZCBmb3I6ICR7a2V5fWApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IG1lc3NhZ2U6ICdQcm9jZXNzaW5nIGNvbXBsZXRlJyB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHByb2Nlc3Npbmc6JywgZXJyb3IpO1xuXG4gICAgLy8gTG9nIGVycm9yIHRvIGF1ZGl0IHRhYmxlXG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIGNvbnN0IGF1ZGl0Q29tbWFuZCA9IG5ldyBQdXRJdGVtQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IGF1ZGl0VGFibGUsXG4gICAgICBJdGVtOiB7XG4gICAgICAgIGlkOiB7IFM6IGAke3RpbWVzdGFtcH0tZXJyb3JgIH0sXG4gICAgICAgIHRpbWVzdGFtcDogeyBTOiB0aW1lc3RhbXAgfSxcbiAgICAgICAgYWN0aW9uOiB7IFM6ICdQUk9DRVNTSU5HX0VSUk9SJyB9LFxuICAgICAgICBlcnJvcjogeyBTOiBTdHJpbmcoZXJyb3IpIH0sXG4gICAgICAgIHN0YXR1czogeyBTOiAnRkFJTEVEJyB9LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKGF1ZGl0Q29tbWFuZCk7XG5cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcbiJdfQ==
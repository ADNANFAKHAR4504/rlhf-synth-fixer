"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_cloudformation_1 = require("@aws-sdk/client-cloudformation");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_sns_1 = require("@aws-sdk/client-sns");
const region = process.env.AWS_REGION || 'us-east-1';
const cfnClient = new client_cloudformation_1.CloudFormationClient({ region });
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region });
const snsClient = new client_sns_1.SNSClient({ region });
const DRIFT_TABLE_NAME = process.env.DRIFT_TABLE_NAME;
const ALERT_TOPIC_ARN = process.env.ALERT_TOPIC_ARN;
const handler = async (event) => {
    console.log('Starting drift detection process', JSON.stringify(event));
    try {
        // Get all CloudFormation stacks
        const stacks = await listAllStacks();
        console.log(`Found ${stacks.length} stacks to analyze`);
        // Filter out test and sandbox stacks
        const filteredStacks = stacks.filter((stackName) => !stackName.toLowerCase().includes('test') &&
            !stackName.toLowerCase().includes('sandbox'));
        console.log(`Analyzing ${filteredStacks.length} stacks after filtering`);
        // Detect drift for each stack
        const driftResults = [];
        for (const stackName of filteredStacks) {
            try {
                const result = await detectStackDrift(stackName);
                driftResults.push(result);
            }
            catch (error) {
                console.error(`Error detecting drift for stack ${stackName}:`, error);
            }
        }
        // Store results in DynamoDB
        await Promise.all(driftResults.map((result) => storeDriftResult(result)));
        // Send alerts for stacks with drift
        const driftedStacks = driftResults.filter((result) => result.driftStatus === client_cloudformation_1.StackDriftStatus.DRIFTED);
        if (driftedStacks.length > 0) {
            await sendDriftAlert(driftedStacks);
        }
        console.log(`Drift detection complete. ${driftedStacks.length} stack(s) with drift detected`);
    }
    catch (error) {
        console.error('Error in drift detection process:', error);
        throw error;
    }
};
exports.handler = handler;
async function listAllStacks() {
    const stacks = [];
    let nextToken;
    do {
        const command = new client_cloudformation_1.ListStacksCommand({
            NextToken: nextToken,
            StackStatusFilter: [
                client_cloudformation_1.StackStatus.CREATE_COMPLETE,
                client_cloudformation_1.StackStatus.UPDATE_COMPLETE,
                client_cloudformation_1.StackStatus.UPDATE_ROLLBACK_COMPLETE,
                client_cloudformation_1.StackStatus.IMPORT_COMPLETE,
            ],
        });
        const response = await cfnClient.send(command);
        if (response.StackSummaries) {
            stacks.push(...response.StackSummaries.map((s) => s.StackName).filter(Boolean));
        }
        nextToken = response.NextToken;
    } while (nextToken);
    return stacks;
}
async function detectStackDrift(stackName) {
    console.log(`Detecting drift for stack: ${stackName}`);
    // Initiate drift detection
    const detectCommand = new client_cloudformation_1.DetectStackDriftCommand({
        StackName: stackName,
    });
    const detectResponse = await cfnClient.send(detectCommand);
    const driftDetectionId = detectResponse.StackDriftDetectionId;
    // Wait for drift detection to complete
    let detectionStatus = client_cloudformation_1.StackDriftDetectionStatus.DETECTION_IN_PROGRESS;
    let driftStatus = client_cloudformation_1.StackDriftStatus.NOT_CHECKED;
    let attempts = 0;
    const maxAttempts = 60; // 5 minutes max (5 seconds * 60)
    while (detectionStatus === client_cloudformation_1.StackDriftDetectionStatus.DETECTION_IN_PROGRESS &&
        attempts < maxAttempts) {
        await new Promise((resolve) => setTimeout(resolve, 5000));
        const statusCommand = new client_cloudformation_1.DescribeStackDriftDetectionStatusCommand({
            StackDriftDetectionId: driftDetectionId,
        });
        const statusResponse = await cfnClient.send(statusCommand);
        detectionStatus = statusResponse.DetectionStatus;
        driftStatus = statusResponse.StackDriftStatus || client_cloudformation_1.StackDriftStatus.NOT_CHECKED;
        attempts++;
    }
    if (detectionStatus !== client_cloudformation_1.StackDriftDetectionStatus.DETECTION_COMPLETE) {
        throw new Error(`Drift detection did not complete for stack ${stackName}. Status: ${detectionStatus}`);
    }
    // Get drifted resources if drift detected
    let driftedResources = [];
    let driftedResourcesCount = 0;
    if (driftStatus === client_cloudformation_1.StackDriftStatus.DRIFTED) {
        const driftsCommand = new client_cloudformation_1.DescribeStackResourceDriftsCommand({
            StackName: stackName,
            StackResourceDriftStatusFilters: ['MODIFIED', 'DELETED'],
        });
        try {
            const driftsResponse = await cfnClient.send(driftsCommand);
            if (driftsResponse.StackResourceDrifts) {
                driftedResourcesCount = driftsResponse.StackResourceDrifts.length;
                driftedResources = driftsResponse.StackResourceDrifts.map((drift) => ({
                    logicalResourceId: drift.LogicalResourceId,
                    resourceType: drift.ResourceType,
                    driftStatus: drift.StackResourceDriftStatus,
                }));
            }
        }
        catch (error) {
            console.error(`Error getting drifted resources for ${stackName}:`, error);
        }
    }
    return {
        stackName,
        driftStatus,
        driftedResourcesCount,
        detectionTimestamp: Date.now(),
        driftedResources,
    };
}
async function storeDriftResult(result) {
    const command = new client_dynamodb_1.PutItemCommand({
        TableName: DRIFT_TABLE_NAME,
        Item: {
            stackName: { S: result.stackName },
            timestamp: { N: result.detectionTimestamp.toString() },
            driftStatus: { S: result.driftStatus },
            driftedResourcesCount: { N: result.driftedResourcesCount.toString() },
            driftedResources: {
                S: JSON.stringify(result.driftedResources),
            },
        },
    });
    await dynamoClient.send(command);
    console.log(`Stored drift result for stack: ${result.stackName}`);
}
async function sendDriftAlert(driftedStacks) {
    const stackDetails = driftedStacks
        .map((stack) => `
Stack Name: ${stack.stackName}
Drift Status: ${stack.driftStatus}
Drifted Resources: ${stack.driftedResourcesCount}
Detection Time: ${new Date(stack.detectionTimestamp).toISOString()}

Drifted Resources Details:
${stack.driftedResources.map((r) => `  - ${r.logicalResourceId} (${r.resourceType}): ${r.driftStatus}`).join('\n')}
`)
        .join('\n---\n');
    const message = `
Infrastructure Drift Detected

${driftedStacks.length} CloudFormation stack(s) have configuration drift:

${stackDetails}

Please review and remediate the drifted resources to maintain infrastructure consistency.
  `.trim();
    const command = new client_sns_1.PublishCommand({
        TopicArn: ALERT_TOPIC_ARN,
        Subject: `Infrastructure Drift Alert - ${driftedStacks.length} Stack(s) Affected`,
        Message: message,
    });
    await snsClient.send(command);
    console.log(`Sent drift alert for ${driftedStacks.length} stack(s)`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwRUFTd0M7QUFDeEMsOERBR2tDO0FBQ2xDLG9EQUc2QjtBQUU3QixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXLENBQUM7QUFDckQsTUFBTSxTQUFTLEdBQUcsSUFBSSw0Q0FBb0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDdkQsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUNwRCxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBRTVDLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBaUIsQ0FBQztBQUN2RCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFjOUMsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVUsRUFBaUIsRUFBRTtJQUN6RCxPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUV2RSxJQUFJLENBQUM7UUFDSCxnQ0FBZ0M7UUFDaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxhQUFhLEVBQUUsQ0FBQztRQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsTUFBTSxDQUFDLE1BQU0sb0JBQW9CLENBQUMsQ0FBQztRQUV4RCxxQ0FBcUM7UUFDckMsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FDbEMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUNaLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDekMsQ0FBQyxTQUFTLENBQUMsV0FB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QUMsTUFBTTs7RUFFcEIsWUFBWTs7O0dBR1gsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVULE1BQU0sT0FBTyxHQUFHLElBQUksMkJBQWMsQ0FBQztRQUNqQyxRQUFRLEVBQUUsZUFBZTtRQUN6QixPQUFPLEVBQUUsZ0NBQWdDLGFBQWEsQ0FBQyxNQUFNLG9CQUFvQjtRQUNqRixPQUFPLEVBQUUsT0FBTztLQUNqQixDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsYUFBYSxDQUFDLE1BQU0sV0FBVyxDQUFDLENBQUM7QUFDdkUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBEZXRlY3RTdGFja0RyaWZ0Q29tbWFuZCxcbiAgRGVzY3JpYmVTdGFja0RyaWZ0RGV0ZWN0aW9uU3RhdHVzQ29tbWFuZCxcbiAgRGVzY3JpYmVTdGFja1Jlc291cmNlRHJpZnRzQ29tbWFuZCxcbiAgTGlzdFN0YWNrc0NvbW1hbmQsXG4gIFN0YWNrU3RhdHVzLFxuICBTdGFja0RyaWZ0RGV0ZWN0aW9uU3RhdHVzLFxuICBTdGFja0RyaWZ0U3RhdHVzLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHtcbiAgRHluYW1vREJDbGllbnQsXG4gIFB1dEl0ZW1Db21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgU05TQ2xpZW50LFxuICBQdWJsaXNoQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNucyc7XG5cbmNvbnN0IHJlZ2lvbiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMSc7XG5jb25zdCBjZm5DbGllbnQgPSBuZXcgQ2xvdWRGb3JtYXRpb25DbGllbnQoeyByZWdpb24gfSk7XG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb24gfSk7XG5jb25zdCBzbnNDbGllbnQgPSBuZXcgU05TQ2xpZW50KHsgcmVnaW9uIH0pO1xuXG5jb25zdCBEUklGVF9UQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuRFJJRlRfVEFCTEVfTkFNRSE7XG5jb25zdCBBTEVSVF9UT1BJQ19BUk4gPSBwcm9jZXNzLmVudi5BTEVSVF9UT1BJQ19BUk4hO1xuXG5pbnRlcmZhY2UgRHJpZnRSZXN1bHQge1xuICBzdGFja05hbWU6IHN0cmluZztcbiAgZHJpZnRTdGF0dXM6IFN0YWNrRHJpZnRTdGF0dXM7XG4gIGRyaWZ0ZWRSZXNvdXJjZXNDb3VudDogbnVtYmVyO1xuICBkZXRlY3Rpb25UaW1lc3RhbXA6IG51bWJlcjtcbiAgZHJpZnRlZFJlc291cmNlczogQXJyYXk8e1xuICAgIGxvZ2ljYWxSZXNvdXJjZUlkOiBzdHJpbmc7XG4gICAgcmVzb3VyY2VUeXBlOiBzdHJpbmc7XG4gICAgZHJpZnRTdGF0dXM6IHN0cmluZztcbiAgfT47XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIGRyaWZ0IGRldGVjdGlvbiBwcm9jZXNzJywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICB0cnkge1xuICAgIC8vIEdldCBhbGwgQ2xvdWRGb3JtYXRpb24gc3RhY2tzXG4gICAgY29uc3Qgc3RhY2tzID0gYXdhaXQgbGlzdEFsbFN0YWNrcygpO1xuICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke3N0YWNrcy5sZW5ndGh9IHN0YWNrcyB0byBhbmFseXplYCk7XG5cbiAgICAvLyBGaWx0ZXIgb3V0IHRlc3QgYW5kIHNhbmRib3ggc3RhY2tzXG4gICAgY29uc3QgZmlsdGVyZWRTdGFja3MgPSBzdGFja3MuZmlsdGVyKFxuICAgICAgKHN0YWNrTmFtZSkgPT5cbiAgICAgICAgIXN0YWNrTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCd0ZXN0JykgJiZcbiAgICAgICAgIXN0YWNrTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdzYW5kYm94JylcbiAgICApO1xuICAgIGNvbnNvbGUubG9nKGBBbmFseXppbmcgJHtmaWx0ZXJlZFN0YWNrcy5sZW5ndGh9IHN0YWNrcyBhZnRlciBmaWx0ZXJpbmdgKTtcblxuICAgIC8vIERldGVjdCBkcmlmdCBmb3IgZWFjaCBzdGFja1xuICAgIGNvbnN0IGRyaWZ0UmVzdWx0czogRHJpZnRSZXN1bHRbXSA9IFtdO1xuICAgIGZvciAoY29uc3Qgc3RhY2tOYW1lIG9mIGZpbHRlcmVkU3RhY2tzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkZXRlY3RTdGFja0RyaWZ0KHN0YWNrTmFtZSk7XG4gICAgICAgIGRyaWZ0UmVzdWx0cy5wdXNoKHJlc3VsdCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBkZXRlY3RpbmcgZHJpZnQgZm9yIHN0YWNrICR7c3RhY2tOYW1lfTpgLCBlcnJvcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3RvcmUgcmVzdWx0cyBpbiBEeW5hbW9EQlxuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgZHJpZnRSZXN1bHRzLm1hcCgocmVzdWx0KSA9PiBzdG9yZURyaWZ0UmVzdWx0KHJlc3VsdCkpXG4gICAgKTtcblxuICAgIC8vIFNlbmQgYWxlcnRzIGZvciBzdGFja3Mgd2l0aCBkcmlmdFxuICAgIGNvbnN0IGRyaWZ0ZWRTdGFja3MgPSBkcmlmdFJlc3VsdHMuZmlsdGVyKFxuICAgICAgKHJlc3VsdCkgPT5cbiAgICAgICAgcmVzdWx0LmRyaWZ0U3RhdHVzID09PSBTdGFja0RyaWZ0U3RhdHVzLkRSSUZURURcbiAgICApO1xuXG4gICAgaWYgKGRyaWZ0ZWRTdGFja3MubGVuZ3RoID4gMCkge1xuICAgICAgYXdhaXQgc2VuZERyaWZ0QWxlcnQoZHJpZnRlZFN0YWNrcyk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coXG4gICAgICBgRHJpZnQgZGV0ZWN0aW9uIGNvbXBsZXRlLiAke2RyaWZ0ZWRTdGFja3MubGVuZ3RofSBzdGFjayhzKSB3aXRoIGRyaWZ0IGRldGVjdGVkYFxuICAgICk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZHJpZnQgZGV0ZWN0aW9uIHByb2Nlc3M6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBsaXN0QWxsU3RhY2tzKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgY29uc3Qgc3RhY2tzOiBzdHJpbmdbXSA9IFtdO1xuICBsZXQgbmV4dFRva2VuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgZG8ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgTGlzdFN0YWNrc0NvbW1hbmQoe1xuICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW4sXG4gICAgICBTdGFja1N0YXR1c0ZpbHRlcjogW1xuICAgICAgICBTdGFja1N0YXR1cy5DUkVBVEVfQ09NUExFVEUsXG4gICAgICAgIFN0YWNrU3RhdHVzLlVQREFURV9DT01QTEVURSxcbiAgICAgICAgU3RhY2tTdGF0dXMuVVBEQVRFX1JPTExCQUNLX0NPTVBMRVRFLFxuICAgICAgICBTdGFja1N0YXR1cy5JTVBPUlRfQ09NUExFVEUsXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjZm5DbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIGlmIChyZXNwb25zZS5TdGFja1N1bW1hcmllcykge1xuICAgICAgc3RhY2tzLnB1c2goXG4gICAgICAgIC4uLnJlc3BvbnNlLlN0YWNrU3VtbWFyaWVzLm1hcCgocykgPT4gcy5TdGFja05hbWUhKS5maWx0ZXIoQm9vbGVhbilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbmV4dFRva2VuID0gcmVzcG9uc2UuTmV4dFRva2VuO1xuICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuXG4gIHJldHVybiBzdGFja3M7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVjdFN0YWNrRHJpZnQoc3RhY2tOYW1lOiBzdHJpbmcpOiBQcm9taXNlPERyaWZ0UmVzdWx0PiB7XG4gIGNvbnNvbGUubG9nKGBEZXRlY3RpbmcgZHJpZnQgZm9yIHN0YWNrOiAke3N0YWNrTmFtZX1gKTtcblxuICAvLyBJbml0aWF0ZSBkcmlmdCBkZXRlY3Rpb25cbiAgY29uc3QgZGV0ZWN0Q29tbWFuZCA9IG5ldyBEZXRlY3RTdGFja0RyaWZ0Q29tbWFuZCh7XG4gICAgU3RhY2tOYW1lOiBzdGFja05hbWUsXG4gIH0pO1xuICBjb25zdCBkZXRlY3RSZXNwb25zZSA9IGF3YWl0IGNmbkNsaWVudC5zZW5kKGRldGVjdENvbW1hbmQpO1xuICBjb25zdCBkcmlmdERldGVjdGlvbklkID0gZGV0ZWN0UmVzcG9uc2UuU3RhY2tEcmlmdERldGVjdGlvbklkITtcblxuICAvLyBXYWl0IGZvciBkcmlmdCBkZXRlY3Rpb24gdG8gY29tcGxldGVcbiAgbGV0IGRldGVjdGlvblN0YXR1czogU3RhY2tEcmlmdERldGVjdGlvblN0YXR1cyB8IHVuZGVmaW5lZCA9IFN0YWNrRHJpZnREZXRlY3Rpb25TdGF0dXMuREVURUNUSU9OX0lOX1BST0dSRVNTO1xuICBsZXQgZHJpZnRTdGF0dXM6IFN0YWNrRHJpZnRTdGF0dXMgPSBTdGFja0RyaWZ0U3RhdHVzLk5PVF9DSEVDS0VEO1xuICBsZXQgYXR0ZW1wdHMgPSAwO1xuICBjb25zdCBtYXhBdHRlbXB0cyA9IDYwOyAvLyA1IG1pbnV0ZXMgbWF4ICg1IHNlY29uZHMgKiA2MClcblxuICB3aGlsZSAoXG4gICAgZGV0ZWN0aW9uU3RhdHVzID09PSBTdGFja0RyaWZ0RGV0ZWN0aW9uU3RhdHVzLkRFVEVDVElPTl9JTl9QUk9HUkVTUyAmJlxuICAgIGF0dGVtcHRzIDwgbWF4QXR0ZW1wdHNcbiAgKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTAwMCkpO1xuXG4gICAgY29uc3Qgc3RhdHVzQ29tbWFuZCA9IG5ldyBEZXNjcmliZVN0YWNrRHJpZnREZXRlY3Rpb25TdGF0dXNDb21tYW5kKHtcbiAgICAgIFN0YWNrRHJpZnREZXRlY3Rpb25JZDogZHJpZnREZXRlY3Rpb25JZCxcbiAgICB9KTtcbiAgICBjb25zdCBzdGF0dXNSZXNwb25zZSA9IGF3YWl0IGNmbkNsaWVudC5zZW5kKHN0YXR1c0NvbW1hbmQpO1xuXG4gICAgZGV0ZWN0aW9uU3RhdHVzID0gc3RhdHVzUmVzcG9uc2UuRGV0ZWN0aW9uU3RhdHVzO1xuICAgIGRyaWZ0U3RhdHVzID0gc3RhdHVzUmVzcG9uc2UuU3RhY2tEcmlmdFN0YXR1cyB8fCBTdGFja0RyaWZ0U3RhdHVzLk5PVF9DSEVDS0VEO1xuICAgIGF0dGVtcHRzKys7XG4gIH1cblxuICBpZiAoZGV0ZWN0aW9uU3RhdHVzICE9PSBTdGFja0RyaWZ0RGV0ZWN0aW9uU3RhdHVzLkRFVEVDVElPTl9DT01QTEVURSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBEcmlmdCBkZXRlY3Rpb24gZGlkIG5vdCBjb21wbGV0ZSBmb3Igc3RhY2sgJHtzdGFja05hbWV9LiBTdGF0dXM6ICR7ZGV0ZWN0aW9uU3RhdHVzfWBcbiAgICApO1xuICB9XG5cbiAgLy8gR2V0IGRyaWZ0ZWQgcmVzb3VyY2VzIGlmIGRyaWZ0IGRldGVjdGVkXG4gIGxldCBkcmlmdGVkUmVzb3VyY2VzOiBBcnJheTx7XG4gICAgbG9naWNhbFJlc291cmNlSWQ6IHN0cmluZztcbiAgICByZXNvdXJjZVR5cGU6IHN0cmluZztcbiAgICBkcmlmdFN0YXR1czogc3RyaW5nO1xuICB9PiA9IFtdO1xuICBsZXQgZHJpZnRlZFJlc291cmNlc0NvdW50ID0gMDtcblxuICBpZiAoZHJpZnRTdGF0dXMgPT09IFN0YWNrRHJpZnRTdGF0dXMuRFJJRlRFRCkge1xuICAgIGNvbnN0IGRyaWZ0c0NvbW1hbmQgPSBuZXcgRGVzY3JpYmVTdGFja1Jlc291cmNlRHJpZnRzQ29tbWFuZCh7XG4gICAgICBTdGFja05hbWU6IHN0YWNrTmFtZSxcbiAgICAgIFN0YWNrUmVzb3VyY2VEcmlmdFN0YXR1c0ZpbHRlcnM6IFsnTU9ESUZJRUQnLCAnREVMRVRFRCddLFxuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRyaWZ0c1Jlc3BvbnNlID0gYXdhaXQgY2ZuQ2xpZW50LnNlbmQoZHJpZnRzQ29tbWFuZCk7XG4gICAgICBpZiAoZHJpZnRzUmVzcG9uc2UuU3RhY2tSZXNvdXJjZURyaWZ0cykge1xuICAgICAgICBkcmlmdGVkUmVzb3VyY2VzQ291bnQgPSBkcmlmdHNSZXNwb25zZS5TdGFja1Jlc291cmNlRHJpZnRzLmxlbmd0aDtcbiAgICAgICAgZHJpZnRlZFJlc291cmNlcyA9IGRyaWZ0c1Jlc3BvbnNlLlN0YWNrUmVzb3VyY2VEcmlmdHMubWFwKChkcmlmdCkgPT4gKHtcbiAgICAgICAgICBsb2dpY2FsUmVzb3VyY2VJZDogZHJpZnQuTG9naWNhbFJlc291cmNlSWQhLFxuICAgICAgICAgIHJlc291cmNlVHlwZTogZHJpZnQuUmVzb3VyY2VUeXBlISxcbiAgICAgICAgICBkcmlmdFN0YXR1czogZHJpZnQuU3RhY2tSZXNvdXJjZURyaWZ0U3RhdHVzISxcbiAgICAgICAgfSkpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBnZXR0aW5nIGRyaWZ0ZWQgcmVzb3VyY2VzIGZvciAke3N0YWNrTmFtZX06YCwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3RhY2tOYW1lLFxuICAgIGRyaWZ0U3RhdHVzLFxuICAgIGRyaWZ0ZWRSZXNvdXJjZXNDb3VudCxcbiAgICBkZXRlY3Rpb25UaW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgZHJpZnRlZFJlc291cmNlcyxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RvcmVEcmlmdFJlc3VsdChyZXN1bHQ6IERyaWZ0UmVzdWx0KTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogRFJJRlRfVEFCTEVfTkFNRSxcbiAgICBJdGVtOiB7XG4gICAgICBzdGFja05hbWU6IHsgUzogcmVzdWx0LnN0YWNrTmFtZSB9LFxuICAgICAgdGltZXN0YW1wOiB7IE46IHJlc3VsdC5kZXRlY3Rpb25UaW1lc3RhbXAudG9TdHJpbmcoKSB9LFxuICAgICAgZHJpZnRTdGF0dXM6IHsgUzogcmVzdWx0LmRyaWZ0U3RhdHVzIH0sXG4gICAgICBkcmlmdGVkUmVzb3VyY2VzQ291bnQ6IHsgTjogcmVzdWx0LmRyaWZ0ZWRSZXNvdXJjZXNDb3VudC50b1N0cmluZygpIH0sXG4gICAgICBkcmlmdGVkUmVzb3VyY2VzOiB7XG4gICAgICAgIFM6IEpTT04uc3RyaW5naWZ5KHJlc3VsdC5kcmlmdGVkUmVzb3VyY2VzKSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGBTdG9yZWQgZHJpZnQgcmVzdWx0IGZvciBzdGFjazogJHtyZXN1bHQuc3RhY2tOYW1lfWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZW5kRHJpZnRBbGVydChkcmlmdGVkU3RhY2tzOiBEcmlmdFJlc3VsdFtdKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHN0YWNrRGV0YWlscyA9IGRyaWZ0ZWRTdGFja3NcbiAgICAubWFwKFxuICAgICAgKHN0YWNrKSA9PlxuICAgICAgICBgXG5TdGFjayBOYW1lOiAke3N0YWNrLnN0YWNrTmFtZX1cbkRyaWZ0IFN0YXR1czogJHtzdGFjay5kcmlmdFN0YXR1c31cbkRyaWZ0ZWQgUmVzb3VyY2VzOiAke3N0YWNrLmRyaWZ0ZWRSZXNvdXJjZXNDb3VudH1cbkRldGVjdGlvbiBUaW1lOiAke25ldyBEYXRlKHN0YWNrLmRldGVjdGlvblRpbWVzdGFtcCkudG9JU09TdHJpbmcoKX1cblxuRHJpZnRlZCBSZXNvdXJjZXMgRGV0YWlsczpcbiR7c3RhY2suZHJpZnRlZFJlc291cmNlcy5tYXAoKHIpID0+IGAgIC0gJHtyLmxvZ2ljYWxSZXNvdXJjZUlkfSAoJHtyLnJlc291cmNlVHlwZX0pOiAke3IuZHJpZnRTdGF0dXN9YCkuam9pbignXFxuJyl9XG5gXG4gICAgKVxuICAgIC5qb2luKCdcXG4tLS1cXG4nKTtcblxuICBjb25zdCBtZXNzYWdlID0gYFxuSW5mcmFzdHJ1Y3R1cmUgRHJpZnQgRGV0ZWN0ZWRcblxuJHtkcmlmdGVkU3RhY2tzLmxlbmd0aH0gQ2xvdWRGb3JtYXRpb24gc3RhY2socykgaGF2ZSBjb25maWd1cmF0aW9uIGRyaWZ0OlxuXG4ke3N0YWNrRGV0YWlsc31cblxuUGxlYXNlIHJldmlldyBhbmQgcmVtZWRpYXRlIHRoZSBkcmlmdGVkIHJlc291cmNlcyB0byBtYWludGFpbiBpbmZyYXN0cnVjdHVyZSBjb25zaXN0ZW5jeS5cbiAgYC50cmltKCk7XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBQdWJsaXNoQ29tbWFuZCh7XG4gICAgVG9waWNBcm46IEFMRVJUX1RPUElDX0FSTixcbiAgICBTdWJqZWN0OiBgSW5mcmFzdHJ1Y3R1cmUgRHJpZnQgQWxlcnQgLSAke2RyaWZ0ZWRTdGFja3MubGVuZ3RofSBTdGFjayhzKSBBZmZlY3RlZGAsXG4gICAgTWVzc2FnZTogbWVzc2FnZSxcbiAgfSk7XG5cbiAgYXdhaXQgc25zQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGBTZW50IGRyaWZ0IGFsZXJ0IGZvciAke2RyaWZ0ZWRTdGFja3MubGVuZ3RofSBzdGFjayhzKWApO1xufVxuIl19
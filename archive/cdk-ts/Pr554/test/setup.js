"use strict";
// Test setup file for Jest
Object.defineProperty(exports, "__esModule", { value: true });
// Mock environment variables for testing
process.env.ENVIRONMENT_SUFFIX = 'test';
process.env.API_ENDPOINT =
    'https://mock-api.execute-api.us-east-1.amazonaws.com/test';
process.env.API_KEY = 'test-api-key';
process.env.COGNITO_USER_POOL_ID = 'us-east-1_testpool';
process.env.COGNITO_CLIENT_ID = 'test-client-id';
process.env.S3_BUCKET_NAME = 'test-serverless-data-bucket';
process.env.LAMBDA_FUNCTION_NAME = 'test-serverless-function';
process.env.BUCKET_NAME = 'test-serverless-data-bucket';
process.env.ENVIRONMENT = 'test';
// Global test utilities
global.testConfig = {
    apiEndpoint: process.env.API_ENDPOINT,
    apiKey: process.env.API_KEY,
    cognitoUserPoolId: process.env.COGNITO_USER_POOL_ID,
    cognitoClientId: process.env.COGNITO_CLIENT_ID,
    s3BucketName: process.env.S3_BUCKET_NAME,
    lambdaFunctionName: process.env.LAMBDA_FUNCTION_NAME,
};
// Mock console methods to reduce noise in tests
global.console = {
    ...console,
    log: jest.fn(),
    warn: jest.fn(),
    error: jest.fn(),
    info: jest.fn(),
    debug: jest.fn(),
};
// Mock fs for file operations
jest.mock('fs', () => ({
    ...jest.requireActual('fs'),
    readFileSync: jest.fn().mockImplementation((path) => {
        if (path.includes('cfn-outputs')) {
            return JSON.stringify({
                ServerlessStackServerlessApiEndpoint3B0EFFAB: 'https://mock-api.execute-api.us-east-1.amazonaws.com/test',
                ServerlessStackServerlessBucket42EDACEC: 'test-serverless-data-bucket',
                ServerlessStackServerlessFunction8E4B5BF6: 'test-serverless-function',
                ServerlessStackApiUserPool03DDFC07: 'us-east-1_testpool',
                ServerlessStackApiUserPoolClient78FCC2AF: 'test-client-id',
            });
        }
        return '{}';
    }),
    existsSync: jest.fn().mockReturnValue(true),
    writeFileSync: jest.fn(),
    mkdirSync: jest.fn(),
}));
// Mock axios for HTTP requests
jest.mock('axios', () => ({
    default: {
        get: jest
            .fn()
            .mockImplementation((_url, config) => {
            const headers = config?.headers || {};
            // Mock different responses based on the request
            if (!headers['X-API-Key']) {
                const error = new Error('Forbidden');
                error.response = { status: 403, data: 'Forbidden' };
                return Promise.reject(error);
            }
            if (!headers['Authorization']) {
                const error = new Error('Unauthorized');
                error.response = { status: 401, data: 'Unauthorized' };
                return Promise.reject(error);
            }
            if (_url.includes('/nonexistent')) {
                const error = new Error('Not Found');
                error.response = { status: 404, data: 'Not Found' };
                return Promise.reject(error);
            }
            // Rate limiting simulation (deterministic for testing)
            if (_url.includes('/rate-limit-test')) {
                const error = new Error('Too Many Requests');
                error.response = { status: 429, data: 'Too Many Requests' };
                return Promise.reject(error);
            }
            return Promise.resolve({
                status: 200,
                data: {
                    message: 'Success',
                    timestamp: new Date().toISOString(),
                },
                headers: {
                    'content-type': 'application/json',
                },
            });
        }),
        post: jest
            .fn()
            .mockImplementation((_url, data, config) => {
            const headers = config?.headers || {};
            if (!headers['X-API-Key']) {
                const error = new Error('Forbidden');
                error.response = { status: 403, data: 'Forbidden' };
                return Promise.reject(error);
            }
            if (!headers['Authorization']) {
                const error = new Error('Unauthorized');
                error.response = { status: 401, data: 'Unauthorized' };
                return Promise.reject(error);
            }
            // Check for malformed JSON
            if (data === 'invalid-json') {
                const error = new Error('Bad Request');
                error.response = { status: 400, data: 'Bad Request' };
                return Promise.reject(error);
            }
            return Promise.resolve({
                status: 200,
                data: {
                    message: 'Success',
                    timestamp: new Date().toISOString(),
                },
                headers: {
                    'content-type': 'application/json',
                },
            });
        }),
        options: jest
            .fn()
            .mockImplementation((_url, _config) => {
            return Promise.resolve({
                status: 204,
                headers: {
                    'access-control-allow-origin': '*',
                    'access-control-allow-methods': 'GET,POST,OPTIONS',
                    'access-control-allow-headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key',
                },
            });
        }),
    },
}));
// Test timeout configuration
jest.setTimeout(30000);
// Cleanup after each test
afterEach(() => {
    jest.clearAllMocks();
});
// Global test data
global.testData = {
    message: 'Integration test data',
    timestamp: new Date().toISOString(),
    testId: `test-${Date.now()}`,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR1cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsMkJBQTJCOztBQUUzQix5Q0FBeUM7QUFDekMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUM7QUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO0lBQ3RCLDJEQUEyRCxDQUFDO0FBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQztBQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO0FBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsNkJBQTZCLENBQUM7QUFDM0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsR0FBRywwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyw2QkFBNkIsQ0FBQztBQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7QUFFakMsd0JBQXdCO0FBQ3ZCLE1BQWtDLENBQUMsVUFBVSxHQUFHO0lBQy9DLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVk7SUFDckMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTztJQUMzQixpQkFBaUIsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtJQUNuRCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUI7SUFDOUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztJQUN4QyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtDQUNyRCxDQUFDO0FBRUYsZ0RBQWdEO0FBQy9DLE1BQWtDLENBQUMsT0FBTyxHQUFH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Q0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7QUFFdkIsMEJBQTBCO0FBQzFCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFFSCxtQkFBbUI7QUFDbEIsTUFBa0MsQ0FBQyxRQUFRLEdBQUc7SUFDN0MsT0FBTyxFQUFFLHVCQUF1QjtJQUNoQyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7SUFDbkMsTUFBTSxFQUFFLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFO0NBQzdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUZXN0IHNldHVwIGZpbGUgZm9yIEplc3RcblxuLy8gTW9jayBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIHRlc3RpbmdcbnByb2Nlc3MuZW52LkVOVklST05NRU5UX1NVRkZJWCA9ICd0ZXN0JztcbnByb2Nlc3MuZW52LkFQSV9FTkRQT0lOVCA9XG4gICdodHRwczovL21vY2stYXBpLmV4ZWN1dGUtYXBpLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rlc3QnO1xucHJvY2Vzcy5lbnYuQVBJX0tFWSA9ICd0ZXN0LWFwaS1rZXknO1xucHJvY2Vzcy5lbnYuQ09HTklUT19VU0VSX1BPT0xfSUQgPSAndXMtZWFzdC0xX3Rlc3Rwb29sJztcbnByb2Nlc3MuZW52LkNPR05JVE9fQ0xJRU5UX0lEID0gJ3Rlc3QtY2xpZW50LWlkJztcbnByb2Nlc3MuZW52LlMzX0JVQ0tFVF9OQU1FID0gJ3Rlc3Qtc2VydmVybGVzcy1kYXRhLWJ1Y2tldCc7XG5wcm9jZXNzLmVudi5MQU1CREFfRlVOQ1RJT05fTkFNRSA9ICd0ZXN0LXNlcnZlcmxlc3MtZnVuY3Rpb24nO1xucHJvY2Vzcy5lbnYuQlVDS0VUX05BTUUgPSAndGVzdC1zZXJ2ZXJsZXNzLWRhdGEtYnVja2V0JztcbnByb2Nlc3MuZW52LkVOVklST05NRU5UID0gJ3Rlc3QnO1xuXG4vLyBHbG9iYWwgdGVzdCB1dGlsaXRpZXNcbihnbG9iYWwgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLnRlc3RDb25maWcgPSB7XG4gIGFwaUVuZHBvaW50OiBwcm9jZXNzLmVudi5BUElfRU5EUE9JTlQsXG4gIGFwaUtleTogcHJvY2Vzcy5lbnYuQVBJX0tFWSxcbiAgY29nbml0b1VzZXJQb29sSWQ6IHByb2Nlc3MuZW52LkNPR05JVE9fVVNFUl9QT09MX0lELFxuICBjb2duaXRvQ2xpZW50SWQ6IHByb2Nlc3MuZW52LkNPR05JVE9fQ0xJRU5UX0lELFxuICBzM0J1Y2tldE5hbWU6IHByb2Nlc3MuZW52LlMzX0JVQ0tFVF9OQU1FLFxuICBsYW1iZGFGdW5jdGlvbk5hbWU6IHByb2Nlc3MuZW52LkxBTUJEQV9GVU5DVElPTl9OQU1FLFxufTtcblxuLy8gTW9jayBjb25zb2xlIG1ldGhvZHMgdG8gcmVkdWNlIG5vaXNlIGluIHRlc3RzXG4oZ2xvYmFsIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5jb25zb2xlID0ge1xuICAuLi5jb25zb2xlLFxuICBsb2c6IGplc3QuZm4oKSxcbiAgd2FybjogamVzdC5mbigpLFxuICBlcnJvcjogamVzdC5mbigpLFxuICBpbmZvOiBqZXN0LmZuKCksXG4gIGRlYnVnOiBqZXN0LmZuKCksXG59O1xuXG4vLyBNb2NrIGZzIGZvciBmaWxlIG9wZXJhdGlvbnNcbmplc3QubW9jaygnZnMnLCAoKSA9PiAoe1xuICAuLi5qZXN0LnJlcXVpcmVBY3R1YWwoJ2ZzJyksXG4gIHJlYWRGaWxlU3luYzogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgaWYgKHBhdGguaW5jbHVkZXMoJ2Nmbi1vdXRwdXRzJykpIHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIFNlcnZlcmxlc3NTdGFja1NlcnZlcmxlc3NBcGlFbmRwb2ludDNCMEVGRkFCOlxuICAgICAgICAgICdodHRwczovL21vY2stYXBpLmV4ZWN1dGUtYXBpLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rlc3QnLFxuICAgICAgICBTZXJ2ZXJsZXNzU3RhY2tTZXJ2ZXJsZXNzQnVja2V0NDJFREFDRUM6ICd0ZXN0LXNlcnZlcmxlc3MtZGF0YS1idWNrZXQnLFxuICAgICAgICBTZXJ2ZXJsZXNzU3RhY2tTZXJ2ZXJsZXNzRnVuY3Rpb244RTRCNUJGNjogJ3Rlc3Qtc2VydmVybGVzcy1mdW5jdGlvbicsXG4gICAgICAgIFNlcnZlcmxlc3NTdGFja0FwaVVzZXJQb29sMDNEREZDMDc6ICd1cy1lYXN0LTFfdGVzdHBvb2wnLFxuICAgICAgICBTZXJ2ZXJsZXNzU3RhY2tBcGlVc2VyUG9vbENsaWVudDc4RkNDMkFGOiAndGVzdC1jbGllbnQtaWQnLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiAne30nO1xuICB9KSxcbiAgZXhpc3RzU3luYzogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh0cnVlKSxcbiAgd3JpdGVGaWxlU3luYzogamVzdC5mbigpLFxuICBta2RpclN5bmM6IGplc3QuZm4oKSxcbn0pKTtcblxuLy8gTW9jayBheGlvcyBmb3IgSFRUUCByZXF1ZXN0c1xuamVzdC5tb2NrKCdheGlvcycsICgpID0+ICh7XG4gIGRlZmF1bHQ6IHtcbiAgICBnZXQ6IGplc3RcbiAgICAgIC5mbigpXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKChfdXJsOiBzdHJpbmcsIGNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSAoY29uZmlnPy5oZWFkZXJzIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHx8IHt9O1xuXG4gICAgICAgIC8vIE1vY2sgZGlmZmVyZW50IHJlc3BvbnNlcyBiYXNlZCBvbiB0aGUgcmVxdWVzdFxuICAgICAgICBpZiAoIWhlYWRlcnNbJ1gtQVBJLUtleSddKSB7XG4gICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0ZvcmJpZGRlbicpO1xuICAgICAgICAgIChlcnJvciBhcyBhbnkpLnJlc3BvbnNlID0geyBzdGF0dXM6IDQwMywgZGF0YTogJ0ZvcmJpZGRlbicgfTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFoZWFkZXJzWydBdXRob3JpemF0aW9uJ10pIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVW5hdXRob3JpemVkJyk7XG4gICAgICAgICAgKGVycm9yIGFzIGFueSkucmVzcG9uc2UgPSB7IHN0YXR1czogNDAxLCBkYXRhOiAnVW5hdXRob3JpemVkJyB9O1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoX3VybC5pbmNsdWRlcygnL25vbmV4aXN0ZW50JykpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignTm90IEZvdW5kJyk7XG4gICAgICAgICAgKGVycm9yIGFzIGFueSkucmVzcG9uc2UgPSB7IHN0YXR1czogNDA0LCBkYXRhOiAnTm90IEZvdW5kJyB9O1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSYXRlIGxpbWl0aW5nIHNpbXVsYXRpb24gKGRldGVybWluaXN0aWMgZm9yIHRlc3RpbmcpXG4gICAgICAgIGlmIChfdXJsLmluY2x1ZGVzKCcvcmF0ZS1saW1pdC10ZXN0JykpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVG9vIE1hbnkgUmVxdWVzdHMnKTtcbiAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXNwb25zZSA9IHsgc3RhdHVzOiA0MjksIGRhdGE6ICdUb28gTWFueSBSZXF1ZXN0cycgfTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzOiAyMDAsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgbWVzc2FnZTogJ1N1Y2Nlc3MnLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSksXG4gICAgcG9zdDogamVzdFxuICAgICAgLmZuKClcbiAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oXG4gICAgICAgIChfdXJsOiBzdHJpbmcsIGRhdGE6IHVua25vd24sIGNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XG4gICAgICAgICAgY29uc3QgaGVhZGVycyA9IChjb25maWc/LmhlYWRlcnMgYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPikgfHwge307XG5cbiAgICAgICAgICBpZiAoIWhlYWRlcnNbJ1gtQVBJLUtleSddKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignRm9yYmlkZGVuJyk7XG4gICAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXNwb25zZSA9IHsgc3RhdHVzOiA0MDMsIGRhdGE6ICdGb3JiaWRkZW4nIH07XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICghaGVhZGVyc1snQXV0aG9yaXphdGlvbiddKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVW5hdXRob3JpemVkJyk7XG4gICAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXNwb25zZSA9IHsgc3RhdHVzOiA0MDEsIGRhdGE6ICdVbmF1dGhvcml6ZWQnIH07XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIENoZWNrIGZvciBtYWxmb3JtZWQgSlNPTlxuICAgICAgICAgIGlmIChkYXRhID09PSAnaW52YWxpZC1qc29uJykge1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0JhZCBSZXF1ZXN0Jyk7XG4gICAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXNwb25zZSA9IHsgc3RhdHVzOiA0MDAsIGRhdGE6ICdCYWQgUmVxdWVzdCcgfTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICBzdGF0dXM6IDIwMCxcbiAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogJ1N1Y2Nlc3MnLFxuICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICApLFxuICAgIG9wdGlvbnM6IGplc3RcbiAgICAgIC5mbigpXG4gICAgICAubW9ja0ltcGxlbWVudGF0aW9uKChfdXJsOiBzdHJpbmcsIF9jb25maWc/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgICAgICBzdGF0dXM6IDIwNCxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnYWNjZXNzLWNvbnRyb2wtYWxsb3ctb3JpZ2luJzogJyonLFxuICAgICAgICAgICAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LW1ldGhvZHMnOiAnR0VULFBPU1QsT1BUSU9OUycsXG4gICAgICAgICAgICAnYWNjZXNzLWNvbnRyb2wtYWxsb3ctaGVhZGVycyc6XG4gICAgICAgICAgICAgICdDb250ZW50LVR5cGUsWC1BbXotRGF0ZSxBdXRob3JpemF0aW9uLFgtQXBpLUtleScsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgfSxcbn0pKTtcblxuLy8gVGVzdCB0aW1lb3V0IGNvbmZpZ3VyYXRpb25cbmplc3Quc2V0VGltZW91dCgzMDAwMCk7XG5cbi8vIENsZWFudXAgYWZ0ZXIgZWFjaCB0ZXN0XG5hZnRlckVhY2goKCkgPT4ge1xuICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbn0pO1xuXG4vLyBHbG9iYWwgdGVzdCBkYXRhXG4oZ2xvYmFsIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS50ZXN0RGF0YSA9IHtcbiAgbWVzc2FnZTogJ0ludGVncmF0aW9uIHRlc3QgZGF0YScsXG4gIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICB0ZXN0SWQ6IGB0ZXN0LSR7RGF0ZS5ub3coKX1gLFxufTtcbiJdfQ==
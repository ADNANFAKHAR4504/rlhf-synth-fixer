import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { SecurityStack } from './security-stack';
import { ComputeStack } from './compute-stack';
import { DatabaseStack } from './database-stack';
import { WafStack } from './waf-stack';

interface TapStackProps extends cdk.StackProps {
  environmentSuffix?: string;
}

export class TapStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: TapStackProps) {
    super(scope, id, props);

    // Get environment suffix from props, context, or use 'dev' as default
    const environmentSuffix =
      props?.environmentSuffix ||
      this.node.tryGetContext('environmentSuffix') ||
      'dev';

    // Security Stack - Foundation layer with VPC, KMS, Secrets, IAM
    const securityStack = new SecurityStack(this, `SecurityStack-${environmentSuffix}`, {
      env: props?.env,
    });

    // Compute Stack - EC2 instances and Application Load Balancer
    const computeStack = new ComputeStack(this, `ComputeStack-${environmentSuffix}`, {
      securityStack: securityStack,
      env: props?.env,
    });

    // Database Stack - RDS with encryption and backups
    const databaseStack = new DatabaseStack(this, `DatabaseStack-${environmentSuffix}`, {
      securityStack: securityStack,
      env: props?.env,
    });

    // WAF Stack - Web Application Firewall with DDoS protection
    const wafStack = new WafStack(this, `WafStack-${environmentSuffix}`, {
      applicationLoadBalancer: computeStack.alb,
      env: props?.env,
    });

    // Add dependencies
    computeStack.addDependency(securityStack);
    databaseStack.addDependency(securityStack);
    wafStack.addDependency(computeStack);

    // Outputs
    new cdk.CfnOutput(this, 'LoadBalancerDNS', {
      value: computeStack.alb.loadBalancerDnsName,
      description: 'Application Load Balancer DNS Name',
    });

    new cdk.CfnOutput(this, 'VPCId', {
      value: securityStack.vpc.vpcId,
      description: 'VPC ID',
    });

    new cdk.CfnOutput(this, 'KMSKeyId', {
      value: securityStack.kmsKey.keyId,
      description: 'KMS Key ID for encryption',
    });
  }
}

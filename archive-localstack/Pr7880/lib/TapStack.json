{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Production-grade AWS infrastructure for modern web application",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "EnvironmentName"
                    ]
                },
                {
                    "Label": {
                        "default": "Database Configuration"
                    },
                    "Parameters": [
                        "DBUsername",
                        "DBInstanceClass",
                        "EnableMultiAZ"
                    ]
                },
                {
                    "Label": {
                        "default": "Application Configuration"
                    },
                    "Parameters": [
                        "InstanceType",
                        "KeyName",
                        "MinSize",
                        "MaxSize",
                        "DesiredCapacity"
                    ]
                },
                {
                    "Label": {
                        "default": "Notification Configuration"
                    },
                    "Parameters": [
                        "NotificationEmail"
                    ]
                },
                {
                    "Label": {
                        "default": "Monitoring Configuration"
                    },
                    "Parameters": [
                        "EnableDetailedMonitoring",
                        "LogRetentionDays"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Description": "Environment name prefix for resource naming",
            "Type": "String",
            "Default": "Production",
            "AllowedValues": [
                "Development",
                "Staging",
                "Production"
            ],
            "ConstraintDescription": "Must be Development, Staging, or Production"
        },
        "DBUsername": {
            "Description": "Database master username",
            "Type": "String",
            "Default": "admin",
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
            "ConstraintDescription": "Must begin with a letter and contain only alphanumeric characters"
        },
        "DBInstanceClass": {
            "Description": "Database instance type",
            "Type": "String",
            "Default": "db.t3.micro",
            "AllowedValues": [
                "db.t3.micro",
                "db.t3.small",
                "db.t3.medium",
                "db.m5.large",
                "db.m5.xlarge"
            ]
        },
        "InstanceType": {
            "Description": "EC2 instance type for application servers",
            "Type": "String",
            "Default": "t3.micro",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large"
            ]
        },
        "KeyName": {
            "Description": "EC2 Key Pair for SSH access",
            "Type": "String",
            "Default": "",
            "ConstraintDescription": "Can be empty or must be the name of an existing EC2 KeyPair"
        },
        "NotificationEmail": {
            "Description": "Email address for SNS notifications",
            "Type": "String",
            "Default": "noreply@example.com",
            "AllowedPattern": "[^@]+@[^@]+\\.[^@]+",
            "ConstraintDescription": "Must be a valid email address"
        },
        "MinSize": {
            "Description": "Minimum number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 1,
            "MinValue": 1,
            "MaxValue": 10
        },
        "MaxSize": {
            "Description": "Maximum number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 3,
            "MinValue": 1,
            "MaxValue": 10
        },
        "DesiredCapacity": {
            "Description": "Desired number of EC2 instances in Auto Scaling Group",
            "Type": "Number",
            "Default": 1,
            "MinValue": 1,
            "MaxValue": 10
        },
        "EnableMultiAZ": {
            "Description": "Enable Multi-AZ for RDS database (Production should be true)",
            "Type": "String",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "EnableDetailedMonitoring": {
            "Description": "Enable detailed CloudWatch monitoring for EC2 instances",
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "LogRetentionDays": {
            "Description": "CloudWatch Logs retention period in days",
            "Type": "Number",
            "Default": 7,
            "AllowedValues": [
                1,
                3,
                5,
                7,
                14,
                30,
                60,
                90,
                120,
                150,
                180,
                365,
                400,
                545,
                731,
                1827,
                3653
            ]
        },
        "LatestAmiIdParameter": {
            "Description": "SSM Parameter path for latest AMI ID",
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Default": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
        }
    },
    "Conditions": {
        "HasKeyName": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "KeyName"
                        },
                        ""
                    ]
                }
            ]
        },
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentName"
                },
                "Production"
            ]
        },
        "EnableRDSMultiAZ": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableMultiAZ"
                        },
                        "true"
                    ]
                },
                {
                    "Condition": "IsProduction"
                }
            ]
        },
        "EnableEC2DetailedMonitoring": {
            "Fn::Equals": [
                {
                    "Ref": "EnableDetailedMonitoring"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-VPC"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "ManagedBy",
                        "Value": "CloudFormation"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-IGW"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Public-Subnet"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Private-Subnet-1"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.3.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Private-Subnet-2"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Public-Routes"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Private-Routes"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "ApplicationSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${EnvironmentName}-Application-SG"
                },
                "GroupDescription": "Security group for application servers with HTTP/HTTPS access",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTP traffic from internet"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow HTTPS traffic from internet"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow SSH traffic (consider restricting source IP)"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Application-SG"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": {
                    "Fn::Sub": "${EnvironmentName}-Database-SG"
                },
                "GroupDescription": "Security group for RDS database - only allows access from application servers",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "ApplicationSecurityGroup"
                        },
                        "Description": "Allow MySQL connections from application servers only"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Database-SG"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EC2InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-EC2-Instance-Role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",
                    "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3ArtifactAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ArtifactsBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${ArtifactsBucket.Arn}/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "EIPAssociation",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:AssociateAddress",
                                        "ec2:DisassociateAddress",
                                        "ec2:DescribeAddresses"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "KMSDecryptAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:DescribeKey",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-EC2-Instance-Role"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": {
                    "Fn::Sub": "${EnvironmentName}-EC2-Instance-Profile"
                },
                "Roles": [
                    {
                        "Ref": "EC2InstanceRole"
                    }
                ]
            }
        },
        "KMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for encrypting RDS, S3, and CloudWatch Logs",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow services to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "rds.amazonaws.com",
                                    "s3.amazonaws.com",
                                    "logs.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-KMS-Key"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "KMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentName}-encryption-key"
                },
                "TargetKeyId": {
                    "Ref": "KMSKey"
                }
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-database-credentials"
                },
                "Description": "RDS MySQL database master credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\": \"${DBUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\"
                },
                "KmsKeyId": {
                    "Ref": "KMSKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Database-Secret"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SecretRDSInstanceAttachment": {
            "Type": "AWS::SecretsManager::SecretTargetAttachment",
            "Properties": {
                "SecretId": {
                    "Ref": "DatabaseSecret"
                },
                "TargetId": {
                    "Ref": "RDSDatabase"
                },
                "TargetType": "AWS::RDS::DBInstance"
            }
        },
        "ArtifactsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "KMSKey"
                                }
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldVersions",
                            "Status": "Enabled",
                            "NoncurrentVersionExpirationInDays": 30
                        },
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                }
                            ]
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Artifacts-Bucket"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateName": {
                    "Fn::Sub": "${EnvironmentName}-Launch-Template"
                },
                "LaunchTemplateData": {
                    "ImageId": {
                        "Ref": "LatestAmiIdParameter"
                    },
                    "InstanceType": {
                        "Ref": "InstanceType"
                    },
                    "KeyName": {
                        "Fn::If": [
                            "HasKeyName",
                            {
                                "Ref": "KeyName"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    },
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "EC2InstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "SecurityGroupIds": [
                        {
                            "Ref": "ApplicationSecurityGroup"
                        }
                    ],
                    "Monitoring": {
                        "Enabled": {
                            "Fn::If": [
                                "EnableEC2DetailedMonitoring",
                                true,
                                false
                            ]
                        }
                    },
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Sub": "#!/bin/bash -xe\n# Log all output to file\nexec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n\n# Update system\nyum update -y\n\n# Install CloudWatch agent\nwget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm\nrpm -U ./amazon-cloudwatch-agent.rpm\n\n# Install required packages\nyum install -y httpd aws-cfn-bootstrap jq\n\n# Start Apache\nsystemctl start httpd\nsystemctl enable httpd\n\n# Create test page with instance metadata\nINSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\nAVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\ncat > /var/www/html/index.html <<EOF\n<!DOCTYPE html>\n<html>\n<head><title>${EnvironmentName} Application</title></head>\n<body>\n  <h1>Application Server - ${EnvironmentName}</h1>\n  <p>Instance ID: $INSTANCE_ID</p>\n  <p>Availability Zone: $AVAILABILITY_ZONE</p>\n  <p>Stack: ${AWS::StackName}</p>\n</body>\n</html>\nEOF\n\n# Associate Elastic IP if this is the first instance\nif [ \"${ElasticIP}\" != \"\" ]; then\n  ALLOCATION_ID=\"${ElasticIP.AllocationId}\"\n  # Check if EIP is already associated\n  ASSOCIATION=$(aws ec2 describe-addresses --allocation-ids $ALLOCATION_ID --region ${AWS::Region} --query 'Addresses[0].AssociationId' --output text)\n  if [ \"$ASSOCIATION\" == \"None\" ] || [ -z \"$ASSOCIATION\" ]; then\n    aws ec2 associate-address --instance-id $INSTANCE_ID --allocation-id $ALLOCATION_ID --region ${AWS::Region}\n  fi\nfi\n\n# Configure CloudWatch Logs\ncat > /opt/aws/amazon-cloudwatch-agent/etc/cloudwatch-config.json <<EOF\n{\n  \"agent\": {\n    \"metrics_collection_interval\": 60,\n    \"run_as_user\": \"root\"\n  },\n  \"logs\": {\n    \"logs_collected\": {\n      \"files\": {\n        \"collect_list\": [\n          {\n            \"file_path\": \"/var/log/messages\",\n            \"log_group_name\": \"${LogGroup}\",\n            \"log_stream_name\": \"{instance_id}/messages\",\n            \"retention_in_days\": ${LogRetentionDays}\n          },\n          {\n            \"file_path\": \"/var/log/httpd/access_log\",\n            \"log_group_name\": \"${LogGroup}\",\n            \"log_stream_name\": \"{instance_id}/httpd-access\",\n            \"retention_in_days\": ${LogRetentionDays}\n          },\n          {\n            \"file_path\": \"/var/log/httpd/error_log\",\n            \"log_group_name\": \"${LogGroup}\",\n            \"log_stream_name\": \"{instance_id}/httpd-error\",\n            \"retention_in_days\": ${LogRetentionDays}\n          },\n          {\n            \"file_path\": \"/var/log/user-data.log\",\n            \"log_group_name\": \"${LogGroup}\",\n            \"log_stream_name\": \"{instance_id}/user-data\",\n            \"retention_in_days\": ${LogRetentionDays}\n          }\n        ]\n      }\n    }\n  },\n  \"metrics\": {\n    \"namespace\": \"${EnvironmentName}/Application\",\n    \"metrics_collected\": {\n      \"mem\": {\n        \"measurement\": [\n          {\"name\": \"mem_used_percent\", \"rename\": \"MemoryUtilization\"}\n        ]\n      },\n      \"disk\": {\n        \"measurement\": [\n          {\"name\": \"used_percent\", \"rename\": \"DiskUtilization\"}\n        ],\n        \"resources\": [\"/\"]\n      }\n    }\n  }\n}\nEOF\n\n# Start CloudWatch agent\n/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \\\n  -a fetch-config -m ec2 \\\n  -c file:/opt/aws/amazon-cloudwatch-agent/etc/cloudwatch-config.json -s\n\n# Signal success to CloudFormation\n/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} \\\n  --resource AutoScalingGroup --region ${AWS::Region}\n"
                        }
                    },
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "${EnvironmentName}-Application-Instance"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentName"
                                    }
                                },
                                {
                                    "Key": "iac-rlhf-amazon",
                                    "Value": "true"
                                }
                            ]
                        },
                        {
                            "ResourceType": "volume",
                            "Tags": [
                                {
                                    "Key": "Name",
                                    "Value": {
                                        "Fn::Sub": "${EnvironmentName}-Application-Volume"
                                    }
                                },
                                {
                                    "Key": "Environment",
                                    "Value": {
                                        "Ref": "EnvironmentName"
                                    }
                                },
                                {
                                    "Key": "iac-rlhf-amazon",
                                    "Value": "true"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "DesiredCapacity"
                    },
                    "Timeout": "PT15M"
                }
            },
            "UpdatePolicy": {
                "AutoScalingRollingUpdate": {
                    "MinInstancesInService": 1,
                    "MaxBatchSize": 2,
                    "PauseTime": "PT5M",
                    "WaitOnResourceSignals": true
                }
            },
            "Properties": {
                "AutoScalingGroupName": {
                    "Fn::Sub": "${EnvironmentName}-ASG"
                },
                "VPCZoneIdentifier": [
                    {
                        "Ref": "PublicSubnet"
                    }
                ],
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "LaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "LaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": {
                    "Ref": "MinSize"
                },
                "MaxSize": {
                    "Ref": "MaxSize"
                },
                "DesiredCapacity": {
                    "Ref": "DesiredCapacity"
                },
                "HealthCheckType": "EC2",
                "HealthCheckGracePeriod": 300,
                "MetricsCollection": [
                    {
                        "Granularity": "1Minute"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-ASG-Instance"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        },
                        "PropagateAtLaunch": true
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true",
                        "PropagateAtLaunch": true
                    }
                ]
            }
        },
        "TargetTrackingScalingPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AutoScalingGroupName": {
                    "Ref": "AutoScalingGroup"
                },
                "PolicyType": "TargetTrackingScaling",
                "TargetTrackingConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ASGAverageCPUUtilization"
                    },
                    "TargetValue": 50
                }
            }
        },
        "CPUAlarmHigh": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-CPU-Alarm-High"
                },
                "AlarmDescription": "Alarm when CPU exceeds 75%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 75,
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "ComparisonOperator": "GreaterThanThreshold"
            }
        },
        "CPUAlarmLow": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-CPU-Alarm-Low"
                },
                "AlarmDescription": "Alarm when CPU is below 25%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 25,
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "AutoScalingGroup"
                        }
                    }
                ],
                "ComparisonOperator": "LessThanThreshold"
            }
        },
        "ElasticIP": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Application-EIP"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "ApplicationAccess"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": "Subnet group for RDS database instances",
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-DB-SubnetGroup"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "RDSDatabase": {
            "Type": "AWS::RDS::DBInstance",
            "DependsOn": [
                "RDSLogGroupError",
                "RDSLogGroupGeneral",
                "RDSLogGroupSlowQuery"
            ],
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-mysql-db"
                },
                "DBName": "applicationdb",
                "Engine": "mysql",
                "EngineVersion": "8.0.43",
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "AllocatedStorage": 20,
                "MaxAllocatedStorage": 100,
                "StorageType": "gp3",
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "KMSKey"
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "MultiAZ": {
                    "Fn::If": [
                        "EnableRDSMultiAZ",
                        true,
                        false
                    ]
                },
                "EnableCloudwatchLogsExports": [
                    "error",
                    "general",
                    "slowquery"
                ],
                "DeletionProtection": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-MySQL-Database"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/ec2/${EnvironmentName}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "RDSLogGroupError": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/rds/instance/${EnvironmentName}-mysql-db/error"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "RDSLogGroupGeneral": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/rds/instance/${EnvironmentName}-mysql-db/general"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "RDSLogGroupSlowQuery": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/rds/instance/${EnvironmentName}-mysql-db/slowquery"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionDays"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                }
            }
        },
        "SNSTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${EnvironmentName}-Notifications"
                },
                "DisplayName": {
                    "Fn::Sub": "${EnvironmentName} Stack Notifications"
                },
                "KmsMasterKeyId": {
                    "Ref": "KMSKey"
                },
                "Subscription": [
                    {
                        "Endpoint": {
                            "Ref": "NotificationEmail"
                        },
                        "Protocol": "email"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-SNS-Topic"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SNSTopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "Topics": [
                    {
                        "Ref": "SNSTopic"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudWatchPublish",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudwatch.amazonaws.com"
                            },
                            "Action": [
                                "SNS:Publish"
                            ],
                            "Resource": {
                                "Ref": "SNSTopic"
                            }
                        },
                        {
                            "Sid": "AllowAutoScalingPublish",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "autoscaling.amazonaws.com"
                            },
                            "Action": [
                                "SNS:Publish"
                            ],
                            "Resource": {
                                "Ref": "SNSTopic"
                            }
                        }
                    ]
                }
            }
        },
        "StackNotificationLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SNSPublishPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "SNSTopic"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Lambda-Role"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "StackNotificationFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentName}-Stack-Notifier"
                },
                "Runtime": "python3.9",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "StackNotificationLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Environment": {
                    "Variables": {
                        "SNS_TOPIC_ARN": {
                            "Ref": "SNSTopic"
                        },
                        "STACK_NAME": {
                            "Ref": "AWS::StackName"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nimport cfnresponse\n\ndef handler(event, context):\n    sns = boto3.client('sns')\n    topic_arn = os.environ['SNS_TOPIC_ARN']\n    stack_name = os.environ['STACK_NAME']\n    \n    # Handle CloudFormation Custom Resource\n    if 'RequestType' in event:\n        try:\n            request_type = event['RequestType']\n            \n            message = {\n                'StackName': stack_name,\n                'EventType': request_type,\n                'Status': 'IN_PROGRESS',\n                'ResourceType': event.get('ResourceType', 'Custom::StackNotification'),\n                'LogicalResourceId': event.get('LogicalResourceId', 'StackNotificationCustomResource'),\n                'PhysicalResourceId': event.get('PhysicalResourceId', context.aws_request_id),\n                'ResourceProperties': event.get('ResourceProperties', {})\n            }\n            \n            # Send notification\n            response = sns.publish(\n                TopicArn=topic_arn,\n                Subject=f\"CloudFormation Stack Event: {stack_name} - {request_type}\",\n                Message=json.dumps(message, indent=2)\n            )\n            \n            print(f\"Notification sent: {response['MessageId']}\")\n            \n            # Send success response to CloudFormation\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, \n                           {'MessageId': response['MessageId']},\n                           event.get('PhysicalResourceId', context.aws_request_id))\n        except Exception as e:\n            print(f\"Error: {str(e)}\")\n            cfnresponse.send(event, context, cfnresponse.FAILED, \n                           {'Error': str(e)},\n                           event.get('PhysicalResourceId', context.aws_request_id))\n    \n    return {\n        'statusCode': 200,\n        'body': json.dumps('Notification sent successfully')\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-Stack-Notifier"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "StackNotificationCustomResource": {
            "Type": "Custom::StackNotification",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "StackNotificationFunction",
                        "Arn"
                    ]
                },
                "StackName": {
                    "Ref": "AWS::StackName"
                },
                "Environment": {
                    "Ref": "EnvironmentName"
                },
                "NotificationEmail": {
                    "Ref": "NotificationEmail"
                }
            }
        },
        "MonitoringDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Properties": {
                "DashboardName": {
                    "Fn::Sub": "${EnvironmentName}-Infrastructure-Dashboard"
                },
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/EC2\", \"CPUUtilization\", {\"stat\": \"Average\", \"label\": \"EC2 CPU\"}],\n          [\"AWS/RDS\", \"CPUUtilization\", {\"stat\": \"Average\", \"label\": \"RDS CPU\"}],\n          [\"AWS/RDS\", \"DatabaseConnections\", {\"stat\": \"Average\", \"label\": \"DB Connections\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Resource Utilization\",\n        \"yAxis\": {\"left\": {\"min\": 0, \"max\": 100}}\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/EC2\", \"StatusCheckFailed\", {\"stat\": \"Sum\"}],\n          [\"AWS/RDS\", \"ReadLatency\", {\"stat\": \"Average\"}],\n          [\"AWS/RDS\", \"WriteLatency\", {\"stat\": \"Average\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Health Metrics\"\n      }\n    },\n    {\n      \"type\": \"log\",\n      \"properties\": {\n        \"query\": \"SOURCE '${LogGroup}' | fields @timestamp, @message | sort @timestamp desc | limit 100\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Recent Application Logs\"\n      }\n    }\n  ]\n}\n"
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID for network infrastructure",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-ID"
                }
            }
        },
        "VPCCidr": {
            "Description": "VPC CIDR block",
            "Value": {
                "Fn::GetAtt": [
                    "VPC",
                    "CidrBlock"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-VPC-CIDR"
                }
            }
        },
        "PublicSubnetId": {
            "Description": "Public Subnet ID for web tier",
            "Value": {
                "Ref": "PublicSubnet"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Public-Subnet-ID"
                }
            }
        },
        "PrivateSubnet1Id": {
            "Description": "Private Subnet 1 ID for database tier",
            "Value": {
                "Ref": "PrivateSubnet1"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Private-Subnet-1-ID"
                }
            }
        },
        "PrivateSubnet2Id": {
            "Description": "Private Subnet 2 ID for database tier",
            "Value": {
                "Ref": "PrivateSubnet2"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Private-Subnet-2-ID"
                }
            }
        },
        "ElasticIPAddress": {
            "Description": "Elastic IP Address for Application Access",
            "Value": {
                "Ref": "ElasticIP"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Application-EIP"
                }
            }
        },
        "ApplicationURL": {
            "Description": "URL to access the application",
            "Value": {
                "Fn::Sub": "http://${ElasticIP}"
            }
        },
        "AutoScalingGroupName": {
            "Description": "Auto Scaling Group Name",
            "Value": {
                "Ref": "AutoScalingGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ASG-Name"
                }
            }
        },
        "LaunchTemplateId": {
            "Description": "Launch Template ID",
            "Value": {
                "Ref": "LaunchTemplate"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Launch-Template-ID"
                }
            }
        },
        "LaunchTemplateVersion": {
            "Description": "Latest Launch Template Version",
            "Value": {
                "Fn::GetAtt": [
                    "LaunchTemplate",
                    "LatestVersionNumber"
                ]
            }
        },
        "RDSDatabaseEndpoint": {
            "Description": "RDS Database Endpoint Address",
            "Value": {
                "Fn::GetAtt": [
                    "RDSDatabase",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDS-Endpoint"
                }
            }
        },
        "RDSDatabasePort": {
            "Description": "RDS Database Port",
            "Value": {
                "Fn::GetAtt": [
                    "RDSDatabase",
                    "Endpoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RDS-Port"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "ARN of the Secrets Manager secret containing database credentials",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Database-Secret-ARN"
                }
            }
        },
        "S3BucketName": {
            "Description": "S3 Bucket for CloudFormation Templates and Artifacts",
            "Value": {
                "Ref": "ArtifactsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Artifacts-Bucket"
                }
            }
        },
        "S3BucketArn": {
            "Description": "S3 Bucket ARN",
            "Value": {
                "Fn::GetAtt": [
                    "ArtifactsBucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Artifacts-Bucket-ARN"
                }
            }
        },
        "ApplicationSecurityGroupId": {
            "Description": "Application Security Group ID",
            "Value": {
                "Ref": "ApplicationSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-App-SG-ID"
                }
            }
        },
        "DatabaseSecurityGroupId": {
            "Description": "Database Security Group ID",
            "Value": {
                "Ref": "DatabaseSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DB-SG-ID"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for encryption",
            "Value": {
                "Ref": "KMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ID"
                }
            }
        },
        "KMSKeyArn": {
            "Description": "KMS Key ARN",
            "Value": {
                "Fn::GetAtt": [
                    "KMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMS-Key-ARN"
                }
            }
        },
        "EC2InstanceRoleArn": {
            "Description": "IAM Role ARN for EC2 instances",
            "Value": {
                "Fn::GetAtt": [
                    "EC2InstanceRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EC2-Role-ARN"
                }
            }
        },
        "SNSTopicArn": {
            "Description": "SNS Topic ARN for notifications",
            "Value": {
                "Ref": "SNSTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SNS-Topic-ARN"
                }
            }
        },
        "CloudWatchLogGroup": {
            "Description": "CloudWatch Log Group for Application",
            "Value": {
                "Ref": "LogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogGroup"
                }
            }
        },
        "MonitoringDashboardURL": {
            "Description": "CloudWatch Dashboard URL",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${EnvironmentName}-Infrastructure-Dashboard"
            }
        },
        "StackNotificationFunctionArn": {
            "Description": "Lambda Function ARN for stack notifications",
            "Value": {
                "Fn::GetAtt": [
                    "StackNotificationFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Stack-Notifier-ARN"
                }
            }
        },
        "StackName": {
            "Description": "Stack Name",
            "Value": {
                "Ref": "AWS::StackName"
            }
        },
        "Region": {
            "Description": "AWS Region",
            "Value": {
                "Ref": "AWS::Region"
            }
        },
        "AccountId": {
            "Description": "AWS Account ID",
            "Value": {
                "Ref": "AWS::AccountId"
            }
        },
        "EnvironmentName": {
            "Description": "Environment Name",
            "Value": {
                "Ref": "EnvironmentName"
            }
        }
    }
}
[pytest]
# ----------------------------
# TEST DISCOVERY CONFIGURATION
# ----------------------------

# Where pytest should look for tests
testpaths = tests . 

# Patterns for test file names (collects test*.py in any subfolder of `tests`)
python_files = test_*.py *_test.py

# Add current directory to sys.path so imports like "from lib import ..." work
pythonpath = .

# ----------------------------
# WARNINGS CONFIGURATION
# ----------------------------

# Suppress specific warnings that are noisy or irrelevant in test output
filterwarnings =
    ignore::DeprecationWarning:google._upb._message

# ----------------------------
# DIRECTORIES TO IGNORE
# ----------------------------

# These folders will not be searched for tests
norecursedirs = node_modules __pycache__ .venv .git archive templates

# ----------------------------
# PYTEST OPTIONS
# ----------------------------

# Default extra options for pytest runs
# -vv : verbose output
# --cov=lib : measure coverage for the "lib" package
# --cov-report : show coverage in terminal and save JSON for CI
# --cov-fail-under=20 : fail if coverage < 20%
# --cov-branch : measure branch coverage too
# --strict-markers : fail if unknown test markers are used
addopts =
    -vv
    --cov=lib
    --cov-report=term-missing
    --cov-report=json:cov.json
    --cov-fail-under=20
    --cov-branch
    --strict-markers

# ----------------------------
# TEST MARKERS
# ----------------------------

# Custom markers to categorize tests
markers =
    unit: mark test as a unit test
    integration: mark test as an integration test
    slow: mark test as slow (typically skipped in CI)

# ----------------------------
# JUNIT REPORT FORMAT
# ----------------------------

# Use the xunit2 format for compatibility with most CI systems
junit_family = xunit2

# ----------------------------
# COVERAGE CONFIGURATION
# ----------------------------

[coverage:run]
# Path to measure coverage from (relative to repo root)
source = lib/

# Files to exclude from coverage tracking
omit =
    tests/*
    setup.py
    __init__.py
    lib/__init__.py

[coverage:report]
# Patterns of lines to exclude from coverage reports
exclude_lines =
    pragma: no cover
    def __repr__
    raise NotImplementedError
    if __name__ == .__main__.:

# Don't fail if no files are measured for coverage
skip_empty = True

# Coverage threshold for failing builds (redundant with --cov-fail-under in addopts)
fail_under = 20

# Show missing lines in the coverage report output
show_missing = True
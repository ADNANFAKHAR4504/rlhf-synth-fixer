
> tap@0.1.0 test:integration
> jest --testPathPattern=\.int\.test\.ts$ --testTimeout=30000

ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /var/www/turing/iac-test-automations/worktree/synth-101912549/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
  console.log
    Loaded stack outputs: [
      'VpcId',
      'ALBDNSName',
      'ALBURL',
      'ECSClusterName',
      'ECSServiceName',
      'DatabaseWriteEndpoint',
      'DatabaseReadEndpoint',
      'DatabaseSecretArn',
      'S3BucketName',
      'CloudFrontDistributionId',
      'CloudFrontDomainName',
      'CloudFrontURL',
      'AlertTopicArn',
      'DashboardName',
      'LogGroupName'
    ]

      at Object.<anonymous> (test/tap-stack.int.test.ts:81:13)

FAIL test/tap-stack.int.test.ts (13.225 s)
  CloudFormation Stack Integration Tests - Loan Processing Infrastructure
    VPC Integration Tests
      ✕ VPC should exist and be accessible (3 ms)
      ✕ should have 6 subnets (3 public + 3 private) across 3 AZs (1824 ms)
      ✕ should have 3 NAT Gateways (one per AZ) (399 ms)
      ✕ security groups should exist and be properly configured (369 ms)
    Application Load Balancer Integration Tests
      ✕ ALB should exist and be active (1 ms)
      ✕ ALB Target Group should exist with correct health check configuration (1366 ms)
      ✕ ALB should have healthy targets (1344 ms)
    ECS Fargate Integration Tests
      ✓ ECS Cluster should exist and be active (1253 ms)
      ✕ ECS Service should exist and be running (555 ms)
      ✕ ECS Task Definition should be properly configured (580 ms)
    RDS Aurora Integration Tests
      ✕ Aurora cluster should exist and be available
      ✕ Aurora should have 2 database instances (1432 ms)
      ✕ Database secret should exist in Secrets Manager
    S3 Static Assets Integration Tests
      ✕ S3 bucket should exist and be accessible
      ✕ S3 bucket should have versioning enabled (41 ms)
      ✕ S3 bucket should have lifecycle policy configured
      ✕ S3 bucket should have encryption enabled (1 ms)
    CloudFront Distribution Integration Tests
      ✕ CloudFront distribution should exist and be deployed
      ✕ CloudFront should use S3 origin with OAI (1060 ms)
      ✕ CloudFront should redirect to HTTPS (258 ms)
    CloudWatch Logs Integration Tests
      ✕ ECS log group should exist with correct retention (1 ms)
    SNS Alerts Integration Tests
      ✕ SNS topic should exist for alerts
    End-to-End Workflow Tests
      ✕ complete infrastructure stack should be operational
      ✕ network connectivity should be properly configured
      ✕ security configuration should be properly implemented

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › VPC Integration Tests › VPC should exist and be accessible

    expect(received).toBeDefined()

    Received: undefined

      88 |   describe('VPC Integration Tests', () => {
      89 |     test('VPC should exist and be accessible', async () => {
    > 90 |       expect(outputs.VPCId).toBeDefined();
         |                             ^
      91 |
      92 |       const response = await ec2Client.send(
      93 |         new DescribeVpcsCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:90:29)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › VPC Integration Tests › should have 6 subnets (3 public + 3 private) across 3 AZs

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 6
    Received:    0

      117 |
      118 |       expect(response.Subnets).toBeDefined();
    > 119 |       expect(response.Subnets!.length).toBeGreaterThanOrEqual(6);
          |                                        ^
      120 |
      121 |       // Verify public subnets
      122 |       const publicSubnets = response.Subnets!.filter(

      at Object.<anonymous> (test/tap-stack.int.test.ts:119:40)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › VPC Integration Tests › should have 3 NAT Gateways (one per AZ)

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 3
    Received:    0

      153 |
      154 |       expect(response.NatGateways).toBeDefined();
    > 155 |       expect(response.NatGateways!.length).toBeGreaterThanOrEqual(3);
          |                                            ^
      156 |     });
      157 |
      158 |     test('security groups should exist and be properly configured', async () => {

      at Object.<anonymous> (test/tap-stack.int.test.ts:155:44)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › VPC Integration Tests › security groups should exist and be properly configured

    InvalidParameterValue: vpc-id

      157 |
      158 |     test('security groups should exist and be properly configured', async () => {
    > 159 |       const response = await ec2Client.send(
          |                        ^
      160 |         new DescribeSecurityGroupsCommand({
      161 |           Filters: [
      162 |             {

      at throwDefaultError (node_modules/@smithy/smithy-client/dist-cjs/index.js:288:22)
      at throwDefaultError (node_modules/@smithy/smithy-client/dist-cjs/index.js:297:9)
      at throwDefaultError (node_modules/@aws-sdk/client-ec2/dist-cjs/index.js:16163:12)
      at node_modules/@smithy/middleware-serde/dist-cjs/index.js:8:24
      at node_modules/@smithy/core/dist-cjs/index.js:121:20
      at node_modules/@smithy/middleware-retry/dist-cjs/index.js:254:46
      at node_modules/@aws-sdk/client-ec2/node_modules/@aws-sdk/middleware-logger/dist-cjs/index.js:5:26
      at Object.<anonymous> (test/tap-stack.int.test.ts:159:24)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › Application Load Balancer Integration Tests › ALB should exist and be active

    expect(received).toBeDefined()

    Received: undefined

      212 |     test('ALB should exist and be active', async () => {
      213 |       expect(outputs.ALBDNSName).toBeDefined();
    > 214 |       expect(outputs.ALBUrl).toBeDefined();
          |                              ^
      215 |
      216 |       const response = await elbClient.send(
      217 |         new DescribeLoadBalancersCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:214:30)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › Application Load Balancer Integration Tests › ALB Target Group should exist with correct health check configuration

    TargetGroupNotFoundException: One or more target groups not found

      229 |
      230 |     test('ALB Target Group should exist with correct health check configuration', async () => {
    > 231 |       const response = await elbClient.send(
          |                        ^
      232 |         new DescribeTargetGroupsCommand({
      233 |           Names: [`loan-app-tg-${environmentSuffix}`]
      234 |         })

      at de_TargetGroupNotFoundExceptionRes (node_modules/@aws-sdk/client-elastic-load-balancing-v2/dist-cjs/index.js:2751:23)
      at de_TargetGroupNotFoundExceptionRes (node_modules/@aws-sdk/client-elastic-load-balancing-v2/dist-cjs/index.js:2249:25)
      at node_modules/@smithy/middleware-serde/dist-cjs/index.js:8:24
      at node_modules/@smithy/core/dist-cjs/index.js:121:20
      at node_modules/@smithy/middleware-retry/dist-cjs/index.js:254:46
      at node_modules/@aws-sdk/client-elastic-load-balancing-v2/node_modules/@aws-sdk/middleware-logger/dist-cjs/index.js:5:26
      at Object.<anonymous> (test/tap-stack.int.test.ts:231:24)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › Application Load Balancer Integration Tests › ALB should have healthy targets

    TargetGroupNotFoundException: One or more target groups not found

      248 |
      249 |     test('ALB should have healthy targets', async () => {
    > 250 |       const tgResponse = await elbClient.send(
          |                          ^
      251 |         new DescribeTargetGroupsCommand({
      252 |           Names: [`loan-app-tg-${environmentSuffix}`]
      253 |         })

      at de_TargetGroupNotFoundExceptionRes (node_modules/@aws-sdk/client-elastic-load-balancing-v2/dist-cjs/index.js:2751:23)
      at de_TargetGroupNotFoundExceptionRes (node_modules/@aws-sdk/client-elastic-load-balancing-v2/dist-cjs/index.js:2249:25)
      at node_modules/@smithy/middleware-serde/dist-cjs/index.js:8:24
      at node_modules/@smithy/core/dist-cjs/index.js:121:20
      at node_modules/@smithy/middleware-retry/dist-cjs/index.js:254:46
      at node_modules/@aws-sdk/client-elastic-load-balancing-v2/node_modules/@aws-sdk/middleware-logger/dist-cjs/index.js:5:26
      at Object.<anonymous> (test/tap-stack.int.test.ts:250:26)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › ECS Fargate Integration Tests › ECS Service should exist and be running

    expect(received).toBe(expected) // Object.is equality

    Expected: "ACTIVE"
    Received: "DRAINING"

      309 |       expect(response.services).toHaveLength(1);
      310 |       const service = response.services![0];
    > 311 |       expect(service.status).toBe('ACTIVE');
          |                              ^
      312 |       expect(service.launchType).toBe('FARGATE');
      313 |       expect(service.desiredCount).toBeGreaterThanOrEqual(2);
      314 |

      at Object.<anonymous> (test/tap-stack.int.test.ts:311:30)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › ECS Fargate Integration Tests › ECS Task Definition should be properly configured

    expect(received).toContain(expected) // indexOf

    Expected value: "curl"
    Received array: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]

      362 |       // Verify health check
      363 |       expect(container.healthCheck).toBeDefined();
    > 364 |       expect(container.healthCheck!.command).toContain('curl');
          |                                              ^
      365 |     });
      366 |   });
      367 |

      at Object.<anonymous> (test/tap-stack.int.test.ts:364:46)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › RDS Aurora Integration Tests › Aurora cluster should exist and be available

    expect(received).toBeDefined()

    Received: undefined

      372 |   describe('RDS Aurora Integration Tests', () => {
      373 |     test('Aurora cluster should exist and be available', async () => {
    > 374 |       expect(outputs.DBClusterEndpoint).toBeDefined();
          |                                         ^
      375 |       expect(outputs.DBClusterReadEndpoint).toBeDefined();
      376 |
      377 |       const response = await rdsClient.send(

      at Object.<anonymous> (test/tap-stack.int.test.ts:374:41)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › RDS Aurora Integration Tests › Aurora should have 2 database instances

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 2
    Received:    0

      405 |
      406 |       expect(response.DBInstances).toBeDefined();
    > 407 |       expect(response.DBInstances!.length).toBeGreaterThanOrEqual(2);
          |                                            ^
      408 |
      409 |       response.DBInstances!.forEach(instance => {
      410 |         expect(instance.DBInstanceStatus).toBe('available');

      at Object.<anonymous> (test/tap-stack.int.test.ts:407:44)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › RDS Aurora Integration Tests › Database secret should exist in Secrets Manager

    expect(received).toBeDefined()

    Received: undefined

      416 |
      417 |     test('Database secret should exist in Secrets Manager', async () => {
    > 418 |       expect(outputs.DBSecretArn).toBeDefined();
          |                                   ^
      419 |
      420 |       const response = await secretsClient.send(
      421 |         new DescribeSecretCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:418:35)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › S3 Static Assets Integration Tests › S3 bucket should exist and be accessible

    expect(received).toBeDefined()

    Received: undefined

      436 |   describe('S3 Static Assets Integration Tests', () => {
      437 |     test('S3 bucket should exist and be accessible', async () => {
    > 438 |       expect(outputs.StaticAssetsBucketName).toBeDefined();
          |                                              ^
      439 |
      440 |       await s3Client.send(
      441 |         new HeadBucketCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:438:46)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › S3 Static Assets Integration Tests › S3 bucket should have versioning enabled

    No value provided for input HTTP label: Bucket.

      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:508:15)
      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:559:25)
      at RequestBuilder.resolvePath [as build] (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:534:13)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › S3 Static Assets Integration Tests › S3 bucket should have lifecycle policy configured

    No value provided for input HTTP label: Bucket.

      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:508:15)
      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:559:25)
      at RequestBuilder.resolvePath [as build] (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:534:13)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › S3 Static Assets Integration Tests › S3 bucket should have encryption enabled

    No value provided for input HTTP label: Bucket.

      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:508:15)
      at resolvedPath (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:559:25)
      at RequestBuilder.resolvePath [as build] (node_modules/@smithy/core/dist-cjs/submodules/protocols/index.js:534:13)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › CloudFront Distribution Integration Tests › CloudFront distribution should exist and be deployed

    expect(received).toBeDefined()

    Received: undefined

      489 |       expect(outputs.CloudFrontDistributionId).toBeDefined();
      490 |       expect(outputs.CloudFrontDomainName).toBeDefined();
    > 491 |       expect(outputs.CloudFrontUrl).toBeDefined();
          |                                     ^
      492 |
      493 |       const response = await cloudFrontClient.send(
      494 |         new GetDistributionCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:491:37)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › CloudFront Distribution Integration Tests › CloudFront should use S3 origin with OAI

    NoSuchDistribution: The specified distribution does not exist.

      509 |
      510 |     test('CloudFront should use S3 origin with OAI', async () => {
    > 511 |       const response = await cloudFrontClient.send(
          |                        ^
      512 |         new GetDistributionCommand({
      513 |           Id: outputs.CloudFrontDistributionId
      514 |         })

      at de_NoSuchDistributionRes (node_modules/@aws-sdk/client-cloudfront/dist-cjs/index.js:9172:21)
      at de_NoSuchDistributionRes (node_modules/@aws-sdk/client-cloudfront/dist-cjs/index.js:7943:19)
      at node_modules/@smithy/middleware-serde/dist-cjs/index.js:8:24
      at node_modules/@smithy/core/dist-cjs/index.js:121:20
      at node_modules/@smithy/middleware-retry/dist-cjs/index.js:254:46
      at node_modules/@aws-sdk/middleware-logger/dist-cjs/index.js:33:22
      at Object.<anonymous> (test/tap-stack.int.test.ts:511:24)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › CloudFront Distribution Integration Tests › CloudFront should redirect to HTTPS

    NoSuchDistribution: The specified distribution does not exist.

      525 |
      526 |     test('CloudFront should redirect to HTTPS', async () => {
    > 527 |       const response = await cloudFrontClient.send(
          |                        ^
      528 |         new GetDistributionCommand({
      529 |           Id: outputs.CloudFrontDistributionId
      530 |         })

      at de_NoSuchDistributionRes (node_modules/@aws-sdk/client-cloudfront/dist-cjs/index.js:9172:21)
      at de_NoSuchDistributionRes (node_modules/@aws-sdk/client-cloudfront/dist-cjs/index.js:7943:19)
      at node_modules/@smithy/middleware-serde/dist-cjs/index.js:8:24
      at node_modules/@smithy/core/dist-cjs/index.js:121:20
      at node_modules/@smithy/middleware-retry/dist-cjs/index.js:254:46
      at node_modules/@aws-sdk/middleware-logger/dist-cjs/index.js:33:22
      at Object.<anonymous> (test/tap-stack.int.test.ts:527:24)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › CloudWatch Logs Integration Tests › ECS log group should exist with correct retention

    expect(received).toBeDefined()

    Received: undefined

      544 |   describe('CloudWatch Logs Integration Tests', () => {
      545 |     test('ECS log group should exist with correct retention', async () => {
    > 546 |       expect(outputs.CloudWatchLogGroup).toBeDefined();
          |                                          ^
      547 |
      548 |       const response = await logsClient.send(
      549 |         new DescribeLogGroupsCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:546:42)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › SNS Alerts Integration Tests › SNS topic should exist for alerts

    expect(received).toBeDefined()

    Received: undefined

      563 |   describe('SNS Alerts Integration Tests', () => {
      564 |     test('SNS topic should exist for alerts', async () => {
    > 565 |       expect(outputs.SNSTopicArn).toBeDefined();
          |                                   ^
      566 |
      567 |       const response = await snsClient.send(
      568 |         new GetTopicAttributesCommand({

      at Object.<anonymous> (test/tap-stack.int.test.ts:565:35)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › End-to-End Workflow Tests › complete infrastructure stack should be operational

    expect(received).toBeDefined()

    Received: undefined

      584 |     test('complete infrastructure stack should be operational', () => {
      585 |       // Verify all critical outputs exist
    > 586 |       expect(outputs.VPCId).toBeDefined();
          |                             ^
      587 |       expect(outputs.ALBUrl).toBeDefined();
      588 |       expect(outputs.ECSClusterName).toBeDefined();
      589 |       expect(outputs.ECSServiceName).toBeDefined();

      at Object.<anonymous> (test/tap-stack.int.test.ts:586:29)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › End-to-End Workflow Tests › network connectivity should be properly configured

    expect(received).toBeDefined()

    Received: undefined

      606 |     test('network connectivity should be properly configured', () => {
      607 |       // Verify networking components
    > 608 |       expect(outputs.VPCId).toBeDefined();
          |                             ^
      609 |
      610 |       // VPC should have subnets, NAT gateways, and route tables
      611 |       // (verified in individual tests above)

      at Object.<anonymous> (test/tap-stack.int.test.ts:608:29)

  ● CloudFormation Stack Integration Tests - Loan Processing Infrastructure › End-to-End Workflow Tests › security configuration should be properly implemented

    expect(received).toBeDefined()

    Received: undefined

      621 |     test('security configuration should be properly implemented', () => {
      622 |       // Verify security components
    > 623 |       expect(outputs.DBSecretArn).toBeDefined(); // Secrets Manager
          |                                   ^
      624 |       expect(outputs.CloudWatchLogGroup).toBeDefined(); // Logging
      625 |       expect(outputs.SNSTopicArn).toBeDefined(); // Alerting
      626 |

      at Object.<anonymous> (test/tap-stack.int.test.ts:623:35)

Test Suites: 1 failed, 1 total
Tests:       24 failed, 1 passed, 25 total
Snapshots:   0 total
Time:        13.484 s, estimated 16 s
Ran all test suites matching /.int.test.ts$/i.

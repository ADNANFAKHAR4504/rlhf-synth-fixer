"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_sns_1 = require("@aws-sdk/client-sns");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const region = process.env.REGION || 'us-east-1';
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region });
const s3Client = new client_s3_1.S3Client({ region });
const snsClient = new client_sns_1.SNSClient({ region });
const ssmClient = new client_ssm_1.SSMClient({ region });
const handler = async (event) => {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, X-Amz-Date, Authorization, X-Api-Key',
    };
    try {
        console.log('Processing request:', JSON.stringify(event, null, 2));
        // Get configuration from Parameter Store
        const [tableNameParam, bucketNameParam, snsTopicParam] = await Promise.all([
            ssmClient.send(new client_ssm_1.GetParameterCommand({ Name: process.env.TABLE_NAME_PARAM })),
            ssmClient.send(new client_ssm_1.GetParameterCommand({ Name: process.env.BUCKET_NAME_PARAM })),
            ssmClient.send(new client_ssm_1.GetParameterCommand({ Name: process.env.SNS_TOPIC_PARAM })),
        ]);
        const tableName = tableNameParam.Parameter?.Value;
        const bucketName = bucketNameParam.Parameter?.Value;
        const snsTopicArn = snsTopicParam.Parameter?.Value;
        if (!tableName || !bucketName || !snsTopicArn) {
            throw new Error('Missing required configuration parameters');
        }
        // Parse request body
        const requestBody = event.body ? JSON.parse(event.body) : {};
        const id = requestBody.id || `item-${Date.now()}`;
        // Create processed data object
        const processedData = {
            id,
            timestamp: new Date().toISOString(),
            data: requestBody,
            processed: true,
        };
        console.log('Processing data for ID:', id);
        // Store in DynamoDB
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: tableName,
            Item: {
                id: { S: processedData.id },
                timestamp: { S: processedData.timestamp },
                data: { S: JSON.stringify(processedData.data) },
                processed: { BOOL: processedData.processed },
            },
        }));
        console.log('Data stored in DynamoDB');
        // Store in S3
        const s3Key = `processed-data/${processedData.id}-${Date.now()}.json`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: bucketName,
            Key: s3Key,
            Body: JSON.stringify(processedData, null, 2),
            ContentType: 'application/json',
            ServerSideEncryption: 'AES256',
        }));
        console.log('Data stored in S3 with key:', s3Key);
        // Publish notification to SNS
        const snsMessage = {
            action: 'data_processed',
            id: processedData.id,
            timestamp: processedData.timestamp,
            s3Key,
            tableName,
        };
        await snsClient.send(new client_sns_1.PublishCommand({
            TopicArn: snsTopicArn,
            Message: JSON.stringify(snsMessage),
            Subject: `TAP: Data processed for ID ${processedData.id}`,
            MessageAttributes: {
                action: {
                    DataType: 'String',
                    StringValue: 'data_processed',
                },
                id: {
                    DataType: 'String',
                    StringValue: processedData.id,
                },
            },
        }));
        console.log('Notification sent to SNS');
        // Return success response
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                message: 'Data processed successfully',
                data: {
                    id: processedData.id,
                    timestamp: processedData.timestamp,
                    s3Key,
                },
            }),
        };
    }
    catch (error) {
        console.error('Error processing request:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({
                success: false,
                message: 'Internal server error',
                error: error instanceof Error ? error.message : 'Unknown error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsOERBQTBFO0FBQzFFLGtEQUFnRTtBQUNoRSxvREFBZ0U7QUFDaEUsb0RBQXFFO0FBRXJFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxJQUFJLFdBQVcsQ0FBQztBQUNqRCxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDMUMsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBU3JDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBMkIsRUFDSyxFQUFFO0lBQ2xDLE1BQU0sT0FBTyxHQUFHO1FBQ2QsY0FBYyxFQUFFLGtCQUFrQjtRQUNsQyw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLDhCQUE4QixFQUFFLGVBQWU7UUFDL0MsOEJBQThCLEVBQzVCLG9EQUFvRDtLQUN2RCxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVuRSx5Q0FBeUM7UUFDekMsTUFBTSxDQUFDLGNBQWMsRUFBRSxlQUFlLEVBQUUsYUFBYSxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ3pFLFNBQVMsQ0FBQyxJQUFJLENBQ1osSUFBSSxnQ0FBbUIsQ0FBQyxFQUFFLElBQUksRUFBRSxPQUFPLENB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WSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWU7YUFDaEUsQ0FBQztTQUNILENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBdElXLFFBQUEsT0FBTyxXQXNJbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgUHV0SXRlbUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgUzNDbGllbnQsIFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgU05TQ2xpZW50LCBQdWJsaXNoQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zbnMnO1xuaW1wb3J0IHsgU1NNQ2xpZW50LCBHZXRQYXJhbWV0ZXJDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNzbSc7XG5cbmNvbnN0IHJlZ2lvbiA9IHByb2Nlc3MuZW52LlJFR0lPTiB8fCAndXMtZWFzdC0xJztcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7IHJlZ2lvbiB9KTtcbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uIH0pO1xuY29uc3Qgc25zQ2xpZW50ID0gbmV3IFNOU0NsaWVudCh7IHJlZ2lvbiB9KTtcbmNvbnN0IHNzbUNsaWVudCA9IG5ldyBTU01DbGllbnQoeyByZWdpb24gfSk7XG5cbmludGVyZmFjZSBQcm9jZXNzZWREYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG4gIGRhdGE6IHVua25vd247XG4gIHByb2Nlc3NlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnUE9TVCwgT1BUSU9OUycsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOlxuICAgICAgJ0NvbnRlbnQtVHlwZSwgWC1BbXotRGF0ZSwgQXV0aG9yaXphdGlvbiwgWC1BcGktS2V5JyxcbiAgfTtcblxuICB0cnkge1xuICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIHJlcXVlc3Q6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICAgIC8vIEdldCBjb25maWd1cmF0aW9uIGZyb20gUGFyYW1ldGVyIFN0b3JlXG4gICAgY29uc3QgW3RhYmxlTmFtZVBhcmFtLCBidWNrZXROYW1lUGFyYW0sIHNuc1RvcGljUGFyYW1dID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgc3NtQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRQYXJhbWV0ZXJDb21tYW5kKHsgTmFtZTogcHJvY2Vzcy5lbnYuVEFCTEVfTkFNRV9QQVJBTSEgfSlcbiAgICAgICksXG4gICAgICBzc21DbGllbnQuc2VuZChcbiAgICAgICAgbmV3IEdldFBhcmFtZXRlckNvbW1hbmQoeyBOYW1lOiBwcm9jZXNzLmVudi5CVUNLRVRfTkFNRV9QQVJBTSEgfSlcbiAgICAgICksXG4gICAgICBzc21DbGllbnQuc2VuZChcbiAgICAgICAgbmV3IEdldFBhcmFtZXRlckNvbW1hbmQoeyBOYW1lOiBwcm9jZXNzLmVudi5TTlNfVE9QSUNfUEFSQU0hIH0pXG4gICAgICApLFxuICAgIF0pO1xuXG4gICAgY29uc3QgdGFibGVOYW1lID0gdGFibGVOYW1lUGFyYW0uUGFyYW1ldGVyPy5WYWx1ZTtcbiAgICBjb25zdCBidWNrZXROYW1lID0gYnVja2V0TmFtZVBhcmFtLlBhcmFtZXRlcj8uVmFsdWU7XG4gICAgY29uc3Qgc25zVG9waWNBcm4gPSBzbnNUb3BpY1BhcmFtLlBhcmFtZXRlcj8uVmFsdWU7XG5cbiAgICBpZiAoIXRhYmxlTmFtZSB8fCAhYnVja2V0TmFtZSB8fCAhc25zVG9waWNBcm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyByZXF1aXJlZCBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMnKTtcbiAgICB9XG5cbiAgICAvLyBQYXJzZSByZXF1ZXN0IGJvZHlcbiAgICBjb25zdCByZXF1ZXN0Qm9keSA9IGV2ZW50LmJvZHkgPyBKU09OLnBhcnNlKGV2ZW50LmJvZHkpIDoge307XG4gICAgY29uc3QgaWQgPSByZXF1ZXN0Qm9keS5pZCB8fCBgaXRlbS0ke0RhdGUubm93KCl9YDtcblxuICAgIC8vIENyZWF0ZSBwcm9jZXNzZWQgZGF0YSBvYmplY3RcbiAgICBjb25zdCBwcm9jZXNzZWREYXRhOiBQcm9jZXNzZWREYXRhID0ge1xuICAgICAgaWQsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGE6IHJlcXVlc3RCb2R5LFxuICAgICAgcHJvY2Vzc2VkOiB0cnVlLFxuICAgIH07XG5cbiAgICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBkYXRhIGZvciBJRDonLCBpZCk7XG5cbiAgICAvLyBTdG9yZSBpbiBEeW5hbW9EQlxuICAgIGF3YWl0IGR5bmFtb0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICBpZDogeyBTOiBwcm9jZXNzZWREYXRhLmlkIH0sXG4gICAgICAgICAgdGltZXN0YW1wOiB7IFM6IHByb2Nlc3NlZERhdGEudGltZXN0YW1wIH0sXG4gICAgICAgICAgZGF0YTogeyBTOiBKU09OLnN0cmluZ2lmeShwcm9jZXNzZWREYXRhLmRhdGEpIH0sXG4gICAgICAgICAgcHJvY2Vzc2VkOiB7IEJPT0w6IHByb2Nlc3NlZERhdGEucHJvY2Vzc2VkIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zb2xlLmxvZygnRGF0YSBzdG9yZWQgaW4gRHluYW1vREInKTtcblxuICAgIC8vIFN0b3JlIGluIFMzXG4gICAgY29uc3QgczNLZXkgPSBgcHJvY2Vzc2VkLWRhdGEvJHtwcm9jZXNzZWREYXRhLmlkfS0ke0RhdGUubm93KCl9Lmpzb25gO1xuICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgIEJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICAgICAgS2V5OiBzM0tleSxcbiAgICAgICAgQm9keTogSlNPTi5zdHJpbmdpZnkocHJvY2Vzc2VkRGF0YSwgbnVsbCwgMiksXG4gICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIFNlcnZlclNpZGVFbmNyeXB0aW9uOiAnQUVTMjU2JyxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKCdEYXRhIHN0b3JlZCBpbiBTMyB3aXRoIGtleTonLCBzM0tleSk7XG5cbiAgICAvLyBQdWJsaXNoIG5vdGlmaWNhdGlvbiB0byBTTlNcbiAgICBjb25zdCBzbnNNZXNzYWdlID0ge1xuICAgICAgYWN0aW9uOiAnZGF0YV9wcm9jZXNzZWQnLFxuICAgICAgaWQ6IHByb2Nlc3NlZERhdGEuaWQsXG4gICAgICB0aW1lc3RhbXA6IHByb2Nlc3NlZERhdGEudGltZXN0YW1wLFxuICAgICAgczNLZXksXG4gICAgICB0YWJsZU5hbWUsXG4gICAgfTtcblxuICAgIGF3YWl0IHNuc0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFB1Ymxpc2hDb21tYW5kKHtcbiAgICAgICAgVG9waWNBcm46IHNuc1RvcGljQXJuLFxuICAgICAgICBNZXNzYWdlOiBKU09OLnN0cmluZ2lmeShzbnNNZXNzYWdlKSxcbiAgICAgICAgU3ViamVjdDogYFRBUDogRGF0YSBwcm9jZXNzZWQgZm9yIElEICR7cHJvY2Vzc2VkRGF0YS5pZH1gLFxuICAgICAgICBNZXNzYWdlQXR0cmlidXRlczoge1xuICAgICAgICAgIGFjdGlvbjoge1xuICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgU3RyaW5nVmFsdWU6ICdkYXRhX3Byb2Nlc3NlZCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBpZDoge1xuICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgU3RyaW5nVmFsdWU6IHByb2Nlc3NlZERhdGEuaWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKCdOb3RpZmljYXRpb24gc2VudCB0byBTTlMnKTtcblxuICAgIC8vIFJldHVybiBzdWNjZXNzIHJlc3BvbnNlXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdEYXRhIHByb2Nlc3NlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgaWQ6IHByb2Nlc3NlZERhdGEuaWQsXG4gICAgICAgICAgdGltZXN0YW1wOiBwcm9jZXNzZWREYXRhLnRpbWVzdGFtcCxcbiAgICAgICAgICBzM0tleSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcHJvY2Vzc2luZyByZXF1ZXN0OicsIGVycm9yKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=
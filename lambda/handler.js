"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const region = process.env.REGION || 'us-east-1';
const dynamoClient = new client_dynamodb_1.DynamoDBClient({ region });
const s3Client = new client_s3_1.S3Client({ region });
const ssmClient = new client_ssm_1.SSMClient({ region });
const handler = async (event) => {
    const headers = {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, X-Amz-Date, Authorization, X-Api-Key',
    };
    try {
        console.log('Processing request:', JSON.stringify(event, null, 2));
        // Get configuration from Parameter Store
        const [tableNameParam, bucketNameParam] = await Promise.all([
            ssmClient.send(new client_ssm_1.GetParameterCommand({ Name: process.env.TABLE_NAME_PARAM })),
            ssmClient.send(new client_ssm_1.GetParameterCommand({ Name: process.env.BUCKET_NAME_PARAM })),
        ]);
        const tableName = tableNameParam.Parameter?.Value;
        const bucketName = bucketNameParam.Parameter?.Value;
        if (!tableName || !bucketName) {
            throw new Error('Missing required configuration parameters');
        }
        // Parse request body
        const requestBody = event.body ? JSON.parse(event.body) : {};
        const id = requestBody.id || `item-${Date.now()}`;
        // Create processed data object
        const processedData = {
            id,
            timestamp: new Date().toISOString(),
            data: requestBody,
            processed: true,
        };
        console.log('Processing data for ID:', id);
        // Store in DynamoDB
        await dynamoClient.send(new client_dynamodb_1.PutItemCommand({
            TableName: tableName,
            Item: {
                id: { S: processedData.id },
                timestamp: { S: processedData.timestamp },
                data: { S: JSON.stringify(processedData.data) },
                processed: { BOOL: processedData.processed },
            },
        }));
        console.log('Data stored in DynamoDB');
        // Store in S3
        const s3Key = `processed-data/${processedData.id}-${Date.now()}.json`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: bucketName,
            Key: s3Key,
            Body: JSON.stringify(processedData, null, 2),
            ContentType: 'application/json',
            ServerSideEncryption: 'AES256',
        }));
        console.log('Data stored in S3 with key:', s3Key);
        // Return success response
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                message: 'Data processed successfully',
                data: {
                    id: processedData.id,
                    timestamp: processedData.timestamp,
                    s3Key,
                },
            }),
        };
    }
    catch (error) {
        console.error('Error processing request:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({
                success: false,
                message: 'Internal server error',
                error: error instanceof Error ? error.message : 'Unknown error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQTBFO0FBQzFFLGtEQUFnRTtBQUNoRSxvREFBcUU7QUFFckUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDO0FBQ2pELE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBU3JDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQWdCLEVBQUU7SUFDeEQsTUFBTSxPQUFPLEdBQUc7UUFDZCxjQUFjLEVBQUUsa0JBQWtCO1FBQ2xDLDZCQUE2QixFQUFFLEdBQUc7UUFDbEMsOEJBQThCLEVBQUUsZUFBZTtRQUMvQyw4QkFBOEIsRUFDNUIsb0RBQW9EO0tBQ3ZELENBQUM7SUFFRixJQUFJLENBQUM7UUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRW5FLHlDQUF5QztRQUN6QyxNQUFNLENBQUMsY0FBYyxFQUFFLGVBQWUsQ0FBQyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUMxRCxTQUFTLENBQUMsSUFBSSxDQUNaLElBQUksZ0NBQW1CLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBaUIsRUFBRSxDQUFDLENBQ2pFO1lBQ0QsU0FBUyxDQUFDLElBQUksQ0FDWixJQUFJLGdDQUFtQixDQUFDLEVBQUUsSUFB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ZixPQUFPO1lBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ25CLE9BQU8sRUFBRSxLQUFLO2dCQUNkLE9BQU8sRUFBRSx1QkFBdUI7Z0JBQ2hDLEtBQUssRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO2FBQ2hFLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztBQUNILENBQUMsQ0FBQztBQW5HVyxRQUFBLE9BQU8sV0FtR2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFB1dEl0ZW1Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IFB1dE9iamVjdENvbW1hbmQsIFMzQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IEdldFBhcmFtZXRlckNvbW1hbmQsIFNTTUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zc20nO1xuXG5jb25zdCByZWdpb24gPSBwcm9jZXNzLmVudi5SRUdJT04gfHwgJ3VzLWVhc3QtMSc7XG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb24gfSk7XG5jb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbiB9KTtcbmNvbnN0IHNzbUNsaWVudCA9IG5ldyBTU01DbGllbnQoeyByZWdpb24gfSk7XG5cbmludGVyZmFjZSBQcm9jZXNzZWREYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG4gIGRhdGE6IHVua25vd247XG4gIHByb2Nlc3NlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IGFueSk6IFByb21pc2U8YW55PiA9PiB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ1BPU1QsIE9QVElPTlMnLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzpcbiAgICAgICdDb250ZW50LVR5cGUsIFgtQW16LURhdGUsIEF1dGhvcml6YXRpb24sIFgtQXBpLUtleScsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyByZXF1ZXN0OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgICAvLyBHZXQgY29uZmlndXJhdGlvbiBmcm9tIFBhcmFtZXRlciBTdG9yZVxuICAgIGNvbnN0IFt0YWJsZU5hbWVQYXJhbSwgYnVja2V0TmFtZVBhcmFtXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHNzbUNsaWVudC5zZW5kKFxuICAgICAgICBuZXcgR2V0UGFyYW1ldGVyQ29tbWFuZCh7IE5hbWU6IHByb2Nlc3MuZW52LlRBQkxFX05BTUVfUEFSQU0hIH0pXG4gICAgICApLFxuICAgICAgc3NtQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRQYXJhbWV0ZXJDb21tYW5kKHsgTmFtZTogcHJvY2Vzcy5lbnYuQlVDS0VUX05BTUVfUEFSQU0hIH0pXG4gICAgICApLFxuICAgIF0pO1xuXG4gICAgY29uc3QgdGFibGVOYW1lID0gdGFibGVOYW1lUGFyYW0uUGFyYW1ldGVyPy5WYWx1ZTtcbiAgICBjb25zdCBidWNrZXROYW1lID0gYnVja2V0TmFtZVBhcmFtLlBhcmFtZXRlcj8uVmFsdWU7XG5cbiAgICBpZiAoIXRhYmxlTmFtZSB8fCAhYnVja2V0TmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycycpO1xuICAgIH1cblxuICAgIC8vIFBhcnNlIHJlcXVlc3QgYm9keVxuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0gZXZlbnQuYm9keSA/IEpTT04ucGFyc2UoZXZlbnQuYm9keSkgOiB7fTtcbiAgICBjb25zdCBpZCA9IHJlcXVlc3RCb2R5LmlkIHx8IGBpdGVtLSR7RGF0ZS5ub3coKX1gO1xuXG4gICAgLy8gQ3JlYXRlIHByb2Nlc3NlZCBkYXRhIG9iamVjdFxuICAgIGNvbnN0IHByb2Nlc3NlZERhdGE6IFByb2Nlc3NlZERhdGEgPSB7XG4gICAgICBpZCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0YTogcmVxdWVzdEJvZHksXG4gICAgICBwcm9jZXNzZWQ6IHRydWUsXG4gICAgfTtcblxuICAgIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIGRhdGEgZm9yIElEOicsIGlkKTtcblxuICAgIC8vIFN0b3JlIGluIER5bmFtb0RCXG4gICAgYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgICAgSXRlbToge1xuICAgICAgICAgIGlkOiB7IFM6IHByb2Nlc3NlZERhdGEuaWQgfSxcbiAgICAgICAgICB0aW1lc3RhbXA6IHsgUzogcHJvY2Vzc2VkRGF0YS50aW1lc3RhbXAgfSxcbiAgICAgICAgICBkYXRhOiB7IFM6IEpTT04uc3RyaW5naWZ5KHByb2Nlc3NlZERhdGEuZGF0YSkgfSxcbiAgICAgICAgICBwcm9jZXNzZWQ6IHsgQk9PTDogcHJvY2Vzc2VkRGF0YS5wcm9jZXNzZWQgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKCdEYXRhIHN0b3JlZCBpbiBEeW5hbW9EQicpO1xuXG4gICAgLy8gU3RvcmUgaW4gUzNcbiAgICBjb25zdCBzM0tleSA9IGBwcm9jZXNzZWQtZGF0YS8ke3Byb2Nlc3NlZERhdGEuaWR9LSR7RGF0ZS5ub3coKX0uanNvbmA7XG4gICAgYXdhaXQgczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBidWNrZXROYW1lLFxuICAgICAgICBLZXk6IHMzS2V5LFxuICAgICAgICBCb2R5OiBKU09OLnN0cmluZ2lmeShwcm9jZXNzZWREYXRhLCBudWxsLCAyKSxcbiAgICAgICAgQ29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgU2VydmVyU2lkZUVuY3J5cHRpb246ICdBRVMyNTYnLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc29sZS5sb2coJ0RhdGEgc3RvcmVkIGluIFMzIHdpdGgga2V5OicsIHMzS2V5KTtcblxuICAgIC8vIFJldHVybiBzdWNjZXNzIHJlc3BvbnNlXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdEYXRhIHByb2Nlc3NlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgaWQ6IHByb2Nlc3NlZERhdGEuaWQsXG4gICAgICAgICAgdGltZXN0YW1wOiBwcm9jZXNzZWREYXRhLnRpbWVzdGFtcCxcbiAgICAgICAgICBzM0tleSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgcHJvY2Vzc2luZyByZXF1ZXN0OicsIGVycm9yKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cbn07XG4iXX0=
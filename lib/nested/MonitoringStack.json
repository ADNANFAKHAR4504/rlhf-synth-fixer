{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Monitoring Infrastructure - CloudWatch Alarms and SNS Topics",
  "Parameters": {
    "EnvironmentName": { "Type": "String" },
    "SnsEmail": { "Type": "String" },
    "ValidationFunctionName": { "Type": "String" },
    "ProcessingFunctionName": { "Type": "String" },
    "PaymentTableName": { "Type": "String" },
    "StateMachineArn": { "Type": "String" }
  },
  "Resources": {
    "AlarmTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": { "Fn::Sub": "payment-alarms-${EnvironmentName}" },
        "DisplayName": { "Fn::Sub": "Payment Processing Alarms - ${EnvironmentName}" },
        "Subscription": [
          {
            "Endpoint": { "Ref": "SnsEmail" },
            "Protocol": "email"
          }
        ],
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ValidationFunctionErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-validation-errors-${EnvironmentName}" },
        "AlarmDescription": "Alarm when validation function has errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ValidationFunctionName" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "ProcessingFunctionErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-processing-errors-${EnvironmentName}" },
        "AlarmDescription": "Alarm when processing function has errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ProcessingFunctionName" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "DynamoDBThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-dynamodb-throttle-${EnvironmentName}" },
        "AlarmDescription": "Alarm when DynamoDB requests are throttled",
        "MetricName": "UserErrors",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": { "Ref": "PaymentTableName" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "StateMachineFailureAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-workflow-failures-${EnvironmentName}" },
        "AlarmDescription": "Alarm when state machine executions fail",
        "MetricName": "ExecutionsFailed",
        "Namespace": "AWS/States",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 3,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "StateMachineArn",
            "Value": { "Ref": "StateMachineArn" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "ValidationFunctionDurationAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-validation-duration-${EnvironmentName}" },
        "AlarmDescription": "Alarm when validation function duration is high",
        "MetricName": "Duration",
        "Namespace": "AWS/Lambda",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ValidationFunctionName" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    }
  },
  "Outputs": {
    "AlarmTopicArn": {
      "Description": "SNS Topic ARN for alarms",
      "Value": { "Ref": "AlarmTopic" }
    },
    "AlarmTopicName": {
      "Description": "SNS Topic Name for alarms",
      "Value": { "Fn::GetAtt": ["AlarmTopic", "TopicName"] }
    }
  }
}

{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS WAF Security Infrastructure for API Protection with rate limiting, geo-blocking, SQL injection protection, and S3 logging",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Environment suffix for resource naming to support multiple PR environments",
      "MinLength": 1,
      "MaxLength": 20,
      "AllowedPattern": "[a-z0-9-]+",
      "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
    },
    "ALBArn": {
      "Type": "String",
      "Description": "ARN of the Application Load Balancer to associate with the WAF Web ACL",
      "AllowedPattern": "arn:aws:elasticloadbalancing:.*:.*:loadbalancer/app/.*",
      "ConstraintDescription": "Must be a valid ALB ARN"
    },
    "ProjectName": {
      "Type": "String",
      "Description": "Project name for cost allocation tagging",
      "Default": "WAFSecurityProject"
    },
    "Environment": {
      "Type": "String",
      "Description": "Environment name for cost allocation tagging",
      "Default": "production",
      "AllowedValues": ["production", "staging", "development", "test"]
    }
  },
  "Resources": {
    "OfficeIPSet": {
      "Type": "AWS::WAFv2::IPSet",
      "Properties": {
        "Name": {
          "Fn::Sub": "office-allowlist-ipset-${EnvironmentSuffix}"
        },
        "Description": "IP set for allowlisting trusted office IP ranges",
        "Scope": "REGIONAL",
        "IPAddressVersion": "IPV4",
        "Addresses": [
          "10.0.0.0/24",
          "192.168.1.0/24"
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "office-allowlist-ipset-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" }
          },
          {
            "Key": "Project",
            "Value": { "Ref": "ProjectName" }
          }
        ]
      }
    },
    "WAFLogBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "aws-waf-logs-${EnvironmentSuffix}-${AWS::AccountId}"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldLogs",
              "Status": "Enabled",
              "ExpirationInDays": 90,
              "NoncurrentVersionExpirationInDays": 30
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aws-waf-logs-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" }
          },
          {
            "Key": "Project",
            "Value": { "Ref": "ProjectName" }
          }
        ]
      }
    },
    "WAFLogBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "WAFLogBucket" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AWSLogDeliveryWrite",
              "Effect": "Allow",
              "Principal": {
                "Service": "logging.s3.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": {
                "Fn::Sub": "${WAFLogBucket.Arn}/*"
              },
              "Condition": {
                "StringEquals": {
                  "aws:SourceAccount": { "Ref": "AWS::AccountId" }
                }
              }
            },
            {
              "Sid": "AWSLogDeliveryAclCheck",
              "Effect": "Allow",
              "Principal": {
                "Service": "logging.s3.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": {
                "Fn::GetAtt": ["WAFLogBucket", "Arn"]
              },
              "Condition": {
                "StringEquals": {
                  "aws:SourceAccount": { "Ref": "AWS::AccountId" }
                }
              }
            }
          ]
        }
      }
    },
    "WAFWebACL": {
      "Type": "AWS::WAFv2::WebACL",
      "DependsOn": ["WAFLogBucket", "WAFLogBucketPolicy", "OfficeIPSet"],
      "Properties": {
        "Name": {
          "Fn::Sub": "api-protection-webacl-${EnvironmentSuffix}"
        },
        "Description": "WAF Web ACL for API protection with rate limiting, geo-blocking, and SQL injection protection",
        "Scope": "REGIONAL",
        "DefaultAction": {
          "Allow": {}
        },
        "Rules": [
          {
            "Name": "AllowOfficeIPs",
            "Priority": 0,
            "Statement": {
              "IPSetReferenceStatement": {
                "Arn": {
                  "Fn::GetAtt": ["OfficeIPSet", "Arn"]
                }
              }
            },
            "Action": {
              "Allow": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "AllowOfficeIPsRule"
            }
          },
          {
            "Name": "GeoBlockRule",
            "Priority": 1,
            "Statement": {
              "GeoMatchStatement": {
                "CountryCodes": ["KP", "IR"]
              }
            },
            "Action": {
              "Block": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "GeoBlockRule"
            }
          },
          {
            "Name": "RateLimitRule",
            "Priority": 2,
            "Statement": {
              "RateBasedStatement": {
                "Limit": 2000,
                "AggregateKeyType": "IP"
              }
            },
            "Action": {
              "Block": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "RateLimitRule"
            }
          },
          {
            "Name": "SQLInjectionProtection",
            "Priority": 3,
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesSQLiRuleSet"
              }
            },
            "OverrideAction": {
              "None": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": "SQLInjectionProtection"
            }
          }
        ],
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": {
            "Fn::Sub": "ApiProtectionWebACL-${EnvironmentSuffix}"
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "api-protection-webacl-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" }
          },
          {
            "Key": "Project",
            "Value": { "Ref": "ProjectName" }
          }
        ]
      }
    },
    "WAFWebACLAssociation": {
      "Type": "AWS::WAFv2::WebACLAssociation",
      "DependsOn": "WAFWebACL",
      "Properties": {
        "ResourceArn": { "Ref": "ALBArn" },
        "WebACLArn": {
          "Fn::GetAtt": ["WAFWebACL", "Arn"]
        }
      }
    },
    "WAFLoggingConfiguration": {
      "Type": "AWS::WAFv2::LoggingConfiguration",
      "DependsOn": ["WAFWebACL", "WAFLogBucket", "WAFLogBucketPolicy"],
      "Properties": {
        "ResourceArn": {
          "Fn::GetAtt": ["WAFWebACL", "Arn"]
        },
        "LogDestinationConfigs": [
          {
            "Fn::Sub": "arn:aws:s3:::${WAFLogBucket}"
          }
        ],
        "LoggingFilter": {
          "DefaultBehavior": "KEEP",
          "Filters": [
            {
              "Behavior": "KEEP",
              "Conditions": [
                {
                  "ActionCondition": {
                    "Action": "BLOCK"
                  }
                }
              ],
              "Requirement": "MEETS_ANY"
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "WebACLArn": {
      "Description": "ARN of the WAF Web ACL for API protection",
      "Value": {
        "Fn::GetAtt": ["WAFWebACL", "Arn"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WebACLArn"
        }
      }
    },
    "WebACLId": {
      "Description": "ID of the WAF Web ACL",
      "Value": {
        "Fn::GetAtt": ["WAFWebACL", "Id"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WebACLId"
        }
      }
    },
    "WAFLogBucketName": {
      "Description": "Name of the S3 bucket for WAF logs",
      "Value": {
        "Ref": "WAFLogBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WAFLogBucketName"
        }
      }
    },
    "WAFLogBucketArn": {
      "Description": "ARN of the S3 bucket for WAF logs",
      "Value": {
        "Fn::GetAtt": ["WAFLogBucket", "Arn"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WAFLogBucketArn"
        }
      }
    },
    "OfficeIPSetArn": {
      "Description": "ARN of the Office IP Set for allowlisting",
      "Value": {
        "Fn::GetAtt": ["OfficeIPSet", "Arn"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-OfficeIPSetArn"
        }
      }
    }
  }
}

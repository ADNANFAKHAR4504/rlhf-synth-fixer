import * as cdk from 'aws-cdk-lib';
import * as config from 'aws-cdk-lib/aws-config';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as sns from 'aws-cdk-lib/aws-sns';
import * as kms from 'aws-cdk-lib/aws-kms';
import * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';

export class SecurityConfigStack extends cdk.Stack {
  constructor(scope, id, props) {
    super(scope, id, props);

    const environmentSuffix = props?.environmentSuffix || 'dev';
    const encryptionKeyArn = props.encryptionKeyArn;
    const serviceRoleArn = props.serviceRoleArn;

    // S3 bucket for Config snapshots and history
    this.configBucket = new s3.Bucket(this, `ConfigBucket${environmentSuffix}`, {
      bucketName: `aws-config-security-${environmentSuffix}-${this.account}-${cdk.Aws.REGION}`,
      encryption: s3.BucketEncryption.KMS,
      encryptionKey: kms.Key.fromKeyArn(this, 'ConfigEncryptionKey', encryptionKeyArn),
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
      versioned: true,
      lifecycleRules: [
        {
          id: 'DeleteOldVersions',
          expiration: cdk.Duration.days(2555), // 7 years retention
          noncurrentVersionExpiration: cdk.Duration.days(365),
        },
      ],
      enforceSSL: true,
    });

    // SNS topic for compliance notifications
    this.complianceTopic = new sns.Topic(this, `ComplianceTopic${environmentSuffix}`, {
      topicName: `security-compliance-alerts-${environmentSuffix}`,
      displayName: 'Security Compliance Alerts',
      masterKey: kms.Key.fromKeyArn(this, 'TopicEncryptionKey', encryptionKeyArn),
    });

    // Config Configuration Recorder
    this.configRecorder = new config.CfnConfigurationRecorder(
      this,
      `ConfigRecorder${environmentSuffix}`,
      {
        name: `SecurityConfigRecorder${environmentSuffix}`,
        roleArn: serviceRoleArn,
        recordingGroup: {
          allSupported: true,
          includeGlobalResourceTypes: true,
          recordingModeOverrides: [
            {
              resourceTypes: ['AWS::EC2::Instance'],
              recordingFrequency: 'CONTINUOUS',
            },
            {
              resourceTypes: ['AWS::S3::Bucket'],
              recordingFrequency: 'CONTINUOUS', 
            },
            {
              resourceTypes: ['AWS::IAM::Role'],
              recordingFrequency: 'DAILY',
            },
          ],
        },
      }
    );

    // Try to use existing delivery channel or create new one
    // Note: AWS Config only allows one delivery channel per account/region
    // We'll reuse existing one if it exists

    // Security Config Rules

    // Rule 1: Ensure root access key check
    new config.ManagedRule(this, `RootAccessKeyCheckRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.IAM_ROOT_ACCESS_KEY_CHECK,
      description: 'Checks whether the root user access key is available',
      configRuleName: `root-access-key-check-${environmentSuffix}`,
    });

    // Rule 2: S3 bucket public access prohibited
    new config.ManagedRule(this, `S3BucketPublicAccessProhibitedRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.S3_BUCKET_PUBLIC_ACCESS_PROHIBITED,
      description: 'Checks that Amazon S3 buckets do not allow public access',
      configRuleName: `s3-bucket-public-access-prohibited-${environmentSuffix}`,
    });

    // Rule 3: S3 bucket server side encryption enabled
    new config.ManagedRule(this, `S3BucketServerSideEncryptionEnabledRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED,
      description: 'Checks that Amazon S3 bucket is encrypted by server-side encryption',
      configRuleName: `s3-bucket-server-side-encryption-enabled-${environmentSuffix}`,
    });

    // Rule 4: IAM password policy check
    new config.ManagedRule(this, `IAMPasswordPolicyRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.IAM_PASSWORD_POLICY,
      description: 'Checks whether the account password policy for IAM users meets specified requirements',
      configRuleName: `iam-password-policy-${environmentSuffix}`,
      inputParameters: {
        RequireUppercaseCharacters: true,
        RequireLowercaseCharacters: true,
        RequireSymbols: true,
        RequireNumbers: true,
        MinimumPasswordLength: 14,
        PasswordReusePrevention: 24,
        MaxPasswordAge: 90,
      },
    });

    // Rule 5: EBS volume encryption check
    new config.ManagedRule(this, `EBSVolumeEncryptionRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.ENCRYPTED_VOLUMES,
      description: 'Checks whether Amazon EBS volumes are encrypted',
      configRuleName: `ebs-volume-encryption-${environmentSuffix}`,
    });

    // Rule 6: CloudTrail enabled
    new config.ManagedRule(this, `CloudTrailEnabledRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.CLOUD_TRAIL_ENABLED,
      description: 'Checks whether AWS CloudTrail is enabled in your AWS account',
      configRuleName: `cloudtrail-enabled-${environmentSuffix}`,
    });

    // Rule 7: KMS key rotation enabled
    new config.ManagedRule(this, `KMSKeyRotationRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.CMK_BACKING_KEY_ROTATION_ENABLED,
      description: 'Checks whether key rotation is enabled for customer-created CMKs',
      configRuleName: `kms-key-rotation-enabled-${environmentSuffix}`,
    });

    // Rule 8: VPC security group restricted ingress
    new config.ManagedRule(this, `VPCSecurityGroupRestrictedIngressRule${environmentSuffix}`, {
      identifier: config.ManagedRuleIdentifiers.VPC_SG_OPEN_ONLY_TO_AUTHORIZED_PORTS,
      description: 'Checks if security groups restrict incoming traffic only to authorized ports',
      configRuleName: `vpc-security-group-restricted-ingress-${environmentSuffix}`,
    });

    // Apply mandatory tags
    cdk.Tags.of(this).add('Owner', 'SecurityTeam');
    cdk.Tags.of(this).add('Purpose', 'ComplianceMonitoring');
    cdk.Tags.of(this).add('Environment', environmentSuffix);
    cdk.Tags.of(this).add('CostCenter', 'Security');
    cdk.Tags.of(this).add('Compliance', 'Required');

    // Outputs
    new cdk.CfnOutput(this, `ConfigBucketName${environmentSuffix}`, {
      value: this.configBucket.bucketName,
      description: 'Config S3 Bucket Name',
      exportName: `SecurityStack-ConfigBucket-${environmentSuffix}`,
    });

    new cdk.CfnOutput(this, `ComplianceTopicArn${environmentSuffix}`, {
      value: this.complianceTopic.topicArn,
      description: 'Compliance SNS Topic ARN',
      exportName: `SecurityStack-ComplianceTopic-${environmentSuffix}`,
    });
  }
}
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Monitoring stack with CloudWatch alarms and Route53 health checks",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource naming"
    },
    "EnvironmentName": {
      "Type": "String",
      "Description": "Environment name (dev, staging, prod)"
    },
    "HostedZoneId": {
      "Type": "String",
      "Description": "Route53 hosted zone ID"
    },
    "DomainName": {
      "Type": "String",
      "Description": "Domain name for the application"
    },
    "ALBDNSName": {
      "Type": "String",
      "Description": "DNS name of the Application Load Balancer"
    },
    "ALBHostedZoneId": {
      "Type": "String",
      "Description": "Hosted zone ID of the Application Load Balancer"
    },
    "ECSClusterName": {
      "Type": "String",
      "Description": "Name of the ECS cluster"
    },
    "ECSServiceName": {
      "Type": "String",
      "Description": "Name of the ECS service"
    },
    "ProjectName": {
      "Type": "String",
      "Description": "Project name for tagging"
    }
  },
  "Resources": {
    "DNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {"Ref": "HostedZoneId"},
        "Name": {
          "Fn::Sub": "app-${EnvironmentName}.${DomainName}"
        },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {"Ref": "ALBDNSName"},
          "HostedZoneId": {"Ref": "ALBHostedZoneId"},
          "EvaluateTargetHealth": true
        }
      }
    },
    "HealthCheck": {
      "Type": "AWS::Route53::HealthCheck",
      "Properties": {
        "HealthCheckConfig": {
          "Type": "HTTPS_STR_MATCH",
          "FullyQualifiedDomainName": {"Ref": "ALBDNSName"},
          "Port": 80,
          "ResourcePath": "/health",
          "SearchString": "ok",
          "RequestInterval": 30,
          "FailureThreshold": 3
        },
        "HealthCheckTags": [
          {"Key": "Name", "Value": {"Fn::Sub": "health-check-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    "CPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "ecs-cpu-high-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when ECS service CPU exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {"Ref": "ECSServiceName"}
          },
          {
            "Name": "ClusterName",
            "Value": {"Ref": "ECSClusterName"}
          }
        ]
      }
    },
    "MemoryAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "ecs-memory-high-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when ECS service memory exceeds 80%",
        "MetricName": "MemoryUtilization",
        "Namespace": "AWS/ECS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {"Ref": "ECSServiceName"}
          },
          {
            "Name": "ClusterName",
            "Value": {"Ref": "ECSClusterName"}
          }
        ]
      }
    }
  },
  "Outputs": {
    "ApplicationDNS": {
      "Description": "Application DNS name",
      "Value": {
        "Fn::Sub": "app-${EnvironmentName}.${DomainName}"
      }
    },
    "HealthCheckId": {
      "Description": "Route53 health check ID",
      "Value": {"Ref": "HealthCheck"}
    }
  }
}
---
# GitLab CI/CD for GCP with Workload Identity Federation (no SA keys)
# - All inline scripts ≤5 lines
# - Security scans block on HIGH/CRITICAL
# - Preview (Cloud Run), Staging (GKE blue/green with Istio), Prod (multi-region gradual rollout)
# - HIPAA/compliance, monitoring, DR test
# - Reports: JUnit, Cobertura, Container Scanning, SAST (SARIF)

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

default:
  retry: 2
  interruptible: true

stages:
  - validate
  - build
  - test
  - preview
  - security
  - compliance
  - staging_deploy
  - performance
  - prod_approval
  - prod_deploy
  - monitoring
  - dr_test

variables:
  # GCP
  GCP_PROJECT_ID: ${GCP_PROJECT_ID}
  GCP_WIF_PROVIDER: ${GCP_WIF_PROVIDER}
  GCP_REGISTRY: ${GCP_REGISTRY}                       # e.g., us-central1-docker.pkg.dev
  APP_NAME: "app-name"
  CLOUD_RUN_REGIONS: "us-central1 us-east1 europe-west1"
  CLOUD_RUN_REGION: "us-central1"                     # default for preview
  ROLLOUT_STEPS: "10,50,100"
  HEALTH_WAIT_SECONDS: "30"

  # URLs
  STAGING_URL: "https://staging.example.com"
  PROD_URL: "https://prod.example.com"

  # Python
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  POETRY_CACHE_DIR: "$CI_PROJECT_DIR/.poetry-cache"

  # Tests
  TEST_COVERAGE_THRESHOLD: "85"

  # Images
  APP_IMAGE: "$GCP_REGISTRY/$GCP_PROJECT_ID/$APP_NAME:$CI_COMMIT_SHA"

  # Misc
  PREVIEW_TTL: "48 hours"
  COSIGN_KMS_KEY: "gcpkms://projects/$GCP_PROJECT_ID/locations/global/keyRings/cosign/cryptoKeys/cosign-key"

cache:
  key: "py-${PYTHON_VERSION}-${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}"
  paths:
    - .pip-cache/
    - .poetry-cache/

# DRY: WIF auth (≤5 lines via external script)
.auth_gcp: &auth_gcp
  before_script:
    - bash lib/scripts/gcp-wif-setup.sh

# ----------------------------
# VALIDATE
# ----------------------------
pylint:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pylint
    - pylint --output-format=parseable --reports=no src/ > pylint-report.txt
  artifacts:
    paths: [pylint-report.txt]
    expire_in: 1 week

flake8:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR flake8
    - flake8 src/ --output-file=flake8-report.txt
  artifacts:
    paths: [flake8-report.txt]
    expire_in: 1 week

mypy:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR mypy
    - mypy src/ > mypy-report.txt
  artifacts:
    paths: [mypy-report.txt]
    expire_in: 1 week

bandit:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR bandit
    - bandit -r src/ -f json -o bandit-report.json
  artifacts:
    paths: [bandit-report.json]
    expire_in: 1 week

pip_audit:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pip-audit
    - pip-audit -r requirements.txt -f json -o pip-audit-report.json
  artifacts:
    paths: [pip-audit-report.json]
    expire_in: 1 week

# ----------------------------
# BUILD
# ----------------------------
build_container:
  stage: build
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - gcloud builds submit --config=cloudbuild.yaml --substitutions=_IMAGE="$APP_IMAGE" .
    - echo "$APP_IMAGE" > image.txt
  artifacts:
    paths: [image.txt]
    expire_in: 1 week

# ----------------------------
# TEST
# ----------------------------
pytest:
  stage: test
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR -r requirements.txt pytest pytest-cov
    - pytest --cov=src --cov-report=xml --cov-report=term --cov-fail-under=$TEST_COVERAGE_THRESHOLD --junitxml=pytest-report.xml
  artifacts:
    reports:
      junit: pytest-report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  needs: [build_container]

locust_test:
  stage: test
  image: $CI_REGISTRY/locustio/locust:latest
  script:
    - locust -f locustfile.py --headless -u 25 -r 2 --run-time 5m --host "$STAGING_URL" --csv locust/results --html locust/report.html
  artifacts:
    paths: [locust/report.html, locust/results_stats.csv]
    expire_in: 1 week
  needs: [build_container]

integration_tests:
  stage: test
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  services:
    - name: docker:27-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pytest testcontainers
    - pytest --junitxml=integration-report.xml tests/integration/
  artifacts:
    reports:
      junit: integration-report.xml
    expire_in: 1 week
  needs: [build_container]

# ----------------------------
# PREVIEW (Cloud Run ephemeral)
# ----------------------------
preview_deploy:
  stage: preview
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - export PREVIEW_ID="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    - bash scripts/deploy-cloudrun.sh --preview --id "$PREVIEW_ID" --region "$CLOUD_RUN_REGION" --image "$(cat image.txt)"
    - gcloud run services describe "$PREVIEW_ID" --region="$CLOUD_RUN_REGION" --format='value(status.url)' > .preview_url
  artifacts:
    reports: { dotenv: .preview_url }
    paths: [.preview_url]
    expire_in: 1 week
  environment:
    name: "preview/$CI_COMMIT_REF_SLUG"
    url: $([ -f .preview_url ] && cat .preview_url || echo "")
    on_stop: stop_preview
    auto_stop_in: $PREVIEW_TTL
  needs: [build_container, pytest, integration_tests]

stop_preview:
  stage: preview
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - export PREVIEW_ID="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    - gcloud run services delete "$PREVIEW_ID" --region="$CLOUD_RUN_REGION" --quiet || true
  environment:
    name: "preview/$CI_COMMIT_REF_SLUG"
    action: stop
  when: manual

# ----------------------------
# SECURITY
# ----------------------------
trivy_scan:
  stage: security
  image: $CI_REGISTRY/aquasec/trivy:latest
  <<: *auth_gcp
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL --format json --output trivy.json "$(cat image.txt)"
  artifacts:
    reports:
      container_scanning: trivy.json
    expire_in: 1 week
  needs: [build_container]

grype_scan:
  stage: security
  image: $CI_REGISTRY/anchore/grype:latest
  <<: *auth_gcp
  script:
    - grype "$(cat image.txt)" -o sarif > grype.sarif
  artifacts:
    reports:
      sast: grype.sarif
    expire_in: 1 week
  needs: [build_container]

cosign_sign:
  stage: security
  image: $CI_REGISTRY/sigstore/cosign:latest
  <<: *auth_gcp
  script:
    - cosign sign --yes --key "$COSIGN_KMS_KEY" "$(cat image.txt)" | tee cosign-output.txt
    - cosign verify --key "$COSIGN_KMS_KEY" "$(cat image.txt)"
  artifacts:
    paths: [cosign-output.txt]
    expire_in: 1 week
  needs: [trivy_scan, grype_scan]

zap_dast:
  stage: security
  image: $CI_REGISTRY/owasp/zap2docker-stable:latest
  variables:
    TARGET_URL: "$CI_ENVIRONMENT_URL"
  script:
    - zap-baseline.py -t "$TARGET_URL" -r zap-report.html -x zap-report.xml -I
  artifacts:
    paths: [zap-report.html, zap-report.xml]
    expire_in: 1 week
  needs: [preview_deploy]

checkov_terraform:
  stage: security
  image: $CI_REGISTRY/bridgecrew/checkov:latest
  script:
    - checkov -d terraform/ --output junitxml > checkov-report.xml
  artifacts:
    reports:
      junit: checkov-report.xml
    expire_in: 1 week

# ----------------------------
# COMPLIANCE
# ----------------------------
hipaa_validation:
  stage: compliance
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - bash scripts/run-hipaa-validation.sh
  artifacts:
    paths: [hipaa-validation-report.json]
    expire_in: 1 week
  needs: [trivy_scan, grype_scan, cosign_sign]

cloud_asset_audit:
  stage: compliance
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - gcloud asset search-all-resources --scope="projects/$GCP_PROJECT_ID" --format=json > asset-inventory.json
    - gcloud asset search-all-iam-policies --scope="projects/$GCP_PROJECT_ID" --format=json > iam-policies.json
  artifacts:
    paths: [asset-inventory.json, iam-policies.json]
    expire_in: 1 week

access_logs_verification:
  stage: compliance
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - gcloud logging read 'logName="projects/'"$GCP_PROJECT_ID"'/logs/cloudaudit.googleapis.com%2Fdata_access"' --limit 100 --format=json > access-logs.json
  artifacts:
    paths: [access-logs.json]
    expire_in: 1 week

encryption_validation:
  stage: compliance
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - bash scripts/validate-encryption.sh
  artifacts:
    paths: [encryption-validation.json]
    expire_in: 1 week

# ----------------------------
# STAGING (GKE blue/green + Istio)
# ----------------------------
staging_deploy:
  stage: staging_deploy
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  variables:
    GKE_CLUSTER: "staging-gke-us-central1"
    GKE_LOCATION: "us-central1"
  script:
    - bash scripts/deploy-gke-bluegreen.sh --cluster "$GKE_CLUSTER" --location "$GKE_LOCATION" --app "$APP_NAME" --image "$(cat image.txt)"
  environment:
    name: staging
    url: $STAGING_URL
  needs: [hipaa_validation, encryption_validation]

# ----------------------------
# PERFORMANCE
# ----------------------------
lighthouse_performance:
  stage: performance
  image: $CI_REGISTRY/getlighthouse/lighthouse:latest
  script:
    - lighthouse "$STAGING_URL" --output html --output-path=./lighthouse-report.html
  artifacts:
    paths: [lighthouse-report.html]
    expire_in: 1 week
  needs: [staging_deploy]

jmeter_test:
  stage: performance
  image: $CI_REGISTRY/justb4/jmeter:latest
  script:
    - jmeter -n -t jmeter/test-plan.jmx -l results.jtl -e -o report/
  artifacts:
    paths: [results.jtl, report/]
    expire_in: 1 week
  needs: [staging_deploy]

db_profiling:
  stage: performance
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - gcloud logging read 'resource.type="cloudsql_database"' --limit 100 --format=json > sql-logs.json
  artifacts:
    paths: [sql-logs.json]
    expire_in: 1 week
  needs: [staging_deploy]

# ----------------------------
# PROD APPROVAL
# ----------------------------
prod_approval:
  stage: prod_approval
  image: $CI_REGISTRY/alpine:3
  script:
    - echo "Awaiting manual approval by compliance officer"
  environment:
    name: production
    action: prepare
  when: manual
  allow_failure: false
  needs: [lighthouse_performance, jmeter_test, db_profiling]

# ----------------------------
# PROD DEPLOY (Cloud Run multi-region, gradual rollout)
# ----------------------------
prod_deploy:
  stage: prod_deploy
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  variables:
    CR_REGIONS: "$CLOUD_RUN_REGIONS"
  script:
    - bash scripts/gradual-rollout.sh --image "$(cat image.txt)" --regions "$CR_REGIONS" --steps "$ROLLOUT_STEPS" --wait "$HEALTH_WAIT_SECONDS"
  environment:
    name: production
    url: $PROD_URL
  when: manual
  needs:
    - job: prod_approval
      artifacts: false

# ----------------------------
# MONITORING
# ----------------------------
configure_monitoring:
  stage: monitoring
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - bash scripts/configure-monitoring.sh
  artifacts:
    paths: [monitoring-dashboards.json]
    expire_in: 1 week
  needs: [prod_deploy]

audit_logs_verification:
  stage: monitoring
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - bq query --nouse_legacy_sql 'SELECT TIMESTAMP, PROTO_PAYLOAD FROM `'"$GCP_PROJECT_ID"'.app_dataset.audit_logs` LIMIT 10' > bq-audit-logs.json || echo "BQ check optional" > bq-audit-logs.json
  artifacts:
    paths: [bq-audit-logs.json]
    expire_in: 1 week
  needs: [prod_deploy]

error_reporting:
  stage: monitoring
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  script:
    - gcloud error-reporting events list --service="$APP_NAME" --limit=50 > error-report.txt || echo "error-reporting not configured" > error-report.txt
  artifacts:
    paths: [error-report.txt]
    expire_in: 1 week
  needs: [prod_deploy]

# ----------------------------
# DR TEST (scheduled)
# ----------------------------
dr_test:
  stage: dr_test
  image: $CI_REGISTRY/google-cloud-sdk:latest
  <<: *auth_gcp
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - bash scripts/test-dr.sh
  artifacts:
    paths: [dr-test-report.json]
    expire_in: 1 week
  needs: [configure_monitoring]

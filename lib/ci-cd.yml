---
# lib/ci-cd.yml
# GitLab CI/CD for GCP with Workload Identity Federation (no service account keys).
# All inline script blocks are kept ≤5 lines; complex logic is externalized in scripts/.
# CI images are expected to be mirrored in your private GitLab registry under $CI_REGISTRY/*.

stages:
  - validate
  - build
  - test
  - preview
  - security
  - compliance
  - staging_deploy
  - performance
  - prod_approval
  - prod_deploy
  - monitoring
  - dr_test

variables:
  # GCP
  GCP_PROJECT_ID: ${GCP_PROJECT_ID}
  GCP_WIF_PROVIDER: ${GCP_WIF_PROVIDER}
  GCP_REGISTRY: "us-central1-docker.pkg.dev"
  APP_NAME: "app-name"
  APP_IMAGE: "$GCP_REGISTRY/$GCP_PROJECT_ID/$APP_NAME:$CI_COMMIT_SHA"
  REGIONS: "us-central1,us-east1,europe-west1"
  PREVIEW_TTL: "48h"
  HEALTH_WAIT_SECONDS: "30"
  ROLLOUT_STEPS: "10,50,100"

  # Python
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  POETRY_CACHE_DIR: "$CI_PROJECT_DIR/.poetry-cache"
  TEST_COVERAGE_THRESHOLD: "85"

  # Optional KMS key path for Cosign
  COSIGN_KMS_KEY: "gcpkms://projects/$GCP_PROJECT_ID/locations/global/keyRings/cosign/cryptoKeys/cosign-key"

default:
  interruptible: true

cache:
  key: "py-${PYTHON_VERSION}-${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}"
  paths:
    - .pip-cache/
    - .poetry-cache/

# Reusable GCP WIF auth (≤5 lines by using external script)
.auth_gcp: &auth_gcp
  image: $CI_REGISTRY/cli/gcloud:latest
  before_script:
    - bash ./scripts/gcp-wif-setup.sh "$GCP_PROJECT_ID" "$GCP_WIF_PROVIDER" "workload-identity@${GCP_PROJECT_ID}.iam.gserviceaccount.com" "$GCP_REGISTRY"

####################
# VALIDATE
####################
pylint:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pylint
    - pylint --output-format=parseable --reports=no src/ > pylint-report.txt
  artifacts:
    paths: [pylint-report.txt]
    expire_in: 1 week

flake8:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR flake8
    - flake8 src/ --output-file=flake8-report.txt
  artifacts:
    paths: [flake8-report.txt]
    expire_in: 1 week

mypy:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR mypy
    - mypy src/ > mypy-report.txt
  artifacts:
    paths: [mypy-report.txt]
    expire_in: 1 week

bandit:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR bandit
    - bandit -r src/ -f json -o bandit-report.json
  artifacts:
    paths: [bandit-report.json]
    expire_in: 1 week

pip_audit:
  stage: validate
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pip-audit
    - pip-audit -r requirements.txt -o json -f pip-audit-report.json
  artifacts:
    paths: [pip-audit-report.json]
    expire_in: 1 week

####################
# BUILD
####################
build_container:
  stage: build
  <<: *auth_gcp
  script:
    - gcloud builds submit --config=cloudbuild.yaml --substitutions=_IMAGE_TAG="$APP_IMAGE" .
    - printf "%s" "$APP_IMAGE" > image.txt
  artifacts:
    paths: [image.txt]
    expire_in: 1 week
  retry: 2

####################
# TEST
####################
pytest:
  stage: test
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pytest pytest-cov
    - pytest --cov=src --cov-report=xml:coverage.xml --cov-fail-under="$TEST_COVERAGE_THRESHOLD" --junitxml=pytest-report.xml tests/
  artifacts:
    reports:
      junit: pytest-report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week

locust_test:
  stage: test
  image: $CI_REGISTRY/perf/locust:latest
  script:
    - cd locust
    - locust -f locustfile.py --headless -u 25 -r 2 --run-time 5m --host https://staging.example.com
  artifacts:
    paths: [locust/]
    expire_in: 1 week

integration_tests:
  stage: test
  image: $CI_REGISTRY/python:$PYTHON_VERSION
  services:
    - name: $CI_REGISTRY/docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - pip install --cache-dir=$PIP_CACHE_DIR pytest testcontainers
    - pytest --junitxml=integration-report.xml tests/integration/
  artifacts:
    reports:
      junit: integration-report.xml
    expire_in: 1 week

####################
# PREVIEW
####################
preview_deploy:
  stage: preview
  <<: *auth_gcp
  needs: [build_container, pytest, integration_tests]
  script:
    - export PREVIEW_ID="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
    - bash scripts/deploy-cloudrun.sh --id "$PREVIEW_ID" --image "$(cat image.txt)" --ttl "$PREVIEW_TTL"
    - sed -n '1p' preview.env
  environment:
    name: "preview/${CI_COMMIT_REF_SLUG}"
    url: "${PREVIEW_URL}"
    on_stop: stop_preview
    auto_stop_in: $PREVIEW_TTL
  artifacts:
    paths: [preview.env]
    reports:
      dotenv: preview.env
    expire_in: 1 week
  retry: 2

stop_preview:
  stage: preview
  <<: *auth_gcp
  script:
    - bash scripts/deploy-cloudrun.sh --delete --id "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  environment:
    name: "preview/${CI_COMMIT_REF_SLUG}"
    action: stop
  when: manual
  retry: 2

####################
# SECURITY
####################
trivy_scan:
  stage: security
  image: $CI_REGISTRY/security/trivy:latest
  <<: *auth_gcp
  needs: [build_container]
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 1 --format json --output trivy-report.json "$(cat image.txt)"
  artifacts:
    paths: [trivy-report.json]
    reports:
      sast: trivy-report.json
    expire_in: 1 week

grype_scan:
  stage: security
  image: $CI_REGISTRY/security/grype:latest
  <<: *auth_gcp
  needs: [build_container]
  script:
    - grype "$(cat image.txt)" --fail-on High -o json > grype-report.json
  artifacts:
    paths: [grype-report.json]
    expire_in: 1 week

cosign_sign:
  stage: security
  image: $CI_REGISTRY/security/cosign:latest
  <<: *auth_gcp
  needs: [trivy_scan, grype_scan]
  script:
    - cosign sign --yes --key "$COSIGN_KMS_KEY" "$(cat image.txt)"
    - cosign verify --key "$COSIGN_KMS_KEY" "$(cat image.txt)"
  artifacts:
    paths: [cosign.signature, cosign.attestation]
    when: on_success
    expire_in: 1 week

zap_dast:
  stage: security
  image: $CI_REGISTRY/security/zap2docker-stable:latest
  needs: [preview_deploy]
  variables:
    TARGET_URL: "${PREVIEW_URL}"
  script:
    - zap-baseline.py -t "$TARGET_URL" -x zap-report.xml -I
    - zap-cli report -o zap-report.html -f html || true
  artifacts:
    paths: [zap-report.xml, zap-report.html]
    expire_in: 1 week

checkov_terraform:
  stage: security
  image: $CI_REGISTRY/iac/checkov:latest
  script:
    - checkov -d terraform/ --output junitxml > checkov-report.xml
  artifacts:
    reports:
      junit: checkov-report.xml
    paths: [checkov-report.xml]
    expire_in: 1 week

####################
# COMPLIANCE
####################
hipaa_validation:
  stage: compliance
  <<: *auth_gcp
  needs: [trivy_scan, grype_scan, cosign_sign]
  script:
    - bash scripts/run-hipaa-validation.sh
    - test -f reports/hipaa/hipaa-validation.json
  artifacts:
    paths: [reports/hipaa/]
    expire_in: 1 week

cloud_asset_audit:
  stage: compliance
  <<: *auth_gcp
  script:
    - bash scripts/validate-encryption.sh inventory
    - test -f reports/compliance/asset-inventory.json
  artifacts:
    paths: [reports/compliance/asset-inventory.json, reports/compliance/iam-policies.json]
    expire_in: 1 week

access_logs_verification:
  stage: compliance
  <<: *auth_gcp
  script:
    - bash scripts/validate-encryption.sh access-logging
    - test -f reports/compliance/access-logs.json
  artifacts:
    paths: [reports/compliance/access-logs.json]
    expire_in: 1 week

encryption_validation:
  stage: compliance
  <<: *auth_gcp
  script:
    - bash scripts/validate-encryption.sh at-rest
    - test -f reports/compliance/encryption-validation.json
  artifacts:
    paths: [reports/compliance/encryption-validation.json]
    expire_in: 1 week

####################
# STAGING (GKE blue/green with Istio)
####################
staging_deploy:
  stage: staging_deploy
  <<: *auth_gcp
  needs: [hipaa_validation, encryption_validation]
  script:
    - bash scripts/deploy-gke-bluegreen.sh --cluster "staging-gke-us-central1" --namespace "staging" --app "$APP_NAME" --image "$(cat image.txt)"
    - echo "Staging deployment complete"
  environment:
    name: staging
    url: https://staging.example.com
  retry: 2

####################
# PERFORMANCE
####################
lighthouse_performance:
  stage: performance
  image: $CI_REGISTRY/perf/lighthouse-ci:latest
  needs: [staging_deploy]
  script:
    - lhci autorun --collect.url=https://staging.example.com --upload.target=filesystem --upload.outputDir=./lighthouse-report
    - test -d lighthouse-report
  artifacts:
    paths: [lighthouse-report/]
    expire_in: 1 week

jmeter_test:
  stage: performance
  image: $CI_REGISTRY/perf/jmeter:latest
  needs: [staging_deploy]
  script:
    - jmeter -n -t jmeter/test-plan.jmx -l jmeter/results.jtl -e -o jmeter/report
    - test -f jmeter/results.jtl
  artifacts:
    paths: [jmeter/results.jtl, jmeter/report/]
    expire_in: 1 week

db_profiling:
  stage: performance
  <<: *auth_gcp
  needs: [staging_deploy]
  script:
    - gcloud sql operations list --instance=app-db > reports/perf/sql-operations.txt
    - gcloud logging read 'resource.type="cloudsql_database"' --limit 100 > reports/perf/sql-logs.json
  artifacts:
    paths: [reports/perf/sql-operations.txt, reports/perf/sql-logs.json]
    expire_in: 1 week

####################
# PRODUCTION APPROVAL
####################
prod_approval:
  stage: prod_approval
  image: $CI_REGISTRY/alpine:latest
  script:
    - echo "Manual approval by compliance officer is required"
  environment:
    name: production
    action: prepare
  when: manual
  allow_failure: false
  needs: [lighthouse_performance, jmeter_test, db_profiling]

####################
# PRODUCTION (Cloud Run gradual multi-region)
####################
prod_deploy:
  stage: prod_deploy
  <<: *auth_gcp
  needs:
    - job: prod_approval
      artifacts: false
  script:
    - bash scripts/gradual-rollout.sh --image "$(cat image.txt)" --regions "$REGIONS" --steps "$ROLLOUT_STEPS" --wait "$HEALTH_WAIT_SECONDS"
    - echo "Production rollout finished"
  environment:
    name: production
    url: https://prod.example.com
  when: manual
  retry: 2

####################
# MONITORING
####################
configure_monitoring:
  stage: monitoring
  <<: *auth_gcp
  needs: [prod_deploy]
  script:
    - bash scripts/configure-monitoring.sh --project "$GCP_PROJECT_ID"
    - test -f reports/monitoring/dashboards.json
  artifacts:
    paths: [reports/monitoring/]
    expire_in: 1 week

audit_logs_verification:
  stage: monitoring
  <<: *auth_gcp
  needs: [prod_deploy]
  script:
    - bash scripts/validate-encryption.sh audit-pipeline
    - test -f reports/compliance/bq-audit-logs.json
  artifacts:
    paths: [reports/compliance/bq-audit-logs.json, reports/compliance/audit-activity.json]
    expire_in: 1 week

error_reporting:
  stage: monitoring
  <<: *auth_gcp
  needs: [prod_deploy]
  script:
    - gcloud error-reporting events list --service="$APP_NAME" > reports/monitoring/error-report.txt || true
    - test -f reports/monitoring/error-report.txt
  artifacts:
    paths: [reports/monitoring/error-report.txt]
    expire_in: 1 week

####################
# DISASTER RECOVERY (scheduled)
####################
dr_test:
  stage: dr_test
  <<: *auth_gcp
  script:
    - bash scripts/test-dr.sh --project "$GCP_PROJECT_ID"
    - test -f reports/dr/dr-test-report.json
  artifacts:
    paths: [reports/dr/dr-test-report.json]
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

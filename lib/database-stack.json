{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Database stack with RDS PostgreSQL and conditional Multi-AZ",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource naming"
    },
    "EnvironmentName": {
      "Type": "String",
      "Description": "Environment name (dev, staging, prod)"
    },
    "PrivateSubnetIds": {
      "Type": "CommaDelimitedList",
      "Description": "List of private subnet IDs for RDS"
    },
    "DBSecurityGroupId": {
      "Type": "String",
      "Description": "Security group ID for RDS"
    },
    "DBInstanceClass": {
      "Type": "String",
      "Description": "RDS instance class"
    },
    "DBAllocatedStorage": {
      "Type": "String",
      "Description": "Allocated storage in GB"
    },
    "DBMultiAZ": {
      "Type": "String",
      "Description": "Enable Multi-AZ deployment (true/false)",
      "AllowedValues": ["true", "false"]
    },
    "DBMasterPasswordSecretArn": {
      "Type": "String",
      "Description": "ARN of Secrets Manager secret containing DB password"
    },
    "ProjectName": {
      "Type": "String",
      "Description": "Project name for tagging"
    },
    "CostCenter": {
      "Type": "String",
      "Description": "Cost center for billing"
    }
  },
  "Resources": {
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {
          "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
        },
        "DBSubnetGroupDescription": "Subnet group for RDS PostgreSQL",
        "SubnetIds": {"Ref": "PrivateSubnetIds"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    "DBParameterGroup": {
      "Type": "AWS::RDS::DBParameterGroup",
      "Properties": {
        "DBParameterGroupName": {
          "Fn::Sub": "pg-params-${EnvironmentSuffix}"
        },
        "Description": "PostgreSQL parameter group with optimized settings",
        "Family": "postgres14",
        "Parameters": {
          "shared_preload_libraries": "pg_stat_statements",
          "log_statement": "all",
          "log_min_duration_statement": "1000"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "pg-params-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    "DBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "DeletionPolicy": "Snapshot",
      "UpdateReplacePolicy": "Snapshot",
      "Properties": {
        "DBInstanceIdentifier": {
          "Fn::Sub": "postgres-${EnvironmentSuffix}"
        },
        "DBName": "appdb",
        "Engine": "postgres",
        "EngineVersion": "14",
        "DBInstanceClass": {"Ref": "DBInstanceClass"},
        "AllocatedStorage": {"Ref": "DBAllocatedStorage"},
        "StorageType": "gp3",
        "StorageEncrypted": true,
        "MasterUsername": {
          "Fn::Sub": "{{resolve:secretsmanager:${DBMasterPasswordSecretArn}:SecretString:username}}"
        },
        "MasterUserPassword": {
          "Fn::Sub": "{{resolve:secretsmanager:${DBMasterPasswordSecretArn}:SecretString:password}}"
        },
        "DBSubnetGroupName": {"Ref": "DBSubnetGroup"},
        "DBParameterGroupName": {"Ref": "DBParameterGroup"},
        "VPCSecurityGroups": [{"Ref": "DBSecurityGroupId"}],
        "MultiAZ": {"Ref": "DBMultiAZ"},
        "PubliclyAccessible": false,
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
        "EnableCloudwatchLogsExports": ["postgresql", "upgrade"],
        "DeletionProtection": false,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "postgres-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    }
  },
  "Outputs": {
    "DBInstanceId": {
      "Description": "RDS instance identifier",
      "Value": {"Ref": "DBInstance"}
    },
    "DBEndpoint": {
      "Description": "RDS instance endpoint",
      "Value": {"Fn::GetAtt": ["DBInstance", "Endpoint.Address"]}
    },
    "DBPort": {
      "Description": "RDS instance port",
      "Value": {"Fn::GetAtt": ["DBInstance", "Endpoint.Port"]}
    },
    "DBName": {
      "Description": "Database name",
      "Value": "appdb"
    }
  }
}
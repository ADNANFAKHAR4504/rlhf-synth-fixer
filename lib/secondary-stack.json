{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Multi-Region DR Infrastructure - Secondary Region (us-west-2) with Aurora Global Database Secondary Cluster and Lambda",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming (must match primary stack)",
      "AllowedPattern": "^[a-z0-9-]+$",
      "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
    },
    "GlobalClusterIdentifier": {
      "Type": "String",
      "Description": "Global Cluster Identifier from primary stack"
    },
    "HostedZoneId": {
      "Type": "String",
      "Description": "Route 53 Hosted Zone ID from primary stack"
    },
    "NotificationEmail": {
      "Type": "String",
      "Default": "devops@example.com",
      "Description": "Email address for SNS failover notifications",
      "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
      "ConstraintDescription": "Must be a valid email address"
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.1.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-vpc-secondary-${EnvironmentSuffix}"}
          },
          {
            "Key": "Environment",
            "Value": "production"
          }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.1.1.0/24",
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-1-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.1.2.0/24",
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-2-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.1.3.0/24",
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-3-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {"Fn::Sub": "payment-dr-db-subnet-secondary-${EnvironmentSuffix}"},
        "DBSubnetGroupDescription": "Subnet group for Aurora Global Database secondary cluster",
        "SubnetIds": [
          {"Ref": "PrivateSubnet1"},
          {"Ref": "PrivateSubnet2"},
          {"Ref": "PrivateSubnet3"}
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-db-subnet-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DatabaseSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "payment-dr-db-sg-secondary-${EnvironmentSuffix}"},
        "GroupDescription": "Security group for Aurora database - allows access from Lambda only",
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-db-sg-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "payment-dr-lambda-sg-secondary-${EnvironmentSuffix}"},
        "GroupDescription": "Security group for Lambda functions",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-lambda-sg-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DatabaseSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "DatabaseSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "SourceSecurityGroupId": {"Ref": "LambdaSecurityGroup"}
      }
    },
    "LambdaSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {"Ref": "LambdaSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "DestinationSecurityGroupId": {"Ref": "DatabaseSecurityGroup"}
      }
    },
    "SecondaryAuroraDBCluster": {
      "Type": "AWS::RDS::DBCluster",
      "DeletionPolicy": "Delete",
      "Properties": {
        "Engine": "aurora-mysql",
        "EngineVersion": "8.0.mysql_aurora.3.04.0",
        "DBClusterIdentifier": {"Fn::Sub": "payment-dr-cluster-secondary-${EnvironmentSuffix}"},
        "DBSubnetGroupName": {"Ref": "DBSubnetGroup"},
        "VpcSecurityGroupIds": [{"Ref": "DatabaseSecurityGroup"}],
        "StorageEncrypted": true,
        "EnableCloudwatchLogsExports": ["error", "general", "slowquery"],
        "DeletionProtection": false,
        "GlobalClusterIdentifier": {"Ref": "GlobalClusterIdentifier"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-cluster-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "SecondaryAuroraDBInstance1": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "aurora-mysql",
        "DBClusterIdentifier": {"Ref": "SecondaryAuroraDBCluster"},
        "DBInstanceIdentifier": {"Fn::Sub": "payment-dr-instance-secondary-1-${EnvironmentSuffix}"},
        "DBInstanceClass": "db.r5.large",
        "PubliclyAccessible": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-instance-secondary-1-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {"Fn::Sub": "payment-dr-lambda-role-secondary-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "RDSDataAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "rds-data:ExecuteStatement",
                    "rds-data:BatchExecuteStatement"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:payment-dr-cluster-secondary-${EnvironmentSuffix}"}
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:payment-dr-*"}
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/payment-processor-*"}
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-lambda-role-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PaymentProcessorFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {"Fn::Sub": "payment-processor-secondary-${EnvironmentSuffix}"},
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Role": {"Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
        "MemorySize": 1024,
        "Timeout": 30,
        "VpcConfig": {
          "SecurityGroupIds": [{"Ref": "LambdaSecurityGroup"}],
          "SubnetIds": [
            {"Ref": "PrivateSubnet1"},
            {"Ref": "PrivateSubnet2"},
            {"Ref": "PrivateSubnet3"}
          ]
        },
        "Environment": {
          "Variables": {
            "DB_CLUSTER_ENDPOINT": {"Fn::GetAtt": ["SecondaryAuroraDBCluster", "Endpoint.Address"]},
            "DB_NAME": "payments",
            "REGION": "us-west-2"
          }
        },
        "Code": {
          "ZipFile": "import json\nimport os\nimport logging\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Payment processing Lambda function - Secondary Region.\n    Processes payment transactions during failover scenarios.\n    \"\"\"\n    try:\n        # Extract payment data from event\n        payment_id = event.get('payment_id', 'unknown')\n        amount = event.get('amount', 0)\n        currency = event.get('currency', 'USD')\n        \n        logger.info(f\"Processing payment {payment_id} for {amount} {currency} in SECONDARY region\")\n        \n        # Database connection parameters\n        db_endpoint = os.environ.get('DB_CLUSTER_ENDPOINT')\n        db_name = os.environ.get('DB_NAME', 'payments')\n        region = os.environ.get('REGION', 'us-west-2')\n        \n        # Process payment logic here\n        # In production, this would connect to Aurora and store transaction\n        \n        response = {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Payment processed successfully in secondary region',\n                'payment_id': payment_id,\n                'region': region,\n                'amount': amount,\n                'currency': currency,\n                'failover': True\n            })\n        }\n        \n        logger.info(f\"Payment {payment_id} processed successfully in SECONDARY {region}\")\n        return response\n        \n    except Exception as e:\n        logger.error(f\"Error processing payment in secondary region: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'message': 'Error processing payment in secondary region',\n                'error': str(e)\n            })\n        }\n"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-processor-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PaymentProcessorLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {"Fn::Sub": "/aws/lambda/payment-processor-secondary-${EnvironmentSuffix}"},
        "RetentionInDays": 30
      }
    },
    "SecondaryReplicationLagAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-replication-lag-secondary-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when Aurora Global Database replication lag exceeds 1 second in secondary region",
        "MetricName": "AuroraGlobalDBReplicationLag",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": {"Ref": "SecondaryAuroraDBCluster"}
          }
        ],
        "AlarmActions": [{"Ref": "SecondaryFailoverNotificationTopic"}],
        "TreatMissingData": "notBreaching"
      }
    },
    "SecondaryDatabaseCPUAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-db-cpu-secondary-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when secondary database CPU exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": {"Ref": "SecondaryAuroraDBCluster"}
          }
        ],
        "AlarmActions": [{"Ref": "SecondaryFailoverNotificationTopic"}]
      }
    },
    "SecondaryLambdaErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-lambda-errors-secondary-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when Lambda function errors exceed threshold in secondary region",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {"Ref": "PaymentProcessorFunction"}
          }
        ],
        "AlarmActions": [{"Ref": "SecondaryFailoverNotificationTopic"}]
      }
    },
    "SecondaryFailoverNotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {"Fn::Sub": "payment-dr-failover-secondary-${EnvironmentSuffix}"},
        "DisplayName": "Payment DR Failover Notifications - Secondary Region",
        "KmsMasterKeyId": "alias/aws/sns",
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-failover-secondary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "SecondaryFailoverNotificationSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Protocol": "email",
        "TopicArn": {"Ref": "SecondaryFailoverNotificationTopic"},
        "Endpoint": {"Ref": "NotificationEmail"}
      }
    },
    "SecondaryHealthAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-secondary-health-${EnvironmentSuffix}"},
        "AlarmDescription": "Health check for secondary region",
        "MetricName": "Invocations",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {"Ref": "PaymentProcessorFunction"}
          }
        ],
        "TreatMissingData": "breaching"
      }
    },
    "SecondaryHealthCheck": {
      "Type": "AWS::Route53::HealthCheck",
      "DependsOn": "SecondaryHealthAlarm",
      "Properties": {
        "HealthCheckConfig": {
          "Type": "CLOUDWATCH_METRIC",
          "AlarmIdentifier": {
            "Region": "us-west-2",
            "Name": {"Fn::Sub": "payment-dr-secondary-health-${EnvironmentSuffix}"}
          },
          "InsufficientDataHealthStatus": "Healthy"
        },
        "HealthCheckTags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-secondary-health-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "SecondaryDNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {"Ref": "HostedZoneId"},
        "Name": {"Fn::Sub": "api.payment-dr-${EnvironmentSuffix}.test-domain.internal"},
        "Type": "CNAME",
        "SetIdentifier": "Secondary",
        "Failover": "SECONDARY",
        "TTL": 60,
        "ResourceRecords": [
          {"Fn::GetAtt": ["SecondaryAuroraDBCluster", "Endpoint.Address"]}
        ],
        "HealthCheckId": {"Ref": "SecondaryHealthCheck"}
      }
    }
  },
  "Outputs": {
    "VPCId": {
      "Description": "VPC ID for secondary region",
      "Value": {"Ref": "VPC"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-vpc-secondary-${EnvironmentSuffix}"}
      }
    },
    "SecondaryAuroraEndpoint": {
      "Description": "Secondary Aurora cluster endpoint",
      "Value": {"Fn::GetAtt": ["SecondaryAuroraDBCluster", "Endpoint.Address"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-secondary-endpoint-${EnvironmentSuffix}"}
      }
    },
    "SecondaryAuroraReadEndpoint": {
      "Description": "Secondary Aurora cluster read endpoint",
      "Value": {"Fn::GetAtt": ["SecondaryAuroraDBCluster", "ReadEndpoint.Address"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-secondary-read-endpoint-${EnvironmentSuffix}"}
      }
    },
    "SecondaryLambdaArn": {
      "Description": "ARN of secondary Lambda function",
      "Value": {"Fn::GetAtt": ["PaymentProcessorFunction", "Arn"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-secondary-lambda-${EnvironmentSuffix}"}
      }
    },
    "SNSTopicArn": {
      "Description": "SNS Topic ARN for failover notifications in secondary region",
      "Value": {"Ref": "SecondaryFailoverNotificationTopic"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-sns-topic-secondary-${EnvironmentSuffix}"}
      }
    }
  }
}

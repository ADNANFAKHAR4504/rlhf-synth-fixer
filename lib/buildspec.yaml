version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo Installing dependencies...
      - pip install -r requirements.txt
      - curl -fsSL https://get.pulumi.com | sh
      - export PATH=$PATH:$HOME/.pulumi/bin

  pre_build:
    commands:
      - echo Logging in to Pulumi...
      - pulumi login
      - echo Running security and compliance tests...
      - python -m pytest tests/ -v
      - echo Validating Pulumi configuration...
      - pulumi config
      - pulumi preview --diff

  build:
    commands:
      - echo Deploying infrastructure...
      - pulumi up --yes --skip-preview
      - echo Running post-deployment validation...
      - python tests/test_infrastructure.py

  post_build:
    commands:
      - echo Deployment completed successfully
      - pulumi stack output --json > infrastructure-outputs.json
      - echo Infrastructure outputs saved

artifacts:
  files:
    - infrastructure-outputs.json
    - '**/*'
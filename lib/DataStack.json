{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Data nested stack with RDS Aurora MySQL and conditional ElastiCache Redis",
  "Mappings": {
    "PortConfig": {
      "MySQL": {
        "Port": "3306"
      },
      "Redis": {
        "Port": "6379"
      }
    }
  },
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource names"
    },
    "VpcId": {
      "Type": "String",
      "Description": "VPC ID from VPC stack"
    },
    "PrivateSubnet1": {
      "Type": "String",
      "Description": "Private subnet 1 ID"
    },
    "PrivateSubnet2": {
      "Type": "String",
      "Description": "Private subnet 2 ID"
    },
    "PrivateSubnet3": {
      "Type": "String",
      "Description": "Private subnet 3 ID"
    },
    "DBMasterUsername": {
      "Type": "String",
      "Description": "Master username for RDS"
    },
    "DBMasterPassword": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Master password for RDS"
    },
    "EnableElastiCache": {
      "Type": "String",
      "Description": "Enable ElastiCache Redis"
    },
    "CostCenter": {
      "Type": "String",
      "Description": "Cost center identifier"
    }
  },
  "Conditions": {
    "CreateElastiCache": {
      "Fn::Equals": [
        {
          "Ref": "EnableElastiCache"
        },
        "true"
      ]
    }
  },
  "Resources": {
    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "db-sg-${EnvironmentSuffix}"
        },
        "GroupDescription": "Security group for RDS Aurora cluster",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": {
              "Fn::FindInMap": [
                "PortConfig",
                "MySQL",
                "Port"
              ]
            },
            "ToPort": {
              "Fn::FindInMap": [
                "PortConfig",
                "MySQL",
                "Port"
              ]
            },
            "CidrIp": "10.0.0.0/16"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "db-sg-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "CacheSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Condition": "CreateElastiCache",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "cache-sg-${EnvironmentSuffix}"
        },
        "GroupDescription": "Security group for ElastiCache Redis cluster",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": {
              "Fn::FindInMap": [
                "PortConfig",
                "Redis",
                "Port"
              ]
            },
            "ToPort": {
              "Fn::FindInMap": [
                "PortConfig",
                "Redis",
                "Port"
              ]
            },
            "CidrIp": "10.0.0.0/16"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "cache-sg-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {
          "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
        },
        "DBSubnetGroupDescription": "Subnet group for RDS Aurora cluster",
        "SubnetIds": [
          {
            "Ref": "PrivateSubnet1"
          },
          {
            "Ref": "PrivateSubnet2"
          },
          {
            "Ref": "PrivateSubnet3"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "CacheSubnetGroup": {
      "Type": "AWS::ElastiCache::SubnetGroup",
      "Condition": "CreateElastiCache",
      "Properties": {
        "CacheSubnetGroupName": {
          "Fn::Sub": "cache-subnet-group-${EnvironmentSuffix}"
        },
        "Description": "Subnet group for ElastiCache Redis cluster",
        "SubnetIds": [
          {
            "Ref": "PrivateSubnet1"
          },
          {
            "Ref": "PrivateSubnet2"
          },
          {
            "Ref": "PrivateSubnet3"
          }
        ]
      }
    },
    "AuroraCluster": {
      "Type": "AWS::RDS::DBCluster",
      "DeletionPolicy": "Snapshot",
      "UpdateReplacePolicy": "Snapshot",
      "Properties": {
        "DBClusterIdentifier": {
          "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
        },
        "Engine": "aurora-mysql",
        "EngineMode": "provisioned",
        "EngineVersion": "8.0.mysql_aurora.3.04.0",
        "MasterUsername": {
          "Ref": "DBMasterUsername"
        },
        "MasterUserPassword": {
          "Ref": "DBMasterPassword"
        },
        "DBSubnetGroupName": {
          "Ref": "DBSubnetGroup"
        },
        "VpcSecurityGroupIds": [
          {
            "Ref": "DBSecurityGroup"
          }
        ],
        "BackupRetentionPeriod": 1,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
        "StorageEncrypted": true,
        "EnableCloudwatchLogsExports": [
          "error",
          "general",
          "slowquery"
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-cluster-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "AuroraInstance1": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": {
          "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
        },
        "DBClusterIdentifier": {
          "Ref": "AuroraCluster"
        },
        "Engine": "aurora-mysql",
        "DBInstanceClass": "db.t3.medium",
        "PubliclyAccessible": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-instance-1-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "AuroraInstance2": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": {
          "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
        },
        "DBClusterIdentifier": {
          "Ref": "AuroraCluster"
        },
        "Engine": "aurora-mysql",
        "DBInstanceClass": "db.t3.medium",
        "PubliclyAccessible": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-instance-2-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    },
    "ElastiCacheReplicationGroup": {
      "Type": "AWS::ElastiCache::ReplicationGroup",
      "Condition": "CreateElastiCache",
      "DeletionPolicy": "Snapshot",
      "UpdateReplacePolicy": "Snapshot",
      "Properties": {
        "ReplicationGroupId": {
          "Fn::Sub": "redis-${EnvironmentSuffix}"
        },
        "ReplicationGroupDescription": "Redis cluster for caching",
        "Engine": "redis",
        "EngineVersion": "7.0",
        "CacheNodeType": "cache.t3.micro",
        "NumCacheClusters": 2,
        "AutomaticFailoverEnabled": true,
        "MultiAZEnabled": true,
        "CacheSubnetGroupName": {
          "Ref": "CacheSubnetGroup"
        },
        "SecurityGroupIds": [
          {
            "Ref": "CacheSecurityGroup"
          }
        ],
        "AtRestEncryptionEnabled": true,
        "TransitEncryptionEnabled": true,
        "SnapshotRetentionLimit": 1,
        "SnapshotWindow": "03:00-05:00",
        "PreferredMaintenanceWindow": "mon:05:00-mon:07:00",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "redis-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "DatabaseEndpoint": {
      "Description": "RDS Aurora cluster endpoint",
      "Value": {
        "Fn::GetAtt": [
          "AuroraCluster",
          "Endpoint.Address"
        ]
      }
    },
    "DatabasePort": {
      "Description": "RDS Aurora cluster port",
      "Value": {
        "Fn::GetAtt": [
          "AuroraCluster",
          "Endpoint.Port"
        ]
      }
    },
    "CacheEndpoint": {
      "Description": "ElastiCache Redis primary endpoint",
      "Condition": "CreateElastiCache",
      "Value": {
        "Fn::GetAtt": [
          "ElastiCacheReplicationGroup",
          "PrimaryEndPoint.Address"
        ]
      }
    },
    "CachePort": {
      "Description": "ElastiCache Redis port",
      "Condition": "CreateElastiCache",
      "Value": {
        "Fn::GetAtt": [
          "ElastiCacheReplicationGroup",
          "PrimaryEndPoint.Port"
        ]
      }
    },
    "DBSecurityGroupId": {
      "Description": "Database Security Group ID",
      "Value": {
        "Ref": "DBSecurityGroup"
      }
    }
  }
}
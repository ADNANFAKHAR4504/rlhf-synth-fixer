{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Multi-Region DR Infrastructure - Primary Region (us-east-1) with Aurora Global Database, Lambda, Route 53, and Monitoring",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "AllowedPattern": "^[a-z0-9-]+$",
      "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
    },
    "NotificationEmail": {
      "Type": "String",
      "Default": "devops@example.com",
      "Description": "Email address for SNS failover notifications",
      "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
      "ConstraintDescription": "Must be a valid email address"
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-vpc-${EnvironmentSuffix}"}
          },
          {
            "Key": "Environment",
            "Value": "production"
          }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-1-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-2-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.0.3.0/24",
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-private-3-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {"Fn::Sub": "payment-dr-db-subnet-${EnvironmentSuffix}"},
        "DBSubnetGroupDescription": "Subnet group for Aurora Global Database primary cluster",
        "SubnetIds": [
          {"Ref": "PrivateSubnet1"},
          {"Ref": "PrivateSubnet2"},
          {"Ref": "PrivateSubnet3"}
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-db-subnet-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DatabaseSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "payment-dr-db-sg-${EnvironmentSuffix}"},
        "GroupDescription": "Security group for Aurora database - allows access from Lambda only",
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-db-sg-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {"Fn::Sub": "payment-dr-lambda-sg-${EnvironmentSuffix}"},
        "GroupDescription": "Security group for Lambda functions",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-lambda-sg-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DatabaseSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "DatabaseSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "SourceSecurityGroupId": {"Ref": "LambdaSecurityGroup"}
      }
    },
    "LambdaSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {"Ref": "LambdaSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "DestinationSecurityGroupId": {"Ref": "DatabaseSecurityGroup"}
      }
    },
    "AuroraDBCluster": {
      "Type": "AWS::RDS::DBCluster",
      "DeletionPolicy": "Delete",
      "DependsOn": "GlobalCluster",
      "Properties": {
        "Engine": "aurora-mysql",
        "EngineVersion": "8.0.mysql_aurora.3.04.0",
        "DBClusterIdentifier": {"Fn::Sub": "payment-dr-cluster-${EnvironmentSuffix}"},
        "MasterUsername": {
          "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
        },
        "MasterUserPassword": {
          "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
        },
        "DBSubnetGroupName": {"Ref": "DBSubnetGroup"},
        "VpcSecurityGroupIds": [{"Ref": "DatabaseSecurityGroup"}],
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
        "StorageEncrypted": true,
        "EnableCloudwatchLogsExports": ["error", "general", "slowquery"],
        "DeletionProtection": false,
        "GlobalClusterIdentifier": {"Fn::Sub": "payment-dr-global-${EnvironmentSuffix}"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-cluster-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "AuroraDBInstance1": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "aurora-mysql",
        "DBClusterIdentifier": {"Ref": "AuroraDBCluster"},
        "DBInstanceIdentifier": {"Fn::Sub": "payment-dr-instance-1-${EnvironmentSuffix}"},
        "DBInstanceClass": "db.r5.large",
        "PubliclyAccessible": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-instance-1-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "AuroraDBInstance2": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "aurora-mysql",
        "DBClusterIdentifier": {"Ref": "AuroraDBCluster"},
        "DBInstanceIdentifier": {"Fn::Sub": "payment-dr-instance-2-${EnvironmentSuffix}"},
        "DBInstanceClass": "db.r5.large",
        "PubliclyAccessible": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-instance-2-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "DatabaseSecret": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": {
          "Fn::Sub": "payment-dr-db-secret-${EnvironmentSuffix}"
        },
        "Description": "RDS Aurora master credentials for payment DR solution",
        "GenerateSecretString": {
          "SecretStringTemplate": "{\"username\":\"admin\"}",
          "GenerateStringKey": "password",
          "PasswordLength": 32,
          "ExcludeCharacters": "\"@/\\'"
        }
      }
    },
    "GlobalCluster": {
      "Type": "AWS::RDS::GlobalCluster",
      "Properties": {
        "GlobalClusterIdentifier": {"Fn::Sub": "payment-dr-global-${EnvironmentSuffix}"},
        "Engine": "aurora-mysql",
        "EngineVersion": "8.0.mysql_aurora.3.04.0",
        "DeletionProtection": false,
        "StorageEncrypted": true
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {"Fn::Sub": "payment-dr-lambda-role-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "RDSDataAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "rds-data:ExecuteStatement",
                    "rds-data:BatchExecuteStatement"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:payment-dr-cluster-${EnvironmentSuffix}"}
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:payment-dr-*"}
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {"Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/payment-processor-*"}
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-lambda-role-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PaymentProcessorFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {"Fn::Sub": "payment-processor-primary-${EnvironmentSuffix}"},
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Role": {"Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
        "MemorySize": 1024,
        "Timeout": 30,
        "VpcConfig": {
          "SecurityGroupIds": [{"Ref": "LambdaSecurityGroup"}],
          "SubnetIds": [
            {"Ref": "PrivateSubnet1"},
            {"Ref": "PrivateSubnet2"},
            {"Ref": "PrivateSubnet3"}
          ]
        },
        "Environment": {
          "Variables": {
            "DB_CLUSTER_ENDPOINT": {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]},
            "DB_NAME": "payments",
            "REGION": "us-east-1"
          }
        },
        "Code": {
          "ZipFile": "import json\nimport os\nimport pymysql\nimport logging\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Payment processing Lambda function.\n    Processes payment transactions and stores them in Aurora database.\n    \"\"\"\n    try:\n        # Extract payment data from event\n        payment_id = event.get('payment_id', 'unknown')\n        amount = event.get('amount', 0)\n        currency = event.get('currency', 'USD')\n        \n        logger.info(f\"Processing payment {payment_id} for {amount} {currency}\")\n        \n        # Database connection parameters\n        db_endpoint = os.environ.get('DB_CLUSTER_ENDPOINT')\n        db_name = os.environ.get('DB_NAME', 'payments')\n        region = os.environ.get('REGION', 'us-east-1')\n        \n        # Process payment logic here\n        # In production, this would connect to Aurora and store transaction\n        \n        response = {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Payment processed successfully',\n                'payment_id': payment_id,\n                'region': region,\n                'amount': amount,\n                'currency': currency\n            })\n        }\n        \n        logger.info(f\"Payment {payment_id} processed successfully in {region}\")\n        return response\n        \n    except Exception as e:\n        logger.error(f\"Error processing payment: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'message': 'Error processing payment',\n                'error': str(e)\n            })\n        }\n"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-processor-primary-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PaymentProcessorLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {"Fn::Sub": "/aws/lambda/payment-processor-primary-${EnvironmentSuffix}"},
        "RetentionInDays": 30
      }
    },
    "ReplicationLagAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-replication-lag-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when Aurora Global Database replication lag exceeds 1 second",
        "MetricName": "AuroraGlobalDBReplicationLag",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": {"Ref": "AuroraDBCluster"}
          }
        ],
        "AlarmActions": [{"Ref": "FailoverNotificationTopic"}],
        "TreatMissingData": "notBreaching"
      }
    },
    "DatabaseCPUAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-db-cpu-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when database CPU exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": {"Ref": "AuroraDBCluster"}
          }
        ],
        "AlarmActions": [{"Ref": "FailoverNotificationTopic"}]
      }
    },
    "LambdaErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-lambda-errors-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when Lambda function errors exceed threshold",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {"Ref": "PaymentProcessorFunction"}
          }
        ],
        "AlarmActions": [{"Ref": "FailoverNotificationTopic"}]
      }
    },
    "LambdaThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-lambda-throttles-${EnvironmentSuffix}"},
        "AlarmDescription": "Triggers when Lambda function is throttled",
        "MetricName": "Throttles",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {"Ref": "PaymentProcessorFunction"}
          }
        ],
        "AlarmActions": [{"Ref": "FailoverNotificationTopic"}]
      }
    },
    "FailoverNotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {"Fn::Sub": "payment-dr-failover-${EnvironmentSuffix}"},
        "DisplayName": "Payment DR Failover Notifications",
        "KmsMasterKeyId": "alias/aws/sns",
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-failover-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "FailoverNotificationSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Protocol": "email",
        "TopicArn": {"Ref": "FailoverNotificationTopic"},
        "Endpoint": {"Ref": "NotificationEmail"}
      }
    },
    "Route53HostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "Properties": {
        "Name": {"Fn::Sub": "payment-dr-${EnvironmentSuffix}.test-domain.internal"},
        "HostedZoneConfig": {
          "Comment": "Hosted zone for payment DR infrastructure with failover routing"
        },
        "HostedZoneTags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-zone-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrimaryHealthAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "payment-dr-primary-health-${EnvironmentSuffix}"},
        "AlarmDescription": "Health check for primary region",
        "MetricName": "Invocations",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1,
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {"Ref": "PaymentProcessorFunction"}
          }
        ],
        "TreatMissingData": "breaching"
      }
    },
    "PrimaryHealthCheck": {
      "Type": "AWS::Route53::HealthCheck",
      "DependsOn": "PrimaryHealthAlarm",
      "Properties": {
        "HealthCheckConfig": {
          "Type": "CLOUDWATCH_METRIC",
          "AlarmIdentifier": {
            "Region": "us-east-1",
            "Name": {"Fn::Sub": "payment-dr-primary-health-${EnvironmentSuffix}"}
          },
          "InsufficientDataHealthStatus": "Unhealthy"
        },
        "HealthCheckTags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "payment-dr-primary-health-${EnvironmentSuffix}"}
          }
        ]
      }
    },
    "PrimaryDNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {"Ref": "Route53HostedZone"},
        "Name": {"Fn::Sub": "api.payment-dr-${EnvironmentSuffix}.test-domain.internal"},
        "Type": "CNAME",
        "SetIdentifier": "Primary",
        "Failover": "PRIMARY",
        "TTL": 60,
        "ResourceRecords": [
          {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]}
        ],
        "HealthCheckId": {"Ref": "PrimaryHealthCheck"}
      }
    }
  },
  "Outputs": {
    "VPCId": {
      "Description": "VPC ID for primary region",
      "Value": {"Ref": "VPC"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-vpc-${EnvironmentSuffix}"}
      }
    },
    "PrimaryAuroraEndpoint": {
      "Description": "Primary Aurora cluster endpoint",
      "Value": {"Fn::GetAtt": ["AuroraDBCluster", "Endpoint.Address"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-primary-endpoint-${EnvironmentSuffix}"}
      }
    },
    "PrimaryAuroraReadEndpoint": {
      "Description": "Primary Aurora cluster read endpoint",
      "Value": {"Fn::GetAtt": ["AuroraDBCluster", "ReadEndpoint.Address"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-primary-read-endpoint-${EnvironmentSuffix}"}
      }
    },
    "PrimaryLambdaArn": {
      "Description": "ARN of primary Lambda function",
      "Value": {"Fn::GetAtt": ["PaymentProcessorFunction", "Arn"]},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-primary-lambda-${EnvironmentSuffix}"}
      }
    },
    "GlobalClusterId": {
      "Description": "Aurora Global Cluster Identifier",
      "Value": {"Ref": "GlobalCluster"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-global-cluster-${EnvironmentSuffix}"}
      }
    },
    "HostedZoneId": {
      "Description": "Route 53 Hosted Zone ID",
      "Value": {"Ref": "Route53HostedZone"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-hosted-zone-${EnvironmentSuffix}"}
      }
    },
    "SNSTopicArn": {
      "Description": "SNS Topic ARN for failover notifications",
      "Value": {"Ref": "FailoverNotificationTopic"},
      "Export": {
        "Name": {"Fn::Sub": "payment-dr-sns-topic-${EnvironmentSuffix}"}
      }
    }
  }
}

'use strict';
var __createBinding =
  (this && this.__createBinding) ||
  (Object.create
    ? function (o, m, k, k2) {
        if (k2 === undefined) k2 = k;
        var desc = Object.getOwnPropertyDescriptor(m, k);
        if (
          !desc ||
          ('get' in desc ? !m.__esModule : desc.writable || desc.configurable)
        ) {
          desc = {
            enumerable: true,
            get: function () {
              return m[k];
            },
          };
        }
        Object.defineProperty(o, k2, desc);
      }
    : function (o, m, k, k2) {
        if (k2 === undefined) k2 = k;
        o[k2] = m[k];
      });
var __setModuleDefault =
  (this && this.__setModuleDefault) ||
  (Object.create
    ? function (o, v) {
        Object.defineProperty(o, 'default', { enumerable: true, value: v });
      }
    : function (o, v) {
        o['default'] = v;
      });
var __importStar =
  (this && this.__importStar) ||
  (function () {
    var ownKeys = function (o) {
      ownKeys =
        Object.getOwnPropertyNames ||
        function (o) {
          var ar = [];
          for (var k in o)
            if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
          return ar;
        };
      return ownKeys(o);
    };
    return function (mod) {
      if (mod && mod.__esModule) return mod;
      var result = {};
      if (mod != null)
        for (var k = ownKeys(mod), i = 0; i < k.length; i++)
          if (k[i] !== 'default') __createBinding(result, mod, k[i]);
      __setModuleDefault(result, mod);
      return result;
    };
  })();
Object.defineProperty(exports, '__esModule', { value: true });
exports.VpcConstruct = void 0;
const constructs_1 = require('constructs');
const ec2 = __importStar(require('aws-cdk-lib/aws-ec2'));
const cdk = __importStar(require('aws-cdk-lib'));
/**
 * VPC Construct that creates a highly available network infrastructure
 * with public and private subnets across multiple Availability Zones
 */
class VpcConstruct extends constructs_1.Construct {
  vpc;
  publicSubnets;
  privateSubnets;
  constructor(scope, id, config) {
    super(scope, id);
    // Create VPC with public and private subnets across multiple AZs
    this.vpc = new ec2.Vpc(this, 'MultiRegionVpc', {
      ipAddresses: ec2.IpAddresses.cidr(config.vpcCidr),
      maxAzs: 3, // Use 3 AZs for high availability
      enableDnsHostnames: true,
      enableDnsSupport: true,
      // Define subnet configuration for network segregation
      subnetConfiguration: [
        {
          cidrMask: 24,
          name: 'PublicSubnet',
          subnetType: ec2.SubnetType.PUBLIC,
          mapPublicIpOnLaunch: true,
        },
        {
          cidrMask: 24,
          name: 'PrivateSubnet',
          subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS,
        },
        {
          cidrMask: 28,
          name: 'DatabaseSubnet',
          subnetType: ec2.SubnetType.PRIVATE_ISOLATED,
        },
      ],
      // Configure NAT Gateway for private subnet internet access
      natGateways: 2, // Deploy NAT gateways in 2 AZs for redundancy
      natGatewayProvider: ec2.NatProvider.gateway(),
    });
    // Store subnet references for use by other constructs
    this.publicSubnets = this.vpc.publicSubnets;
    this.privateSubnets = this.vpc.privateSubnets;
    // Create VPC Flow Logs for network monitoring and security
    if (config.security.enableVpcFlowLogs) {
      new ec2.FlowLog(this, 'VpcFlowLog', {
        resourceType: ec2.FlowLogResourceType.fromVpc(this.vpc),
        destination: ec2.FlowLogDestination.toCloudWatchLogs(),
        trafficType: ec2.FlowLogTrafficType.ALL,
      });
    }
    // Apply tags to VPC and all subnets
    cdk.Tags.of(this.vpc).add('Name', `MultiRegionApp-VPC-${config.region}`);
    Object.entries(config.tags).forEach(([key, value]) => {
      cdk.Tags.of(this.vpc).add(key, value);
    });
    // Tag subnets for better identification
    this.publicSubnets.forEach((subnet, index) => {
      cdk.Tags.of(subnet).add(
        'Name',
        `PublicSubnet-${index + 1}-${config.region}`
      );
      cdk.Tags.of(subnet).add('SubnetType', 'Public');
    });
    this.privateSubnets.forEach((subnet, index) => {
      cdk.Tags.of(subnet).add(
        'Name',
        `PrivateSubnet-${index + 1}-${config.region}`
      );
      cdk.Tags.of(subnet).add('SubnetType', 'Private');
    });
    // Create Network ACLs for additional subnet-level security (least privilege principle)
    this.createNetworkAcls(config);
  }
  /**
   * Create Network ACLs for public and private subnets with least privilege access
   */
  createNetworkAcls(config) {
    // Public subnet NACL - allows HTTP/HTTPS from internet and ephemeral ports for responses
    const publicNacl = new ec2.NetworkAcl(this, 'PublicNacl', {
      vpc: this.vpc,
      subnetSelection: { subnetType: ec2.SubnetType.PUBLIC },
    });
    // Inbound rules for public subnets
    publicNacl.addEntry('AllowHTTPInbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 100,
      traffic: ec2.AclTraffic.tcpPort(80),
      direction: ec2.TrafficDirection.INGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    publicNacl.addEntry('AllowHTTPSInbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 110,
      traffic: ec2.AclTraffic.tcpPort(443),
      direction: ec2.TrafficDirection.INGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    publicNacl.addEntry('AllowEphemeralInbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 120,
      traffic: ec2.AclTraffic.tcpPortRange(1024, 65535),
      direction: ec2.TrafficDirection.INGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    // Outbound rules for public subnets
    publicNacl.addEntry('AllowAllOutbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 100,
      traffic: ec2.AclTraffic.allTraffic(),
      direction: ec2.TrafficDirection.EGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    // Private subnet NACL - more restrictive, only allows necessary traffic
    const privateNacl = new ec2.NetworkAcl(this, 'PrivateNacl', {
      vpc: this.vpc,
      subnetSelection: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },
    });
    // Inbound rules for private subnets - only from VPC and ephemeral ports
    privateNacl.addEntry('AllowVPCInbound', {
      cidr: ec2.AclCidr.ipv4(config.vpcCidr),
      ruleNumber: 100,
      traffic: ec2.AclTraffic.allTraffic(),
      direction: ec2.TrafficDirection.INGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    privateNacl.addEntry('AllowEphemeralInbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 110,
      traffic: ec2.AclTraffic.tcpPortRange(1024, 65535),
      direction: ec2.TrafficDirection.INGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    // Outbound rules for private subnets
    privateNacl.addEntry('AllowVPCOutbound', {
      cidr: ec2.AclCidr.ipv4(config.vpcCidr),
      ruleNumber: 100,
      traffic: ec2.AclTraffic.allTraffic(),
      direction: ec2.TrafficDirection.EGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    privateNacl.addEntry('AllowHTTPSOutbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 110,
      traffic: ec2.AclTraffic.tcpPort(443),
      direction: ec2.TrafficDirection.EGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    privateNacl.addEntry('AllowHTTPOutbound', {
      cidr: ec2.AclCidr.anyIpv4(),
      ruleNumber: 120,
      traffic: ec2.AclTraffic.tcpPort(80),
      direction: ec2.TrafficDirection.EGRESS,
      ruleAction: ec2.Action.ALLOW,
    });
    // Apply tags to NACLs
    cdk.Tags.of(publicNacl).add(
      'Name',
      `MultiRegionApp-Public-NACL-${config.region}`
    );
    cdk.Tags.of(privateNacl).add(
      'Name',
      `MultiRegionApp-Private-NACL-${config.region}`
    );
    Object.entries(config.tags).forEach(([key, value]) => {
      cdk.Tags.of(publicNacl).add(key, value);
      cdk.Tags.of(privateNacl).add(key, value);
    });
  }
}
exports.VpcConstruct = VpcConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLWNvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZwYy1jb25zdHJ1Y3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLHlEQUEyQztBQUMzQyxpREFBbUM7QUFHbkM7OztHQUdHO0FBQ0gsTUFBYSxZQUFhLFNBQVEsc0JBQVM7SUFDekIsR0FBRyxDQUFVO0lBQ2IsYUFBYSxDQUFnQjtJQUM3QixjQUFjLENBQWdCO0lBRTlDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsTUFBbUI7UUFDM0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixpRUFBaUU7UUFDakUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQzdDLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ2pELE1BQU0sRUFBRSxDQUFDLEVBQUUsa0NBQWtDO1lBQzdDLGtCQUFrQixFQUFFLElBQUk7WUFDeEIsZ0JBQWdCLEVBQUUsSUFBSTtZQUV0QixzREFBc0Q7WUFDdEQsbUJBQW1CLEVBQUU7Z0JBQ25CO29CQUNFLFFBQVEsRUFBRSxFQUFFO29CQUNaLElBQUksRUFBRSxjQUFjO29CQUNwQixVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNO29CQUNqQyxtQkFBbUIsRUFBRSxJQUFJO2lCQUMxQjtnQkFDRDtvQkFDRSxRQUFRLEVBQUUsRUFBRTtvQkFDWixJQUFJLEVBQUUsZUFBZTtvQkFDckIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsbUJBQW1CO2lCQUMvQztnQkFDRDtvQkFDRSxRQUFRLEVBQUUsRUFBRTtvQkFDWixJQUFJLEVBQUUsZ0JBQWdCO29CQUN0QixVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0I7aUJBQzVDO2FBQ0Y7WUFFRCwyREFBMkQ7WUFDM0QsV0FBVyxFQUFFLENBQUMsRUFBRSw4Q0FBOEM7WUFDOUQsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUU7U0FDOUMsQ0FBQyxDQUFDO1FBRUgsc0RBQXNEO1FBQ3RELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7UUFDNUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztRQUU5QywyREFBMkQ7UUFDM0QsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDdEMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQ2xDLFlBQVksRUFBRSxHQUFHLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7Z0JBQ3ZELFdBQVcsRUFBRSxHQUFHLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ3RELFdBQVcsRUFBRSxHQUFHLENBQUMsa0JBQWtCLENBQUMsR0FBRzthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsb0NBQW9DO1FBQ3BDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLHNCQUFzQixNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUN6RSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ25ELEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsd0NBQXdDO1FBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzNDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FDckIsTUFBTSxFQUNOLGdCQUFnQixLQUFLLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FDN0MsQ0FBQztZQUNGLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUM1QyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQ3JCLE1BQU0sRUFDTixpQkFBaUIsS0FBSyxHQUFHLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQzlDLENBQUM7WUFDRixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO1FBRUgsdUZBQXVGO1FBQ3ZGLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxpQkFBaUIsQ0FBQyxNQUFtQjtRQUMzQyx5RkFBeUY7UUFDekYsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7WUFDeEQsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO1lBQ2IsZUFBZSxFQUFFLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1NBQ3ZELENBQUMsQ0FBQztRQUVILG1DQUFtQztRQUNuQyxVQUFVLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFO1lBQ3RDLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUMzQixVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDbkMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPO1lBQ3ZDLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsVUFBVSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRTtZQUN2QyxJQUFJLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7WUFDM0IsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ3BDLFNBQVMsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTztZQUN2QyxVQUFVLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1NBQzdCLENBQUMsQ0FBQztRQUVILFVBQVUsQ0FBQyxRQUFRLENBQUMsdUJBQXVCLEVBQUU7WUFDM0MsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQzNCLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7WUFDakQsU0FBUyxFQUFFLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPO1lBQ3ZDLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsb0NBQW9DO1FBQ3BDLFVBQVUsQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEVBQUU7WUFDdEMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQzNCLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFO1lBQ3BDLFNBQVMsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtZQUN0QyxVQUFVLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1NBQzdCLENBQUMsQ0FBQztRQUVILHdFQUF3RTtRQUN4RSxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUMxRCxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUc7WUFDYixlQUFlLEVBQUUsRUFBRSxVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsRUFBRTtTQUNwRSxDQUFDLENBQUM7UUFFSCx3RUFBd0U7UUFDeEUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRTtZQUN0QyxJQUFJLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQztZQUN0QyxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRTtZQUNwQyxTQUFTLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE9BQU87WUFDdkMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztTQUM3QixDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsUUFBUSxDQUFDLHVCQUF1QixFQUFFO1lBQzVDLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUMzQixVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDO1lBQ2pELFNBQVMsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTztZQUN2QyxVQUFVLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1NBQzdCLENBQUMsQ0FBQztRQUVILHFDQUFxQztRQUNyQyxXQUFXLENBQUMsUUFBUSxDQUFDLGtCQUFrQixFQUFFO1lBQ3ZDLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ3RDLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFO1lBQ3BDLFNBQVMsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtZQUN0QyxVQUFVLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1NBQzdCLENBQUMsQ0FBQztRQUVILFdBQVcsQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7WUFDekMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO1lBQzNCLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUNwQyxTQUFTLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU07WUFDdEMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztTQUM3QixDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFO1lBQ3hDLElBQUksRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUMzQixVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDbkMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNO1lBQ3RDLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsc0JBQXNCO1FBQ3RCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FDekIsTUFBTSxFQUNOLDhCQUE4QixNQUFNLENBQUMsTUFBTSxFQUFFLENBQzlDLENBQUM7UUFDRixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQzFCLE1BQU0sRUFDTiwrQkFBK0IsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUMvQyxDQUFDO1FBRUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUNuRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUEzTEQsb0NBMkxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgU3RhY2tDb25maWcgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0YWNrLWNvbmZpZyc7XG5cbi8qKlxuICogVlBDIENvbnN0cnVjdCB0aGF0IGNyZWF0ZXMgYSBoaWdobHkgYXZhaWxhYmxlIG5ldHdvcmsgaW5mcmFzdHJ1Y3R1cmVcbiAqIHdpdGggcHVibGljIGFuZCBwcml2YXRlIHN1Ym5ldHMgYWNyb3NzIG11bHRpcGxlIEF2YWlsYWJpbGl0eSBab25lc1xuICovXG5leHBvcnQgY2xhc3MgVnBjQ29uc3RydWN0IGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHZwYzogZWMyLlZwYztcbiAgcHVibGljIHJlYWRvbmx5IHB1YmxpY1N1Ym5ldHM6IGVjMi5JU3VibmV0W107XG4gIHB1YmxpYyByZWFkb25seSBwcml2YXRlU3VibmV0czogZWMyLklTdWJuZXRbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBjb25maWc6IFN0YWNrQ29uZmlnKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIENyZWF0ZSBWUEMgd2l0aCBwdWJsaWMgYW5kIHByaXZhdGUgc3VibmV0cyBhY3Jvc3MgbXVsdGlwbGUgQVpzXG4gICAgdGhpcy52cGMgPSBuZXcgZWMyLlZwYyh0aGlzLCAnTXVsdGlSZWdpb25WcGMnLCB7XG4gICAgICBpcEFkZHJlc3NlczogZWMyLklwQWRkcmVzc2VzLmNpZHIoY29uZmlnLnZwY0NpZHIpLFxuICAgICAgbWF4QXpzOiAzLCAvLyBVc2UgMyBBWnMgZm9yIGhpZ2ggYXZhaWxhYmlsaXR5XG4gICAgICBlbmFibGVEbnNIb3N0bmFtZXM6IHRydWUsXG4gICAgICBlbmFibGVEbnNTdXBwb3J0OiB0cnVlLFxuXG4gICAgICAvLyBEZWZpbmUgc3VibmV0IGNvbmZpZ3VyYXRpb24gZm9yIG5ldHdvcmsgc2VncmVnYXRpb25cbiAgICAgIHN1Ym5ldENvbmZpZ3VyYXRpb246IFtcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyNCxcbiAgICAgICAgICBuYW1lOiAnUHVibGljU3VibmV0JyxcbiAgICAgICAgICBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QVUJMSUMsXG4gICAgICAgICAgbWFwUHVibGljSXBPbkxhdW5jaDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyNCxcbiAgICAgICAgICBuYW1lOiAnUHJpdmF0ZVN1Ym5ldCcsXG4gICAgICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX0VHUkVTUyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGNpZHJNYXNrOiAyOCxcbiAgICAgICAgICBuYW1lOiAnRGF0YWJhc2VTdWJuZXQnLFxuICAgICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfSVNPTEFURUQsXG4gICAgICAgIH0sXG4gICAgICBdLFxuXG4gICAgICAvLyBDb25maWd1cmUgTkFUIEdhdGV3YXkgZm9yIHByaXZhdGUgc3VibmV0IGludGVybmV0IGFjY2Vzc1xuICAgICAgbmF0R2F0ZXdheXM6IDIsIC8vIERlcGxveSBOQVQgZ2F0ZXdheXMgaW4gMiBBWnMgZm9yIHJlZHVuZGFuY3lcbiAgICAgIG5hdEdhdGV3YXlQcm92aWRlcjogZWMyLk5hdFByb3ZpZGVyLmdhdGV3YXkoKSxcbiAgICB9KTtcblxuICAgIC8vIFN0b3JlIHN1Ym5ldCByZWZlcmVuY2VzIGZvciB1c2UgYnkgb3RoZXIgY29uc3RydWN0c1xuICAgIHRoaXMucHVibGljU3VibmV0cyA9IHRoaXMudnBjLnB1YmxpY1N1Ym5ldHM7XG4gICAgdGhpcy5wcml2YXRlU3VibmV0cyA9IHRoaXMudnBjLnByaXZhdGVTdWJuZXRzO1xuXG4gICAgLy8gQ3JlYXRlIFZQQyBGbG93IExvZ3MgZm9yIG5ldHdvcmsgbW9uaXRvcmluZyBhbmQgc2VjdXJpdHlcbiAgICBpZiAoY29uZmlnLnNlY3VyaXR5LmVuYWJsZVZwY0Zsb3dMb2dzKSB7XG4gICAgICBuZXcgZWMyLkZsb3dMb2codGhpcywgJ1ZwY0Zsb3dMb2cnLCB7XG4gICAgICAgIHJlc291cmNlVHlwZTogZWMyLkZsb3dMb2dSZXNvdXJjZVR5cGUuZnJvbVZwYyh0aGlzLnZwYyksXG4gICAgICAgIGRlc3RpbmF0aW9uOiBlYzIuRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvQ2xvdWRXYXRjaExvZ3MoKSxcbiAgICAgICAgdHJhZmZpY1R5cGU6IGVjMi5GbG93TG9nVHJhZmZpY1R5cGUuQUxMLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgdGFncyB0byBWUEMgYW5kIGFsbCBzdWJuZXRzXG4gICAgY2RrLlRhZ3Mub2YodGhpcy52cGMpLmFkZCgnTmFtZScsIGBNdWx0aVJlZ2lvbkFwcC1WUEMtJHtjb25maWcucmVnaW9ufWApO1xuICAgIE9iamVjdC5lbnRyaWVzKGNvbmZpZy50YWdzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGNkay5UYWdzLm9mKHRoaXMudnBjKS5hZGQoa2V5LCB2YWx1ZSk7XG4gICAgfSk7XG5cbiAgICAvLyBUYWcgc3VibmV0cyBmb3IgYmV0dGVyIGlkZW50aWZpY2F0aW9uXG4gICAgdGhpcy5wdWJsaWNTdWJuZXRzLmZvckVhY2goKHN1Ym5ldCwgaW5kZXgpID0+IHtcbiAgICAgIGNkay5UYWdzLm9mKHN1Ym5ldCkuYWRkKFxuICAgICAgICAnTmFtZScsXG4gICAgICAgIGBQdWJsaWNTdWJuZXQtJHtpbmRleCArIDF9LSR7Y29uZmlnLnJlZ2lvbn1gXG4gICAgICApO1xuICAgICAgY2RrLlRhZ3Mub2Yoc3VibmV0KS5hZGQoJ1N1Ym5ldFR5cGUnLCAnUHVibGljJyk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnByaXZhdGVTdWJuZXRzLmZvckVhY2goKHN1Ym5ldCwgaW5kZXgpID0+IHtcbiAgICAgIGNkay5UYWdzLm9mKHN1Ym5ldCkuYWRkKFxuICAgICAgICAnTmFtZScsXG4gICAgICAgIGBQcml2YXRlU3VibmV0LSR7aW5kZXggKyAxfS0ke2NvbmZpZy5yZWdpb259YFxuICAgICAgKTtcbiAgICAgIGNkay5UYWdzLm9mKHN1Ym5ldCkuYWRkKCdTdWJuZXRUeXBlJywgJ1ByaXZhdGUnKTtcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBOZXR3b3JrIEFDTHMgZm9yIGFkZGl0aW9uYWwgc3VibmV0LWxldmVsIHNlY3VyaXR5IChsZWFzdCBwcml2aWxlZ2UgcHJpbmNpcGxlKVxuICAgIHRoaXMuY3JlYXRlTmV0d29ya0FjbHMoY29uZmlnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgTmV0d29yayBBQ0xzIGZvciBwdWJsaWMgYW5kIHByaXZhdGUgc3VibmV0cyB3aXRoIGxlYXN0IHByaXZpbGVnZSBhY2Nlc3NcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTmV0d29ya0FjbHMoY29uZmlnOiBTdGFja0NvbmZpZyk6IHZvaWQge1xuICAgIC8vIFB1YmxpYyBzdWJuZXQgTkFDTCAtIGFsbG93cyBIVFRQL0hUVFBTIGZyb20gaW50ZXJuZXQgYW5kIGVwaGVtZXJhbCBwb3J0cyBmb3IgcmVzcG9uc2VzXG4gICAgY29uc3QgcHVibGljTmFjbCA9IG5ldyBlYzIuTmV0d29ya0FjbCh0aGlzLCAnUHVibGljTmFjbCcsIHtcbiAgICAgIHZwYzogdGhpcy52cGMsXG4gICAgICBzdWJuZXRTZWxlY3Rpb246IHsgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDIH0sXG4gICAgfSk7XG5cbiAgICAvLyBJbmJvdW5kIHJ1bGVzIGZvciBwdWJsaWMgc3VibmV0c1xuICAgIHB1YmxpY05hY2wuYWRkRW50cnkoJ0FsbG93SFRUUEluYm91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5hbnlJcHY0KCksXG4gICAgICBydWxlTnVtYmVyOiAxMDAsXG4gICAgICB0cmFmZmljOiBlYzIuQWNsVHJhZmZpYy50Y3BQb3J0KDgwKSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uSU5HUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICBwdWJsaWNOYWNsLmFkZEVudHJ5KCdBbGxvd0hUVFBTSW5ib3VuZCcsIHtcbiAgICAgIGNpZHI6IGVjMi5BY2xDaWRyLmFueUlwdjQoKSxcbiAgICAgIHJ1bGVOdW1iZXI6IDExMCxcbiAgICAgIHRyYWZmaWM6IGVjMi5BY2xUcmFmZmljLnRjcFBvcnQoNDQzKSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uSU5HUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICBwdWJsaWNOYWNsLmFkZEVudHJ5KCdBbGxvd0VwaGVtZXJhbEluYm91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5hbnlJcHY0KCksXG4gICAgICBydWxlTnVtYmVyOiAxMjAsXG4gICAgICB0cmFmZmljOiBlYzIuQWNsVHJhZmZpYy50Y3BQb3J0UmFuZ2UoMTAyNCwgNjU1MzUpLFxuICAgICAgZGlyZWN0aW9uOiBlYzIuVHJhZmZpY0RpcmVjdGlvbi5JTkdSRVNTLFxuICAgICAgcnVsZUFjdGlvbjogZWMyLkFjdGlvbi5BTExPVyxcbiAgICB9KTtcblxuICAgIC8vIE91dGJvdW5kIHJ1bGVzIGZvciBwdWJsaWMgc3VibmV0c1xuICAgIHB1YmxpY05hY2wuYWRkRW50cnkoJ0FsbG93QWxsT3V0Ym91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5hbnlJcHY0KCksXG4gICAgICBydWxlTnVtYmVyOiAxMDAsXG4gICAgICB0cmFmZmljOiBlYzIuQWNsVHJhZmZpYy5hbGxUcmFmZmljKCksXG4gICAgICBkaXJlY3Rpb246IGVjMi5UcmFmZmljRGlyZWN0aW9uLkVHUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICAvLyBQcml2YXRlIHN1Ym5ldCBOQUNMIC0gbW9yZSByZXN0cmljdGl2ZSwgb25seSBhbGxvd3MgbmVjZXNzYXJ5IHRyYWZmaWNcbiAgICBjb25zdCBwcml2YXRlTmFjbCA9IG5ldyBlYzIuTmV0d29ya0FjbCh0aGlzLCAnUHJpdmF0ZU5hY2wnLCB7XG4gICAgICB2cGM6IHRoaXMudnBjLFxuICAgICAgc3VibmV0U2VsZWN0aW9uOiB7IHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfV0lUSF9FR1JFU1MgfSxcbiAgICB9KTtcblxuICAgIC8vIEluYm91bmQgcnVsZXMgZm9yIHByaXZhdGUgc3VibmV0cyAtIG9ubHkgZnJvbSBWUEMgYW5kIGVwaGVtZXJhbCBwb3J0c1xuICAgIHByaXZhdGVOYWNsLmFkZEVudHJ5KCdBbGxvd1ZQQ0luYm91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5pcHY0KGNvbmZpZy52cGNDaWRyKSxcbiAgICAgIHJ1bGVOdW1iZXI6IDEwMCxcbiAgICAgIHRyYWZmaWM6IGVjMi5BY2xUcmFmZmljLmFsbFRyYWZmaWMoKSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uSU5HUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICBwcml2YXRlTmFjbC5hZGRFbnRyeSgnQWxsb3dFcGhlbWVyYWxJbmJvdW5kJywge1xuICAgICAgY2lkcjogZWMyLkFjbENpZHIuYW55SXB2NCgpLFxuICAgICAgcnVsZU51bWJlcjogMTEwLFxuICAgICAgdHJhZmZpYzogZWMyLkFjbFRyYWZmaWMudGNwUG9ydFJhbmdlKDEwMjQsIDY1NTM1KSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uSU5HUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICAvLyBPdXRib3VuZCBydWxlcyBmb3IgcHJpdmF0ZSBzdWJuZXRzXG4gICAgcHJpdmF0ZU5hY2wuYWRkRW50cnkoJ0FsbG93VlBDT3V0Ym91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5pcHY0KGNvbmZpZy52cGNDaWRyKSxcbiAgICAgIHJ1bGVOdW1iZXI6IDEwMCxcbiAgICAgIHRyYWZmaWM6IGVjMi5BY2xUcmFmZmljLmFsbFRyYWZmaWMoKSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uRUdSRVNTLFxuICAgICAgcnVsZUFjdGlvbjogZWMyLkFjdGlvbi5BTExPVyxcbiAgICB9KTtcblxuICAgIHByaXZhdGVOYWNsLmFkZEVudHJ5KCdBbGxvd0hUVFBTT3V0Ym91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5hbnlJcHY0KCksXG4gICAgICBydWxlTnVtYmVyOiAxMTAsXG4gICAgICB0cmFmZmljOiBlYzIuQWNsVHJhZmZpYy50Y3BQb3J0KDQ0MyksXG4gICAgICBkaXJlY3Rpb246IGVjMi5UcmFmZmljRGlyZWN0aW9uLkVHUkVTUyxcbiAgICAgIHJ1bGVBY3Rpb246IGVjMi5BY3Rpb24uQUxMT1csXG4gICAgfSk7XG5cbiAgICBwcml2YXRlTmFjbC5hZGRFbnRyeSgnQWxsb3dIVFRQT3V0Ym91bmQnLCB7XG4gICAgICBjaWRyOiBlYzIuQWNsQ2lkci5hbnlJcHY0KCksXG4gICAgICBydWxlTnVtYmVyOiAxMjAsXG4gICAgICB0cmFmZmljOiBlYzIuQWNsVHJhZmZpYy50Y3BQb3J0KDgwKSxcbiAgICAgIGRpcmVjdGlvbjogZWMyLlRyYWZmaWNEaXJlY3Rpb24uRUdSRVNTLFxuICAgICAgcnVsZUFjdGlvbjogZWMyLkFjdGlvbi5BTExPVyxcbiAgICB9KTtcblxuICAgIC8vIEFwcGx5IHRhZ3MgdG8gTkFDTHNcbiAgICBjZGsuVGFncy5vZihwdWJsaWNOYWNsKS5hZGQoXG4gICAgICAnTmFtZScsXG4gICAgICBgTXVsdGlSZWdpb25BcHAtUHVibGljLU5BQ0wtJHtjb25maWcucmVnaW9ufWBcbiAgICApO1xuICAgIGNkay5UYWdzLm9mKHByaXZhdGVOYWNsKS5hZGQoXG4gICAgICAnTmFtZScsXG4gICAgICBgTXVsdGlSZWdpb25BcHAtUHJpdmF0ZS1OQUNMLSR7Y29uZmlnLnJlZ2lvbn1gXG4gICAgKTtcblxuICAgIE9iamVjdC5lbnRyaWVzKGNvbmZpZy50YWdzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGNkay5UYWdzLm9mKHB1YmxpY05hY2wpLmFkZChrZXksIHZhbHVlKTtcbiAgICAgIGNkay5UYWdzLm9mKHByaXZhdGVOYWNsKS5hZGQoa2V5LCB2YWx1ZSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==

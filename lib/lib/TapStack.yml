AWSTemplateFormatVersion: '2010-09-09'
Description: >
  TapStack.yml — Secure and compliant production environment in us-east-1.
  Enforces least-privilege IAM roles, encrypted EC2 EBS volumes, S3 bucket SSE,
  IP-range–restricted access (default 192.168.0.0/16), CloudTrail->CloudWatch logging,
  production tagging, RDS in a predefined VPC, Lambda with >=128MB, and no public SSH.

Parameters:
  NamePrefix:
    Type: String
    Default: prod
    AllowedPattern: '^[a-z0-9-]+$'
    Description: Naming prefix (must follow prod-* convention; default "prod").
  AllowedIpCidr:
    Type: String
    Default: 192.168.0.0/16
    Description: IP range allowed to access resources (no public access).
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Predefined VPC ID where resources will be deployed.
  PrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Private subnet IDs for EC2 and RDS (in the predefined VPC).
  LambdaSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Private subnet IDs for Lambda (in the predefined VPC).
  EC2AmiId:
    Type: AWS::EC2::Image::Id
    Description: AMI ID for EC2 instance.
  EC2InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - m6i.large
      - m6i.xlarge
    Description: Instance type for EC2.
  TrailBucketName:
    Type: String
    Description: Globally unique S3 bucket name to store CloudTrail logs.
    AllowedPattern: '^[a-z0-9.-]{3,63}$'
  DBEngine:
    Type: String
    Default: postgres
    AllowedValues: [postgres, mysql]
  DBEngineVersion:
    Type: String
    Default: '15.5'
    Description: Engine version (e.g., Postgres 15.x or MySQL 8.x).
  DBInstanceClass:
    Type: String
    Default: db.t3.micro
  DBAllocatedStorage:
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 16384
  DBUsername:
    Type: String
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9_]+$'
    Description: Master username for the database.
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 41
    AllowedPattern: '^[ -~]+$'
    Description: Master user password for the database (min 8 chars).
  AppBucketName:
    Type: String
    Description: Globally unique S3 bucket name for application data (SSE required).
    AllowedPattern: '^[a-z0-9.-]{3,63}$'

Mappings:
  EngineFamily:
    postgres:
      Family: postgres15
      SslParamName: rds.force_ssl
      SslParamValue: '1'
    mysql:
      Family: mysql8.0
      SslParamName: require_secure_transport
      SslParamValue: 'ON'

Conditions:
  IsPostgres: !Equals [!Ref DBEngine, 'postgres']

Resources:

  #######################################
  # S3 — CloudTrail log bucket (SSE, BPA)
  #######################################
  TrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref TrailBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration: { Status: Enabled }
      Tags:
        - Key: Environment
          Value: Production

  TrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref TrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow CloudTrail to write logs
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - s3:PutObject
              - s3:GetBucketAcl
            Resource:
              - !Sub arn:aws:s3:::${TrailBucketName}
              - !Sub arn:aws:s3:::${TrailBucketName}/AWSLogs/${AWS::AccountId}/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
          # Optional IP restriction for direct access (administrative usage)
          - Sid: IpRestrictAdminAccess
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub arn:aws:s3:::${TrailBucketName}
              - !Sub arn:aws:s3:::${TrailBucketName}/*
            Condition:
              NotIpAddress:
                aws:SourceIp: !Ref AllowedIpCidr

  #######################################
  # S3 — Application bucket (SSE + IP restrict)
  #######################################
  AppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref AppBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration: { Status: Enabled }
      Tags:
        - Key: Environment
          Value: Production

  AppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AppBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceTls
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub arn:aws:s3:::${AppBucketName}
              - !Sub arn:aws:s3:::${AppBucketName}/*
            Condition:
              Bool:
                aws:SecureTransport: 'false'
          - Sid: IpRestrict
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub arn:aws:s3:::${AppBucketName}
              - !Sub arn:aws:s3:::${AppBucketName}/*
            Condition:
              NotIpAddress:
                aws:SourceIp: !Ref AllowedIpCidr

  #######################################
  # CloudWatch Logs + CloudTrail (API activity)
  #######################################
  TrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/cloudtrail/${NamePrefix}-api-activity
      RetentionInDays: 365
      Tags:
        - Key: Environment
          Value: Production

  CloudTrailToCWLRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${NamePrefix}-cloudtrail-to-cwl
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudTrailToCWL
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !GetAtt TrailLogGroup.Arn
      Tags:
        - Key: Environment
          Value: Production

  OrgCloudTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Sub ${NamePrefix}-api-activity
      S3BucketName: !Ref TrailBucketName
      IsLogging: true
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      CloudWatchLogsLogGroupArn: !GetAtt TrailLogGroup.Arn
      CloudWatchLogsRoleArn: !GetAtt CloudTrailToCWLRole.Arn
      Tags:
        - Key: Environment
          Value: Production

  #######################################
  # Security Groups (deny public SSH; restrict by CIDR)
  #######################################
  Ec2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${NamePrefix} EC2 SG — no public SSH'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIpCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: !Ref AllowedIpCidr
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-ec2-sg
        - Key: Environment
          Value: Production

  RdsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${NamePrefix} RDS SG — restricted client access'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !If [IsPostgres, !Ref AllowedIpCidr, '0.0.0.0/32']  # closed when MySQL, opened below
        - !If
          - IsPostgres
          - !Ref AWS::NoValue
          - { IpProtocol: tcp, FromPort: 3306, ToPort: 3306, CidrIp: !Ref AllowedIpCidr }
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: !Ref AllowedIpCidr
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-rds-sg
        - Key: Environment
          Value: Production

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${NamePrefix} Lambda SG — restricted egress'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: !Ref AllowedIpCidr
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-lambda-sg
        - Key: Environment
          Value: Production

  #######################################
  # EC2 Instance (encrypted EBS, private subnets only)
  #######################################
  Ec2Instance:
    Type: AWS::EC2::Instance
    Metadata:
      Comment: Encrypted root volume; no public IP; SSH allowed only from AllowedIpCidr via SG.
    Properties:
      ImageId: !Ref EC2AmiId
      InstanceType: !Ref EC2InstanceType
      NetworkInterfaces:
        - AssociatePublicIpAddress: false
          DeviceIndex: 0
          GroupSet: [!Ref Ec2SecurityGroup]
          SubnetId: !Select [0, !Ref PrivateSubnetIds]
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 16
            VolumeType: gp3
            Encrypted: true
      IamInstanceProfile: !Ref Ec2MinimalInstanceProfile
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-ec2
        - Key: Environment
          Value: Production

  Ec2MinimalInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${NamePrefix}-ec2-minimal
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      # Least-privilege example: allow writing to instance's own CW log stream only.
      Policies:
        - PolicyName: EC2CWLogsMinimal
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CreateOwnLogStream
                Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:CreateLogGroup
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${NamePrefix}-*
              - Sid: PutLogEvents
                Effect: Allow
                Action: logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${NamePrefix}-*:log-stream:*
      Tags:
        - Key: Environment
          Value: Production

  Ec2MinimalInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref Ec2MinimalInstanceRole]

  #######################################
  # RDS — Subnet group, parameter group, instance (encrypted, private)
  #######################################
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub '${NamePrefix} RDS subnet group'
      SubnetIds: !Ref PrivateSubnetIds
      DBSubnetGroupName: !Sub ${NamePrefix}-db-subnets
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-db-subnets
        - Key: Environment
          Value: Production

  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: !Sub '${NamePrefix} parameter group to enforce TLS'
      Family: !FindInMap [EngineFamily, !Ref DBEngine, Family]
      Parameters:
        # Enforce SSL/TLS in transit depending on engine
        # Postgres: rds.force_ssl=1 ; MySQL: require_secure_transport=ON
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: !Sub >
              inline://{
                "${EngineParam}": "${EngineValue}"
              }
      Tags:
        - Key: Environment
          Value: Production
    Metadata:
      EngineParam: !FindInMap [EngineFamily, !Ref DBEngine, SslParamName]
      EngineValue: !FindInMap [EngineFamily, !Ref DBEngine, SslParamValue]

  # Helper (since AWS::Include doesn't support inline directly, we expand explicitly)
  DBParameterGroupParamsHelper:
    Type: AWS::CloudFormation::CustomResource
    Condition: IsPostgres
    Properties: {}

  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${NamePrefix}-db
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceClass
      Engine: !Ref DBEngine
      EngineVersion: !Ref DBEngineVersion
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      StorageEncrypted: true
      KmsKeyId: !Ref AWS::NoValue  # uses AWS managed KMS for RDS
      PubliclyAccessible: false
      VPCSecurityGroups: [!Ref RdsSecurityGroup]
      DBSubnetGroupName: !Ref DBSubnetGroup
      DeletionProtection: true
      CopyTagsToSnapshot: true
      MultiAZ: false
      Tags:
        - Key: Name
          Value: !Sub ${NamePrefix}-db
        - Key: Environment
          Value: Production

  #######################################
  # Lambda (>=128MB, VPC, least-priv role)
  #######################################
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${NamePrefix}-lambda-exec
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        # Minimal logging + VPC ENI mgmt for Lambda
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Tags:
        - Key: Environment
          Value: Production

  HelloFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${NamePrefix}-hello
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: python3.12
      Handler: index.handler
      MemorySize: 128
      Timeout: 10
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: !Ref LambdaSubnetIds
      Code:
        ZipFile: |
          import json
          def handler(event, context):
              return {"statusCode": 200, "body": json.dumps({"message": "hello from prod lambda"})}
      Tags:
        - Key: Environment
          Value: Production

  #######################################
  # CloudWatch Log Group for EC2 app logs
  #######################################
  Ec2AppLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/ec2/${NamePrefix}-app
      RetentionInDays: 90
      Tags:
        - Key: Environment
          Value: Production

Outputs:
  EC2InstanceId:
    Description: EC2 instance ID
    Value: !Ref Ec2Instance
  RdsEndpoint:
    Description: RDS endpoint address
    Value: !GetAtt Database.Endpoint.Address
  AppBucketOut:
    Description: Application S3 bucket name
    Value: !Ref AppBucket
  CloudTrailName:
    Description: CloudTrail trail name capturing all API activity
    Value: !Ref OrgCloudTrail
  LambdaName:
    Description: Lambda function name
    Value: !Ref HelloFunction

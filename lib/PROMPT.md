Create an AWS CloudFormation template in JSON format for setting up a secure and scalable cloud environment to host a production application that requires high availability, auto-scaling capabilities, and strict security controls.

Here are the requirements for the setup:

VPC and Networking: Create a VPC in the us-west-1 region with proper network segmentation using one public subnet and two private subnets across different Availability Zones. Define appropriate CIDR blocks for the VPC and subnets to ensure proper network isolation. Set up an Internet Gateway and attach it to the VPC to allow internet access from the public subnet. Create route tables and associate them with the respective subnets to ensure correct routing of traffic. Ensure the public subnet routes through the Internet Gateway for outbound traffic to the internet. Configure the private subnet route table to isolate database resources from direct internet access.

Network Security: Define security groups that follow the principle of least privilege and only allow necessary traffic. Create a security group for EC2 instances that allows web traffic including HTTP (port 80) and HTTPS (port 443) from the internet. Configure the EC2 security group to allow SSH access (port 22) only from a specific IP address range to ensure secure administrative access. Create a security group for the RDS database instance that allows database traffic only from the EC2 instance security group. Ensure all inbound and outbound rules are properly configured to minimize the attack surface and prevent unauthorized access. Implement appropriate egress rules to allow necessary outbound connectivity for application functionality.

Auto Scaling and Compute: Set up an Auto Scaling Group to manage the lifecycle of EC2 instances that will host the application. Configure the Auto Scaling Group with a minimum size of 2 instances and a maximum size of 5 instances to ensure both high availability and cost optimization. Use a Launch Template or Launch Configuration that specifies the appropriate EC2 instance type and Amazon Machine Image (AMI) for the application workload. Implement Auto Scaling policies based on CPU utilization metrics to automatically scale the number of instances up or down as demand changes. Configure the scaling policies to add instances when CPU utilization increases and remove instances when utilization decreases, ensuring responsive scaling behavior. Launch all EC2 instances within the public subnet to handle incoming web traffic. Attach the appropriate IAM instance profile to EC2 instances to grant necessary permissions for accessing other AWS services. Ensure all instances are properly configured to receive traffic and serve the application.

Database: Provision an Amazon RDS database instance within the private subnet to ensure the database is not directly accessible from the internet. Configure the RDS instance with an appropriate database engine such as MySQL, PostgreSQL, or other supported engines based on application requirements. Select suitable instance class and storage type to meet performance and durability needs. Configure automated backups with an appropriate retention period to ensure data protection and recovery capabilities. Set up the RDS security group to allow database connections only from the EC2 instance security group, implementing network-level access control. Ensure the database is deployed in the private subnet to maintain security best practices and prevent direct internet exposure.

IAM Roles and Policies: Create IAM roles following the principle of least privilege to grant EC2 instances only the permissions they need. Define an IAM role for EC2 instances that includes policies allowing access to Amazon S3 for object storage operations such as reading and writing application assets. Include permissions in the IAM role for accessing Amazon DynamoDB to perform table operations required by the application. Ensure IAM policies are tightly scoped to specific actions and resources to prevent over-permissioning. Attach the IAM role to EC2 instances through an instance profile defined in the Launch Template. Follow AWS security best practices for IAM role creation including appropriate trust relationships and permission boundaries.

Monitoring and Alarms: Integrate Amazon CloudWatch to monitor the health and performance of EC2 instances and track key metrics. Create CloudWatch alarms to notify administrators when CPU utilization on EC2 instances exceeds 70 percent, indicating potential performance issues or the need for scaling. Configure alarm actions to send notifications through Amazon SNS topics or trigger automated responses. Set appropriate evaluation periods and thresholds for alarms to avoid false positives while ensuring timely alerts. Enable detailed monitoring for EC2 instances if required to collect metrics at higher frequency for better visibility into instance performance. Ensure all critical metrics are monitored to maintain application availability and performance.

Tagging Strategy: Apply consistent resource tagging across all AWS resources created by the template to enable proper resource management and cost allocation. Tag all resources with 'Environment: Production' to clearly identify resources belonging to the production environment. Ensure tags are applied to VPC, subnets, security groups, EC2 instances, Auto Scaling Group, Launch Template, RDS instance, IAM roles, CloudWatch alarms, Internet Gateway, and all other created resources. Use tags consistently throughout the template to enable filtering, tracking, and management of resources through the AWS console and APIs. Implement tagging best practices to support governance, compliance, and operational requirements.

Template Features: The CloudFormation template should be written in valid JSON format following AWS CloudFormation syntax and best practices. Parameterize the template to allow customization of values such as SSH key pair names, specific IP address ranges for SSH access, instance types, database credentials, and other configurable settings. Include appropriate default values and constraints for parameters to ensure valid inputs and prevent configuration errors. Use CloudFormation intrinsic functions such as Ref, GetAtt, Sub, Join, and Select to dynamically reference resources and construct values. Ensure all resources are explicitly configured to be deployed in the us-west-1 region either through region-specific properties or stack deployment settings. Define resource dependencies using DependsOn attributes where necessary to ensure proper creation order and avoid deployment failures. Include an Outputs section to display important resource identifiers after deployment such as VPC ID, subnet IDs, security group IDs, Auto Scaling Group name, RDS endpoint address, and other critical information needed for application configuration and management. Organize the template with clear sections for Parameters, Resources, and Outputs to ensure maintainability and readability. Ensure proper resource naming and logical IDs that clearly identify the purpose of each resource.

Please ensure the final JSON template is valid, follows AWS CloudFormation best practices, and would pass standard AWS CloudFormation validation tests.

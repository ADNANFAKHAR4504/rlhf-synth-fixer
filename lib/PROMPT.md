Create a single CloudFormation template that implements a comprehensive automated EMR based data processing pipeline for analyzing 5TB of daily financial transaction logs used in fraud detection and risk analysis systems. The template must orchestrate a complete big data processing ecosystem using Amazon EMR 6.9.0 or later, configured with Apache Spark 3.3 and Hive 3.1.3, where the cluster dynamically scales based on YARN memory utilization thresholds.

The data storage layer requires S3 buckets configured with versioning enabled and these buckets must implement lifecycle policies that automatically transition processed data to Glacier storage tier after 90 days and permanently expire objects after 7 years to comply with data retention regulations. All data at rest must be encrypted using AWS KMS with SSE KMS encryption, and the template should be region agnostic, utilizing AWS pseudo parameters and intrinsic functions to dynamically reference the deployment region, ensuring seamless deployment across any AWS region without template modifications.

The workflow orchestration must be implemented through AWS Step Functions, creating a state machine that handles EMR job submission with sophisticated error handling, including exponential backoff retry logic with a maximum of 5 retry attempts. Lambda functions need to be deployed for monitoring job progress, capturing custom metrics for job duration and data volume processed, and sending SNS notifications on both job failures and successful completions. EventBridge rules must be configured to trigger the pipeline automatically at 2 AM UTC daily and respond to S3 object creation events for real time processing capabilities. All CloudWatch logs must have a 30 day retention period configured.

From a security and networking perspective, the EMR cluster must operate within private subnets with no internet gateway attachment, ensuring complete isolation from public networks. VPC endpoints for both S3 and DynamoDB services must be configured to guarantee that data traffic remains within the AWS network backbone. IAM roles must follow least privilege principles, with separate roles for EMR service, EC2 instances, Lambda functions, and Step Functions, each granted only the minimum permissions required for their specific operations.

Expected output: A production ready CloudFormation YAML template that creates all required resources with proper parameters for all environment specific values and dependency chains.
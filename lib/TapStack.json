{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Multi-Region Aurora Global Database with Automated Failover and Health Monitoring",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource names to ensure uniqueness",
      "MinLength": 1,
      "MaxLength": 20
    },
    "IsProduction": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Enable deletion protection for production environments"
    },
    "DBMasterUsername": {
      "Type": "String",
      "Default": "dbadmin",
      "Description": "Master username for Aurora database",
      "MinLength": 1,
      "MaxLength": 16,
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*"
    },
    "DBMasterPassword": {
      "Type": "String",
      "NoEcho": true,
      "Default": "TempPassword123!",
      "Description": "Master password for Aurora database (min 8 characters)",
      "MinLength": 8,
      "MaxLength": 41
    },
    "VpcCidr": {
      "Type": "String",
      "Default": "10.0.0.0/16",
      "Description": "CIDR block for the VPC"
    }
  },
  "Conditions": {
    "IsProductionCondition": {
      "Fn::Equals": [
        {"Ref": "IsProduction"},
        "true"
      ]
    }
  },
  "Resources": {
    "PrimaryVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {"Ref": "VpcCidr"},
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-vpc-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-igw-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "VPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {"Ref": "PrimaryVPC"},
        "InternetGatewayId": {"Ref": "InternetGateway"}
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "PrimaryVPC"},
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": {
          "Fn::Select": [0, {"Fn::GetAZs": {"Ref": "AWS::Region"}}]
        },
        "MapPublicIpOnLaunch": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-private-subnet-1-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "PrimaryVPC"},
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": {
          "Fn::Select": [1, {"Fn::GetAZs": {"Ref": "AWS::Region"}}]
        },
        "MapPublicIpOnLaunch": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-private-subnet-2-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "PrimaryVPC"},
        "CidrBlock": "10.0.3.0/24",
        "AvailabilityZone": {
          "Fn::Select": [2, {"Fn::GetAZs": {"Ref": "AWS::Region"}}]
        },
        "MapPublicIpOnLaunch": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-private-subnet-3-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {"Ref": "PrimaryVPC"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-private-rt-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrivateSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet1"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    "PrivateSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet2"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    "PrivateSubnet3RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet3"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    "PrivateHostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "Properties": {
        "Name": {
          "Fn::Sub": "aurora-${EnvironmentSuffix}.internal"
        },
        "VPCs": [
          {
            "VPCId": {"Ref": "PrimaryVPC"},
            "VPCRegion": {"Ref": "AWS::Region"}
          }
        ],
        "HostedZoneConfig": {
          "Comment": {
            "Fn::Sub": "Private hosted zone for Aurora cluster - ${EnvironmentSuffix}"
          }
        },
        "HostedZoneTags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-hosted-zone-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrimaryKMSKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {
          "Fn::Sub": "KMS key for Aurora encryption in primary region - ${EnvironmentSuffix}"
        },
        "EnableKeyRotation": true,
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow RDS to use the key",
              "Effect": "Allow",
              "Principal": {
                "Service": "rds.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-kms-primary-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          },
          {
            "Key": "Region",
            "Value": "us-east-1"
          }
        ]
      }
    },
    "PrimaryKMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/aurora-primary-${EnvironmentSuffix}"
        },
        "TargetKeyId": {"Ref": "PrimaryKMSKey"}
      }
    },
    "DBClusterParameterGroup": {
      "Type": "AWS::RDS::DBClusterParameterGroup",
      "Properties": {
        "Description": {
          "Fn::Sub": "Aurora MySQL 5.7 cluster parameter group - ${EnvironmentSuffix}"
        },
        "Family": "aurora-mysql5.7",
        "Parameters": {
          "binlog_format": "OFF",
          "slow_query_log": "1",
          "long_query_time": "2"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-cluster-params-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "DBParameterGroup": {
      "Type": "AWS::RDS::DBParameterGroup",
      "Properties": {
        "Description": {
          "Fn::Sub": "Aurora MySQL 5.7 instance parameter group - ${EnvironmentSuffix}"
        },
        "Family": "aurora-mysql5.7",
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-instance-params-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "AuroraSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": {
          "Fn::Sub": "Security group for Aurora cluster - ${EnvironmentSuffix}"
        },
        "VpcId": {"Ref": "PrimaryVPC"},
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-sg-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": {
          "Fn::Sub": "Security group for Lambda health check functions - ${EnvironmentSuffix}"
        },
        "VpcId": {"Ref": "PrimaryVPC"},
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "lambda-sg-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "AuroraSecurityGroupIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "AuroraSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "SourceSecurityGroupId": {"Ref": "LambdaSecurityGroup"}
      }
    },
    "LambdaSecurityGroupEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {"Ref": "LambdaSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 3306,
        "ToPort": 3306,
        "DestinationSecurityGroupId": {"Ref": "AuroraSecurityGroup"}
      }
    },
    "PrimaryDBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {
          "Fn::Sub": "aurora-subnet-primary-${EnvironmentSuffix}"
        },
        "DBSubnetGroupDescription": {
          "Fn::Sub": "Subnet group for Aurora primary cluster - ${EnvironmentSuffix}"
        },
        "SubnetIds": [
          {"Ref": "PrivateSubnet1"},
          {"Ref": "PrivateSubnet2"},
          {"Ref": "PrivateSubnet3"}
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-subnet-primary-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          },
          {
            "Key": "Region",
            "Value": "us-east-1"
          }
        ]
      }
    },
    "GlobalCluster": {
      "Type": "AWS::RDS::GlobalCluster",
      "Properties": {
        "GlobalClusterIdentifier": {
          "Fn::Sub": "aurora-global-${EnvironmentSuffix}"
        },
        "Engine": "aurora-mysql",
        "EngineVersion": "5.7.mysql_aurora.2.12.5",
        "StorageEncrypted": true,
        "DeletionProtection": {
          "Fn::If": [
            "IsProductionCondition",
            true,
            false
          ]
        }
      }
    },
    "PrimaryCluster": {
      "Type": "AWS::RDS::DBCluster",
      "Properties": {
        "Engine": "aurora-mysql",
        "EngineVersion": "5.7.mysql_aurora.2.12.5",
        "GlobalClusterIdentifier": {"Ref": "GlobalCluster"},
        "DBClusterIdentifier": {
          "Fn::Sub": "aurora-primary-${EnvironmentSuffix}"
        },
        "MasterUsername": {"Ref": "DBMasterUsername"},
        "MasterUserPassword": {"Ref": "DBMasterPassword"},
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "mon:04:00-mon:05:00",
        "DBSubnetGroupName": {"Ref": "PrimaryDBSubnetGroup"},
        "DBClusterParameterGroupName": {"Ref": "DBClusterParameterGroup"},
        "VpcSecurityGroupIds": [
          {"Ref": "AuroraSecurityGroup"}
        ],
        "KmsKeyId": {
          "Fn::GetAtt": ["PrimaryKMSKey", "Arn"]
        },
        "StorageEncrypted": true,
        "EnableCloudwatchLogsExports": ["slowquery", "error"],
        "DeletionProtection": {
          "Fn::If": [
            "IsProductionCondition",
            true,
            false
          ]
        },
        "EnableIAMDatabaseAuthentication": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-primary-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          },
          {
            "Key": "Region",
            "Value": "us-east-1"
          },
          {
            "Key": "Role",
            "Value": "Primary"
          }
        ]
      }
    },
    "PrimaryInstance1": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "aurora-mysql",
        "DBClusterIdentifier": {"Ref": "PrimaryCluster"},
        "DBInstanceIdentifier": {
          "Fn::Sub": "aurora-primary-1-${EnvironmentSuffix}"
        },
        "DBInstanceClass": "db.r5.large",
        "DBParameterGroupName": {"Ref": "DBParameterGroup"},
        "PubliclyAccessible": false,
        "EnablePerformanceInsights": true,
        "PerformanceInsightsRetentionPeriod": 7,
        "MonitoringInterval": 60,
        "MonitoringRoleArn": {
          "Fn::GetAtt": ["RDSMonitoringRole", "Arn"]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-primary-1-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrimaryInstance2": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "aurora-mysql",
        "DBClusterIdentifier": {"Ref": "PrimaryCluster"},
        "DBInstanceIdentifier": {
          "Fn::Sub": "aurora-primary-2-${EnvironmentSuffix}"
        },
        "DBInstanceClass": "db.r5.large",
        "DBParameterGroupName": {"Ref": "DBParameterGroup"},
        "PubliclyAccessible": false,
        "EnablePerformanceInsights": true,
        "PerformanceInsightsRetentionPeriod": 7,
        "MonitoringInterval": 60,
        "MonitoringRoleArn": {
          "Fn::GetAtt": ["RDSMonitoringRole", "Arn"]
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-primary-2-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "RDSMonitoringRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "monitoring.rds.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "rds-monitoring-role-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "aurora-health-check-role-${EnvironmentSuffix}"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "RDSDescribeAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "rds:DescribeDBClusters",
                    "rds:DescribeDBInstances"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "lambda-execution-role-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrimaryHealthCheckFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "aurora-health-check-primary-${EnvironmentSuffix}"
        },
        "Runtime": "python3.11",
        "Handler": "index.lambda_handler",
        "Timeout": 5,
        "MemorySize": 256,
        "Role": {
          "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]
        },
        "VpcConfig": {
          "SecurityGroupIds": [
            {"Ref": "LambdaSecurityGroup"}
          ],
          "SubnetIds": [
            {"Ref": "PrivateSubnet1"},
            {"Ref": "PrivateSubnet2"},
            {"Ref": "PrivateSubnet3"}
          ]
        },
        "Environment": {
          "Variables": {
            "CLUSTER_ID": {
              "Ref": "PrimaryCluster"
            },
            "REGION": "us-east-1",
            "ENVIRONMENT_SUFFIX": {"Ref": "EnvironmentSuffix"}
          }
        },
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport os\nimport time\nfrom datetime import datetime\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Health check function for Aurora cluster endpoints.\n    Checks cluster status and publishes metrics to CloudWatch.\n    \"\"\"\n    cluster_id = os.environ.get('CLUSTER_ID')\n    region = os.environ.get('REGION', 'us-east-1')\n    \n    rds_client = boto3.client('rds', region_name=region)\n    cloudwatch = boto3.client('cloudwatch', region_name=region)\n    \n    try:\n        start_time = time.time()\n        \n        # Describe cluster status\n        response = rds_client.describe_db_clusters(\n            DBClusterIdentifier=cluster_id\n        )\n        \n        if not response['DBClusters']:\n            raise Exception(f'Cluster {cluster_id} not found')\n        \n        cluster = response['DBClusters'][0]\n        status = cluster['Status']\n        endpoint = cluster.get('Endpoint', 'N/A')\n        reader_endpoint = cluster.get('ReaderEndpoint', 'N/A')\n        \n        # Calculate response time\n        response_time = (time.time() - start_time) * 1000\n        \n        # Determine health status\n        is_healthy = status == 'available'\n        health_value = 1.0 if is_healthy else 0.0\n        \n        # Publish custom metrics to CloudWatch\n        cloudwatch.put_metric_data(\n            Namespace='Aurora/HealthCheck',\n            MetricData=[\n                {\n                    'MetricName': 'ClusterHealth',\n                    'Value': health_value,\n                    'Unit': 'None',\n                    'Timestamp': datetime.utcnow(),\n                    'Dimensions': [\n                        {\n                            'Name': 'ClusterIdentifier',\n                            'Value': cluster_id\n                        },\n                        {\n                            'Name': 'Region',\n                            'Value': region\n                        }\n                    ]\n                },\n                {\n                    'MetricName': 'ResponseTime',\n                    'Value': response_time,\n                    'Unit': 'Milliseconds',\n                    'Timestamp': datetime.utcnow(),\n                    'Dimensions': [\n                        {\n                            'Name': 'ClusterIdentifier',\n                            'Value': cluster_id\n                        }\n                    ]\n                }\n            ]\n        )\n        \n        return {\n            'statusCode': 200 if is_healthy else 503,\n            'body': json.dumps({\n                'cluster_id': cluster_id,\n                'status': status,\n                'endpoint': endpoint,\n                'reader_endpoint': reader_endpoint,\n                'is_healthy': is_healthy,\n                'response_time_ms': response_time,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n    except Exception as e:\n        # Publish failure metric\n        try:\n            cloudwatch.put_metric_data(\n                Namespace='Aurora/HealthCheck',\n                MetricData=[\n                    {\n                        'MetricName': 'ClusterHealth',\n                        'Value': 0.0,\n                        'Unit': 'None',\n                        'Timestamp': datetime.utcnow(),\n                        'Dimensions': [\n                            {\n                                'Name': 'ClusterIdentifier',\n                                'Value': cluster_id\n                            },\n                            {\n                                'Name': 'Region',\n                                'Value': region\n                            }\n                        ]\n                    }\n                ]\n            )\n        except:\n            pass\n        \n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': str(e),\n                'cluster_id': cluster_id,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-health-check-primary-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          },
          {
            "Key": "Region",
            "Value": "us-east-1"
          }
        ]
      }
    },
    "PrimaryHealthCheckSchedule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "aurora-health-check-schedule-primary-${EnvironmentSuffix}"
        },
        "Description": "Trigger Aurora health check every minute",
        "ScheduleExpression": "rate(1 minute)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": ["PrimaryHealthCheckFunction", "Arn"]
            },
            "Id": "PrimaryHealthCheckTarget"
          }
        ]
      }
    },
    "PrimaryHealthCheckPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "PrimaryHealthCheckFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": ["PrimaryHealthCheckSchedule", "Arn"]
        }
      }
    },
    "PrimaryRoute53HealthCheck": {
      "Type": "AWS::Route53::HealthCheck",
      "Properties": {
        "HealthCheckConfig": {
          "Type": "CLOUDWATCH_METRIC",
          "AlarmIdentifier": {
            "Name": {
              "Ref": "PrimaryClusterHealthAlarm"
            },
            "Region": "us-east-1"
          },
          "InsufficientDataHealthStatus": "Unhealthy"
        },
        "HealthCheckTags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "aurora-health-check-primary-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "EnvironmentSuffix"}
          }
        ]
      }
    },
    "PrimaryClusterHealthAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "aurora-cluster-health-primary-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Monitor primary Aurora cluster health status",
        "MetricName": "ClusterHealth",
        "Namespace": "Aurora/HealthCheck",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 0.5,
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "ClusterIdentifier",
            "Value": {
              "Ref": "PrimaryCluster"
            }
          },
          {
            "Name": "Region",
            "Value": "us-east-1"
          }
        ],
        "TreatMissingData": "breaching"
      }
    },
    "ReplicationLagAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "aurora-replication-lag-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when global database replication lag exceeds 1000ms",
        "MetricName": "AuroraGlobalDBReplicationLag",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 2,
        "Threshold": 1000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBClusterIdentifier",
            "Value": {
              "Ref": "PrimaryCluster"
            }
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "SlowQueryLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/rds/cluster/${PrimaryCluster}/slowquery"
        },
        "RetentionInDays": 30
      }
    },
    "ErrorLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/rds/cluster/${PrimaryCluster}/error"
        },
        "RetentionInDays": 30
      }
    },
    "PrimaryDNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {"Ref": "PrivateHostedZone"},
        "Name": {
          "Fn::Sub": "db.aurora-${EnvironmentSuffix}.internal"
        },
        "Type": "CNAME",
        "SetIdentifier": "Primary",
        "Weight": 100,
        "TTL": 60,
        "ResourceRecords": [
          {
            "Fn::GetAtt": ["PrimaryCluster", "Endpoint.Address"]
          }
        ],
        "HealthCheckId": {
          "Ref": "PrimaryRoute53HealthCheck"
        }
      }
    },
    "PrimaryReaderDNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {"Ref": "PrivateHostedZone"},
        "Name": {
          "Fn::Sub": "reader.db.aurora-${EnvironmentSuffix}.internal"
        },
        "Type": "CNAME",
        "SetIdentifier": "PrimaryReader",
        "Weight": 100,
        "TTL": 60,
        "ResourceRecords": [
          {
            "Fn::GetAtt": ["PrimaryCluster", "ReadEndpoint.Address"]
          }
        ],
        "HealthCheckId": {
          "Ref": "PrimaryRoute53HealthCheck"
        }
      }
    }
  },
  "Outputs": {
    "VpcId": {
      "Description": "VPC ID for the Aurora cluster",
      "Value": {"Ref": "PrimaryVPC"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-VpcId"
        }
      }
    },
    "PrivateSubnet1Id": {
      "Description": "Private Subnet 1 ID",
      "Value": {"Ref": "PrivateSubnet1"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrivateSubnet1Id"
        }
      }
    },
    "PrivateSubnet2Id": {
      "Description": "Private Subnet 2 ID",
      "Value": {"Ref": "PrivateSubnet2"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrivateSubnet2Id"
        }
      }
    },
    "PrivateSubnet3Id": {
      "Description": "Private Subnet 3 ID",
      "Value": {"Ref": "PrivateSubnet3"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrivateSubnet3Id"
        }
      }
    },
    "HostedZoneId": {
      "Description": "Private hosted zone ID",
      "Value": {"Ref": "PrivateHostedZone"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-HostedZoneId"
        }
      }
    },
    "GlobalClusterId": {
      "Description": "Global cluster identifier",
      "Value": {"Ref": "GlobalCluster"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-GlobalClusterId"
        }
      }
    },
    "PrimaryClusterId": {
      "Description": "Primary cluster identifier",
      "Value": {"Ref": "PrimaryCluster"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrimaryClusterId"
        }
      }
    },
    "PrimaryClusterEndpoint": {
      "Description": "Primary cluster writer endpoint",
      "Value": {
        "Fn::GetAtt": ["PrimaryCluster", "Endpoint.Address"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrimaryClusterEndpoint"
        }
      }
    },
    "PrimaryClusterReaderEndpoint": {
      "Description": "Primary cluster reader endpoint",
      "Value": {
        "Fn::GetAtt": ["PrimaryCluster", "ReadEndpoint.Address"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrimaryClusterReaderEndpoint"
        }
      }
    },
    "PrimaryClusterPort": {
      "Description": "Primary cluster port",
      "Value": {
        "Fn::GetAtt": ["PrimaryCluster", "Endpoint.Port"]
      }
    },
    "PrimaryKMSKeyId": {
      "Description": "KMS key ID for primary region",
      "Value": {"Ref": "PrimaryKMSKey"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrimaryKMSKeyId"
        }
      }
    },
    "PrimaryKMSKeyArn": {
      "Description": "KMS key ARN for primary region",
      "Value": {
        "Fn::GetAtt": ["PrimaryKMSKey", "Arn"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PrimaryKMSKeyArn"
        }
      }
    },
    "HealthCheckFunctionArn": {
      "Description": "Primary health check Lambda function ARN",
      "Value": {
        "Fn::GetAtt": ["PrimaryHealthCheckFunction", "Arn"]
      }
    },
    "AuroraSecurityGroupId": {
      "Description": "Security group ID for Aurora cluster",
      "Value": {"Ref": "AuroraSecurityGroup"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-AuroraSecurityGroupId"
        }
      }
    },
    "DBClusterParameterGroupName": {
      "Description": "DB cluster parameter group name",
      "Value": {"Ref": "DBClusterParameterGroup"},
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DBClusterParameterGroupName"
        }
      }
    },
    "DNSEndpoint": {
      "Description": "Route 53 DNS endpoint for Aurora cluster",
      "Value": {
        "Fn::Sub": "db.aurora-${EnvironmentSuffix}.internal"
      }
    },
    "ReaderDNSEndpoint": {
      "Description": "Route 53 DNS endpoint for Aurora reader",
      "Value": {
        "Fn::Sub": "reader.db.aurora-${EnvironmentSuffix}.internal"
      }
    }
  }
}

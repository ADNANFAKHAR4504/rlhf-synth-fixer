{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Production-ready multi-tier application infrastructure with ECS Fargate, RDS PostgreSQL, and complete monitoring",
  
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Suffix for resource naming to ensure uniqueness across environments",
      "Default": "prod",
      "AllowedPattern": "^[a-z0-9-]+$"
    },
    "EnvironmentName": {
      "Type": "String",
      "Description": "Environment name (dev, staging, prod)",
      "Default": "dev",
      "AllowedValues": ["dev", "staging", "prod"]
    },
    "VpcCidr": {
      "Type": "String",
      "Description": "CIDR block for VPC",
      "Default": "10.100.0.0/16"
    },
    "ProjectName": {
      "Type": "String",
      "Default": "app-migration",
      "Description": "Project name for tagging"
    },
    "CostCenter": {
      "Type": "String",
      "Default": "engineering",
      "Description": "Cost center for billing"
    },
    "DBInstanceClass": {
      "Type": "String",
      "Description": "RDS instance class for PostgreSQL database",
      "Default": "db.t3.medium",
      "AllowedValues": ["db.t3.micro", "db.t3.small", "db.t3.medium", "db.t3.large", "db.r5.large"]
    },
    "ECSTaskCPU": {
      "Type": "String",
      "Description": "CPU units for ECS task (256, 512, 1024, 2048, 4096)",
      "Default": "512",
      "AllowedValues": ["256", "512", "1024", "2048", "4096"]
    },
    "ECSTaskMemory": {
      "Type": "String",
      "Description": "Memory for ECS task in MB",
      "Default": "1024",
      "AllowedValues": ["512", "1024", "2048", "4096", "8192"]
    },
    "ECSDesiredCount": {
      "Type": "Number",
      "Description": "Desired number of ECS tasks",
      "Default": 2,
      "MinValue": 1,
      "MaxValue": 10
    },
    "HostedZoneId": {
      "Type": "String",
      "Description": "Route53 hosted zone ID for DNS records (optional)",
      "Default": ""
    },
    "DomainName": {
      "Type": "String",
      "Description": "Domain name for the application (optional)",
      "Default": ""
    }
  },
  
  "Conditions": {
    "HasHostedZoneId": {"Fn::Not": [{"Fn::Equals": [{"Ref": "HostedZoneId"}, ""]}]},
    "HasDomainName": {"Fn::Not": [{"Fn::Equals": [{"Ref": "DomainName"}, ""]}]},
    "HasMonitoring": {"Fn::And": [
      {"Condition": "HasHostedZoneId"},
      {"Condition": "HasDomainName"}
    ]}
  },
  
  "Mappings": {
    "EnvironmentConfig": {
      "dev": {
        "DBAllocatedStorage": "20",
        "DBMultiAZ": "false",
        "LogRetentionDays": "7"
      },
      "staging": {
        "DBAllocatedStorage": "50",
        "DBMultiAZ": "false",
        "LogRetentionDays": "30"
      },
      "prod": {
        "DBAllocatedStorage": "100",
        "DBMultiAZ": "true",
        "LogRetentionDays": "90"
      }
    }
  },
  
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": {"Ref": "VpcCidr"},
        "EnableDnsSupport": true,
        "EnableDnsHostnames": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "vpc-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "igw-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "InternetGatewayId": {"Ref": "InternetGateway"}
      }
    },
    
    "NATGatewayEIP": {
      "Type": "AWS::EC2::EIP",
      "DependsOn": "AttachGateway",
      "Properties": {
        "Domain": "vpc",
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "nat-eip-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.1.0/24",
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "public-subnet-1-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.2.0/24",
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "public-subnet-2-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PublicSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.3.0/24",
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "public-subnet-3-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.11.0/24",
        "AvailabilityZone": {"Fn::Select": [0, {"Fn::GetAZs": ""}]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "private-subnet-1-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.12.0/24",
        "AvailabilityZone": {"Fn::Select": [1, {"Fn::GetAZs": ""}]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "private-subnet-2-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "CidrBlock": "10.100.13.0/24",
        "AvailabilityZone": {"Fn::Select": [2, {"Fn::GetAZs": ""}]},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "private-subnet-3-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "NATGateway": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {"Fn::GetAtt": ["NATGatewayEIP", "AllocationId"]},
        "SubnetId": {"Ref": "PublicSubnet1"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "nat-gw-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "public-rt-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachGateway",
      "Properties": {
        "RouteTableId": {"Ref": "PublicRouteTable"},
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {"Ref": "InternetGateway"}
      }
    },
    
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "private-rt-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "PrivateRoute": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {"Ref": "PrivateRouteTable"},
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {"Ref": "NATGateway"}
      }
    },
    
    "PublicSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PublicSubnet1"},
        "RouteTableId": {"Ref": "PublicRouteTable"}
      }
    },
    
    "PublicSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PublicSubnet2"},
        "RouteTableId": {"Ref": "PublicRouteTable"}
      }
    },
    
    "PublicSubnet3RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PublicSubnet3"},
        "RouteTableId": {"Ref": "PublicRouteTable"}
      }
    },
    
    "PrivateSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet1"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    
    "PrivateSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet2"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    
    "PrivateSubnet3RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {"Ref": "PrivateSubnet3"},
        "RouteTableId": {"Ref": "PrivateRouteTable"}
      }
    },
    
    "RDSEncryptionKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {"Fn::Sub": "KMS key for RDS encryption in ${EnvironmentSuffix}"},
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {"AWS": {"Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"}},
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow RDS to use the key",
              "Effect": "Allow",
              "Principal": {"Service": "rds.amazonaws.com"},
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey",
                "kms:CreateGrant"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "rds-kms-key-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "RDSEncryptionKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {"Fn::Sub": "alias/rds-${EnvironmentSuffix}"},
        "TargetKeyId": {"Ref": "RDSEncryptionKey"}
      }
    },
    
    "DBMasterPasswordSecret": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": {"Fn::Sub": "db-master-password-${EnvironmentSuffix}"},
        "Description": "RDS PostgreSQL master password",
        "GenerateSecretString": {
          "SecretStringTemplate": "{\"username\":\"dbadmin\"}",
          "GenerateStringKey": "password",
          "PasswordLength": 32,
          "ExcludeCharacters": "\"@/\\",
          "RequireEachIncludedType": true
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "db-secret-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "AppSecrets": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": {"Fn::Sub": "app-secrets-${EnvironmentSuffix}"},
        "Description": "Application secrets and API keys",
        "SecretString": "{\"api_key\":\"changeme\",\"jwt_secret\":\"changeme\"}",
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "app-secret-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Application Load Balancer - internet-facing",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTP from internet"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTPS from internet"
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "alb-sg-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for ECS Fargate tasks",
        "VpcId": {"Ref": "VPC"},
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTPS to AWS services (ECR, Secrets Manager)"
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "ecs-sg-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for RDS PostgreSQL instance",
        "VpcId": {"Ref": "VPC"},
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "db-sg-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ALBToECSEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {"Ref": "ALBSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 80,
        "ToPort": 80,
        "DestinationSecurityGroupId": {"Ref": "ECSSecurityGroup"},
        "Description": "Allow traffic to ECS tasks"
      }
    },
    
    "ECSFromALBIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "ECSSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 80,
        "ToPort": 80,
        "SourceSecurityGroupId": {"Ref": "ALBSecurityGroup"},
        "Description": "Allow traffic from ALB"
      }
    },
    
    "ECSToDBEgress": {
      "Type": "AWS::EC2::SecurityGroupEgress",
      "Properties": {
        "GroupId": {"Ref": "ECSSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 5432,
        "ToPort": 5432,
        "DestinationSecurityGroupId": {"Ref": "DBSecurityGroup"},
        "Description": "Allow traffic to RDS PostgreSQL"
      }
    },
    
    "DBFromECSIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Ref": "DBSecurityGroup"},
        "IpProtocol": "tcp",
        "FromPort": 5432,
        "ToPort": 5432,
        "SourceSecurityGroupId": {"Ref": "ECSSecurityGroup"},
        "Description": "Allow PostgreSQL from ECS tasks"
      }
    },
    
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": {"Fn::Sub": "alb-${EnvironmentSuffix}"},
        "Type": "application",
        "Scheme": "internet-facing",
        "IpAddressType": "ipv4",
        "Subnets": [
          {"Ref": "PublicSubnet1"},
          {"Ref": "PublicSubnet2"},
          {"Ref": "PublicSubnet3"}
        ],
        "SecurityGroups": [{"Ref": "ALBSecurityGroup"}],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "alb-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ALBTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": {"Fn::Sub": "tg-${EnvironmentSuffix}"},
        "Port": 80,
        "Protocol": "HTTP",
        "TargetType": "ip",
        "VpcId": {"Ref": "VPC"},
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "Matcher": {
          "HttpCode": "200"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "tg-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ALBListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {"Ref": "ApplicationLoadBalancer"},
        "Port": 80,
        "Protocol": "HTTP",
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {"Ref": "ALBTargetGroup"}
          }
        ]
      }
    },
    
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {"Fn::Sub": "ecs-cluster-${EnvironmentSuffix}"},
        "CapacityProviders": ["FARGATE", "FARGATE_SPOT"],
        "DefaultCapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Weight": 1,
            "Base": 1
          }
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "enabled"
          }
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "ecs-cluster-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECRRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {"Fn::Sub": "app-repo-${EnvironmentSuffix}"},
        "ImageScanningConfiguration": {
          "ScanOnPush": true
        },
        "EncryptionConfiguration": {
          "EncryptionType": "AES256"
        },
        "LifecyclePolicy": {
          "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Remove untagged images after 7 days\",\"selection\":{\"tagStatus\":\"untagged\",\"countType\":\"sinceImagePushed\",\"countUnit\":\"days\",\"countNumber\":7},\"action\":{\"type\":\"expire\"}},{\"rulePriority\":2,\"description\":\"Keep last 10 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":10},\"action\":{\"type\":\"expire\"}}]}"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "app-repo-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECSTaskExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {"Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {"Service": "ecs-tasks.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ],
        "Policies": [
          {
            "PolicyName": "SecretsManagerAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": [
                    {"Ref": "DBMasterPasswordSecret"},
                    {"Ref": "AppSecrets"}
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "ECRAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecr:GetAuthorizationToken",
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:BatchGetImage"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECSTaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {"Fn::Sub": "ecs-task-role-${EnvironmentSuffix}"},
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {"Service": "ecs-tasks.amazonaws.com"},
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "ApplicationPermissions",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": [
                    {"Ref": "AppSecrets"}
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECSLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {"Fn::Sub": "/ecs/app-${EnvironmentSuffix}"},
        "RetentionInDays": {
          "Fn::FindInMap": ["EnvironmentConfig", {"Ref": "EnvironmentName"}, "LogRetentionDays"]
        }
      }
    },
    
    "ECSTaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": {"Fn::Sub": "app-task-${EnvironmentSuffix}"},
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": ["FARGATE"],
        "Cpu": {"Ref": "ECSTaskCPU"},
        "Memory": {"Ref": "ECSTaskMemory"},
        "ExecutionRoleArn": {"Fn::GetAtt": ["ECSTaskExecutionRole", "Arn"]},
        "TaskRoleArn": {"Fn::GetAtt": ["ECSTaskRole", "Arn"]},
        "ContainerDefinitions": [
          {
            "Name": "app-container",
            "Image": "public.ecr.aws/docker/library/nginx:latest",
            "Essential": true,
            "PortMappings": [
              {
                "ContainerPort": 80,
                "Protocol": "tcp"
              }
            ],
            "Environment": [
              {
                "Name": "ENVIRONMENT",
                "Value": {"Ref": "EnvironmentName"}
              },
              {
                "Name": "DB_HOST",
                "Value": {"Fn::GetAtt": ["DBInstance", "Endpoint.Address"]}
              },
              {
                "Name": "DB_PORT",
                "Value": "5432"
              },
              {
                "Name": "DB_NAME",
                "Value": "appdb"
              }
            ],
            "Secrets": [
              {
                "Name": "DB_USERNAME",
                "ValueFrom": {
                  "Fn::Sub": "${DBMasterPasswordSecret}:username::"
                }
              },
              {
                "Name": "DB_PASSWORD",
                "ValueFrom": {
                  "Fn::Sub": "${DBMasterPasswordSecret}:password::"
                }
              },
              {
                "Name": "API_KEY",
                "ValueFrom": {
                  "Fn::Sub": "${AppSecrets}:api_key::"
                }
              }
            ],
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-group": {"Ref": "ECSLogGroup"},
                "awslogs-region": {"Ref": "AWS::Region"},
                "awslogs-stream-prefix": "ecs"
              }
            }
          }
        ],
        "Tags": [
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "DependsOn": "ALBListener",
      "Properties": {
        "ServiceName": {"Fn::Sub": "app-service-${EnvironmentSuffix}"},
        "Cluster": {"Ref": "ECSCluster"},
        "TaskDefinition": {"Ref": "ECSTaskDefinition"},
        "DesiredCount": {"Ref": "ECSDesiredCount"},
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "DISABLED",
            "Subnets": [
              {"Ref": "PrivateSubnet1"},
              {"Ref": "PrivateSubnet2"},
              {"Ref": "PrivateSubnet3"}
            ],
            "SecurityGroups": [{"Ref": "ECSSecurityGroup"}]
          }
        },
        "LoadBalancers": [
          {
            "ContainerName": "app-container",
            "ContainerPort": 80,
            "TargetGroupArn": {"Ref": "ALBTargetGroup"}
          }
        ],
        "HealthCheckGracePeriodSeconds": 60,
        "Tags": [
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "ServiceScalingTarget": {
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
      "Properties": {
        "MaxCapacity": 10,
        "MinCapacity": {"Ref": "ECSDesiredCount"},
        "ResourceId": {
          "Fn::Sub": "service/${ECSCluster}/${ECSService.Name}"
        },
        "RoleARN": {
          "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      }
    },
    
    "ServiceScalingPolicy": {
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
      "Properties": {
        "PolicyName": {"Fn::Sub": "cpu-scaling-policy-${EnvironmentSuffix}"},
        "PolicyType": "TargetTrackingScaling",
        "ScalingTargetId": {"Ref": "ServiceScalingTarget"},
        "TargetTrackingScalingPolicyConfiguration": {
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
          },
          "TargetValue": 70.0,
          "ScaleInCooldown": 300,
          "ScaleOutCooldown": 60
        }
      }
    },
    
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {"Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"},
        "DBSubnetGroupDescription": "Subnet group for RDS PostgreSQL",
        "SubnetIds": [
          {"Ref": "PrivateSubnet1"},
          {"Ref": "PrivateSubnet2"},
          {"Ref": "PrivateSubnet3"}
        ],
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "db-subnet-group-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "DBParameterGroup": {
      "Type": "AWS::RDS::DBParameterGroup",
      "Properties": {
        "DBParameterGroupName": {"Fn::Sub": "pg-params-${EnvironmentSuffix}"},
        "Description": "PostgreSQL parameter group with optimized settings",
        "Family": "postgres14",
        "Parameters": {
          "shared_preload_libraries": "pg_stat_statements",
          "log_statement": "all",
          "log_min_duration_statement": "1000"
        },
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "pg-params-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "DBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "DeletionPolicy": "Snapshot",
      "UpdateReplacePolicy": "Snapshot",
      "Properties": {
        "DBInstanceIdentifier": {"Fn::Sub": "postgres-${EnvironmentSuffix}"},
        "DBName": "appdb",
        "Engine": "postgres",
        "EngineVersion": "16.1",
        "DBInstanceClass": {"Ref": "DBInstanceClass"},
        "AllocatedStorage": {
          "Fn::FindInMap": ["EnvironmentConfig", {"Ref": "EnvironmentName"}, "DBAllocatedStorage"]
        },
        "StorageType": "gp3",
        "StorageEncrypted": true,
        "KmsKeyId": {"Ref": "RDSEncryptionKey"},
        "MasterUsername": {
          "Fn::Sub": "{{resolve:secretsmanager:${DBMasterPasswordSecret}:SecretString:username}}"
        },
        "MasterUserPassword": {
          "Fn::Sub": "{{resolve:secretsmanager:${DBMasterPasswordSecret}:SecretString:password}}"
        },
        "DBSubnetGroupName": {"Ref": "DBSubnetGroup"},
        "DBParameterGroupName": {"Ref": "DBParameterGroup"},
        "VPCSecurityGroups": [{"Ref": "DBSecurityGroup"}],
        "MultiAZ": {
          "Fn::FindInMap": ["EnvironmentConfig", {"Ref": "EnvironmentName"}, "DBMultiAZ"]
        },
        "PubliclyAccessible": false,
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
        "EnableCloudwatchLogsExports": ["postgresql", "upgrade"],
        "DeletionProtection": false,
        "Tags": [
          {"Key": "Name", "Value": {"Fn::Sub": "postgres-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "CostCenter", "Value": {"Ref": "CostCenter"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "DNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Condition": "HasMonitoring",
      "Properties": {
        "HostedZoneId": {"Ref": "HostedZoneId"},
        "Name": {
          "Fn::Sub": "app-${EnvironmentName}.${DomainName}"
        },
        "Type": "A",
        "AliasTarget": {
          "DNSName": {"Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]},
          "HostedZoneId": {"Fn::GetAtt": ["ApplicationLoadBalancer", "CanonicalHostedZoneID"]},
          "EvaluateTargetHealth": true
        }
      }
    },
    
    "HealthCheck": {
      "Type": "AWS::Route53::HealthCheck",
      "Condition": "HasMonitoring",
      "Properties": {
        "HealthCheckConfig": {
          "Type": "HTTP_STR_MATCH",
          "FullyQualifiedDomainName": {"Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]},
          "Port": 80,
          "ResourcePath": "/",
          "SearchString": "Welcome to nginx",
          "RequestInterval": 30,
          "FailureThreshold": 3
        },
        "HealthCheckTags": [
          {"Key": "Name", "Value": {"Fn::Sub": "health-check-${EnvironmentSuffix}"}},
          {"Key": "Environment", "Value": {"Ref": "EnvironmentName"}},
          {"Key": "Project", "Value": {"Ref": "ProjectName"}},
          {"Key": "ManagedBy", "Value": "CloudFormation"}
        ]
      }
    },
    
    "CPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "ecs-cpu-high-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when ECS service CPU exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {"Fn::GetAtt": ["ECSService", "Name"]}
          },
          {
            "Name": "ClusterName",
            "Value": {"Ref": "ECSCluster"}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "MemoryAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "ecs-memory-high-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when ECS service memory exceeds 80%",
        "MetricName": "MemoryUtilization",
        "Namespace": "AWS/ECS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {"Fn::GetAtt": ["ECSService", "Name"]}
          },
          {
            "Name": "ClusterName",
            "Value": {"Ref": "ECSCluster"}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "RDSCPUAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "rds-cpu-utilization-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when RDS CPU utilization exceeds 80%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80.0,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "DBInstanceIdentifier",
            "Value": {"Ref": "DBInstance"}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "RDSStorageAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "rds-storage-space-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when RDS free storage space is low",
        "MetricName": "FreeStorageSpace",
        "Namespace": "AWS/RDS",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10737418240,
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "DBInstanceIdentifier",
            "Value": {"Ref": "DBInstance"}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "ALBTargetResponseTimeAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "alb-target-response-time-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when ALB target response time exceeds 1 second",
        "MetricName": "TargetResponseTime",
        "Namespace": "AWS/ApplicationELB",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 1.0,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "LoadBalancer",
            "Value": {"Fn::GetAtt": ["ApplicationLoadBalancer", "LoadBalancerFullName"]}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "ALB5XXErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {"Fn::Sub": "alb-5xx-errors-${EnvironmentSuffix}"},
        "AlarmDescription": "Alert when ALB returns 5XX errors",
        "MetricName": "HTTPCode_Target_5XX_Count",
        "Namespace": "AWS/ApplicationELB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10.0,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "LoadBalancer",
            "Value": {"Fn::GetAtt": ["ApplicationLoadBalancer", "LoadBalancerFullName"]}
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    
    "ApplicationDashboard": {
      "Type": "AWS::CloudWatch::Dashboard",
      "Properties": {
        "DashboardName": {"Fn::Sub": "application-dashboard-${EnvironmentSuffix}"},
        "DashboardBody": {
          "Fn::Sub": [
            "{\"widgets\":[{\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/ApplicationELB\",\"TargetResponseTime\",{\"stat\":\"Average\"}]],\"period\":300,\"stat\":\"Average\",\"region\":\"${AWS::Region}\",\"title\":\"ALB Response Time\"}},{\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/ApplicationELB\",\"RequestCount\",{\"stat\":\"Sum\",\"label\":\"Total Requests\"}],[\"AWS/ApplicationELB\",\"HTTPCode_Target_2XX_Count\",{\"stat\":\"Sum\",\"label\":\"2XX\"}],[\"AWS/ApplicationELB\",\"HTTPCode_Target_5XX_Count\",{\"stat\":\"Sum\",\"label\":\"5XX\"}]],\"period\":300,\"stat\":\"Sum\",\"region\":\"${AWS::Region}\",\"title\":\"ALB Traffic\"}},{\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/ECS\",\"CPUUtilization\",{\"stat\":\"Average\"}],[\"AWS/ECS\",\"MemoryUtilization\",{\"stat\":\"Average\"}]],\"period\":300,\"stat\":\"Average\",\"region\":\"${AWS::Region}\",\"title\":\"ECS Metrics\"}},{\"type\":\"metric\",\"properties\":{\"metrics\":[[\"AWS/RDS\",\"CPUUtilization\",{\"stat\":\"Average\"}],[\"AWS/RDS\",\"DatabaseConnections\",{\"stat\":\"Average\"}]],\"period\":300,\"stat\":\"Average\",\"region\":\"${AWS::Region}\",\"title\":\"RDS Metrics\"}}]}",
            {}
          ]
        }
      }
    }
  },
  
  "Outputs": {
    "VPCId": {
      "Description": "VPC ID for the infrastructure",
      "Value": {"Ref": "VPC"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-VPCId"}}
    },
    "ALBDNSName": {
      "Description": "Application Load Balancer DNS name",
      "Value": {"Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-ALBDNSName"}}
    },
    "ApplicationURL": {
      "Description": "Application URL",
      "Condition": "HasMonitoring",
      "Value": {
        "Fn::Sub": "http://app-${EnvironmentName}.${DomainName}"
      }
    },
    "ECSClusterName": {
      "Description": "ECS Cluster Name",
      "Value": {"Ref": "ECSCluster"},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-ECSClusterName"}}
    },
    "ECSClusterArn": {
      "Description": "ARN of the ECS cluster",
      "Value": {"Fn::GetAtt": ["ECSCluster", "Arn"]}
    },
    "ECSServiceName": {
      "Description": "Name of the ECS service",
      "Value": {"Fn::GetAtt": ["ECSService", "Name"]}
    },
    "ECRRepositoryURI": {
      "Description": "ECR repository URI for Docker images",
      "Value": {
        "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}"
      }
    },
    "RDSEndpoint": {
      "Description": "RDS PostgreSQL Instance Endpoint",
      "Value": {"Fn::GetAtt": ["DBInstance", "Endpoint.Address"]},
      "Export": {"Name": {"Fn::Sub": "${AWS::StackName}-RDSEndpoint"}}
    },
    "RDSPort": {
      "Description": "RDS PostgreSQL Instance Port",
      "Value": {"Fn::GetAtt": ["DBInstance", "Endpoint.Port"]}
    },
    "DBName": {
      "Description": "Database name",
      "Value": "appdb"
    },
    "DBMasterPasswordSecretArn": {
      "Description": "ARN of database master password secret",
      "Value": {"Ref": "DBMasterPasswordSecret"}
    },
    "AppSecretsArn": {
      "Description": "ARN of application secrets",
      "Value": {"Ref": "AppSecrets"}
    },
    "KMSKeyId": {
      "Description": "KMS Key ID for RDS encryption",
      "Value": {"Ref": "RDSEncryptionKey"}
    },
    "ApplicationDashboardURL": {
      "Description": "CloudWatch Dashboard URL for application monitoring",
      "Value": {
        "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=application-dashboard-${EnvironmentSuffix}"
      }
    }
  }
}

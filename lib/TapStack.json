{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Serverless infrastructure with S3 triggers, Lambda processing, API Gateway, and DynamoDB",
    "Parameters": {
        "BucketName": {
            "Type": "String",
            "Default": "serverless-processing-bucket",
            "Description": "S3 bucket name for file uploads"
        },
        "TableName": {
            "Type": "String",
            "Default": "ProcessingTable",
            "Description": "DynamoDB table name"
        },
        "Environment": {
            "Type": "String",
            "Default": "Production",
            "Description": "Environment tag for all resources"
        }
    },
    "Resources": {
        "ProcessingBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${BucketName}-${AWS::AccountId}-${AWS::Region}"
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LambdaInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "ProcessingFunction",
                        "Arn"
                    ]
                },
                "Principal": "s3.amazonaws.com",
                "SourceAccount": {
                    "Ref": "AWS::AccountId"
                },
                "SourceArn": {
                    "Fn::Sub": "arn:aws:s3:::${BucketName}-${AWS::AccountId}-${AWS::Region}"
                }
            }
        },
        "ProcessingTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "${TableName}-${AWS::AccountId}"
                },
                "BillingMode": "PAY_PER_REQUEST",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "PartitionKey",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "SortKey",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "PartitionKey",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "SortKey",
                        "KeyType": "RANGE"
                    }
                ],
                "StreamSpecification": {
                    "StreamViewType": "NEW_AND_OLD_IMAGES"
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "LambdaExecutionRole-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "DynamoDBAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:GetItem",
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:DeleteItem",
                                        "dynamodb:Query",
                                        "dynamodb:Scan"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ProcessingTable",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "S3Access",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:GetObjectVersion"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:s3:::${BucketName}-${AWS::AccountId}-${AWS::Region}/*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProcessingFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "ProcessingFunction-${AWS::StackName}"
                },
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "MemorySize": 256,
                "ReservedConcurrentExecutions": 50,
                "Environment": {
                    "Variables": {
                        "TABLE_NAME": {
                            "Ref": "ProcessingTable"
                        },
                        "BUCKET_NAME": {
                            "Fn::Sub": "${BucketName}-${AWS::AccountId}-${AWS::Region}"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom datetime import datetime\nimport uuid\n\ndef lambda_handler(event, context):\n    dynamodb = boto3.resource('dynamodb')\n    s3 = boto3.client('s3')\n    table = dynamodb.Table(os.environ['TABLE_NAME'])\n    \n    try:\n        # Handle S3 trigger event\n        if 'Records' in event:\n            for record in event['Records']:\n                if 's3' in record:\n                    bucket_name = record['s3']['bucket']['name']\n                    object_key = record['s3']['object']['key']\n                    \n                    # Get object metadata\n                    s3_response = s3.head_object(Bucket=bucket_name, Key=object_key)\n                    \n                    # Store processing record in DynamoDB\n                    table.put_item(\n                        Item={\n                            'PartitionKey': f\"file#{object_key}\",\n                            'SortKey': f\"processed#{datetime.utcnow().isoformat()}\",\n                            'bucket_name': bucket_name,\n                            'object_key': object_key,\n                            'file_size': s3_response.get('ContentLength', 0),\n                            'processed_at': datetime.utcnow().isoformat(),\n                            'processing_id': str(uuid.uuid4()),\n                            'status': 'processed'\n                        }\n                    )\n        \n        # Handle API Gateway event\n        elif 'httpMethod' in event:\n            # API Gateway request processing\n            http_method = event['httpMethod']\n            path = event['path']\n            \n            if http_method == 'GET':\n                # Query recent processing records\n                response = table.scan(\n                    FilterExpression='attribute_exists(#status)',\n                    ExpressionAttributeNames={'#status': 'status'},\n                    Limit=10\n                )\n                \n                return {\n                    'statusCode': 200,\n                    'headers': {\n                        'Content-Type': 'application/json',\n                        'Access-Control-Allow-Origin': '*'\n                    },\n                    'body': json.dumps({\n                        'message': 'Processing records retrieved successfully',\n                        'records': response.get('Items', [])\n                    })\n                }\n            \n            elif http_method == 'POST':\n                # Create new processing record\n                body = json.loads(event.get('body', '{}'))\n                \n                table.put_item(\n                    Item={\n                        'PartitionKey': f\"manual#{body.get('key', str(uuid.uuid4()))}\",\n                        'SortKey': f\"created#{datetime.utcnow().isoformat()}\",\n                        'data': body,\n                        'created_at': datetime.utcnow().isoformat(),\n                        'processing_id': str(uuid.uuid4()),\n                        'status': 'manual'\n                    }\n                )\n                \n                return {\n                    'statusCode': 201,\n                    'headers': {\n                        'Content-Type': 'application/json',\n                        'Access-Control-Allow-Origin': '*'\n                    },\n                    'body': json.dumps({\n                        'message': 'Record created successfully',\n                        'processing_id': str(uuid.uuid4())\n                    })\n                }\n        \n        return {\n            'statusCode': 200,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({'message': 'Event processed successfully'})\n        }\n        \n    except Exception as e:\n        print(f\"Error processing event: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({'error': str(e)})\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ProcessingApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "ProcessingApi-${AWS::StackName}"
                },
                "Description": "API Gateway for serverless processing infrastructure",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "ApiResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "ProcessingApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "ProcessingApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "process"
            }
        },
        "ApiGetMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ProcessingApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ProcessingFunction.Arn}/invocations"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseModels": {
                            "application/json": "Empty"
                        },
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Origin": true
                        }
                    }
                ]
            }
        },
        "ApiPostMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ProcessingApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ProcessingFunction.Arn}/invocations"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 201,
                        "ResponseModels": {
                            "application/json": "Empty"
                        },
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Origin": true
                        }
                    }
                ]
            }
        },
        "ApiOptionsMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ProcessingApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "OPTIONS",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "MOCK",
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200,
                            "ResponseParameters": {
                                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
                                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,OPTIONS'",
                                "method.response.header.Access-Control-Allow-Origin": "'*'"
                            }
                        }
                    ],
                    "RequestTemplates": {
                        "application/json": "{\"statusCode\": 200}"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Headers": true,
                            "method.response.header.Access-Control-Allow-Methods": true,
                            "method.response.header.Access-Control-Allow-Origin": true
                        }
                    }
                ]
            }
        },
        "ApiGatewayInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "ProcessingFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ProcessingApi}/*/POST/process"
                }
            }
        },
        "ApiGatewayGetInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "ProcessingFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ProcessingApi}/*/GET/process"
                }
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "ApiGetMethod",
                "ApiPostMethod",
                "ApiOptionsMethod"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "ProcessingApi"
                },
                "StageName": "prod",
                "StageDescription": {
                    "Description": "Production stage for serverless processing API"
                }
            }
        },
        "S3ConfigurationFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "S3ConfigurationFunction-${AWS::StackName}"
                },
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "S3ConfigurationRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport cfnresponse\n\ndef lambda_handler(event, context):\n    try:\n        request_type = event['RequestType']\n        bucket_name = event['ResourceProperties']['BucketName']\n        lambda_arn = event['ResourceProperties']['LambdaArn']\n        \n        s3 = boto3.client('s3')\n        \n        if request_type in ['Create', 'Update']:\n            # Configure S3 bucket notification\n            notification_config = {\n                'LambdaFunctionConfigurations': [\n                    {\n                        'LambdaFunctionArn': lambda_arn,\n                        'Events': ['s3:ObjectCreated:*']\n                    }\n                ]\n            }\n            s3.put_bucket_notification_configuration(\n                Bucket=bucket_name,\n                NotificationConfiguration=notification_config\n            )\n            print(f\"Successfully configured S3 bucket notification for {bucket_name}\")\n        elif request_type == 'Delete':\n            # Remove notification configuration\n            s3.put_bucket_notification_configuration(\n                Bucket=bucket_name,\n                NotificationConfiguration={}\n            )\n            print(f\"Successfully removed S3 bucket notification for {bucket_name}\")\n        \n        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n    except Exception as e:\n        print(f\"Error: {str(e)}\")\n        cfnresponse.send(event, context, cfnresponse.FAILED, {})\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "S3ConfigurationRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "S3ConfigurationRole-${AWS::StackName}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3ConfigurationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetBucketNotification",
                                        "s3:PutBucketNotification"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ProcessingBucket",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "S3BucketNotificationConfig": {
            "Type": "Custom::S3BucketNotification",
            "DependsOn": [
                "LambdaInvokePermission"
            ],
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "S3ConfigurationFunction",
                        "Arn"
                    ]
                },
                "BucketName": {
                    "Ref": "ProcessingBucket"
                },
                "LambdaArn": {
                    "Fn::GetAtt": [
                        "ProcessingFunction",
                        "Arn"
                    ]
                }
            }
        }
    },
    "Outputs": {
        "S3BucketName": {
            "Description": "Name of the S3 bucket",
            "Value": {
                "Ref": "ProcessingBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3BucketName"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "Name of the DynamoDB table",
            "Value": {
                "Ref": "ProcessingTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableName"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the Lambda function",
            "Value": {
                "Ref": "ProcessingFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunctionName"
                }
            }
        },
        "ApiGatewayUrl": {
            "Description": "API Gateway endpoint URL",
            "Value": {
                "Fn::Sub": "https://${ProcessingApi}.execute-api.${AWS::Region}.amazonaws.com/prod/process"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayUrl"
                }
            }
        },
        "ApiGatewayRestApiId": {
            "Description": "API Gateway REST API ID",
            "Value": {
                "Ref": "ProcessingApi"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayRestApiId"
                }
            }
        }
    }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Serverless application infrastructure with Lambda, API Gateway, and DynamoDB",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "AllowedValues": [
                "dev",
                "stage",
                "prod"
            ],
            "Default": "dev",
            "Description": "Deployment environment"
        },
        "LogLevel": {
            "Type": "String",
            "AllowedValues": [
                "INFO",
                "WARN",
                "ERROR"
            ],
            "Default": "INFO",
            "Description": "Lambda function log level"
        },
        "SNSEmail": {
            "Type": "String",
            "Default": "no-reply@example.com",
            "Description": "Email address for SNS notifications",
            "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
            "ConstraintDescription": "Must be a valid email address"
        }
    },
    "Resources": {
        "DynamoDBEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS Key for DynamoDB table encryption",
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow DynamoDB Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "dynamodb.amazonaws.com"
                            },
                            "Action": [
                                "kms:GenerateDataKey",
                                "kms:Decrypt"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "DynamoDB Encryption"
                    }
                ]
            }
        },
        "DynamoDBEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${AWS::StackName}-dynamodb-key"
                },
                "TargetKeyId": {
                    "Ref": "DynamoDBEncryptionKey"
                }
            }
        },
        "DataTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "${AWS::StackName}-data-table"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "timestamp",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 5,
                    "WriteCapacityUnits": 5
                },
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": {
                        "Fn::GetAtt": [
                            "DynamoDBEncryptionKey",
                            "Arn"
                        ]
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "Application Data Storage"
                    }
                ]
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${AWS::StackName}-data-processor"
                },
                "RetentionInDays": 14
            }
        },
        "ApiGatewayLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/apigateway/${AWS::StackName}-api-access-logs"
                },
                "RetentionInDays": 14
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudWatchLogsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:us-east-1:${AWS::AccountId}:log-group:/aws/lambda/${AWS::StackName}-data-processor:*"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "DynamoDBPutItemPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:PutItem"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DataTable",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "KMSAccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DynamoDBEncryptionKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "DataProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": "LambdaLogGroup",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${AWS::StackName}-data-processor"
                },
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 30,
                "MemorySize": 128,
                "Environment": {
                    "Variables": {
                        "STAGE": {
                            "Ref": "Environment"
                        },
                        "DYNAMODB_TABLE_NAME": {
                            "Ref": "DataTable"
                        },
                        "LOG_LEVEL": {
                            "Ref": "LogLevel"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport uuid\nimport os\nfrom datetime import datetime\nimport logging\n\n# Configure logging\nlogger = logging.getLogger()\nlogger.setLevel(os.environ.get('LOG_LEVEL', 'INFO'))\n\n# Initialize DynamoDB client\ndynamodb = boto3.resource('dynamodb', region_name='us-east-1')\ntable_name = os.environ['DYNAMODB_TABLE_NAME']\ntable = dynamodb.Table(table_name)\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Lambda handler for processing HTTP POST requests\n    Generates unique ID, stores data in DynamoDB, returns success response\n    \"\"\"\n    try:\n        logger.info(f\"Processing request: {event}\")\n        \n        # Parse request body\n        if 'body' not in event or not event['body']:\n            return {\n                'statusCode': 400,\n                'headers': {\n                    'Content-Type': 'application/json',\n                    'Access-Control-Allow-Origin': '*'\n                },\n                'body': json.dumps({\n                    'error': 'Request body is required'\n                })\n            }\n        \n        # Generate unique ID and timestamp\n        unique_id = str(uuid.uuid4())\n        timestamp = datetime.utcnow().isoformat() + 'Z'\n        \n        # Parse request body (handle both string and dict)\n        request_body = event['body']\n        if isinstance(request_body, str):\n            try:\n                request_data = json.loads(request_body)\n            except json.JSONDecodeError:\n                request_data = {'raw_data': request_body}\n        else:\n            request_data = request_body\n        \n        # Prepare item for DynamoDB\n        item = {\n            'id': unique_id,\n            'timestamp': timestamp,\n            'data': request_data,\n            'stage': os.environ['STAGE']\n        }\n        \n        # Store in DynamoDB\n        table.put_item(Item=item)\n        \n        logger.info(f\"Successfully stored item with ID: {unique_id}\")\n        \n        # Return success response\n        return {\n            'statusCode': 200,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({\n                'message': 'Data processed successfully',\n                'id': unique_id,\n                'timestamp': timestamp\n            })\n        }\n        \n    except Exception as e:\n        logger.error(f\"Error processing request: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': {\n                'Content-Type': 'application/json',\n                'Access-Control-Allow-Origin': '*'\n            },\n            'body': json.dumps({\n                'error': 'Internal server error',\n                'message': str(e)\n            })\n        }\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "LambdaApiGatewayPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "DataProcessorFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:us-east-1:${AWS::AccountId}:${DataApi}/*/*"
                }
            }
        },
        "DataApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-data-api"
                },
                "Description": "REST API for serverless data processing application",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "DataResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "DataApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "DataApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "data"
            }
        },
        "DataPostMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "DataApi"
                },
                "ResourceId": {
                    "Ref": "DataResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/${DataProcessorFunction.Arn}/invocations"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": 400,
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    },
                    {
                        "StatusCode": 500,
                        "ResponseModels": {
                            "application/json": "Empty"
                        }
                    }
                ]
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "DataPostMethod"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "DataApi"
                },
                "Description": {
                    "Fn::Sub": "Deployment for ${Environment} environment"
                }
            }
        },
        "ApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "RestApiId": {
                    "Ref": "DataApi"
                },
                "DeploymentId": {
                    "Ref": "ApiDeployment"
                },
                "StageName": {
                    "Ref": "Environment"
                },
                "Description": {
                    "Fn::Sub": "API Gateway stage for ${Environment} environment"
                },
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "ThrottlingBurstLimit": 50,
                        "ThrottlingRateLimit": 100,
                        "MetricsEnabled": true,
                        "DataTraceEnabled": false,
                        "LoggingLevel": "INFO"
                    }
                ],
                "AccessLogSetting": {
                    "DestinationArn": {
                        "Fn::GetAtt": [
                            "ApiGatewayLogGroup",
                            "Arn"
                        ]
                    },
                    "Format": "$context.requestId $requestTime $httpMethod $resourcePath $status $responseLength $responseTime"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "AlarmNotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${AWS::StackName}-lambda-error-alerts"
                },
                "DisplayName": "Lambda Error Alerts",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "AlarmNotificationSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "TopicArn": {
                    "Ref": "AlarmNotificationTopic"
                },
                "Protocol": "email",
                "Endpoint": {
                    "Ref": "SNSEmail"
                }
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${AWS::StackName}-lambda-errors"
                },
                "AlarmDescription": "Alarm for Lambda function errors",
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 0,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "DataProcessorFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "AlarmNotificationTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "ApiGatewayUrl": {
            "Description": "API Gateway endpoint URL",
            "Value": {
                "Fn::Sub": "https://${DataApi}.execute-api.us-east-1.amazonaws.com/${Environment}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayUrl"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "Lambda function ARN",
            "Value": {
                "Fn::GetAtt": [
                    "DataProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunctionArn"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "DynamoDB table name",
            "Value": {
                "Ref": "DataTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableName"
                }
            }
        },
        "CloudWatchAlarmName": {
            "Description": "CloudWatch alarm name for Lambda errors",
            "Value": {
                "Ref": "LambdaErrorAlarm"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudWatchAlarmName"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for DynamoDB encryption",
            "Value": {
                "Ref": "DynamoDBEncryptionKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyId"
                }
            }
        },
        "SNSTopicArn": {
            "Description": "SNS Topic ARN for alarm notifications",
            "Value": {
                "Ref": "AlarmNotificationTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SNSTopicArn"
                }
            }
        }
    }
}
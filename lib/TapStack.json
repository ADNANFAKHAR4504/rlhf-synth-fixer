{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploys a highly available and scalable Node.js web application using AWS Elastic Beanstalk. This template configures an Application Load Balancer, Auto Scaling, and HTTPS.\n",
    "Parameters": {
        "ApplicationName": {
            "Type": "String",
            "Description": "The name of the Elastic Beanstalk application.",
            "Default": "MyNodeJsApp"
        },
        "InstanceType": {
            "Type": "String",
            "Description": "EC2 instance type for the web application servers.",
            "Default": "t3.micro",
            "AllowedValues": [
                "t2.micro",
                "t3.micro",
                "t3.small",
                "m5.large"
            ]
        },
        "KeyPairName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "The name of an existing EC2 KeyPair to enable SSH access to the instances.",
            "Default": "your-dev-key"
        },
        "SSLCertificateArn": {
            "Type": "String",
            "Description": "The ARN of an existing ACM SSL certificate in us-east-1 for HTTPS.",
            "Default": "arn:aws:acm:us-east-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
        }
    },
    "Resources": {
        "WebAppApplication": {
            "Type": "AWS::ElasticBeanstalk::Application",
            "Properties": {
                "ApplicationName": {
                    "Ref": "ApplicationName"
                },
                "Description": "AWS Elastic Beanstalk application for our Node.js app."
            }
        },
        "WebAppEnvironment": {
            "Type": "AWS::ElasticBeanstalk::Environment",
            "Properties": {
                "ApplicationName": {
                    "Ref": "WebAppApplication"
                },
                "Description": "Environment for the Node.js web application",
                "SolutionStackName": "64bit Amazon Linux 2 v5.8.0 running Node.js 18",
                "OptionSettings": [
                    {
                        "Namespace": "aws:autoscaling:launchconfiguration",
                        "OptionName": "InstanceType",
                        "Value": {
                            "Ref": "InstanceType"
                        }
                    },
                    {
                        "Namespace": "aws:autoscaling:launchconfiguration",
                        "OptionName": "EC2KeyName",
                        "Value": {
                            "Ref": "KeyPairName"
                        }
                    },
                    {
                        "Namespace": "aws:elasticbeanstalk:environment",
                        "OptionName": "EnvironmentType",
                        "Value": "LoadBalanced"
                    },
                    {
                        "Namespace": "aws:elasticbeanstalk:environment",
                        "OptionName": "LoadBalancerType",
                        "Value": "application"
                    },
                    {
                        "Namespace": "aws:autoscaling:asg",
                        "OptionName": "MinSize",
                        "Value": "2"
                    },
                    {
                        "Namespace": "aws:autoscaling:asg",
                        "OptionName": "MaxSize",
                        "Value": "10"
                    },
                    {
                        "Namespace": "aws:elbv2:listener:443",
                        "OptionName": "Protocol",
                        "Value": "HTTPS"
                    },
                    {
                        "Namespace": "aws:elbv2:listener:443",
                        "OptionName": "SSLCertificateArns",
                        "Value": {
                            "Ref": "SSLCertificateArn"
                        }
                    },
                    {
                        "Namespace": "aws:elbv2:listener:default",
                        "OptionName": "ListenerEnabled",
                        "Value": "true"
                    },
                    {
                        "Namespace": "aws:elasticbeanstalk:application:environment",
                        "OptionName": "ELBScheme",
                        "Value": "public"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "EnvironmentURL": {
            "Description": "The URL of the new Elastic Beanstalk environment.",
            "Value": {
                "Fn::Sub": "https://${WebAppEnvironment.EndpointURL}"
            }
        }
    }
}
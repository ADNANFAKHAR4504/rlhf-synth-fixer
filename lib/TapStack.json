{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TapStack.yml — Secure and compliant production environment in us-east-1. Enforces least-privilege IAM roles, encrypted EC2 EBS volumes, S3 bucket SSE, IP-range–restricted access (default 192.168.0.0/16), CloudTrail->CloudWatch logging, production tagging, RDS in a predefined VPC, Lambda with >=128MB, and no public SSH.\n",
    "Parameters": {
        "NamePrefix": {
            "Type": "String",
            "Default": "prod",
            "AllowedPattern": "^[a-z0-9-]+$",
            "Description": "Naming prefix (must follow prod-* convention; default \"prod\")."
        },
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "AllowedPattern": "^[a-z0-9-]+$",
            "Description": "Environment suffix for unique naming."
        },
        "AllowedIpCidr": {
            "Type": "String",
            "Default": "192.168.0.0/16",
            "Description": "IP range allowed to access resources (no public access)."
        },
        "VpcId": {
            "Type": "String",
            "Default": "",
            "Description": "Predefined VPC ID where resources will be deployed. Leave empty to use default VPC."
        },
        "PrivateSubnetIds": {
            "Type": "CommaDelimitedList",
            "Default": "",
            "Description": "Private subnet IDs for EC2 and RDS. Leave empty to use default subnets."
        },
        "LambdaSubnetIds": {
            "Type": "CommaDelimitedList",
            "Default": "",
            "Description": "Private subnet IDs for Lambda. Leave empty to use default subnets."
        },
        "EC2AmiId": {
            "Type": "String",
            "Default": "",
            "Description": "AMI ID for EC2 instance. Leave empty to use latest Amazon Linux 2023."
        },
        "EC2InstanceType": {
            "Type": "String",
            "Default": "t3.micro",
            "AllowedValues": [
                "t3.micro",
                "t3.small",
                "t3.medium",
                "t3.large",
                "m6i.large",
                "m6i.xlarge"
            ],
            "Description": "Instance type for EC2."
        },
        "TrailBucketName": {
            "Type": "String",
            "Default": "",
            "Description": "S3 bucket name for CloudTrail logs. Leave empty to auto-generate."
        },
        "DBEngine": {
            "Type": "String",
            "Default": "postgres",
            "AllowedValues": [
                "postgres",
                "mysql"
            ]
        },
        "DBEngineVersion": {
            "Type": "String",
            "Default": "15.5",
            "Description": "Engine version (e.g., Postgres 15.x or MySQL 8.x)."
        },
        "DBInstanceClass": {
            "Type": "String",
            "Default": "db.t3.micro"
        },
        "DBAllocatedStorage": {
            "Type": "Number",
            "Default": 20,
            "MinValue": 20,
            "MaxValue": 16384
        },
        "DBUsername": {
            "Type": "String",
            "Default": "dbadmin",
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9_]+$",
            "Description": "Master username for the database."
        },
        "AppBucketName": {
            "Type": "String",
            "Default": "",
            "Description": "S3 bucket name for application data. Leave empty to auto-generate."
        },
        "ExistingDBParameterGroupName": {
            "Type": "String",
            "Default": "",
            "Description": "Optional: Use an existing DB parameter group instead of creating a new one."
        },
        "IsEphemeral": {
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "If true, ephemeral stacks skip creating DBParameterGroup to avoid hitting quota."
        }
    },
    "Mappings": {
        "EngineFamily": {
            "postgres": {
                "Family": "postgres15",
                "SslParamName": "rds.force_ssl",
                "SslParamValue": "1"
            },
            "mysql": {
                "Family": "mysql8.0",
                "SslParamName": "require_secure_transport",
                "SslParamValue": "ON"
            }
        },
        "RegionMap": {
            "us-east-1": {
                "AMI": "ami-0230bd60aa48260c6"
            }
        }
    },
    "Conditions": {
        "IsPostgres": {
            "Fn::Equals": [
                {
                    "Ref": "DBEngine"
                },
                "postgres"
            ]
        },
        "HasVpcId": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "VpcId"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasPrivateSubnets": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Fn::Join": [
                                "",
                                {
                                    "Ref": "PrivateSubnetIds"
                                }
                            ]
                        },
                        ""
                    ]
                }
            ]
        },
        "HasLambdaSubnets": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Fn::Join": [
                                "",
                                {
                                    "Ref": "LambdaSubnetIds"
                                }
                            ]
                        },
                        ""
                    ]
                }
            ]
        },
        "HasAmiId": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EC2AmiId"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasTrailBucket": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "TrailBucketName"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasAppBucket": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AppBucketName"
                        },
                        ""
                    ]
                }
            ]
        },
        "UseDefaultVpc": {
            "Fn::Not": [
                {
                    "Condition": "HasVpcId"
                }
            ]
        },
        "UseDefaultSubnets": {
            "Fn::And": [
                {
                    "Fn::Not": [
                        {
                            "Condition": "HasPrivateSubnets"
                        }
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Condition": "HasVpcId"
                        }
                    ]
                }
            ]
        },
        "HasExistingDBParameterGroup": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "ExistingDBParameterGroupName"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateDBParameterGroup": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "IsEphemeral"
                        },
                        "false"
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Condition": "HasExistingDBParameterGroup"
                        }
                    ]
                }
            ]
        }
    },
    "Resources": {
        "DefaultVpcLookup": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Condition": "UseDefaultVpc",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "VpcLookupFunction",
                        "Arn"
                    ]
                }
            }
        },
        "VpcLookupFunction": {
            "Type": "AWS::Lambda::Function",
            "Condition": "UseDefaultVpc",
            "Properties": {
                "Runtime": "python3.12",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "VpcLookupRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "import boto3\nimport cfnresponse\ndef handler(event, context):\n    try:\n        ec2 = boto3.client('ec2')\n        vpcs = ec2.describe_vpcs(Filters=[{'Name': 'isDefault', 'Values': ['true']}])\n        if vpcs['Vpcs']:\n            vpc_id = vpcs['Vpcs'][0]['VpcId']\n            subnets = ec2.describe_subnets(Filters=[{'Name': 'vpc-id', 'Values': [vpc_id]}])\n            subnet_ids = [s['SubnetId'] for s in subnets['Subnets'][:2]]\n            cfnresponse.send(event, context, cfnresponse.SUCCESS, {\n                'VpcId': vpc_id,\n                'SubnetIds': ','.join(subnet_ids)\n            })\n        else:\n            cfnresponse.send(event, context, cfnresponse.FAILED, {}, \"No default VPC found\")\n    except Exception as e:\n        cfnresponse.send(event, context, cfnresponse.FAILED, {}, str(e))\n"
                }
            }
        },
        "VpcLookupRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "UseDefaultVpc",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "VpcLookup",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:DescribeVpcs",
                                        "ec2:DescribeSubnets"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "TrailBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::If": [
                        "HasTrailBucket",
                        {
                            "Ref": "TrailBucketName"
                        },
                        {
                            "Fn::Sub": "${NamePrefix}-cloudtrail-${EnvironmentSuffix}-${AWS::AccountId}"
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "TrailBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "TrailBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:GetBucketAcl"
                            ],
                            "Resource": [
                                {
                                    "Fn::Sub": "${TrailBucket}"
                                },
                                {
                                    "Fn::Sub": "${TrailBucket}/AWSLogs/${AWS::AccountId}/*"
                                }
                            ],
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "IpRestrictAdminAccess",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "${TrailBucket}"
                                },
                                {
                                    "Fn::Sub": "${TrailBucket}/*"
                                }
                            ],
                            "Condition": {
                                "NotIpAddress": {
                                    "aws:SourceIp": {
                                        "Ref": "AllowedIpCidr"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AppBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::If": [
                        "HasAppBucket",
                        {
                            "Ref": "AppBucketName"
                        },
                        {
                            "Fn::Sub": "${NamePrefix}-app-${EnvironmentSuffix}-${AWS::AccountId}"
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "AppBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "AppBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnforceTls",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "${AppBucket}"
                                },
                                {
                                    "Fn::Sub": "${AppBucket}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "IpRestrict",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::Sub": "${AppBucket}"
                                },
                                {
                                    "Fn::Sub": "${AppBucket}/*"
                                }
                            ],
                            "Condition": {
                                "NotIpAddress": {
                                    "aws:SourceIp": {
                                        "Ref": "AllowedIpCidr"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "TrailLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/cloudtrail/${NamePrefix}-api-activity-${EnvironmentSuffix}"
                },
                "RetentionInDays": 365,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "CloudTrailToCWLRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${NamePrefix}-cloudtrail-to-cwl-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudTrailToCWL",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "TrailLogGroup",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "OrgCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "Properties": {
                "TrailName": {
                    "Fn::Sub": "${NamePrefix}-api-activity-${EnvironmentSuffix}"
                },
                "S3BucketName": {
                    "Ref": "TrailBucket"
                },
                "IsLogging": true,
                "IncludeGlobalServiceEvents": true,
                "IsMultiRegionTrail": true,
                "EnableLogFileValidation": true,
                "CloudWatchLogsLogGroupArn": {
                    "Fn::GetAtt": [
                        "TrailLogGroup",
                        "Arn"
                    ]
                },
                "CloudWatchLogsRoleArn": {
                    "Fn::GetAtt": [
                        "CloudTrailToCWLRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Ec2SecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${NamePrefix} EC2 SG - no public SSH"
                },
                "VpcId": {
                    "Fn::If": [
                        "HasVpcId",
                        {
                            "Ref": "VpcId"
                        },
                        {
                            "Fn::GetAtt": [
                                "DefaultVpcLookup",
                                "VpcId"
                            ]
                        }
                    ]
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "AllowedIpCidr"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-ec2-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "RdsSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${NamePrefix} RDS SG - restricted client access"
                },
                "VpcId": {
                    "Fn::If": [
                        "HasVpcId",
                        {
                            "Ref": "VpcId"
                        },
                        {
                            "Fn::GetAtt": [
                                "DefaultVpcLookup",
                                "VpcId"
                            ]
                        }
                    ]
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": {
                            "Fn::If": [
                                "IsPostgres",
                                5432,
                                3306
                            ]
                        },
                        "ToPort": {
                            "Fn::If": [
                                "IsPostgres",
                                5432,
                                3306
                            ]
                        },
                        "CidrIp": {
                            "Ref": "AllowedIpCidr"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-rds-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": {
                    "Fn::Sub": "${NamePrefix} Lambda SG - restricted egress"
                },
                "VpcId": {
                    "Fn::If": [
                        "HasVpcId",
                        {
                            "Ref": "VpcId"
                        },
                        {
                            "Fn::GetAtt": [
                                "DefaultVpcLookup",
                                "VpcId"
                            ]
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-lambda-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Ec2Instance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "Comment": "Encrypted root volume; no public IP; SSH allowed only from AllowedIpCidr via SG."
            },
            "Properties": {
                "ImageId": {
                    "Fn::If": [
                        "HasAmiId",
                        {
                            "Ref": "EC2AmiId"
                        },
                        {
                            "Fn::FindInMap": [
                                "RegionMap",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "AMI"
                            ]
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "EC2InstanceType"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "Ec2SecurityGroup"
                    }
                ],
                "SubnetId": {
                    "Fn::If": [
                        "HasPrivateSubnets",
                        {
                            "Fn::Select": [
                                0,
                                {
                                    "Ref": "PrivateSubnetIds"
                                }
                            ]
                        },
                        {
                            "Fn::If": [
                                "UseDefaultVpc",
                                {
                                    "Fn::Select": [
                                        0,
                                        {
                                            "Fn::Split": [
                                                ",",
                                                {
                                                    "Fn::GetAtt": [
                                                        "DefaultVpcLookup",
                                                        "SubnetIds"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": 16,
                            "VolumeType": "gp3",
                            "Encrypted": true
                        }
                    }
                ],
                "IamInstanceProfile": {
                    "Ref": "Ec2MinimalInstanceProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-ec2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Ec2MinimalInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${NamePrefix}-ec2-minimal-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "EC2CWLogsMinimal",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "CreateOwnLogStream",
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:CreateLogGroup"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${NamePrefix}-*"
                                    }
                                },
                                {
                                    "Sid": "PutLogEvents",
                                    "Effect": "Allow",
                                    "Action": "logs:PutLogEvents",
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${NamePrefix}-*:log-stream:*"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Ec2MinimalInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "Ec2MinimalInstanceRole"
                    }
                ]
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Condition": "HasPrivateSubnets",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "${NamePrefix} RDS subnet group"
                },
                "SubnetIds": {
                    "Ref": "PrivateSubnetIds"
                },
                "DBSubnetGroupName": {
                    "Fn::Sub": "${NamePrefix}-db-subnets-${EnvironmentSuffix}"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-db-subnets-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DefaultDBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Condition": "UseDefaultSubnets",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "${NamePrefix} RDS subnet group - default VPC"
                },
                "SubnetIds": {
                    "Fn::Split": [
                        ",",
                        {
                            "Fn::GetAtt": [
                                "DefaultVpcLookup",
                                "SubnetIds"
                            ]
                        }
                    ]
                },
                "DBSubnetGroupName": {
                    "Fn::Sub": "${NamePrefix}-db-subnets-default-${EnvironmentSuffix}"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-db-subnets-default-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DBPasswordSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${NamePrefix}-db-password-${EnvironmentSuffix}"
                },
                "Description": {
                    "Fn::Sub": "Database password for ${NamePrefix} RDS instance"
                },
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\": \"dbadmin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "DBParameterGroup": {
            "Condition": "CreateDBParameterGroup",
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "${NamePrefix} parameter group to enforce TLS"
                },
                "Family": {
                    "Fn::FindInMap": [
                        "EngineFamily",
                        {
                            "Ref": "DBEngine"
                        },
                        "Family"
                    ]
                },
                "Parameters": {
                    "Fn::If": [
                        "IsPostgres",
                        {
                            "rds.force_ssl": "1"
                        },
                        {
                            "require_secure_transport": "ON"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Database": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${NamePrefix}-db-${EnvironmentSuffix}"
                },
                "AllocatedStorage": {
                    "Ref": "DBAllocatedStorage"
                },
                "DBInstanceClass": {
                    "Ref": "DBInstanceClass"
                },
                "Engine": {
                    "Ref": "DBEngine"
                },
                "EngineVersion": {
                    "Ref": "DBEngineVersion"
                },
                "MasterUsername": {
                    "Ref": "DBUsername"
                },
                "ManageMasterUserPassword": true,
                "StorageEncrypted": true,
                "PubliclyAccessible": false,
                "VPCSecurityGroups": [
                    {
                        "Ref": "RdsSecurityGroup"
                    }
                ],
                "DBSubnetGroupName": {
                    "Fn::If": [
                        "HasPrivateSubnets",
                        {
                            "Ref": "DBSubnetGroup"
                        },
                        {
                            "Fn::If": [
                                "UseDefaultSubnets",
                                {
                                    "Ref": "DefaultDBSubnetGroup"
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                },
                "DBParameterGroupName": {
                    "Fn::If": [
                        "HasExistingDBParameterGroup",
                        {
                            "Ref": "ExistingDBParameterGroupName"
                        },
                        {
                            "Fn::If": [
                                "CreateDBParameterGroup",
                                {
                                    "Ref": "DBParameterGroup"
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                },
                "DeletionProtection": false,
                "CopyTagsToSnapshot": true,
                "MultiAZ": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${NamePrefix}-db-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${NamePrefix}-lambda-exec-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    {
                        "Fn::If": [
                            "HasLambdaSubnets",
                            "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "HelloFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${NamePrefix}-hello-${EnvironmentSuffix}"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.12",
                "Handler": "index.handler",
                "MemorySize": 128,
                "Timeout": 10,
                "VpcConfig": {
                    "Fn::If": [
                        "HasLambdaSubnets",
                        {
                            "SecurityGroupIds": [
                                {
                                    "Ref": "LambdaSecurityGroup"
                                }
                            ],
                            "SubnetIds": {
                                "Ref": "LambdaSubnetIds"
                            }
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Code": {
                    "ZipFile": "import json\ndef handler(event, context):\n    return {\"statusCode\": 200, \"body\": json.dumps({\"message\": \"hello from prod lambda\"})}\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        },
        "Ec2AppLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/ec2/${NamePrefix}-app-${EnvironmentSuffix}"
                },
                "RetentionInDays": 90,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": "Production"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "EC2InstanceId": {
            "Description": "EC2 instance ID",
            "Value": {
                "Ref": "Ec2Instance"
            }
        },
        "RdsEndpoint": {
            "Description": "RDS endpoint address",
            "Value": {
                "Fn::GetAtt": [
                    "Database",
                    "Endpoint.Address"
                ]
            }
        },
        "AppBucketOut": {
            "Description": "Application S3 bucket name",
            "Value": {
                "Ref": "AppBucket"
            }
        },
        "CloudTrailName": {
            "Description": "CloudTrail trail name capturing all API activity",
            "Value": {
                "Ref": "OrgCloudTrail"
            }
        },
        "LambdaName": {
            "Description": "Lambda function name",
            "Value": {
                "Ref": "HelloFunction"
            }
        },
        "DBPasswordSecretArn": {
            "Description": "ARN of the database password secret",
            "Value": {
                "Ref": "DBPasswordSecret"
            }
        }
    }
}
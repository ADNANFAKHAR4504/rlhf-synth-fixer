{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::SecretsManager-2024-09-16",
    "Description": "TapStack â€” Aurora MySQL (writer+2 readers) with tuned params, backtrack, Secrets Manager rotation, proactive CloudWatch alarms, and full VPC isolation. All names are suffixed with EnvironmentSuffix.\n",
    "Metadata": {
        "cfn-lint": {
            "config": {
                "regions": [
                    "us-east-1"
                ]
            }
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Description": "Suffix applied to all names to prevent cross-environment collisions (use kebab-case).",
            "AllowedPattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
            "ConstraintDescription": "Use lowercase letters, digits, and hyphens (kebab-case), e.g., prod-us.",
            "Default": "prod-us"
        },
        "AlarmEmail": {
            "Type": "String",
            "Description": "Email address to subscribe for alarm notifications.",
            "AllowedPattern": "^[^@]+@[^@]+\\.[^@]+$",
            "Default": "trading-platform-alerts@example.com"
        },
        "VpcCidr": {
            "Type": "String",
            "Default": "10.42.0.0/16",
            "Description": "CIDR for the application VPC."
        },
        "PrivateSubnet1Cidr": {
            "Type": "String",
            "Default": "10.42.1.0/24",
            "Description": "CIDR for private subnet in AZ a."
        },
        "PrivateSubnet2Cidr": {
            "Type": "String",
            "Default": "10.42.2.0/24",
            "Description": "CIDR for private subnet in AZ b."
        },
        "PrivateSubnet3Cidr": {
            "Type": "String",
            "Default": "10.42.3.0/24",
            "Description": "CIDR for private subnet in AZ c."
        },
        "DBName": {
            "Type": "String",
            "Default": "tradingdb",
            "Description": "Initial database name.",
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9_]{0,63}$"
        },
        "MasterUsername": {
            "Type": "String",
            "Default": "dbadmin",
            "Description": "Master user name for the Aurora cluster.",
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9_]{0,15}$"
        },
        "EngineVersion": {
            "Type": "String",
            "Default": "5.7.mysql_aurora.2.11.5",
            "Description": "Aurora MySQL 2.x engine version compatible with MySQL 5.7 family."
        },
        "InstanceClass": {
            "Type": "String",
            "Default": "db.r5.2xlarge",
            "Description": "DB instance class for writer and readers."
        }
    },
    "Mappings": {
        "Tags": {
            "Common": {
                "Environment": "Production",
                "Team": "Platform",
                "Service": "Trading"
            }
        }
    },
    "Resources": {
        "Vpc": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Ref": "VpcCidr"
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-vpc-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet1Cidr"
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-private-az1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet2Cidr"
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-private-az2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Ref": "PrivateSubnet3Cidr"
                },
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-private-az3-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "RouteTablePrivate": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-rtb-private-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "RouteTableAssociation1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTablePrivate"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "RouteTableAssociation2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTablePrivate"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "RouteTableAssociation3": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "RouteTablePrivate"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                }
            }
        },
        "VpcEndpointSecretsManager": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.secretsmanager"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "RotationLambdaSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-vpce-secretsmanager-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "VpcEndpointCloudWatch": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "Vpc"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.logs"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "RotationLambdaSecurityGroup"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-vpce-logs-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AppSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Application tier SG allowed to connect to DB",
                "VpcId": {
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-app-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "RotationLambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "SG for Secrets Manager hosted rotation lambda",
                "VpcId": {
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-rotate-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Database SG allowing MySQL from App and Rotation Lambda SGs",
                "VpcId": {
                    "Ref": "Vpc"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "AppSecurityGroup"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 3306,
                        "ToPort": 3306,
                        "SourceSecurityGroupId": {
                            "Ref": "RotationLambdaSecurityGroup"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-db-sg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "Aurora subnets (${EnvironmentSuffix})"
                },
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "DBSubnetGroupName": {
                    "Fn::Sub": "tap-dbsubnet-${EnvironmentSuffix}"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-dbsubnet-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "KmsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "CMK for RDS and Secrets (${EnvironmentSuffix})"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowRootAccount",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-kms-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "KmsAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/tap-rds-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "KmsKey"
                }
            }
        },
        "DbSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": [
                        "tap/aurora/mysql/master/${EnvironmentSuffix}/${StackName}-${Guid}",
                        {
                            "StackName": {
                                "Ref": "AWS::StackName"
                            },
                            "Guid": {
                                "Fn::Select": [
                                    2,
                                    {
                                        "Fn::Split": [
                                            "/",
                                            {
                                                "Ref": "AWS::StackId"
                                            }
                                        ]
                                    }
                                ]
                            }
                        }
                    ]
                },
                "Description": {
                    "Fn::Sub": "Master credentials secret for Aurora MySQL (${EnvironmentSuffix})"
                },
                "KmsKeyId": {
                    "Ref": "KmsKey"
                },
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\":\"${MasterUsername}\"}\n"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-secret-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "SecretRotationSchedule": {
            "Type": "AWS::SecretsManager::RotationSchedule",
            "Properties": {
                "SecretId": {
                    "Ref": "DbSecret"
                },
                "RotationRules": {
                    "AutomaticallyAfterDays": 30
                },
                "HostedRotationLambda": {
                    "RotationType": "MySQLSingleUser",
                    "RotationLambdaName": {
                        "Fn::Sub": "tap-rotate-mysql-${EnvironmentSuffix}"
                    },
                    "VpcSecurityGroupIds": {
                        "Ref": "RotationLambdaSecurityGroup"
                    },
                    "VpcSubnetIds": {
                        "Fn::Join": [
                            ",",
                            [
                                {
                                    "Ref": "PrivateSubnet1"
                                },
                                {
                                    "Ref": "PrivateSubnet2"
                                },
                                {
                                    "Ref": "PrivateSubnet3"
                                }
                            ]
                        ]
                    }
                }
            }
        },
        "DbClusterParameterGroup": {
            "Type": "AWS::RDS::DBClusterParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Aurora MySQL cluster params (${EnvironmentSuffix})"
                },
                "Family": "aurora-mysql5.7",
                "Parameters": {
                    "query_cache_size": "0",
                    "character_set_server": "utf8mb4",
                    "collation_server": "utf8mb4_unicode_ci"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-cluster-pg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbInstanceParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "Description": {
                    "Fn::Sub": "Aurora MySQL instance params (${EnvironmentSuffix})"
                },
                "Family": "aurora-mysql5.7",
                "Parameters": {
                    "max_connections": "16000"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-instance-pg-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbCluster": {
            "Type": "AWS::RDS::DBCluster",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "Engine": "aurora-mysql",
                "EngineVersion": {
                    "Ref": "EngineVersion"
                },
                "EngineMode": "provisioned",
                "DBClusterIdentifier": {
                    "Fn::Sub": "tap-aurora-${EnvironmentSuffix}"
                },
                "DatabaseName": {
                    "Ref": "DBName"
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DbSecurityGroup"
                    }
                ],
                "KmsKeyId": {
                    "Ref": "KmsKey"
                },
                "StorageEncrypted": true,
                "MasterUsername": {
                    "Ref": "MasterUsername"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
                },
                "CopyTagsToSnapshot": true,
                "BackupRetentionPeriod": 7,
                "PreferredBackupWindow": "07:00-09:00",
                "PreferredMaintenanceWindow": "sun:09:00-sun:11:00",
                "BacktrackWindow": 259200,
                "DBClusterParameterGroupName": {
                    "Ref": "DbClusterParameterGroup"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-cluster-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbInstanceWriter": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "tap-aurora-writer-${EnvironmentSuffix}"
                },
                "DBInstanceClass": {
                    "Ref": "InstanceClass"
                },
                "Engine": "aurora-mysql",
                "EngineVersion": {
                    "Ref": "EngineVersion"
                },
                "DBClusterIdentifier": {
                    "Ref": "DbCluster"
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "DBParameterGroupName": {
                    "Ref": "DbInstanceParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-writer-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Role",
                        "Value": "writer"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbInstanceReader1": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "tap-aurora-reader1-${EnvironmentSuffix}"
                },
                "DBInstanceClass": {
                    "Ref": "InstanceClass"
                },
                "Engine": "aurora-mysql",
                "EngineVersion": {
                    "Ref": "EngineVersion"
                },
                "DBClusterIdentifier": {
                    "Ref": "DbCluster"
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "DBParameterGroupName": {
                    "Ref": "DbInstanceParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-reader1-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Role",
                        "Value": "reader"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "DbInstanceReader2": {
            "Type": "AWS::RDS::DBInstance",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "tap-aurora-reader2-${EnvironmentSuffix}"
                },
                "DBInstanceClass": {
                    "Ref": "InstanceClass"
                },
                "Engine": "aurora-mysql",
                "EngineVersion": {
                    "Ref": "EngineVersion"
                },
                "DBClusterIdentifier": {
                    "Ref": "DbCluster"
                },
                "DBSubnetGroupName": {
                    "Ref": "DbSubnetGroup"
                },
                "DBParameterGroupName": {
                    "Ref": "DbInstanceParameterGroup"
                },
                "PubliclyAccessible": false,
                "EnablePerformanceInsights": true,
                "PerformanceInsightsRetentionPeriod": 7,
                "AutoMinorVersionUpgrade": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-reader2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Role",
                        "Value": "reader"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "SnsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "tap-aurora-alarms-${EnvironmentSuffix}"
                },
                "KmsMasterKeyId": {
                    "Ref": "KmsKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-alarms-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "Team",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Team"
                            ]
                        }
                    },
                    {
                        "Key": "Service",
                        "Value": {
                            "Fn::FindInMap": [
                                "Tags",
                                "Common",
                                "Service"
                            ]
                        }
                    }
                ]
            }
        },
        "SnsSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "TopicArn": {
                    "Ref": "SnsTopic"
                },
                "Protocol": "email",
                "Endpoint": {
                    "Ref": "AlarmEmail"
                }
            }
        },
        "AlarmCpu": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-aurora-cpu80-${EnvironmentSuffix}"
                },
                "AlarmDescription": "CPUUtilization > 80% on writer (5min)",
                "Namespace": "AWS/RDS",
                "MetricName": "CPUUtilization",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DbInstanceWriter"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-cpu80-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AlarmConnections": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-aurora-connections-${EnvironmentSuffix}"
                },
                "AlarmDescription": "DatabaseConnections > 14000 at writer (5min)",
                "Namespace": "AWS/RDS",
                "MetricName": "DatabaseConnections",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DbInstanceWriter"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 14000,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-connections-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AlarmReadLatency": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-aurora-read-latency-${EnvironmentSuffix}"
                },
                "AlarmDescription": "ReadLatency > 200ms on writer (5min)",
                "Namespace": "AWS/RDS",
                "MetricName": "ReadLatency",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DbInstanceWriter"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 0.2,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-read-latency-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AlarmWriteLatency": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-aurora-write-latency-${EnvironmentSuffix}"
                },
                "AlarmDescription": "WriteLatency > 200ms on writer (5min)",
                "Namespace": "AWS/RDS",
                "MetricName": "WriteLatency",
                "Dimensions": [
                    {
                        "Name": "DBInstanceIdentifier",
                        "Value": {
                            "Ref": "DbInstanceWriter"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 0.2,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-write-latency-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        },
        "AlarmReplicaLag": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-aurora-replica-lag-${EnvironmentSuffix}"
                },
                "AlarmDescription": "AuroraReplicaLagMaximum > 1000ms at cluster (5min)",
                "Namespace": "AWS/RDS",
                "MetricName": "AuroraReplicaLagMaximum",
                "Dimensions": [
                    {
                        "Name": "DBClusterIdentifier",
                        "Value": {
                            "Ref": "DbCluster"
                        }
                    }
                ],
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "TreatMissingData": "notBreaching",
                "AlarmActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "OKActions": [
                    {
                        "Ref": "SnsTopic"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-aurora-replica-lag-${EnvironmentSuffix}"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "ClusterArn": {
            "Description": "Aurora cluster ARN",
            "Value": {
                "Fn::GetAtt": [
                    "DbCluster",
                    "DBClusterArn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-cluster-arn"
                }
            }
        },
        "ClusterIdentifier": {
            "Description": "Aurora cluster identifier",
            "Value": {
                "Ref": "DbCluster"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-cluster-id"
                }
            }
        },
        "WriterEndpoint": {
            "Description": "Writer endpoint DNS",
            "Value": {
                "Fn::GetAtt": [
                    "DbCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-writer-endpoint"
                }
            }
        },
        "ReaderEndpoint": {
            "Description": "Reader endpoint DNS (Aurora distributes reads)",
            "Value": {
                "Fn::GetAtt": [
                    "DbCluster",
                    "ReadEndpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-reader-endpoint"
                }
            }
        },
        "EngineVersionOut": {
            "Description": "Engine version",
            "Value": {
                "Ref": "EngineVersion"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-engine-version"
                }
            }
        },
        "DBInstanceWriterArn": {
            "Description": "Writer instance DBI resource id",
            "Value": {
                "Fn::GetAtt": [
                    "DbInstanceWriter",
                    "DbiResourceId"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-writer-dbi-resource-id"
                }
            }
        },
        "DBInstanceReader1Arn": {
            "Description": "Reader1 instance DBI resource id",
            "Value": {
                "Fn::GetAtt": [
                    "DbInstanceReader1",
                    "DbiResourceId"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-reader1-dbi-resource-id"
                }
            }
        },
        "DBInstanceReader2Arn": {
            "Description": "Reader2 instance DBI resource id",
            "Value": {
                "Fn::GetAtt": [
                    "DbInstanceReader2",
                    "DbiResourceId"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-reader2-dbi-resource-id"
                }
            }
        },
        "SecretArn": {
            "Description": "Secrets Manager master credential secret ARN",
            "Value": {
                "Ref": "DbSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-secret-arn"
                }
            }
        },
        "RotationScheduleArn": {
            "Description": "Rotation schedule ARN",
            "Value": {
                "Ref": "SecretRotationSchedule"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-rotation-arn"
                }
            }
        },
        "SnsTopicArn": {
            "Description": "SNS topic for alarms",
            "Value": {
                "Ref": "SnsTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-sns-arn"
                }
            }
        },
        "AlarmCpuArn": {
            "Description": "Alarm ARN (CPU)",
            "Value": {
                "Fn::GetAtt": [
                    "AlarmCpu",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-alarm-cpu-arn"
                }
            }
        },
        "AlarmConnectionsArn": {
            "Description": "Alarm ARN (Connections)",
            "Value": {
                "Fn::GetAtt": [
                    "AlarmConnections",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-alarm-connections-arn"
                }
            }
        },
        "AlarmReadLatencyArn": {
            "Description": "Alarm ARN (ReadLatency)",
            "Value": {
                "Fn::GetAtt": [
                    "AlarmReadLatency",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-alarm-read-latency-arn"
                }
            }
        },
        "AlarmWriteLatencyArn": {
            "Description": "Alarm ARN (WriteLatency)",
            "Value": {
                "Fn::GetAtt": [
                    "AlarmWriteLatency",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-alarm-write-latency-arn"
                }
            }
        },
        "AlarmReplicaLagArn": {
            "Description": "Alarm ARN (ReplicaLag)",
            "Value": {
                "Fn::GetAtt": [
                    "AlarmReplicaLag",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-alarm-replica-lag-arn"
                }
            }
        },
        "VpcId": {
            "Description": "VPC Id",
            "Value": {
                "Ref": "Vpc"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-vpc-id"
                }
            }
        },
        "DbSecurityGroupId": {
            "Description": "DB Security Group Id",
            "Value": {
                "Ref": "DbSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-db-sg-id"
                }
            }
        },
        "AppSecurityGroupId": {
            "Description": "App Security Group Id",
            "Value": {
                "Ref": "AppSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-app-sg-id"
                }
            }
        },
        "DbSubnetGroupName": {
            "Description": "DB Subnet Group Name",
            "Value": {
                "Ref": "DbSubnetGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-dbsubnet-name"
                }
            }
        },
        "PrivateSubnetIds": {
            "Description": "Comma-delimited list of private subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        },
                        {
                            "Ref": "PrivateSubnet3"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "tap-${EnvironmentSuffix}-private-subnets"
                }
            }
        }
    }
}
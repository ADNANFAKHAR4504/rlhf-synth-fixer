{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Payment Processing Infrastructure - Flattened Stack for Multi-Account Deployment",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": { "default": "Environment Configuration" },
          "Parameters": ["EnvironmentName", "SnsEmail"]
        },
        {
          "Label": { "default": "Network Configuration" },
          "Parameters": ["VpcCidr", "AvailabilityZone1", "AvailabilityZone2", "AvailabilityZone3"]
        }
      ]
    }
  },
  "Parameters": {
    "EnvironmentName": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": ["dev", "staging", "prod"],
      "Description": "Environment name for resource naming and conditional logic"
    },
    "SnsEmail": {
      "Type": "String",
      "Description": "Email address for SNS alarm notifications",
      "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    },
    "VpcCidr": {
      "Type": "String",
      "Default": "10.0.0.0/16",
      "Description": "CIDR block for VPC",
      "AllowedPattern": "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    },
    "AvailabilityZone1": {
      "Type": "AWS::EC2::AvailabilityZone::Name",
      "Description": "First Availability Zone"
    },
    "AvailabilityZone2": {
      "Type": "AWS::EC2::AvailabilityZone::Name",
      "Description": "Second Availability Zone"
    },
    "AvailabilityZone3": {
      "Type": "AWS::EC2::AvailabilityZone::Name",
      "Description": "Third Availability Zone"
    }
  },
  "Conditions": {
    "IsProduction": {
      "Fn::Equals": [{ "Ref": "EnvironmentName" }, "prod"]
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": { "Ref": "VpcCidr" },
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-vpc-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-igw-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "InternetGatewayId": { "Ref": "InternetGateway" }
      }
    },
    "PublicSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [0, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone1" },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-public-subnet-1-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PublicSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [1, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone2" },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-public-subnet-2-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PublicSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [2, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone3" },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-public-subnet-3-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [3, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone1" },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-private-subnet-1-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [4, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone2" },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-private-subnet-2-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": { "Fn::Select": [5, { "Fn::Cidr": [{ "Ref": "VpcCidr" }, 6, 8] }] },
        "AvailabilityZone": { "Ref": "AvailabilityZone3" },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-private-subnet-3-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-public-rt-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachGateway",
      "Properties": {
        "RouteTableId": { "Ref": "PublicRouteTable" },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": { "Ref": "InternetGateway" }
      }
    },
    "PublicSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PublicSubnet1" },
        "RouteTableId": { "Ref": "PublicRouteTable" }
      }
    },
    "PublicSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PublicSubnet2" },
        "RouteTableId": { "Ref": "PublicRouteTable" }
      }
    },
    "PublicSubnet3RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PublicSubnet3" },
        "RouteTableId": { "Ref": "PublicRouteTable" }
      }
    },
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-private-rt-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PrivateSubnet1RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PrivateSubnet1" },
        "RouteTableId": { "Ref": "PrivateRouteTable" }
      }
    },
    "PrivateSubnet2RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PrivateSubnet2" },
        "RouteTableId": { "Ref": "PrivateRouteTable" }
      }
    },
    "PrivateSubnet3RouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "PrivateSubnet3" },
        "RouteTableId": { "Ref": "PrivateRouteTable" }
      }
    },
    "LambdaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": { "Fn::Sub": "payment-lambda-sg-${EnvironmentName}" },
        "GroupDescription": "Security group for payment processing Lambda functions",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic"
          }
        ],
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-lambda-sg-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "AlbSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": { "Fn::Sub": "payment-alb-sg-${EnvironmentName}" },
        "GroupDescription": "Security group for Application Load Balancer",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTPS from anywhere"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow HTTP from anywhere"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "-1",
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic"
          }
        ],
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-alb-sg-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "DynamoDBEndpoint": {
      "Type": "AWS::EC2::VPCEndpoint",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "ServiceName": { "Fn::Sub": "com.amazonaws.${AWS::Region}.dynamodb" },
        "VpcEndpointType": "Gateway",
        "RouteTableIds": [{ "Ref": "PrivateRouteTable" }]
      }
    },
    "PaymentTransactionsTable": {
      "Type": "AWS::DynamoDB::Table",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TableName": { "Fn::Sub": "payment-transactions-${EnvironmentName}" },
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          { "AttributeName": "transactionId", "AttributeType": "S" },
          { "AttributeName": "timestamp", "AttributeType": "N" },
          { "AttributeName": "customerId", "AttributeType": "S" },
          { "AttributeName": "paymentStatus", "AttributeType": "S" }
        ],
        "KeySchema": [
          { "AttributeName": "transactionId", "KeyType": "HASH" },
          { "AttributeName": "timestamp", "KeyType": "RANGE" }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "customer-index",
            "KeySchema": [
              { "AttributeName": "customerId", "KeyType": "HASH" },
              { "AttributeName": "timestamp", "KeyType": "RANGE" }
            ],
            "Projection": { "ProjectionType": "ALL" }
          },
          {
            "IndexName": "status-index",
            "KeySchema": [
              { "AttributeName": "paymentStatus", "KeyType": "HASH" },
              { "AttributeName": "timestamp", "KeyType": "RANGE" }
            ],
            "Projection": { "ProjectionType": "ALL" }
          }
        ],
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-transactions-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "payment-lambda-role-${EnvironmentName}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "lambda.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:GetItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    { "Fn::GetAtt": ["PaymentTransactionsTable", "Arn"] },
                    { "Fn::Sub": "${PaymentTransactionsTable.Arn}/index/*" }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogs",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/payment-*" }
                }
              ]
            }
          }
        ],
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ValidationFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": { "Fn::Sub": "payment-validation-${EnvironmentName}" },
        "Runtime": "nodejs22.x",
        "Handler": "index.handler",
        "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"] },
        "MemorySize": 512,
        "Timeout": 30,
        "ReservedConcurrentExecutions": {
          "Fn::If": ["IsProduction", 100, { "Ref": "AWS::NoValue" }]
        },
        "Environment": {
          "Variables": {
            "ENVIRONMENT": { "Ref": "EnvironmentName" },
            "PAYMENT_TABLE": { "Ref": "PaymentTransactionsTable" }
          }
        },
        "VpcConfig": {
          "SecurityGroupIds": [{ "Ref": "LambdaSecurityGroup" }],
          "SubnetIds": [
            { "Ref": "PrivateSubnet1" },
            { "Ref": "PrivateSubnet2" },
            { "Ref": "PrivateSubnet3" }
          ]
        },
        "Code": {
          "ZipFile": "const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');\nconst { DynamoDBDocumentClient, GetItemCommand } = require('@aws-sdk/lib-dynamodb');\n\nconst client = new DynamoDBClient({});\nconst ddbDocClient = DynamoDBDocumentClient.from(client);\n\nexports.handler = async (event) => {\n  console.log('Validation event:', JSON.stringify(event));\n  \n  const body = typeof event.body === 'string' ? JSON.parse(event.body) : event;\n  const { transactionId, amount, customerId } = body;\n  \n  if (!transactionId || !amount || !customerId) {\n    return {\n      statusCode: 400,\n      body: JSON.stringify({ error: 'Missing required fields' })\n    };\n  }\n  \n  if (amount <= 0 || amount > 10000) {\n    return {\n      statusCode: 400,\n      body: JSON.stringify({ error: 'Invalid amount' })\n    };\n  }\n  \n  return {\n    statusCode: 200,\n    body: JSON.stringify({\n      valid: true,\n      transactionId,\n      customerId,\n      amount\n    })\n  };\n};\n"
        },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-validation-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ProcessingFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": { "Fn::Sub": "payment-processing-${EnvironmentName}" },
        "Runtime": "nodejs22.x",
        "Handler": "index.handler",
        "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"] },
        "MemorySize": 512,
        "Timeout": 60,
        "ReservedConcurrentExecutions": {
          "Fn::If": ["IsProduction", 100, { "Ref": "AWS::NoValue" }]
        },
        "Environment": {
          "Variables": {
            "ENVIRONMENT": { "Ref": "EnvironmentName" },
            "PAYMENT_TABLE": { "Ref": "PaymentTransactionsTable" }
          }
        },
        "VpcConfig": {
          "SecurityGroupIds": [{ "Ref": "LambdaSecurityGroup" }],
          "SubnetIds": [
            { "Ref": "PrivateSubnet1" },
            { "Ref": "PrivateSubnet2" },
            { "Ref": "PrivateSubnet3" }
          ]
        },
        "Code": {
          "ZipFile": "const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');\nconst { DynamoDBDocumentClient, PutItemCommand } = require('@aws-sdk/lib-dynamodb');\n\nconst client = new DynamoDBClient({});\nconst ddbDocClient = DynamoDBDocumentClient.from(client);\n\nexports.handler = async (event) => {\n  console.log('Processing event:', JSON.stringify(event));\n  \n  const body = typeof event.body === 'string' ? JSON.parse(event.body) : event;\n  const { transactionId, amount, customerId } = body;\n  \n  const timestamp = Date.now();\n  \n  const params = {\n    TableName: process.env.PAYMENT_TABLE,\n    Item: {\n      transactionId,\n      timestamp,\n      customerId,\n      amount,\n      paymentStatus: 'COMPLETED',\n      processedAt: new Date().toISOString()\n    }\n  };\n  \n  try {\n    await ddbDocClient.send(new PutItemCommand(params));\n    \n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        success: true,\n        transactionId,\n        timestamp,\n        status: 'COMPLETED'\n      })\n    };\n  } catch (error) {\n    console.error('Error processing payment:', error);\n    throw error;\n  }\n};\n"
        },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-processing-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ValidationFunctionPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "ValidationFunction" },
        "Action": "lambda:InvokeFunction",
        "Principal": "elasticloadbalancing.amazonaws.com"
      }
    },
    "ProcessingFunctionPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "ProcessingFunction" },
        "Action": "lambda:InvokeFunction",
        "Principal": "elasticloadbalancing.amazonaws.com"
      }
    },
    "StepFunctionsFunctionPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "ValidationFunction" },
        "Action": "lambda:InvokeFunction",
        "Principal": "states.amazonaws.com"
      }
    },
    "StepFunctionsProcessingPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "ProcessingFunction" },
        "Action": "lambda:InvokeFunction",
        "Principal": "states.amazonaws.com"
      }
    },
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": { "Fn::Sub": "payment-alb-${EnvironmentName}" },
        "Type": "application",
        "Scheme": "internet-facing",
        "IpAddressType": "ipv4",
        "Subnets": [
          { "Ref": "PublicSubnet1" },
          { "Ref": "PublicSubnet2" },
          { "Ref": "PublicSubnet3" }
        ],
        "SecurityGroups": [{ "Ref": "AlbSecurityGroup" }],
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-alb-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ValidationTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "DependsOn": "ValidationFunctionPermission",
      "Properties": {
        "Name": { "Fn::Sub": "payment-validation-tg-${EnvironmentName}" },
        "TargetType": "lambda",
        "Targets": [
          { "Id": { "Fn::GetAtt": ["ValidationFunction", "Arn"] } }
        ],
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/health",
        "HealthCheckIntervalSeconds": 35,
        "HealthCheckTimeoutSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 2,
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ProcessingTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "DependsOn": "ProcessingFunctionPermission",
      "Properties": {
        "Name": { "Fn::Sub": "payment-processing-tg-${EnvironmentName}" },
        "TargetType": "lambda",
        "Targets": [
          { "Id": { "Fn::GetAtt": ["ProcessingFunction", "Arn"] } }
        ],
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/health",
        "HealthCheckIntervalSeconds": 35,
        "HealthCheckTimeoutSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 2,
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "AlbListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": { "Ref": "ApplicationLoadBalancer" },
        "Port": 80,
        "Protocol": "HTTP",
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "ValidationTargetGroup" }
          }
        ]
      }
    },
    "AlbListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": { "Ref": "AlbListener" },
        "Priority": 1,
        "Conditions": [
          {
            "Field": "path-pattern",
            "Values": ["/process"]
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "ProcessingTargetGroup" }
          }
        ]
      }
    },
    "StepFunctionsRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "payment-stepfunctions-role-${EnvironmentName}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "states.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "LambdaInvoke",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["lambda:InvokeFunction"],
                  "Resource": [
                    { "Fn::GetAtt": ["ValidationFunction", "Arn"] },
                    { "Fn::GetAtt": ["ProcessingFunction", "Arn"] }
                  ]
                }
              ]
            }
          }
        ],
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "PaymentStateMachine": {
      "Type": "AWS::StepFunctions::StateMachine",
      "Properties": {
        "StateMachineName": { "Fn::Sub": "payment-workflow-${EnvironmentName}" },
        "RoleArn": { "Fn::GetAtt": ["StepFunctionsRole", "Arn"] },
        "DefinitionString": {
          "Fn::Sub": [
            "{\n  \"Comment\": \"Payment Processing Workflow\",\n  \"StartAt\": \"ValidatePayment\",\n  \"States\": {\n    \"ValidatePayment\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\n        \"FunctionName\": \"${ValidationFunctionArn}\",\n        \"Payload.$\": \"$\"\n      },\n      \"Retry\": [\n        {\n          \"ErrorEquals\": [\"States.TaskFailed\", \"States.Timeout\"],\n          \"IntervalSeconds\": 2,\n          \"MaxAttempts\": 3,\n          \"BackoffRate\": 2.0\n        }\n      ],\n      \"Catch\": [\n        {\n          \"ErrorEquals\": [\"States.ALL\"],\n          \"Next\": \"ValidationFailed\"\n        }\n      ],\n      \"Next\": \"ProcessPayment\"\n    },\n    \"ProcessPayment\": {\n      \"Type\": \"Task\",\n      \"Resource\": \"arn:aws:states:::lambda:invoke\",\n      \"Parameters\": {\n        \"FunctionName\": \"${ProcessingFunctionArn}\",\n        \"Payload.$\": \"$.Payload.body\"\n      },\n      \"Retry\": [\n        {\n          \"ErrorEquals\": [\"States.TaskFailed\", \"States.Timeout\"],\n          \"IntervalSeconds\": 2,\n          \"MaxAttempts\": 3,\n          \"BackoffRate\": 2.0\n        }\n      ],\n      \"Catch\": [\n        {\n          \"ErrorEquals\": [\"States.ALL\"],\n          \"Next\": \"ProcessingFailed\"\n        }\n      ],\n      \"Next\": \"PaymentSucceeded\"\n    },\n    \"PaymentSucceeded\": {\n      \"Type\": \"Succeed\"\n    },\n    \"ValidationFailed\": {\n      \"Type\": \"Fail\",\n      \"Error\": \"ValidationError\",\n      \"Cause\": \"Payment validation failed\"\n    },\n    \"ProcessingFailed\": {\n      \"Type\": \"Fail\",\n      \"Error\": \"ProcessingError\",\n      \"Cause\": \"Payment processing failed\"\n    }\n  }\n}",
            {
              "ValidationFunctionArn": { "Fn::GetAtt": ["ValidationFunction", "Arn"] },
              "ProcessingFunctionArn": { "Fn::GetAtt": ["ProcessingFunction", "Arn"] }
            }
          ]
        },
        "Tags": [
          { "Key": "Name", "Value": { "Fn::Sub": "payment-workflow-${EnvironmentName}" } },
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "AlarmTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": { "Fn::Sub": "payment-alarms-${EnvironmentName}" },
        "DisplayName": { "Fn::Sub": "Payment Processing Alarms - ${EnvironmentName}" },
        "Subscription": [
          {
            "Endpoint": { "Ref": "SnsEmail" },
            "Protocol": "email"
          }
        ],
        "Tags": [
          { "Key": "Environment", "Value": { "Ref": "EnvironmentName" } }
        ]
      }
    },
    "ValidationFunctionErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-validation-errors-${EnvironmentName}" },
        "AlarmDescription": "Alarm when validation function has errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ValidationFunction" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "ProcessingFunctionErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-processing-errors-${EnvironmentName}" },
        "AlarmDescription": "Alarm when processing function has errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ProcessingFunction" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "DynamoDBThrottleAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-dynamodb-throttle-${EnvironmentName}" },
        "AlarmDescription": "Alarm when DynamoDB requests are throttled",
        "MetricName": "UserErrors",
        "Namespace": "AWS/DynamoDB",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 10,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "TableName",
            "Value": { "Ref": "PaymentTransactionsTable" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "StateMachineFailureAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-workflow-failures-${EnvironmentName}" },
        "AlarmDescription": "Alarm when state machine executions fail",
        "MetricName": "ExecutionsFailed",
        "Namespace": "AWS/States",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 1,
        "Threshold": 3,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "StateMachineArn",
            "Value": { "Ref": "PaymentStateMachine" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    },
    "ValidationFunctionDurationAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": { "Fn::Sub": "payment-validation-duration-${EnvironmentName}" },
        "AlarmDescription": "Alarm when validation function duration is high",
        "MetricName": "Duration",
        "Namespace": "AWS/Lambda",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": { "Ref": "ValidationFunction" }
          }
        ],
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "TreatMissingData": "notBreaching"
      }
    }
  },
  "Outputs": {
    "StackName": {
      "Description": "Name of the CloudFormation stack",
      "Value": { "Ref": "AWS::StackName" },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-StackName" } }
    },
    "EnvironmentName": {
      "Description": "Environment name for this deployment",
      "Value": { "Ref": "EnvironmentName" },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-EnvironmentName" } }
    },
    "VpcId": {
      "Description": "VPC ID",
      "Value": { "Ref": "VPC" },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-VpcId" } }
    },
    "AlbDnsName": {
      "Description": "DNS name of the Application Load Balancer",
      "Value": { "Fn::GetAtt": ["ApplicationLoadBalancer", "DNSName"] },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-AlbDnsName" } }
    },
    "StateMachineArn": {
      "Description": "ARN of the payment processing state machine",
      "Value": { "Fn::GetAtt": ["PaymentStateMachine", "Arn"] },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-StateMachineArn" } }
    },
    "PaymentTableName": {
      "Description": "Name of the payment transactions table",
      "Value": { "Ref": "PaymentTransactionsTable" },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-PaymentTableName" } }
    },
    "ValidationFunctionArn": {
      "Description": "ARN of the validation Lambda function",
      "Value": { "Fn::GetAtt": ["ValidationFunction", "Arn"] },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-ValidationFunctionArn" } }
    },
    "ProcessingFunctionArn": {
      "Description": "ARN of the processing Lambda function",
      "Value": { "Fn::GetAtt": ["ProcessingFunction", "Arn"] },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-ProcessingFunctionArn" } }
    },
    "AlarmTopicArn": {
      "Description": "ARN of the SNS alarm topic",
      "Value": { "Ref": "AlarmTopic" },
      "Export": { "Name": { "Fn::Sub": "${AWS::StackName}-AlarmTopicArn" } }
    }
  }
}

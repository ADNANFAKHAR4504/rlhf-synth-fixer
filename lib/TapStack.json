{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Optimized Trading Platform Infrastructure - Production-grade refactored template with best practices",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VpcId",
            "PublicSubnetAId",
            "PublicSubnetBId",
            "PrivateSubnetAId",
            "PrivateSubnetBId"
          ]
        },
        {
          "Label": {
            "default": "Application Configuration"
          },
          "Parameters": [
            "Environment",
            "ProjectName",
            "Owner"
          ]
        },
        {
          "Label": {
            "default": "Instance Configuration"
          },
          "Parameters": [
            "InstanceType",
            "KeyPairName",
            "MinInstances",
            "MaxInstances",
            "DesiredInstances"
          ]
        },
        {
          "Label": {
            "default": "Monitoring Configuration"
          },
          "Parameters": [
            "EnableCloudWatchAlarms",
            "SNSAlertTopic"
          ]
        },
        {
          "Label": {
            "default": "SSL Configuration"
          },
          "Parameters": [
            "SSLCertificateArn"
          ]
        }
      ],
      "ParameterLabels": {
        "VpcId": {
          "default": "VPC ID"
        },
        "Environment": {
          "default": "Environment Name"
        },
        "EnableCloudWatchAlarms": {
          "default": "Enable CloudWatch Monitoring"
        },
        "SSLCertificateArn": {
          "default": "SSL Certificate ARN"
        }
      }
    }
  },
  "Parameters": {
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Default": "vpc-0123456789abcdef0",
      "Description": "ID of existing VPC where resources will be deployed"
    },
    "PublicSubnetAId": {
      "Type": "AWS::EC2::Subnet::Id",
      "Default": "subnet-0123456789abcdef0",
      "Description": "Public subnet in first availability zone for ALB"
    },
    "PublicSubnetBId": {
      "Type": "AWS::EC2::Subnet::Id",
      "Default": "subnet-0123456789abcdef1",
      "Description": "Public subnet in second availability zone for ALB"
    },
    "PrivateSubnetAId": {
      "Type": "AWS::EC2::Subnet::Id",
      "Default": "subnet-0123456789abcdef2",
      "Description": "Private subnet in first availability zone for EC2 instances"
    },
    "PrivateSubnetBId": {
      "Type": "AWS::EC2::Subnet::Id",
      "Default": "subnet-0123456789abcdef3",
      "Description": "Private subnet in second availability zone for EC2 instances"
    },
    "Environment": {
      "Type": "String",
      "Default": "production",
      "AllowedValues": [
        "production",
        "staging",
        "development"
      ],
      "Description": "Environment name for tagging and configuration"
    },
    "ProjectName": {
      "Type": "String",
      "Default": "TradingPlatform",
      "Description": "Project name for resource identification",
      "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9-]*$",
      "ConstraintDescription": "Must start with a letter and contain only alphanumeric characters and hyphens"
    },
    "Owner": {
      "Type": "String",
      "Default": "FinanceTeam",
      "Description": "Team or individual responsible for these resources"
    },
    "InstanceType": {
      "Type": "String",
      "Default": "t3.medium",
      "Description": "EC2 instance type for application servers",
      "AllowedValues": [
        "t3.small",
        "t3.medium",
        "t3.large",
        "t3a.small",
        "t3a.medium",
        "t3a.large",
        "m5.large",
        "m5.xlarge"
      ]
    },
    "KeyPairName": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Default": "default-keypair",
      "Description": "EC2 key pair for SSH access to instances"
    },
    "MinInstances": {
      "Type": "Number",
      "Default": 2,
      "MinValue": 1,
      "MaxValue": 4,
      "Description": "Minimum number of instances in Auto Scaling Group"
    },
    "MaxInstances": {
      "Type": "Number",
      "Default": 4,
      "MinValue": 2,
      "MaxValue": 10,
      "Description": "Maximum number of instances in Auto Scaling Group"
    },
    "DesiredInstances": {
      "Type": "Number",
      "Default": 2,
      "MinValue": 1,
      "MaxValue": 10,
      "Description": "Desired number of instances in Auto Scaling Group"
    },
    "EnableCloudWatchAlarms": {
      "Type": "String",
      "Default": "Yes",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Description": "Enable CloudWatch alarms for monitoring"
    },
    "SNSAlertTopic": {
      "Type": "String",
      "Default": "",
      "Description": "SNS topic ARN for alarm notifications (optional)"
    },
    "SSLCertificateArn": {
      "Type": "String",
      "Default": "arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012",
      "Description": "ARN of SSL certificate for HTTPS listener",
      "AllowedPattern": "^arn:aws:acm:[a-z0-9-]+:[0-9]{12}:certificate/.+$",
      "ConstraintDescription": "Must be a valid ACM certificate ARN"
    }
  },
  "Conditions": {
    "CreateAlarms": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatchAlarms"
        },
        "Yes"
      ]
    },
    "HasSNSTopic": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SNSAlertTopic"
            },
            ""
          ]
        }
      ]
    },
    "IsProduction": {
      "Fn::Equals": [
        {
          "Ref": "Environment"
        },
        "production"
      ]
    }
  },
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "us-east-2": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "us-west-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "us-west-2": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "eu-west-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "eu-central-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "ap-southeast-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      },
      "ap-northeast-1": {
        "AMIParameter": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
      }
    }
  },
  "Resources": {
    "EC2InstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "${ProjectName}-${Environment}-ec2-role"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-ec2-role"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            }
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true"
          }
        ]
      }
    },
    "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "InstanceProfileName": {
          "Fn::Sub": "${ProjectName}-${Environment}-instance-profile"
        },
        "Roles": [
          {
            "Ref": "EC2InstanceRole"
          }
        ]
      }
    },
    "ApplicationSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "${ProjectName}-${Environment}-app-sg"
        },
        "GroupDescription": {
          "Fn::Sub": "Consolidated security group for ${ProjectName} ${Environment} environment"
        },
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-app-sg"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            }
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true"
          }
        ]
      }
    },
    "ALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "${ProjectName}-${Environment}-alb-sg"
        },
        "GroupDescription": {
          "Fn::Sub": "Security group for ${ProjectName} Application Load Balancer"
        },
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTPS from internet"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTP from internet (redirect to HTTPS)"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-alb-sg"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            }
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true"
          }
        ]
      }
    },
    "ApplicationSecurityGroupIngressFromALB": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {
          "Ref": "ApplicationSecurityGroup"
        },
        "IpProtocol": "tcp",
        "FromPort": 80,
        "ToPort": 80,
        "SourceSecurityGroupId": {
          "Ref": "ALBSecurityGroup"
        },
        "Description": "HTTP from ALB only"
      }
    },
    "ApplicationLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${Environment}-alb"
        },
        "Type": "application",
        "Scheme": "internet-facing",
        "IpAddressType": "ipv4",
        "Subnets": [
          {
            "Ref": "PublicSubnetAId"
          },
          {
            "Ref": "PublicSubnetBId"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "ALBSecurityGroup"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-alb"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            }
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true"
          }
        ]
      },
      "DeletionPolicy": "Retain",
      "UpdateReplacePolicy": "Retain"
    },
    "TargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${Environment}-tg"
        },
        "Port": 80,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/health",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "TargetType": "instance",
        "TargetGroupAttributes": [
          {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "30"
          }
        ],
        "Matcher": {
          "HttpCode": "200"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-tg"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            }
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true"
          }
        ]
      }
    },
    "ALBListenerHTTPS": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "Port": 443,
        "Protocol": "HTTPS",
        "Certificates": [
          {
            "CertificateArn": {
              "Ref": "SSLCertificateArn"
            }
          }
        ],
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "TargetGroup"
            }
          }
        ],
        "SslPolicy": "ELBSecurityPolicy-TLS-1-2-2017-01"
      }
    },
    "ALBListenerHTTP": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {
          "Ref": "ApplicationLoadBalancer"
        },
        "Port": 80,
        "Protocol": "HTTP",
        "DefaultActions": [
          {
            "Type": "redirect",
            "RedirectConfig": {
              "Protocol": "HTTPS",
              "Port": "443",
              "StatusCode": "HTTP_301"
            }
          }
        ]
      }
    },
    "LaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateName": {
          "Fn::Sub": "${ProjectName}-${Environment}-lt"
        },
        "LaunchTemplateData": {
          "ImageId": {
            "Fn::Sub": [
              "{{resolve:ssm:${AMIParam}}}",
              {
                "AMIParam": {
                  "Fn::FindInMap": [
                    "RegionMap",
                    {
                      "Ref": "AWS::Region"
                    },
                    "AMIParameter"
                  ]
                }
              }
            ]
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "KeyName": {
            "Ref": "KeyPairName"
          },
          "IamInstanceProfile": {
            "Arn": {
              "Fn::GetAtt": [
                "EC2InstanceProfile",
                "Arn"
              ]
            }
          },
          "SecurityGroupIds": [
            {
              "Ref": "ApplicationSecurityGroup"
            }
          ],
          "UserData": {
            "Fn::Base64": {
              "Fn::Sub": "#!/bin/bash\nset -e\nexec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n\necho \"Starting bootstrap process for ${ProjectName} ${Environment}\"\n\nyum update -y\n\nyum install -y amazon-cloudwatch-agent httpd mod_ssl aws-cfn-bootstrap jq\n\ncat > /var/www/html/index.html << 'EOFHTML'\n<!DOCTYPE html>\n<html>\n<head><title>${ProjectName} - ${Environment}</title></head>\n<body>\n  <h1>${ProjectName} Trading Platform</h1>\n  <p><strong>Environment:</strong> ${Environment}</p>\n  <p><strong>Region:</strong> ${AWS::Region}</p>\n</body>\n</html>\nEOFHTML\n\necho '{\"status\": \"healthy\"}' > /var/www/html/health\n\nsystemctl enable httpd\nsystemctl start httpd\n\n/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AutoScalingGroup --region ${AWS::Region}\n\necho \"Bootstrap process completed successfully\"\n"
            }
          },
          "TagSpecifications": [
            {
              "ResourceType": "instance",
              "Tags": [
                {
                  "Key": "Name",
                  "Value": {
                    "Fn::Sub": "${ProjectName}-${Environment}-instance"
                  }
                },
                {
                  "Key": "Environment",
                  "Value": {
                    "Ref": "Environment"
                  }
                },
                {
                  "Key": "Project",
                  "Value": {
                    "Ref": "ProjectName"
                  }
                },
                {
                  "Key": "Owner",
                  "Value": {
                    "Ref": "Owner"
                  }
                },
                {
                  "Key": "iac-rlhf-amazon",
                  "Value": "true"
                }
              ]
            },
            {
              "ResourceType": "volume",
              "Tags": [
                {
                  "Key": "Name",
                  "Value": {
                    "Fn::Sub": "${ProjectName}-${Environment}-volume"
                  }
                },
                {
                  "Key": "Environment",
                  "Value": {
                    "Ref": "Environment"
                  }
                },
                {
                  "Key": "Project",
                  "Value": {
                    "Ref": "ProjectName"
                  }
                },
                {
                  "Key": "Owner",
                  "Value": {
                    "Ref": "Owner"
                  }
                },
                {
                  "Key": "iac-rlhf-amazon",
                  "Value": "true"
                }
              ]
            }
          ],
          "MetadataOptions": {
            "HttpTokens": "required",
            "HttpPutResponseHopLimit": 1
          }
        }
      }
    },
    "AutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "DependsOn": "TargetGroup",
      "Properties": {
        "AutoScalingGroupName": {
          "Fn::Sub": "${ProjectName}-${Environment}-asg"
        },
        "MinSize": {
          "Ref": "MinInstances"
        },
        "MaxSize": {
          "Ref": "MaxInstances"
        },
        "DesiredCapacity": {
          "Ref": "DesiredInstances"
        },
        "HealthCheckType": "ELB",
        "HealthCheckGracePeriod": 300,
        "VPCZoneIdentifier": [
          {
            "Ref": "PrivateSubnetAId"
          },
          {
            "Ref": "PrivateSubnetBId"
          }
        ],
        "MixedInstancesPolicy": {
          "LaunchTemplate": {
            "LaunchTemplateSpecification": {
              "LaunchTemplateId": {
                "Ref": "LaunchTemplate"
              },
              "Version": {
                "Fn::GetAtt": [
                  "LaunchTemplate",
                  "LatestVersionNumber"
                ]
              }
            },
            "Overrides": [
              {
                "InstanceType": {
                  "Ref": "InstanceType"
                }
              },
              {
                "InstanceType": "t3a.medium",
                "WeightedCapacity": "1"
              },
              {
                "InstanceType": "t3.medium",
                "WeightedCapacity": "1"
              }
            ]
          },
          "InstancesDistribution": {
            "OnDemandBaseCapacity": {
              "Fn::If": [
                "IsProduction",
                2,
                0
              ]
            },
            "OnDemandPercentageAboveBaseCapacity": {
              "Fn::If": [
                "IsProduction",
                50,
                0
              ]
            },
            "SpotAllocationStrategy": "capacity-optimized",
            "SpotInstancePools": 3
          }
        },
        "TargetGroupARNs": [
          {
            "Ref": "TargetGroup"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${ProjectName}-${Environment}-asg-instance"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Owner",
            "Value": {
              "Ref": "Owner"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "iac-rlhf-amazon",
            "Value": "true",
            "PropagateAtLaunch": true
          }
        ]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": {
            "Ref": "MinInstances"
          },
          "Timeout": "PT15M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": 1,
          "MaxBatchSize": 2,
          "PauseTime": "PT5M",
          "WaitOnResourceSignals": true
        }
      }
    },
    "CPUScalingPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AutoScalingGroupName": {
          "Ref": "AutoScalingGroup"
        },
        "PolicyType": "TargetTrackingScaling",
        "TargetTrackingConfiguration": {
          "TargetValue": 70.0,
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ASGAverageCPUUtilization"
          }
        }
      }
    },
    "RequestCountScalingPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AutoScalingGroupName": {
          "Ref": "AutoScalingGroup"
        },
        "PolicyType": "TargetTrackingScaling",
        "TargetTrackingConfiguration": {
          "TargetValue": 1000.0,
          "PredefinedMetricSpecification": {
            "PredefinedMetricType": "ALBRequestCountPerTarget",
            "ResourceLabel": {
              "Fn::Join": [
                "/",
                [
                  {
                    "Fn::GetAtt": [
                      "ApplicationLoadBalancer",
                      "LoadBalancerFullName"
                    ]
                  },
                  {
                    "Fn::GetAtt": [
                      "TargetGroup",
                      "TargetGroupFullName"
                    ]
                  }
                ]
              ]
            }
          }
        }
      }
    },
    "HighCPUAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Condition": "CreateAlarms",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${Environment}-high-cpu"
        },
        "AlarmDescription": {
          "Fn::Sub": "CPU utilization exceeds 80% for ${ProjectName} ${Environment}"
        },
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 80,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": {
              "Ref": "AutoScalingGroup"
            }
          }
        ],
        "AlarmActions": [
          {
            "Fn::If": [
              "HasSNSTopic",
              {
                "Ref": "SNSAlertTopic"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "LowHealthyInstancesAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Condition": "CreateAlarms",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${Environment}-low-healthy-instances"
        },
        "AlarmDescription": {
          "Fn::Sub": "Healthy instance count below 2 for ${ProjectName} ${Environment}"
        },
        "MetricName": "HealthyHostCount",
        "Namespace": "AWS/ApplicationELB",
        "Statistic": "Average",
        "Period": 60,
        "EvaluationPeriods": 3,
        "Threshold": 2,
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "TargetGroup",
            "Value": {
              "Fn::GetAtt": [
                "TargetGroup",
                "TargetGroupFullName"
              ]
            }
          },
          {
            "Name": "LoadBalancer",
            "Value": {
              "Fn::GetAtt": [
                "ApplicationLoadBalancer",
                "LoadBalancerFullName"
              ]
            }
          }
        ],
        "AlarmActions": [
          {
            "Fn::If": [
              "HasSNSTopic",
              {
                "Ref": "SNSAlertTopic"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "TreatMissingData": "breaching"
      }
    },
    "HighResponseTimeAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Condition": "CreateAlarms",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "${ProjectName}-${Environment}-high-response-time"
        },
        "AlarmDescription": {
          "Fn::Sub": "Target response time exceeds 1 second for ${ProjectName} ${Environment}"
        },
        "MetricName": "TargetResponseTime",
        "Namespace": "AWS/ApplicationELB",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 1.0,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "LoadBalancer",
            "Value": {
              "Fn::GetAtt": [
                "ApplicationLoadBalancer",
                "LoadBalancerFullName"
              ]
            }
          }
        ],
        "AlarmActions": [
          {
            "Fn::If": [
              "HasSNSTopic",
              {
                "Ref": "SNSAlertTopic"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    }
  },
  "Outputs": {
    "LoadBalancerDNS": {
      "Description": "DNS name of the Application Load Balancer",
      "Value": {
        "Fn::GetAtt": [
          "ApplicationLoadBalancer",
          "DNSName"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-DNS"
        }
      }
    },
    "LoadBalancerArn": {
      "Description": "ARN of the Application Load Balancer",
      "Value": {
        "Ref": "ApplicationLoadBalancer"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-ARN"
        }
      }
    },
    "AutoScalingGroupName": {
      "Description": "Name of the Auto Scaling Group",
      "Value": {
        "Ref": "AutoScalingGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ASG-Name"
        }
      }
    },
    "SecurityGroupId": {
      "Description": "ID of the consolidated application security group",
      "Value": {
        "Ref": "ApplicationSecurityGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SecurityGroup-ID"
        }
      }
    },
    "ALBSecurityGroupId": {
      "Description": "ID of the ALB security group",
      "Value": {
        "Ref": "ALBSecurityGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ALB-SecurityGroup-ID"
        }
      }
    },
    "TargetGroupArn": {
      "Description": "ARN of the Target Group",
      "Value": {
        "Ref": "TargetGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-TargetGroup-ARN"
        }
      }
    },
    "ApplicationURL": {
      "Description": "URL of the trading platform application",
      "Value": {
        "Fn::Sub": "https://${ApplicationLoadBalancer.DNSName}"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Application-URL"
        }
      }
    },
    "LaunchTemplateId": {
      "Description": "ID of the Launch Template",
      "Value": {
        "Ref": "LaunchTemplate"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LaunchTemplate-ID"
        }
      }
    },
    "InstanceRoleArn": {
      "Description": "ARN of the EC2 instance IAM role",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-InstanceRole-ARN"
        }
      }
    }
  }
}
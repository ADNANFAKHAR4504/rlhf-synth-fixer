{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Meridian Financial Services - Production-Grade Containerized Transaction Processing Infrastructure with Multi-Region Support",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentName"
                    ]
                },
                {
                    "Label": {
                        "default": "Application Configuration"
                    },
                    "Parameters": [
                        "ContainerImage",
                        "ContainerRegistryURL",
                        "DeployECSService",
                        "DomainName",
                        "CertificateArn"
                    ]
                },
                {
                    "Label": {
                        "default": "Database Configuration"
                    },
                    "Parameters": [
                        "DatabaseMasterUsername",
                        "DatabaseInstanceClass"
                    ]
                },
                {
                    "Label": {
                        "default": "Compliance and Tagging"
                    },
                    "Parameters": [
                        "CostCenter",
                        "DataClassification",
                        "LogRetentionYears"
                    ]
                },
                {
                    "Label": {
                        "default": "Backup and DR Configuration"
                    },
                    "Parameters": [
                        "BackupAccountId",
                        "BackupVaultName"
                    ]
                },
                {
                    "Label": {
                        "default": "Alerting Configuration"
                    },
                    "Parameters": [
                        "DevOpsEmailAddress"
                    ]
                }
            ]
        }
    },
    "Parameters": {
        "EnvironmentName": {
            "Type": "String",
            "Default": "production",
            "AllowedValues": [
                "development",
                "staging",
                "production"
            ],
            "Description": "Environment name for resource tagging and configuration"
        },
        "CostCenter": {
            "Type": "String",
            "Default": "FIN-TECH-001",
            "Description": "Cost center code for billing allocation"
        },
        "DataClassification": {
            "Type": "String",
            "Default": "Highly-Confidential",
            "AllowedValues": [
                "Public",
                "Internal",
                "Confidential",
                "Highly-Confidential"
            ],
            "Description": "Data classification level for compliance"
        },
        "DevOpsEmailAddress": {
            "Type": "String",
            "Default": "devops@meridianfinancial.com",
            "Description": "Email address for operational alerts",
            "AllowedPattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        },
        "BackupAccountId": {
            "Type": "String",
            "Description": "AWS Account ID for cross-account backup replication",
            "AllowedPattern": "^[0-9]{12}$",
            "Default": "123456789012"
        },
        "BackupVaultName": {
            "Type": "String",
            "Default": "meridian-dr-vault",
            "Description": "Name of the backup vault in DR account"
        },
        "LambdaLayerS3Bucket": {
            "Type": "String",
            "Default": "",
            "Description": "S3 bucket containing psycopg2 Lambda layer (leave empty to skip layer)"
        },
        "LambdaLayerS3Key": {
            "Type": "String",
            "Default": "psycopg2-py39.zip",
            "Description": "S3 key for psycopg2 Lambda layer"
        },
        "ContainerImage": {
            "Type": "String",
            "Default": "transaction-processor",
            "Description": "Container image name (without registry URL and tag)"
        },
        "ContainerRegistryURL": {
            "Type": "String",
            "Default": "",
            "Description": "ECR registry URL (leave empty to use default AccountId.dkr.ecr.Region.amazonaws.com)"
        },
        "DomainName": {
            "Type": "String",
            "Default": "app.meridianfinancial.com",
            "Description": "Domain name for the application"
        },
        "CertificateArn": {
            "Type": "String",
            "Default": "",
            "Description": "ACM Certificate ARN (leave empty to create new, or set to skip certificate)"
        },
        "CreateSSLCertificate": {
            "Type": "String",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "Set to true to create SSL certificate for dummy domain (requires domain validation)"
        },
        "DeployECSService": {
            "Type": "String",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "Deploy ECS Service. Set to true ONLY after container image has been pushed to ECR. The template does not create container images - only the infrastructure to run them."
        },
        "DatabaseMasterUsername": {
            "Type": "String",
            "Default": "dbadmin",
            "Description": "Master username for Aurora PostgreSQL",
            "NoEcho": true,
            "MinLength": 1,
            "MaxLength": 16,
            "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9]*$"
        },
        "DatabaseInstanceClass": {
            "Type": "String",
            "Default": "db.r6g.xlarge",
            "Description": "Database instance class",
            "AllowedValues": [
                "db.r6g.large",
                "db.r6g.xlarge",
                "db.r6g.2xlarge",
                "db.r6g.4xlarge"
            ]
        },
        "LogRetentionYears": {
            "Type": "Number",
            "Default": 7,
            "Description": "Number of years to retain logs for compliance",
            "MinValue": 1,
            "MaxValue": 10
        }
    },
    "Mappings": {
        "SubnetConfig": {
            "VPC": {
                "CIDR": "10.0.0.0/16"
            },
            "PublicSubnet1": {
                "CIDR": "10.0.1.0/24"
            },
            "PublicSubnet2": {
                "CIDR": "10.0.2.0/24"
            },
            "PublicSubnet3": {
                "CIDR": "10.0.3.0/24"
            },
            "PrivateSubnet1": {
                "CIDR": "10.0.11.0/24"
            },
            "PrivateSubnet2": {
                "CIDR": "10.0.12.0/24"
            },
            "PrivateSubnet3": {
                "CIDR": "10.0.13.0/24"
            },
            "DatabaseSubnet1": {
                "CIDR": "10.0.21.0/24"
            },
            "DatabaseSubnet2": {
                "CIDR": "10.0.22.0/24"
            },
            "DatabaseSubnet3": {
                "CIDR": "10.0.23.0/24"
            }
        }
    },
    "Conditions": {
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentName"
                },
                "production"
            ]
        },
        "CreateCertificate": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CertificateArn"
                        },
                        ""
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateSSLCertificate"
                        },
                        "true"
                    ]
                }
            ]
        },
        "HasCertificate": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "CreateSSLCertificate"
                        },
                        "true"
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                {
                                    "Ref": "CertificateArn"
                                },
                                ""
                            ]
                        }
                    ]
                }
            ]
        },
        "UseDefaultECR": {
            "Fn::Equals": [
                {
                    "Ref": "ContainerRegistryURL"
                },
                ""
            ]
        },
        "HasBackupAccount": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "BackupAccountId"
                        },
                        "123456789012"
                    ]
                }
            ]
        },
        "HasLambdaLayer": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "LambdaLayerS3Bucket"
                        },
                        ""
                    ]
                }
            ]
        },
        "ShouldDeployECS": {
            "Fn::Equals": [
                {
                    "Ref": "DeployECSService"
                },
                "true"
            ]
        }
    },
    "Resources": {
        "ECRRepository": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": {
                    "Ref": "ContainerImage"
                },
                "ImageScanningConfiguration": {
                    "ScanOnPush": true
                },
                "ImageTagMutability": "MUTABLE",
                "EncryptionConfiguration": {
                    "EncryptionType": "AES256"
                },
                "LifecyclePolicy": {
                    "LifecyclePolicyText": "{\n  \"rules\": [\n    {\n      \"rulePriority\": 1,\n      \"description\": \"Keep last 10 images\",\n      \"selection\": {\n        \"tagStatus\": \"any\",\n        \"countType\": \"imageCountMoreThan\",\n        \"countNumber\": 10\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    }\n  ]\n}\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudWatchLogsKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "Customer managed KMS key for CloudWatch Logs encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Ref": "DataClassification"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudWatchLogsKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/meridian-cloudwatch-logs-${EnvironmentName}"
                },
                "TargetKeyId": {
                    "Ref": "CloudWatchLogsKMSKey"
                }
            }
        },
        "ApplicationCertificate": {
            "Type": "AWS::CertificateManager::Certificate",
            "Condition": "CreateCertificate",
            "Properties": {
                "DomainName": {
                    "Ref": "DomainName"
                },
                "SubjectAlternativeNames": [
                    {
                        "Fn::Sub": "*.${DomainName}"
                    }
                ],
                "ValidationMethod": "DNS",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "VPC",
                        "CIDR"
                    ]
                },
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-meridian-vpc"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPCFlowLogsRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudWatchLogPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "VPCFlowLogs": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VPC"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "cloud-watch-logs",
                "LogGroupName": {
                    "Fn::Sub": "/aws/vpc/flowlogs/${EnvironmentName}"
                },
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "VPCFlowLogsRole",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-meridian-igw"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PublicSubnet1",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-subnet-az1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PublicSubnet2",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-subnet-az2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PublicSubnet3",
                        "CIDR"
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-subnet-az3"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Public"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet1",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-az1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-ECS"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet2",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-az2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-ECS"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PrivateSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "PrivateSubnet3",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-subnet-az3"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-ECS"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "DatabaseSubnet1",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database-subnet-az1"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-Database"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "DatabaseSubnet2",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database-subnet-az2"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-Database"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSubnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        2,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": {
                    "Fn::FindInMap": [
                        "SubnetConfig",
                        "DatabaseSubnet3",
                        "CIDR"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database-subnet-az3"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Type",
                        "Value": "Private-Database"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway1EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-eip-az1"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway2EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-eip-az2"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway3EIP": {
            "Type": "AWS::EC2::EIP",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "Domain": "vpc",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-eip-az3"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway1": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway1EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-gateway-az1"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway2": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway2EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-gateway-az2"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "NatGateway3": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "NatGateway3EIP",
                        "AllocationId"
                    ]
                },
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-nat-gateway-az3"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-public-routes"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPublicRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                }
            }
        },
        "PublicSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                }
            }
        },
        "PublicSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet3"
                }
            }
        },
        "PrivateRouteTable1": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-routes-az1"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPrivateRoute1": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway1"
                }
            }
        },
        "PrivateSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet1"
                }
            }
        },
        "PrivateRouteTable2": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-routes-az2"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPrivateRoute2": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway2"
                }
            }
        },
        "PrivateSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet2"
                }
            }
        },
        "PrivateRouteTable3": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-private-routes-az3"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DefaultPrivateRoute3": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable3"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway3"
                }
            }
        },
        "PrivateSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable3"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet3"
                }
            }
        },
        "DatabaseSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable1"
                },
                "SubnetId": {
                    "Ref": "DatabaseSubnet1"
                }
            }
        },
        "DatabaseSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable2"
                },
                "SubnetId": {
                    "Ref": "DatabaseSubnet2"
                }
            }
        },
        "DatabaseSubnet3RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable3"
                },
                "SubnetId": {
                    "Ref": "DatabaseSubnet3"
                }
            }
        },
        "S3VPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.s3"
                },
                "RouteTableIds": [
                    {
                        "Ref": "PrivateRouteTable1"
                    },
                    {
                        "Ref": "PrivateRouteTable2"
                    },
                    {
                        "Ref": "PrivateRouteTable3"
                    }
                ]
            }
        },
        "ECRApiVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.ecr.api"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "ECRDkrVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.ecr.dkr"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "SecretsManagerVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.secretsmanager"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "CloudWatchLogsVPCEndpoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.logs"
                },
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true,
                "SubnetIds": [
                    {
                        "Ref": "PrivateSubnet1"
                    },
                    {
                        "Ref": "PrivateSubnet2"
                    },
                    {
                        "Ref": "PrivateSubnet3"
                    }
                ],
                "SecurityGroupIds": [
                    {
                        "Ref": "VPCEndpointSecurityGroup"
                    }
                ]
            }
        },
        "VPCEndpointSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for VPC endpoints",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "HTTPS from ECS tasks"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-vpce-sg"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Application Load Balancer",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTPS from Internet"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0",
                        "Description": "HTTP from Internet (redirect to HTTPS)"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-alb-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ECSSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for ECS tasks",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 8080,
                        "ToPort": 8080,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSecurityGroup"
                        },
                        "Description": "Traffic from ALB"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-ecs-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Aurora PostgreSQL",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "ECSSecurityGroup"
                        },
                        "Description": "PostgreSQL from ECS tasks"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 5432,
                        "ToPort": 5432,
                        "SourceSecurityGroupId": {
                            "Ref": "LambdaSecurityGroup"
                        },
                        "Description": "PostgreSQL from Lambda rotation function"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-database-sg"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LambdaSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Security group for Lambda functions",
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}-lambda-sg"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-meridian-db-credentials"
                },
                "Description": "Aurora PostgreSQL database credentials",
                "GenerateSecretString": {
                    "SecretStringTemplate": {
                        "Fn::Sub": "{\"username\": \"${DatabaseMasterUsername}\"}"
                    },
                    "GenerateStringKey": "password",
                    "PasswordLength": 32,
                    "ExcludeCharacters": "\"@/\\",
                    "RequireEachIncludedType": true
                },
                "KmsKeyId": {
                    "Ref": "SecretsManagerKMSKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Ref": "DataClassification"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SecretsManagerKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for Secrets Manager encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow Secrets Manager",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "secretsmanager.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecretRotation": {
            "Type": "AWS::SecretsManager::RotationSchedule",
            "DependsOn": [
                "DatabaseSecretAttachment",
                "AuroraPrimaryInstance"
            ],
            "Properties": {
                "SecretId": {
                    "Ref": "DatabaseSecret"
                },
                "RotationLambdaARN": {
                    "Fn::GetAtt": [
                        "DatabaseSecretRotationLambda",
                        "Arn"
                    ]
                },
                "RotationRules": {
                    "AutomaticallyAfterDays": 30
                }
            }
        },
        "DatabaseSecretRotationLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentName}-db-secret-rotation"
                },
                "PackageType": "Zip",
                "Runtime": "python3.9",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "DatabaseSecretRotationRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                            "Ref": "LambdaSecurityGroup"
                        }
                    ],
                    "SubnetIds": [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        },
                        {
                            "Ref": "PrivateSubnet3"
                        }
                    ]
                },
                "Code": {
                    "ZipFile": "import boto3\nimport json\nimport logging\nimport os\n\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\ndef handler(event, context):\n    \"\"\"Secrets Manager RDS PostgreSQL rotation handler\"\"\"\n    arn = event['SecretId']\n    token = event['Token']\n    step = event['Step']\n    \n    # Setup clients\n    sm_client = boto3.client('secretsmanager')\n    \n    metadata = sm_client.describe_secret(SecretId=arn)\n    \n    if step == \"createSecret\":\n        create_secret(sm_client, arn, token)\n    elif step == \"setSecret\":\n        set_secret(sm_client, arn, token)\n    elif step == \"testSecret\":\n        test_secret(sm_client, arn, token)\n    elif step == \"finishSecret\":\n        finish_secret(sm_client, arn, token)\n    else:\n        logger.error(f\"Unknown step: {step}\")\n        raise ValueError(f\"Unknown step: {step}\")\n    \n    return {\"statusCode\": 200}\n\ndef create_secret(sm_client, arn, token):\n    \"\"\"Create a new secret version\"\"\"\n    try:\n        sm_client.get_secret_value(SecretId=arn, VersionId=token, VersionStage=\"AWSPENDING\")\n        logger.info(\"createSecret: Secret version already exists\")\n    except sm_client.exceptions.ResourceNotFoundException:\n        # Get current secret\n        current = sm_client.get_secret_value(SecretId=arn, VersionStage=\"AWSCURRENT\")\n        secret = json.loads(current['SecretString'])\n        \n        # Generate new password\n        response = sm_client.get_random_password(\n            PasswordLength=32,\n            ExcludeCharacters='\"@/\\\\'\n        )\n        secret['password'] = response['RandomPassword']\n        \n        # Store new version\n        sm_client.put_secret_value(\n            SecretId=arn,\n            ClientRequestToken=token,\n            SecretString=json.dumps(secret),\n            VersionStages=['AWSPENDING']\n        )\n        logger.info(\"createSecret: Successfully created new secret version\")\n\ndef set_secret(sm_client, arn, token):\n    \"\"\"Set the pending secret in the database\"\"\"\n    import psycopg2\n    \n    # Get pending secret\n    pending = sm_client.get_secret_value(SecretId=arn, VersionId=token, VersionStage=\"AWSPENDING\")\n    pending_dict = json.loads(pending['SecretString'])\n    \n    # Get current secret for connection\n    current = sm_client.get_secret_value(SecretId=arn, VersionStage=\"AWSCURRENT\")\n    current_dict = json.loads(current['SecretString'])\n    \n    # Update password in database\n    try:\n        conn = psycopg2.connect(\n            host=current_dict['host'],\n            port=current_dict.get('port', 5432),\n            database=current_dict.get('dbname', 'postgres'),\n            user=current_dict['username'],\n            password=current_dict['password']\n        )\n        \n        with conn.cursor() as cursor:\n            cursor.execute(\n                f\"ALTER USER {pending_dict['username']} WITH PASSWORD %s\",\n                (pending_dict['password'],)\n            )\n        conn.commit()\n        conn.close()\n        logger.info(\"setSecret: Successfully set password in database\")\n    except Exception as e:\n        logger.error(f\"setSecret: Failed to set password: {str(e)}\")\n        raise\n\ndef test_secret(sm_client, arn, token):\n    \"\"\"Test the pending secret\"\"\"\n    import psycopg2\n    \n    # Get pending secret\n    pending = sm_client.get_secret_value(SecretId=arn, VersionId=token, VersionStage=\"AWSPENDING\")\n    pending_dict = json.loads(pending['SecretString'])\n    \n    # Test connection\n    try:\n        conn = psycopg2.connect(\n            host=pending_dict['host'],\n            port=pending_dict.get('port', 5432),\n            database=pending_dict.get('dbname', 'postgres'),\n            user=pending_dict['username'],\n            password=pending_dict['password']\n        )\n        conn.close()\n        logger.info(\"testSecret: Successfully tested new password\")\n    except Exception as e:\n        logger.error(f\"testSecret: Failed to connect with new password: {str(e)}\")\n        raise\n\ndef finish_secret(sm_client, arn, token):\n    \"\"\"Finish the rotation by updating version stages\"\"\"\n    metadata = sm_client.describe_secret(SecretId=arn)\n    \n    for version in metadata.get('VersionIdsToStages', {}):\n        if \"AWSCURRENT\" in metadata['VersionIdsToStages'][version]:\n            if version == token:\n                logger.info(\"finishSecret: Version already current\")\n                return\n            \n            # Move staging labels\n            sm_client.update_secret_version_stage(\n                SecretId=arn,\n                VersionStage=\"AWSCURRENT\",\n                MoveToVersionId=token,\n                RemoveFromVersionId=version\n            )\n            logger.info(\"finishSecret: Successfully updated secret version\")\n            return\n"
                },
                "Layers": {
                    "Fn::If": [
                        "HasLambdaLayer",
                        [
                            {
                                "Ref": "DatabaseRotationLambdaLayer"
                            }
                        ],
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Environment": {
                    "Variables": {
                        "SECRETS_MANAGER_ENDPOINT": {
                            "Fn::Sub": "https://secretsmanager.${AWS::Region}.amazonaws.com"
                        }
                    }
                },
                "Timeout": 30,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseRotationLambdaLayer": {
            "Type": "AWS::Lambda::LayerVersion",
            "Condition": "HasLambdaLayer",
            "Properties": {
                "LayerName": {
                    "Fn::Sub": "${EnvironmentName}-psycopg2-layer"
                },
                "Description": "PostgreSQL client library for Python",
                "Content": {
                    "S3Bucket": {
                        "Ref": "LambdaLayerS3Bucket"
                    },
                    "S3Key": {
                        "Ref": "LambdaLayerS3Key"
                    }
                },
                "CompatibleRuntimes": [
                    "python3.9"
                ]
            }
        },
        "DatabaseSecretRotationRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretRotationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:PutSecretValue",
                                        "secretsmanager:UpdateSecretVersionStage",
                                        "secretsmanager:GetRandomPassword"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "SecretsManagerKMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseSecretRotationLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "DatabaseSecretRotationLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "secretsmanager.amazonaws.com"
            }
        },
        "DatabaseSecretAttachment": {
            "Type": "AWS::SecretsManager::SecretTargetAttachment",
            "Properties": {
                "SecretId": {
                    "Ref": "DatabaseSecret"
                },
                "TargetId": {
                    "Ref": "AuroraCluster"
                },
                "TargetType": "AWS::RDS::DBCluster"
            }
        },
        "DBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Properties": {
                "DBSubnetGroupName": {
                    "Fn::Sub": "${EnvironmentName}-aurora-subnet-group"
                },
                "DBSubnetGroupDescription": "Subnet group for Aurora PostgreSQL",
                "SubnetIds": [
                    {
                        "Ref": "DatabaseSubnet1"
                    },
                    {
                        "Ref": "DatabaseSubnet2"
                    },
                    {
                        "Ref": "DatabaseSubnet3"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DBClusterParameterGroup": {
            "Type": "AWS::RDS::DBClusterParameterGroup",
            "Properties": {
                "Description": "Custom cluster parameter group for Aurora PostgreSQL",
                "Family": "aurora-postgresql14",
                "Parameters": {
                    "shared_preload_libraries": "pg_stat_statements,pgaudit",
                    "log_statement": "all",
                    "log_min_duration_statement": 1000,
                    "pgaudit.log": "ALL",
                    "pgaudit.log_catalog": "on",
                    "pgaudit.log_level": "log",
                    "pgaudit.log_parameter": "on",
                    "pgaudit.log_relation": "on",
                    "pgaudit.log_statement_once": "on"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DBParameterGroup": {
            "Type": "AWS::RDS::DBParameterGroup",
            "Properties": {
                "Description": "Custom parameter group for Aurora PostgreSQL instances",
                "Family": "aurora-postgresql14",
                "Parameters": {
                    "max_connections": {
                        "Fn::If": [
                            "IsProduction",
                            "1000",
                            "500"
                        ]
                    },
                    "shared_buffers": {
                        "Fn::If": [
                            "IsProduction",
                            "2097152",
                            "1048576"
                        ]
                    },
                    "effective_cache_size": {
                        "Fn::If": [
                            "IsProduction",
                            "6291456",
                            "3145728"
                        ]
                    },
                    "work_mem": {
                        "Fn::If": [
                            "IsProduction",
                            "16384",
                            "8192"
                        ]
                    },
                    "maintenance_work_mem": {
                        "Fn::If": [
                            "IsProduction",
                            "524288",
                            "262144"
                        ]
                    },
                    "random_page_cost": "1.1",
                    "default_statistics_target": "100"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "AuroraCluster": {
            "Type": "AWS::RDS::DBCluster",
            "Properties": {
                "Engine": "aurora-postgresql",
                "EngineVersion": "14.6",
                "DBClusterIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-meridian-aurora-cluster"
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}"
                },
                "DatabaseName": "meridian_transactions",
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "VpcSecurityGroupIds": [
                    {
                        "Ref": "DatabaseSecurityGroup"
                    }
                ],
                "DBClusterParameterGroupName": {
                    "Ref": "DBClusterParameterGroup"
                },
                "BackupRetentionPeriod": {
                    "Fn::If": [
                        "IsProduction",
                        30,
                        7
                    ]
                },
                "PreferredBackupWindow": "03:00-04:00",
                "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
                "EnableCloudwatchLogsExports": [
                    "postgresql"
                ],
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "DatabaseKMSKey"
                },
                "DeletionProtection": false,
                "EnableIAMDatabaseAuthentication": true,
                "CopyTagsToSnapshot": true,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Ref": "DataClassification"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DatabaseKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for Aurora database encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow RDS",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "rds.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "AuroraPrimaryInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-meridian-aurora-primary"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "DBInstanceClass": {
                    "Ref": "DatabaseInstanceClass"
                },
                "Engine": "aurora-postgresql",
                "DBParameterGroupName": {
                    "Ref": "DBParameterGroup"
                },
                "PubliclyAccessible": false,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "EnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "PerformanceInsightsRetentionPeriod": {
                    "Fn::If": [
                        "IsProduction",
                        731,
                        7
                    ]
                },
                "PerformanceInsightsKMSKeyId": {
                    "Ref": "DatabaseKMSKey"
                },
                "EnablePerformanceInsights": true,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "AuroraSecondaryInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "${EnvironmentName}-meridian-aurora-secondary"
                },
                "DBClusterIdentifier": {
                    "Ref": "AuroraCluster"
                },
                "DBInstanceClass": {
                    "Ref": "DatabaseInstanceClass"
                },
                "Engine": "aurora-postgresql",
                "DBParameterGroupName": {
                    "Ref": "DBParameterGroup"
                },
                "PubliclyAccessible": false,
                "MonitoringInterval": 60,
                "MonitoringRoleArn": {
                    "Fn::GetAtt": [
                        "EnhancedMonitoringRole",
                        "Arn"
                    ]
                },
                "PerformanceInsightsRetentionPeriod": {
                    "Fn::If": [
                        "IsProduction",
                        731,
                        7
                    ]
                },
                "PerformanceInsightsKMSKeyId": {
                    "Ref": "DatabaseKMSKey"
                },
                "EnablePerformanceInsights": true,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EnhancedMonitoringRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "monitoring.rds.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "BackupReplicationRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-backup-replication-role"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        },
                        {
                            "Fn::If": [
                                "HasBackupAccount",
                                {
                                    "Effect": "Allow",
                                    "Principal": {
                                        "AWS": {
                                            "Fn::Sub": "arn:aws:iam::${BackupAccountId}:root"
                                        }
                                    },
                                    "Action": "sts:AssumeRole",
                                    "Condition": {
                                        "StringEquals": {
                                            "sts:ExternalId": {
                                                "Fn::Sub": "${EnvironmentName}-backup-replication"
                                            }
                                        }
                                    }
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "BackupReplicationPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "rds:CreateDBSnapshot",
                                        "rds:CopyDBSnapshot",
                                        "rds:DescribeDBSnapshots",
                                        "rds:ModifyDBSnapshotAttribute",
                                        "rds:CopyDBClusterSnapshot",
                                        "rds:CreateDBClusterSnapshot",
                                        "rds:DescribeDBClusterSnapshots"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:CreateGrant",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "BackupKMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "BackupPlan": {
            "Type": "AWS::Backup::BackupPlan",
            "Properties": {
                "BackupPlan": {
                    "BackupPlanName": {
                        "Fn::Sub": "${EnvironmentName}-meridian-backup-plan"
                    },
                    "Rules": [
                        {
                            "RuleName": "DailyBackups",
                            "TargetBackupVault": {
                                "Ref": "BackupVault"
                            },
                            "ScheduleExpression": "cron(0 2 * * ? *)",
                            "StartWindowMinutes": 60,
                            "CompletionWindowMinutes": 120,
                            "Lifecycle": {
                                "MoveToColdStorageAfterDays": {
                                    "Fn::If": [
                                        "IsProduction",
                                        30,
                                        7
                                    ]
                                },
                                "DeleteAfterDays": {
                                    "Fn::If": [
                                        "IsProduction",
                                        365,
                                        120
                                    ]
                                }
                            },
                            "RecoveryPointTags": {
                                "Environment": {
                                    "Ref": "EnvironmentName"
                                },
                                "DataClassification": {
                                    "Ref": "DataClassification"
                                }
                            },
                            "CopyActions": [
                                {
                                    "DestinationBackupVaultArn": {
                                        "Fn::Sub": "arn:aws:backup:${AWS::Region}:${BackupAccountId}:backup-vault:${BackupVaultName}"
                                    },
                                    "Lifecycle": {
                                        "MoveToColdStorageAfterDays": 7,
                                        "DeleteAfterDays": 2555
                                    }
                                }
                            ]
                        },
                        {
                            "RuleName": "WeeklyBackups",
                            "TargetBackupVault": {
                                "Ref": "BackupVault"
                            },
                            "ScheduleExpression": "cron(0 3 ? * 1 *)",
                            "StartWindowMinutes": 60,
                            "CompletionWindowMinutes": 120,
                            "Lifecycle": {
                                "MoveToColdStorageAfterDays": {
                                    "Fn::If": [
                                        "IsProduction",
                                        90,
                                        30
                                    ]
                                },
                                "DeleteAfterDays": {
                                    "Fn::If": [
                                        "IsProduction",
                                        730,
                                        180
                                    ]
                                }
                            },
                            "RecoveryPointTags": {
                                "Environment": {
                                    "Ref": "EnvironmentName"
                                },
                                "BackupType": "Weekly"
                            }
                        }
                    ]
                },
                "BackupPlanTags": {
                    "Environment": {
                        "Ref": "EnvironmentName"
                    },
                    "iac-rlhf-amazon": "true"
                }
            }
        },
        "BackupVault": {
            "Type": "AWS::Backup::BackupVault",
            "Properties": {
                "BackupVaultName": {
                    "Fn::Sub": "${EnvironmentName}-meridian-backup-vault"
                },
                "EncryptionKeyArn": {
                    "Fn::GetAtt": [
                        "BackupKMSKey",
                        "Arn"
                    ]
                },
                "BackupVaultTags": {
                    "Environment": {
                        "Ref": "EnvironmentName"
                    },
                    "DataClassification": {
                        "Ref": "DataClassification"
                    },
                    "iac-rlhf-amazon": "true"
                }
            }
        },
        "BackupKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for AWS Backup encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow AWS Backup",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:DescribeKey",
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Fn::If": [
                                "HasBackupAccount",
                                {
                                    "Sid": "Allow cross-account access",
                                    "Effect": "Allow",
                                    "Principal": {
                                        "AWS": {
                                            "Fn::Sub": "arn:aws:iam::${BackupAccountId}:root"
                                        }
                                    },
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Ref": "AWS::NoValue"
                                }
                            ]
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "BackupSelection": {
            "Type": "AWS::Backup::BackupSelection",
            "Properties": {
                "BackupPlanId": {
                    "Ref": "BackupPlan"
                },
                "BackupSelection": {
                    "SelectionName": {
                        "Fn::Sub": "${EnvironmentName}-aurora-backup-selection"
                    },
                    "IamRoleArn": {
                        "Fn::GetAtt": [
                            "BackupRole",
                            "Arn"
                        ]
                    },
                    "Resources": [
                        {
                            "Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${AuroraCluster}"
                        }
                    ],
                    "ListOfTags": [
                        {
                            "ConditionType": "STRINGEQUALS",
                            "ConditionKey": "DataClassification",
                            "ConditionValue": {
                                "Ref": "DataClassification"
                            }
                        }
                    ]
                }
            }
        },
        "BackupRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup",
                    "arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "Properties": {
                "ClusterName": {
                    "Fn::Sub": "${EnvironmentName}-meridian-cluster"
                },
                "ClusterSettings": [
                    {
                        "Name": "containerInsights",
                        "Value": "enabled"
                    }
                ],
                "Configuration": {
                    "ExecuteCommandConfiguration": {
                        "Logging": "OVERRIDE",
                        "LogConfiguration": {
                            "CloudWatchLogGroupName": {
                                "Ref": "ECSLogGroup"
                            }
                        }
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ECSLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/ecs/${EnvironmentName}-meridian"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionYears"
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "CloudWatchLogsKMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Ref": "DataClassification"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-ecs-task-execution-role"
                },
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretAndRegistryAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "SecretsManagerKMSKey",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "CloudWatchLogsKMSKey",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecr:GetAuthorizationToken",
                                        "ecr:BatchCheckLayerAvailability",
                                        "ecr:GetDownloadUrlForLayer",
                                        "ecr:BatchGetImage"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ECSTaskRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "${EnvironmentName}-ecs-task-role"
                },
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "TaskPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "SecretsManagerKMSKey",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "CloudWatchLogsKMSKey",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ECSLogGroup",
                                            "Arn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "xray:PutTraceSegments",
                                        "xray:PutTelemetryRecords"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssmmessages:CreateControlChannel",
                                        "ssmmessages:CreateDataChannel",
                                        "ssmmessages:OpenControlChannel",
                                        "ssmmessages:OpenDataChannel"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "TaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "Family": {
                    "Fn::Sub": "${EnvironmentName}-meridian-task"
                },
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "Cpu": "2048",
                "Memory": "4096",
                "ExecutionRoleArn": {
                    "Ref": "ECSTaskExecutionRole"
                },
                "TaskRoleArn": {
                    "Ref": "ECSTaskRole"
                },
                "ContainerDefinitions": [
                    {
                        "Name": "transaction-processor",
                        "Image": {
                            "Fn::If": [
                                "UseDefaultECR",
                                {
                                    "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ContainerImage}:latest"
                                },
                                {
                                    "Fn::Sub": "${ContainerRegistryURL}/${ContainerImage}:latest"
                                }
                            ]
                        },
                        "Essential": true,
                        "User": "1000:1000",
                        "LinuxParameters": {
                            "InitProcessEnabled": true
                        },
                        "PortMappings": [
                            {
                                "ContainerPort": 8080,
                                "Protocol": "tcp"
                            }
                        ],
                        "Environment": [
                            {
                                "Name": "ENVIRONMENT",
                                "Value": {
                                    "Ref": "EnvironmentName"
                                }
                            },
                            {
                                "Name": "DB_HOST",
                                "Value": {
                                    "Fn::GetAtt": [
                                        "AuroraCluster",
                                        "Endpoint.Address"
                                    ]
                                }
                            },
                            {
                                "Name": "DB_PORT",
                                "Value": "5432"
                            },
                            {
                                "Name": "DB_NAME",
                                "Value": "meridian_transactions"
                            },
                            {
                                "Name": "AWS_REGION",
                                "Value": {
                                    "Ref": "AWS::Region"
                                }
                            },
                            {
                                "Name": "LOG_LEVEL",
                                "Value": {
                                    "Fn::If": [
                                        "IsProduction",
                                        "INFO",
                                        "DEBUG"
                                    ]
                                }
                            },
                            {
                                "Name": "STARTUP_DELAY_SECONDS",
                                "Value": "30"
                            }
                        ],
                        "Secrets": [
                            {
                                "Name": "DB_USERNAME",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:username::"
                                }
                            },
                            {
                                "Name": "DB_PASSWORD",
                                "ValueFrom": {
                                    "Fn::Sub": "${DatabaseSecret}:password::"
                                }
                            }
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ECSLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        },
                        "StopTimeout": 30
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Ref": "DataClassification"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ApplicationLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "DependsOn": "ALBAccessLogsBucketPolicy",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-meridian-alb"
                },
                "Scheme": "internet-facing",
                "Type": "application",
                "SecurityGroups": [
                    {
                        "Ref": "ALBSecurityGroup"
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "PublicSubnet1"
                    },
                    {
                        "Ref": "PublicSubnet2"
                    },
                    {
                        "Ref": "PublicSubnet3"
                    }
                ],
                "LoadBalancerAttributes": [
                    {
                        "Key": "idle_timeout.timeout_seconds",
                        "Value": "60"
                    },
                    {
                        "Key": "routing.http2.enabled",
                        "Value": "true"
                    },
                    {
                        "Key": "access_logs.s3.enabled",
                        "Value": "true"
                    },
                    {
                        "Key": "access_logs.s3.bucket",
                        "Value": {
                            "Ref": "ALBAccessLogsBucket"
                        }
                    },
                    {
                        "Key": "access_logs.s3.prefix",
                        "Value": {
                            "Fn::Sub": "${EnvironmentName}/alb"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBAccessLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldAccessLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 90
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBAccessLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ALBAccessLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowALBAccessLogs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "delivery.logs.amazonaws.com",
                                    "logdelivery.elasticloadbalancing.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "s3:PutObject"
                            ],
                            "Resource": {
                                "Fn::Sub": "${ALBAccessLogsBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control",
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AllowALBBucketCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "delivery.logs.amazonaws.com",
                                    "logdelivery.elasticloadbalancing.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "s3:GetBucketAcl",
                                "s3:PutBucketAcl"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ALBAccessLogsBucket",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ALBTargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-meridian-tg"
                },
                "Port": 8080,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "ip",
                "HealthCheckEnabled": true,
                "HealthCheckPath": "/health",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 10,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Matcher": {
                    "HttpCode": "200-299"
                },
                "TargetGroupAttributes": [
                    {
                        "Key": "deregistration_delay.timeout_seconds",
                        "Value": "30"
                    },
                    {
                        "Key": "stickiness.enabled",
                        "Value": "true"
                    },
                    {
                        "Key": "stickiness.type",
                        "Value": "lb_cookie"
                    },
                    {
                        "Key": "stickiness.lb_cookie.duration_seconds",
                        "Value": "86400"
                    },
                    {
                        "Key": "load_balancing.algorithm.type",
                        "Value": "least_outstanding_requests"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBTargetGroupBlueGreen": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-meridian-tg-bg"
                },
                "Port": 8080,
                "Protocol": "HTTP",
                "VpcId": {
                    "Ref": "VPC"
                },
                "TargetType": "ip",
                "HealthCheckEnabled": true,
                "HealthCheckPath": "/health",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckIntervalSeconds": 30,
                "HealthCheckTimeoutSeconds": 10,
                "HealthyThresholdCount": 2,
                "UnhealthyThresholdCount": 3,
                "Matcher": {
                    "HttpCode": "200-299"
                },
                "TargetGroupAttributes": [
                    {
                        "Key": "deregistration_delay.timeout_seconds",
                        "Value": "30"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "BlueGreenDeployment"
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ALBListenerHTTP": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 80,
                "Protocol": "HTTP",
                "DefaultActions": {
                    "Fn::If": [
                        "HasCertificate",
                        [
                            {
                                "Type": "redirect",
                                "RedirectConfig": {
                                    "Protocol": "HTTPS",
                                    "Port": "443",
                                    "StatusCode": "HTTP_301"
                                }
                            }
                        ],
                        [
                            {
                                "Type": "forward",
                                "TargetGroupArn": {
                                    "Ref": "ALBTargetGroup"
                                }
                            }
                        ]
                    ]
                }
            }
        },
        "ALBListenerHTTPS": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Condition": "HasCertificate",
            "Properties": {
                "LoadBalancerArn": {
                    "Ref": "ApplicationLoadBalancer"
                },
                "Port": 443,
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Fn::If": [
                                "CreateCertificate",
                                {
                                    "Ref": "ApplicationCertificate"
                                },
                                {
                                    "Ref": "CertificateArn"
                                }
                            ]
                        }
                    }
                ],
                "SslPolicy": "ELBSecurityPolicy-TLS-1-2-2017-01",
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ]
            }
        },
        "ALBListenerRuleBlueGreen": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Condition": "HasCertificate",
            "Properties": {
                "ListenerArn": {
                    "Ref": "ALBListenerHTTPS"
                },
                "Priority": 100,
                "Conditions": [
                    {
                        "Field": "http-header",
                        "HttpHeaderConfig": {
                            "HttpHeaderName": "X-Deployment-Version",
                            "Values": [
                                "blue-green-test"
                            ]
                        }
                    }
                ],
                "Actions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroupBlueGreen"
                        }
                    }
                ]
            }
        },
        "ECSService": {
            "Type": "AWS::ECS::Service",
            "Condition": "ShouldDeployECS",
            "DependsOn": [
                "ALBListenerHTTP",
                "AuroraPrimaryInstance",
                "ECRApiVPCEndpoint",
                "ECRDkrVPCEndpoint",
                "CloudWatchLogsVPCEndpoint",
                "SecretsManagerVPCEndpoint"
            ],
            "Properties": {
                "ServiceName": {
                    "Fn::Sub": "${EnvironmentName}-meridian-service"
                },
                "Cluster": {
                    "Ref": "ECSCluster"
                },
                "TaskDefinition": {
                    "Ref": "TaskDefinition"
                },
                "DesiredCount": {
                    "Fn::If": [
                        "IsProduction",
                        3,
                        2
                    ]
                },
                "LaunchType": "FARGATE",
                "PlatformVersion": "LATEST",
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "DISABLED",
                        "SecurityGroups": [
                            {
                                "Ref": "ECSSecurityGroup"
                            }
                        ],
                        "Subnets": [
                            {
                                "Ref": "PrivateSubnet1"
                            },
                            {
                                "Ref": "PrivateSubnet2"
                            },
                            {
                                "Ref": "PrivateSubnet3"
                            }
                        ]
                    }
                },
                "LoadBalancers": [
                    {
                        "ContainerName": "transaction-processor",
                        "ContainerPort": 8080,
                        "TargetGroupArn": {
                            "Ref": "ALBTargetGroup"
                        }
                    }
                ],
                "HealthCheckGracePeriodSeconds": 180,
                "DeploymentConfiguration": {
                    "MaximumPercent": 200,
                    "MinimumHealthyPercent": 50,
                    "DeploymentCircuitBreaker": {
                        "Enable": true,
                        "Rollback": true
                    }
                },
                "DeploymentController": {
                    "Type": "ECS"
                },
                "EnableECSManagedTags": true,
                "EnableExecuteCommand": true,
                "PropagateTags": "SERVICE",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "ServiceScalingTarget": {
            "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
            "Condition": "ShouldDeployECS",
            "Properties": {
                "MaxCapacity": {
                    "Fn::If": [
                        "IsProduction",
                        20,
                        10
                    ]
                },
                "MinCapacity": {
                    "Fn::If": [
                        "IsProduction",
                        3,
                        2
                    ]
                },
                "ResourceId": {
                    "Fn::Sub": "service/${ECSCluster}/${ECSService.Name}"
                },
                "RoleARN": {
                    "Fn::GetAtt": [
                        "AutoScalingRole",
                        "Arn"
                    ]
                },
                "ScalableDimension": "ecs:service:DesiredCount",
                "ServiceNamespace": "ecs"
            }
        },
        "ServiceScalingPolicy": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Condition": "ShouldDeployECS",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "${EnvironmentName}-cpu-scaling-policy"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "ServiceScalingTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
                    },
                    "TargetValue": 70.0,
                    "ScaleInCooldown": 300,
                    "ScaleOutCooldown": 60
                }
            }
        },
        "ServiceScalingPolicyMemory": {
            "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
            "Condition": "ShouldDeployECS",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "${EnvironmentName}-memory-scaling-policy"
                },
                "PolicyType": "TargetTrackingScaling",
                "ScalingTargetId": {
                    "Ref": "ServiceScalingTarget"
                },
                "TargetTrackingScalingPolicyConfiguration": {
                    "PredefinedMetricSpecification": {
                        "PredefinedMetricType": "ECSServiceAverageMemoryUtilization"
                    },
                    "TargetValue": 75.0,
                    "ScaleInCooldown": 300,
                    "ScaleOutCooldown": 60
                }
            }
        },
        "AutoScalingRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "application-autoscaling.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "AutoScalingPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecs:DescribeServices",
                                        "ecs:UpdateService"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricAlarm",
                                        "cloudwatch:DescribeAlarms",
                                        "cloudwatch:DeleteAlarms"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SNSTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "${EnvironmentName}-meridian-ops-alerts"
                },
                "DisplayName": "Meridian Operational Alerts",
                "KmsMasterKeyId": "alias/aws/sns",
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentName"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SNSSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "SNSTopic"
                },
                "Endpoint": {
                    "Ref": "DevOpsEmailAddress"
                }
            }
        },
        "MonitoringDashboard": {
            "Type": "AWS::CloudWatch::Dashboard",
            "Properties": {
                "DashboardName": {
                    "Fn::Sub": "${EnvironmentName}-meridian-dashboard"
                },
                "DashboardBody": {
                    "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/ECS\", \"CPUUtilization\", {\"stat\": \"Average\"}],\n          [\".\", \"MemoryUtilization\", {\"stat\": \"Average\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"ECS Resource Utilization\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/ApplicationELB\", \"TargetResponseTime\", {\"stat\": \"Average\"}],\n          [\".\", \"RequestCount\", {\"stat\": \"Sum\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"ALB Performance\"\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/RDS\", \"DatabaseConnections\", {\"stat\": \"Average\"}],\n          [\".\", \"CPUUtilization\", {\"stat\": \"Average\"}]\n        ],\n        \"period\": 300,\n        \"stat\": \"Average\",\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Aurora Database Metrics\"\n      }\n    }\n  ]\n}\n"
                }
            }
        },
        "HighCPUAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "ShouldDeployECS",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-ecs-high-cpu"
                },
                "AlarmDescription": "Alarm when ECS service CPU exceeds 80%",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/ECS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 80,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "ServiceName",
                        "Value": {
                            "Fn::GetAtt": [
                                "ECSService",
                                "Name"
                            ]
                        }
                    },
                    {
                        "Name": "ClusterName",
                        "Value": {
                            "Ref": "ECSCluster"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DatabaseConnectionsAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-aurora-high-connections"
                },
                "AlarmDescription": "Alarm when database connections exceed threshold",
                "MetricName": "DatabaseConnections",
                "Namespace": "AWS/RDS",
                "Statistic": "Average",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": {
                    "Fn::If": [
                        "IsProduction",
                        900,
                        450
                    ]
                },
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "DBClusterIdentifier",
                        "Value": {
                            "Ref": "AuroraCluster"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "ALBUnhealthyHostAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-alb-unhealthy-hosts"
                },
                "AlarmDescription": "Alarm when target group has unhealthy hosts",
                "MetricName": "UnHealthyHostCount",
                "Namespace": "AWS/ApplicationELB",
                "Statistic": "Maximum",
                "Period": 60,
                "EvaluationPeriods": 2,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanOrEqualToThreshold",
                "Dimensions": [
                    {
                        "Name": "TargetGroup",
                        "Value": {
                            "Fn::GetAtt": [
                                "ALBTargetGroup",
                                "TargetGroupFullName"
                            ]
                        }
                    },
                    {
                        "Name": "LoadBalancer",
                        "Value": {
                            "Fn::GetAtt": [
                                "ApplicationLoadBalancer",
                                "LoadBalancerFullName"
                            ]
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Ref": "SNSTopic"
                    }
                ]
            }
        },
        "RollbackAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "ShouldDeployECS",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "${EnvironmentName}-stack-rollback-trigger"
                },
                "AlarmDescription": "Triggers CloudFormation stack rollback on critical failures",
                "MetricName": "HealthyHostCount",
                "Namespace": "AWS/ApplicationELB",
                "Statistic": "Minimum",
                "Period": 60,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "LessThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TargetGroup",
                        "Value": {
                            "Fn::GetAtt": [
                                "ALBTargetGroup",
                                "TargetGroupFullName"
                            ]
                        }
                    },
                    {
                        "Name": "LoadBalancer",
                        "Value": {
                            "Fn::GetAtt": [
                                "ApplicationLoadBalancer",
                                "LoadBalancerFullName"
                            ]
                        }
                    }
                ],
                "TreatMissingData": "breaching"
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-vpc-id"
                }
            }
        },
        "VPCCidrBlock": {
            "Description": "VPC CIDR Block",
            "Value": {
                "Fn::GetAtt": [
                    "VPC",
                    "CidrBlock"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-vpc-cidr"
                }
            }
        },
        "PublicSubnetIds": {
            "Description": "Comma-delimited list of public subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PublicSubnet1"
                        },
                        {
                            "Ref": "PublicSubnet2"
                        },
                        {
                            "Ref": "PublicSubnet3"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-public-subnet-ids"
                }
            }
        },
        "PrivateSubnetIds": {
            "Description": "Comma-delimited list of private subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "PrivateSubnet1"
                        },
                        {
                            "Ref": "PrivateSubnet2"
                        },
                        {
                            "Ref": "PrivateSubnet3"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-private-subnet-ids"
                }
            }
        },
        "DatabaseSubnetIds": {
            "Description": "Comma-delimited list of database subnet IDs",
            "Value": {
                "Fn::Join": [
                    ",",
                    [
                        {
                            "Ref": "DatabaseSubnet1"
                        },
                        {
                            "Ref": "DatabaseSubnet2"
                        },
                        {
                            "Ref": "DatabaseSubnet3"
                        }
                    ]
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-database-subnet-ids"
                }
            }
        },
        "ECRRepositoryURI": {
            "Description": "ECR Repository URI",
            "Value": {
                "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecr-repository-uri"
                }
            }
        },
        "LoadBalancerURL": {
            "Description": "Application Load Balancer URL",
            "Value": {
                "Fn::If": [
                    "HasCertificate",
                    {
                        "Fn::Sub": "https://${ApplicationLoadBalancer.DNSName}"
                    },
                    {
                        "Fn::Sub": "http://${ApplicationLoadBalancer.DNSName}"
                    }
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-alb-url"
                }
            }
        },
        "LoadBalancerArn": {
            "Description": "Application Load Balancer ARN",
            "Value": {
                "Ref": "ApplicationLoadBalancer"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-alb-arn"
                }
            }
        },
        "LoadBalancerDNSName": {
            "Description": "Application Load Balancer DNS Name",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "DNSName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-alb-dns"
                }
            }
        },
        "LoadBalancerZoneId": {
            "Description": "Application Load Balancer Canonical Hosted Zone ID",
            "Value": {
                "Fn::GetAtt": [
                    "ApplicationLoadBalancer",
                    "CanonicalHostedZoneID"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-alb-zone-id"
                }
            }
        },
        "ECSClusterName": {
            "Description": "ECS Cluster Name",
            "Value": {
                "Ref": "ECSCluster"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-cluster"
                }
            }
        },
        "ECSClusterArn": {
            "Description": "ECS Cluster ARN",
            "Value": {
                "Fn::GetAtt": [
                    "ECSCluster",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-cluster-arn"
                }
            }
        },
        "ECSServiceName": {
            "Condition": "ShouldDeployECS",
            "Description": "ECS Service Name",
            "Value": {
                "Fn::GetAtt": [
                    "ECSService",
                    "Name"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-service-name"
                }
            }
        },
        "ECSServiceArn": {
            "Condition": "ShouldDeployECS",
            "Description": "ECS Service ARN",
            "Value": {
                "Ref": "ECSService"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-service-arn"
                }
            }
        },
        "TaskDefinitionArn": {
            "Description": "ECS Task Definition ARN",
            "Value": {
                "Ref": "TaskDefinition"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-task-definition-arn"
                }
            }
        },
        "DatabaseEndpoint": {
            "Description": "Aurora Cluster Write Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "Endpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-endpoint"
                }
            }
        },
        "DatabaseReadEndpoint": {
            "Description": "Aurora Cluster Read Endpoint",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "ReadEndpoint.Address"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-read-endpoint"
                }
            }
        },
        "DatabasePort": {
            "Description": "Aurora Cluster Port",
            "Value": {
                "Fn::GetAtt": [
                    "AuroraCluster",
                    "Endpoint.Port"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-port"
                }
            }
        },
        "DatabaseSecretArn": {
            "Description": "Database Secret ARN",
            "Value": {
                "Ref": "DatabaseSecret"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-secret"
                }
            }
        },
        "DatabaseName": {
            "Description": "Database Name",
            "Value": "meridian_transactions",
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-name"
                }
            }
        },
        "ALBSecurityGroupId": {
            "Description": "ALB Security Group ID",
            "Value": {
                "Ref": "ALBSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-alb-sg"
                }
            }
        },
        "ECSSecurityGroupId": {
            "Description": "ECS Security Group ID",
            "Value": {
                "Ref": "ECSSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-sg"
                }
            }
        },
        "DatabaseSecurityGroupId": {
            "Description": "Database Security Group ID",
            "Value": {
                "Ref": "DatabaseSecurityGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-sg"
                }
            }
        },
        "SNSTopicArn": {
            "Description": "SNS Topic ARN for alerts",
            "Value": {
                "Ref": "SNSTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-sns-topic"
                }
            }
        },
        "DashboardURL": {
            "Description": "CloudWatch Dashboard URL",
            "Value": {
                "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${EnvironmentName}-meridian-dashboard"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-dashboard-url"
                }
            }
        },
        "ALBTargetGroupArn": {
            "Description": "Primary Target Group ARN",
            "Value": {
                "Ref": "ALBTargetGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-tg-arn"
                }
            }
        },
        "ALBTargetGroupBlueGreenArn": {
            "Description": "Blue-Green Target Group ARN",
            "Value": {
                "Ref": "ALBTargetGroupBlueGreen"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-tg-bg-arn"
                }
            }
        },
        "BackupVaultArn": {
            "Description": "Backup Vault ARN",
            "Value": {
                "Fn::GetAtt": [
                    "BackupVault",
                    "BackupVaultArn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-backup-vault-arn"
                }
            }
        },
        "BackupPlanId": {
            "Description": "Backup Plan ID",
            "Value": {
                "Ref": "BackupPlan"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-backup-plan-id"
                }
            }
        },
        "BackupVaultName": {
            "Description": "Backup Vault Name",
            "Value": {
                "Fn::Sub": "${EnvironmentName}-meridian-backup-vault"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-backup-vault-name"
                }
            }
        },
        "BackupRoleArn": {
            "Description": "Backup Role ARN",
            "Value": {
                "Fn::GetAtt": [
                    "BackupRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-backup-role-arn"
                }
            }
        },
        "ECSLogGroupArn": {
            "Description": "ECS CloudWatch Log Group ARN",
            "Value": {
                "Fn::GetAtt": [
                    "ECSLogGroup",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-ecs-log-group-arn"
                }
            }
        },
        "CloudWatchLogsKMSKeyArn": {
            "Description": "CloudWatch Logs KMS Key ARN",
            "Value": {
                "Fn::GetAtt": [
                    "CloudWatchLogsKMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-logs-kms-key"
                }
            }
        },
        "DatabaseKMSKeyArn": {
            "Description": "Database KMS Key ARN",
            "Value": {
                "Fn::GetAtt": [
                    "DatabaseKMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${EnvironmentName}-db-kms-key"
                }
            }
        }
    }
}
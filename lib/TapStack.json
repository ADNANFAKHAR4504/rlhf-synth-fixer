{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "TAP Stack - Task Assignment Platform with DynamoDB Streams, Lambda processors, and CloudWatch monitoring",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix",
                        "ProjectOwner"
                    ]
                },
                {
                    "Label": {
                        "default": "DynamoDB Configuration"
                    },
                    "Parameters": [
                        "PointInTimeRecoveryEnabled",
                        "StreamViewType"
                    ]
                },
                {
                    "Label": {
                        "default": "Lambda Configuration"
                    },
                    "Parameters": [
                        "LambdaRuntime",
                        "LambdaTimeout",
                        "LambdaMemorySize"
                    ]
                },
                {
                    "Label": {
                        "default": "Monitoring Configuration"
                    },
                    "Parameters": [
                        "EnableDetailedMonitoring",
                        "AlarmEmail"
                    ]
                }
            ],
            "ParameterLabels": {
                "EnvironmentSuffix": {
                    "default": "Environment Suffix"
                },
                "ProjectOwner": {
                    "default": "Project Owner"
                },
                "PointInTimeRecoveryEnabled": {
                    "default": "Enable Point-in-Time Recovery"
                },
                "StreamViewType": {
                    "default": "DynamoDB Stream View Type"
                },
                "EnableDetailedMonitoring": {
                    "default": "Enable Detailed CloudWatch Monitoring"
                }
            }
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
            "AllowedPattern": "^[a-zA-Z0-9]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters"
        },
        "ProjectOwner": {
            "Type": "String",
            "Default": "TAP-Team",
            "Description": "Team or individual responsible for this project",
            "AllowedPattern": "^[a-zA-Z0-9-_]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters, hyphens, and underscores"
        },
        "PointInTimeRecoveryEnabled": {
            "Type": "String",
            "Default": "true",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Description": "Enable point-in-time recovery for DynamoDB table"
        },
        "StreamViewType": {
            "Type": "String",
            "Default": "NEW_AND_OLD_IMAGES",
            "AllowedValues": [
                "NEW_IMAGE",
                "OLD_IMAGE",
                "NEW_AND_OLD_IMAGES",
                "KEYS_ONLY"
            ],
            "Description": "Type of information written to the DynamoDB stream"
        },
        "LambdaRuntime": {
            "Type": "String",
            "Default": "python3.11",
            "AllowedValues": [
                "python3.11",
                "python3.12",
                "nodejs20.x",
                "nodejs18.x"
            ],
            "Description": "Runtime environment for Lambda functions"
        },
        "LambdaTimeout": {
            "Type": "Number",
            "Default": 30,
            "MinValue": 3,
            "MaxValue": 900,
            "Description": "Lambda function timeout in seconds"
        },
        "LambdaMemorySize": {
            "Type": "Number",
            "Default": 256,
            "AllowedValues": [
                128,
                256,
                512,
                1024,
                2048
            ],
            "Description": "Lambda function memory allocation in MB"
        },
        "EnableDetailedMonitoring": {
            "Type": "String",
            "Default": "Yes",
            "AllowedValues": [
                "Yes",
                "No"
            ],
            "Description": "Enable detailed CloudWatch monitoring and alarms"
        },
        "AlarmEmail": {
            "Type": "String",
            "Default": "",
            "Description": "Email address for alarm notifications (optional)",
            "AllowedPattern": "^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
            "ConstraintDescription": "Must be a valid email address or empty"
        }
    },
    "Conditions": {
        "EnablePITR": {
            "Fn::Equals": [
                {
                    "Ref": "PointInTimeRecoveryEnabled"
                },
                "true"
            ]
        },
        "EnableMonitoring": {
            "Fn::Equals": [
                {
                    "Ref": "EnableDetailedMonitoring"
                },
                "Yes"
            ]
        },
        "HasAlarmEmail": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AlarmEmail"
                        },
                        ""
                    ]
                }
            ]
        },
        "IsProduction": {
            "Fn::Equals": [
                {
                    "Ref": "EnvironmentSuffix"
                },
                "prod"
            ]
        }
    },
    "Resources": {
        "TurnAroundPromptTable": {
            "Type": "AWS::DynamoDB::Table",
            "DeletionPolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    "Delete"
                ]
            },
            "UpdateReplacePolicy": {
                "Fn::If": [
                    "IsProduction",
                    "Retain",
                    "Delete"
                ]
            },
            "Properties": {
                "TableName": {
                    "Fn::Sub": "TurnAroundPromptTable-${EnvironmentSuffix}"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "taskType",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "createdAt",
                        "AttributeType": "N"
                    },
                    {
                        "AttributeName": "status",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    }
                ],
                "GlobalSecondaryIndexes": [
                    {
                        "IndexName": "TaskTypeIndex",
                        "KeySchema": [
                            {
                                "AttributeName": "taskType",
                                "KeyType": "HASH"
                            },
                            {
                                "AttributeName": "createdAt",
                                "KeyType": "RANGE"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        }
                    },
                    {
                        "IndexName": "StatusIndex",
                        "KeySchema": [
                            {
                                "AttributeName": "status",
                                "KeyType": "HASH"
                            },
                            {
                                "AttributeName": "createdAt",
                                "KeyType": "RANGE"
                            }
                        ],
                        "Projection": {
                            "ProjectionType": "ALL"
                        }
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "DeletionProtectionEnabled": {
                    "Fn::If": [
                        "IsProduction",
                        true,
                        false
                    ]
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": {
                        "Fn::If": [
                            "EnablePITR",
                            true,
                            false
                        ]
                    }
                },
                "StreamSpecification": {
                    "StreamViewType": {
                        "Ref": "StreamViewType"
                    }
                },
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": {
                        "Fn::GetAtt": [
                            "DynamoDBEncryptionKey",
                            "Arn"
                        ]
                    }
                },
                "TimeToLiveSpecification": {
                    "AttributeName": "ttl",
                    "Enabled": true
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "TurnAroundPromptTable-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Project",
                        "Value": "TAP"
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DynamoDBEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for DynamoDB table encryption in ${EnvironmentSuffix} environment"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow DynamoDB to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "dynamodb.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:CreateGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "kms:ViaService": {
                                        "Fn::Sub": "dynamodb.${AWS::Region}.amazonaws.com"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-dynamodb-key-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "DynamoDBEncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/tap-dynamodb-${EnvironmentSuffix}"
                },
                "TargetKeyId": {
                    "Ref": "DynamoDBEncryptionKey"
                }
            }
        },
        "StreamProcessorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "tap-stream-processor-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "DynamoDBStreamReadPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:GetRecords",
                                        "dynamodb:GetShardIterator",
                                        "dynamodb:DescribeStream",
                                        "dynamodb:ListStreams"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "TurnAroundPromptTable",
                                            "StreamArn"
                                        ]
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DynamoDBEncryptionKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchMetricsPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:PutMetricData"
                                    ],
                                    "Resource": "*",
                                    "Condition": {
                                        "StringEquals": {
                                            "cloudwatch:namespace": {
                                                "Fn::Sub": "TAP/${EnvironmentSuffix}"
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "SNSPublishPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:Publish"
                                    ],
                                    "Resource": {
                                        "Ref": "ProcessingNotificationTopic"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-stream-processor-role-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "StreamProcessorFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "tap-stream-processor-${EnvironmentSuffix}"
                },
                "Description": "Processes DynamoDB stream events for task assignment analytics and notifications",
                "Runtime": {
                    "Ref": "LambdaRuntime"
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "StreamProcessorRole",
                        "Arn"
                    ]
                },
                "Timeout": {
                    "Ref": "LambdaTimeout"
                },
                "MemorySize": {
                    "Ref": "LambdaMemorySize"
                },
                "Environment": {
                    "Variables": {
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        },
                        "TABLE_NAME": {
                            "Ref": "TurnAroundPromptTable"
                        },
                        "NOTIFICATION_TOPIC_ARN": {
                            "Ref": "ProcessingNotificationTopic"
                        },
                        "CLOUDWATCH_NAMESPACE": {
                            "Fn::Sub": "TAP/${EnvironmentSuffix}"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport os\nimport boto3\nfrom datetime import datetime\nfrom decimal import Decimal\n\ncloudwatch = boto3.client('cloudwatch')\nsns = boto3.client('sns')\n\ndef handler(event, context):\n    \"\"\"\n    Real-world use case: Process DynamoDB stream events to:\n    1. Track task assignment metrics (created, completed, failed)\n    2. Calculate processing times and success rates\n    3. Send notifications for critical task status changes\n    4. Aggregate analytics for operational dashboards\n    \"\"\"\n    \n    namespace = os.environ['CLOUDWATCH_NAMESPACE']\n    topic_arn = os.environ['NOTIFICATION_TOPIC_ARN']\n    \n    metrics = {\n        'tasks_created': 0,\n        'tasks_completed': 0,\n        'tasks_failed': 0,\n        'tasks_modified': 0\n    }\n    \n    notifications = []\n    \n    for record in event.get('Records', []):\n        event_name = record['eventName']\n        \n        if event_name == 'INSERT':\n            metrics['tasks_created'] += 1\n            new_image = record['dynamodb'].get('NewImage', {})\n            task_type = new_image.get('taskType', {}).get('S', 'unknown')\n            \n            print(f\"New task created: {new_image.get('id', {}).get('S')} of type {task_type}\")\n            \n        elif event_name == 'MODIFY':\n            metrics['tasks_modified'] += 1\n            old_image = record['dynamodb'].get('OldImage', {})\n            new_image = record['dynamodb'].get('NewImage', {})\n            \n            old_status = old_image.get('status', {}).get('S')\n            new_status = new_image.get('status', {}).get('S')\n            \n            if old_status != new_status:\n                if new_status == 'completed':\n                    metrics['tasks_completed'] += 1\n                    \n                    # Calculate processing time\n                    created_at = int(new_image.get('createdAt', {}).get('N', 0))\n                    completed_at = int(new_image.get('completedAt', {}).get('N', 0))\n                    processing_time = completed_at - created_at\n                    \n                    cloudwatch.put_metric_data(\n                        Namespace=namespace,\n                        MetricData=[{\n                            'MetricName': 'TaskProcessingTime',\n                            'Value': processing_time,\n                            'Unit': 'Seconds',\n                            'Dimensions': [\n                                {'Name': 'TaskType', 'Value': new_image.get('taskType', {}).get('S', 'unknown')},\n                                {'Name': 'Environment', 'Value': os.environ['ENVIRONMENT']}\n                            ]\n                        }]\n                    )\n                    \n                elif new_status == 'failed':\n                    metrics['tasks_failed'] += 1\n                    \n                    # Send notification for failed tasks\n                    task_id = new_image.get('id', {}).get('S', 'unknown')\n                    error_msg = new_image.get('errorMessage', {}).get('S', 'No error message')\n                    \n                    notifications.append({\n                        'task_id': task_id,\n                        'status': 'failed',\n                        'error': error_msg\n                    })\n    \n    # Publish aggregate metrics\n    for metric_name, value in metrics.items():\n        if value > 0:\n            cloudwatch.put_metric_data(\n                Namespace=namespace,\n                MetricData=[{\n                    'MetricName': metric_name,\n                    'Value': value,\n                    'Unit': 'Count',\n                    'Dimensions': [\n                        {'Name': 'Environment', 'Value': os.environ['ENVIRONMENT']}\n                    ]\n                }]\n            )\n    \n    # Send notifications for critical events\n    if notifications:\n        sns.publish(\n            TopicArn=topic_arn,\n            Subject=f\"TAP Task Failures - {os.environ['ENVIRONMENT']}\",\n            Message=json.dumps(notifications, indent=2)\n        )\n    \n    return {\n        'statusCode': 200,\n        'body': json.dumps({\n            'processed_records': len(event.get('Records', [])),\n            'metrics': metrics\n        })\n    }\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-stream-processor-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "StreamEventSourceMapping": {
            "Type": "AWS::Lambda::EventSourceMapping",
            "Properties": {
                "EventSourceArn": {
                    "Fn::GetAtt": [
                        "TurnAroundPromptTable",
                        "StreamArn"
                    ]
                },
                "FunctionName": {
                    "Ref": "StreamProcessorFunction"
                },
                "StartingPosition": "LATEST",
                "BatchSize": 100,
                "MaximumBatchingWindowInSeconds": 10,
                "MaximumRecordAgeInSeconds": 604800,
                "MaximumRetryAttempts": 3,
                "BisectBatchOnFunctionError": true,
                "ParallelizationFactor": 1
            }
        },
        "ProcessingNotificationTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": {
                    "Fn::Sub": "tap-processing-notifications-${EnvironmentSuffix}"
                },
                "DisplayName": {
                    "Fn::Sub": "TAP Processing Notifications (${EnvironmentSuffix})"
                },
                "KmsMasterKeyId": {
                    "Ref": "SNSEncryptionKey"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-processing-notifications-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "SNSEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for SNS topic encryption in ${EnvironmentSuffix} environment"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow SNS to use the key",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "sns.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-sns-key-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "EmailSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Condition": "HasAlarmEmail",
            "Properties": {
                "Protocol": "email",
                "TopicArn": {
                    "Ref": "ProcessingNotificationTopic"
                },
                "Endpoint": {
                    "Ref": "AlarmEmail"
                }
            }
        },
        "StreamProcessorLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/tap-stream-processor-${EnvironmentSuffix}"
                },
                "RetentionInDays": {
                    "Fn::If": [
                        "IsProduction",
                        90,
                        7
                    ]
                },
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "CloudWatchLogsKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-stream-processor-logs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "CloudWatchLogsKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS key for CloudWatch Logs encryption in ${EnvironmentSuffix} environment"
                },
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:CreateGrant",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/tap-*"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "tap-logs-key-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Ref": "ProjectOwner"
                        }
                    },
                    {
                        "Key": "iac-rlhf-amazon",
                        "Value": "true"
                    }
                ]
            }
        },
        "LambdaErrorAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "EnableMonitoring",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-lambda-errors-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "Lambda function errors in ${EnvironmentSuffix} environment"
                },
                "MetricName": "Errors",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 5,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "StreamProcessorFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Fn::If": [
                            "HasAlarmEmail",
                            {
                                "Ref": "ProcessingNotificationTopic"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "LambdaThrottleAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "EnableMonitoring",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-lambda-throttles-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "Lambda function throttles in ${EnvironmentSuffix} environment"
                },
                "MetricName": "Throttles",
                "Namespace": "AWS/Lambda",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 1,
                "Threshold": 1,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "FunctionName",
                        "Value": {
                            "Ref": "StreamProcessorFunction"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Fn::If": [
                            "HasAlarmEmail",
                            {
                                "Ref": "ProcessingNotificationTopic"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBReadThrottleAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "EnableMonitoring",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-dynamodb-read-throttles-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "DynamoDB read throttles in ${EnvironmentSuffix} environment"
                },
                "MetricName": "ReadThrottleEvents",
                "Namespace": "AWS/DynamoDB",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 10,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "TurnAroundPromptTable"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Fn::If": [
                            "HasAlarmEmail",
                            {
                                "Ref": "ProcessingNotificationTopic"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        },
        "DynamoDBWriteThrottleAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "EnableMonitoring",
            "Properties": {
                "AlarmName": {
                    "Fn::Sub": "tap-dynamodb-write-throttles-${EnvironmentSuffix}"
                },
                "AlarmDescription": {
                    "Fn::Sub": "DynamoDB write throttles in ${EnvironmentSuffix} environment"
                },
                "MetricName": "WriteThrottleEvents",
                "Namespace": "AWS/DynamoDB",
                "Statistic": "Sum",
                "Period": 300,
                "EvaluationPeriods": 2,
                "Threshold": 10,
                "ComparisonOperator": "GreaterThanThreshold",
                "Dimensions": [
                    {
                        "Name": "TableName",
                        "Value": {
                            "Ref": "TurnAroundPromptTable"
                        }
                    }
                ],
                "AlarmActions": [
                    {
                        "Fn::If": [
                            "HasAlarmEmail",
                            {
                                "Ref": "ProcessingNotificationTopic"
                            },
                            {
                                "Ref": "AWS::NoValue"
                            }
                        ]
                    }
                ],
                "TreatMissingData": "notBreaching"
            }
        }
    },
    "Outputs": {
        "TurnAroundPromptTableName": {
            "Description": "Name of the DynamoDB table",
            "Value": {
                "Ref": "TurnAroundPromptTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableName"
                }
            }
        },
        "TurnAroundPromptTableArn": {
            "Description": "ARN of the DynamoDB table",
            "Value": {
                "Fn::GetAtt": [
                    "TurnAroundPromptTable",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableArn"
                }
            }
        },
        "TurnAroundPromptTableStreamArn": {
            "Description": "ARN of the DynamoDB table stream",
            "Value": {
                "Fn::GetAtt": [
                    "TurnAroundPromptTable",
                    "StreamArn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-TableStreamArn"
                }
            }
        },
        "StreamProcessorFunctionArn": {
            "Description": "ARN of the Lambda stream processor function",
            "Value": {
                "Fn::GetAtt": [
                    "StreamProcessorFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StreamProcessorFunctionArn"
                }
            }
        },
        "StreamProcessorFunctionName": {
            "Description": "Name of the Lambda stream processor function",
            "Value": {
                "Ref": "StreamProcessorFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StreamProcessorFunctionName"
                }
            }
        },
        "ProcessingNotificationTopicArn": {
            "Description": "ARN of the SNS topic for processing notifications",
            "Value": {
                "Ref": "ProcessingNotificationTopic"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-NotificationTopicArn"
                }
            }
        },
        "DynamoDBEncryptionKeyArn": {
            "Description": "ARN of the KMS key for DynamoDB encryption",
            "Value": {
                "Fn::GetAtt": [
                    "DynamoDBEncryptionKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBEncryptionKeyArn"
                }
            }
        },
        "StackName": {
            "Description": "Name of this CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StackName"
                }
            }
        },
        "EnvironmentSuffix": {
            "Description": "Environment suffix used for this deployment",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
                }
            }
        },
        "Region": {
            "Description": "AWS Region where stack is deployed",
            "Value": {
                "Ref": "AWS::Region"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Region"
                }
            }
        }
    }
}
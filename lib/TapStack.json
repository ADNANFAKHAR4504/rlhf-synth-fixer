{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Highly secure cloud infrastructure with encrypted S3 buckets, least-privilege IAM roles, and comprehensive CloudWatch logging",
    "Parameters": {
        "Environment": {
            "Type": "String",
            "Default": "prod",
            "Description": "Environment name for resource tagging",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ]
        }
    },
    "Resources": {
        "SecureAppKMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS key for SecureApp S3 bucket encryption",
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": [
                                "kms:CreateGrant",
                                "kms:Decrypt",
                                "kms:DescribeKey",
                                "kms:Encrypt",
                                "kms:GenerateDataKey",
                                "kms:GenerateDataKeyWithoutPlaintext",
                                "kms:ReEncryptFrom",
                                "kms:ReEncryptTo",
                                "kms:PutKeyPolicy",
                                "kms:GetKeyPolicy",
                                "kms:ListGrants",
                                "kms:ListKeys",
                                "kms:ListAliases",
                                "kms:DisableKey",
                                "kms:EnableKey",
                                "kms:ScheduleKeyDeletion",
                                "kms:CancelKeyDeletion",
                                "kms:CreateAlias",
                                "kms:DeleteAlias",
                                "kms:UpdateAlias"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow S3 Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "s3.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-kms-key"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppKMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": "alias/secureapp-s3-encryption-key",
                "TargetKeyId": {
                    "Ref": "SecureAppKMSKey"
                }
            }
        },
        "SecureAppDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "secureapp-data-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "SecureAppKMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "SecureAppLogsBucket"
                    },
                    "LogFilePrefix": "access-logs/data-bucket/"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-data-bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "secureapp-log-bucket-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "SecureAppKMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteOldLogs",
                            "Status": "Enabled",
                            "ExpirationInDays": 90
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-logs-bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "SecureAppLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "CloudTrailAclCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "SecureAppLogsBucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "CloudTrailWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${SecureAppLogsBucket.Arn}/cloudtrail-logs/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "CloudTrailLogDeliveryWrite",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${SecureAppLogsBucket.Arn}/cloudtrail-logs/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "SecureAppBackupBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "secureapp-backup-${AWS::AccountId}-${AWS::Region}"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "SecureAppKMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-backup-bucket"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppReadOnlyRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "secureapp-readonly-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        },
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "sts:ExternalId": "secureapp-readonly-access"
                                }
                            }
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-readonly-role"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppReadOnlyPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "secureapp-readonly-policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowS3ReadAccess",
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:GetObjectVersion",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "SecureAppDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureAppDataBucket.Arn}/*"
                                }
                            ]
                        },
                        {
                            "Sid": "AllowKMSDecryption",
                            "Effect": "Allow",
                            "Action": [
                                "kms:Decrypt",
                                "kms:DescribeKey"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "SecureAppKMSKey",
                                    "Arn"
                                ]
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "SecureAppReadOnlyRole"
                    }
                ]
            }
        },
        "SecureAppReadWriteRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "secureapp-readwrite-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com",
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess"
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-readwrite-role"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppReadWritePolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "secureapp-readwrite-policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowS3ReadWriteAccess",
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:GetObjectVersion",
                                "s3:PutObject",
                                "s3:DeleteObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "SecureAppDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureAppDataBucket.Arn}/*"
                                },
                                {
                                    "Fn::GetAtt": [
                                        "SecureAppBackupBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureAppBackupBucket.Arn}/*"
                                }
                            ]
                        },
                        {
                            "Sid": "AllowKMSOperations",
                            "Effect": "Allow",
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:DescribeKey"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "SecureAppKMSKey",
                                    "Arn"
                                ]
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "SecureAppReadWriteRole"
                    }
                ]
            }
        },
        "SecureAppBackupRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "secureapp-backup-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "backup.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-backup-role"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppBackupPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "secureapp-backup-policy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowBackupOperations",
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:PutObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "SecureAppDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureAppDataBucket.Arn}/*"
                                },
                                {
                                    "Fn::GetAtt": [
                                        "SecureAppBackupBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureAppBackupBucket.Arn}/*"
                                }
                            ]
                        },
                        {
                            "Sid": "AllowKMSForBackup",
                            "Effect": "Allow",
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey",
                                "kms:DescribeKey"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "SecureAppKMSKey",
                                    "Arn"
                                ]
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "SecureAppBackupRole"
                    }
                ]
            }
        },
        "SecureAppS3LogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "/secureapp/s3-events",
                "RetentionInDays": 30,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-s3-logs"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppCloudFormationLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "/secureapp/cloudformation-events",
                "RetentionInDays": 90,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-cloudformation-logs"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppApplicationLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": "/secureapp/application",
                "RetentionInDays": 90,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-application-logs"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        },
        "SecureAppCloudTrail": {
            "Type": "AWS::CloudTrail::Trail",
            "DependsOn": "SecureAppLogsBucketPolicy",
            "Properties": {
                "TrailName": "secureapp-cloudtrail",
                "S3BucketName": {
                    "Ref": "SecureAppLogsBucket"
                },
                "S3KeyPrefix": "cloudtrail-logs/",
                "IncludeGlobalServiceEvents": true,
                "IsLogging": true,
                "IsMultiRegionTrail": false,
                "EnableLogFileValidation": true,
                "EventSelectors": [
                    {
                        "ReadWriteType": "All",
                        "IncludeManagementEvents": true
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "secureapp-cloudtrail"
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "DataBucketName": {
            "Description": "Name of the primary data bucket",
            "Value": {
                "Ref": "SecureAppDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DataBucket"
                }
            }
        },
        "BackupBucketName": {
            "Description": "Name of the backup bucket",
            "Value": {
                "Ref": "SecureAppBackupBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupBucket"
                }
            }
        },
        "LogsBucketName": {
            "Description": "Name of the logs bucket",
            "Value": {
                "Ref": "SecureAppLogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogsBucket"
                }
            }
        },
        "KMSKeyId": {
            "Description": "KMS Key ID for S3 encryption",
            "Value": {
                "Ref": "SecureAppKMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKey"
                }
            }
        },
        "KMSKeyAlias": {
            "Description": "KMS Key Alias for S3 encryption",
            "Value": {
                "Ref": "SecureAppKMSKeyAlias"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyAlias"
                }
            }
        },
        "ReadOnlyRoleArn": {
            "Description": "ARN of the read-only IAM role",
            "Value": {
                "Fn::GetAtt": [
                    "SecureAppReadOnlyRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ReadOnlyRole"
                }
            }
        },
        "ReadWriteRoleArn": {
            "Description": "ARN of the read-write IAM role",
            "Value": {
                "Fn::GetAtt": [
                    "SecureAppReadWriteRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ReadWriteRole"
                }
            }
        },
        "BackupRoleArn": {
            "Description": "ARN of the backup IAM role",
            "Value": {
                "Fn::GetAtt": [
                    "SecureAppBackupRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupRole"
                }
            }
        },
        "S3LogGroupName": {
            "Description": "CloudWatch Log Group for S3 events",
            "Value": {
                "Ref": "SecureAppS3LogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3LogGroup"
                }
            }
        },
        "CloudFormationLogGroupName": {
            "Description": "CloudWatch Log Group for CloudFormation events",
            "Value": {
                "Ref": "SecureAppCloudFormationLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CFLogGroup"
                }
            }
        },
        "ApplicationLogGroupName": {
            "Description": "CloudWatch Log Group for application logs",
            "Value": {
                "Ref": "SecureAppApplicationLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-AppLogGroup"
                }
            }
        },
        "CloudTrailName": {
            "Description": "Name of the CloudTrail for API logging",
            "Value": {
                "Ref": "SecureAppCloudTrail"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-CloudTrail"
                }
            }
        },
        "StackName": {
            "Description": "Name of this CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StackName"
                }
            }
        },
        "Environment": {
            "Description": "Environment name used for this deployment",
            "Value": {
                "Ref": "Environment"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Environment"
                }
            }
        }
    }
}
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Comprehensive CI/CD Pipeline with CodePipeline, CodeBuild, and secure artifact deployment",
  "Parameters": {
    "ProjectName": {
      "Type": "String",
      "Default": "my-cicd-project",
      "Description": "Name of the project for resource naming and tagging"
    },
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "Description": "Environment name for resource naming and tagging"
    },
    "CodeStarConnectionArn": {
      "Type": "String",
      "Description": "ARN of the CodeStar Connection for GitHub integration"
    },
    "GitHubRepositoryOwner": {
      "Type": "String",
      "Description": "GitHub repository owner (username or organization)"
    },
    "GitHubRepositoryName": {
      "Type": "String",
      "Description": "GitHub repository name"
    },
    "GitHubBranchName": {
      "Type": "String",
      "Default": "main",
      "Description": "GitHub branch name to track"
    },
    "ApprovalNotificationEmail": {
      "Type": "String",
      "Description": "Email address for manual approval notifications"
    },
    "SecretValue": {
      "Type": "String",
      "NoEcho": true,
      "Description": "Secret value to store in AWS Secrets Manager",
      "Default": "my-secret-api-key"
    }
  },
  "Resources": {
    "PipelineKMSKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": {
          "Fn::Sub": "${ProjectName}-${Environment} Pipeline KMS Key"
        },
        "KeyPolicy": {
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow use of the key for S3",
              "Effect": "Allow",
              "Principal": {
                "Service": "s3.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey"
              ],
              "Resource": "*"
            },
            {
              "Sid": "Allow use of the key for SNS",
              "Effect": "Allow",
              "Principal": {
                "Service": "sns.amazonaws.com"
              },
              "Action": [
                "kms:Decrypt",
                "kms:GenerateDataKey"
              ],
              "Resource": "*"
            }
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "PipelineKMSKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": {
          "Fn::Sub": "alias/${ProjectName}-${Environment}-pipeline-key"
        },
        "TargetKeyId": {
          "Ref": "PipelineKMSKey"
        }
      }
    },
    "PipelineArtifactsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ProjectName}-${Environment}-pipeline-artifacts-${AWS::AccountId}-${AWS::Region}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": {
                  "Ref": "PipelineKMSKey"
                }
              },
              "BucketKeyEnabled": true
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldVersions",
              "Status": "Enabled",
              "NoncurrentVersionTransitions": [
                {
                  "TransitionInDays": 30,
                  "StorageClass": "GLACIER"
                }
              ],
              "NoncurrentVersionExpirationInDays": 365
            }
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "DeploymentArtifactsBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ProjectName}-${Environment}-deployment-artifacts-${AWS::AccountId}-${AWS::Region}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "aws:kms",
                "KMSMasterKeyID": {
                  "Ref": "PipelineKMSKey"
                }
              },
              "BucketKeyEnabled": true
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "ManageObjectVersions",
              "Status": "Enabled",
              "NoncurrentVersionTransitions": [
                {
                  "TransitionInDays": 30,
                  "StorageClass": "GLACIER"
                }
              ],
              "NoncurrentVersionExpirationInDays": 365
            }
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "BuildSecret": {
      "Type": "AWS::SecretsManager::Secret",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${Environment}-build-secret"
        },
        "Description": "Secret for CI/CD pipeline build process",
        "SecretString": {
          "Ref": "SecretValue"
        },
        "KmsKeyId": {
          "Ref": "PipelineKMSKey"
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "ApprovalNotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "${ProjectName}-${Environment}-approval-notifications"
        },
        "DisplayName": "Pipeline Approval Notifications",
        "KmsMasterKeyId": {
          "Ref": "PipelineKMSKey"
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "ApprovalNotificationSubscription": {
      "Type": "AWS::SNS::Subscription",
      "Properties": {
        "Protocol": "email",
        "TopicArn": {
          "Ref": "ApprovalNotificationTopic"
        },
        "Endpoint": {
          "Ref": "ApprovalNotificationEmail"
        }
      }
    },
    "CodeBuildLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/codebuild/${ProjectName}-${Environment}-build"
        },
        "RetentionInDays": 30,
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "CodePipelineServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "codepipeline.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "PipelineExecutionPolicy",
            "PolicyDocument": {
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetBucketVersioning",
                    "s3:GetObject",
                    "s3:GetObjectVersion",
                    "s3:PutObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "${PipelineArtifactsBucket}/*"
                    },
                    {
                      "Fn::Sub": "${DeploymentArtifactsBucket}/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "PipelineArtifactsBucket",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "DeploymentArtifactsBucket",
                        "Arn"
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "codebuild:BatchGetBuilds",
                    "codebuild:StartBuild"
                  ],
                  "Resource": {
                    "Fn::GetAtt": [
                      "CodeBuildProject",
                      "Arn"
                    ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "codestar-connections:UseConnection"
                  ],
                  "Resource": {
                    "Ref": "CodeStarConnectionArn"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:Publish"
                  ],
                  "Resource": {
                    "Ref": "ApprovalNotificationTopic"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:Decrypt",
                    "kms:GenerateDataKey"
                  ],
                  "Resource": {
                    "Fn::GetAtt": [
                      "PipelineKMSKey",
                      "Arn"
                    ]
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "CodeBuildServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "codebuild.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "BuildExecutionPolicy",
            "PolicyDocument": {
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "${CodeBuildLogGroup.Arn}*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion",
                    "s3:PutObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "${PipelineArtifactsBucket}/*"
                    },
                    {
                      "Fn::Sub": "${DeploymentArtifactsBucket}/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "PipelineArtifactsBucket",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::GetAtt": [
                        "DeploymentArtifactsBucket",
                        "Arn"
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": {
                    "Ref": "BuildSecret"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:Decrypt",
                    "kms:GenerateDataKey"
                  ],
                  "Resource": {
                    "Fn::GetAtt": [
                      "PipelineKMSKey",
                      "Arn"
                    ]
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "CodeBuildProject": {
      "Type": "AWS::CodeBuild::Project",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${Environment}-build"
        },
        "Description": "Build project for CI/CD pipeline",
        "ServiceRole": {
          "Fn::GetAtt": [
            "CodeBuildServiceRole",
            "Arn"
          ]
        },
        "Artifacts": {
          "Type": "CODEPIPELINE"
        },
        "Environment": {
          "Type": "LINUX_CONTAINER",
          "ComputeType": "BUILD_GENERAL1_MEDIUM",
          "Image": "aws/codebuild/standard:7.0",
          "EnvironmentVariables": [
            {
              "Name": "PROJECT_NAME",
              "Value": {
                "Ref": "ProjectName"
              }
            },
            {
              "Name": "ENVIRONMENT",
              "Value": {
                "Ref": "Environment"
              }
            },
            {
              "Name": "SECRET_ARN",
              "Value": {
                "Ref": "BuildSecret"
              }
            },
            {
              "Name": "DEPLOYMENT_BUCKET",
              "Value": {
                "Ref": "DeploymentArtifactsBucket"
              }
            }
          ]
        },
        "Source": {
          "Type": "CODEPIPELINE",
          "BuildSpec": "version: 0.2\nphases:\n  install:\n    runtime-versions:\n      nodejs: 18\n      python: 3.11\n    commands:\n      - echo \"Installing dependencies...\"\n      - |\n        if [ -f package.json ]; then\n          npm install\n        elif [ -f requirements.txt ]; then\n          pip install -r requirements.txt\n        elif [ -f pom.xml ]; then\n          mvn install -DskipTests\n        else\n          echo \"No recognized dependency file found\"\n        fi\n  pre_build:\n    commands:\n      - echo \"Running pre-build phase...\"\n      - echo \"Retrieving secret from Secrets Manager...\"\n      - SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id $SECRET_ARN --query SecretString --output text)\n      - echo \"Secret retrieved successfully (not displaying value for security)\"\n      - echo \"Running security scans and linters...\"\n      - |\n        if [ -f package.json ]; then\n          npm audit --audit-level high\n          if command -v eslint &> /dev/null; then\n            npm run lint || echo \"Linting completed with warnings\"\n          fi\n        elif [ -f requirements.txt ]; then\n          if command -v bandit &> /dev/null; then\n            bandit -r . || echo \"Security scan completed with warnings\"\n          fi\n          if command -v flake8 &> /dev/null; then\n            flake8 . || echo \"Linting completed with warnings\"\n          fi\n        fi\n  build:\n    commands:\n      - echo \"Build phase started on $(date)\"\n      - echo \"Compiling application...\"\n      - |\n        if [ -f package.json ]; then\n          npm run build || echo \"Build script not found, skipping\"\n          npm test || echo \"Test script not found, skipping\"\n        elif [ -f requirements.txt ]; then\n          python -m pytest tests/ || echo \"No tests found, skipping\"\n        elif [ -f pom.xml ]; then\n          mvn clean compile test\n        else\n          echo \"Creating sample application artifact\"\n          mkdir -p dist\n          echo \"Sample application built on $(date)\" > dist/app.txt\n        fi\n  post_build:\n    commands:\n      - echo \"Post-build phase started on $(date)\"\n      - echo \"Packaging artifacts...\"\n      - |\n        # Create deployment package\n        if [ -d dist ]; then\n          cd dist && zip -r ../deployment-package.zip . && cd ..\n        elif [ -d build ]; then\n          cd build && zip -r ../deployment-package.zip . && cd ..\n        elif [ -d target ]; then\n          cd target && zip -r ../deployment-package.zip . && cd ..\n        else\n          # Create a sample deployment package\n          mkdir -p package\n          echo \"Deployment package created on $(date)\" > package/deployment-info.txt\n          echo \"Environment: $ENVIRONMENT\" >> package/deployment-info.txt\n          echo \"Project: $PROJECT_NAME\" >> package/deployment-info.txt\n          cd package && zip -r ../deployment-package.zip . && cd ..\n        fi\n      - echo \"Artifacts packaged successfully\"\n      - ls -la *.zip\nartifacts:\n  files:\n    - deployment-package.zip\n  name: BuildArtifact\n"
        },
        "LogsConfig": {
          "CloudWatchLogs": {
            "Status": "ENABLED",
            "GroupName": {
              "Ref": "CodeBuildLogGroup"
            }
          }
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    },
    "CodePipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ProjectName}-${Environment}-pipeline"
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "CodePipelineServiceRole",
            "Arn"
          ]
        },
        "ArtifactStore": {
          "Type": "S3",
          "Location": {
            "Ref": "PipelineArtifactsBucket"
          },
          "EncryptionKey": {
            "Id": {
              "Fn::GetAtt": [
                "PipelineKMSKey",
                "Arn"
              ]
            },
            "Type": "KMS"
          }
        },
        "Stages": [
          {
            "Name": "Source",
            "Actions": [
              {
                "Name": "SourceAction",
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "AWS",
                  "Provider": "CodeStarSourceConnection",
                  "Version": "1"
                },
                "Configuration": {
                  "ConnectionArn": {
                    "Ref": "CodeStarConnectionArn"
                  },
                  "FullRepositoryId": {
                    "Fn::Sub": "${GitHubRepositoryOwner}/${GitHubRepositoryName}"
                  },
                  "BranchName": {
                    "Ref": "GitHubBranchName"
                  },
                  "DetectChanges": true
                },
                "OutputArtifacts": [
                  {
                    "Name": "SourceOutput"
                  }
                ]
              }
            ]
          },
          {
            "Name": "Build",
            "Actions": [
              {
                "Name": "BuildAction",
                "ActionTypeId": {
                  "Category": "Build",
                  "Owner": "AWS",
                  "Provider": "CodeBuild",
                  "Version": "1"
                },
                "Configuration": {
                  "ProjectName": {
                    "Ref": "CodeBuildProject"
                  }
                },
                "InputArtifacts": [
                  {
                    "Name": "SourceOutput"
                  }
                ],
                "OutputArtifacts": [
                  {
                    "Name": "BuildOutput"
                  }
                ]
              }
            ]
          },
          {
            "Name": "Approval",
            "Actions": [
              {
                "Name": "ManualApproval",
                "ActionTypeId": {
                  "Category": "Approval",
                  "Owner": "AWS",
                  "Provider": "Manual",
                  "Version": "1"
                },
                "Configuration": {
                  "NotificationArn": {
                    "Ref": "ApprovalNotificationTopic"
                  },
                  "CustomData": {
                    "Fn::Sub": "Please review and approve deployment for ${ProjectName} ${Environment} environment"
                  }
                }
              }
            ]
          },
          {
            "Name": "Deploy",
            "Actions": [
              {
                "Name": "DeployAction",
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "S3",
                  "Version": "1"
                },
                "Configuration": {
                  "BucketName": {
                    "Ref": "DeploymentArtifactsBucket"
                  },
                  "Extract": true,
                  "ObjectKey": {
                    "Fn::Sub": "deployments/${ProjectName}-${Environment}"
                  }
                },
                "InputArtifacts": [
                  {
                    "Name": "BuildOutput"
                  }
                ]
              }
            ]
          }
        ],
        "Tags": [
          {
            "Key": "Project",
            "Value": {
              "Ref": "ProjectName"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "PipelineName": {
      "Description": "Name of the created CodePipeline",
      "Value": {
        "Ref": "CodePipeline"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PipelineName"
        }
      }
    },
    "PipelineArtifactsBucket": {
      "Description": "S3 bucket for pipeline artifacts",
      "Value": {
        "Ref": "PipelineArtifactsBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-PipelineArtifactsBucket"
        }
      }
    },
    "DeploymentArtifactsBucket": {
      "Description": "S3 bucket for deployment artifacts",
      "Value": {
        "Ref": "DeploymentArtifactsBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DeploymentArtifactsBucket"
        }
      }
    },
    "CodeBuildProjectName": {
      "Description": "Name of the CodeBuild project",
      "Value": {
        "Ref": "CodeBuildProject"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CodeBuildProject"
        }
      }
    },
    "SecretsManagerSecretArn": {
      "Description": "ARN of the Secrets Manager secret",
      "Value": {
        "Ref": "BuildSecret"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-BuildSecret"
        }
      }
    },
    "SNSTopicArn": {
      "Description": "ARN of the SNS topic for approvals",
      "Value": {
        "Ref": "ApprovalNotificationTopic"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ApprovalTopic"
        }
      }
    }
  }
}
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Expert-level CloudFormation template for secure infrastructure deployment in us-east-1",
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Default": "secureorg",
            "Description": "Project name used in resource naming convention",
            "AllowedPattern": "^[a-z][a-z0-9-]*$",
            "ConstraintDescription": "Project name must start with lowercase letter and contain only lowercase letters, numbers, and hyphens",
            "MinLength": 3,
            "MaxLength": 20
        },
        "Environment": {
            "Type": "String",
            "Default": "prod",
            "AllowedValues": [
                "dev",
                "staging",
                "prod"
            ],
            "Description": "Environment for deployment (dev, staging, prod)"
        }
    },
    "Resources": {
        "PasswordPolicyLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "IAMPasswordPolicyAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:UpdateAccountPasswordPolicy",
                                        "iam:GetAccountPasswordPolicy"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "PasswordPolicyLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "PasswordPolicyLambdaRole",
                        "Arn"
                    ]
                },
                "Timeout": 60,
                "Code": {
                    "ZipFile": "import boto3\nimport json\nimport cfnresponse\n\ndef lambda_handler(event, context):\n    try:\n        iam = boto3.client('iam')\n        \n        if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':\n            # Set account password policy with required security parameters\n            iam.update_account_password_policy(\n                MinimumPasswordLength=12,\n                RequireSymbols=True,\n                RequireNumbers=True,\n                RequireUppercaseCharacters=True,\n                RequireLowercaseCharacters=True,\n                AllowUsersToChangePassword=True,\n                MaxPasswordAge=90,\n                PasswordReusePrevention=12,\n                HardExpiry=True\n            )\n            print(\"Password policy updated successfully\")\n        \n        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})\n        \n    except Exception as e:\n        print(f\"Error: {str(e)}\")\n        cfnresponse.send(event, context, cfnresponse.FAILED, {})\n"
                }
            }
        },
        "PasswordPolicyCustomResource": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "PasswordPolicyLambda",
                        "Arn"
                    ]
                }
            }
        },
        "PrimaryDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-${Environment}-s3bucket-primary"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 30,
                                    "StorageClass": "STANDARD_IA"
                                }
                            ]
                        },
                        {
                            "Id": "TransitionToGlacier",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 90,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "BackupDataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-${Environment}-s3bucket-backup"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                }
            }
        },
        "LogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${ProjectName}-${Environment}-s3bucket-logs"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "LogsRetention",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "TransitionInDays": 365,
                                    "StorageClass": "GLACIER"
                                }
                            ]
                        },
                        {
                            "Id": "LogsDeletion",
                            "Status": "Enabled",
                            "ExpirationInDays": 2555
                        }
                    ]
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "S3AccessPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject",
                                        "s3:DeleteObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${PrimaryDataBucket}/*"
                                        },
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${BackupDataBucket}/*"
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "PrimaryDataBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::GetAtt": [
                                                "BackupDataBucket",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:PutObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:s3:::${LogsBucket}/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "DataProcessorLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Runtime": "python3.9",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 300,
                "MemorySize": 256,
                "Environment": {
                    "Variables": {
                        "ENVIRONMENT": {
                            "Ref": "Environment"
                        },
                        "PROJECT_NAME": {
                            "Ref": "ProjectName"
                        },
                        "PRIMARY_BUCKET": {
                            "Ref": "PrimaryDataBucket"
                        },
                        "BACKUP_BUCKET": {
                            "Ref": "BackupDataBucket"
                        },
                        "LOGS_BUCKET": {
                            "Ref": "LogsBucket"
                        }
                    }
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport logging\nimport os\nfrom datetime import datetime\nimport re\n\n# Configure logging to filter sensitive information\nclass SensitiveInfoFilter(logging.Filter):\n    \"\"\"Custom filter to prevent logging of sensitive AWS credentials\"\"\"\n    \n    SENSITIVE_PATTERNS = [\n        r'AWS_ACCESS_KEY_ID',\n        r'AWS_SECRET_ACCESS_KEY',\n        r'AWS_SESSION_TOKEN',\n        r'AKIA[0-9A-Z]{16}',  # AWS Access Key pattern\n        r'[A-Za-z0-9/+=]{40}',  # AWS Secret Key pattern (basic)\n    ]\n    \n    def filter(self, record):\n        # Check if log message contains sensitive information\n        message = record.getMessage()\n        for pattern in self.SENSITIVE_PATTERNS:\n            if re.search(pattern, message, re.IGNORECASE):\n                record.msg = \"[REDACTED - Sensitive AWS credential detected]\"\n                record.args = ()\n                break\n        return True\n\n# Set up logger with sensitive info filter\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\n# Add the filter to prevent sensitive data logging\nfor handler in logger.handlers:\n    handler.addFilter(SensitiveInfoFilter())\n\ndef lambda_handler(event, context):\n    \"\"\"\n    Secure Lambda function that processes S3 events without exposing credentials\n    \"\"\"\n    try:\n        # Log the event (safe to log as it doesn't contain credentials)\n        logger.info(f\"Processing event: {json.dumps(event, default=str)}\")\n        \n        # Get environment variables (safe to log these specific ones)\n        environment = os.environ.get('ENVIRONMENT', 'unknown')\n        project_name = os.environ.get('PROJECT_NAME', 'unknown')\n        \n        logger.info(f\"Running in environment: {environment}, project: {project_name}\")\n        \n        # Initialize S3 client using IAM role (credentials handled automatically)\n        s3_client = boto3.client('s3')\n        \n        # Process S3 events securely\n        if 'Records' in event:\n            for record in event['Records']:\n                if record.get('eventSource') == 'aws:s3':\n                    bucket_name = record['s3']['bucket']['name']\n                    object_key = record['s3']['object']['key']\n                    \n                    logger.info(f\"Processing object: {object_key} from bucket: {bucket_name}\")\n                    \n                    # Secure data processing logic here\n                    # Example: Copy to backup bucket\n                    backup_bucket = os.environ.get('BACKUP_BUCKET')\n                    if backup_bucket:\n                        copy_source = {'Bucket': bucket_name, 'Key': object_key}\n                        s3_client.copy_object(\n                            CopySource=copy_source,\n                            Bucket=backup_bucket,\n                            Key=f\"backup-{datetime.utcnow().isoformat()}-{object_key}\"\n                        )\n                        logger.info(f\"Successfully backed up {object_key}\")\n        \n        # Demonstrate secure environment variable handling\n        # NEVER log AWS credentials directly\n        env_vars = dict(os.environ)\n        safe_env_vars = {k: v for k, v in env_vars.items() \n                        if not k.startswith('AWS_') or k in ['AWS_REGION', 'AWS_DEFAULT_REGION']}\n        \n        logger.info(f\"Safe environment variables: {json.dumps(safe_env_vars)}\")\n        \n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': 'Data processed successfully',\n                'environment': environment,\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n        \n    except Exception as e:\n        logger.error(f\"Error processing data: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'error': 'Internal server error',\n                'timestamp': datetime.utcnow().isoformat()\n            })\n        }\n"
                }
            }
        },
        "S3InvokeLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "DataProcessorLambda"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "s3.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "PrimaryDataBucket",
                        "Arn"
                    ]
                },
                "SourceAccount": {
                    "Ref": "AWS::AccountId"
                }
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "RetentionInDays": 30
            }
        },
        "OrganizationSecurityPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description": "Organization security policy enforcing best practices",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyUnencryptedS3Uploads",
                            "Effect": "Deny",
                            "Action": "s3:PutObject",
                            "Resource": [
                                {
                                    "Fn::Sub": "arn:aws:s3:::${PrimaryDataBucket}/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${BackupDataBucket}/*"
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${LogsBucket}/*"
                                }
                            ],
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "AES256"
                                }
                            }
                        },
                        {
                            "Sid": "DenyInsecureS3Operations",
                            "Effect": "Deny",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "PrimaryDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${PrimaryDataBucket}/*"
                                },
                                {
                                    "Fn::GetAtt": [
                                        "BackupDataBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${BackupDataBucket}/*"
                                },
                                {
                                    "Fn::GetAtt": [
                                        "LogsBucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "arn:aws:s3:::${LogsBucket}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": "false"
                                }
                            }
                        },
                        {
                            "Sid": "RestrictLambdaModification",
                            "Effect": "Deny",
                            "Action": [
                                "lambda:UpdateFunctionCode",
                                "lambda:UpdateFunctionConfiguration",
                                "lambda:DeleteFunction"
                            ],
                            "Resource": {
                                "Fn::GetAtt": [
                                    "DataProcessorLambda",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "aws:PrincipalTag/Department": "SecurityTeam"
                                }
                            }
                        }
                    ]
                }
            }
        }
    },
    "Outputs": {
        "PrimaryBucketName": {
            "Description": "Name of the primary S3 bucket",
            "Value": {
                "Ref": "PrimaryDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-PrimaryBucket"
                }
            }
        },
        "BackupBucketName": {
            "Description": "Name of the backup S3 bucket",
            "Value": {
                "Ref": "BackupDataBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-BackupBucket"
                }
            }
        },
        "LogsBucketName": {
            "Description": "Name of the logs S3 bucket",
            "Value": {
                "Ref": "LogsBucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LogsBucket"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the data processor Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "DataProcessorLambda",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunction"
                }
            }
        },
        "LambdaExecutionRoleArn": {
            "Description": "ARN of the Lambda execution role",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaExecutionRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaRole"
                }
            }
        },
        "SecurityPolicyArn": {
            "Description": "ARN of the organization security policy",
            "Value": {
                "Ref": "OrganizationSecurityPolicy"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-SecurityPolicy"
                }
            }
        }
    }
}
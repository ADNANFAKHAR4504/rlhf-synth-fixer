{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Secure IAM roles for web application, database access, and CI/CD pipeline with MFA enforcement",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Default": "prod",
      "AllowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "Description": "Environment name for resource tagging"
    },
    "MFAMaxSessionDuration": {
      "Type": "Number",
      "Default": 3600,
      "MinValue": 900,
      "MaxValue": 43200,
      "Description": "Maximum session duration in seconds when using MFA (15 minutes to 12 hours)"
    }
  },
  "Conditions": {
    "IsProduction": {
      "Fn::Equals": [
        {
          "Ref": "Environment"
        },
        "prod"
      ]
    }
  },
  "Resources": {
    "WebApplicationRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Description": "Role for web application with limited S3 and CloudWatch access",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            },
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "sts:AssumeRole",
              "Condition": {
                "Bool": {
                  "aws:MultiFactorAuthPresent": "true"
                },
                "NumericLessThan": {
                  "aws:MultiFactorAuthAge": {
                    "Ref": "MFAMaxSessionDuration"
                  }
                }
              }
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
        ],
        "Policies": [
          {
            "PolicyName": "WebApplicationPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${Environment}-web-assets/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${Environment}-web-assets"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                    "logs:DescribeLogStreams"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/web-application/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:GetParametersByPath"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${Environment}/web-app/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:Decrypt"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*"
                    }
                  ],
                  "Condition": {
                    "StringEquals": {
                      "kms:ViaService": {
                        "Fn::Sub": "ssm.${AWS::Region}.amazonaws.com"
                      }
                    }
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Purpose",
            "Value": "Web Application Access"
          },
          {
            "Key": "MFARequired",
            "Value": "true"
          }
        ]
      }
    },
    "DatabaseAccessRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Description": "Role for database access with strict MFA enforcement",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "sts:AssumeRole",
              "Condition": {
                "Bool": {
                  "aws:MultiFactorAuthPresent": "true"
                },
                "NumericLessThan": {
                  "aws:MultiFactorAuthAge": 1800
                },
                "IpAddress": {
                  "aws:SourceIp": [
                    "10.0.0.0/8",
                    "172.16.0.0/12",
                    "192.168.0.0/16"
                  ]
                }
              }
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "DatabaseAccessPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "rds:DescribeDBInstances",
                    "rds:DescribeDBClusters",
                    "rds:DescribeDBSnapshots"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${Environment}-*"
                    },
                    {
                      "Fn::Sub": "arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${Environment}-*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "rds-db:connect"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:rds-db:${AWS::Region}:${AWS::AccountId}:dbuser:${Environment}-*/app-user"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:GetMetricStatistics",
                    "cloudwatch:ListMetrics"
                  ],
                  "Resource": "*",
                  "Condition": {
                    "StringEquals": {
                      "cloudwatch:namespace": "AWS/RDS"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:GetSecretValue"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${Environment}/database/*"
                    }
                  ]
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Purpose",
            "Value": "Database Access"
          },
          {
            "Key": "MFARequired",
            "Value": "true"
          }
        ]
      }
    },
    "CICDPipelineRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Description": "Role for CI/CD pipeline with deployment permissions",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "codebuild.amazonaws.com",
                  "codepipeline.amazonaws.com",
                  "codedeploy.amazonaws.com"
                ]
              },
              "Action": "sts:AssumeRole"
            },
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "sts:AssumeRole",
              "Condition": {
                "Bool": {
                  "aws:MultiFactorAuthPresent": "true"
                },
                "NumericLessThan": {
                  "aws:MultiFactorAuthAge": 3600
                }
              }
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "CICDPipelinePolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:GetObjectVersion",
                    "s3:PutObject",
                    "s3:DeleteObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${Environment}-cicd-artifacts/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:s3:::${Environment}-cicd-artifacts"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "codebuild:BatchGetBuilds",
                    "codebuild:StartBuild",
                    "codebuild:BatchGetProjects"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/${Environment}-*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "codedeploy:CreateDeployment",
                    "codedeploy:GetApplication",
                    "codedeploy:GetApplicationRevision",
                    "codedeploy:GetDeployment",
                    "codedeploy:GetDeploymentConfig",
                    "codedeploy:RegisterApplicationRevision"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:application:${Environment}-*"
                    },
                    {
                      "Fn::Sub": "arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:deploymentgroup:${Environment}-*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:CreateStack",
                    "cloudformation:UpdateStack",
                    "cloudformation:DeleteStack",
                    "cloudformation:DescribeStacks",
                    "cloudformation:DescribeStackEvents",
                    "cloudformation:DescribeStackResources",
                    "cloudformation:ValidateTemplate"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${Environment}-*/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${Environment}-*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:BatchGetImage",
                    "ecr:GetAuthorizationToken",
                    "ecr:PutImage",
                    "ecr:InitiateLayerUpload",
                    "ecr:UploadLayerPart",
                    "ecr:CompleteLayerUpload"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/${Environment}-*"
                    }
                  ]
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Purpose",
            "Value": "CI/CD Pipeline"
          },
          {
            "Key": "MFARequired",
            "Value": "true"
          }
        ]
      }
    },
    "SecurityAuditRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Description": "Role for security auditing with read-only access",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "sts:AssumeRole",
              "Condition": {
                "Bool": {
                  "aws:MultiFactorAuthPresent": "true"
                },
                "NumericLessThan": {
                  "aws:MultiFactorAuthAge": 1800
                },
                "StringEquals": {
                  "aws:RequestedRegion": {
                    "Ref": "AWS::Region"
                  }
                }
              }
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/SecurityAudit",
          "arn:aws:iam::aws:policy/ReadOnlyAccess"
        ],
        "Policies": [
          {
            "PolicyName": "EnhancedSecurityAuditPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudtrail:LookupEvents",
                    "cloudtrail:GetTrailStatus"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "config:GetComplianceDetailsByConfigRule",
                    "config:GetComplianceDetailsByResource",
                    "config:GetComplianceSummaryByConfigRule"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "guardduty:GetFindings",
                    "guardduty:ListFindings",
                    "guardduty:GetDetector",
                    "guardduty:ListDetectors"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Purpose",
            "Value": "Security Audit"
          },
          {
            "Key": "MFARequired",
            "Value": "true"
          }
        ]
      }
    },
    "EmergencyAccessRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Description": "Emergency administrative access role with strict controls",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "sts:AssumeRole",
              "Condition": {
                "Bool": {
                  "aws:MultiFactorAuthPresent": "true"
                },
                "NumericLessThan": {
                  "aws:MultiFactorAuthAge": 900
                },
                "IpAddress": {
                  "aws:SourceIp": [
                    "203.0.113.0/24"
                  ]
                },
                "DateGreaterThan": {
                  "aws:CurrentTime": {
                    "Fn::If": [
                      "IsProduction",
                      "08:00Z",
                      "00:00Z"
                    ]
                  }
                },
                "DateLessThan": {
                  "aws:CurrentTime": {
                    "Fn::If": [
                      "IsProduction",
                      "18:00Z",
                      "23:59Z"
                    ]
                  }
                }
              }
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AdministratorAccess"
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "Environment"
            }
          },
          {
            "Key": "Purpose",
            "Value": "Emergency Administrative Access"
          },
          {
            "Key": "MFARequired",
            "Value": "true"
          },
          {
            "Key": "HighPrivilege",
            "Value": "true"
          }
        ]
      }
    },
    "WebApplicationInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "InstanceProfileName": {
          "Fn::Sub": "${Environment}-web-application-instance-profile"
        },
        "Roles": [
          {
            "Ref": "WebApplicationRole"
          }
        ]
      }
    }
  },
  "Outputs": {
    "WebApplicationRoleArn": {
      "Description": "ARN of the Web Application Role",
      "Value": {
        "Fn::GetAtt": [
          "WebApplicationRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-web-application-role-arn"
        }
      }
    },
    "DatabaseAccessRoleArn": {
      "Description": "ARN of the Database Access Role",
      "Value": {
        "Fn::GetAtt": [
          "DatabaseAccessRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-database-access-role-arn"
        }
      }
    },
    "CICDPipelineRoleArn": {
      "Description": "ARN of the CI/CD Pipeline Role",
      "Value": {
        "Fn::GetAtt": [
          "CICDPipelineRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-cicd-pipeline-role-arn"
        }
      }
    },
    "SecurityAuditRoleArn": {
      "Description": "ARN of the Security Audit Role",
      "Value": {
        "Fn::GetAtt": [
          "SecurityAuditRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-security-audit-role-arn"
        }
      }
    },
    "EmergencyAccessRoleArn": {
      "Description": "ARN of the Emergency Access Role",
      "Value": {
        "Fn::GetAtt": [
          "EmergencyAccessRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-emergency-access-role-arn"
        }
      }
    },
    "WebApplicationInstanceProfileArn": {
      "Description": "ARN of the Web Application Instance Profile",
      "Value": {
        "Fn::GetAtt": [
          "WebApplicationInstanceProfile",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${Environment}-web-application-instance-profile-arn"
        }
      }
    }
  }
}

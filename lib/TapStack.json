{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure baseline (us-east-1) with KMS, HTTPS-only ALB, VPC Flow Logs, MFA, S3 SSE+logs, and Route53 DNSSEC with KSK activation wait.",
    "Mappings": {
        "OrgCIDR": {
            "Allowed": {
                "CIDR1": "203.0.113.0/24",
                "CIDR2": "198.51.100.10/32"
            }
        },
        "R53": {
            "Zone": {
                "Id": "Z0457876OLTG958Q3IXN",
                "Name": "tap-us-east-1.turing229221.com.",
                "ApexFQDN": "tap-us-east-1.turing229221.com"
            }
        },
        "ACM": {
            "Cert": {
                "Arn": "arn:aws:acm:us-east-1:718240086340:certificate/6f65b67a-bb90-471b-ab0b-8727ad2d7583"
            }
        }
    },
    "Resources": {
        "EncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "KMS for S3, EBS, CloudWatch Logs",
                "EnableKeyRotation": true,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "RootAdmin",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowLogs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowS3",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "s3.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "EncryptionKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${AWS::StackName}-enc"
                },
                "TargetKeyId": {
                    "Ref": "EncryptionKey"
                }
            }
        },
        "DNSSECKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": "Route53 DNSSEC signing key",
                "KeySpec": "ECC_NIST_P256",
                "KeyUsage": "SIGN_VERIFY",
                "EnableKeyRotation": false,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "RootAdmin",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowRoute53DNSSEC",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "dnssec-route53.amazonaws.com"
                            },
                            "Action": [
                                "kms:DescribeKey",
                                "kms:GetPublicKey",
                                "kms:Sign"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsSupport": true,
                "EnableDnsHostnames": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-vpc"
                        }
                    }
                ]
            }
        },
        "PublicSubnetA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.1.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-public-a"
                        }
                    }
                ]
            }
        },
        "PublicSubnetB": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "CidrBlock": "10.0.2.0/24",
                "AvailabilityZone": {
                    "Fn::Select": [
                        1,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-public-b"
                        }
                    }
                ]
            }
        },
        "IGW": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-igw"
                        }
                    }
                ]
            }
        },
        "VPCGWAttach": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "IGW"
                }
            }
        },
        "PublicRT": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-public-rt"
                        }
                    }
                ]
            }
        },
        "DefaultRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "VPCGWAttach",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRT"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "IGW"
                }
            }
        },
        "AssocPubA": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "RouteTableId": {
                    "Ref": "PublicRT"
                }
            }
        },
        "AssocPubB": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "PublicSubnetB"
                },
                "RouteTableId": {
                    "Ref": "PublicRT"
                }
            }
        },
        "ALBSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "ALB - HTTPS only from known IPs",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Fn::FindInMap": [
                                "OrgCIDR",
                                "Allowed",
                                "CIDR1"
                            ]
                        },
                        "Description": "HTTPS org #1"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 443,
                        "ToPort": 443,
                        "CidrIp": {
                            "Fn::FindInMap": [
                                "OrgCIDR",
                                "Allowed",
                                "CIDR2"
                            ]
                        },
                        "Description": "HTTPS org #2"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-alb-sg"
                        }
                    }
                ]
            }
        },
        "InstanceSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "EC2 - HTTP from ALB, SSH from known IPs",
                "VpcId": {
                    "Ref": "VPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "SourceSecurityGroupId": {
                            "Ref": "ALBSG"
                        },
                        "Description": "HTTP from ALB"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Fn::FindInMap": [
                                "OrgCIDR",
                                "Allowed",
                                "CIDR1"
                            ]
                        },
                        "Description": "SSH org #1"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Fn::FindInMap": [
                                "OrgCIDR",
                                "Allowed",
                                "CIDR2"
                            ]
                        },
                        "Description": "SSH org #2"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-instance-sg"
                        }
                    }
                ]
            }
        },
        "AccessLogsBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "OwnershipControls": {
                    "Rules": [
                        {
                            "ObjectOwnership": "BucketOwnerPreferred"
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "BucketKeyEnabled": true,
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "EncryptionKey"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AccessLogsBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "AccessLogsBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowServerAccessLogs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logging.s3.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${AccessLogsBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ApplicationBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "AccessLogsBucket"
                    },
                    "LogFilePrefix": "application/"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "BucketKeyEnabled": true,
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "EncryptionKey"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "LoggingConfiguration": {
                    "DestinationBucketName": {
                        "Ref": "AccessLogsBucket"
                    },
                    "LogFilePrefix": "config/"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "BucketKeyEnabled": true,
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "EncryptionKey"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "ConfigBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "ConfigBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSConfigBucketPermissionsCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ConfigBucket",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AWSConfigBucketExistenceCheck",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:ListBucket",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ConfigBucket",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        },
                        {
                            "Sid": "AWSConfigBucketDelivery",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${ConfigBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control",
                                    "aws:SourceAccount": {
                                        "Ref": "AWS::AccountId"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AppLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/${AWS::StackName}/application"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "EncryptionKey",
                        "Arn"
                    ]
                }
            }
        },
        "VPCFlowLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/${AWS::StackName}/vpcflowlogs"
                },
                "RetentionInDays": 30,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "EncryptionKey",
                        "Arn"
                    ]
                }
            }
        },
        "EC2Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Policies": [
                    {
                        "PolicyName": "AppLogsWrite",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${AppLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2Role"
                    }
                ]
            }
        },
        "VPCFlowLogRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "vpc-flow-logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "FlowLogsToCW",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${VPCFlowLogGroup.Arn}:*"
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "MFAEnforcementPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "Description": "Deny non-MFA actions for IAM users (except MFA setup/self-management)",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowViewAccountInfo",
                            "Effect": "Allow",
                            "Action": [
                                "iam:GetAccountPasswordPolicy",
                                "iam:GetAccountSummary",
                                "iam:ListVirtualMFADevices"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowManageOwnPasswords",
                            "Effect": "Allow",
                            "Action": [
                                "iam:ChangePassword",
                                "iam:GetUser"
                            ],
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:iam::",
                                        {
                                            "Ref": "AWS::AccountId"
                                        },
                                        ":user/${aws:username}"
                                    ]
                                ]
                            }
                        },
                        {
                            "Sid": "AllowManageOwnMFA",
                            "Effect": "Allow",
                            "Action": [
                                "iam:CreateVirtualMFADevice",
                                "iam:DeleteVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:ListMFADevices",
                                "iam:ResyncMFADevice"
                            ],
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":mfa/${aws:username}"
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:aws:iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":user/${aws:username}"
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Sid": "DenyAllUnlessMFA",
                            "Effect": "Deny",
                            "NotAction": [
                                "iam:CreateVirtualMFADevice",
                                "iam:EnableMFADevice",
                                "iam:GetUser",
                                "iam:ListMFADevices",
                                "iam:ListVirtualMFADevices",
                                "iam:ResyncMFADevice",
                                "sts:GetSessionToken",
                                "iam:ChangePassword",
                                "iam:GetAccountPasswordPolicy",
                                "iam:GetAccountSummary"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "BoolIfExists": {
                                    "aws:MultiFactorAuthPresent": "false"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "AllUsersGroup": {
            "Type": "AWS::IAM::Group",
            "Properties": {
                "ManagedPolicyArns": [
                    {
                        "Ref": "MFAEnforcementPolicy"
                    }
                ]
            }
        },
        "AppInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
                "InstanceType": "t3.micro",
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "SubnetId": {
                    "Ref": "PublicSubnetA"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "InstanceSG"
                    }
                ],
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeType": "gp3",
                            "VolumeSize": 8,
                            "Encrypted": true,
                            "KmsKeyId": {
                                "Ref": "EncryptionKey"
                            },
                            "DeleteOnTermination": true
                        }
                    }
                ],
                "UserData": {
                    "Fn::Base64": "#!/bin/bash\nyum update -y\namazon-linux-extras install -y nginx1\necho \"OK\" > /usr/share/nginx/html/health\nsystemctl enable nginx && systemctl start nginx\n"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-app"
                        }
                    }
                ]
            }
        },
        "ALB": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Type": "application",
                "Scheme": "internet-facing",
                "Subnets": [
                    {
                        "Ref": "PublicSubnetA"
                    },
                    {
                        "Ref": "PublicSubnetB"
                    }
                ],
                "SecurityGroups": [
                    {
                        "Ref": "ALBSG"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${AWS::StackName}-alb"
                        }
                    }
                ]
            }
        },
        "TargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Protocol": "HTTP",
                "Port": 80,
                "TargetType": "instance",
                "HealthCheckPath": "/health",
                "HealthCheckProtocol": "HTTP",
                "Targets": [
                    {
                        "Id": {
                            "Ref": "AppInstance"
                        },
                        "Port": 80
                    }
                ]
            }
        },
        "HTTPSListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "LoadBalancerArn": {
                    "Ref": "ALB"
                },
                "Port": 443,
                "Protocol": "HTTPS",
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Fn::FindInMap": [
                                "ACM",
                                "Cert",
                                "Arn"
                            ]
                        }
                    }
                ],
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        }
                    }
                ],
                "SslPolicy": "ELBSecurityPolicy-TLS13-1-2-2021-06"
            }
        },
        "VPCFlowLogs": {
            "Type": "AWS::EC2::FlowLog",
            "Properties": {
                "ResourceType": "VPC",
                "ResourceId": {
                    "Ref": "VPC"
                },
                "TrafficType": "ALL",
                "LogDestinationType": "cloud-watch-logs",
                "LogGroupName": {
                    "Ref": "VPCFlowLogGroup"
                },
                "DeliverLogsPermissionArn": {
                    "Fn::GetAtt": [
                        "VPCFlowLogRole",
                        "Arn"
                    ]
                }
            }
        },
        "KeySigningKey": {
            "Type": "AWS::Route53::KeySigningKey",
            "Properties": {
                "HostedZoneId": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "Id"
                    ]
                },
                "KeyManagementServiceArn": {
                    "Fn::GetAtt": [
                        "DNSSECKey",
                        "Arn"
                    ]
                },
                "Name": "ksk_main",
                "Status": "ACTIVE"
            }
        },
        "KSKWaiterRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "Route53ReadAndLogs",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "route53:GetDNSSEC"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "KSKWaiterFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Runtime": "python3.12",
                "Handler": "index.handler",
                "Timeout": 300,
                "Role": {
                    "Fn::GetAtt": [
                        "KSKWaiterRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "import json, time, urllib.request, logging, boto3\nlog = logging.getLogger()\nlog.setLevel(logging.INFO)\nr53 = boto3.client('route53')\ndef respond(event, status, data=None, reason=None):\n    body = {\n        'Status': status,\n        'Reason': reason or 'See CloudWatch Logs for details',\n        'PhysicalResourceId': event.get('PhysicalResourceId', 'KSKWaiter'),\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'Data': data or {}\n    }\n    req = urllib.request.Request(event['ResponseURL'], data=json.dumps(body).encode('utf-8'), method='PUT')\n    req.add_header('content-type', '')\n    urllib.request.urlopen(req).read()\ndef ksk_is_active(hz_id, ksk_name):\n    resp = r53.get_dnssec(HostedZoneId=hz_id)\n    ksk_ok = any(ksk.get('Name') == ksk_name and ksk.get('Status') == 'ACTIVE'\n                 for ksk in resp.get('KeySigningKeys', []))\n    log.info(f\"Checking KSK {ksk_name}: ACTIVE={ksk_ok}\")\n    return ksk_ok\ndef handler(event, context):\n    try:\n        if event['RequestType'] == 'Delete':\n            return respond(event, 'SUCCESS', {'Message': 'Deleted'})\n        props = event['ResourceProperties']\n        hz_id = props['HostedZoneId']\n        ksk_name = props['KSKName']\n        deadline = time.time() + 240  # 4 minutes max wait\n        while time.time() < deadline:\n            if ksk_is_active(hz_id, ksk_name):\n                return respond(event, 'SUCCESS', {'Status': 'ACTIVE'})\n            time.sleep(10)\n        return respond(event, 'FAILED', reason='KSK did not become ACTIVE in time')\n    except Exception as e:\n        log.exception('waiter error')\n        return respond(event, 'FAILED', reason=str(e))\n"
                }
            }
        },
        "WaitForKSKActive": {
            "Type": "Custom::WaitForKSKActive",
            "DependsOn": "KeySigningKey",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "KSKWaiterFunction",
                        "Arn"
                    ]
                },
                "HostedZoneId": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "Id"
                    ]
                },
                "KSKName": "ksk_main"
            }
        },
        "DNSSECEnable": {
            "Type": "AWS::Route53::DNSSEC",
            "DependsOn": "WaitForKSKActive",
            "Properties": {
                "HostedZoneId": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "Id"
                    ]
                }
            }
        },
        "ApexA": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneId": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "Id"
                    ]
                },
                "Name": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "ApexFQDN"
                    ]
                },
                "Type": "A",
                "AliasTarget": {
                    "DNSName": {
                        "Fn::GetAtt": [
                            "ALB",
                            "DNSName"
                        ]
                    },
                    "HostedZoneId": {
                        "Fn::GetAtt": [
                            "ALB",
                            "CanonicalHostedZoneID"
                        ]
                    }
                }
            }
        },
        "ApexAAAA": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneId": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "Id"
                    ]
                },
                "Name": {
                    "Fn::FindInMap": [
                        "R53",
                        "Zone",
                        "ApexFQDN"
                    ]
                },
                "Type": "AAAA",
                "AliasTarget": {
                    "DNSName": {
                        "Fn::GetAtt": [
                            "ALB",
                            "DNSName"
                        ]
                    },
                    "HostedZoneId": {
                        "Fn::GetAtt": [
                            "ALB",
                            "CanonicalHostedZoneID"
                        ]
                    }
                }
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "VPC ID",
            "Value": {
                "Ref": "VPC"
            }
        },
        "ALBDNSName": {
            "Description": "ALB DNS name",
            "Value": {
                "Fn::GetAtt": [
                    "ALB",
                    "DNSName"
                ]
            }
        },
        "PublicFQDN": {
            "Description": "Public apex pointing to ALB",
            "Value": {
                "Fn::FindInMap": [
                    "R53",
                    "Zone",
                    "ApexFQDN"
                ]
            }
        },
        "Route53HostedZoneId": {
            "Description": "Hosted zone used",
            "Value": {
                "Fn::FindInMap": [
                    "R53",
                    "Zone",
                    "Id"
                ]
            }
        },
        "KMSKeyId": {
            "Description": "General encryption KMS KeyId",
            "Value": {
                "Ref": "EncryptionKey"
            }
        },
        "MFAGroupToUse": {
            "Description": "Add IAM users to this group to enforce MFA",
            "Value": {
                "Ref": "AllUsersGroup"
            }
        }
    }
}
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Serverless Image Processing System with S3, Lambda, DynamoDB, and CloudWatch",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Environment suffix for resource naming",
      "Default": "prod"
    }
  },
  "Resources": {
    "ImageBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "image-processing-bucket-${EnvironmentSuffix}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "NotificationConfiguration": {
          "LambdaConfigurations": [
            {
              "Event": "s3:ObjectCreated:*",
              "Function": {
                "Fn::GetAtt": [
                  "ImageProcessorFunction",
                  "Arn"
                ]
              },
              "Filter": {
                "S3Key": {
                  "Rules": [
                    {
                      "Name": "prefix",
                      "Value": "uploads/"
                    },
                    {
                      "Name": "suffix",
                      "Value": ".jpg"
                    }
                  ]
                }
              }
            },
            {
              "Event": "s3:ObjectCreated:*",
              "Function": {
                "Fn::GetAtt": [
                  "ImageProcessorFunction",
                  "Arn"
                ]
              },
              "Filter": {
                "S3Key": {
                  "Rules": [
                    {
                      "Name": "prefix",
                      "Value": "uploads/"
                    },
                    {
                      "Name": "suffix",
                      "Value": ".png"
                    }
                  ]
                }
              }
            }
          ]
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Application",
            "Value": "ImageProcessing"
          }
        ]
      }
    },
    "ImageMetadataTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Sub": "image-metadata-${EnvironmentSuffix}"
        },
        "BillingMode": "PAY_PER_REQUEST",
        "AttributeDefinitions": [
          {
            "AttributeName": "imageId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "uploadTimestamp",
            "AttributeType": "N"
          },
          {
            "AttributeName": "status",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "imageId",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "uploadTimestamp",
            "KeyType": "RANGE"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "StatusIndex",
            "KeySchema": [
              {
                "AttributeName": "status",
                "KeyType": "HASH"
              },
              {
                "AttributeName": "uploadTimestamp",
                "KeyType": "RANGE"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          }
        ],
        "StreamSpecification": {
          "StreamViewType": "NEW_AND_OLD_IMAGES"
        },
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          },
          {
            "Key": "Application",
            "Value": "ImageProcessing"
          }
        ]
      }
    },
    "ImageProcessorRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "ImageProcessorPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:DeleteObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Sub": "${ImageBucket}/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Resource": {
                    "Fn::GetAtt": [
                      "ImageBucket",
                      "Arn"
                    ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:GetItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "ImageMetadataTable",
                        "Arn"
                      ]
                    },
                    {
                      "Fn::Sub": "${ImageMetadataTable.Arn}/index/*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudwatch:PutMetricData"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "ImageProcessorFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "image-processor-${EnvironmentSuffix}"
        },
        "Runtime": "python3.9",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "ImageProcessorRole",
            "Arn"
          ]
        },
        "Timeout": 300,
        "MemorySize": 1024,
        "Environment": {
          "Variables": {
            "METADATA_TABLE": {
              "Ref": "ImageMetadataTable"
            },
            "PROCESSED_BUCKET": {
              "Ref": "ImageBucket"
            },
            "ENVIRONMENT": {
              "Ref": "EnvironmentSuffix"
            }
          }
        },
        "Code": {
          "ZipFile": "import json\nimport boto3\nimport os\nimport uuid\nfrom datetime import datetime\nfrom urllib.parse import unquote_plus\n\ns3_client = boto3.client('s3')\ndynamodb = boto3.resource('dynamodb')\ncloudwatch = boto3.client('cloudwatch')\n\ndef handler(event, context):\n    print(f\"Processing event: {json.dumps(event, default=str)}\")\n    \n    processed_count = 0\n    errors = []\n    \n    try:\n        for record in event.get('Records', []):\n            if record['eventSource'] != 'aws:s3':\n                continue\n                \n            bucket = record['s3']['bucket']['name']\n            key = unquote_plus(record['s3']['object']['key'])\n            size = record['s3']['object']['size']\n            \n            print(f\"Processing image: {key} from bucket: {bucket}\")\n            \n            try:\n                image_id = str(uuid.uuid4())\n                upload_timestamp = int(datetime.now().timestamp() * 1000)\n                \n                response = s3_client.get_object(Bucket=bucket, Key=key)\n                image_content = response['Body'].read()\n                \n                thumbnail_key = f\"thumbnails/{image_id}_thumb.jpg\"\n                \n                table = dynamodb.Table(os.environ['METADATA_TABLE'])\n                table.put_item(\n                    Item={\n                        'imageId': image_id,\n                        'uploadTimestamp': upload_timestamp,\n                        'originalKey': key,\n                        'thumbnailKey': thumbnail_key,\n                        'status': 'PROCESSED',\n                        'fileSize': size,\n                        'processedAt': datetime.now().isoformat(),\n                        'bucket': bucket\n                    }\n                )\n                \n                processed_count += 1\n                print(f\"Successfully processed image: {image_id}\")\n                \n            except Exception as e:\n                error_msg = f\"Error processing {key}: {str(e)}\"\n                print(error_msg)\n                errors.append(error_msg)\n        \n        publish_metrics('ImagesProcessed', processed_count, 'Count')\n        publish_metrics('ProcessingErrors', len(errors), 'Count')\n        \n        return {\n            'statusCode': 200,\n            'body': json.dumps({\n                'message': f'Successfully processed {processed_count} images',\n                'errors': len(errors),\n                'processedCount': processed_count\n            })\n        }\n        \n    except Exception as e:\n        print(f\"Fatal error in handler: {str(e)}\")\n        publish_metrics('ProcessingErrors', 1, 'Count')\n        \n        return {\n            'statusCode': 500,\n            'body': json.dumps({\n                'message': 'Error processing images',\n                'error': str(e)\n            })\n        }\n\ndef publish_metrics(metric_name, value, unit):\n    try:\n        cloudwatch.put_metric_data(\n            Namespace='ImageProcessing',\n            MetricData=[\n                {\n                    'MetricName': metric_name,\n                    'Value': value,\n                    'Unit': unit,\n                    'Timestamp': datetime.now(),\n                    'Dimensions': [\n                        {\n                            'Name': 'Environment',\n                            'Value': os.environ['ENVIRONMENT']\n                        }\n                    ]\n                }\n            ]\n        )\n    except Exception as e:\n        print(f\"Error publishing metrics: {e}\")\n"
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "S3InvokeLambdaPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "ImageProcessorFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "s3.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "${ImageBucket}"
        }
      }
    },
    "ImageProcessorLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Sub": "/aws/lambda/image-processor-${EnvironmentSuffix}"
        },
        "RetentionInDays": 30
      }
    },
    "LambdaErrorAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "image-processor-errors-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when Lambda function has errors",
        "MetricName": "Errors",
        "Namespace": "AWS/Lambda",
        "Statistic": "Sum",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 5,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {
              "Ref": "ImageProcessorFunction"
            }
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "LambdaDurationAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "image-processor-duration-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alert when Lambda function duration is too high",
        "MetricName": "Duration",
        "Namespace": "AWS/Lambda",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 240000,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "FunctionName",
            "Value": {
              "Ref": "ImageProcessorFunction"
            }
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "ImageProcessingDashboard": {
      "Type": "AWS::CloudWatch::Dashboard",
      "Properties": {
        "DashboardName": {
          "Fn::Sub": "image-processing-${EnvironmentSuffix}"
        },
        "DashboardBody": {
          "Fn::Sub": "{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/Lambda\", \"Invocations\", \"FunctionName\", \"${ImageProcessorFunction}\"],\n          [\".\", \"Errors\", \".\", \".\"],\n          [\".\", \"Duration\", \".\", \".\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Lambda Performance Metrics\",\n        \"period\": 300\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"ImageProcessing\", \"ImagesProcessed\"],\n          [\".\", \"ProcessingErrors\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"Image Processing Metrics\",\n        \"period\": 300\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/S3\", \"BucketSizeBytes\", \"BucketName\", \"${ImageBucket}\", \"StorageType\", \"StandardStorage\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"S3 Storage Usage\",\n        \"period\": 86400\n      }\n    },\n    {\n      \"type\": \"metric\",\n      \"properties\": {\n        \"metrics\": [\n          [\"AWS/DynamoDB\", \"ConsumedReadCapacityUnits\", \"TableName\", \"${ImageMetadataTable}\"],\n          [\".\", \"ConsumedWriteCapacityUnits\", \".\", \".\"]\n        ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"region\": \"${AWS::Region}\",\n        \"title\": \"DynamoDB Usage\",\n        \"period\": 300\n      }\n    }\n  ]\n}"
        }
      }
    }
  },
  "Outputs": {
    "ImageBucketName": {
      "Description": "Name of the S3 bucket for image storage",
      "Value": {
        "Ref": "ImageBucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ImageBucket"
        }
      }
    },
    "ImageMetadataTableName": {
      "Description": "Name of the DynamoDB table for image metadata",
      "Value": {
        "Ref": "ImageMetadataTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-MetadataTable"
        }
      }
    },
    "ImageProcessorFunctionArn": {
      "Description": "ARN of the image processor Lambda function",
      "Value": {
        "Fn::GetAtt": [
          "ImageProcessorFunction",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-LambdaArn"
        }
      }
    },
    "DashboardURL": {
      "Description": "CloudWatch Dashboard URL",
      "Value": {
        "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=image-processing-${EnvironmentSuffix}"
      }
    },
    "ImageBucketArn": {
      "Description": "ARN of the S3 bucket",
      "Value": {
        "Fn::GetAtt": [
          "ImageBucket",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ImageBucketArn"
        }
      }
    }
  }
}
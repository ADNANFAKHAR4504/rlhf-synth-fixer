{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Secure, Scalable, Fully Serverless Web Application Infrastructure",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Environment Configuration"
                    },
                    "Parameters": [
                        "EnvironmentSuffix"
                    ]
                }
            ],
            "ParameterLabels": {
                "EnvironmentSuffix": {
                    "default": "Environment Suffix"
                }
            }
        }
    },
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "prod",
            "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
            "AllowedPattern": "^[a-zA-Z0-9]+$",
            "ConstraintDescription": "Must contain only alphanumeric characters"
        }
    },
    "Resources": {
        "KMSKey": {
            "Type": "AWS::KMS::Key",
            "Properties": {
                "Description": {
                    "Fn::Sub": "KMS Key for ${EnvironmentSuffix} serverless application encryption"
                },
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "Enable IAM User Permissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow CloudWatch Logs",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "Allow Lambda Service",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": [
                                "kms:Decrypt",
                                "kms:GenerateDataKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-serverless-kms-key"
                        }
                    }
                ]
            }
        },
        "KMSKeyAlias": {
            "Type": "AWS::KMS::Alias",
            "Properties": {
                "AliasName": {
                    "Fn::Sub": "alias/${EnvironmentSuffix}-serverless-app-key"
                },
                "TargetKeyId": {
                    "Ref": "KMSKey"
                }
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "KMSKey"
                                }
                            },
                            "BucketKeyEnabled": true
                        }
                    ]
                },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "DeleteIncompleteMultipartUploads",
                            "Status": "Enabled",
                            "AbortIncompleteMultipartUpload": {
                                "DaysAfterInitiation": 7
                            }
                        },
                        {
                            "Id": "TransitionToIA",
                            "Status": "Enabled",
                            "Transitions": [
                                {
                                    "StorageClass": "STANDARD_IA",
                                    "TransitionInDays": 30
                                }
                            ]
                        }
                    ]
                },
                "NotificationConfiguration": {
                    "TopicConfigurations": []
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-serverless-app-bucket"
                        }
                    }
                ]
            },
            "DeletionPolicy": "Retain",
            "UpdateReplacePolicy": "Retain"
        },
        "DynamoDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {
                    "Fn::Sub": "ServerlessAppTable-${EnvironmentSuffix}"
                },
                "AttributeDefinitions": [
                    {
                        "AttributeName": "id",
                        "AttributeType": "S"
                    },
                    {
                        "AttributeName": "timestamp",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "id",
                        "KeyType": "HASH"
                    },
                    {
                        "AttributeName": "timestamp",
                        "KeyType": "RANGE"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST",
                "SSESpecification": {
                    "SSEEnabled": true,
                    "SSEType": "KMS",
                    "KMSMasterKeyId": {
                        "Ref": "KMSKey"
                    }
                },
                "PointInTimeRecoverySpecification": {
                    "PointInTimeRecoveryEnabled": true
                },
                "DeletionProtectionEnabled": false,
                "StreamSpecification": {
                    "StreamViewType": "NEW_AND_OLD_IMAGES"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-serverless-app-table"
                        }
                    }
                ]
            }
        },
        "LambdaLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${EnvironmentSuffix}-serverless-app-function"
                },
                "RetentionInDays": 14,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-lambda-logs"
                        }
                    }
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "DynamoDBAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:GetItem",
                                        "dynamodb:PutItem",
                                        "dynamodb:UpdateItem",
                                        "dynamodb:DeleteItem",
                                        "dynamodb:Query",
                                        "dynamodb:Scan"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "DynamoDBTable",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "S3Access",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject",
                                        "s3:DeleteObject"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "${S3Bucket.Arn}/*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:ListBucket"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "S3Bucket",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "KMSAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "kms:Decrypt",
                                        "kms:GenerateDataKey",
                                        "kms:DescribeKey"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "KMSKey",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CloudWatchLogs",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${EnvironmentSuffix}-serverless-app-function:*"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": [
                "LambdaLogGroup"
            ],
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${EnvironmentSuffix}-serverless-app-function"
                },
                "Runtime": "python3.11",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Timeout": 30,
                "MemorySize": 256,
                "Environment": {
                    "Variables": {
                        "DYNAMODB_TABLE": {
                            "Ref": "DynamoDBTable"
                        },
                        "S3_BUCKET": {
                            "Ref": "S3Bucket"
                        },
                        "KMS_KEY_ID": {
                            "Ref": "KMSKey"
                        },
                        "ENVIRONMENT": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                },
                "KmsKeyArn": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "import json\nimport boto3\nimport os\nfrom datetime import datetime\nimport decimal\nimport uuid\n\n# Helper class to handle decimal serialization\nclass DecimalEncoder(json.JSONEncoder):\n    def default(self, o):\n        if isinstance(o, decimal.Decimal):\n            return float(o)\n        return super(DecimalEncoder, self).default(o)\n\ndynamodb = boto3.resource('dynamodb')\ns3 = boto3.client('s3')\n\ndef lambda_handler(event, context):\n    print(f\"Received event: {json.dumps(event)}\")\n    \n    table_name = os.environ['DYNAMODB_TABLE']\n    table = dynamodb.Table(table_name)\n    \n    # CORS headers for all responses\n    cors_headers = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',\n        'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',\n        'Content-Type': 'application/json'\n    }\n    \n    try:\n        # Handle OPTIONS requests for CORS preflight\n        if event.get('httpMethod') == 'OPTIONS':\n            return {\n                'statusCode': 200,\n                'headers': cors_headers,\n                'body': json.dumps({'message': 'CORS preflight'})\n            }\n        \n        # Handle GET requests - retrieve all items\n        elif event.get('httpMethod') == 'GET':\n            print(\"Processing GET request\")\n            response = table.scan()\n            \n            return {\n                'statusCode': 200,\n                'headers': cors_headers,\n                'body': json.dumps({\n                    'message': 'Data retrieved successfully',\n                    'data': response.get('Items', []),\n                    'count': len(response.get('Items', [])),\n                    'environment': os.environ['ENVIRONMENT'],\n                    'timestamp': datetime.utcnow().isoformat()\n                }, cls=DecimalEncoder)\n            }\n        \n        # Handle POST requests - create new item\n        elif event.get('httpMethod') == 'POST':\n            print(\"Processing POST request\")\n            \n            # Parse request body\n            if event.get('body'):\n                try:\n                    body = json.loads(event['body'])\n                except json.JSONDecodeError:\n                    return {\n                        'statusCode': 400,\n                        'headers': cors_headers,\n                        'body': json.dumps({\n                            'error': 'Invalid JSON in request body',\n                            'message': 'Request body must be valid JSON'\n                        })\n                    }\n            else:\n                body = {}\n            \n            # Generate unique ID and timestamp\n            item_id = body.get('id', str(uuid.uuid4()))\n            timestamp = datetime.utcnow().isoformat()\n            \n            # Create item for DynamoDB\n            item = {\n                'id': item_id,\n                'timestamp': timestamp,\n                'data': body.get('data', {}),\n                'environment': os.environ['ENVIRONMENT'],\n                'created_at': timestamp\n            }\n            \n            # Store item in DynamoDB\n            table.put_item(Item=item)\n            \n            # Optionally store in S3 for backup\n            try:\n                s3_key = f\"data/{item_id}-{timestamp}.json\"\n                s3.put_object(\n                    Bucket=os.environ['S3_BUCKET'],\n                    Key=s3_key,\n                    Body=json.dumps(item, cls=DecimalEncoder),\n                    ContentType='application/json'\n                )\n                print(f\"Item also stored in S3: {s3_key}\")\n            except Exception as s3_error:\n                print(f\"S3 storage failed: {str(s3_error)}\")\n                # Continue even if S3 fails\n            \n            return {\n                'statusCode': 201,\n                'headers': cors_headers,\n                'body': json.dumps({\n                    'message': 'Item created successfully',\n                    'item': item,\n                    'environment': os.environ['ENVIRONMENT']\n                }, cls=DecimalEncoder)\n            }\n        \n        # Handle PUT requests - update existing item\n        elif event.get('httpMethod') == 'PUT':\n            print(\"Processing PUT request\")\n            \n            if not event.get('body'):\n                return {\n                    'statusCode': 400,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'error': 'Missing request body',\n                        'message': 'PUT request requires a JSON body'\n                    })\n                }\n            \n            try:\n                body = json.loads(event['body'])\n            except json.JSONDecodeError:\n                return {\n                    'statusCode': 400,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'error': 'Invalid JSON in request body'\n                    })\n                }\n            \n            if not body.get('id'):\n                return {\n                    'statusCode': 400,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'error': 'Missing required field: id'\n                    })\n                }\n            \n            # Update item in DynamoDB\n            response = table.update_item(\n                Key={\n                    'id': body['id'],\n                    'timestamp': body.get('timestamp', datetime.utcnow().isoformat())\n                },\n                UpdateExpression='SET #data = :data, updated_at = :updated_at',\n                ExpressionAttributeNames={\n                    '#data': 'data'\n                },\n                ExpressionAttributeValues={\n                    ':data': body.get('data', {}),\n                    ':updated_at': datetime.utcnow().isoformat()\n                },\n                ReturnValues='ALL_NEW'\n            )\n            \n            return {\n                'statusCode': 200,\n                'headers': cors_headers,\n                'body': json.dumps({\n                    'message': 'Item updated successfully',\n                    'item': response['Attributes'],\n                    'environment': os.environ['ENVIRONMENT']\n                }, cls=DecimalEncoder)\n            }\n        \n        # Handle DELETE requests\n        elif event.get('httpMethod') == 'DELETE':\n            print(\"Processing DELETE request\")\n            \n            # Get ID from path parameters or query parameters\n            item_id = None\n            if event.get('pathParameters') and event['pathParameters'].get('id'):\n                item_id = event['pathParameters']['id']\n            elif event.get('queryStringParameters') and event['queryStringParameters'].get('id'):\n                item_id = event['queryStringParameters']['id']\n            \n            if not item_id:\n                return {\n                    'statusCode': 400,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'error': 'Missing required parameter: id'\n                    })\n                }\n            \n            # Delete item from DynamoDB\n            try:\n                table.delete_item(\n                    Key={'id': item_id}\n                )\n                \n                return {\n                    'statusCode': 200,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'message': f'Item {item_id} deleted successfully',\n                        'environment': os.environ['ENVIRONMENT']\n                    })\n                }\n            except Exception as delete_error:\n                return {\n                    'statusCode': 404,\n                    'headers': cors_headers,\n                    'body': json.dumps({\n                        'error': 'Item not found',\n                        'message': str(delete_error)\n                    })\n                }\n        \n        # Handle unsupported methods\n        else:\n            return {\n                'statusCode': 405,\n                'headers': cors_headers,\n                'body': json.dumps({\n                    'error': 'Method Not Allowed',\n                    'message': f'HTTP method {event.get(\"httpMethod\", \"UNKNOWN\")} is not supported',\n                    'supported_methods': ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']\n                })\n            }\n    \n    except Exception as e:\n        print(f\"Error processing request: {str(e)}\")\n        return {\n            'statusCode': 500,\n            'headers': cors_headers,\n            'body': json.dumps({\n                'error': 'Internal Server Error',\n                'message': str(e),\n                'environment': os.environ['ENVIRONMENT']\n            })\n        }\n"
                }
            }
        },
        "ApiGatewayLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/apigateway/${EnvironmentSuffix}-serverless-app-api"
                },
                "RetentionInDays": 14,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "KMSKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-api-gateway-logs"
                        }
                    }
                ]
            }
        },
        "RestApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-serverless-app-api"
                },
                "Description": {
                    "Fn::Sub": "Serverless Application API for ${EnvironmentSuffix} environment"
                },
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-serverless-app-api"
                        }
                    }
                ]
            }
        },
        "ApiResource": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "RestApi",
                        "RootResourceId"
                    ]
                },
                "PathPart": "data"
            }
        },
        "ApiMethodGet": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "AWS_IAM",
                "ApiKeyRequired": true,
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaFunction.Arn}/invocations"
                    }
                }
            }
        },
        "ApiMethodPost": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "POST",
                "AuthorizationType": "AWS_IAM",
                "ApiKeyRequired": true,
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaFunction.Arn}/invocations"
                    }
                }
            }
        },
        "ApiMethodOptions": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "ResourceId": {
                    "Ref": "ApiResource"
                },
                "HttpMethod": "OPTIONS",
                "AuthorizationType": "NONE",
                "ApiKeyRequired": false,
                "Integration": {
                    "Type": "MOCK",
                    "IntegrationResponses": [
                        {
                            "StatusCode": 200,
                            "ResponseParameters": {
                                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",
                                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,OPTIONS'",
                                "method.response.header.Access-Control-Allow-Origin": "'*'"
                            }
                        }
                    ],
                    "RequestTemplates": {
                        "application/json": "{\"statusCode\": 200}"
                    }
                },
                "MethodResponses": [
                    {
                        "StatusCode": 200,
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Headers": false,
                            "method.response.header.Access-Control-Allow-Methods": false,
                            "method.response.header.Access-Control-Allow-Origin": false
                        }
                    }
                ]
            }
        },
        "LambdaApiGatewayPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "LambdaFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*/*"
                }
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "ApiMethodGet",
                "ApiMethodPost",
                "ApiMethodOptions",
                "LambdaApiGatewayPermission"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "Description": {
                    "Fn::Sub": "Deployment for ${EnvironmentSuffix} environment"
                }
            }
        },
        "ApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "RestApiId": {
                    "Ref": "RestApi"
                },
                "StageName": {
                    "Ref": "EnvironmentSuffix"
                },
                "DeploymentId": {
                    "Ref": "ApiDeployment"
                },
                "Description": {
                    "Fn::Sub": "Stage for ${EnvironmentSuffix} environment"
                },
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "LoggingLevel": "INFO",
                        "DataTraceEnabled": true,
                        "MetricsEnabled": true,
                        "ThrottlingRateLimit": 1000,
                        "ThrottlingBurstLimit": 2000
                    }
                ],
                "AccessLogSetting": {
                    "DestinationArn": {
                        "Fn::GetAtt": [
                            "ApiGatewayLogGroup",
                            "Arn"
                        ]
                    },
                    "Format": "$context.requestId $context.status $context.error.message $context.error.messageString"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-api-stage"
                        }
                    }
                ]
            }
        },
        "ApiKey": {
            "Type": "AWS::ApiGateway::ApiKey",
            "DependsOn": [
                "ApiStage"
            ],
            "Properties": {
                "Name": {
                    "Fn::Sub": "${EnvironmentSuffix}-serverless-app-api-key"
                },
                "Description": {
                    "Fn::Sub": "API Key for ${EnvironmentSuffix} serverless application"
                },
                "Enabled": true,
                "StageKeys": [
                    {
                        "RestApiId": {
                            "Ref": "RestApi"
                        },
                        "StageName": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-api-key"
                        }
                    }
                ]
            }
        },
        "UsagePlan": {
            "Type": "AWS::ApiGateway::UsagePlan",
            "DependsOn": [
                "ApiStage"
            ],
            "Properties": {
                "UsagePlanName": {
                    "Fn::Sub": "${EnvironmentSuffix}-serverless-app-usage-plan"
                },
                "Description": {
                    "Fn::Sub": "Usage plan for ${EnvironmentSuffix} serverless application"
                },
                "ApiStages": [
                    {
                        "ApiId": {
                            "Ref": "RestApi"
                        },
                        "Stage": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ],
                "Throttle": {
                    "RateLimit": 1000,
                    "BurstLimit": 2000
                },
                "Quota": {
                    "Limit": 10000,
                    "Period": "DAY"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "${EnvironmentSuffix}-usage-plan"
                        }
                    }
                ]
            }
        },
        "UsagePlanKey": {
            "Type": "AWS::ApiGateway::UsagePlanKey",
            "Properties": {
                "KeyId": {
                    "Ref": "ApiKey"
                },
                "KeyType": "API_KEY",
                "UsagePlanId": {
                    "Ref": "UsagePlan"
                }
            }
        }
    },
    "Outputs": {
        "StackName": {
            "Description": "Name of the CloudFormation stack",
            "Value": {
                "Ref": "AWS::StackName"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-StackName"
                }
            }
        },
        "Environment": {
            "Description": "Environment suffix used for this deployment",
            "Value": {
                "Ref": "EnvironmentSuffix"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-Environment"
                }
            }
        },
        "KMSKeyId": {
            "Description": "ID of the KMS key used for encryption",
            "Value": {
                "Ref": "KMSKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyId"
                }
            }
        },
        "KMSKeyArn": {
            "Description": "ARN of the KMS key used for encryption",
            "Value": {
                "Fn::GetAtt": [
                    "KMSKey",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyArn"
                }
            }
        },
        "KMSKeyAlias": {
            "Description": "Alias of the KMS key",
            "Value": {
                "Ref": "KMSKeyAlias"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-KMSKeyAlias"
                }
            }
        },
        "S3BucketName": {
            "Description": "Name of the S3 bucket for data storage",
            "Value": {
                "Ref": "S3Bucket"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3BucketName"
                }
            }
        },
        "S3BucketArn": {
            "Description": "ARN of the S3 bucket",
            "Value": {
                "Fn::GetAtt": [
                    "S3Bucket",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3BucketArn"
                }
            }
        },
        "S3BucketDomainName": {
            "Description": "Domain name of the S3 bucket",
            "Value": {
                "Fn::GetAtt": [
                    "S3Bucket",
                    "DomainName"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-S3BucketDomainName"
                }
            }
        },
        "DynamoDBTableName": {
            "Description": "Name of the DynamoDB table",
            "Value": {
                "Ref": "DynamoDBTable"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableName"
                }
            }
        },
        "DynamoDBTableArn": {
            "Description": "ARN of the DynamoDB table",
            "Value": {
                "Fn::GetAtt": [
                    "DynamoDBTable",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableArn"
                }
            }
        },
        "DynamoDBTableStreamArn": {
            "Description": "ARN of the DynamoDB table stream",
            "Value": {
                "Fn::GetAtt": [
                    "DynamoDBTable",
                    "StreamArn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DynamoDBTableStreamArn"
                }
            }
        },
        "LambdaFunctionName": {
            "Description": "Name of the Lambda function",
            "Value": {
                "Ref": "LambdaFunction"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunctionName"
                }
            }
        },
        "LambdaFunctionArn": {
            "Description": "ARN of the Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaFunction",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaFunctionArn"
                }
            }
        },
        "LambdaExecutionRoleArn": {
            "Description": "ARN of the Lambda execution role",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaExecutionRole",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaExecutionRoleArn"
                }
            }
        },
        "RestApiId": {
            "Description": "ID of the REST API",
            "Value": {
                "Ref": "RestApi"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RestApiId"
                }
            }
        },
        "RestApiRootResourceId": {
            "Description": "Root resource ID of the REST API",
            "Value": {
                "Fn::GetAtt": [
                    "RestApi",
                    "RootResourceId"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-RestApiRootResourceId"
                }
            }
        },
        "ApiGatewayUrl": {
            "Description": "URL of the API Gateway endpoint",
            "Value": {
                "Fn::Sub": "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayUrl"
                }
            }
        },
        "ApiGatewayDataEndpoint": {
            "Description": "Full URL for the data endpoint",
            "Value": {
                "Fn::Sub": "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}/data"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayDataEndpoint"
                }
            }
        },
        "ApiKeyId": {
            "Description": "ID of the API Gateway API key",
            "Value": {
                "Ref": "ApiKey"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiKeyId"
                }
            }
        },
        "LambdaLogGroupName": {
            "Description": "Name of the Lambda function log group",
            "Value": {
                "Ref": "LambdaLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaLogGroupName"
                }
            }
        },
        "LambdaLogGroupArn": {
            "Description": "ARN of the Lambda function log group",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaLogGroup",
                    "Arn"
                ]
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-LambdaLogGroupArn"
                }
            }
        },
        "ApiGatewayLogGroupName": {
            "Description": "Name of the API Gateway log group",
            "Value": {
                "Ref": "ApiGatewayLogGroup"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-ApiGatewayLogGroupName"
                }
            }
        },
        "UsagePlanId": {
            "Description": "ID of the API Gateway usage plan",
            "Value": {
                "Ref": "UsagePlan"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-UsagePlanId"
                }
            }
        },
        "DeploymentTimestamp": {
            "Description": "Timestamp of the deployment",
            "Value": {
                "Fn::Sub": "${AWS::StackName}-deployed-at-${AWS::Region}"
            },
            "Export": {
                "Name": {
                    "Fn::Sub": "${AWS::StackName}-DeploymentInfo"
                }
            }
        }
    }
}
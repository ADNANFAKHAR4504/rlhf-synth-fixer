{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Master stack for multi-tier web application with nested stacks for VPC, Compute, and Data tiers",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Environment Configuration"
          },
          "Parameters": [
            "EnvironmentSuffix",
            "EnvironmentType",
            "CostCenter"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VpcCidr",
            "AvailabilityZone1",
            "AvailabilityZone2",
            "AvailabilityZone3"
          ]
        },
        {
          "Label": {
            "default": "Compute Configuration"
          },
          "Parameters": [
            "InstanceType",
            "MinSize",
            "MaxSize",
            "DesiredCapacity"
          ]
        },
        {
          "Label": {
            "default": "Database Configuration"
          },
          "Parameters": [
            "DBMasterUsername",
            "DBMasterPassword",
            "EnableElastiCache"
          ]
        },
        {
          "Label": {
            "default": "Nested Stack Templates"
          },
          "Parameters": [
            "TemplatesBucketName",
            "VPCTemplateKey",
            "ComputeTemplateKey",
            "DataTemplateKey"
          ]
        }
      ],
      "ParameterLabels": {
        "EnvironmentSuffix": {
          "default": "Environment Suffix for Resource Naming"
        },
        "EnvironmentType": {
          "default": "Environment Type (prod enables ElastiCache)"
        },
        "CostCenter": {
          "default": "Cost Center for Resource Tagging"
        },
        "VpcCidr": {
          "default": "VPC CIDR Block"
        },
        "InstanceType": {
          "default": "EC2 Instance Type"
        },
        "DBMasterUsername": {
          "default": "Database Master Username"
        },
        "DBMasterPassword": {
          "default": "Database Master Password"
        },
        "EnableElastiCache": {
          "default": "Enable ElastiCache Redis Cluster"
        }
      }
    }
  },
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Unique suffix for resource names to support multiple environments",
      "MinLength": 3,
      "MaxLength": 10,
      "AllowedPattern": "[a-z0-9]+",
      "ConstraintDescription": "Must be lowercase alphanumeric, 3-10 characters"
    },
    "EnvironmentType": {
      "Type": "String",
      "Description": "Environment type for conditional resource creation",
      "Default": "dev",
      "AllowedValues": ["dev", "staging", "prod"],
      "ConstraintDescription": "Must be dev, staging, or prod"
    },
    "CostCenter": {
      "Type": "String",
      "Description": "Cost center identifier for resource tagging",
      "Default": "engineering",
      "MinLength": 3,
      "MaxLength": 50
    },
    "VpcCidr": {
      "Type": "String",
      "Description": "CIDR block for the VPC",
      "Default": "10.0.0.0/16",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid CIDR block"
    },
    "AvailabilityZone1": {
      "Type": "String",
      "Description": "First availability zone (leave empty to auto-select)",
      "Default": ""
    },
    "AvailabilityZone2": {
      "Type": "String",
      "Description": "Second availability zone (leave empty to auto-select)",
      "Default": ""
    },
    "AvailabilityZone3": {
      "Type": "String",
      "Description": "Third availability zone (leave empty to auto-select)",
      "Default": ""
    },
    "InstanceType": {
      "Type": "String",
      "Description": "EC2 instance type for application servers",
      "Default": "t3.medium",
      "AllowedValues": ["t3.medium", "t3.large", "t3.xlarge"],
      "ConstraintDescription": "Must be t3.medium, t3.large, or t3.xlarge"
    },
    "MinSize": {
      "Type": "Number",
      "Description": "Minimum number of instances in Auto Scaling Group",
      "Default": 2,
      "MinValue": 1,
      "MaxValue": 10
    },
    "MaxSize": {
      "Type": "Number",
      "Description": "Maximum number of instances in Auto Scaling Group",
      "Default": 6,
      "MinValue": 1,
      "MaxValue": 20
    },
    "DesiredCapacity": {
      "Type": "Number",
      "Description": "Desired number of instances in Auto Scaling Group",
      "Default": 3,
      "MinValue": 1,
      "MaxValue": 10
    },
    "DBMasterUsername": {
      "Type": "String",
      "Description": "Master username for RDS Aurora cluster",
      "Default": "dbadmin",
      "MinLength": 1,
      "MaxLength": 16,
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "Must begin with a letter and contain only alphanumeric characters"
    },
    "DBMasterPassword": {
      "Type": "String",
      "Description": "Master password for RDS Aurora cluster (Note: Using Secrets Manager in DataStack)",
      "Default": "TempPassword123",
      "NoEcho": true,
      "MinLength": 8,
      "MaxLength": 41,
      "AllowedPattern": "[a-zA-Z0-9]*",
      "ConstraintDescription": "Must contain only alphanumeric characters and be 8-41 characters long"
    },
    "EnableElastiCache": {
      "Type": "String",
      "Description": "Enable ElastiCache Redis cluster",
      "Default": "true",
      "AllowedValues": ["true", "false"]
    },
    "TemplatesBucketName": {
      "Type": "String",
      "Description": "S3 bucket name containing nested stack templates (auto-detected from CI/CD or manual override)",
      "Default": ""
    },
    "VPCTemplateKey": {
      "Type": "String",
      "Description": "S3 key for VPC template",
      "Default": "VPCStack.json"
    },
    "ComputeTemplateKey": {
      "Type": "String",
      "Description": "S3 key for Compute template",
      "Default": "ComputeStack.json"
    },
    "DataTemplateKey": {
      "Type": "String",
      "Description": "S3 key for Data template",
      "Default": "DataStack.json"
    }
  },
  "Conditions": {
    "IsProduction": {
      "Fn::Equals": [
        {
          "Ref": "EnvironmentType"
        },
        "prod"
      ]
    },
    "UseDefaultBucket": {
      "Fn::Equals": [
        {
          "Ref": "TemplatesBucketName"
        },
        ""
      ]
    }
  },
  "Resources": {
    "VPCStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": [
            "https://${BucketName}.s3.${AWS::Region}.amazonaws.com/${VPCTemplateKey}",
            {
              "BucketName": {
                "Fn::If": [
                  "UseDefaultBucket",
                  {
                    "Fn::Sub": "iac-rlhf-cfn-states-${AWS::Region}-${AWS::AccountId}"
                  },
                  {
                    "Ref": "TemplatesBucketName"
                  }
                ]
              }
            }
          ]
        },
        "Parameters": {
          "EnvironmentSuffix": {
            "Ref": "EnvironmentSuffix"
          },
          "VpcCidr": {
            "Ref": "VpcCidr"
          },
          "AvailabilityZone1": {
            "Ref": "AvailabilityZone1"
          },
          "AvailabilityZone2": {
            "Ref": "AvailabilityZone2"
          },
          "AvailabilityZone3": {
            "Ref": "AvailabilityZone3"
          },
          "CostCenter": {
            "Ref": "CostCenter"
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "vpc-stack-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentType"
            }
          }
        ]
      }
    },
    "ComputeStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": [
            "https://${BucketName}.s3.${AWS::Region}.amazonaws.com/${ComputeTemplateKey}",
            {
              "BucketName": {
                "Fn::If": [
                  "UseDefaultBucket",
                  {
                    "Fn::Sub": "iac-rlhf-cfn-states-${AWS::Region}-${AWS::AccountId}"
                  },
                  {
                    "Ref": "TemplatesBucketName"
                  }
                ]
              }
            }
          ]
        },
        "Parameters": {
          "EnvironmentSuffix": {
            "Ref": "EnvironmentSuffix"
          },
          "VpcId": {
            "Fn::GetAtt": ["VPCStack", "Outputs.VpcId"]
          },
          "PublicSubnet1": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PublicSubnet1"]
          },
          "PublicSubnet2": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PublicSubnet2"]
          },
          "PublicSubnet3": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PublicSubnet3"]
          },
          "PrivateSubnet1": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet1"]
          },
          "PrivateSubnet2": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet2"]
          },
          "PrivateSubnet3": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet3"]
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "MinSize": {
            "Ref": "MinSize"
          },
          "MaxSize": {
            "Ref": "MaxSize"
          },
          "DesiredCapacity": {
            "Ref": "DesiredCapacity"
          },
          "CostCenter": {
            "Ref": "CostCenter"
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "compute-stack-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentType"
            }
          }
        ]
      }
    },
    "DataStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": [
            "https://${BucketName}.s3.${AWS::Region}.amazonaws.com/${DataTemplateKey}",
            {
              "BucketName": {
                "Fn::If": [
                  "UseDefaultBucket",
                  {
                    "Fn::Sub": "iac-rlhf-cfn-states-${AWS::Region}-${AWS::AccountId}"
                  },
                  {
                    "Ref": "TemplatesBucketName"
                  }
                ]
              }
            }
          ]
        },
        "Parameters": {
          "EnvironmentSuffix": {
            "Ref": "EnvironmentSuffix"
          },
          "VpcId": {
            "Fn::GetAtt": ["VPCStack", "Outputs.VpcId"]
          },
          "PrivateSubnet1": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet1"]
          },
          "PrivateSubnet2": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet2"]
          },
          "PrivateSubnet3": {
            "Fn::GetAtt": ["VPCStack", "Outputs.PrivateSubnet3"]
          },
          "DBMasterUsername": {
            "Ref": "DBMasterUsername"
          },
          "DBMasterPassword": {
            "Ref": "DBMasterPassword"
          },
          "EnableElastiCache": {
            "Ref": "EnableElastiCache"
          },
          "CostCenter": {
            "Ref": "CostCenter"
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "data-stack-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "CostCenter",
            "Value": {
              "Ref": "CostCenter"
            }
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentType"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "VpcId": {
      "Description": "VPC ID",
      "Value": {
        "Fn::GetAtt": ["VPCStack", "Outputs.VpcId"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "VpcId-${EnvironmentSuffix}"
        }
      }
    },
    "LoadBalancerDNS": {
      "Description": "Application Load Balancer DNS name",
      "Value": {
        "Fn::GetAtt": ["ComputeStack", "Outputs.LoadBalancerDNS"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "LoadBalancerDNS-${EnvironmentSuffix}"
        }
      }
    },
    "DatabaseEndpoint": {
      "Description": "RDS Aurora cluster endpoint",
      "Value": {
        "Fn::GetAtt": ["DataStack", "Outputs.DatabaseEndpoint"]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "DatabaseEndpoint-${EnvironmentSuffix}"
        }
      }
    },
    "CacheEndpoint": {
      "Description": "ElastiCache Redis endpoint (if enabled)",
      "Value": {
        "Fn::GetAtt": ["DataStack", "Outputs.CacheEndpoint"]
      },
      "Condition": "IsProduction",
      "Export": {
        "Name": {
          "Fn::Sub": "CacheEndpoint-${EnvironmentSuffix}"
        }
      }
    }
  }
}

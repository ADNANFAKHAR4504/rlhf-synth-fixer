{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Cloud Environment Setup - S3, EC2, and DynamoDB Infrastructure",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Default": "dev",
      "Description": "Environment suffix for resource naming",
      "AllowedPattern": "^[a-zA-Z0-9]+$",
      "ConstraintDescription": "Must contain only alphanumeric characters"
    },
    "BucketName": {
      "Type": "String",
      "Default": "cloud-setup-bucket",
      "Description": "Name prefix for the S3 bucket",
      "AllowedPattern": "^[a-z0-9-]+$",
      "ConstraintDescription": "Must contain only lowercase letters, numbers, and hyphens"
    },
    "InstanceType": {
      "Type": "String",
      "Default": "t3.micro",
      "Description": "EC2 instance type",
      "AllowedValues": [
        "t3.micro",
        "t3.small",
        "t3.medium"
      ],
      "ConstraintDescription": "Must be a valid EC2 instance type"
    },
    "SSHAccessIP": {
      "Type": "String",
      "Default": "203.0.113.0/32",
      "Description": "IP address allowed for SSH access (CIDR notation)",
      "AllowedPattern": "^(\\d{1,3}\\.){3}\\d{1,3}\\/\\d{1,2}$",
      "ConstraintDescription": "Must be a valid CIDR notation (e.g., 203.0.113.0/32)"
    },
    "DynamoDBTableName": {
      "Type": "String",
      "Default": "CloudSetupTable",
      "Description": "Name for the DynamoDB table",
      "AllowedPattern": "^[a-zA-Z0-9-_]+$",
      "ConstraintDescription": "Must contain only alphanumeric characters, hyphens, and underscores"
    },
    "DynamoDBPrimaryKey": {
      "Type": "String",
      "Default": "id",
      "Description": "Primary key name for the DynamoDB table",
      "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9_]*$",
      "ConstraintDescription": "Must start with a letter and contain only alphanumeric characters and underscores"
    }
  },
  "Resources": {
    "CloudSetupVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "CloudSetup-VPC-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupInternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "CloudSetup-IGW-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupVPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "CloudSetupVPC"
        },
        "InternetGatewayId": {
          "Ref": "CloudSetupInternetGateway"
        }
      }
    },
    "CloudSetupPublicSubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "CloudSetupVPC"
        },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": {
          "Fn::Select": [
            0,
            {
              "Fn::GetAZs": ""
            }
          ]
        },
        "MapPublicIpOnLaunch": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "CloudSetup-PublicSubnet-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupPublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "CloudSetupVPC"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "CloudSetup-PublicRT-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupPublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "CloudSetupVPCGatewayAttachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "CloudSetupPublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "CloudSetupInternetGateway"
        }
      }
    },
    "CloudSetupSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "CloudSetupPublicSubnet"
        },
        "RouteTableId": {
          "Ref": "CloudSetupPublicRouteTable"
        }
      }
    },
    "CloudSetupS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${BucketName}-${EnvironmentSuffix}-${AWS::AccountId}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "EC2InstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": {
          "Fn::Sub": "CloudSetup-EC2Role-${EnvironmentSuffix}"
        },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "S3ListBucketPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:ListBucket",
                  "Resource": {
                    "Fn::GetAtt": [
                      "CloudSetupS3Bucket",
                      "Arn"
                    ]
                  }
                }
              ]
            }
          }
        ],
        "Tags": [
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "EC2InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "InstanceProfileName": {
          "Fn::Sub": "CloudSetup-EC2Profile-${EnvironmentSuffix}"
        },
        "Roles": [
          {
            "Ref": "EC2InstanceRole"
          }
        ]
      }
    },
    "EC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": {
          "Fn::Sub": "CloudSetup-SG-${EnvironmentSuffix}"
        },
        "GroupDescription": "Security group for CloudSetup EC2 instance",
        "VpcId": {
          "Ref": "CloudSetupVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": {
              "Ref": "SSHAccessIP"
            },
            "Description": "SSH access from specified IP"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": -1,
            "CidrIp": "0.0.0.0/0",
            "Description": "All outbound traffic"
          }
        ],
        "Tags": [
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "ImageId": "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}",
        "SubnetId": {
          "Ref": "CloudSetupPublicSubnet"
        },
        "SecurityGroupIds": [
          {
            "Ref": "EC2SecurityGroup"
          }
        ],
        "IamInstanceProfile": {
          "Ref": "EC2InstanceProfile"
        },
        "Monitoring": true,
        "UserData": {
          "Fn::Base64": "#!/bin/bash\nyum update -y\nyum install -y amazon-cloudwatch-agent\n/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c default\n"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "CloudSetup-Instance-${EnvironmentSuffix}"
            }
          },
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CPUAlarmHigh": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmName": {
          "Fn::Sub": "CloudSetup-HighCPU-${EnvironmentSuffix}"
        },
        "AlarmDescription": "Alarm when CPU exceeds 70%",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Statistic": "Average",
        "Period": 300,
        "EvaluationPeriods": 2,
        "Threshold": 70,
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "InstanceId",
            "Value": {
              "Ref": "CloudSetupEC2Instance"
            }
          }
        ],
        "AlarmActions": [
          {
            "Ref": "CPUAlarmTopic"
          }
        ],
        "TreatMissingData": "notBreaching"
      }
    },
    "CPUAlarmTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "TopicName": {
          "Fn::Sub": "CloudSetup-CPUAlarm-${EnvironmentSuffix}"
        },
        "DisplayName": "CloudSetup CPU Alarm Notifications",
        "Tags": [
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    },
    "CloudSetupDynamoDBTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Sub": "${DynamoDBTableName}-${EnvironmentSuffix}"
        },
        "AttributeDefinitions": [
          {
            "AttributeName": {
              "Ref": "DynamoDBPrimaryKey"
            },
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": {
              "Ref": "DynamoDBPrimaryKey"
            },
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 5,
          "WriteCapacityUnits": 5
        },
        "DeletionProtectionEnabled": false,
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": false
        },
        "SSESpecification": {
          "SSEEnabled": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "CloudSetup"
          },
          {
            "Key": "Environment",
            "Value": {
              "Ref": "EnvironmentSuffix"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "S3BucketName": {
      "Description": "Name of the created S3 bucket",
      "Value": {
        "Ref": "CloudSetupS3Bucket"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-S3BucketName"
        }
      }
    },
    "S3BucketArn": {
      "Description": "ARN of the created S3 bucket",
      "Value": {
        "Fn::GetAtt": [
          "CloudSetupS3Bucket",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-S3BucketArn"
        }
      }
    },
    "EC2InstanceId": {
      "Description": "Instance ID of the created EC2 instance",
      "Value": {
        "Ref": "CloudSetupEC2Instance"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EC2InstanceId"
        }
      }
    },
    "EC2InstancePublicIP": {
      "Description": "Public IP address of the EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "CloudSetupEC2Instance",
          "PublicIp"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EC2PublicIP"
        }
      }
    },
    "EC2SecurityGroupId": {
      "Description": "Security Group ID for the EC2 instance",
      "Value": {
        "Ref": "EC2SecurityGroup"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SecurityGroupId"
        }
      }
    },
    "DynamoDBTableName": {
      "Description": "Name of the created DynamoDB table",
      "Value": {
        "Ref": "CloudSetupDynamoDBTable"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DynamoDBTableName"
        }
      }
    },
    "DynamoDBTableArn": {
      "Description": "ARN of the created DynamoDB table",
      "Value": {
        "Fn::GetAtt": [
          "CloudSetupDynamoDBTable",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-DynamoDBTableArn"
        }
      }
    },
    "IAMRoleArn": {
      "Description": "ARN of the IAM role attached to EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "EC2InstanceRole",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-IAMRoleArn"
        }
      }
    },
    "CloudWatchAlarmName": {
      "Description": "Name of the CloudWatch CPU alarm",
      "Value": {
        "Ref": "CPUAlarmHigh"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-CPUAlarmName"
        }
      }
    },
    "StackName": {
      "Description": "Name of this CloudFormation stack",
      "Value": {
        "Ref": "AWS::StackName"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-StackName"
        }
      }
    },
    "EnvironmentSuffix": {
      "Description": "Environment suffix used for this deployment",
      "Value": {
        "Ref": "EnvironmentSuffix"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix"
        }
      }
    },
    "VPCId": {
      "Description": "VPC ID created for this deployment",
      "Value": {
        "Ref": "CloudSetupVPC"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-VPCId"
        }
      }
    },
    "SubnetId": {
      "Description": "Subnet ID created for this deployment",
      "Value": {
        "Ref": "CloudSetupPublicSubnet"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-SubnetId"
        }
      }
    }
  }
}
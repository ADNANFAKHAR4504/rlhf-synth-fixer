{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Zero-trust security baseline for a fresh AWS account. Least-privilege IAM, permission boundaries, cross-account access with external ID, KMS CMKs (RDS/S3/EBS) with MFA-guarded admin, S3 TLS/SSE-KMS enforcement, Secrets Manager + SSM parameters (dynamic references), CloudWatch Logs (KMS, 365d), AWS Config (custom resource orchestration with idempotent reuse), and regional guardrails.\n",
    "Parameters": {
        "EnvironmentSuffix": {
            "Type": "String",
            "Default": "dev",
            "Description": "Environment suffix for resource names (e.g., dev, prod, test-01)",
            "AllowedPattern": "^[a-zA-Z0-9-]+$"
        },
        "ApprovedAccountId": {
            "Type": "String",
            "Default": "342597974367",
            "Description": "AWS Account ID permitted for cross-account assume role",
            "AllowedPattern": "^[0-9]{12}$"
        },
        "ThirdPartyExternalId": {
            "Type": "String",
            "Default": "default-external-id-12345",
            "NoEcho": true,
            "MinLength": 8,
            "MaxLength": 128,
            "Description": "External ID used by third party when assuming the cross-account role"
        },
        "SecretLength": {
            "Type": "Number",
            "Default": 32,
            "MinValue": 16,
            "MaxValue": 64,
            "Description": "Length for dynamically generated secrets"
        },
        "PlatformName": {
            "Type": "String",
            "Default": "cloudformation",
            "AllowedValues": [
                "cloudformation"
            ],
            "Description": "Helper value for external platform validation scripts."
        },
        "EnableEC2": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false",
            "Description": "Toggle to create a minimal sample EC2 instance in default VPC"
        },
        "EC2KeyPairName": {
            "Type": "String",
            "Default": "",
            "Description": "(Optional) EC2 KeyPair name for the sample instance (empty to skip SSH key association)",
            "AllowedPattern": "^$|^[a-zA-Z0-9._-]+$"
        },
        "EC2AmiId": {
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Default": "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64",
            "Description": "SSM path for Amazon Linux 2023 AMI (x86_64)"
        },
        "EnableRDS": {
            "Type": "String",
            "AllowedValues": [
                "true",
                "false"
            ],
            "Default": "false",
            "Description": "Toggle to create optional sample RDS resources"
        },
        "DBSubnetIdA": {
            "Type": "String",
            "Default": "",
            "Description": "(Optional) Private subnet A for RDS"
        },
        "DBSubnetIdB": {
            "Type": "String",
            "Default": "",
            "Description": "(Optional) Private subnet B for RDS"
        },
        "DBVpcSecurityGroupId": {
            "Type": "String",
            "Default": "",
            "Description": "(Optional) VPC security group ID for RDS instance"
        }
    },
    "Conditions": {
        "IsApprovedRegion": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "us-east-1"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "us-west-2"
                    ]
                }
            ]
        },
        "HasKeyPair": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EC2KeyPairName"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasDBA": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DBSubnetIdA"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasDBB": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DBSubnetIdB"
                        },
                        ""
                    ]
                }
            ]
        },
        "HasDBSG": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "DBVpcSecurityGroupId"
                        },
                        ""
                    ]
                }
            ]
        },
        "CreateEC2": {
            "Fn::And": [
                {
                    "Condition": "IsApprovedRegion"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableEC2"
                        },
                        "true"
                    ]
                }
            ]
        },
        "CreateRDS": {
            "Fn::And": [
                {
                    "Condition": "IsApprovedRegion"
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "EnableRDS"
                        },
                        "true"
                    ]
                },
                {
                    "Condition": "HasDBA"
                },
                {
                    "Condition": "HasDBB"
                },
                {
                    "Condition": "HasDBSG"
                }
            ]
        }
    },
    "Metadata": {
        "Compliance": {
            "Owner": "Security",
            "Classification": "Confidential",
            "Controls": "CIS-1.1, CIS-3.1, CIS-3.2, CIS-3.4, CIS-4.1"
        },
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Validation / Platform"
                    },
                    "Parameters": [
                        "PlatformName"
                    ]
                },
                {
                    "Label": {
                        "default": "Optional EC2 Sample (default VPC)"
                    },
                    "Parameters": [
                        "EnableEC2",
                        "EC2KeyPairName",
                        "EC2AmiId"
                    ]
                },
                {
                    "Label": {
                        "default": "Optional RDS Sample (requires VPC)"
                    },
                    "Parameters": [
                        "EnableRDS",
                        "DBSubnetIdA",
                        "DBSubnetIdB",
                        "DBVpcSecurityGroupId"
                    ]
                }
            ]
        }
    },
    "Resources": {
        "RDSEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "BypassPolicyLockoutSafetyCheck": true,
                "Description": {
                    "Fn::Sub": "CMK for RDS encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "PendingWindowInDays": 7,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableRootPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "DenyCriticalWithoutMFA",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "kms:PutKeyPolicy",
                                "kms:ScheduleKeyDeletion",
                                "kms:DisableKey",
                                "kms:DeleteAlias",
                                "kms:DeleteImportedKeyMaterial",
                                "kms:RevokeGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "aws:MultiFactorAuthPresent": false
                                }
                            }
                        },
                        {
                            "Sid": "AllowKeyUseWithinAccount",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowCloudWatchLogsUse",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": {
                                    "Fn::Sub": "logs.${AWS::Region}.amazonaws.com"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:Describe*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "ArnLike": {
                                    "kms:EncryptionContext:aws:logs:arn": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "RDS-Encryption"
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "S3EncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "BypassPolicyLockoutSafetyCheck": true,
                "Description": {
                    "Fn::Sub": "CMK for S3 encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "PendingWindowInDays": 7,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableRootPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "DenyCriticalWithoutMFA",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "kms:PutKeyPolicy",
                                "kms:ScheduleKeyDeletion",
                                "kms:DisableKey",
                                "kms:DeleteAlias",
                                "kms:DeleteImportedKeyMaterial",
                                "kms:RevokeGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "aws:MultiFactorAuthPresent": false
                                }
                            }
                        },
                        {
                            "Sid": "AllowKeyUseWithinAccount",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowAWSConfigServiceUseOfKey",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowConfigDeliveryRoleUseOfKey",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::GetAtt": [
                                        "ConfigDeliveryRole",
                                        "Arn"
                                    ]
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "S3-Encryption"
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "EBSEncryptionKey": {
            "Type": "AWS::KMS::Key",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "BypassPolicyLockoutSafetyCheck": true,
                "Description": {
                    "Fn::Sub": "CMK for EBS encryption - ${EnvironmentSuffix}"
                },
                "EnableKeyRotation": true,
                "PendingWindowInDays": 7,
                "KeyPolicy": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "EnableRootPermissions",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "kms:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "DenyCriticalWithoutMFA",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": [
                                "kms:PutKeyPolicy",
                                "kms:ScheduleKeyDeletion",
                                "kms:DisableKey",
                                "kms:DeleteAlias",
                                "kms:DeleteImportedKeyMaterial",
                                "kms:RevokeGrant"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "Bool": {
                                    "aws:MultiFactorAuthPresent": false
                                }
                            }
                        },
                        {
                            "Sid": "AllowKeyUseWithinAccount",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        },
                        {
                            "Sid": "AllowEC2Use",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": [
                                "kms:Encrypt",
                                "kms:Decrypt",
                                "kms:ReEncrypt*",
                                "kms:GenerateDataKey*",
                                "kms:DescribeKey"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Purpose",
                        "Value": "EBS-Encryption"
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "EC2InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "ec2-instance-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "EC2InstancePolicy": {
            "Type": "AWS::IAM::Policy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "ec2-least-privilege-${EnvironmentSuffix}"
                },
                "Roles": [
                    {
                        "Ref": "EC2InstanceRole"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowSSMParameterAccess",
                            "Effect": "Allow",
                            "Action": [
                                "ssm:GetParameter",
                                "ssm:GetParameters"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvironmentSuffix}/*"
                            }
                        },
                        {
                            "Sid": "DenySensitiveIAMActions",
                            "Effect": "Deny",
                            "Action": [
                                "iam:CreateUser",
                                "iam:DeleteUser",
                                "iam:CreateAccessKey"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:user/*"
                            }
                        },
                        {
                            "Sid": "DenyKMSScheduleDeletion",
                            "Effect": "Deny",
                            "Action": "kms:ScheduleKeyDeletion",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "RDSEncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "S3EncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "EBSEncryptionKey",
                                        "Arn"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "lambda-execution-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "LambdaExecutionPolicy": {
            "Type": "AWS::IAM::Policy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "lambda-least-privilege-${EnvironmentSuffix}"
                },
                "Roles": [
                    {
                        "Ref": "LambdaExecutionRole"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowBasicLogging",
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${EnvironmentSuffix}*:*"
                            }
                        },
                        {
                            "Sid": "DenyIAMPassRole",
                            "Effect": "Deny",
                            "Action": "iam:PassRole",
                            "Resource": {
                                "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/*"
                            }
                        },
                        {
                            "Sid": "DenyKMSDecryptForAppKeys",
                            "Effect": "Deny",
                            "Action": "kms:Decrypt",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "RDSEncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "S3EncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "EBSEncryptionKey",
                                        "Arn"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "ECSTaskExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "ecs-task-execution-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "ECSTaskExecutionPolicy": {
            "Type": "AWS::IAM::Policy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "ecs-task-execution-policy-${EnvironmentSuffix}"
                },
                "Roles": [
                    {
                        "Ref": "ECSTaskExecutionRole"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowECRActions",
                            "Effect": "Allow",
                            "Action": [
                                "ecr:GetAuthorizationToken",
                                "ecr:BatchCheckLayerAvailability",
                                "ecr:GetDownloadUrlForLayer",
                                "ecr:BatchGetImage"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/${EnvironmentSuffix}/*"
                            }
                        },
                        {
                            "Sid": "AllowCloudWatchLogs",
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ecs/${EnvironmentSuffix}*:*"
                            }
                        },
                        {
                            "Sid": "DenyIAMPassRole",
                            "Effect": "Deny",
                            "Action": "iam:PassRole",
                            "Resource": {
                                "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/*"
                            }
                        },
                        {
                            "Sid": "DenyKMSScheduleDeletion",
                            "Effect": "Deny",
                            "Action": "kms:ScheduleKeyDeletion",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "RDSEncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "S3EncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "EBSEncryptionKey",
                                        "Arn"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "DeveloperPermissionBoundary": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "ManagedPolicyName": {
                    "Fn::Sub": "developer-boundary-${EnvironmentSuffix}"
                },
                "Description": "Boundary restricting non-admin roles",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyIAMAdministration",
                            "Effect": "Deny",
                            "Action": "iam:*",
                            "Resource": {
                                "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:*"
                            }
                        },
                        {
                            "Sid": "DenyOrganizations",
                            "Effect": "Deny",
                            "Action": "organizations:*",
                            "Resource": "*"
                        },
                        {
                            "Sid": "DenyNonApprovedRegionsExceptReadOnlyCFN",
                            "Effect": "Deny",
                            "NotAction": [
                                "cloudformation:Describe*",
                                "cloudformation:Get*",
                                "cloudformation:List*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringNotEquals": {
                                    "aws:RequestedRegion": [
                                        "us-east-1",
                                        "us-west-2"
                                    ]
                                }
                            }
                        },
                        {
                            "Sid": "DenyKMSScheduleDeletion",
                            "Effect": "Deny",
                            "Action": "kms:ScheduleKeyDeletion",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "RDSEncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "S3EncryptionKey",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::GetAtt": [
                                        "EBSEncryptionKey",
                                        "Arn"
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "DeveloperRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "developer-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                }
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "PermissionsBoundary": {
                    "Ref": "DeveloperPermissionBoundary"
                },
                "ManagedPolicyArns": [],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "CrossAccountAssumeRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "cross-account-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCrossAccountAssume",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Ref": "ApprovedAccountId"
                                }
                            },
                            "Action": "sts:AssumeRole",
                            "Condition": {
                                "StringEquals": {
                                    "sts:ExternalId": {
                                        "Ref": "ThirdPartyExternalId"
                                    }
                                }
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "CrossAccountAssumePolicy": {
            "Type": "AWS::IAM::Policy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "PolicyName": {
                    "Fn::Sub": "cross-account-assume-policy-${EnvironmentSuffix}"
                },
                "Roles": [
                    {
                        "Ref": "CrossAccountAssumeRole"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowReadOnlyAccessS3",
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "SecureS3Bucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureS3Bucket.Arn}/*"
                                }
                            ]
                        },
                        {
                            "Sid": "AllowReadOnlyAccessLogs",
                            "Effect": "Allow",
                            "Action": [
                                "logs:FilterLogEvents"
                            ],
                            "Resource": {
                                "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/audit/${EnvironmentSuffix}:*"
                            }
                        },
                        {
                            "Sid": "AllowReadOnlyAccessCloudWatch",
                            "Effect": "Allow",
                            "Action": [
                                "cloudwatch:GetMetricData"
                            ],
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "SecureS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "aws:kms",
                                "KMSMasterKeyID": {
                                    "Ref": "S3EncryptionKey"
                                }
                            }
                        }
                    ]
                },
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "S3BucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Bucket": {
                    "Ref": "SecureS3Bucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowConfigDelivery",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${SecureS3Bucket.Arn}/AWSLogs/${AWS::AccountId}/Config/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "AllowConfigBucketAccess",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "SecureS3Bucket",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Sid": "EnforceSSL",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "SecureS3Bucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Sub": "${SecureS3Bucket.Arn}/*"
                                }
                            ],
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        },
                        {
                            "Sid": "DenyUnencryptedUploads",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${SecureS3Bucket.Arn}/*"
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "aws:kms"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "DatabaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Name": {
                    "Fn::Sub": "database-credentials-${EnvironmentSuffix}"
                },
                "Description": "Database credentials with automatic rotation",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"username\":\"db_admin\"}",
                    "GenerateStringKey": "password",
                    "PasswordLength": {
                        "Ref": "SecretLength"
                    },
                    "ExcludeCharacters": "\"@/\\\\"
                },
                "KmsKeyId": {
                    "Ref": "RDSEncryptionKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "SecretRotationRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "SecretsManagerAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:DescribeSecret",
                                        "secretsmanager:GetSecretValue",
                                        "secretsmanager:PutSecretValue",
                                        "secretsmanager:UpdateSecretVersionStage"
                                    ],
                                    "Resource": {
                                        "Ref": "DatabaseSecret"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "secretsmanager:GetRandomPassword",
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "SecretRotationFunction": {
            "Type": "AWS::Lambda::Function",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "secret-rotation-${EnvironmentSuffix}"
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "SecretRotationRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.12",
                "Timeout": 60,
                "Code": {
                    "ZipFile": "import json, boto3, random, string\ndef handler(event, context):\n    sm = boto3.client('secretsmanager')\n    sid = event['SecretId']; crt = event['ClientRequestToken']; step = event['Step']\n    if step == 'createSecret':\n        v = sm.describe_secret(SecretId=sid).get('VersionIdsToStages', {})\n        if any('AWSPENDING' in stages for stages in v.values()): return\n        pw = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(32))\n        sm.put_secret_value(SecretId=sid, ClientRequestToken=crt,\n                            SecretString=json.dumps({'username':'db_admin','password':pw}),\n                            VersionStages=['AWSPENDING'])\n    elif step == 'setSecret':\n        pass\n    elif step == 'testSecret':\n        pass\n    elif step == 'finishSecret':\n        v = sm.describe_secret(SecretId=sid)['VersionIdsToStages']\n        cur = next((vid for vid, st in v.items() if 'AWSCURRENT' in st), None)\n        sm.update_secret_version_stage(SecretId=sid, VersionStage='AWSCURRENT',\n                                       MoveToVersionId=crt, RemoveFromVersionId=cur)\n"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "SecretRotationLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Fn::GetAtt": [
                        "SecretRotationFunction",
                        "Arn"
                    ]
                },
                "Principal": "secretsmanager.amazonaws.com",
                "SourceArn": {
                    "Ref": "DatabaseSecret"
                }
            }
        },
        "DatabaseSecretRotation": {
            "Type": "AWS::SecretsManager::RotationSchedule",
            "Condition": "IsApprovedRegion",
            "DependsOn": "SecretRotationLambdaPermission",
            "Properties": {
                "SecretId": {
                    "Ref": "DatabaseSecret"
                },
                "RotationLambdaARN": {
                    "Fn::GetAtt": [
                        "SecretRotationFunction",
                        "Arn"
                    ]
                },
                "RotationRules": {
                    "AutomaticallyAfterDays": 30
                }
            }
        },
        "ApplicationSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Name": {
                    "Fn::Sub": "application-secret-${EnvironmentSuffix}"
                },
                "Description": "Application secrets stored securely",
                "GenerateSecretString": {
                    "SecretStringTemplate": "{\"app_key\":\"base64\"}",
                    "GenerateStringKey": "secret",
                    "PasswordLength": {
                        "Ref": "SecretLength"
                    },
                    "ExcludeCharacters": "\"@/\\\\"
                },
                "KmsKeyId": {
                    "Ref": "RDSEncryptionKey"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "DBPasswordParameter": {
            "Type": "AWS::SSM::Parameter",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/${EnvironmentSuffix}/db/password"
                },
                "Type": "String",
                "Value": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}::password}}"
                },
                "Tags": {
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    },
                    "Compliance": "Security-Baseline"
                }
            }
        },
        "AppSecretParameter": {
            "Type": "AWS::SSM::Parameter",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Name": {
                    "Fn::Sub": "/${EnvironmentSuffix}/app/secret"
                },
                "Type": "String",
                "Value": {
                    "Fn::Sub": "{{resolve:secretsmanager:${ApplicationSecret}::secret}}"
                },
                "Tags": {
                    "Environment": {
                        "Ref": "EnvironmentSuffix"
                    },
                    "Compliance": "Security-Baseline"
                }
            }
        },
        "AuditLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/audit/${EnvironmentSuffix}"
                },
                "RetentionInDays": 365,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "RDSEncryptionKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "ApplicationLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/application/${EnvironmentSuffix}"
                },
                "RetentionInDays": 365,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "RDSEncryptionKey",
                        "Arn"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "ConfigDeliveryRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "config-delivery-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "config.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWS_ConfigRole"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "ConfigBootstrapRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": "config-bootstrap-role-${EnvironmentSuffix}"
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "ConfigBootstrapPermissions",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "config:PutConfigurationRecorder",
                                        "config:DescribeConfigurationRecorders",
                                        "config:DescribeConfigurationRecorderStatus",
                                        "config:DeleteConfigurationRecorder",
                                        "config:PutDeliveryChannel",
                                        "config:DescribeDeliveryChannels",
                                        "config:DescribeDeliveryChannelStatus",
                                        "config:DeleteDeliveryChannel",
                                        "config:StartConfigurationRecorder",
                                        "config:StopConfigurationRecorder"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "iam:PassRole",
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "ConfigDeliveryRole",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "ConfigBootstrapFunction": {
            "Type": "AWS::Lambda::Function",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "config-bootstrap-${EnvironmentSuffix}"
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "ConfigBootstrapRole",
                        "Arn"
                    ]
                },
                "Runtime": "python3.12",
                "Timeout": 120,
                "Code": {
                    "ZipFile": "import json, boto3, urllib.request, traceback, time\ndef send_response(event, context, status, data, reason=None, physical_resource_id=None):\n    response_url = event['ResponseURL']\n    body = {\n        'Status': status,\n        'Reason': reason or f'See CloudWatch Log Stream: {context.log_stream_name}',\n        'PhysicalResourceId': physical_resource_id or context.log_stream_name,\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'Data': data or {}\n    }\n    req = urllib.request.Request(response_url, data=json.dumps(body).encode('utf-8'), method='PUT')\n    req.add_header('content-type', '')\n    urllib.request.urlopen(req)\ndef handler(event, context):\n    cfg = boto3.client('config')\n    props = event.get('ResourceProperties', {})\n    desired_recorder_name = f\"tapstack-recorder-{props.get('EnvironmentSuffix','env')}\"\n    desired_channel_name  = f\"tapstack-channel-{props.get('EnvironmentSuffix','env')}\"\n    role_arn    = props['RoleArn']\n    bucket_name = props['BucketName']\n    kms_arn     = props['S3KmsKeyArn']\n    try:\n        req_type = event['RequestType']\n        if req_type in ('Create', 'Update'):\n            recs = cfg.describe_configuration_recorders().get('ConfigurationRecorders', [])\n            chans = cfg.describe_delivery_channels().get('DeliveryChannels', [])\n            recorder_name = (recs[0]['name'] if recs else desired_recorder_name)\n            channel_name  = (chans[0]['name'] if chans else desired_channel_name)\n            cfg.put_configuration_recorder(\n                ConfigurationRecorder={\n                    'name': recorder_name,\n                    'roleARN': role_arn,\n                    'recordingGroup': {\n                        'allSupported': True,\n                        'includeGlobalResourceTypes': False\n                    }\n                }\n            )\n            cfg.put_delivery_channel(\n                DeliveryChannel={\n                    'name': channel_name,\n                    's3BucketName': bucket_name,\n                    's3KmsKeyArn': kms_arn\n                }\n            )\n            for _ in range(6):\n                try:\n                    cfg.start_configuration_recorder(ConfigurationRecorderName=recorder_name)\n                    break\n                except Exception:\n                    time.sleep(2)\n            send_response(event, context, 'SUCCESS',\n                          {'RecorderName': recorder_name, 'ChannelName': channel_name},\n                          physical_resource_id=recorder_name)\n        elif req_type == 'Delete':\n            try:\n                recs = cfg.describe_configuration_recorders().get('ConfigurationRecorders', [])\n                if recs:\n                    cfg.stop_configuration_recorder(ConfigurationRecorderName=recs[0]['name'])\n            except Exception:\n                pass\n            try:\n                chans = cfg.describe_delivery_channels().get('DeliveryChannels', [])\n                if chans:\n                    cfg.delete_delivery_channel(DeliveryChannelName=chans[0]['name'])\n            except Exception:\n                pass\n            try:\n                recs = cfg.describe_configuration_recorders().get('ConfigurationRecorders', [])\n                if recs:\n                    cfg.delete_configuration_recorder(ConfigurationRecorderName=recs[0]['name'])\n            except Exception:\n                pass\n            send_response(event, context, 'SUCCESS', {}, physical_resource_id='ConfigBootstrap-Cleanup')\n    except Exception as e:\n        reason = f\"{str(e)} | Trace: {traceback.format_exc()}\"\n        try:\n            send_response(event, context, 'FAILED', {}, reason=reason)\n        except Exception:\n            pass\n        raise\n"
                }
            }
        },
        "ConfigBootstrap": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Condition": "IsApprovedRegion",
            "DependsOn": [
                "S3BucketPolicy"
            ],
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "ConfigBootstrapFunction",
                        "Arn"
                    ]
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "ConfigDeliveryRole",
                        "Arn"
                    ]
                },
                "BucketName": {
                    "Ref": "SecureS3Bucket"
                },
                "S3KmsKeyArn": {
                    "Fn::GetAtt": [
                        "S3EncryptionKey",
                        "Arn"
                    ]
                },
                "EnvironmentSuffix": {
                    "Ref": "EnvironmentSuffix"
                }
            }
        },
        "S3BucketSSLConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "IsApprovedRegion",
            "DependsOn": "ConfigBootstrap",
            "Properties": {
                "Description": "Require SSL requests to S3 buckets",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "S3_BUCKET_SSL_REQUESTS_ONLY"
                },
                "Scope": {
                    "ComplianceResourceTypes": [
                        "AWS::S3::Bucket"
                    ]
                }
            }
        },
        "IAMPasswordPolicyConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "IsApprovedRegion",
            "DependsOn": "ConfigBootstrap",
            "Properties": {
                "Description": "Enforce secure IAM account password policy",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "IAM_PASSWORD_POLICY"
                }
            }
        },
        "EncryptedVolumesConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "IsApprovedRegion",
            "DependsOn": "ConfigBootstrap",
            "Properties": {
                "Description": "EBS volumes must be encrypted",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ENCRYPTED_VOLUMES"
                }
            }
        },
        "RootMFAConfigRule": {
            "Type": "AWS::Config::ConfigRule",
            "Condition": "IsApprovedRegion",
            "DependsOn": "ConfigBootstrap",
            "Properties": {
                "Description": "Root account must have MFA enabled",
                "Source": {
                    "Owner": "AWS",
                    "SourceIdentifier": "ROOT_ACCOUNT_MFA_ENABLED"
                }
            }
        },
        "RegionalRestrictionPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "ManagedPolicyName": {
                    "Fn::Sub": "regional-restriction-${EnvironmentSuffix}"
                },
                "Description": "Simulated regional guardrail (SCPs require Organizations)",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "DenyNonApprovedRegions",
                            "Effect": "Deny",
                            "NotAction": [
                                "cloudformation:Describe*",
                                "cloudformation:Get*",
                                "cloudformation:List*",
                                "cloudwatch:Describe*",
                                "cloudwatch:Get*",
                                "cloudwatch:List*"
                            ],
                            "Resource": "*",
                            "Condition": {
                                "StringNotEquals": {
                                    "aws:RequestedRegion": [
                                        "us-east-1",
                                        "us-west-2"
                                    ]
                                }
                            }
                        },
                        {
                            "Sid": "RestrictRootActions",
                            "Effect": "Deny",
                            "Action": "*",
                            "Resource": "*",
                            "Condition": {
                                "StringEquals": {
                                    "aws:PrincipalARN": {
                                        "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "SampleEBSVolume": {
            "Type": "AWS::EC2::Volume",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "AvailabilityZone": {
                    "Fn::Sub": "${AWS::Region}a"
                },
                "Size": 8,
                "Encrypted": true,
                "KmsKeyId": {
                    "Fn::GetAtt": [
                        "EBSEncryptionKey",
                        "Arn"
                    ]
                },
                "VolumeType": "gp3",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sample-ebs-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "EC2InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Condition": "CreateEC2",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "EC2InstanceRole"
                    }
                ],
                "InstanceProfileName": {
                    "Fn::Sub": "ec2-instance-profile-${EnvironmentSuffix}"
                }
            }
        },
        "SampleEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Condition": "CreateEC2",
            "Properties": {
                "IamInstanceProfile": {
                    "Ref": "EC2InstanceProfile"
                },
                "ImageId": {
                    "Ref": "EC2AmiId"
                },
                "InstanceType": "t3.micro",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/xvda",
                        "Ebs": {
                            "VolumeSize": 8,
                            "VolumeType": "gp3",
                            "Encrypted": true,
                            "KmsKeyId": {
                                "Fn::GetAtt": [
                                    "EBSEncryptionKey",
                                    "Arn"
                                ]
                            },
                            "DeleteOnTermination": true
                        }
                    }
                ],
                "KeyName": {
                    "Fn::If": [
                        "HasKeyPair",
                        {
                            "Ref": "EC2KeyPairName"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sample-ec2-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        },
        "SampleECSCluster": {
            "Type": "AWS::ECS::Cluster",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "ClusterName": {
                    "Fn::Sub": "sample-ecs-cluster-${EnvironmentSuffix}"
                },
                "CapacityProviders": [
                    "FARGATE",
                    "FARGATE_SPOT"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    }
                ]
            }
        },
        "SampleECSTaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Condition": "IsApprovedRegion",
            "Properties": {
                "Family": {
                    "Fn::Sub": "sample-task-${EnvironmentSuffix}"
                },
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "Cpu": "256",
                "Memory": "512",
                "NetworkMode": "awsvpc",
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "ECSTaskExecutionRole",
                        "Arn"
                    ]
                },
                "ContainerDefinitions": [
                    {
                        "Name": "hello",
                        "Image": "public.ecr.aws/amazonlinux/amazonlinux:2023",
                        "Command": [
                            "bash",
                            "-lc",
                            "echo hello-from-ecs; sleep 3600"
                        ],
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "ApplicationLogGroup"
                                },
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                },
                                "awslogs-stream-prefix": "ecs"
                            }
                        }
                    }
                ]
            }
        },
        "SampleDBSubnetGroup": {
            "Type": "AWS::RDS::DBSubnetGroup",
            "Condition": "CreateRDS",
            "Properties": {
                "DBSubnetGroupDescription": {
                    "Fn::Sub": "sample-rds-subnets-${EnvironmentSuffix}"
                },
                "SubnetIds": [
                    {
                        "Ref": "DBSubnetIdA"
                    },
                    {
                        "Ref": "DBSubnetIdB"
                    }
                ],
                "DBSubnetGroupName": {
                    "Fn::Sub": "sample-rds-${EnvironmentSuffix}"
                }
            }
        },
        "SampleRDSInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Condition": "CreateRDS",
            "DeletionPolicy": "Snapshot",
            "UpdateReplacePolicy": "Snapshot",
            "Properties": {
                "DBInstanceIdentifier": {
                    "Fn::Sub": "sample-rds-${EnvironmentSuffix}"
                },
                "Engine": "postgres",
                "EngineVersion": "16",
                "DBInstanceClass": "db.t4g.micro",
                "AllocatedStorage": 20,
                "StorageType": "gp3",
                "PubliclyAccessible": false,
                "MultiAZ": false,
                "StorageEncrypted": true,
                "KmsKeyId": {
                    "Ref": "RDSEncryptionKey"
                },
                "MasterUsername": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}::username}}"
                },
                "MasterUserPassword": {
                    "Fn::Sub": "{{resolve:secretsmanager:${DatabaseSecret}::password}}"
                },
                "DBSubnetGroupName": {
                    "Ref": "SampleDBSubnetGroup"
                },
                "VPCSecurityGroups": [
                    {
                        "Ref": "DBVpcSecurityGroupId"
                    }
                ],
                "DeletionProtection": false,
                "BackupRetentionPeriod": 7,
                "EnablePerformanceInsights": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Sub": "sample-rds-${EnvironmentSuffix}"
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "EnvironmentSuffix"
                        }
                    },
                    {
                        "Key": "Compliance",
                        "Value": "Security-Baseline"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "EC2InstanceRoleArn": {
            "Condition": "IsApprovedRegion",
            "Description": "ARN of the EC2 instance role",
            "Value": {
                "Fn::GetAtt": [
                    "EC2InstanceRole",
                    "Arn"
                ]
            }
        },
        "LambdaExecutionRoleArn": {
            "Condition": "IsApprovedRegion",
            "Description": "ARN of the Lambda execution role",
            "Value": {
                "Fn::GetAtt": [
                    "LambdaExecutionRole",
                    "Arn"
                ]
            }
        },
        "ECSTaskExecutionRoleArn": {
            "Condition": "IsApprovedRegion",
            "Description": "ARN of the ECS task execution role",
            "Value": {
                "Fn::GetAtt": [
                    "ECSTaskExecutionRole",
                    "Arn"
                ]
            }
        },
        "DeveloperPermissionBoundaryArn": {
            "Condition": "IsApprovedRegion",
            "Description": "ARN of the developer permission boundary",
            "Value": {
                "Ref": "DeveloperPermissionBoundary"
            }
        },
        "DeveloperRoleArn": {
            "Condition": "IsApprovedRegion",
            "Description": "Example developer role ARN (with boundary applied)",
            "Value": {
                "Fn::GetAtt": [
                    "DeveloperRole",
                    "Arn"
                ]
            }
        },
        "CrossAccountAssumeRoleArn": {
            "Condition": "IsApprovedRegion",
            "Description": "ARN for cross-account assume role",
            "Value": {
                "Fn::GetAtt": [
                    "CrossAccountAssumeRole",
                    "Arn"
                ]
            }
        },
        "RDSEncryptionKeyId": {
            "Condition": "IsApprovedRegion",
            "Description": "RDS KMS Key ID",
            "Value": {
                "Ref": "RDSEncryptionKey"
            }
        },
        "S3EncryptionKeyId": {
            "Condition": "IsApprovedRegion",
            "Description": "S3 KMS Key ID",
            "Value": {
                "Ref": "S3EncryptionKey"
            }
        },
        "EBSEncryptionKeyId": {
            "Condition": "IsApprovedRegion",
            "Description": "EBS KMS Key ID",
            "Value": {
                "Ref": "EBSEncryptionKey"
            }
        },
        "SecureS3BucketName": {
            "Condition": "IsApprovedRegion",
            "Description": "Name of the secure S3 bucket",
            "Value": {
                "Ref": "SecureS3Bucket"
            }
        },
        "PlatformNameOut": {
            "Description": "Helper output for platform validation (expected 'cloudformation')",
            "Value": {
                "Ref": "PlatformName"
            }
        },
        "SampleEBSVolumeId": {
            "Condition": "IsApprovedRegion",
            "Description": "ID of the sample encrypted EBS volume",
            "Value": {
                "Ref": "SampleEBSVolume"
            }
        },
        "SampleEC2InstanceId": {
            "Condition": "CreateEC2",
            "Description": "ID of the sample EC2 instance (created only when enabled)",
            "Value": {
                "Ref": "SampleEC2Instance"
            }
        },
        "SampleECSClusterName": {
            "Condition": "IsApprovedRegion",
            "Description": "Name of the sample ECS Cluster",
            "Value": {
                "Ref": "SampleECSCluster"
            }
        },
        "SampleECSTaskFamily": {
            "Condition": "IsApprovedRegion",
            "Description": "ECS TaskDefinition family name",
            "Value": {
                "Ref": "SampleECSTaskDefinition"
            }
        },
        "SampleRDSInstanceEndpoint": {
            "Condition": "CreateRDS",
            "Description": "RDS instance endpoint address",
            "Value": {
                "Fn::GetAtt": [
                    "SampleRDSInstance",
                    "Endpoint.Address"
                ]
            }
        }
    }
}
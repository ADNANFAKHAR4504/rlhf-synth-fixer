{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "CloudFormation template for a serverless web application with API Gateway, Lambda, and S3 logging",
    "Parameters": {
        "ProjectName": {
            "Type": "String",
            "Description": "Name of the project",
            "Default": "ServerlessWebApp"
        },
        "CostCenter": {
            "Type": "String",
            "Description": "Cost center for billing purposes",
            "Default": "IT-12345"
        },
        "Environment": {
            "Type": "String",
            "Description": "Deployment environment",
            "Default": "Production",
            "AllowedValues": [
                "Production",
                "Staging",
                "Development"
            ]
        },
        "LogRetentionInDays": {
            "Type": "Number",
            "Description": "Number of days to retain logs in CloudWatch",
            "Default": 30,
            "AllowedValues": [
                1,
                3,
                5,
                7,
                14,
                30,
                60,
                90,
                120,
                150,
                180,
                365,
                400,
                545,
                731,
                1827,
                3653
            ]
        },
        "DeploymentRegion": {
            "Type": "String",
            "Description": "AWS region where resources will be deployed",
            "Default": "us-west-2",
            "AllowedValues": [
                "us-west-2"
            ],
            "ConstraintDescription": "This template can only be deployed in us-west-2 region"
        }
    },
    "Resources": {
        "LogBucket": {
            "Type": "AWS::S3::Bucket",
            "DeletionPolicy": "Delete",
            "Properties": {
                "BucketName": {
                    "Fn::Sub": "${AWS::AccountId}-${ProjectName}-logs-${AWS::Region}-${Environment}"
                },
                "AccessControl": "LogDeliveryWrite",
                "PublicAccessBlockConfiguration": {
                    "BlockPublicAcls": true,
                    "BlockPublicPolicy": true,
                    "IgnorePublicAcls": true,
                    "RestrictPublicBuckets": true
                },
                "LifecycleConfiguration": {
                    "Rules": [
                        {
                            "Id": "LogRetention",
                            "Status": "Enabled",
                            "ExpirationInDays": 365
                        }
                    ]
                },
                "BucketEncryption": {
                    "ServerSideEncryptionConfiguration": [
                        {
                            "ServerSideEncryptionByDefault": {
                                "SSEAlgorithm": "AES256"
                            }
                        }
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LogBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "LogBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AllowCloudWatchLogsToWriteToS3",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${LogBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        },
                        {
                            "Sid": "AllowAPIGatewayToWriteToS3",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "apigateway.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Sub": "${LogBucket.Arn}/*"
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "HelloWorldFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ProjectName}-HelloWorldFunction-${Environment}"
                },
                "Runtime": "nodejs18.x",
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Code": {
                    "ZipFile": "exports.handler = async (event) => {\n  console.log('Received event:', JSON.stringify(event, null, 2));\n  \n  return {\n    statusCode: 200,\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      message: 'Hello World!'\n    })\n  };\n};\n"
                },
                "Description": "Lambda function that returns a Hello World message",
                "Timeout": 10,
                "MemorySize": 128,
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "HelloWorldFunctionLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/lambda/${HelloWorldFunction}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionInDays"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LambdaLogToS3SubscriptionFilter": {
            "Type": "AWS::Logs::SubscriptionFilter",
            "DependsOn": [
                "LogBucketPolicy",
                "HelloWorldFunctionLogGroup"
            ],
            "Properties": {
                "LogGroupName": {
                    "Ref": "HelloWorldFunctionLogGroup"
                },
                "FilterPattern": "",
                "DestinationArn": {
                    "Fn::GetAtt": [
                        "LogsToS3DeliveryStream",
                        "Arn"
                    ]
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "LogsToS3Role",
                        "Arn"
                    ]
                }
            }
        },
        "LogsToS3Role": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "logs.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "AllowPutRecordToFirehose",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "firehose:PutRecord",
                                        "firehose:PutRecordBatch"
                                    ],
                                    "Resource": {
                                        "Fn::GetAtt": [
                                            "LogsToS3DeliveryStream",
                                            "Arn"
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "FirehoseDeliveryRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "firehose.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "S3DeliveryPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:AbortMultipartUpload",
                                        "s3:GetBucketLocation",
                                        "s3:GetObject",
                                        "s3:ListBucket",
                                        "s3:ListBucketMultipartUploads",
                                        "s3:PutObject"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "LogBucket",
                                                "Arn"
                                            ]
                                        },
                                        {
                                            "Fn::Sub": "${LogBucket.Arn}/*"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "LogsToS3DeliveryStream": {
            "Type": "AWS::KinesisFirehose::DeliveryStream",
            "Properties": {
                "DeliveryStreamName": {
                    "Fn::Sub": "${ProjectName}-LogsToS3-${Environment}"
                },
                "DeliveryStreamType": "DirectPut",
                "S3DestinationConfiguration": {
                    "BucketARN": {
                        "Fn::GetAtt": [
                            "LogBucket",
                            "Arn"
                        ]
                    },
                    "BufferingHints": {
                        "IntervalInSeconds": 60,
                        "SizeInMBs": 5
                    },
                    "CompressionFormat": "GZIP",
                    "Prefix": "lambda-logs/",
                    "RoleARN": {
                        "Fn::GetAtt": [
                            "FirehoseDeliveryRole",
                            "Arn"
                        ]
                    }
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiGatewayCloudWatchRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "apigateway.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiGatewayAccount": {
            "Type": "AWS::ApiGateway::Account",
            "Properties": {
                "CloudWatchRoleArn": {
                    "Fn::GetAtt": [
                        "ApiGatewayCloudWatchRole",
                        "Arn"
                    ]
                }
            }
        },
        "ApiGateway": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${ProjectName}-API-${Environment}"
                },
                "Description": "API Gateway for serverless web application",
                "EndpointConfiguration": {
                    "Types": [
                        "REGIONAL"
                    ]
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiGatewayRootMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "ApiGateway"
                },
                "ResourceId": {
                    "Fn::GetAtt": [
                        "ApiGateway",
                        "RootResourceId"
                    ]
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "POST",
                    "Uri": {
                        "Fn::Sub": "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HelloWorldFunction.Arn}/invocations"
                    }
                }
            }
        },
        "ApiGatewayDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": "ApiGatewayRootMethod",
            "Properties": {
                "RestApiId": {
                    "Ref": "ApiGateway"
                },
                "Description": "Deployment for the serverless web application"
            }
        },
        "ApiGatewayStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "RestApiId": {
                    "Ref": "ApiGateway"
                },
                "DeploymentId": {
                    "Ref": "ApiGatewayDeployment"
                },
                "StageName": {
                    "Ref": "Environment"
                },
                "AccessLogSetting": {
                    "DestinationArn": {
                        "Fn::GetAtt": [
                            "ApiGatewayLogGroup",
                            "Arn"
                        ]
                    },
                    "Format": "{\"requestId\":\"$context.requestId\", \"ip\":\"$context.identity.sourceIp\", \"requestTime\":\"$context.requestTime\", \"httpMethod\":\"$context.httpMethod\", \"routeKey\":\"$context.routeKey\", \"status\":\"$context.status\", \"protocol\":\"$context.protocol\", \"responseLength\":\"$context.responseLength\", \"userAgent\":\"$context.identity.userAgent\"}"
                },
                "MethodSettings": [
                    {
                        "ResourcePath": "/*",
                        "HttpMethod": "*",
                        "LoggingLevel": "INFO",
                        "DataTraceEnabled": true,
                        "MetricsEnabled": true
                    }
                ],
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiGatewayLogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Sub": "/aws/apigateway/${ApiGateway}/${Environment}"
                },
                "RetentionInDays": {
                    "Ref": "LogRetentionInDays"
                },
                "Tags": [
                    {
                        "Key": "Environment",
                        "Value": {
                            "Ref": "Environment"
                        }
                    },
                    {
                        "Key": "ProjectName",
                        "Value": {
                            "Ref": "ProjectName"
                        }
                    },
                    {
                        "Key": "CostCenter",
                        "Value": {
                            "Ref": "CostCenter"
                        }
                    }
                ]
            }
        },
        "ApiGatewayLogToS3SubscriptionFilter": {
            "Type": "AWS::Logs::SubscriptionFilter",
            "DependsOn": [
                "LogBucketPolicy",
                "ApiGatewayLogGroup"
            ],
            "Properties": {
                "LogGroupName": {
                    "Ref": "ApiGatewayLogGroup"
                },
                "FilterPattern": "",
                "DestinationArn": {
                    "Fn::GetAtt": [
                        "LogsToS3DeliveryStream",
                        "Arn"
                    ]
                },
                "RoleArn": {
                    "Fn::GetAtt": [
                        "LogsToS3Role",
                        "Arn"
                    ]
                }
            }
        },
        "LambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "HelloWorldFunction"
                },
                "Principal": "apigateway.amazonaws.com",
                "SourceArn": {
                    "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*/*"
                }
            }
        }
    },
    "Outputs": {
        "ApiGatewayEndpoint": {
            "Description": "URL of the API Gateway endpoint",
            "Value": {
                "Fn::Sub": "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
            }
        },
        "LambdaFunction": {
            "Description": "ARN of the Lambda function",
            "Value": {
                "Fn::GetAtt": [
                    "HelloWorldFunction",
                    "Arn"
                ]
            }
        },
        "LogBucketName": {
            "Description": "Name of the S3 bucket for logs",
            "Value": {
                "Ref": "LogBucket"
            }
        }
    }
}
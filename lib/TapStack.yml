AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure AWS VPC, S3, and IAM Access with Environment-Based Tagging in us-east-1'

Parameters:
  Environment:
    Type: String
    Description: Deployment environment (dev/stage/prod)
    AllowedValues: [dev, stage, prod]
    Default: dev
  ProjectName:
    Type: String
    Description: Project name for resource naming
    Default: myproject

Resources:
  # 1. Create the IAM Group that will be allowed to assume the role
  S3ReadAccessGroup:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub ${ProjectName}-s3-read-group

  # 2. VPC Configuration
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-vpc
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # 3. S3 Bucket with Security
  ProjectBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ProjectName}-storage
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-storage
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

  # 4. IAM Role for S3 Read Access (uses the created group)
  S3ReadRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-s3-read-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !GetAtt S3ReadAccessGroup.Arn
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${ProjectName}-s3-read-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt ProjectBucket.Arn
                  - !Sub ${ProjectBucket.Arn}/*
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-s3-read-role
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  VPCId:
    Description: ID of the created VPC
    Value: !Ref VPC
  BucketName:
    Description: Name of the created S3 bucket
    Value: !Ref ProjectBucket
  S3ReadRoleARN:
    Description: ARN of the S3 read-only IAM role
    Value: !GetAtt S3ReadRole.Arn
  S3AccessGroupName:
    Description: Name of the IAM Group with S3 read access
    Value: !Ref S3ReadAccessGroup
AWSTemplateFormatVersion: '2010-09-09'
Description: 'TapStack - Comprehensive AWS Security Infrastructure Template (error-free, hardened)'

# ========================
# Parameters
# ========================
Parameters:
  Environment:
    Type: String
    Default: 'production'
    AllowedValues: ['development', 'staging', 'production']
    Description: 'Environment type for resource naming and configuration'

  VPCCidrWest:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'CIDR block for VPC in us-west-2'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  VPNTunnelCIDR:
    Type: String
    Default: '192.168.100.0/24'
    Description: 'CIDR block for IPSec VPN tunnel access'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  DBMasterUsername:
    Type: String
    Default: 'dbadmin'
    Description: 'Master username for RDS instance'
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9]*$'

  # NOTE: Make cross-account role creation optional to avoid deployment failures.
  # Provide either an AWS account root ARN like arn:aws:iam::111122223333:root OR a specific role ARN,
  # or leave blank to skip creating the cross-account role entirely.
  CrossAccountPrincipal:
    Type: String
    Default: ''
    Description: '(Optional) External AWS principal allowed to assume the TapStack cross-account role (account root ARN or role ARN). Leave blank to skip.'
    AllowedPattern: '^$|^arn:aws:iam::[0-9]{12}:(root|role\/[a-zA-Z0-9+=,.@_\/-]+)$'

  UseExistingLogsBucket:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: 'Whether to use existing logs bucket or create a new one'

  EnableShieldAdvanced:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: 'Whether to create AWS Shield Advanced protection for the ALB (requires active subscription)'

# ========================
# Mappings
# ========================
Mappings:
  EnvironmentMap:
    development:
      InstanceType: 't3.micro'
      DBInstanceClass: 'db.t3.micro'
    staging:
      InstanceType: 't3.small'
      DBInstanceClass: 'db.t3.small'
    production:
      InstanceType: 't3.medium'
      DBInstanceClass: 'db.t3.medium'

# ========================
# Conditions
# ========================
Conditions:
  IsProduction: !Equals [!Ref Environment, 'production']
  CreateLogsBucket: !Equals [!Ref UseExistingLogsBucket, 'false']
  CreateCrossAccountRole: !Not [!Equals [!Ref CrossAccountPrincipal, '']]
  EnableShield: !Equals [!Ref EnableShieldAdvanced, 'true']

# ========================
# Resources
# ========================
Resources:
  # ---------- KMS Key ----------
  TapStackKMSKey:
    Type: 'AWS::KMS::Key'
    Properties:
      Description: 'KMS Key for TapStack encryption'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: 'Enable IAM User Permissions'
            Effect: 'Allow'
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: 'Allow CloudTrail to use the key'
            Effect: 'Allow'
            Principal:
              Service: 'cloudtrail.amazonaws.com'
            Action:
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
              - 'kms:Decrypt'
            Resource: '*'
          - Sid: 'Allow S3 Server-Side Encryption'
            Effect: 'Allow'
            Principal:
              Service: 's3.amazonaws.com'
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource: '*'
          - Sid: 'Allow CloudWatch Logs'
            Effect: 'Allow'
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource: '*'
          - Sid: 'Allow RDS Service'
            Effect: 'Allow'
            Principal:
              Service: 'rds.amazonaws.com'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource: '*'
          - Sid: 'Allow SecretsManager'
            Effect: 'Allow'
            Principal:
              Service: 'secretsmanager.amazonaws.com'
            Action:
              - 'kms:GenerateDataKey*'
              - 'kms:Decrypt'
              - 'kms:DescribeKey'
            Resource: '*'

  TapStackKMSKeyAlias:
    Type: 'AWS::KMS::Alias'
    Properties:
      AliasName: !Sub 'alias/tapstack-${Environment}'
      TargetKeyId: !Ref TapStackKMSKey

  # ---------- S3 Buckets ----------
  TapStackLogsBucket:
    Type: 'AWS::S3::Bucket'
    Condition: CreateLogsBucket
    Properties:
      BucketName: !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !Ref TapStackKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: 'DeleteOldLogs'
            Status: 'Enabled'
            ExpirationInDays: 90

  TapStackLogsBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'DenyPublicAccess'
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub
                - 'arn:aws:s3:::${LogsBucket}/*'
                - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
              - !Sub
                - 'arn:aws:s3:::${LogsBucket}'
                - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
            Condition:
              StringEquals:
                's3:x-amz-acl': ['public-read', 'public-read-write', 'authenticated-read']
          - Sid: 'DenyUnSecureCommunications'
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub
                - 'arn:aws:s3:::${LogsBucket}/*'
                - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
              - !Sub
                - 'arn:aws:s3:::${LogsBucket}'
                - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: 'AWSCloudTrailAclCheck'
            Effect: 'Allow'
            Principal:
              Service: 'cloudtrail.amazonaws.com'
            Action: 's3:GetBucketAcl'
            Resource: !Sub
              - 'arn:aws:s3:::${LogsBucket}'
              - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
            Condition:
              StringEquals:
                'aws:SourceArn': !Sub 'arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/TapStack-CloudTrail-${Environment}'
          - Sid: 'AWSCloudTrailWrite'
            Effect: 'Allow'
            Principal:
              Service: 'cloudtrail.amazonaws.com'
            Action: 's3:PutObject'
            Resource: !Sub
              - 'arn:aws:s3:::${LogsBucket}/cloudtrail-logs/AWSLogs/${AWS::AccountId}/*'
              - LogsBucket: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
            Condition:
              StringEquals:
                's3:x-amz-acl': 'bucket-owner-full-control'
                'aws:SourceArn': !Sub 'arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/TapStack-CloudTrail-${Environment}'

  TapStackSecureBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'tapstack-secure-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !Ref TapStackKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: 'Enabled'
      LoggingConfiguration:
        DestinationBucketName: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
        LogFilePrefix: 'access-logs/'

  TapStackSecureBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref TapStackSecureBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'DenyPublicAccess'
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub 'arn:aws:s3:::${TapStackSecureBucket}/*'
              - !Sub 'arn:aws:s3:::${TapStackSecureBucket}'
            Condition:
              StringEquals:
                's3:x-amz-acl': ['public-read', 'public-read-write', 'authenticated-read']
          - Sid: 'DenyUnSecureCommunications'
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub 'arn:aws:s3:::${TapStackSecureBucket}/*'
              - !Sub 'arn:aws:s3:::${TapStackSecureBucket}'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'

  # ---------- CloudTrail ----------
  TapStackCloudTrail:
    Type: 'AWS::CloudTrail::Trail'
    DependsOn: TapStackLogsBucketPolicy
    Properties:
      TrailName: !Sub 'TapStack-CloudTrail-${Environment}'
      S3BucketName: !If [CreateLogsBucket, !Ref TapStackLogsBucket, !Sub 'tapstack-logs-${Environment}-${AWS::AccountId}']
      S3KeyPrefix: 'cloudtrail-logs/'
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      KMSKeyId: !Ref TapStackKMSKey
      EventSelectors:
        - ReadWriteType: 'All'
          IncludeManagementEvents: true
          DataResources:
            - Type: 'AWS::S3::Object'
              Values:
                - !Sub 'arn:aws:s3:::${TapStackSecureBucket}/*'

  # ---------- CloudWatch Logs ----------
  S3LogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '/aws/s3/tapstack-${Environment}'
      RetentionInDays: 30
      KmsKeyId: !GetAtt TapStackKMSKey.Arn

  # ---------- Networking (VPC us-west-2) ----------
  VPCWest:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: !Ref VPCCidrWest
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-VPC-West-${Environment}'
        - Key: 'Environment'
          Value: !Ref Environment

  PublicSubnetWest1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPCWest
      CidrBlock: !Select [0, !Cidr [!Ref VPCCidrWest, 6, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Public-Subnet-West-1-${Environment}'

  PublicSubnetWest2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPCWest
      CidrBlock: !Select [1, !Cidr [!Ref VPCCidrWest, 6, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Public-Subnet-West-2-${Environment}'

  PrivateSubnetWest1:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPCWest
      CidrBlock: !Select [2, !Cidr [!Ref VPCCidrWest, 6, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Private-Subnet-West-1-${Environment}'

  PrivateSubnetWest2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPCWest
      CidrBlock: !Select [3, !Cidr [!Ref VPCCidrWest, 6, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Private-Subnet-West-2-${Environment}'

  InternetGatewayWest:
    Type: 'AWS::EC2::InternetGateway'
    Properties:
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-IGW-West-${Environment}'

  AttachGatewayWest:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPCWest
      InternetGatewayId: !Ref InternetGatewayWest

  EIPNATWest:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: 'vpc'

  NATGatewayWest:
    Type: 'AWS::EC2::NatGateway'
    Properties:
      AllocationId: !GetAtt EIPNATWest.AllocationId
      SubnetId: !Ref PublicSubnetWest1
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-NAT-West-${Environment}'

  PublicRouteTableWest:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPCWest
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Public-RT-West-${Environment}'

  PrivateRouteTableWest:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPCWest
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Private-RT-West-${Environment}'

  PublicRouteWest:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTableWest
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGatewayWest

  PrivateRouteWest:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PrivateRouteTableWest
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NATGatewayWest

  PublicSubnetRouteTableAssociationWest1:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetWest1
      RouteTableId: !Ref PublicRouteTableWest

  PublicSubnetRouteTableAssociationWest2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnetWest2
      RouteTableId: !Ref PublicRouteTableWest

  PrivateSubnetRouteTableAssociationWest1:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnetWest1
      RouteTableId: !Ref PrivateRouteTableWest

  PrivateSubnetRouteTableAssociationWest2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnetWest2
      RouteTableId: !Ref PrivateRouteTableWest

  # ---------- Security Groups ----------
  ALBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for Application Load Balancer'
      VpcId: !Ref VPCWest
      SecurityGroupIngress:
        - IpProtocol: 'tcp'
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'HTTP traffic'
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-ALB-SG-${Environment}'

  WebServerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for web servers'
      VpcId: !Ref VPCWest
      SecurityGroupIngress:
        - IpProtocol: 'tcp'
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: 'HTTP from ALB'
        - IpProtocol: 'tcp'
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VPNTunnelCIDR
          Description: 'SSH from VPN tunnel only'
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-WebServer-SG-${Environment}'

  DatabaseSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for RDS database'
      VpcId: !Ref VPCWest
      SecurityGroupIngress:
        - IpProtocol: 'tcp'
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: 'MySQL from web servers'
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Database-SG-${Environment}'

  # ---------- IAM (optional cross-account role) ----------
  CrossAccountAccessRole:
    Type: 'AWS::IAM::Role'
    Condition: CreateCrossAccountRole
    Properties:
      RoleName: !Sub 'TapStack-CrossAccount-Role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              AWS: !Ref CrossAccountPrincipal
            Action: 'sts:AssumeRole'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '3600'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/ReadOnlyAccess'
      Policies:
        - PolicyName: 'MinimalS3Access'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action: ['s3:GetObject', 's3:PutObject']
                Resource: !Sub 'arn:aws:s3:::${TapStackSecureBucket}/*'
              - Effect: 'Allow'
                Action: ['s3:ListBucket']
                Resource: !Sub 'arn:aws:s3:::${TapStackSecureBucket}'

  EC2InstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub 'TapStack-EC2-Role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'ec2.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Policies:
        - PolicyName: 'S3AccessPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action: ['s3:GetObject', 's3:PutObject']
                Resource: !Sub 'arn:aws:s3:::${TapStackSecureBucket}/*'

  EC2InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Roles: [!Ref EC2InstanceRole]

  RDSMonitoringRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub 'TapStack-RDS-Monitoring-Role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'monitoring.rds.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole'

  # ---------- Load Balancing & WAF ----------
  ApplicationLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: !Sub 'TapStack-ALB-${Environment}'
      Scheme: 'internet-facing'
      Type: 'application'
      SecurityGroups: [!Ref ALBSecurityGroup]
      Subnets: [!Ref PublicSubnetWest1, !Ref PublicSubnetWest2]
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-ALB-${Environment}'

  ALBTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      Name: !Sub 'TapStack-TG-${Environment}'
      Port: 80
      Protocol: 'HTTP'
      VpcId: !Ref VPCWest
      HealthCheckPath: '/health'
      HealthCheckProtocol: 'HTTP'
      HealthCheckIntervalSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetType: 'instance'

  ALBListenerHTTP:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: 'forward'
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: 'HTTP'

  WebACL:
    Type: 'AWS::WAFv2::WebACL'
    Properties:
      Name: !Sub 'TapStack-WAF-${Environment}'
      Scope: 'REGIONAL'
      DefaultAction:
        Allow: {}
      Rules:
        - Name: 'AWSManagedRulesCommonRuleSet'
          Priority: 1
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesCommonRuleSet'
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'CommonRuleSetMetric'
        - Name: 'AWSManagedRulesKnownBadInputsRuleSet'
          Priority: 2
          OverrideAction:
            None: {}
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesKnownBadInputsRuleSet'
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'KnownBadInputsRuleSetMetric'
        - Name: 'RateLimitRule'
          Priority: 3
          Action:
            Block: {}
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: 'IP'
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'RateLimitRuleMetric'
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub 'TapStack-WAF-${Environment}'

  WebACLAssociation:
    Type: 'AWS::WAFv2::WebACLAssociation'
    Properties:
      ResourceArn: !Ref ApplicationLoadBalancer
      WebACLArn: !GetAtt WebACL.Arn

  # ---------- RDS ----------
  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: 'Subnet group for RDS database'
      SubnetIds: [!Ref PrivateSubnetWest1, !Ref PrivateSubnetWest2]
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-DB-SubnetGroup-${Environment}'

  RDSSecret:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: !Sub 'TapStackDBSecret-${Environment}'
      Description: 'RDS database credentials for TapStack'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBMasterUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 16
        ExcludeCharacters: '"@/\\'
      KmsKeyId: !Ref TapStackKMSKey
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-DB-Secret-${Environment}'

  RDSInstance:
    Type: 'AWS::RDS::DBInstance'
    DeletionPolicy: 'Snapshot'
    UpdateReplacePolicy: 'Snapshot'
    DependsOn: RDSSecret
    Properties:
      DBInstanceIdentifier: !Sub 'tapstack-db-${Environment}'
      DBInstanceClass: !FindInMap [EnvironmentMap, !Ref Environment, DBInstanceClass]
      Engine: 'mysql'
      # Omit specific patch version to avoid availability drift; allow automatic minor upgrades.
      # EngineVersion can be pinned to a family (e.g., '8.0') if you prefer; left unset here intentionally.
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Sub '{{resolve:secretsmanager:TapStackDBSecret-${Environment}:SecretString:password}}'
      AllocatedStorage: 20
      StorageType: 'gp3'
      StorageEncrypted: true
      KmsKeyId: !Ref TapStackKMSKey
      VPCSecurityGroups: [!Ref DatabaseSecurityGroup]
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      MultiAZ: !If [IsProduction, true, false]
      AutoMinorVersionUpgrade: true
      DeletionProtection: !If [IsProduction, true, false]
      EnablePerformanceInsights: true
      PerformanceInsightsKMSKeyId: !Ref TapStackKMSKey
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSMonitoringRole.Arn
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-RDS-${Environment}'
        - Key: 'Environment'
          Value: !Ref Environment

  # ---------- Compute (Auto Scaling) ----------
  LaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Properties:
      LaunchTemplateName: !Sub 'TapStack-LaunchTemplate-${Environment}'
      LaunchTemplateData:
        # Use SSM public parameter for the latest Amazon Linux 2023 AMI (per-region, dynamic)
        ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}'
        InstanceType: !FindInMap [EnvironmentMap, !Ref Environment, InstanceType]
        SecurityGroupIds: [!Ref WebServerSecurityGroup]
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -euxo pipefail
            dnf update -y || yum update -y
            (dnf install -y httpd || yum install -y httpd)
            systemctl enable --now httpd
            echo "<h1>TapStack ${Environment} Environment</h1>" > /var/www/html/index.html
            echo "OK" > /var/www/html/health
        BlockDeviceMappings:
          - DeviceName: '/dev/xvda'
            Ebs:
              VolumeSize: 20
              VolumeType: 'gp3'
              Encrypted: true
              KmsKeyId: !Ref TapStackKMSKey
        MetadataOptions:
          HttpEndpoint: 'enabled'
          HttpTokens: 'required'
          HttpPutResponseHopLimit: 2

  AutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AutoScalingGroupName: !Sub 'TapStack-ASG-${Environment}'
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: !If [IsProduction, '2', '1']
      MaxSize: !If [IsProduction, '6', '3']
      DesiredCapacity: !If [IsProduction, '2', '1']
      VPCZoneIdentifier: [!Ref PrivateSubnetWest1, !Ref PrivateSubnetWest2]
      TargetGroupARNs: [!Ref ALBTargetGroup]
      HealthCheckType: 'ELB'
      HealthCheckGracePeriod: 300
      Tags:
        - Key: 'Name'
          Value: !Sub 'TapStack-Instance-${Environment}'
          PropagateAtLaunch: true
        - Key: 'Environment'
          Value: !Ref Environment
          PropagateAtLaunch: true

  # ---------- Shield Advanced (optional) ----------
  ShieldProtection:
    Type: 'AWS::Shield::Protection'
    Condition: EnableShield
    Properties:
      Name: !Sub 'TapStack-Shield-${Environment}'
      ResourceArn: !Ref ApplicationLoadBalancer

# ========================
# Outputs
# ========================
Outputs:
  SecureBucketName:
    Description: 'Name of the secure S3 bucket'
    Value: !Ref TapStackSecureBucket

  ALBDNSName:
    Description: 'DNS name of the Application Load Balancer'
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  RDSInstanceEndpoint:
    Description: 'Endpoint of the RDS instance'
    Value: !GetAtt RDSInstance.Endpoint.Address

  CrossAccountRoleArn:
    Condition: CreateCrossAccountRole
    Description: 'ARN of the optional cross-account role'
    Value: !GetAtt CrossAccountAccessRole.Arn

  KMSKeyArn:
    Description: 'ARN of the KMS key'
    Value: !GetAtt TapStackKMSKey.Arn

  RDSSecretArn:
    Description: 'ARN of the RDS database secret'
    Value: !Ref RDSSecret

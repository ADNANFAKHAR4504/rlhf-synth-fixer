AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure AWS Infrastructure for Production Environment with Session Manager Access'

Parameters:
  InstanceType:
    Type: String
    Default: 't3.micro'
    Description: 'EC2 Instance Type'
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large

  EnvironmentSuffix:
    Type: String
    Default: 'prod'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9-]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters and hyphens'

  EnableKMSKeyRotation:
    Type: String
    Default: 'true'
    Description: 'Enable automatic KMS key rotation for enhanced security'
    AllowedValues:
      - 'true'
      - 'false'

  # Optional SSH access - defaults to Session Manager only
  EnableSSHAccess:
    Type: String
    Default: 'false'
    Description: 'Enable SSH access (not recommended - use Session Manager instead)'
    AllowedValues:
      - 'true'
      - 'false'

  AllowedSSHCIDR:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'CIDR block for SSH access - use "VPC" for VPC CIDR (10.0.0.0/16), or specify custom CIDR like 192.168.1.0/24'

Conditions:
  EnableSSH: !Equals [!Ref EnableSSHAccess, 'true']
  UseVPCCIDR: !Equals [!Ref AllowedSSHCIDR, 'VPC']

Resources:
  # Core VPC - Isolated network environment
  SecureVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'SecureVPC-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Internet Gateway for public subnet connectivity
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 'SecureIGW-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Attach IGW to VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref SecureVPC
      InternetGatewayId: !Ref InternetGateway

  # Public subnet for internet-accessible resources
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureVPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'SecurePublicSubnet-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Private subnet for backend resources
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureVPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub 'SecurePrivateSubnet-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Route table for public subnet
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SecureVPC
      Tags:
        - Key: Name
          Value: !Sub 'PublicRouteTable-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Route to internet via IGW
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  # Associate public subnet with route table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Security Group - Session Manager primary, SSH optional
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'SecureEC2SG-${EnvironmentSuffix}'
      GroupDescription: !Sub 'Security group for EC2 instances with Session Manager access - ${EnvironmentSuffix}'
      VpcId: !Ref SecureVPC
      # Conditional SSH access - only if enabled
      SecurityGroupIngress: !If
        - EnableSSH
        - - IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            CidrIp:
              !If [UseVPCCIDR, !GetAtt SecureVPC.CidrBlock, !Ref AllowedSSHCIDR]
            Description:
              !If [
                UseVPCCIDR,
                'SSH access from within VPC only',
                !Sub 'SSH access from ${AllowedSSHCIDR}',
              ]
        - []
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: Name
          Value: !Sub 'SecureEC2SecurityGroup-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Encrypted S3 bucket with comprehensive security
  SecureS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3KMSKey
            BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LoggingConfiguration:
        DestinationBucketName: !Ref S3AccessLogsBucket
        LogFilePrefix: 'access-logs/'
      Tags:
        - Key: Name
          Value: !Sub 'SecureS3Bucket-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # S3 access logs storage
  S3AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub 'S3AccessLogsBucket-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # CloudTrail logs storage
  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub 'CloudTrailBucket-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # IAM role for EC2 with Session Manager and minimal S3 access
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore # Session Manager access
      Policies:
        - PolicyName: !Sub 'MinimalS3Access-${EnvironmentSuffix}'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub '${SecureS3Bucket.Arn}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub '${SecureS3Bucket.Arn}'
      Tags:
        - Key: Name
          Value: !Sub 'SecureEC2Role-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Instance profile to attach role to EC2
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # EC2 instance with Session Manager - NO KeyPair required
  SecureEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      InstanceType: !Ref InstanceType
      # KeyName removed - Session Manager access only
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      BlockDeviceMappings:
        - DeviceName: '/dev/xvda'
          Ebs:
            VolumeType: gp3
            VolumeSize: 20
            Encrypted: true
            DeleteOnTermination: true
      UserData:
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          yum install -y amazon-cloudwatch-agent amazon-ssm-agent
          systemctl enable amazon-ssm-agent
          systemctl start amazon-ssm-agent
      Tags:
        - Key: Name
          Value: !Sub 'SecureInstance-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

  # Customer-managed KMS key for encryption
  S3KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub 'KMS Key for S3 bucket encryption with automatic rotation - ${EnvironmentSuffix}'
      EnableKeyRotation: !Ref EnableKMSKeyRotation
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow S3 Service
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
              - kms:ReEncrypt*
              - kms:CreateGrant
              - kms:DescribeKey
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService': !Sub 's3.${AWS::Region}.amazonaws.com'
          - Sid: Allow CloudTrail Encryption
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub 'S3KMSKey-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: KeyRotation
          Value: !Ref EnableKMSKeyRotation
        - Key: Purpose
          Value: 'S3 and CloudTrail encryption'

  # KMS key alias for easier reference
  S3KMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}-s3-key-${EnvironmentSuffix}'
      TargetKeyId: !Ref S3KMSKey

  # S3 bucket policy for CloudTrail
  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub '${CloudTrailBucket.Arn}/*'
            Condition:
              StringEquals:
                's3:x-amz-acl': 'bucket-owner-full-control'

  # CloudTrail for audit logging
  SecureCloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: CloudTrailBucketPolicy
    Properties:
      TrailName: !Sub '${AWS::StackName}-CloudTrail-${EnvironmentSuffix}'
      S3BucketName: !Ref CloudTrailBucket
      S3KeyPrefix: 'cloudtrail-logs'
      KMSKeyId: !Ref S3KMSKey
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      IsLogging: true
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
          DataResources:
            - Type: 'AWS::S3::Object'
              Values:
                - !Sub '${SecureS3Bucket.Arn}/*'
      Tags:
        - Key: Name
          Value: !Sub 'SecureCloudTrail-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix

Outputs:
  VPCId:
    Description: 'VPC ID for the deployed environment'
    Value: !Ref SecureVPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-${EnvironmentSuffix}'

  EC2InstanceId:
    Description: 'EC2 Instance ID for the deployed environment'
    Value: !Ref SecureEC2Instance
    Export:
      Name: !Sub '${AWS::StackName}-EC2-${EnvironmentSuffix}'

  EC2PublicIP:
    Description: 'EC2 Public IP for the deployed environment'
    Value: !GetAtt SecureEC2Instance.PublicIp
    Export:
      Name: !Sub '${AWS::StackName}-EC2-PublicIP-${EnvironmentSuffix}'

  SessionManagerConnectCommand:
    Description: 'Command to connect to EC2 instance via Session Manager'
    Value: !Sub 'aws ssm start-session --target ${SecureEC2Instance} --region ${AWS::Region}'
    Export:
      Name: !Sub '${AWS::StackName}-SessionManager-Command-${EnvironmentSuffix}'

  S3BucketName:
    Description: 'S3 Bucket Name for the deployed environment'
    Value: !Ref SecureS3Bucket
    Export:
      Name: !Sub '${AWS::StackName}-S3Bucket-${EnvironmentSuffix}'

  CloudTrailArn:
    Description: 'CloudTrail ARN for the deployed environment'
    Value: !GetAtt SecureCloudTrail.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CloudTrail-${EnvironmentSuffix}'

  SecurityGroupId:
    Description: 'Security Group ID for the deployed environment'
    Value: !Ref EC2SecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroup-${EnvironmentSuffix}'

  S3KMSKeyId:
    Description: 'KMS Key ID for S3 encryption in the deployed environment'
    Value: !Ref S3KMSKey
    Export:
      Name: !Sub '${AWS::StackName}-S3KMSKey-${EnvironmentSuffix}'

  S3KMSKeyArn:
    Description: 'KMS Key ARN for S3 encryption'
    Value: !GetAtt S3KMSKey.Arn
    Export:
      Name: !Sub '${AWS::StackName}-S3KMSKey-ARN-${EnvironmentSuffix}'

  KMSKeyRotationStatus:
    Description: 'KMS Key rotation status'
    Value: !Ref EnableKMSKeyRotation
    Export:
      Name: !Sub '${AWS::StackName}-KMSRotation-${EnvironmentSuffix}'

  EC2RoleArn:
    Description: 'EC2 IAM Role ARN for the deployed environment'
    Value: !GetAtt EC2Role.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2Role-${EnvironmentSuffix}'

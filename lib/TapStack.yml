AWSTemplateFormatVersion: '2010-09-09'
Description: 'Production-ready VPC infrastructure with Auto Scaling Group deployment across public subnets in us-east-1'

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: dev
    Description: Environment suffix (e.g., dev, prod, staging, pr265, etc.)
    AllowedPattern: ^[a-zA-Z0-9-]+$
    ConstraintDescription: Must be a valid environment name (alphanumeric and hyphens only)

  Name:
    Type: String
    Default: tapstack
    Description: Application name for resource naming

  Team:
    Type: String
    Default: team
    Description: Team name for resource tagging and naming

  Project:
    Type: String
    Default: infrastructure
    Description: Project identifier for cost tracking

  Owner:
    Type: String
    Default: devops-team
    Description: Team or individual responsible for resources

  CostCenter:
    Type: String
    Default: engineering
    Description: Cost center for cost allocation and tracking

  AllowedSSHCidr:
    Type: String
    Default: 203.0.113.0/24
    Description: CIDR block allowed for SSH access to EC2 instances
    AllowedPattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$
    ConstraintDescription: Must be a valid CIDR block (e.g., 203.0.113.0/24)

  KeyPairName:
    Type: String
    Description: EC2 Key Pair for SSH access to instances (leave default for LocalStack)
    Default: localstack-key

  UseLocalStack:
    Type: String
    Description: Set to 'true' when deploying to LocalStack
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

Conditions:
  IsLocalStack: !Equals [!Ref UseLocalStack, 'true']

Mappings:
  AZConfig:
    us-east-1:
      AZ1: [us-east-1a]
      AZ2: [us-east-1b]

  AMIConfig:
    us-east-1:
      # LocalStack uses a dummy AMI ID (8-character format)
      LocalStack: ami-12345678
      # AWS uses Amazon Linux 2 AMI (update this periodically for real AWS deployments)
      AWS: ami-0c02fb55b2485eb75

Resources:
  # VPC Configuration
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-vpc-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Main VPC for Auto Scaling Group deployment

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-igw-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Internet Gateway for public subnet access

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !FindInMap [AZConfig, us-east-1, AZ1]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-public-subnet-1-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Public subnet for Auto Scaling Group instances in AZ1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [0, !FindInMap [AZConfig, us-east-1, AZ2]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-public-subnet-2-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Public subnet for Auto Scaling Group instances in AZ2

  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !FindInMap [AZConfig, us-east-1, AZ1]]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-private-subnet-1-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Private subnet for backend resources in AZ1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [0, !FindInMap [AZConfig, us-east-1, AZ2]]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-private-subnet-2-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Private subnet for backend resources in AZ2

  # NAT Gateway and Elastic IP
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-nat-eip-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Elastic IP for NAT Gateway

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-nat-gateway-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: NAT Gateway for private subnet outbound internet access

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-public-rt-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Route table for public subnets

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-private-rt-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Route table for private subnets

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # Security Group for EC2 instances
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentSuffix}-${Name}-ec2-sg-${Team}
      GroupDescription: Security group for Auto Scaling Group EC2 instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHCidr
          Description: SSH access from specified CIDR block
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-ec2-sg-${Team}
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref Project
        - Key: Owner
          Value: !Ref Owner
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Purpose
          Value: Security group for Auto Scaling Group EC2 instances

  # Launch Template for Auto Scaling Group
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${EnvironmentSuffix}-${Name}-launch-template-${Team}
      LaunchTemplateData:
        MetadataOptions:
          HttpEndpoint: enabled
          HttpTokens: required
        ImageId: !If
          - IsLocalStack
          - !FindInMap [AMIConfig, us-east-1, LocalStack]
          - !FindInMap [AMIConfig, us-east-1, AWS]
        InstanceType: t3.micro
        KeyName: !Ref KeyPairName
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub ${EnvironmentSuffix}-${Name}-asg-instance-${Team}
              - Key: Environment
                Value: !Ref EnvironmentSuffix
              - Key: Project
                Value: !Ref Project
              - Key: Owner
                Value: !Ref Owner
              - Key: CostCenter
                Value: !Ref CostCenter
              - Key: Purpose
                Value: Auto Scaling Group instance for web application
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub ${EnvironmentSuffix}-${Name}-asg-volume-${Team}
              - Key: Environment
                Value: !Ref EnvironmentSuffix
              - Key: Project
                Value: !Ref Project
              - Key: Owner
                Value: !Ref Owner
              - Key: CostCenter
                Value: !Ref CostCenter
              - Key: Purpose
                Value: EBS volume for Auto Scaling Group instance

  # Auto Scaling Group
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub ${EnvironmentSuffix}-${Name}-asg-${Team}
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 2
      DesiredCapacity: 2
      VPCZoneIdentifier:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      HealthCheckType: EC2
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentSuffix}-${Name}-asg-${Team}
          PropagateAtLaunch: false
        - Key: Environment
          Value: !Ref EnvironmentSuffix
          PropagateAtLaunch: true
        - Key: Project
          Value: !Ref Project
          PropagateAtLaunch: true
        - Key: Owner
          Value: !Ref Owner
          PropagateAtLaunch: true
        - Key: CostCenter
          Value: !Ref CostCenter
          PropagateAtLaunch: true
        - Key: Purpose
          Value: Auto Scaling Group for web application deployment
          PropagateAtLaunch: true

Outputs:
  VPCId:
    Description: VPC ID for the infrastructure
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-vpc-id-${Team}

  PublicSubnetIds:
    Description: List of Public Subnet IDs
    Value: !Join
      - ','
      - - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-public-subnets-${Team}

  PrivateSubnetIds:
    Description: List of Private Subnet IDs
    Value: !Join
      - ','
      - - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-private-subnets-${Team}

  PublicSubnet1Id:
    Description: Public Subnet 1 ID (us-east-1a)
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-public-subnet-1-${Team}

  PublicSubnet2Id:
    Description: Public Subnet 2 ID (us-east-1b)
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-public-subnet-2-${Team}

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID (us-east-1a)
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-private-subnet-1-${Team}

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID (us-east-1b)
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-private-subnet-2-${Team}

  AutoScalingGroupName:
    Description: Auto Scaling Group name
    Value: !Ref AutoScalingGroup
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-asg-name-${Team}

  SecurityGroupId:
    Description: Security Group ID for EC2 instances
    Value: !Ref EC2SecurityGroup
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-sg-id-${Team}

  LaunchTemplateId:
    Description: Launch Template ID
    Value: !Ref LaunchTemplate
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-lt-id-${Team}

  NATGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NATGateway
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-nat-gateway-id-${Team}

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: !Sub ${EnvironmentSuffix}-${Name}-igw-id-${Team}

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  A robust CloudFormation template that provisions a web application environment.
  It uses AWS Secrets Manager for the database password and a parameter for the username.
  WARNING: The default IP for SSH is 0.0.0.0/0. Please change this for production.

Parameters:
  EnvironmentName:
    Type: String
    Description: "An environment identifier (e.g., dev, qa, prod)."
    Default: dev
  OwnerName:
    Type: String
    Description: "The name of the resource owner."
    Default: TechTeam
  ProjectName:
    Type: String
    Description: "The name of the project."
    Default: WebAppProject

  # No default value is provided for the KeyPair for security reasons.
  # This ensures you consciously select a key that you own.
  WebAppServerKeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: "Name of an existing EC2 KeyPair to enable SSH access to the instance."
    Default: iac-rlhf-aws-trainer-instance

  DBMasterUsername:
    Type: String
    Description: "Username for the RDS master user. Use only letters and numbers."
    Default: "dbadmin"

  MyIpAddress:
    Type: String
    Description: "Your IP in CIDR notation (e.g., 203.0.113.5/32) for secure SSH access."
    Default: "0.0.0.0/0" # WARNING: Insecure. Allows SSH from anywhere.

Conditions:
  IsProd: !Equals [!Ref EnvironmentName, "prod"]

Resources:
  WebAppAssets:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: !Ref OwnerName
        - Key: Project
          Value: !Ref ProjectName

  # -- Security Groups --
  WebAppServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Enable HTTP and SSH access for the web application server"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIpAddress
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: !Ref OwnerName
        - Key: Project
          Value: !Ref ProjectName

  WebAppDatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Allow database access from the web server security group"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt WebAppServerSecurityGroup.GroupId
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: !Ref OwnerName
        - Key: Project
          Value: !Ref ProjectName

  # -- EC2 Instance --
  WebAppServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      KeyName: !Ref WebAppServerKeyName
      SecurityGroupIds:
        - !GetAtt WebAppServerSecurityGroup.GroupId
      # --- ADDED: This UserData script installs and starts a web server ---
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          # Update all packages
          yum update -y
          # Install Apache Web Server
          yum install -y httpd
          # Start the Apache service
          systemctl start httpd
          # Enable the Apache service to start on boot
          systemctl enable httpd
          # Create a simple index.html file to serve
          echo "<h1>Hello from CloudFormation!</h1>" > /var/www/html/index.html
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: !Ref OwnerName
        - Key: Project
          Value: !Ref ProjectName
        - Key: Name
          Value: !Sub '${ProjectName}-WebAppServer-${EnvironmentName}'

  # -- RDS Database --
  WebAppDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: '8.0.36'
      AllocatedStorage: '20'
      StorageType: gp2
      MultiAZ: !If [IsProd, true, false]
      DBName: !Sub '${ProjectName}${EnvironmentName}DB'
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: '{{resolve:secretsmanager:MyProdDbCredentials:SecretString:password}}'
      VPCSecurityGroups:
        - !GetAtt WebAppDatabaseSecurityGroup.GroupId
      PubliclyAccessible: false
      DeletionProtection: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Owner
          Value: !Ref OwnerName
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  WebAppServerId:
    Description: "Instance ID of the Web Application Server"
    Value: !Ref WebAppServer
    Export:
      Name: !Sub "${AWS::StackName}-WebAppServerId"

  WebAppServerPublicIp:
    Description: "Public IP address of the Web Application Server"
    Value: !GetAtt WebAppServer.PublicIp
    Export:
      Name: !Sub "${AWS::StackName}-WebAppServerPublicIp"

  WebAppAssetsBucketName:
    Description: "Name of the S3 bucket for static assets"
    Value: !Ref WebAppAssets
    Export:
      Name: !Sub "${AWS::StackName}-WebAppAssetsBucketName"

  WebAppDatabaseEndpoint:
    Description: "Endpoint address for the RDS database"
    Value: !GetAtt WebAppDatabase.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-WebAppDatabaseEndpoint"

  WebAppDatabasePort:
    Description: "Port for the RDS database"
    Value: !GetAtt WebAppDatabase.Endpoint.Port
    Export:
      Name: !Sub "${AWS::StackName}-WebAppDatabasePort"

AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template for a secure web environment using the default VPC with default parameters

Parameters:
  AllowedIPAddress:
    Type: String
    Description: IP address allowed for SSH access 
    AllowedPattern: ^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/32$
    ConstraintDescription: Must be a valid CIDR IP address 
    Default: 203.0.113.10/32
  ExistingVPCId:
    Type: String
    Description: ID of the existing default VPC (e.g., vpc-xxxxxxxx)
    Default: vpc-0b094aa4091786d92

Resources:
  # Creating Subnet in the existing VPC
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ExistingVPCId
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: SecureWebSubnet

  # Creating Security Group
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EC2 instance with restricted SSH access
      VpcId: !Ref ExistingVPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIPAddress
      Tags:
        - Key: Name
          Value: SecureWebSG

  # Creating IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3ReadOnlyPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:Get*
                  - s3:List*
                Resource: '*'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: EC2S3ReadOnlyRole

  # Creating Instance Profile
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Creating Parameter Store for configuration
  ConfigParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /secure-web/config
      Type: String
      Value: 'example-config-value'
      Description: Configuration value for EC2 instance

  # Creating Elastic IP
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # Creating EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0c55b159cbfafe1f0 # Amazon Linux 2 AMI in us-west-2
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup
      IamInstanceProfile: !Ref EC2InstanceProfile
      UserData: 
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          # Retrieving configuration from Parameter Store
          CONFIG_VALUE=$(aws ssm get-parameter --name "/secure-web/config" --region us-west-2 --query Parameter.Value --output text)
          echo "Configuration: $CONFIG_VALUE" >> /var/log/config.log
      Tags:
        - Key: Name
          Value: SecureWebInstance

  # Associating Elastic IP with EC2 Instance
  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref EC2Instance
      EIP: !Ref ElasticIP

Outputs:
  InstancePublicIP:
    Description: Public IP address of the EC2 instance
    Value: !Ref ElasticIP
  VPCId:
    Description: ID of the existing VPC used
    Value: !Ref ExistingVPCId
  InstanceId:
    Description: ID of the EC2 instance
    Value: !Ref EC2Instance
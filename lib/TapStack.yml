AWSTemplateFormatVersion: "2010-09-09"
Description: "TAP Stack - Task Assignment Platform CloudFormation Template"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix
          - VpcCidr

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: "Environment suffix for resource naming (e.g., dev, staging, prod)"
    AllowedPattern: "^[a-zA-Z0-9]+$"
    ConstraintDescription: "Must contain only alphanumeric characters"

  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
    Description: "CIDR block for the VPC"
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    ConstraintDescription: "Must be a valid IP CIDR range of the form x.x.x.x/16-28"

Resources:
  # Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: { Ref: VpcCidr }
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-vpc-${EnvironmentSuffix}" }

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-igw-${EnvironmentSuffix}" }

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: { Ref: VPC }
      InternetGatewayId: { Ref: InternetGateway }

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: VPC }
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        "Fn::Select":
          - 0
          - "Fn::GetAZs": ""
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-public-a-${EnvironmentSuffix}" }

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: VPC }
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        "Fn::Select":
          - 1
          - "Fn::GetAZs": ""
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-public-b-${EnvironmentSuffix}" }

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: VPC }
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        "Fn::Select":
          - 0
          - "Fn::GetAZs": ""
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-private-a-${EnvironmentSuffix}" }

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: { Ref: VPC }
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        "Fn::Select":
          - 1
          - "Fn::GetAZs": ""
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-private-b-${EnvironmentSuffix}" }

  # NAT Gateway and EIP for private subnet internet access
  EIPNatGateway:
    Type: AWS::EC2::EIP
    DependsOn: VPCGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    DependsOn: VPCGatewayAttachment
    Properties:
      AllocationId: { "Fn::GetAtt": ["EIPNatGateway", "AllocationId"] }
      SubnetId: { Ref: PublicSubnet1 }

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: VPC }

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: { Ref: PublicRouteTable }
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: { Ref: InternetGateway }

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: { Ref: PublicRouteTable }
      SubnetId: { Ref: PublicSubnet1 }

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: { Ref: PublicRouteTable }
      SubnetId: { Ref: PublicSubnet2 }

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: VPC }

  PrivateRoute1Default:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: { Ref: PrivateRouteTable1 }
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: { Ref: NatGateway }

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: { Ref: PrivateRouteTable1 }
      SubnetId: { Ref: PrivateSubnet1 }

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: { Ref: VPC }

  PrivateRoute2Default:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: { Ref: PrivateRouteTable2 }
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: { Ref: NatGateway }

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: { Ref: PrivateRouteTable2 }
      SubnetId: { Ref: PrivateSubnet2 }

  # Security Groups
  PublicSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for resources in public subnets"
      VpcId: { Ref: VPC }
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: "0.0.0.0/0"
          Description: "Allow HTTP traffic from internet"
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: "0.0.0.0/0"
          Description: "Allow HTTPS traffic from internet"
      SecurityGroupEgress:
        - IpProtocol: "-1"
          CidrIp: "0.0.0.0/0"
          Description: "Allow all outbound traffic"
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-public-sg-${EnvironmentSuffix}" }

  PrivateSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Security group for resources in private subnets"
      VpcId: { Ref: VPC }
      SecurityGroupIngress:
        - IpProtocol: "-1"
          SourceSecurityGroupId: { Ref: PublicSecurityGroup }
          Description: "Allow all traffic from public security group"
      SecurityGroupEgress:
        - IpProtocol: "-1"
          CidrIp: "0.0.0.0/0"
          Description: "Allow all outbound traffic"
      Tags:
        - Key: Name
          Value: { "Fn::Sub": "tap-private-sg-${EnvironmentSuffix}" }

  # Secure S3 bucket with versioning
  ArtifactsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Environment
          Value: { Ref: EnvironmentSuffix }

  # Least-privilege IAM role for EC2 instances in private subnets to read from the S3 bucket
  PrivateInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: "S3ReadArtifactsBucket"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: ListBucket
                Effect: Allow
                Action: "s3:ListBucket"
                Resource:
                  "Fn::Sub": "arn:aws:s3:::${ArtifactsBucket}"
              - Sid: GetObjects
                Effect: Allow
                Action: "s3:GetObject"
                Resource:
                  "Fn::Sub": "arn:aws:s3:::${ArtifactsBucket}/*"

  # Instance Profile for the IAM role to be used by EC2 instances
  PrivateInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - { Ref: PrivateInstanceRole }

  # Existing DynamoDB table retained
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName:
        "Fn::Sub": "TurnAroundPromptTable${EnvironmentSuffix}"
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      DeletionProtectionEnabled: false

Outputs:
  # DynamoDB outputs (unchanged semantics, long-form intrinsics)
  TurnAroundPromptTableName:
    Description: "Name of the DynamoDB table"
    Value: { Ref: TurnAroundPromptTable }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableName" }

  TurnAroundPromptTableArn:
    Description: "ARN of the DynamoDB table"
    Value: { "Fn::GetAtt": ["TurnAroundPromptTable", "Arn"] }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-TurnAroundPromptTableArn" }

  # Core stack info
  StackName:
    Description: "Name of this CloudFormation stack"
    Value: { Ref: "AWS::StackName" }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-StackName" }

  EnvironmentSuffix:
    Description: "Environment suffix used for this deployment"
    Value: { Ref: EnvironmentSuffix }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-EnvironmentSuffix" }

  # Networking outputs
  VpcId:
    Description: "ID of the VPC"
    Value: { Ref: VPC }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-VpcId" }

  PublicSubnetIds:
    Description: "Comma-separated list of public subnet IDs"
    Value:
      "Fn::Join":
        - ","
        - - { Ref: PublicSubnet1 }
          - { Ref: PublicSubnet2 }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PublicSubnetIds" }

  PrivateSubnetIds:
    Description: "Comma-separated list of private subnet IDs"
    Value:
      "Fn::Join":
        - ","
        - - { Ref: PrivateSubnet1 }
          - { Ref: PrivateSubnet2 }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PrivateSubnetIds" }

  NatGatewayId:
    Description: "ID of the NAT Gateway"
    Value: { Ref: NatGateway }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-NatGatewayId" }

  ArtifactsBucketName:
    Description: "Name of the S3 artifacts bucket (versioning enabled)"
    Value: { Ref: ArtifactsBucket }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-ArtifactsBucketName" }

  PrivateInstanceRoleArn:
    Description: "ARN of the least-privilege IAM role for instances in private subnets"
    Value: { "Fn::GetAtt": ["PrivateInstanceRole", "Arn"] }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PrivateInstanceRoleArn" }

  PrivateInstanceProfileArn:
    Description: "ARN of the IAM instance profile for instances in private subnets"
    Value: { "Fn::GetAtt": ["PrivateInstanceProfile", "Arn"] }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PrivateInstanceProfileArn" }

  PublicSecurityGroupId:
    Description: "ID of the security group for public subnet resources"
    Value: { Ref: PublicSecurityGroup }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PublicSecurityGroupId" }

  PrivateSecurityGroupId:
    Description: "ID of the security group for private subnet resources"
    Value: { Ref: PrivateSecurityGroup }
    Export:
      Name: { "Fn::Sub": "${AWS::StackName}-PrivateSecurityGroupId" }

AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure financial application infrastructure with encrypted S3 storage and least-privilege IAM access'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix
          - BucketNameSuffix
      - Label:
          default: "Security Configuration"
        Parameters:
          - RetentionDays
    ParameterLabels:
      EnvironmentSuffix:
        default: "Environment Suffix"
      BucketNameSuffix:
        default: "Unique Bucket Suffix"
      RetentionDays:
        default: "Document Retention Period (Days)"
  SecurityCompliance:
    Standards: ['PCI-DSS', 'SOX', 'GDPR']
    LastReview: '2025-08-07'
    ReviewedBy: 'Security Engineering Team'

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: 'Environment suffix for resource naming and tagging'
    Default: 'dev'
    MinLength: 3
    MaxLength: 20
    AllowedPattern: '^[a-z0-9-]*$'
    ConstraintDescription: 'Must contain only lowercase letters, numbers, and hyphens'
    
  BucketNameSuffix:
    Type: String
    Description: 'Unique suffix for S3 bucket naming to avoid conflicts'
    Default: 'dev'
    MinLength: 3
    MaxLength: 20
    AllowedPattern: '^[a-z0-9-]*$'
    ConstraintDescription: 'Must contain only lowercase letters, numbers, and hyphens'
    
  RetentionDays:
    Type: Number
    Description: 'Number of days to retain financial documents (minimum 7 years for compliance)'
    Default: 2557  # 7 years
    MinValue: 365
    MaxValue: 3650

Conditions:
  IsProduction: !Equals [!Ref EnvironmentSuffix, 'prod']

Resources:

  # S3 Bucket for Secure Financial Document Storage
  FinAppSecureDocuments:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'finapp-documents-${BucketNameSuffix}-${AWS::AccountId}'
      
      # Encryption Configuration - SSE-S3 for data at rest
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      
      # Public Access Block - Prevent any public access
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      
      # Versioning - Enable for audit trails and data recovery
      VersioningConfiguration:
        Status: Enabled
      
      # Lifecycle Management for Compliance
      LifecycleConfiguration:
        Rules:
          - Id: FinancialDocumentRetention
            Status: Enabled
            ExpirationInDays: !Ref RetentionDays
            NoncurrentVersionExpirationInDays: !Ref RetentionDays
            
          # Move to cheaper storage classes for cost optimization
          - Id: StorageClassTransition
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 90
                StorageClass: GLACIER
              - TransitionInDays: 365
                StorageClass: DEEP_ARCHIVE
      
      # Resource Tagging for Governance
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Application
          Value: FinApp
        - Key: DataClassification
          Value: Confidential
        - Key: Compliance
          Value: Financial
        - Key: BackupRequired
          Value: 'true'
        - Key: CostCenter
          Value: Finance
      
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # Bucket Policy for Additional Security Controls
  FinAppBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FinAppSecureDocuments
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          
          # Deny all HTTP requests - Enforce HTTPS/TLS
          - Sid: DenyHTTPRequests
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource: 
              - !Sub '${FinAppSecureDocuments}/*'
              - !Ref FinAppSecureDocuments
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          
          # Deny uploads without encryption
          - Sid: DenyUnencryptedUploads
            Effect: Deny
            Principal: '*'
            Action: 's3:PutObject'
            Resource: !Sub '${FinAppSecureDocuments}/*'
            Condition:
              StringNotEquals:
                's3:x-amz-server-side-encryption': 'AES256'
          
          # Deny public ACL modifications
          - Sid: DenyPublicACLs
            Effect: Deny
            Principal: '*'
            Action:
              - 's3:PutBucketAcl'
              - 's3:PutObjectAcl'
            Resource:
              - !Ref FinAppSecureDocuments
              - !Sub '${FinAppSecureDocuments}/*'
            Condition:
              StringLike:
                's3:x-amz-acl':
                  - 'public-read'
                  - 'public-read-write'
                  - 'authenticated-read'

  # IAM Role for Least-Privilege S3 Access
  FinAppS3AccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'FinApp-S3Access-${EnvironmentSuffix}-${AWS::Region}'
      Description: 'Least-privilege role for FinApp S3 document access'
      
      # Trust Policy - Allow EC2 instances to assume this role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: 
                - ec2.amazonaws.com
                - lambda.amazonaws.com  # Allow Lambda functions as well
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'aws:RequestedRegion': !Ref 'AWS::Region'
      
      # Inline Policy with Least Privilege Permissions
      Policies:
        - PolicyName: S3DocumentAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              
              # Allow listing bucket contents
              - Sid: AllowBucketListing
                Effect: Allow
                Action:
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketVersioning'
                Resource: !Ref FinAppSecureDocuments
                Condition:
                  StringEquals:
                    's3:ExistingObjectTag/Environment': !Ref EnvironmentSuffix
              
              # Allow object operations on financial documents
              - Sid: AllowObjectOperations
                Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:GetObjectVersion'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:RestoreObject'
                Resource: !Sub '${FinAppSecureDocuments}/*'
                Condition:
                  StringEquals:
                    's3:x-amz-server-side-encryption': 'AES256'
              
              # Allow metadata operations
              - Sid: AllowMetadataOperations
                Effect: Allow
                Action:
                  - 's3:GetObjectAttributes'
                  - 's3:GetObjectTagging'
                  - 's3:PutObjectTagging'
                Resource: !Sub '${FinAppSecureDocuments}/*'
              
              # Explicit deny for dangerous operations
              - Sid: DenyDangerousOperations
                Effect: Deny
                Action:
                  - 's3:DeleteBucket*'
                  - 's3:PutBucketAcl'
                  - 's3:PutBucketPolicy'
                  - 's3:PutEncryptionConfiguration'
                  - 's3:PutBucketPublicAccessBlock'
                Resource: 
                  - !Ref FinAppSecureDocuments
                  - !Sub '${FinAppSecureDocuments}/*'
      
      # Resource Tags
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Application
          Value: FinApp
        - Key: Purpose
          Value: S3DocumentAccess
        - Key: SecurityLevel
          Value: LeastPrivilege

  # Instance Profile for EC2 Attachment
  FinAppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub 'FinApp-InstanceProfile-${EnvironmentSuffix}'
      Roles:
        - !Ref FinAppS3AccessRole

  # CloudTrail for Audit Logging (Optional but Recommended)
  FinAppCloudTrail:
    Type: AWS::CloudTrail::Trail
    Condition: IsProduction
    Properties:
      TrailName: !Sub 'FinApp-AuditTrail-${EnvironmentSuffix}'
      S3BucketName: !Ref FinAppAuditLogsBucket
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      
      # Focus on S3 API calls for financial documents
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
          DataResources:
            - Type: 'AWS::S3::Object'
              Values: 
                - !Sub '${FinAppSecureDocuments}/*'
      
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Application
          Value: FinApp
        - Key: Purpose
          Value: AuditLogging

  # Separate bucket for CloudTrail logs
  FinAppAuditLogsBucket:
    Type: AWS::S3::Bucket
    Condition: IsProduction
    Properties:
      BucketName: !Sub 'finapp-audit-logs-${BucketNameSuffix}-${AWS::AccountId}'
      
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
              
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
        
      LifecycleConfiguration:
        Rules:
          - Id: AuditLogRetention
            Status: Enabled
            ExpirationInDays: 2557  # Same retention as documents
            
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Application
          Value: FinApp
        - Key: Purpose
          Value: AuditLogs

Outputs:
  
  # S3 Bucket Information
  S3BucketName:
    Description: 'Name of the secure S3 bucket for financial documents'
    Value: !Ref FinAppSecureDocuments
    Export:
      Name: !Sub '${AWS::StackName}-S3Bucket'
  
  S3BucketArn:
    Description: 'ARN of the secure S3 bucket'
    Value: !GetAtt FinAppSecureDocuments.Arn
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketArn'
  
  S3BucketDomainName:
    Description: 'Regional domain name of the S3 bucket'
    Value: !GetAtt FinAppSecureDocuments.RegionalDomainName
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketDomain'
  
  S3BucketEndpoint:
    Description: 'HTTPS endpoint for the S3 bucket'
    Value: !Sub 'https://${FinAppSecureDocuments}.s3.${AWS::Region}.amazonaws.com'
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketEndpoint'
  
  # IAM Role Information
  IAMRoleName:
    Description: 'Name of the S3 access IAM role'
    Value: !Ref FinAppS3AccessRole
    Export:
      Name: !Sub '${AWS::StackName}-IAMRoleName'
  
  IAMRoleArn:
    Description: 'ARN of the S3 access IAM role'
    Value: !GetAtt FinAppS3AccessRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-IAMRoleArn'
  
  InstanceProfileArn:
    Description: 'ARN of the EC2 instance profile'
    Value: !GetAtt FinAppInstanceProfile.Arn
    Export:
      Name: !Sub '${AWS::StackName}-InstanceProfileArn'
  
  # Security Configuration
  EncryptionMethod:
    Description: 'Encryption method used for S3 bucket'
    Value: 'SSE-S3 (AES-256)'
    Export:
      Name: !Sub '${AWS::StackName}-EncryptionMethod'
  
  PublicAccessBlocked:
    Description: 'Public access configuration status'
    Value: 'All public access blocked'
    Export:
      Name: !Sub '${AWS::StackName}-PublicAccessStatus'
  
  # Compliance Information
  RetentionPeriod:
    Description: 'Document retention period in days'
    Value: !Ref RetentionDays
    Export:
      Name: !Sub '${AWS::StackName}-RetentionDays'
  
  ComplianceStandards:
    Description: 'Compliance standards addressed by this configuration'
    Value: 'PCI-DSS, SOX, GDPR'
    Export:
      Name: !Sub '${AWS::StackName}-ComplianceStandards'
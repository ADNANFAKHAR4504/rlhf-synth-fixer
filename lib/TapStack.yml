AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS Config Rules - Infrastructure Compliance Monitoring'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix
          - EnableConfigRecorder

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'

  EnableConfigRecorder:
    Type: String
    Default: 'true'
    Description: 'Enable AWS Config Recorder'
    AllowedValues:
      - 'true'
      - 'false'

Conditions:
  ShouldEnableConfigRecorder: !Equals [!Ref EnableConfigRecorder, 'true']

Resources:
  # S3 Bucket for AWS Config Delivery
  ConfigBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub 'config-bucket-${AWS::AccountId}-${EnvironmentSuffix}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt ConfigKMSKey.Arn
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: 'DeleteOldConfigData'
            Status: Enabled
            ExpirationInDays: 90
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Compliance
          Value: 'AWS Config'
        - Key: Owner
          Value: 'Infrastructure Team'

  # KMS Key for Config Encryption
  ConfigKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS key for AWS Config encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow Config to use the key
            Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Compliance
          Value: 'AWS Config'
        - Key: Owner
          Value: 'Infrastructure Team'

  # SNS Topic for Config Notifications
  ConfigTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'config-notifications-${EnvironmentSuffix}'
      DisplayName: 'AWS Config Compliance Notifications'
      KmsMasterKeyId: !GetAtt ConfigKMSKey.Arn
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Compliance
          Value: 'AWS Config'
        - Key: Owner
          Value: 'Infrastructure Team'

  # IAM Role for AWS Config
  ConfigRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'AWSConfigRole-${EnvironmentSuffix}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWS_ConfigRole'
      Policies:
        - PolicyName: ConfigS3Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:PutObjectAcl'
                Resource: !Sub '${ConfigBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - 's3:GetBucketVersioning'
                Resource: !GetAtt ConfigBucket.Arn
        - PolicyName: ConfigSNSPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 'sns:Publish'
                Resource: !Ref ConfigTopic
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Compliance
          Value: 'AWS Config'
        - Key: Owner
          Value: 'Infrastructure Team'

  # AWS Config Recorder
  ConfigRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Condition: ShouldEnableConfigRecorder
    Properties:
      Name: !Sub 'config-recorder-${EnvironmentSuffix}'
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: true

  # AWS Config Delivery Channel
  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Condition: ShouldEnableConfigRecorder
    Properties:
      Name: !Sub 'config-delivery-${EnvironmentSuffix}'
      S3BucketName: !Ref ConfigBucket
      SnsTopicARN: !Ref ConfigTopic
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: TwentyFour_Hours

  # Config Rule: Encrypted Volumes
  EncryptedVolumesRule:
    Type: AWS::Config::ConfigRule
    Condition: ShouldEnableConfigRecorder
    Properties:
      ConfigRuleName: !Sub 'encrypted-volumes-${EnvironmentSuffix}'
      Description: 'Checks whether EBS volumes are encrypted'
      Source:
        Owner: AWS
        SourceIdentifier: 'ENCRYPTED_VOLUMES'
      Scope:
        ComplianceResourceTypes:
          - 'AWS::EC2::Volume'
    DependsOn:
      - ConfigRecorder
      - ConfigDeliveryChannel

  # Config Rule: S3 Bucket Public Read Prohibited
  S3BucketPublicReadRule:
    Type: AWS::Config::ConfigRule
    Condition: ShouldEnableConfigRecorder
    Properties:
      ConfigRuleName: !Sub 's3-bucket-public-read-prohibited-${EnvironmentSuffix}'
      Description: 'Checks that S3 buckets do not allow public read access'
      Source:
        Owner: AWS
        SourceIdentifier: 'S3_BUCKET_PUBLIC_READ_PROHIBITED'
      Scope:
        ComplianceResourceTypes:
          - 'AWS::S3::Bucket'
    DependsOn:
      - ConfigRecorder
      - ConfigDeliveryChannel

  # Config Rule: Required Tags
  RequiredTagsRule:
    Type: AWS::Config::ConfigRule
    Condition: ShouldEnableConfigRecorder
    Properties:
      ConfigRuleName: !Sub 'required-tags-${EnvironmentSuffix}'
      Description: 'Checks whether resources are tagged with required tags'
      InputParameters:
        tag1Key: Environment
        tag2Key: Owner
      Source:
        Owner: AWS
        SourceIdentifier: 'REQUIRED_TAGS'
    DependsOn:
      - ConfigRecorder
      - ConfigDeliveryChannel

  # CloudWatch Alarm for Config Compliance
  ConfigComplianceAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'config-compliance-violations-${EnvironmentSuffix}'
      AlarmDescription: 'Alert when Config rules detect compliance violations'
      MetricName: ComplianceViolations
      Namespace: AWS/Config
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

Outputs:
  ConfigBucketName:
    Description: 'Name of the Config S3 bucket'
    Value: !Ref ConfigBucket
    Export:
      Name: !Sub '${AWS::StackName}-ConfigBucketName'

  ConfigBucketArn:
    Description: 'ARN of the Config S3 bucket'
    Value: !GetAtt ConfigBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ConfigBucketArn'

  ConfigTopicArn:
    Description: 'ARN of the Config SNS topic'
    Value: !Ref ConfigTopic
    Export:
      Name: !Sub '${AWS::StackName}-ConfigTopicArn'

  ConfigRecorderName:
    Condition: ShouldEnableConfigRecorder
    Description: 'Name of the Config recorder'
    Value: !Ref ConfigRecorder
    Export:
      Name: !Sub '${AWS::StackName}-ConfigRecorderName'

  ConfigRoleArn:
    Description: 'ARN of the Config IAM role'
    Value: !GetAtt ConfigRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ConfigRoleArn'

  StackName:
    Description: 'Name of this CloudFormation stack'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  EnvironmentSuffix:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

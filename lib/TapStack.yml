AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure EC2 and S3 infrastructure with minimal IAM permissions, logging, randomized naming, and production-grade security'

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: dev
    Description: Environment suffix for resource naming (e.g., dev, staging, prod)
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: Must contain only alphanumeric characters

  InstanceType:
    Type: String
    Default: t3.micro
    Description: EC2 instance type
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium

  KeyPairName:
    Type: String
    Default: ''
    Description: EC2 Key Pair for SSH access (if needed for emergency access). Leave empty if no SSH access needed.

  LatestAmiId:
    Type: String
    Default: ami-0c02fb55956c7d316
    Description: Amazon Linux 2023 AMI ID (LocalStack compatible - using hardcoded AMI for deployment)

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Resources:
  # Lambda function for generating random suffixes
  RandomSuffixGenerator:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'tapstack${EnvironmentSuffix}-random-generator-${AWS::AccountId}'
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt RandomGeneratorRole.Arn
      Code:
        ZipFile: |
          import json
          import random
          import string
          import cfnresponse

          def handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Generate 8-character random alphanumeric suffix
                  random_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
                  
                  response_data = {'RandomSuffix': random_suffix}
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data)
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: RandomGenerator

  # IAM Role for Lambda function
  RandomGeneratorRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'tapstack${EnvironmentSuffix}-lambda-role-${AWS::AccountId}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: IAM

  # Custom resource to trigger random suffix generation
  GenerateRandomSuffix:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt RandomSuffixGenerator.Arn
      Trigger: !Ref 'AWS::StackId'

  # KMS Key for encryption
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub 'tapstack${EnvironmentSuffix} KMS key for CloudWatch Logs encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: EnableRootPermissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'

          # Allow CloudWatch Logs in THIS REGION to use the key for any log group in this account
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              ArnLike:
                # Allow any of your log groups in this account (covers /aws/ec2, /aws/s3, /aws/vpc, etc.)
                'kms:EncryptionContext:aws:logs:arn': !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*'
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Encryption

  # KMS Key Alias
  KMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/tapstack${EnvironmentSuffix}-logs-key-${AWS::AccountId}'
      TargetKeyId: !Ref KMSKey

  # S3 Bucket with strict security controls
  SecureS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'tapstack${EnvironmentSuffix}-secure-bucket-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3AccessLogsBucket
        LogFilePrefix: access-logs/
      Tags:
        - Key: Environment
          Value: Production

  # S3 Bucket Policy to enforce SSL/HTTPS
  SecureS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SecureS3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${SecureS3Bucket.Arn}/*'
              - !GetAtt SecureS3Bucket.Arn
            Condition:
              Bool:
                'aws:SecureTransport': 'false'

  # S3 Bucket for access logs
  S3AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'tapstack${EnvironmentSuffix}-access-logs-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 30
      Tags:
        - Key: Environment
          Value: Production

  # CloudWatch Log Groups with KMS encryption
  EC2LogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: KMSKeyAlias
    Properties:
      LogGroupName: !Sub '/aws/ec2/tapstack${EnvironmentSuffix}-${GenerateRandomSuffix.RandomSuffix}'
      RetentionInDays: 7
      KmsKeyId: !GetAtt KMSKey.Arn
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Logging

  S3LogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: KMSKeyAlias
    Properties:
      LogGroupName: !Sub '/aws/s3/tapstack${EnvironmentSuffix}-${GenerateRandomSuffix.RandomSuffix}'
      RetentionInDays: 7
      KmsKeyId: !GetAtt KMSKey.Arn
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Logging

  VPCFlowLogsGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: KMSKeyAlias
    Properties:
      LogGroupName: !Sub '/aws/vpc/tapstack${EnvironmentSuffix}-${GenerateRandomSuffix.RandomSuffix}'
      RetentionInDays: 7
      KmsKeyId: !GetAtt KMSKey.Arn
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: NetworkLogging

  # IAM Role for EC2 instances with minimal permissions and region restrictions
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'tapstack${EnvironmentSuffix}-ec2-role-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                'aws:RequestedRegion': 'us-west-1'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: MinimalS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub '${SecureS3Bucket.Arn}/*'
                Condition:
                  StringEquals:
                    'aws:RequestedRegion': 'us-west-1'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt SecureS3Bucket.Arn
                Condition:
                  StringEquals:
                    'aws:RequestedRegion': 'us-west-1'
        - PolicyName: CloudWatchLogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource:
                  - !GetAtt EC2LogGroup.Arn
                  - !Sub '${EC2LogGroup.Arn}:*'
                Condition:
                  StringEquals:
                    'aws:RequestedRegion': 'us-west-1'
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: IAM

  # Instance Profile for EC2
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub 'tapstack${EnvironmentSuffix}-ec2-instance-profile-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      Roles:
        - !Ref EC2Role

  # Security Group - Only HTTPS traffic allowed with enhanced security
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'tapstack${EnvironmentSuffix}-ec2-sg-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      GroupDescription: Security group allowing only HTTPS traffic with enhanced security
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS traffic from anywhere
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS outbound traffic
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP outbound for package updates
      Tags:
        - Key: Environment
          Value: Production

  # VPC for our resources with enhanced security
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-vpc-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Networking

  # VPC Flow Logs for network monitoring
  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'tapstack${EnvironmentSuffix}-vpc-flow-logs-role-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FlowLogsDeliveryPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:us-west-1:${AWS::AccountId}:*'
      Tags:
        - Key: Environment
          Value: Production
        - Key: Component
          Value: VPCFlowLogs

  # VPC Flow Logs
  VPCFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogsGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-vpc-flow-logs-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: NetworkLogging

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-igw-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Networking

  # Attach Internet Gateway to VPC
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-public-subnet-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Networking

  # Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-public-routes-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Networking

  # Default Public Route
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate subnet with route table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet

  # Launch Template for EC2 instances with security hardening
  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub 'tapstack${EnvironmentSuffix}-launch-template-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
      LaunchTemplateData:
        ImageId: !Ref LatestAmiId
        InstanceType: !Ref InstanceType
        KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
        IamInstanceProfile:
          Name: !Ref EC2InstanceProfile
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y amazon-cloudwatch-agent firewalld

            # Security hardening
            # Disable root login
            sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
            systemctl reload sshd

            # Enable and configure firewall
            systemctl enable firewalld
            systemctl start firewalld
            firewall-cmd --permanent --add-port=443/tcp
            firewall-cmd --reload

            # Disable IP forwarding for security
            echo 'net.ipv4.ip_forward = 0' >> /etc/sysctl.conf
            sysctl -p

            # Configure CloudWatch agent with enhanced monitoring
            cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << EOF
            {
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/log/messages",
                        "log_group_name": "${EC2LogGroup}",
                        "log_stream_name": "{instance_id}/var/log/messages"
                      },
                      {
                        "file_path": "/var/log/secure",
                        "log_group_name": "${EC2LogGroup}",
                        "log_stream_name": "{instance_id}/var/log/secure"
                      },
                      {
                        "file_path": "/var/log/audit/audit.log",
                        "log_group_name": "${EC2LogGroup}",
                        "log_stream_name": "{instance_id}/var/log/audit"
                      }
                    ]
                  }
                }
              },
              "metrics": {
                "namespace": "CWAgent",
                "metrics_collected": {
                  "cpu": {
                    "measurement": ["cpu_usage_idle", "cpu_usage_iowait", "cpu_usage_user", "cpu_usage_system"],
                    "metrics_collection_interval": 60
                  },
                  "disk": {
                    "measurement": ["used_percent"],
                    "metrics_collection_interval": 60,
                    "resources": ["*"]
                  },
                  "mem": {
                    "measurement": ["mem_used_percent"],
                    "metrics_collection_interval": 60
                  }
                }
              }
            }
            EOF

            # Start CloudWatch agent
            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config -m ec2 -s \
              -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub 'tapstack${EnvironmentSuffix}-ec2-instance-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
              - Key: Environment
                Value: Production
              - Key: Component
                Value: Compute

  # EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: $Latest
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub 'tapstack${EnvironmentSuffix}-ec2-instance-${AWS::AccountId}-${GenerateRandomSuffix.RandomSuffix}'
        - Key: Environment
          Value: Production
        - Key: Component
          Value: Compute

Outputs:
  # Random suffix for uniqueness
  RandomSuffix:
    Description: Random suffix used for resource naming
    Value: !GetAtt GenerateRandomSuffix.RandomSuffix

  # Storage outputs
  S3BucketName:
    Description: Name of the secure S3 bucket
    Value: !Ref SecureS3Bucket

  S3AccessLogsBucketName:
    Description: Name of the S3 access logs bucket
    Value: !Ref S3AccessLogsBucket

  # Compute outputs
  EC2InstanceId:
    Description: Instance ID of the EC2 instance
    Value: !Ref EC2Instance

  EC2LaunchTemplateId:
    Description: ID of the EC2 Launch Template
    Value: !Ref EC2LaunchTemplate

  # Networking outputs
  VPCId:
    Description: VPC ID
    Value: !Ref VPC

  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet

  SecurityGroupId:
    Description: Security Group ID
    Value: !Ref EC2SecurityGroup

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway

  # IAM outputs
  EC2RoleArn:
    Description: ARN of the EC2 IAM Role
    Value: !GetAtt EC2Role.Arn

  EC2InstanceProfileArn:
    Description: ARN of the EC2 Instance Profile
    Value: !GetAtt EC2InstanceProfile.Arn

  # Logging outputs
  EC2LogGroupName:
    Description: Name of the EC2 CloudWatch Log Group
    Value: !Ref EC2LogGroup

  S3LogGroupName:
    Description: Name of the S3 CloudWatch Log Group
    Value: !Ref S3LogGroup

  VPCFlowLogsGroupName:
    Description: Name of the VPC Flow Logs CloudWatch Log Group
    Value: !Ref VPCFlowLogsGroup

  # Encryption outputs
  KMSKeyId:
    Description: KMS Key ID for encryption
    Value: !Ref KMSKey

  KMSKeyAlias:
    Description: KMS Key Alias
    Value: !Ref KMSKeyAlias

  # Lambda outputs
  RandomSuffixGeneratorArn:
    Description: ARN of the Random Suffix Generator Lambda
    Value: !GetAtt RandomSuffixGenerator.Arn

  # Stack metadata
  StackName:
    Description: Name of this CloudFormation stack
    Value: !Ref AWS::StackName

  EnvironmentSuffix:
    Description: Environment suffix used for this deployment
    Value: !Ref EnvironmentSuffix

AWSTemplateFormatVersion: '2010-09-09'
Description: 'VPC Infrastructure with Public and Private Subnets across Two Availability Zones'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix
          - ProjectName
          - Owner
      - Label:
          default: 'Network Configuration'
        Parameters:
          - VpcCidr
          - PublicSubnet1Cidr
          - PublicSubnet2Cidr
          - PrivateSubnet1Cidr
          - PrivateSubnet2Cidr

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'

  ProjectName:
    Type: String
    Default: 'TapStack'
    Description: 'Project name for resource tagging'

  Owner:
    Type: String
    Default: 'DevOps Team'
    Description: 'Owner of the resources for cost tracking'

  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'CIDR block for the VPC'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  PublicSubnet1Cidr:
    Type: String
    Default: '10.0.1.0/24'
    Description: 'CIDR block for Public Subnet 1'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  PublicSubnet2Cidr:
    Type: String
    Default: '10.0.2.0/24'
    Description: 'CIDR block for Public Subnet 2'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  PrivateSubnet1Cidr:
    Type: String
    Default: '10.0.3.0/24'
    Description: 'CIDR block for Private Subnet 1'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  PrivateSubnet2Cidr:
    Type: String
    Default: '10.0.4.0/24'
    Description: 'CIDR block for Private Subnet 2'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

Resources:
  # VPC
  TapVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-VPC-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  # Internet Gateway
  TapInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-IGW-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  TapInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref TapInternetGateway
      VpcId: !Ref TapVPC

  # Public Subnets
  TapPublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TapVPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet1Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Public-Subnet-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: Type
          Value: 'Public'

  TapPublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TapVPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PublicSubnet2Cidr
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Public-Subnet-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: Type
          Value: 'Public'

  # Private Subnets
  TapPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TapVPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: !Ref PrivateSubnet1Cidr
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-Subnet-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: Type
          Value: 'Private'

  TapPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TapVPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: !Ref PrivateSubnet2Cidr
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-Subnet-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner
        - Key: Type
          Value: 'Private'

  # Elastic IPs for NAT Gateways
  TapNatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: TapInternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-NAT-EIP-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  TapNatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: TapInternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-NAT-EIP-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  # NAT Gateways
  TapNatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt TapNatGateway1EIP.AllocationId
      SubnetId: !Ref TapPublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-NAT-Gateway-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  TapNatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt TapNatGateway2EIP.AllocationId
      SubnetId: !Ref TapPublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-NAT-Gateway-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  # Route Tables
  TapPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TapVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Public-RT-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  TapPrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TapVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-RT-1-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  TapPrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TapVPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-Private-RT-2-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

  # Routes
  TapPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: TapInternetGatewayAttachment
    Properties:
      RouteTableId: !Ref TapPublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref TapInternetGateway

  TapPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref TapPrivateRouteTable1
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref TapNatGateway1

  TapPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref TapPrivateRouteTable2
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref TapNatGateway2

  # Route Table Associations
  TapPublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TapPublicRouteTable
      SubnetId: !Ref TapPublicSubnet1

  TapPublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TapPublicRouteTable
      SubnetId: !Ref TapPublicSubnet2

  TapPrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TapPrivateRouteTable1
      SubnetId: !Ref TapPrivateSubnet1

  TapPrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TapPrivateRouteTable2
      SubnetId: !Ref TapPrivateSubnet2

  # Security Group for ICMP Traffic
  TapICMPSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group allowing full ICMP traffic for troubleshooting'
      VpcId: !Ref TapVPC
      SecurityGroupIngress:
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: '0.0.0.0/0'
          Description: 'Allow all inbound ICMP traffic'
      SecurityGroupEgress:
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: '0.0.0.0/0'
          Description: 'Allow all outbound ICMP traffic'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-ICMP-SG-${EnvironmentSuffix}'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: !Ref ProjectName
        - Key: Owner
          Value: !Ref Owner

Outputs:
  VpcId:
    Description: 'ID of the VPC'
    Value: !Ref TapVPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  VpcCidr:
    Description: 'CIDR block of the VPC'
    Value: !Ref VpcCidr
    Export:
      Name: !Sub '${AWS::StackName}-VpcCidr'

  InternetGatewayId:
    Description: 'ID of the Internet Gateway'
    Value: !Ref TapInternetGateway
    Export:
      Name: !Sub '${AWS::StackName}-InternetGatewayId'

  PublicSubnet1Id:
    Description: 'ID of Public Subnet 1'
    Value: !Ref TapPublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1Id'

  PublicSubnet1AZ:
    Description: 'Availability Zone of Public Subnet 1'
    Value: !GetAtt TapPublicSubnet1.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1AZ'

  PublicSubnet2Id:
    Description: 'ID of Public Subnet 2'
    Value: !Ref TapPublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2Id'

  PublicSubnet2AZ:
    Description: 'Availability Zone of Public Subnet 2'
    Value: !GetAtt TapPublicSubnet2.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2AZ'

  PrivateSubnet1Id:
    Description: 'ID of Private Subnet 1'
    Value: !Ref TapPrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1Id'

  PrivateSubnet1AZ:
    Description: 'Availability Zone of Private Subnet 1'
    Value: !GetAtt TapPrivateSubnet1.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1AZ'

  PrivateSubnet2Id:
    Description: 'ID of Private Subnet 2'
    Value: !Ref TapPrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2Id'

  PrivateSubnet2AZ:
    Description: 'Availability Zone of Private Subnet 2'
    Value: !GetAtt TapPrivateSubnet2.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2AZ'

  NatGateway1Id:
    Description: 'ID of NAT Gateway 1'
    Value: !Ref TapNatGateway1
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway1Id'

  NatGateway1EIP:
    Description: 'Elastic IP of NAT Gateway 1'
    Value: !Ref TapNatGateway1EIP
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway1EIP'

  NatGateway2Id:
    Description: 'ID of NAT Gateway 2'
    Value: !Ref TapNatGateway2
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway2Id'

  NatGateway2EIP:
    Description: 'Elastic IP of NAT Gateway 2'
    Value: !Ref TapNatGateway2EIP
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway2EIP'

  ICMPSecurityGroupId:
    Description: 'ID of the ICMP Security Group'
    Value: !Ref TapICMPSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ICMPSecurityGroupId'

  PublicRouteTableId:
    Description: 'ID of the Public Route Table'
    Value: !Ref TapPublicRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-PublicRouteTableId'

  PrivateRouteTable1Id:
    Description: 'ID of Private Route Table 1'
    Value: !Ref TapPrivateRouteTable1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable1Id'

  PrivateRouteTable2Id:
    Description: 'ID of Private Route Table 2'
    Value: !Ref TapPrivateRouteTable2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable2Id'

  StackName:
    Description: 'Name of this CloudFormation stack'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  EnvironmentSuffix:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'
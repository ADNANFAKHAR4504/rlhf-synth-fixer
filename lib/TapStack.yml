AWSTemplateFormatVersion: '2010-09-09'
Description: 'Enterprise-ready foundational infrastructure for modern application deployment with comprehensive monitoring and security controls'

# ==========================================
# METADATA
# ==========================================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentName
          - EnvironmentType
      - Label:
          default: "Network Configuration"
        Parameters:
          - VPCCIDR
          - AllowedSSHIP
      - Label:
          default: "Compute Configuration"
        Parameters:
          - KeyPairName
          - InstanceType
          - EnableDetailedMonitoring
      - Label:
          default: "Alerting Configuration"
        Parameters:
          - AlertEmail
          - CPUAlarmThreshold
    ParameterLabels:
      EnvironmentName:
        default: "Environment Name"
      AllowedSSHIP:
        default: "Allowed SSH Source IP CIDR"

# ==========================================
# PARAMETERS
# ==========================================
Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: 'production'
    AllowedValues:
      - development
      - staging
      - production
    AllowedPattern: '^[a-z0-9][a-z0-9-]*[a-z0-9]$'
    ConstraintDescription: Must be lowercase alphanumeric with hyphens
  
  EnvironmentType:
    Description: Environment type for resource sizing and configuration
    Type: String
    Default: 'production'
    AllowedValues:
      - development
      - staging
      - production
  
  KeyPairName:
    Description: EC2 Key Pair for SSH access (leave empty to skip SSH key configuration)
    Type: String
    Default: ''
  
  InstanceType:
    Description: EC2 instance type for the web server
    Type: String
    Default: 't3.micro'
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
    ConstraintDescription: Must be a valid EC2 instance type
  
  VPCCIDR:
    Description: CIDR block for the VPC
    Type: String
    Default: '10.0.0.0/16'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/16$'
    ConstraintDescription: Must be a valid /16 CIDR block
  
  AllowedSSHIP:
    Description: IP address range that can SSH to the EC2 instances (use your IP/32 for production)
    Type: String
    Default: '10.0.0.0/16'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/(3[0-2]|[1-2][0-9]|[0-9])$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x
  
  AlertEmail:
    Description: Email address for CloudWatch alarm notifications
    Type: String
    Default: 'alerts@example.com'
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: Must be a valid email address
  
  EnableDetailedMonitoring:
    Description: Enable detailed CloudWatch monitoring for EC2 instance
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
  
  CPUAlarmThreshold:
    Description: CPU utilization threshold for CloudWatch alarm (percentage)
    Type: Number
    Default: 80
    MinValue: 50
    MaxValue: 100
    ConstraintDescription: Must be between 50 and 100


# ==========================================
# CONDITIONS
# ==========================================
Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]
  IsProduction: !Equals [!Ref EnvironmentType, 'production']
  EnableMonitoring: !Equals [!Ref EnableDetailedMonitoring, 'true']

# ==========================================
# MAPPINGS
# ==========================================
Mappings:
  SubnetConfig:
    VPC:
      CIDR: '10.0.0.0/16'
    PublicSubnet1:
      CIDR: '10.0.1.0/24'
    PublicSubnet2:
      CIDR: '10.0.2.0/24'
  
  EnvironmentConfig:
    development:
      InstanceType: 't3.micro'
      EBSVolumeSize: 10
      LogRetention: 7
    staging:
      InstanceType: 't3.small'
      EBSVolumeSize: 20
      LogRetention: 14
    production:
      InstanceType: 't3.medium'
      EBSVolumeSize: 30
      LogRetention: 30

Resources:
  # ==========================================
  # NETWORKING INFRASTRUCTURE
  # ==========================================
  
  # Virtual Private Cloud - Main network boundary
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-VPC'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: ManagedBy
          Value: 'CloudFormation'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Internet Gateway for public internet access
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-IGW'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: iac-rlhf-amazon
          Value: 'true'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnet in First Availability Zone
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet1, CIDR]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Subnet-AZ1'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: Type
          Value: 'Public'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Public Subnet in Second Availability Zone
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet2, CIDR]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Subnet-AZ2'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: Type
          Value: 'Public'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Route Table for Public Subnets
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Public-Routes'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Default route to Internet Gateway
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  # ==========================================
  # SECURITY GROUPS
  # ==========================================
  
  # Security Group for Web Server with controlled access
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-WebServer-SG'
      GroupDescription: Security group for web server with HTTP and controlled SSH access
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTP traffic from anywhere'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTPS traffic from anywhere'
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHIP
          Description: !Sub 'Allow SSH traffic from ${AllowedSSHIP}'
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: '0.0.0.0/0'
          Description: 'Allow all outbound traffic'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-SG'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # ==========================================
  # IAM ROLES AND POLICIES
  # ==========================================
  
  # IAM Role for EC2 instances with S3 and CloudWatch access
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-${AWS::Region}-EC2-S3-Role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'  # For Session Manager access
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                  - 's3:GetBucketVersioning'
                Resource:
                  - !GetAtt GeneralPurposeBucket.Arn
                  - !Sub '${GeneralPurposeBucket.Arn}/*'
                  - !GetAtt LoggingBucket.Arn
                  - !Sub '${LoggingBucket.Arn}/*'
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogStreams'
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${EnvironmentName}/*'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-EC2-Role'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Infrastructure'
        - Key: iac-rlhf-amazon
          Value: 'true'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${EnvironmentName}-${AWS::Region}-EC2-Instance-Profile'
      Roles:
        - !Ref EC2Role

  # ==========================================
  # S3 STORAGE BUCKETS
  # ==========================================
  
  # General Purpose S3 Bucket with versioning and encryption
  GeneralPurposeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-general-purpose-${AWS::AccountId}-${AWS::Region}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: !If [IsProduction, 90, 30]
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: !If [IsProduction, 60, 30]
                StorageClass: STANDARD_IA
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-General-Purpose-Bucket'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Storage'
        - Key: Purpose
          Value: 'General'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Dedicated Logging Bucket with retention policies
  LoggingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-logging-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: !FindInMap [EnvironmentConfig, !Ref EnvironmentType, LogRetention]
          - Id: TransitionOldLogs
            Status: Enabled
            Transitions:
              - TransitionInDays: 7
                StorageClass: GLACIER
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Logging-Bucket'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Storage'
        - Key: Purpose
          Value: 'Logging'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Bucket Policy enforcing secure transport
  LoggingBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref LoggingBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowSSLRequestsOnly
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt LoggingBucket.Arn
              - !Sub '${LoggingBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: AllowCloudWatchLogs
            Effect: Allow
            Principal:
              Service: logs.amazonaws.com
            Action:
              - 's3:GetBucketAcl'
              - 's3:PutObject'
            Resource:
              - !GetAtt LoggingBucket.Arn
              - !Sub '${LoggingBucket.Arn}/*'

  # ==========================================
  # EC2 COMPUTE RESOURCES
  # ==========================================
  
  # Web Server EC2 Instance with enhanced configuration
  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-12345678
      InstanceType: !Ref InstanceType
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      IamInstanceProfile: !Ref EC2InstanceProfile
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !FindInMap [EnvironmentConfig, !Ref EnvironmentType, EBSVolumeSize]
            VolumeType: gp3
            Encrypted: true
            DeleteOnTermination: true
            Iops: 3000
      Monitoring: !If [EnableMonitoring, true, false]
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
                #!/bin/bash
                # Update and install basic packages
                yum update -y
                yum install -y httpd aws-cfn-bootstrap
                
                # Start and enable httpd
                systemctl start httpd
                systemctl enable httpd
                
                # Create basic web page
                cat > /var/www/html/index.html << EOF
                <!DOCTYPE html>
                <html>
                <head><title>${EnvironmentName} Infrastructure</title></head>
                <body>
                  <h1>Enterprise Application Server - ${EnvironmentName}</h1>
                  <p>Region: ${AWS::Region}</p>
                  <p>Instance ID: $(ec2-metadata --instance-id | cut -d " " -f 2)</p>
                  <p>Availability Zone: $(ec2-metadata --availability-zone | cut -d " " -f 2)</p>
                </body>
                </html>
                EOF
                
                # Install and configure CloudWatch agent
                wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
                rpm -U ./amazon-cloudwatch-agent.rpm
                
                # Create CloudWatch agent configuration
                cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << EOF
                {
                  "metrics": {
                    "namespace": "${EnvironmentName}/Application",
                    "metrics_collected": {
                      "cpu": {
                        "measurement": [{"name": "cpu_usage_idle", "rename": "CPU_IDLE", "unit": "Percent"}],
                        "totalcpu": false,
                        "metrics_collection_interval": 60
                      },
                      "disk": {
                        "measurement": [{"name": "used_percent", "rename": "DISK_USED", "unit": "Percent"}],
                        "metrics_collection_interval": 60,
                        "resources": ["/"]
                      },
                      "mem": {
                        "measurement": [{"name": "mem_used_percent", "rename": "MEM_USED", "unit": "Percent"}],
                        "metrics_collection_interval": 60
                      }
                    }
                  },
                  "logs": {
                    "logs_collected": {
                      "files": {
                        "collect_list": [
                          {
                            "file_path": "/var/log/httpd/access_log",
                            "log_group_name": "/aws/ec2/${EnvironmentName}/httpd",
                            "log_stream_name": "{instance_id}/access_log",
                            "retention_in_days": ${LogRetentionDays}
                          },
                          {
                            "file_path": "/var/log/httpd/error_log",
                            "log_group_name": "/aws/ec2/${EnvironmentName}/httpd",
                            "log_stream_name": "{instance_id}/error_log",
                            "retention_in_days": ${LogRetentionDays}
                          }
                        ]
                      }
                    }
                  }
                }
                EOF
                
                # Start CloudWatch agent
                /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
                  -a fetch-config -m ec2 -s \
                  -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
                
                # Signal CloudFormation that the instance is ready
                /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} \
                  --resource WebServerInstance --region ${AWS::Region}
            - { LogRetentionDays: !FindInMap [EnvironmentConfig, !Ref EnvironmentType, LogRetention] }
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Compute'
        - Key: Application
          Value: 'WebServer'
        - Key: Backup
          Value: !If [IsProduction, 'Required', 'Optional']
        - Key: iac-rlhf-amazon
          Value: 'true'

  # Elastic IP for consistent public endpoint
  ElasticIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      InstanceId: !Ref WebServerInstance
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-WebServer-EIP'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: CostCenter
          Value: 'Network'
        - Key: iac-rlhf-amazon
          Value: 'true'

  # ==========================================
  # MONITORING AND ALERTING
  # ==========================================
  
  # SNS Topic for alarm notifications
  AlarmNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${EnvironmentName}-Alarms'
      DisplayName: !Sub '${EnvironmentName} Infrastructure Alarms'
      Subscription:
        - Endpoint: !Ref AlertEmail
          Protocol: email
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-Alarm-Topic'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: iac-rlhf-amazon
          Value: 'true'

  # CloudWatch Alarm for high CPU utilization
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${EnvironmentName}-WebServer-HighCPU'
      AlarmDescription: !Sub 'Alert when CPU utilization exceeds ${CPUAlarmThreshold}%'
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: !Ref CPUAlarmThreshold
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref WebServerInstance
      AlarmActions:
        - !Ref AlarmNotificationTopic
      OKActions:
        - !Ref AlarmNotificationTopic
      TreatMissingData: notBreaching

  # Additional alarm for high memory utilization
  HighMemoryAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableMonitoring
    Properties:
      AlarmName: !Sub '${EnvironmentName}-WebServer-HighMemory'
      AlarmDescription: 'Alert when memory utilization exceeds 90%'
      MetricName: MEM_USED
      Namespace: !Sub '${EnvironmentName}/Application'
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 90
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref WebServerInstance
      AlarmActions:
        - !Ref AlarmNotificationTopic
      TreatMissingData: notBreaching

  # Alarm for disk space utilization
  HighDiskUsageAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: EnableMonitoring
    Properties:
      AlarmName: !Sub '${EnvironmentName}-WebServer-HighDiskUsage'
      AlarmDescription: 'Alert when disk utilization exceeds 85%'
      MetricName: DISK_USED
      Namespace: !Sub '${EnvironmentName}/Application'
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 85
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref WebServerInstance
      AlarmActions:
        - !Ref AlarmNotificationTopic
      TreatMissingData: notBreaching

  # ==========================================
  # CLOUDWATCH LOG GROUPS
  # ==========================================
  
  # Log Group for Application Logs
  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/ec2/${EnvironmentName}/application'
      RetentionInDays: !FindInMap [EnvironmentConfig, !Ref EnvironmentType, LogRetention]

  # Log Group for HTTP Access Logs
  HTTPLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/ec2/${EnvironmentName}/httpd'
      RetentionInDays: !FindInMap [EnvironmentConfig, !Ref EnvironmentType, LogRetention]

  # Log Stream for exporting to S3
  LogsToS3DeliveryStream:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamType: DirectPut
      ExtendedS3DestinationConfiguration:
        BucketARN: !GetAtt LoggingBucket.Arn
        Prefix: 'cloudwatch-logs/'
        CompressionFormat: GZIP
        RoleARN: !GetAtt FirehoseDeliveryRole.Arn

  LogsToS3ExportTask:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      LogGroupName: !Ref HTTPLogGroup
      FilterPattern: ''
      DestinationArn: !GetAtt LogsToS3DeliveryStream.Arn
      RoleArn: !GetAtt LogsRole.Arn

  # IAM Role for CloudWatch Logs to write to S3
  LogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: logs.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: LogsToFirehosePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'firehose:PutRecord'
                  - 'firehose:PutRecordBatch'
                Resource: !GetAtt LogsToS3DeliveryStream.Arn
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'

  FirehoseDeliveryRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: firehose.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: FirehoseS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:AbortMultipartUpload'
                  - 's3:GetBucketLocation'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                  - 's3:ListBucketMultipartUploads'
                  - 's3:PutObject'
                Resource:
                  - !GetAtt LoggingBucket.Arn
                  - !Sub '${LoggingBucket.Arn}/*'
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'

# ==========================================
# OUTPUTS - Comprehensive stack information
# ==========================================

Outputs:
  VPCId:
    Description: VPC ID for the enterprise infrastructure
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  VPCCIDR:
    Description: VPC CIDR block
    Value: !Ref VPCCIDR
    Export:
      Name: !Sub '${AWS::StackName}-VPC-CIDR'

  PublicSubnet1Id:
    Description: Public Subnet 1 ID in first Availability Zone
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1-ID'

  PublicSubnet1AZ:
    Description: Availability Zone of Public Subnet 1
    Value: !GetAtt PublicSubnet1.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1-AZ'

  PublicSubnet2Id:
    Description: Public Subnet 2 ID in second Availability Zone
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2-ID'

  PublicSubnet2AZ:
    Description: Availability Zone of Public Subnet 2
    Value: !GetAtt PublicSubnet2.AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2-AZ'

  EC2InstanceId:
    Description: EC2 Instance ID of the web server
    Value: !Ref WebServerInstance
    Export:
      Name: !Sub '${AWS::StackName}-EC2Instance-ID'

  EC2InstancePrivateIP:
    Description: Private IP address of the EC2 instance
    Value: !GetAtt WebServerInstance.PrivateIp
    Export:
      Name: !Sub '${AWS::StackName}-EC2Instance-PrivateIP'

  ElasticIPAddress:
    Description: Elastic IP address of the web server
    Value: !Ref ElasticIP
    Export:
      Name: !Sub '${AWS::StackName}-ElasticIP'

  WebServerURL:
    Description: URL to access the web server
    Value: !Sub 'http://${ElasticIP}'
    Export:
      Name: !Sub '${AWS::StackName}-WebServerURL'

  SSHCommand:
    Description: SSH command to connect to the instance
    Value: !If 
      - HasKeyPair
      - !Sub 'ssh -i ${KeyPairName}.pem ec2-user@${ElasticIP}'
      - 'SSH key not configured - use Session Manager'

  GeneralPurposeBucketName:
    Description: Name of the general purpose S3 bucket
    Value: !Ref GeneralPurposeBucket
    Export:
      Name: !Sub '${AWS::StackName}-GeneralPurposeBucket'

  GeneralPurposeBucketArn:
    Description: ARN of the general purpose S3 bucket
    Value: !GetAtt GeneralPurposeBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-GeneralPurposeBucket-ARN'

  LoggingBucketName:
    Description: Name of the logging S3 bucket
    Value: !Ref LoggingBucket
    Export:
      Name: !Sub '${AWS::StackName}-LoggingBucket'

  LoggingBucketArn:
    Description: ARN of the logging S3 bucket
    Value: !GetAtt LoggingBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LoggingBucket-ARN'

  SecurityGroupId:
    Description: Security Group ID for the web server
    Value: !Ref WebServerSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroup-ID'

  IAMRoleArn:
    Description: ARN of the IAM role for EC2 instances
    Value: !GetAtt EC2Role.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2Role-ARN'

  IAMRoleName:
    Description: Name of the IAM role for EC2 instances
    Value: !Ref EC2Role
    Export:
      Name: !Sub '${AWS::StackName}-EC2Role-Name'

  SNSTopicArn:
    Description: ARN of the SNS topic for alarms
    Value: !Ref AlarmNotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-SNSTopic-ARN'

  ApplicationLogGroupName:
    Description: CloudWatch Log Group for application logs
    Value: !Ref ApplicationLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-AppLogGroup'

  HTTPLogGroupName:
    Description: CloudWatch Log Group for HTTP logs
    Value: !Ref HTTPLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-HTTPLogGroup'

  StackRegion:
    Description: AWS Region where the stack is deployed
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'

  StackName:
    Description: Name of this CloudFormation stack
    Value: !Ref AWS::StackName

  AccountId:
    Description: AWS Account ID
    Value: !Ref AWS::AccountId
    Export:
      Name: !Sub '${AWS::StackName}-AccountId'
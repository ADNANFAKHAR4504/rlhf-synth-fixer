AWSTemplateFormatVersion: '2010-09-09'
Description: 'TAP Stack - Task Assignment Platform CloudFormation Template'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'

Resources:
  # DynamoDB Table (existing)
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub 'TurnAroundPromptTable${EnvironmentSuffix}'
      AttributeDefinitions:
        - AttributeName: 'id'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'id'
          KeyType: 'HASH'
      BillingMode: PAY_PER_REQUEST
      DeletionProtectionEnabled: false
      # Tags will be applied at stack level during deployment

  # S3 Bucket for testing IAM policies
  TestS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      BucketName: !Sub 'tap-test-bucket-${EnvironmentSuffix}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # IAM Role for EC2 Instances with S3 Read-Only Access
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'EC2S3ReadOnlyRole${EnvironmentSuffix}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3ReadOnlyAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:ListBucket
                  - s3:ListBucketVersions
                  - s3:GetBucketLocation
                Resource: 
                  - !Sub '${TestS3Bucket}/*'
                  - !Ref TestS3Bucket
              - Effect: Deny
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:CreateBucket
                  - s3:DeleteBucket
                  - s3:PutBucketPolicy
                  - s3:DeleteBucketPolicy
                Resource: '*'

  # Instance Profile for EC2 Role
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub 'EC2S3ReadOnlyInstanceProfile${EnvironmentSuffix}'
      Roles:
        - !Ref EC2InstanceRole

  # Test IAM User for specific S3 bucket access
  TestIAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub 'TestS3ReadOnlyUser${EnvironmentSuffix}'
      
  # IAM Policy for Specific S3 Bucket Read-Only Access
  S3SpecificBucketReadOnlyPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'S3SpecificBucketReadOnly${EnvironmentSuffix}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:ListBucket
              - s3:ListBucketVersions
              - s3:GetBucketLocation
            Resource:
              - !Sub '${TestS3Bucket}/*'
              - !Ref TestS3Bucket
      Users:
        - !Ref TestIAMUser

Outputs:
  TurnAroundPromptTableName:
    Description: 'Name of the DynamoDB table'
    Value: !Ref TurnAroundPromptTable
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableName'

  TurnAroundPromptTableArn:
    Description: 'ARN of the DynamoDB table'
    Value: !GetAtt TurnAroundPromptTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableArn'

  TestS3BucketName:
    Description: 'Name of the test S3 bucket'
    Value: !Ref TestS3Bucket
    Export:
      Name: !Sub '${AWS::StackName}-TestS3BucketName'

  TestS3BucketArn:
    Description: 'ARN of the test S3 bucket'
    Value: !GetAtt TestS3Bucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TestS3BucketArn'

  EC2InstanceRoleArn:
    Description: 'ARN of the EC2 instance role with S3 read-only access'
    Value: !GetAtt EC2InstanceRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2InstanceRoleArn'

  EC2InstanceProfileArn:
    Description: 'ARN of the EC2 instance profile'
    Value: !GetAtt EC2InstanceProfile.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2InstanceProfileArn'

  TestIAMUserArn:
    Description: 'ARN of the test IAM user'
    Value: !GetAtt TestIAMUser.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TestIAMUserArn'

  S3SpecificBucketReadOnlyPolicyArn:
    Description: 'ARN of the S3 specific bucket read-only policy'
    Value: !Ref S3SpecificBucketReadOnlyPolicy
    Export:
      Name: !Sub '${AWS::StackName}-S3SpecificBucketReadOnlyPolicyArn'

  StackName:
    Description: 'Name of this CloudFormation stack'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  EnvironmentSuffix:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

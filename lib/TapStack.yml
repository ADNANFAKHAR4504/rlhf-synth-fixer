AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AWS CloudFormation template to deploy a highly available web application.
  This solution uses an Application Load Balancer, an Auto Scaling Group
  with dynamic scaling policies, and an S3 bucket for logging with a lifecycle
  policy to transition logs to Glacier after 30 days for cost optimization.

Parameters:
  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of your existing VPC.
  SubnetId1:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of a subnet in Availability Zone 1.
  SubnetId2:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of a subnet in Availability Zone 2.
  InstanceType:
    Description: EC2 instance type for the web servers.
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
  LatestAmiId:
    Description: The latest Amazon Linux 2 AMI ID.
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-2/latest/amzn2-ami-hvm-x86_64-gp2'

Resources:
  # -----------------------------------------------------------------------
  # 1. Security Groups
  # -----------------------------------------------------------------------
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: WebAppSecurityGroup
      GroupDescription: Enable HTTP/HTTPS and SSH access to the web servers.
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !GetAtt LoadBalancerSecurityGroup.GroupId
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: LoadBalancerSecurityGroup
      GroupDescription: Enable HTTP/HTTPS access to the Application Load Balancer.
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  # -----------------------------------------------------------------------
  # 2. S3 Bucket for Logging
  # -----------------------------------------------------------------------
  WebAppLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "webapp-logs-${AWS::AccountId}-${AWS::Region}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: MoveToGlacier
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: GLACIER

  # Add a policy to the S3 bucket to allow the ELB to write logs
  S3BucketPolicyForELBAccessLogs:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebAppLogBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Changed Principal to use a regionalized service principal, which is more robust
          # and avoids the "endpoint" validation error.
          - Effect: Allow
            Principal:
              Service: !Sub 'elb.${AWS::Region}.amazonaws.com'
            Action: 's3:PutObject'
            Resource: !Sub '${WebAppLogBucket.Arn}/AWSLogs/${AWS::AccountId}/*'

  # -----------------------------------------------------------------------
  # 3. EC2 Launch Template & Auto Scaling
  # -----------------------------------------------------------------------
  WebServerLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: WebAppLaunchTemplate
      LaunchTemplateData:
        ImageId: !Ref LatestAmiId
        InstanceType: !Ref InstanceType
        SecurityGroupIds:
          - !GetAtt WebServerSecurityGroup.GroupId
        UserData: !Base64 |
          #!/bin/bash -xe
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<html><body><h1>Hello from a highly available web server!</h1></body></html>" > /var/www/html/index.html

  WebAppAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: WebAppAutoScalingGroup
      VPCZoneIdentifier:
        - !Ref SubnetId1
        - !Ref SubnetId2
      LaunchTemplate:
        LaunchTemplateId: !Ref WebServerLaunchTemplate
        Version: !GetAtt WebServerLaunchTemplate.DefaultVersionNumber
      MinSize: '2'
      MaxSize: '10'
      DesiredCapacity: '2'
      TargetGroupARNs:
        - !Ref LoadBalancerTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300

  # -----------------------------------------------------------------------
  # 4. Application Load Balancer & Listener
  # -----------------------------------------------------------------------
  WebAppLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: WebAppLoadBalancer
      Subnets:
        - !Ref SubnetId1
        - !Ref SubnetId2
      SecurityGroups:
        - !GetAtt LoadBalancerSecurityGroup.GroupId
      # Enable access logs and point to the S3 bucket with a prefix
      LoadBalancerAttributes:
        - Key: access_logs.s3.enabled
          Value: 'true'
        - Key: access_logs.s3.bucket
          Value: !Ref WebAppLogBucket
        - Key: access_logs.s3.prefix
          Value: !Sub 'AWSLogs/${AWS::AccountId}/'

  LoadBalancerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: WebAppTargetGroup
      VpcId: !Ref VPCId
      Port: 80
      Protocol: HTTP
      HealthCheckEnabled: true
      HealthCheckPath: /
      HealthyThresholdCount: 5
      UnhealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'

  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref WebAppLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref LoadBalancerTargetGroup

  # -----------------------------------------------------------------------
  # 5. Scaling Policies and Alarms
  # -----------------------------------------------------------------------
  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WebAppAutoScalingGroup
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: 2
      Cooldown: 300

  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WebAppAutoScalingGroup
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: -1
      Cooldown: 300

  CPUHighAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Alarm to add more instances when CPU is high.
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebAppAutoScalingGroup
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 70
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref ScaleUpPolicy

  CPULowAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Alarm to remove instances when CPU is low.
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WebAppAutoScalingGroup
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 30
      ComparisonOperator: LessThanOrEqualToThreshold
      AlarmActions:
        - !Ref ScaleDownPolicy

Outputs:
  WebsiteURL:
    Description: The URL for the highly available web application.
    Value: !GetAtt WebAppLoadBalancer.DNSName
  WebAppLogBucketName:
    Description: The name of the S3 bucket used for logs.
    Value: !Ref WebAppLogBucket
  AutoScalingGroupName:
    Description: The name of the Auto Scaling Group.
    Value: !Ref WebAppAutoScalingGroup
  LoadBalancerSecurityGroupId:
    Description: The ID of the Security Group for the Load Balancer.
    Value: !Ref LoadBalancerSecurityGroup
  WebServerSecurityGroupId:
    Description: The ID of the Security Group for the web servers.
    Value: !Ref WebServerSecurityGroup

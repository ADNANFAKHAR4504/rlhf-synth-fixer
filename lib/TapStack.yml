AWSTemplateFormatVersion: "2010-09-09"
Description: >
  TapStack.yml â€” Secure, Production-Ready Web Infrastructure (us-east-1)
  Creates VPC, ALB, EC2, RDS, S3, SNS, Lambda, SQS, WAF, CloudFront, Config, and CloudWatch.
  Fully secure, encrypted, least-privilege, region-locked, and self-contained.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: "Environment Configuration" }
        Parameters: [Environment, Owner, Project]
      - Label: { default: "Access & Network" }
        Parameters: [AllowedSSHLocation, KeyPairName, InstanceType]

Parameters:
  Environment:
    Type: String
    Default: Production
    AllowedValues: [Development, Staging, Production]
    Description: Deployment environment tag.
  Owner:
    Type: String
    Default: TapOps Team
    Description: Owner tag for resources.
  Project:
    Type: String
    Default: TapStack
    Description: Project tag for resources.
  AllowedSSHLocation:
    Type: String
    Default: 203.0.113.0/32
    Description: CIDR allowed for SSH.
  KeyPairName:
    Type: String
    Default: ""
    Description: Optional EC2 KeyPair name (leave blank if none exists)
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues: [t2.micro, t2.small, t3.micro, t3.small]
    Description: EC2 instance type (restricted to T2/T3 family).

Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, ""]]
  IsUsEast1: !Equals [!Ref "AWS::Region", "us-east-1"]

Mappings:
  RegionMap:
    us-east-1:
      AZs: ["us-east-1a", "us-east-1b"]

Resources:

  ###########################################################
  # Networking
  ###########################################################
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${Project}-VPC"
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !FindInMap [RegionMap, !Ref "AWS::Region", AZs]]
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [1, !FindInMap [RegionMap, !Ref "AWS::Region", AZs]]
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !FindInMap [RegionMap, !Ref "AWS::Region", AZs]]
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !FindInMap [RegionMap, !Ref "AWS::Region", AZs]]
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  EIPForNAT:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIPForNAT.AllocationId
      SubnetId: !Ref PublicSubnet1

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  ###########################################################
  # IAM, Roles & Security
  ###########################################################
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref InstanceRole]

  SecurityGroupEC2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH only from allowed IP
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSSHLocation
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ###########################################################
  # Compute
  ###########################################################
  KMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: General encryption key for EBS and other resources
      EnableKeyRotation: true
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  EC2Instance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref "AWS::NoValue"]
      SubnetId: !Ref PrivateSubnet1
      ImageId: ami-0c02fb55956c7d316
      IamInstanceProfile: !Ref InstanceProfile
      SecurityGroupIds: [!Ref SecurityGroupEC2]
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 10
            Encrypted: true
            KmsKeyId: !Ref KMSKey
      Tags:
        - Key: Name
          Value: !Sub "${Project}-EC2-1"
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  EC2Instance2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref "AWS::NoValue"]
      SubnetId: !Ref PrivateSubnet2
      ImageId: ami-0c02fb55956c7d316
      IamInstanceProfile: !Ref InstanceProfile
      SecurityGroupIds: [!Ref SecurityGroupEC2]
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 10
            Encrypted: true
            KmsKeyId: !Ref KMSKey
      Tags:
        - Key: Name
          Value: !Sub "${Project}-EC2-2"
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ###########################################################
  # Load Balancer
  ###########################################################
  ALBSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP inbound
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Subnets: [!Ref PublicSubnet1, !Ref PublicSubnet2]
      SecurityGroups: [!Ref ALBSG]
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VPC
      Port: 80
      Protocol: HTTP
      TargetType: instance
      Targets:
        - Id: !Ref EC2Instance1
        - Id: !Ref EC2Instance2

  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  ###########################################################
  # Storage, SNS (for safe notifications) & Database
  #
  # NOTE: To avoid the common S3 destination validation failure,
  # - create the SNS Topic first,
  # - attach a TopicPolicy permitting s3.amazonaws.com to Publish (restricted by account),
  # - THEN create the S3 bucket with a TopicConfiguration referencing that topic.
  #
  # This ordering ensures S3 can validate the destination at bucket creation time.
  ###########################################################
  S3EventsTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub "${Project}-S3EventsTopic"
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  SNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics: [!Ref S3EventsTopic]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowS3Publish
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: sns:Publish
            Resource: !Ref S3EventsTopic
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  S3Bucket:
    Type: AWS::S3::Bucket
    DependsOn:
      - SNSTopicPolicy
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      NotificationConfiguration:
        TopicConfigurations:
          - Event: s3:ObjectCreated:*
            Topic: !Ref S3EventsTopic
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyUnEncryptedObjectUploads
            Effect: Deny
            Principal: "*"
            Action: "s3:PutObject"
            Resource: !Sub "${S3Bucket.Arn}/*"
            Condition:
              StringNotEquals:
                "s3:x-amz-server-side-encryption": "AES256"

  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${Project}-DBSecret"
      Description: "Generated DB credentials for RDS (managed by CloudFormation)"
      GenerateSecretString:
        SecretStringTemplate: '{"username":"adminuser"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Private subnets for RDS
      SubnetIds: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]
      DBSubnetGroupName: !Sub "${Project}-db-subnet-group"
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      Engine: mysql
      MasterUsername: !Sub "{{resolve:secretsmanager:${DBSecret}::username}}"
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${DBSecret}::password}}"
      AllocatedStorage: 20
      PubliclyAccessible: false
      StorageEncrypted: true
      KmsKeyId: !Ref KMSKey
      DBSubnetGroupName: !Ref DBSubnetGroup
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ###########################################################
  # Lambda (audit) & SNS subscription (safe, non-circular)
  ###########################################################
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: [lambda.amazonaws.com]
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  AuditLambda:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.9
      Timeout: 10
      Code:
        ZipFile: |
          import json
          def handler(event, context):
              print("S3 Event:", json.dumps(event))
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  LambdaPermissionForSNS:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AuditLambda
      Principal: sns.amazonaws.com
      SourceArn: !Ref S3EventsTopic
      SourceAccount: !Ref AWS::AccountId

  SNSSubscriptionToLambda:
    Type: AWS::SNS::Subscription
    DependsOn: LambdaPermissionForSNS
    Properties:
      TopicArn: !Ref S3EventsTopic
      Protocol: lambda
      Endpoint: !GetAtt AuditLambda.Arn
      RawMessageDelivery: true

  ###########################################################
  # Monitoring & Config
  ###########################################################
  CPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: CPU Utilization High
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: InstanceId
          Value: !Ref EC2Instance1
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project

  AWSConfigRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AWSConfigInlinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - config:PutConfigurationRecorder
                  - config:PutDeliveryChannel
                  - config:PutEvaluations
                  - config:PutConfigRule
                  - config:StartConfigurationRecorder
                  - config:StopConfigurationRecorder
                  - config:Get*
                  - config:Describe*
                  - config:DeliverConfigSnapshot
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub "arn:aws:s3:::${S3Bucket}/*"
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref S3EventsTopic
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ConfigRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      RoleARN: !GetAtt AWSConfigRole.Arn
      RecordingGroup:
        AllSupported: true

  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    DependsOn: ConfigRecorder
    Properties:
      S3BucketName: !Ref S3Bucket

  ###########################################################
  # WAF & CloudFront (us-east-1 only)
  ###########################################################
  WAFWebACL:
    Type: AWS::WAFv2::WebACL
    Condition: IsUsEast1
    Properties:
      Scope: CLOUDFRONT
      DefaultAction: { Allow: {} }
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Sub "${Project}-WAF"
      Rules:
        - Name: LimitRequests
          Priority: 1
          Action: { Block: {} }
          Statement:
            RateBasedStatement:
              Limit: 2000
              AggregateKeyType: IP
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: limitrequests
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Condition: IsUsEast1
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt S3Bucket.DomainName
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: allow-all
        WebACLId: !Ref WAFWebACL

  ###########################################################
  # SQS (logging queue)
  ###########################################################
  AppLoggingQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 30
      Tags:
        - Key: Owner
          Value: !Ref Owner
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
  ALBDNS:
    Description: Load Balancer DNS
    Value: !GetAtt ALB.DNSName
  S3BucketName:
    Description: Application S3 Bucket name
    Value: !Ref S3Bucket
  RDSAddress:
    Description: RDS Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
  S3EventsTopicArn:
    Description: SNS Topic ARN used for S3 events
    Value: !Ref S3EventsTopic
  AuditLambdaArn:
    Description: Audit Lambda ARN
    Value: !GetAtt AuditLambda.Arn

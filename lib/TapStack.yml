AWSTemplateFormatVersion: '2010-09-09'
Description: 'A comprehensive, multi-region secure baseline for the Nova application, designed for AWS CloudFormation StackSets. Deploys to us-east-1 and us-west-2.'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Application Environment Configuration'
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod).'
    ConstraintDescription: 'Must be one of: dev, staging, or prod.'

Mappings:
  RegionAMIMap:
    us-east-1:
      AMI: 'ami-0c55b159cbfafe1f0' # Amazon Linux 2 AMI in us-east-1
    us-west-2:
      AMI: 'ami-0892d3c7ee95c038d' # Amazon Linux 2 AMI in us-west-2

Resources:
  # ============================================
  # Networking Stack (VPC, Subnet, etc.)
  # ============================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub 'Nova-VPC-${AWS::Region}'
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref RouteTable

  # ============================================
  # KMS, IAM, and S3 Resources
  # ============================================
  NovaKMSKey:
    Type: 'AWS::KMS::Key'
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Description: !Sub 'KMS key for Nova application encryption in ${AWS::Region}'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AllowAdminsToManageKey'
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  NovaKMSKeyAlias:
    Type: 'AWS::KMS::Alias'
    Properties:
      AliasName: 'alias/nova-app-key'
      TargetKeyId: !Ref NovaKMSKey

  EC2AppRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: 'ec2.amazonaws.com' }
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: 'NovaAppLeastPrivilegePolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: 'S3ReadOnlyAccess'
                Effect: Allow
                Action: ['s3:GetObject', 's3:ListBucket']
                Resource:
                  - !GetAtt NovaDataBucket.Arn
                  - !Sub '${NovaDataBucket.Arn}/*'
              - Sid: 'CloudWatchLogsAccess'
                Effect: Allow
                Action:
                  [
                    'logs:CreateLogGroup',
                    'logs:CreateLogStream',
                    'logs:PutLogEvents',
                  ]
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/nova-app*:*'
              # FIX: Permissions for the role to use the KMS key are now defined here.
              # This breaks the circular dependency.
              - Sid: 'KMSAccess'
                Effect: Allow
                Action:
                  - 'kms:Decrypt'
                  - 'kms:GenerateDataKey'
                Resource: !GetAtt NovaKMSKey.Arn
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  EC2InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Roles:
        - !Ref EC2AppRole

  NovaDataBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'nova-data-bucket-${AWS::AccountId}-${AWS::Region}-${EnvironmentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt NovaKMSKey.Arn
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  # ============================================
  # Compute and Security Group Resources
  # ============================================
  NovaSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for Nova application EC2 instances'
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  NovaEC2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't3.micro'
      ImageId: !FindInMap [RegionAMIMap, !Ref 'AWS::Region', AMI]
      IamInstanceProfile: !Ref EC2InstanceProfile
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !GetAtt NovaSecurityGroup.GroupId
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 20
            Encrypted: true
            KmsKeyId: !Ref NovaKMSKey
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y
          yum install -y amazon-cloudwatch-agent
          cat > /opt/aws/amazon-cloudwatch-agent/etc/config.json << EOF
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "/aws/ec2/nova-app-${EnvironmentSuffix}",
                      "log_stream_name": "{instance_id}"
                    }
                  ]
                }
              }
            }
          }
          EOF
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json -s
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  # ============================================
  # AWS Config Compliance Resources
  # ============================================
  ConfigRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: 'config.amazonaws.com' }
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSConfigRole'
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  ConfigBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub 'config-bucket-${AWS::AccountId}-${AWS::Region}-${EnvironmentSuffix}'
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  ConfigBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref ConfigBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AWSConfigBucketPermissionsCheck'
            Effect: Allow
            Principal: { Service: 'config.amazonaws.com' }
            Action: 's3:GetBucketAcl'
            Resource: !GetAtt ConfigBucket.Arn
          - Sid: 'AWSConfigBucketDelivery'
            Effect: Allow
            Principal: { Service: 'config.amazonaws.com' }
            Action: 's3:PutObject'
            Resource: !Sub '${ConfigBucket.Arn}/AWSLogs/${AWS::AccountId}/Config/*'
            Condition:
              StringEquals: { 's3:x-amz-acl': 'bucket-owner-full-control' }

  ConfigurationRecorder:
    Type: 'AWS::Config::ConfigurationRecorder'
    Properties:
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: false

  DeliveryChannel:
    Type: 'AWS::Config::DeliveryChannel'
    Properties:
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: 'TwentyFour_Hours'
      S3BucketName: !Ref ConfigBucket

  S3EncryptionRule:
    Type: 'AWS::Config::ConfigRule'
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: 'S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED'
    DependsOn: ConfigurationRecorder

  EbsEncryptionRule:
    Type: 'AWS::Config::ConfigRule'
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: 'ENCRYPTED_VOLUMES'
    DependsOn: ConfigurationRecorder

  IamRolePolicyCheckRule:
    Type: 'AWS::Config::ConfigRule'
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: 'IAM_ROLE_MANAGED_POLICY_CHECK'
    DependsOn: ConfigurationRecorder

Outputs:
  VpcId:
    Description: 'ID of the newly created VPC'
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'
  PublicSubnetId:
    Description: 'ID of the public subnet'
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnetId'
  KMSKeyArn:
    Description: 'ARN of the regional KMS Key'
    Value: !GetAtt NovaKMSKey.Arn
    Export:
      Name: !Sub '${AWS::StackName}-KMSKeyArn'
  S3BucketName:
    Description: 'Name of the regional S3 Bucket for Nova data'
    Value: !Ref NovaDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketName'
  EC2InstanceId:
    Description: 'ID of the regional EC2 Instance'
    Value: !Ref NovaEC2Instance
    Export:
      Name: !Sub '${AWS::StackName}-EC2InstanceId'

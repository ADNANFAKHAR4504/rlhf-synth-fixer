AWSTemplateFormatVersion: '2010-09-09'
Description: >
  ServerlessApp - Highly Available, Secure Serverless Application Template.
  Deploys Lambda triggered by S3, with secure secrets, HA, monitoring, and least-privilege IAM.
Parameters:
  LambdaRuntime:
    Type: String
    Default: python3.12
    Description: Lambda function runtime version.
    AllowedValues:
      - python3.12
      - nodejs20.x
  LambdaHandler:
    Type: String
    Default: lambda_function.lambda_handler
    Description: The handler for the Lambda function executable.
  S3BucketName:
    Type: String
    Default: serverlessapp-bucket-284210-1
    Description: Unique S3 bucket name for object triggers.

Resources:
  # S3 Bucket Policy to allow Lambda invocation
  ServerlessAppBucketInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ServerlessAppLambda
      Principal: s3.amazonaws.com
      SourceArn: !Sub arn:aws:s3:::${S3BucketName}
      SourceAccount: !Ref AWS::AccountId

  # S3 Bucket for File Uploads (Secured)
  ServerlessAppBucket:
    Type: AWS::S3::Bucket
    DependsOn: ServerlessAppBucketInvokePermission
    Properties:
      BucketName: !Ref S3BucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function: !GetAtt ServerlessAppLambda.Arn
      Tags:
        - Key: Name
          Value: ServerlessAppBucket

  # VPC for Lambda isolation (Multi-AZ)
  ServerlessAppVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/24
      Tags:
        - Key: Name
          Value: ServerlessAppVPC

  ServerlessAppSubnetAZ1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServerlessAppVPC
      CidrBlock: 10.0.0.0/26
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: ServerlessAppSubnetAZ1

  ServerlessAppSubnetAZ2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServerlessAppVPC
      CidrBlock: 10.0.0.64/26
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: ServerlessAppSubnetAZ2

  # Public subnet for NAT Gateway
  ServerlessAppPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServerlessAppVPC
      CidrBlock: 10.0.0.128/26
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: ServerlessAppPublicSubnet

  # Elastic IP for NAT Gateway
  ServerlessAppNATEIP:
    Type: AWS::EC2::EIP
    DependsOn: ServerlessAppVPCGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ServerlessAppNATEIP

  # NAT Gateway for Lambda internet access
  ServerlessAppNATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ServerlessAppNATEIP.AllocationId
      SubnetId: !Ref ServerlessAppPublicSubnet
      Tags:
        - Key: Name
          Value: ServerlessAppNATGateway

  ServerlessAppInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: ServerlessAppInternetGateway

  ServerlessAppVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ServerlessAppVPC
      InternetGatewayId: !Ref ServerlessAppInternetGateway

  # Public route table for NAT Gateway subnet
  ServerlessAppPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ServerlessAppVPC
      Tags:
        - Key: Name
          Value: ServerlessAppPublicRouteTable

  # Private route table for Lambda subnets
  ServerlessAppPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ServerlessAppVPC
      Tags:
        - Key: Name
          Value: ServerlessAppPrivateRouteTable

  # Public route - Internet Gateway
  ServerlessAppPublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ServerlessAppPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ServerlessAppInternetGateway

  # Private route - NAT Gateway
  ServerlessAppPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ServerlessAppPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref ServerlessAppNATGateway

  # Associate public subnet with public route table
  ServerlessAppPublicSubnetRouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ServerlessAppPublicSubnet
      RouteTableId: !Ref ServerlessAppPublicRouteTable

  # Associate private subnets with private route table
  ServerlessAppSubnetRouteTableAssocAZ1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ServerlessAppSubnetAZ1
      RouteTableId: !Ref ServerlessAppPrivateRouteTable

  ServerlessAppSubnetRouteTableAssocAZ2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ServerlessAppSubnetAZ2
      RouteTableId: !Ref ServerlessAppPrivateRouteTable

  # Security Group to allow Lambda outbound access
  ServerlessAppLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Lambda internet access
      VpcId: !Ref ServerlessAppVPC
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: ServerlessAppLambdaSG

  # Secrets Manager Secret for sensitive config
  ServerlessAppSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: ServerlessAppSecret
      Description: Sensitive information for ServerlessApp Lambda function.
      GenerateSecretString:
        SecretStringTemplate: '{"api_key": ""}'
        GenerateStringKey: 'api_key'
        PasswordLength: 32
      Tags:
        - Key: Name
          Value: ServerlessAppSecret

  # IAM Role for Lambda with least privilege
  ServerlessAppLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ServerlessAppLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Only allow reading this one secret
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref ServerlessAppSecret
              # Allow logging to its own log group
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/ServerlessAppLambda:*
              # Allows read access to objects in the S3 bucket for processing
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub arn:aws:s3:::${S3BucketName}/*
              # VPC permissions for Lambda network interface management
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DetachNetworkInterface
                Resource: '*'
      Path: '/'
      Tags:
        - Key: Name
          Value: ServerlessAppLambdaRole

  # Lambda Function (Python 3.12 example)
  ServerlessAppLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: ServerlessAppLambda
      Description: 'ServerlessApp Lambda triggered by S3, using secrets, VPC-aware, secure.'
      Role: !GetAtt ServerlessAppLambdaRole.Arn
      Runtime: !Ref LambdaRuntime
      Handler: !Ref LambdaHandler
      Timeout: 60
      MemorySize: 256
      Code:
        ZipFile: |
          import boto3
          import os
          import json

          def lambda_handler(event, context):
              try:
                  secret_name = os.environ['SERVERLESSAPP_SECRET_ARN']
                  # Get secret value
                  session = boto3.session.Session()
                  client = session.client(service_name='secretsmanager')
                  get_secret_value_response = client.get_secret_value(SecretId=secret_name)
                  secret = json.loads(get_secret_value_response['SecretString'])
                  
                  # Process S3 event (get bucket and key)
                  for record in event['Records']:
                      s3 = boto3.client('s3')
                      bucket = record['s3']['bucket']['name']
                      key = record['s3']['object']['key']
                      # For example: read file
                      obj = s3.get_object(Bucket=bucket, Key=key)
                      data = obj['Body'].read()
                      # ... further processing ...
                  
                  return {'statusCode': 200, 'body': 'Processed successfully'}
              except Exception as e:
                  return {
                      'statusCode': 500,
                      'body': json.dumps(f'Error: {str(e)}')
                  }
      Environment:
        Variables:
          SERVERLESSAPP_SECRET_ARN: !Ref ServerlessAppSecret
      VpcConfig:
        SecurityGroupIds:
          - !Ref ServerlessAppLambdaSecurityGroup
        SubnetIds:
          - !Ref ServerlessAppSubnetAZ1
          - !Ref ServerlessAppSubnetAZ2
      Tags:
        - Key: Name
          Value: ServerlessAppLambda
      # ReservedConcurrentExecutions: 2 # Optionally restrict concurrency

  # CloudWatch Log Group (retention 7d, secure)
  ServerlessAppLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/ServerlessAppLambda
      RetentionInDays: 7
      Tags:
        - Key: Name
          Value: ServerlessAppLogGroup

  # CloudWatch Alarm - High Error Rate (5-min window)
  ServerlessAppLambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ServerlessAppLambdaErrorAlarm
      AlarmDescription: 'Alarm if error count > 1 in 5-minute period'
      Namespace: AWS/Lambda
      MetricName: Errors
      Dimensions:
        - Name: FunctionName
          Value: !Ref ServerlessAppLambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # CloudWatch Alarm - High Invocation Count (workload indicator)
  ServerlessAppLambdaInvocationsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: ServerlessAppLambdaInvocationsAlarm
      AlarmDescription: 'Alarm if invocation count > 100 in 5 minutes'
      Namespace: AWS/Lambda
      MetricName: Invocations
      Dimensions:
        - Name: FunctionName
          Value: !Ref ServerlessAppLambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

Outputs:
  S3BucketName:
    Description: 'ServerlessApp S3 bucket name for triggering uploads'
    Value: !Ref ServerlessAppBucket

  LambdaFunctionName:
    Description: 'ServerlessApp Lambda function name'
    Value: !Ref ServerlessAppLambda

  LambdaFunctionArn:
    Description: 'ServerlessApp Lambda function ARN'
    Value: !GetAtt ServerlessAppLambda.Arn

  SecretArn:
    Description: 'ARN of the ServerlessApp Lambda Secret'
    Value: !Ref ServerlessAppSecret

  Alarms:
    Description: 'CloudWatch Alarms monitoring Lambda errors and invocations'
    Value:
      !Join [
        ', ',
        [
          !Ref ServerlessAppLambdaErrorAlarm,
          !Ref ServerlessAppLambdaInvocationsAlarm,
        ],
      ]

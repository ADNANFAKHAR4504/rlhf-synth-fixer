AWSTemplateFormatVersion: "2010-09-09"
Description: "VPC Infrastructure - Secure, scalable, and cost-effective AWS Virtual Private Cloud infrastructure for multi-AZ environment"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: "Environment suffix for resource naming (e.g., dev, staging, prod)"
    AllowedPattern: "^[a-zA-Z0-9]+$"
    ConstraintDescription: "Must contain only alphanumeric characters"

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "vpc-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "igw-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Internet Gateway Attachment
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnet 1 (AZ a)
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: "10.0.1.0/24"
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "public-subnet-1-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"
        - Key: Type
          Value: "Public"

  # Public Subnet 2 (AZ b)
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: "10.0.2.0/24"
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "public-subnet-2-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"
        - Key: Type
          Value: "Public"

  # Private Subnet 1 (AZ a)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs ""]
      CidrBlock: "10.0.11.0/24"
      Tags:
        - Key: Name
          Value: !Sub "private-subnet-1-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"
        - Key: Type
          Value: "Private"

  # Private Subnet 2 (AZ b)
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs ""]
      CidrBlock: "10.0.12.0/24"
      Tags:
        - Key: Name
          Value: !Sub "private-subnet-2-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"
        - Key: Type
          Value: "Private"

  # NAT Gateway 1 Elastic IP
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "nat-eip-1-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # NAT Gateway 2 Elastic IP
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "nat-eip-2-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # NAT Gateway 1
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub "nat-gateway-1-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # NAT Gateway 2
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub "nat-gateway-2-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "public-rt-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Default Public Route
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref InternetGateway

  # Public Subnet 1 Route Table Association
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  # Public Subnet 2 Route Table Association
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  # Private Route Table 1
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "private-rt-1-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Default Private Route 1
  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: !Ref NatGateway1

  # Private Subnet 1 Route Table Association
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  # Private Route Table 2
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "private-rt-2-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"
        - Key: Owner
          Value: "DevOps-Team"
        - Key: BillingCode
          Value: "INFRA-001"

  # Default Private Route 2
  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: "0.0.0.0/0"
      NatGatewayId: !Ref NatGateway2

  # Private Subnet 2 Route Table Association
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  # IAM Role for EC2 Instances
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "EC2InstanceRole-${EnvironmentSuffix}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: !Sub "EC2InstanceRole-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"

  # Instance Profile for EC2 Role
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "EC2InstanceProfile-${EnvironmentSuffix}"
      Roles:
        - !Ref EC2InstanceRole

  # Test S3 Bucket
  TestS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "test-s3-bucket-${EnvironmentSuffix}-${AWS::AccountId}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "test-s3-bucket-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"

  # Test IAM User
  TestIAMUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "TestIAMUser-${EnvironmentSuffix}"
      Policies:
        - PolicyName: !Sub "S3BucketReadOnlyPolicy-${EnvironmentSuffix}"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt TestS3Bucket.Arn
                  - !Sub "${TestS3Bucket}/*"
      Tags:
        - Key: Name
          Value: !Sub "TestIAMUser-${EnvironmentSuffix}"
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: "VPC-Infrastructure"

Outputs:
  VPCId:
    Description: "ID of the VPC"
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCId"

  VPCCidrBlock:
    Description: "CIDR block of the VPC"
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub "${AWS::StackName}-VPCCidrBlock"

  InternetGatewayId:
    Description: "ID of the Internet Gateway"
    Value: !Ref InternetGateway
    Export:
      Name: !Sub "${AWS::StackName}-InternetGatewayId"

  PublicSubnet1Id:
    Description: "ID of the first public subnet"
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-PublicSubnet1Id"

  PublicSubnet2Id:
    Description: "ID of the second public subnet"
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-PublicSubnet2Id"

  PrivateSubnet1Id:
    Description: "ID of the first private subnet"
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnet1Id"

  PrivateSubnet2Id:
    Description: "ID of the second private subnet"
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub "${AWS::StackName}-PrivateSubnet2Id"

  NatGateway1Id:
    Description: "ID of the first NAT Gateway"
    Value: !Ref NatGateway1
    Export:
      Name: !Sub "${AWS::StackName}-NatGateway1Id"

  NatGateway2Id:
    Description: "ID of the second NAT Gateway"
    Value: !Ref NatGateway2
    Export:
      Name: !Sub "${AWS::StackName}-NatGateway2Id"

  PublicRouteTableId:
    Description: "ID of the public route table"
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub "${AWS::StackName}-PublicRouteTableId"

  PrivateRouteTable1Id:
    Description: "ID of the first private route table"
    Value: !Ref PrivateRouteTable1
    Export:
      Name: !Sub "${AWS::StackName}-PrivateRouteTable1Id"

  PrivateRouteTable2Id:
    Description: "ID of the second private route table"
    Value: !Ref PrivateRouteTable2
    Export:
      Name: !Sub "${AWS::StackName}-PrivateRouteTable2Id"

  AvailabilityZones:
    Description: "Availability zones used"
    Value: !Join
      - ","
      - - !Select [0, !GetAZs ""]
        - !Select [1, !GetAZs ""]
    Export:
      Name: !Sub "${AWS::StackName}-AvailabilityZones"

  StackName:
    Description: "Name of this CloudFormation stack"
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub "${AWS::StackName}-StackName"

  EnvironmentSuffix:
    Description: "Environment suffix used for this deployment"
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub "${AWS::StackName}-EnvironmentSuffix"

  EC2InstanceRoleName:
    Description: "Name of the EC2 instance IAM role"
    Value: !Ref EC2InstanceRole
    Export:
      Name: !Sub "${AWS::StackName}-EC2InstanceRoleName"

  TestIAMUserName:
    Description: "Name of the test IAM user"
    Value: !Ref TestIAMUser
    Export:
      Name: !Sub "${AWS::StackName}-TestIAMUserName"

  TestS3BucketName:
    Description: "Name of the test S3 bucket"
    Value: !Ref TestS3Bucket
    Export:
      Name: !Sub "${AWS::StackName}-TestS3BucketName"

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  This CloudFormation template sets up a basic cloud environment in the us-west-2 region
  for a development workload. It includes an S3 bucket with versioning, an EC2 instance
  in a public subnet, an Elastic IP, and a Security Group with SSH and HTTP access.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: 'my-dev-keypair'
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance

Mappings:
  RegionMap:
    us-west-2:
      AMI: ami-022c7aee234b29c55 # Example AMI ID for us-west-2, replace with a valid one

Resources:
  SampleBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub sample-bucket-${EnvironmentSuffix}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject
  
  SampleBucketPublicAccessBlock:
    Type: AWS::S3::BucketPublicAccessBlock
    Properties:
      Bucket: !Ref SampleBucket
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true

  # VPC
  DevVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: DevVPC
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject
  
  # Internet Gateway
  DevInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Environment
          Value: dev
        - Key: Project
          Value: SampleProject
    
  DevAttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref DevVPC
      InternetGatewayId: !Ref DevInternetGateway

  # Public Subnet
  DevPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DevVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: DevPublicSubnet
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject

  # Route Table
  DevRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DevVPC
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject
    
  DevRoute:
    Type: AWS::EC2::Route
    DependsOn: DevAttachGateway
    Properties:
      RouteTableId: !Ref DevRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref DevInternetGateway
  
  DevSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DevPublicSubnet
      RouteTableId: !Ref DevRouteTable

  DevSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH and HTTP access
      VpcId: !Ref DevVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject
        
  # Elastic IP
  DevEIP:
    Type: AWS::EC2::EIP
    DependsOn: DevAttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject

  DevEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: !FindInMap [RegionMap, us-west-2, AMI]
      KeyName: !Ref KeyPairName
      SubnetId: !Ref DevPublicSubnet
      SecurityGroupIds:
        - !Ref DevSecurityGroup
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Project
          Value: SampleProject

  DevEIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt DevEIP.AllocationId
      InstanceId: !Ref DevEC2Instance

Outputs:
  S3BucketName:
    Description: The name of the S3 bucket
    Value: !Ref SampleBucket

  EC2InstancePublicIP:
    Description: The public IP address of the EC2 instance
    Value: !GetAtt DevEIP.PublicIp

  EC2InstanceId:
    Description: The EC2 Instance ID
    Value: !Ref DevEC2Instance

  ElasticIPAllocationId:
    Description: Allocation ID of the EIP
    Value: !GetAtt DevEIP.AllocationId

  DevSecurityGroupId:
    Description: Security Group ID for the instance
    Value: !Ref DevSecurityGroup

  KeyPairName:
    Description: Key pair name used
    Value: !Ref KeyPairName
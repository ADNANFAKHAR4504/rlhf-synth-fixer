AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure multi-region AWS infrastructure template with S3 encryption, least privilege IAM, RDS logging, and EC2 in private subnets'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentSuffix

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'
  CompanyName:
    Type: String
    Default: 'mycompany'
    Description: 'Company name for resource naming convention (lowercase)'
    AllowedPattern: '^[a-z0-9]+$'
    ConstraintDescription: 'Must contain only lowercase alphanumeric characters'
  Environment:
    Type: String
    Default: 'prod'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment for resource naming convention'
  ExistingVpcId:
    Type: String
    Default: ''
    Description: 'ID of existing VPC where resources will be deployed'
  PrivateSubnetIds:
    Type: String
    Default: ''
    Description: 'Comma-delimited list of private subnet IDs within the existing VPC'
  DBSubnetGroupName:
    Type: String
    Default: ''
    Description: 'Name of existing DB subnet group for RDS instances'
  DBMasterUsername:
    Type: String
    Default: 'dbadmin'
    Description: 'Master username for RDS instance'
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
  EC2InstanceType:
    Type: String
    Default: 't3.micro'
    AllowedValues: ['t3.micro', 't3.small', 't3.medium']
    Description: 'EC2 instance type for private instances'

Conditions:
  HasExistingVpcId: !Not [!Equals [!Ref ExistingVpcId, '']]
  HasPrivateSubnetIds: !Not [!Equals [!Ref PrivateSubnetIds, '']]
  HasDBSubnetGroupName: !Not [!Equals [!Ref DBSubnetGroupName, '']]
  DeployEC2AndRDS: !And 
    - !Condition HasExistingVpcId
    - !Condition HasPrivateSubnetIds
    - !Condition HasDBSubnetGroupName

Resources:
  # IAM Role for EC2 instances with least privilege
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/${CompanyName}-${Environment}*'
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-IAMRole'

  # KMS Key for S3 encryption
  S3EncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub '${CompanyName}-${Environment} S3 encryption key'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow S3 Service
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-KMSKey'

  S3EncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${CompanyName}-${Environment}-s3-key'
      TargetKeyId: !Ref S3EncryptionKey

  # S3 Bucket with server-side encryption
  SecureS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${CompanyName}-${Environment}-bucket-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3EncryptionKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-S3Bucket'

  # S3 Bucket Policy to allow EC2 role access
  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SecureS3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !GetAtt EC2Role.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:ListBucket
            Resource: 
              - !Sub 'arn:aws:s3:::${SecureS3Bucket}'
              - !Sub 'arn:aws:s3:::${SecureS3Bucket}/*'

  # Update EC2 Role policy for KMS access
  EC2RoleKMSPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: KMSAccessPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: !GetAtt S3EncryptionKey.Arn
      Roles:
        - !Ref EC2Role

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # IAM Role for RDS Enhanced Monitoring
  RDSEnhancedMonitoringRole:
    Type: AWS::IAM::Role
    Condition: DeployEC2AndRDS
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-RDSMonitoringRole'

  # DB Parameter Group for MySQL with logging enabled
  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Condition: DeployEC2AndRDS
    Properties:
      DBParameterGroupName: !Sub '${CompanyName}-${Environment}-mysql-params'
      Family: mysql8.0
      Description: 'MySQL parameter group with logging enabled'
      Parameters:
        general_log: 1
        slow_query_log: 1
        log_queries_not_using_indexes: 1
        long_query_time: 2
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-DBParameterGroup'

  # Security Group for EC2 instances
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: DeployEC2AndRDS
    Properties:
      GroupName: !Sub '${CompanyName}-${Environment}-EC2-SG'
      GroupDescription: 'Security group for EC2 instances in private subnets'
      VpcId: !Ref ExistingVpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: 'HTTPS outbound'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: 'HTTP outbound'
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
          Description: 'MySQL to RDS'
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-EC2SecurityGroup'

  # Security Group for RDS
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: DeployEC2AndRDS
    Properties:
      GroupName: !Sub '${CompanyName}-${Environment}-RDS-SG'
      GroupDescription: 'Security group for RDS instance'
      VpcId: !Ref ExistingVpcId
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-RDSSecurityGroup'

  # Adding ingress rule after both security groups are created
  RDSSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: DeployEC2AndRDS
    Properties:
      GroupId: !Ref RDSSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref EC2SecurityGroup
      Description: 'MySQL access from EC2 instances'

  # Launch Template for EC2 instances
  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Condition: DeployEC2AndRDS
    Properties:
      LaunchTemplateName: !Sub '${CompanyName}-${Environment}-LaunchTemplate'
      LaunchTemplateData:
        ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
        InstanceType: !Ref EC2InstanceType
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        UserData:
          Fn::Base64: |
            #!/bin/bash
            yum update -y
            yum install -y awscli
            # Configure CloudWatch agent for logging
            yum install -y amazon-cloudwatch-agent
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${CompanyName}-${Environment}-EC2Instance'

  # EC2 Instance in private subnet
  EC2Instance:
    Type: AWS::EC2::Instance
    Condition: DeployEC2AndRDS
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: !GetAtt EC2LaunchTemplate.LatestVersionNumber
      SubnetId: !Select [0, !Split [',', !Ref PrivateSubnetIds]]
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-EC2Instance'

  # Create AWS Secrets Manager secret with a deterministic name
  RDSSecret:
    Type: AWS::SecretsManager::Secret
    Condition: DeployEC2AndRDS
    Properties:
      Name: !Sub '${CompanyName}-${Environment}-db-secret'
      Description: !Sub 'Secret for ${CompanyName}-${Environment} RDS instance'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DBMasterUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-DBSecret'

  # RDS Instance - Use fixed secret name in dynamic reference
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Condition: DeployEC2AndRDS
    Properties:
      DBInstanceIdentifier: !Sub '${CompanyName}-${Environment}-rds-instance'
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: '8.0.35'
      AllocatedStorage: 20
      StorageType: gp2
      StorageEncrypted: true
      MasterUsername: !Sub '{{resolve:secretsmanager:${CompanyName}-${Environment}-db-secret:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${CompanyName}-${Environment}-db-secret:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroupName
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBParameterGroupName: !Ref DBParameterGroup
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSEnhancedMonitoringRole.Arn
      EnableCloudwatchLogsExports:
        - error
        - general
        - slow-query
      BackupRetentionPeriod: 7
      PubliclyAccessible: false
      DeletionProtection: true
      Tags:
        - Key: Name
          Value: !Sub '${CompanyName}-${Environment}-RDSInstance'

  # Keep the original DynamoDB table from TapStack.yml
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub 'TurnAroundPromptTable${EnvironmentSuffix}'
      AttributeDefinitions:
        - AttributeName: 'id'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'id'
          KeyType: 'HASH'
      BillingMode: PAY_PER_REQUEST
      DeletionProtectionEnabled: false

Outputs:
  S3BucketArn:
    Description: 'ARN of the secure S3 bucket'
    Value: !GetAtt SecureS3Bucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketArn'

  S3BucketName:
    Description: 'Name of the secure S3 bucket'
    Value: !Ref SecureS3Bucket
    Export:
      Name: !Sub '${AWS::StackName}-S3BucketName'

  KMSKeyArn:
    Description: 'ARN of the KMS key for S3 encryption'
    Value: !GetAtt S3EncryptionKey.Arn
    Export:
      Name: !Sub '${AWS::StackName}-KMSKeyArn'

  EC2RoleArn:
    Description: 'ARN of the EC2 IAM role'
    Value: !GetAtt EC2Role.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2RoleArn'

  # Conditional outputs for EC2/RDS resources
  RDSInstanceEndpoint:
    Condition: DeployEC2AndRDS
    Description: 'RDS instance endpoint'
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-RDSEndpoint'

  RDSInstanceArn:
    Condition: DeployEC2AndRDS
    Description: 'ARN of the RDS instance'
    Value: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${RDSInstance}'
    Export:
      Name: !Sub '${AWS::StackName}-RDSInstanceArn'

  EC2InstanceId:
    Condition: DeployEC2AndRDS
    Description: 'ID of the EC2 instance'
    Value: !Ref EC2Instance
    Export:
      Name: !Sub '${AWS::StackName}-EC2InstanceId'

  RDSEnhancedMonitoringRoleArn:
    Condition: DeployEC2AndRDS
    Description: 'ARN of the RDS Enhanced Monitoring role'
    Value: !GetAtt RDSEnhancedMonitoringRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-RDSMonitoringRoleArn'

  # Keep original TapStack.yml outputs as well
  TurnAroundPromptTableName:
    Description: 'Name of the DynamoDB table'
    Value: !Ref TurnAroundPromptTable
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableName'

  TurnAroundPromptTableArn:
    Description: 'ARN of the DynamoDB table'
    Value: !GetAtt TurnAroundPromptTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableArn'

  StackName:
    Description: 'Name of this CloudFormation stack'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  EnvironmentSuffix:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

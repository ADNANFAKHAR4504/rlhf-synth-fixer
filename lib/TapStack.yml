AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Complete high-availability stack for the Nova web application. This template
  provisions a VPC with 3 public/private subnets, an Application Load Balancer,
  an Auto Scaling Group with EC2 instances, Route 53 DNS records, an encrypted S3
  bucket, and SNS notifications. (v1.0.2)

Parameters:
  InstanceType:
    Description: EC2 instance type for the web servers.
    Type: String
    Default: t3.micro
    AllowedValues:
      - t2.micro
      - t3.micro
      - t3.small
      - m5.large
      - c5.large

  HostedZoneId:
    Description: The Route 53 Hosted Zone ID to create the DNS record in (e.g., Z0123456789ABCDEFGHIJ).
    Type: AWS::Route53::HostedZone::Id

  DnsName:
    Description: The fully qualified domain name (FQDN) for the application (e.g., nova.yourdomain.com).
    Type: String

  ACMCertificateArn:
    Description: ARN of the AWS Certificate Manager (ACM) certificate for the ALB HTTPS listener.
    Type: String

Resources:
  # ------------------------------------------------------------
  # IAM Roles & Profiles
  # ------------------------------------------------------------
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'Nova-EC2-Role-${AWS::StackName}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Description: IAM Role for Nova EC2 instances to allow access to SSM and CloudWatch.

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub 'Nova-Instance-Profile-${AWS::StackName}'
      Roles:
        - !Ref EC2InstanceRole

  # ------------------------------------------------------------
  # Networking
  # ------------------------------------------------------------
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub 'Nova-VPC-${AWS::StackName}'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 'Nova-IGW-${AWS::StackName}'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets - AZ distribution is handled by referencing the index of Fn::GetAZs
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PublicSubnet-A-${AWS::StackName}'

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PublicSubnet-B-${AWS::StackName}'

  PublicSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [2, !GetAZs '']
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PublicSubnet-C-${AWS::StackName}'

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.101.0/24
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PrivateSubnet-A-${AWS::StackName}'

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.102.0/24
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PrivateSubnet-B-${AWS::StackName}'

  PrivateSubnetC:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [2, !GetAZs '']
      CidrBlock: 10.0.103.0/24
      Tags:
        - Key: Name
          Value: !Sub 'Nova-PrivateSubnet-C-${AWS::StackName}'

  # NAT Gateways & EIPs for private subnet outbound access
  EIPA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  EIPB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  EIPC:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIPA.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: !Sub 'Nova-NatGateway-A-${AWS::StackName}'

  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIPB.AllocationId
      SubnetId: !Ref PublicSubnetB
      Tags:
        - Key: Name
          Value: !Sub 'Nova-NatGateway-B-${AWS::StackName}'

  NatGatewayC:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIPC.AllocationId
      SubnetId: !Ref PublicSubnetC
      Tags:
        - Key: Name
          Value: !Sub 'Nova-NatGateway-C-${AWS::StackName}'

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'Nova-Public-RouteTable-${AWS::StackName}'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable
  PublicSubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable
  PublicSubnetRouteTableAssociationC:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetC
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'Nova-Private-RouteTable-A-${AWS::StackName}'
  PrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayA
  PrivateSubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'Nova-Private-RouteTable-B-${AWS::StackName}'
  PrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayB
  PrivateSubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  PrivateRouteTableC:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'Nova-Private-RouteTable-C-${AWS::StackName}'
  PrivateRouteC:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableC
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayC
  PrivateSubnetRouteTableAssociationC:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetC
      RouteTableId: !Ref PrivateRouteTableC

  # ------------------------------------------------------------
  # Security Groups
  # ------------------------------------------------------------
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'Nova-ALB-SG-${AWS::StackName}'
      GroupDescription: 'Allow HTTPS traffic from the internet to the ALB'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
      Tags:
        - Key: Name
          Value: !Sub 'Nova-ALB-SG-${AWS::StackName}'

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'Nova-EC2-SG-${AWS::StackName}'
      GroupDescription: 'Allow HTTP traffic from the ALB'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref ALBSecurityGroup
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
      Tags:
        - Key: Name
          Value: !Sub 'Nova-EC2-SG-${AWS::StackName}'

  # ------------------------------------------------------------
  # Load Balancer, Target Group & Listener
  # ------------------------------------------------------------
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub 'Nova-ALB-${AWS::StackName}'
      Scheme: internet-facing
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: idle_timeout.timeout_seconds
          Value: '60'
      Subnets:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
        - !Ref PublicSubnetC
      SecurityGroups:
        - !Ref ALBSecurityGroup

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub 'Nova-TG-${AWS::StackName}'
      VpcId: !Ref VPC
      Protocol: HTTP
      Port: 80
      HealthCheckProtocol: HTTP
      HealthCheckPath: /index.html
      Matcher:
        HttpCode: '200'
      TargetType: instance
      Tags:
        - Key: Name
          Value: !Sub 'Nova-TargetGroup-${AWS::StackName}'

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Protocol: HTTPS
      Port: 443
      SslPolicy: ELBSecurityPolicy-2016-08
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup

  # ------------------------------------------------------------
  # Compute & Auto Scaling
  # ------------------------------------------------------------
  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub 'Nova-LaunchTemplate-${AWS::StackName}'
      LaunchTemplateData:
        ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
        InstanceType: !Ref InstanceType
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        Monitoring:
          Enabled: true
        SecurityGroupIds:
          - !Ref EC2SecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd
            systemctl start httpd
            systemctl enable httpd
            echo "<h1>Hello from Nova Web Server on $(hostname -f)</h1>" > /var/www/html/index.html
            echo "<p>This is stack ${AWS::StackName}</p>" >> /var/www/html/index.html

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub 'Nova-ASG-${AWS::StackName}'
      VPCZoneIdentifier:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
        - !Ref PrivateSubnetC
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: !GetAtt EC2LaunchTemplate.LatestVersionNumber
      MinSize: '2'
      MaxSize: '6'
      DesiredCapacity: '2'
      TargetGroupARNs:
        - !Ref ALBTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      NotificationConfiguration:
        TopicARN: !Ref NotificationTopic
        NotificationTypes:
          - 'autoscaling:EC2_INSTANCE_LAUNCH'
          - 'autoscaling:EC2_INSTANCE_LAUNCH_ERROR'
          - 'autoscaling:EC2_INSTANCE_TERMINATE'
          - 'autoscaling:EC2_INSTANCE_TERMINATE_ERROR'
      Tags:
        - Key: Name
          Value: !Sub 'Nova-Instance-${AWS::StackName}'
          PropagateAtLaunch: true
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 1
        PauseTime: PT5M
        WaitOnResourceSignals: false

  # ------------------------------------------------------------
  # Scaling Policies & Alarms
  # ------------------------------------------------------------
  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0

  # ------------------------------------------------------------
  # DNS & Health Checks
  # ------------------------------------------------------------
  Route53HealthCheck:
    Type: AWS::Route53::HealthCheck
    Properties:
      HealthCheckConfig:
        Type: HTTPS
        FullyQualifiedDomainName: !GetAtt ApplicationLoadBalancer.DNSName
        Port: 443
        ResourcePath: /index.html
        FailureThreshold: 3
        RequestInterval: 30
      HealthCheckTags:
        - Key: Name
          Value: !Sub 'Nova-ALB-HealthCheck-${AWS::StackName}'

  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DnsName
      Type: A
      AliasTarget:
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
      HealthCheckId: !Ref Route53HealthCheck

  # ------------------------------------------------------------
  # Storage
  # ------------------------------------------------------------
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'nova-app-data-${AWS::AccountId}-${AWS::Region}-${AWS::StackName}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: NoncurrentVersionTransitionRule
            Status: Enabled
            NoncurrentVersionTransitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
          - Id: ExpireNoncurrentVersionsRule
            Status: Enabled
            NoncurrentVersionExpirationInDays: 365
          - Id: AbortIncompleteMultipartUploadRule
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7

  # ------------------------------------------------------------
  # Monitoring & Notifications
  # ------------------------------------------------------------
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub 'Nova-Notifications-${AWS::StackName}'
      TopicName: !Sub 'Nova-Notifications-${AWS::StackName}'

  NotificationTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudwatch.amazonaws.com
                - autoscaling.amazonaws.com
            Action: sns:Publish
            Resource: !Ref NotificationTopic
      Topics:
        - !Ref NotificationTopic

  HighCPUAlarmForNotification:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub 'Nova-High-CPU-Notification-${AWS::StackName}'
      AlarmDescription: 'Alarm if CPU exceeds 90% for 10 minutes (notification only)'
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 90
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref NotificationTopic

# ------------------------------------------------------------
# Outputs for Integration Testing and Management
# ------------------------------------------------------------
Outputs:
  WebAppURL:
    Description: The URL for the Nova web application.
    Value: !Sub 'https://${DnsName}'

  ApplicationLoadBalancerDNS:
    Description: The DNS name of the Application Load Balancer.
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  ApplicationLoadBalancerArn:
    Description: The ARN of the Application Load Balancer.
    Value: !Ref ApplicationLoadBalancer

  TargetGroupArn:
    Description: The ARN of the ALB Target Group.
    Value: !Ref ALBTargetGroup

  AutoScalingGroupName:
    Description: The name of the Auto Scaling Group.
    Value: !Ref AutoScalingGroup

  EC2InstanceRoleArn:
    Description: The ARN of the IAM Role for EC2 instances.
    Value: !GetAtt EC2InstanceRole.Arn

  S3BucketName:
    Description: Name of the private S3 bucket for durable storage.
    Value: !Ref S3Bucket

  NotificationTopicARN:
    Description: ARN of the SNS topic for notifications.
    Value: !Ref NotificationTopic

  VpcId:
    Description: The ID of the deployed VPC.
    Value: !Ref VPC

  PublicSubnetAId:
    Description: ID of Public Subnet in AZ-A.
    Value: !Ref PublicSubnetA

  PublicSubnetBId:
    Description: ID of Public Subnet in AZ-B.
    Value: !Ref PublicSubnetB

  PublicSubnetCId:
    Description: ID of Public Subnet in AZ-C.
    Value: !Ref PublicSubnetC

  PrivateSubnetAId:
    Description: ID of Private Subnet in AZ-A.
    Value: !Ref PrivateSubnetA

  PrivateSubnetBId:
    Description: ID of Private Subnet in AZ-B.
    Value: !Ref PrivateSubnetB

  PrivateSubnetCId:
    Description: ID of Private Subnet in AZ-C.
    Value: !Ref PrivateSubnetC

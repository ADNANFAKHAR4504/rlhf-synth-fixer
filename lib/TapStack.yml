AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure Regional Foundation for Project Nova (Prod). DEPLOYMENT: Use StackSets. See template comments for 2-step peering setup.'

Parameters:
  ProjectName:
    Type: String
    Default: 'nova'
    Description: 'Project name, used for resource naming.'
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod)'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'
  AdminCidrIp:
    Type: String
    Description: 'CIDR block for administrative SSH access to the Bastion host. IMPORTANT: Do not use 0.0.0.0/0.'
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
  PeerVpcId:
    Type: String
    Description: '(Optional - For Step 2) The VPC ID of the peer region to establish VPC Peering.'
  PeerCidrBlock:
    Type: String
    Description: '(Optional - For Step 2) The CIDR block of the peer VPC (e.g., 10.1.0.0/16).'

Conditions:
  HasPeerVpcId: !Not [!Equals [!Ref PeerVpcId, '']]
  IsPrimaryRegion: !Equals [!Ref 'AWS::Region', 'us-east-1']

Resources:
  KMSKey:
    Type: 'AWS::KMS::Key'
    Properties:
      Description: !Sub 'KMS key for ${ProjectName}-${EnvironmentSuffix} resources'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AllowKeyAdmins'
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: 'AllowServiceUsage'
            Effect: Allow
            Principal:
              Service:
                - 'rds.amazonaws.com'
                - 'cloudtrail.amazonaws.com'
            Action: ['kms:GenerateDataKey*', 'kms:Decrypt']
            Resource: '*'
  KMSKeyAlias:
    Type: 'AWS::KMS::Alias'
    Properties:
      AliasName: !Sub 'alias/${ProjectName}-${EnvironmentSuffix}-key'
      TargetKeyId: !Ref KMSKey
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: !If [IsPrimaryRegion, '10.0.0.0/16', '10.1.0.0/16']
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-vpc'
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !If [IsPrimaryRegion, '10.0.1.0/24', '10.1.1.0/24']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-public-subnet'
  PrivateSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !If [IsPrimaryRegion, '10.0.100.0/24', '10.1.100.0/24']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-private-subnet'
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
  AttachGateway:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  NatGatewayEIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: 'vpc'
  NatGateway:
    Type: 'AWS::EC2::NatGateway'
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
  PublicRoute:
    Type: 'AWS::EC2::Route'
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway
  PublicSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
  PrivateRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway
  PrivateSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable
  VPCPeeringConnection:
    Type: 'AWS::EC2::VPCPeeringConnection'
    Condition: HasPeerVpcId
    Properties:
      VpcId: !Ref VPC
      PeerVpcId: !Ref PeerVpcId
      PeerRegion: !If [IsPrimaryRegion, 'us-west-2', 'us-east-1']
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-peering'
  PeeringRoute:
    Type: 'AWS::EC2::Route'
    Condition: HasPeerVpcId
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: !Ref PeerCidrBlock
      VpcPeeringConnectionId: !Ref VPCPeeringConnection
  BastionSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allow SSH access from admin IP'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: 'tcp'
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AdminCidrIp
  EC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for application EC2 instances'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: 'tcp'
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: 'tcp'
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref RDSSecurityGroup
  RDSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Allow inbound PostgreSQL traffic from EC2 instances'
      VpcId: !Ref VPC
  RDSSecurityGroupIngress:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref RDSSecurityGroup
      IpProtocol: 'tcp'
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref EC2SecurityGroup
  EC2InstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ['ec2.amazonaws.com'] }
            Action: ['sts:AssumeRole']
      Policies:
        - PolicyName: 'S3AndKMSAccess'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: 'S3ListAndObjectActions'
                Effect: Allow
                Action:
                  [
                    's3:GetObject',
                    's3:PutObject',
                    's3:DeleteObject',
                    's3:ListBucket',
                  ]
                Resource: [!GetAtt DataBucket.Arn, !Sub '${DataBucket.Arn}/*']
              - Sid: 'KMSAccess'
                Effect: Allow
                Action: ['kms:Decrypt', 'kms:GenerateDataKey*']
                Resource: !GetAtt KMSKey.Arn
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
  EC2InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Roles: [!Ref EC2InstanceRole]
  DataBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub '${ProjectName}-${EnvironmentSuffix}-data-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt KMSKey.Arn
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: 'Enabled'
  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: 'Subnet group for RDS'
      SubnetIds: [!Ref PrivateSubnet]
  DBParameterGroup:
    Type: 'AWS::RDS::DBParameterGroup'
    Properties:
      Description: 'Parameter group for PostgreSQL with forced SSL'
      Family: 'postgres15'
      Parameters:
        rds.force_ssl: '1'
  PrimaryDBInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-${EnvironmentSuffix}-db'
      Engine: 'postgres'
      EngineVersion: '15.7'
      DBInstanceClass: 'db.t3.medium'
      AllocatedStorage: '20'
      StorageEncrypted: true
      KmsKeyId: !Ref KMSKey
      MasterUsername: 'nova_admin'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${ProjectName}-${EnvironmentSuffix}-db-password:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups: [!Ref RDSSecurityGroup]
      DBParameterGroupName: !Ref DBParameterGroup
      MultiAZ: false # Set to true for production workloads
      DeletionProtection: true
      EnablePerformanceInsights: true
      PerformanceInsightsKMSKeyId: !Ref KMSKey
  AppServerInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't3.micro'
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      SubnetId: !Ref PrivateSubnet
      SecurityGroupIds: [!Ref EC2SecurityGroup]
      IamInstanceProfile: !Ref EC2InstanceProfile
      BlockDeviceMappings:
        - DeviceName: '/dev/xvda'
          Ebs:
            VolumeSize: 10
            VolumeType: 'gp3'
            Encrypted: true
            KmsKeyId: !Ref KMSKey
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-app-server'
  CloudTrailLogBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub '${ProjectName}-${EnvironmentSuffix}-cloudtrail-logs-${AWS::AccountId}-${AWS::Region}'
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt KMSKey.Arn
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: 'Enabled'
  CloudTrailLogBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref CloudTrailLogBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AWSCloudTrailAclCheck'
            Effect: Allow
            Principal: { Service: 'cloudtrail.amazonaws.com' }
            Action: 's3:GetBucketAcl'
            Resource: !GetAtt CloudTrailLogBucket.Arn
          - Sid: 'AWSCloudTrailWrite'
            Effect: Allow
            Principal: { Service: 'cloudtrail.amazonaws.com' }
            Action: 's3:PutObject'
            Resource: !Sub '${CloudTrailLogBucket.Arn}/AWSLogs/${AWS::AccountId}/*'
  CloudTrail:
    Type: 'AWS::CloudTrail::Trail'
    DependsOn: CloudTrailLogBucketPolicy
    Properties:
      S3BucketName: !Ref CloudTrailLogBucket
      KMSKeyId: !Ref KMSKey
      IsLogging: true
      IsMultiRegionTrail: true
      IncludeGlobalServiceEvents: true
  VPCFlowLogsLogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '/aws/vpc-flow-logs/${ProjectName}-${EnvironmentSuffix}'
      RetentionInDays: 90
      KmsKeyId: !GetAtt KMSKey.Arn
  VPCFlowLogs:
    Type: 'AWS::EC2::FlowLog'
    Properties:
      ResourceType: 'VPC'
      ResourceId: !Ref VPC
      TrafficType: 'ALL'
      LogDestinationType: 'cloud-watch-logs'
      LogGroupName: !Ref VPCFlowLogsLogGroup

Outputs:
  VPCId:
    Description: 'ID of the created VPC'
    Value: !Ref VPC
  EC2InstanceId:
    Description: 'ID of the application server instance'
    Value: !Ref AppServerInstance
  RDSEndpoint:
    Description: 'Endpoint address of the RDS database instance'
    Value: !GetAtt PrimaryDBInstance.Endpoint.Address
  DataBucketName:
    Description: 'Name of the primary S3 data bucket'
    Value: !Ref DataBucket

  StackName:
    Description: 'Name of this CloudFormation stack'
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  EnvironmentSuffix:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

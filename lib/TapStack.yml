AWSTemplateFormatVersion: '2010-09-09'
Description: 'Enterprise-grade web application infrastructure with comprehensive security, monitoring, and operational excellence - Production Ready'

# ====================
# METADATA
# ====================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - EnvironmentName
          - ProjectName
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - DatabaseSubnet1CIDR
          - DatabaseSubnet2CIDR
      - Label:
          default: "Compute Configuration"
        Parameters:
          - InstanceType
          - BastionInstanceType
          - KeyPairName
          - MinSize
          - MaxSize
          - DesiredCapacity
      - Label:
          default: "Database Configuration"
        Parameters:
          - DatabaseInstanceClass
          - DatabaseName
          - DatabaseUsername
      - Label:
          default: "Security & Monitoring"
        Parameters:
          - SSLCertificateArn
          - AlertEmail
          - EnableEnhancedMonitoring

# ====================
# PARAMETERS
# ====================
Parameters:
  EnvironmentName:
    Description: Environment name prefix for resources
    Type: String
    Default: Production
    AllowedValues:
      - Development
      - Staging
      - Production
    
  ProjectName:
    Description: Project name for tagging
    Type: String
    Default: WebApplication
    
  VpcCIDR:
    Description: CIDR block for the VPC
    Type: String
    Default: 10.0.0.0/16
    MinLength: 9
    MaxLength: 18
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    
  PublicSubnet1CIDR:
    Description: CIDR block for public subnet in AZ1
    Type: String
    Default: 10.0.1.0/24
    
  PublicSubnet2CIDR:
    Description: CIDR block for public subnet in AZ2
    Type: String
    Default: 10.0.2.0/24
    
  PrivateSubnet1CIDR:
    Description: CIDR block for private subnet in AZ1
    Type: String
    Default: 10.0.10.0/24
    
  PrivateSubnet2CIDR:
    Description: CIDR block for private subnet in AZ2
    Type: String
    Default: 10.0.11.0/24
    
  DatabaseSubnet1CIDR:
    Description: CIDR block for database subnet in AZ1
    Type: String
    Default: 10.0.20.0/24
    
  DatabaseSubnet2CIDR:
    Description: CIDR block for database subnet in AZ2
    Type: String
    Default: 10.0.21.0/24
    
  InstanceType:
    Description: EC2 instance type for application servers
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t2.small
      - t2.medium
      - t3.micro
      - t3.small
      
  BastionInstanceType:
    Description: EC2 instance type for bastion host
    Type: String
    Default: t2.micro
    
  KeyPairName:
    Description: EC2 Key Pair for SSH access (leave empty for Session Manager only)
    Type: String
    Default: ''
    
  DatabaseInstanceClass:
    Description: RDS database instance class
    Type: String
    Default: db.t3.micro
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
    
  DatabaseName:
    Description: Database name
    Type: String
    Default: webappdb
    MinLength: 1
    MaxLength: 64
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    
  DatabaseUsername:
    Description: Database master username
    Type: String
    Default: dbadmin
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    NoEcho: true
    
  MinSize:
    Description: Minimum number of EC2 instances in Auto Scaling Group
    Type: Number
    Default: 2
    MinValue: 1
    
  MaxSize:
    Description: Maximum number of EC2 instances in Auto Scaling Group
    Type: Number
    Default: 4
    MinValue: 2
    
  DesiredCapacity:
    Description: Desired number of EC2 instances in Auto Scaling Group
    Type: Number
    Default: 2
    MinValue: 1
    
  SSLCertificateArn:
    Description: ARN of ACM SSL certificate for HTTPS (leave empty for HTTP only)
    Type: String
    Default: ''
    
  AlertEmail:
    Description: Email address for CloudWatch alarm notifications
    Type: String
    Default: 'alerts@example.com'
    AllowedPattern: '([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})'
    
  EnableEnhancedMonitoring:
    Description: Enable enhanced monitoring and logging
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

# ====================
# CONDITIONS
# ====================
Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]
  HasSSLCertificate: !Not [!Equals [!Ref SSLCertificateArn, '']]
  IsProduction: !Equals [!Ref EnvironmentName, 'Production']
  EnableMonitoring: !Equals [!Ref EnableEnhancedMonitoring, 'true']

# ====================
# RESOURCES
# ====================
Resources:
  # ====================
  # SECRETS MANAGER
  # ====================
  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'webapp-database-secret-${AWS::StackName}'
      Description: RDS database master password
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username": "${DatabaseUsername}"}'
        GenerateStringKey: 'password'
        PasswordLength: 32
        ExcludePunctuation: true
        ExcludeCharacters: '/@" '
        RequireEachIncludedType: true
      Tags:
        - Key: Name
          Value: webapp-database-secret
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
          
  # ====================
  # VPC AND NETWORKING
  # ====================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: webapp-vpc
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
          
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: webapp-igw
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
          
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
      
  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref PublicSubnet1CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: webapp-public-subnet-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Public
          
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Ref PublicSubnet2CIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: webapp-public-subnet-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Public
          
  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet1CIDR
      Tags:
        - Key: Name
          Value: webapp-private-subnet-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Private
          
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Ref PrivateSubnet2CIDR
      Tags:
        - Key: Name
          Value: webapp-private-subnet-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Private
          
  # Database Subnets
  DatabaseSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Ref DatabaseSubnet1CIDR
      Tags:
        - Key: Name
          Value: webapp-database-subnet-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Database
          
  DatabaseSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Ref DatabaseSubnet2CIDR
      Tags:
        - Key: Name
          Value: webapp-database-subnet-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Database
          
  # NAT Gateways for Private Subnets
  NatGatewayEIP1:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: webapp-nat-eip-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
      
  NatGatewayEIP2:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: webapp-nat-eip-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
      
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: webapp-nat-gateway-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP2.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: webapp-nat-gateway-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: webapp-public-routes
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1
      
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2
      
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: webapp-private-routes-az1
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1
      
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1
      
  DatabaseSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref DatabaseSubnet1
      
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: webapp-private-routes-az2
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2
      
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2
      
  DatabaseSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref DatabaseSubnet2
      
  # ====================
  # SECURITY GROUPS
  # ====================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: webapp-alb-sg
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP traffic
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS traffic
      Tags:
        - Key: Name
          Value: webapp-alb-sg
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: webapp-webserver-sg
      GroupDescription: Security group for web servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTP from ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTPS from ALB
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: Allow SSH from Bastion
      Tags:
        - Key: Name
          Value: webapp-webserver-sg
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: webapp-database-sg
      GroupDescription: Security group for RDS database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref WebServerSecurityGroup
          Description: Allow PostgreSQL from web servers
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: Allow PostgreSQL from Bastion for maintenance
      Tags:
        - Key: Name
          Value: webapp-database-sg
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: webapp-bastion-sg
      GroupDescription: Security group for bastion host
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: Allow SSH from anywhere (restrict in production)
      Tags:
        - Key: Name
          Value: webapp-bastion-sg
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  # ====================
  # S3 BUCKETS
  # ====================
  ApplicationLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'webapp-application-logs-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
      VersioningConfiguration:
        Status: Enabled
      NotificationConfiguration:
        LambdaConfigurations: []
      Tags:
        - Key: Name
          Value: webapp-application-logs
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
          
  VPCFlowLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'webapp-vpc-flow-logs-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 30
          - Id: TransitionToGlacier
            Status: Enabled
            Transitions:
              - TransitionInDays: 7
                StorageClass: GLACIER
      Tags:
        - Key: Name
          Value: webapp-vpc-flow-logs
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  # ====================
  # CLOUDWATCH LOG GROUPS
  # ====================
  VPCFlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableMonitoring
    Properties:
      LogGroupName: /aws/vpc/flowlogs
      RetentionInDays: 7
      
  ApplicationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/webapp/application
      RetentionInDays: 30
      
  # ====================
  # VPC FLOW LOGS
  # ====================
  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: webapp-vpc-flow-logs-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: webapp-vpc-flow-logs-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:GetBucketLocation'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt VPCFlowLogsBucket.Arn
                  - !Sub '${VPCFlowLogsBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                Resource: '*'
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'
                  
  VPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: s3
      LogDestination: !GetAtt VPCFlowLogsBucket.Arn
      LogFormat: '${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${action} ${log-status}'
      Tags:
        - Key: Name
          Value: webapp-vpc-flow-log
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  VPCFlowLogToCloudWatch:
    Type: AWS::EC2::FlowLog
    Condition: EnableMonitoring
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogsLogGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      Tags:
        - Key: Name
          Value: webapp-vpc-flow-log-cloudwatch
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  # ====================
  # IAM ROLES
  # ====================
  WebServerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: webapp-webserver-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: webapp-s3-logs-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:PutObject'
                  - 's3:PutObjectAcl'
                  - 's3:GetObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt ApplicationLogsBucket.Arn
                  - !Sub '${ApplicationLogsBucket.Arn}/*'
        - PolicyName: webapp-secrets-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetSecretValue'
                Resource: !Ref DatabaseSecret
        - PolicyName: webapp-ssm-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ssm:GetParameter'
                  - 'ssm:GetParameters'
                  - 'ssm:GetParametersByPath'
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/webapp/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}::parameter/aws/service/ami-amazon-linux-latest/*'
        - PolicyName: webapp-cloudwatch-logs-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: !GetAtt ApplicationLogGroup.Arn
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'
                
  WebServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: webapp-webserver-profile
      Roles:
        - !Ref WebServerRole
        
  BastionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: webapp-bastion-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  BastionInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: webapp-bastion-profile
      Roles:
        - !Ref BastionRole
        
  # ====================
  # LOAD BALANCER
  # ====================
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: webapp-alb
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: webapp-alb
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
          
  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: webapp-tg
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200-299
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'
        - Key: stickiness.enabled
          Value: 'true'
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: '86400'
      Tags:
        - Key: Name
          Value: webapp-target-group
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  # HTTP Listener with redirect to HTTPS
  ALBListenerHTTP:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - !If
          - HasSSLCertificate
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      
  # HTTPS Listener
  ALBListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasSSLCertificate
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref SSLCertificateArn
      SslPolicy: ELBSecurityPolicy-TLS-1-2-2017-01
      
  # ====================
  # SSM PARAMETER FOR AMI
  # ====================
  LatestAmiIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /webapp/ami/latest
      Type: String
      Value: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
      Description: Latest Amazon Linux 2 AMI ID
      Tags:
        iac-rlhf-amazon: 'true'
        
  # ====================
  # AUTO SCALING
  # ====================
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: webapp-launch-template
      LaunchTemplateData:
        ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
        InstanceType: !Ref InstanceType
        KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
        IamInstanceProfile:
          Arn: !GetAtt WebServerInstanceProfile.Arn
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 20
              VolumeType: gp3
              Encrypted: true
              DeleteOnTermination: true
        MetadataOptions:
          HttpEndpoint: enabled
          HttpTokens: required
          HttpPutResponseHopLimit: 1
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash -xe
            # Update system
            yum update -y
            
            # Install required packages
            yum install -y httpd aws-cfn-bootstrap amazon-cloudwatch-agent mysql jq
            
            # Configure CloudWatch agent
            cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'
            {
              "metrics": {
                "namespace": "WebApp",
                "metrics_collected": {
                  "mem": {
                    "measurement": [{"name": "mem_used_percent"}]
                  },
                  "disk": {
                    "measurement": [{"name": "used_percent"}],
                    "resources": ["*"]
                  }
                }
              },
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/log/httpd/access_log",
                        "log_group_name": "${ApplicationLogGroup}",
                        "log_stream_name": "{instance_id}/httpd/access"
                      },
                      {
                        "file_path": "/var/log/httpd/error_log",
                        "log_group_name": "${ApplicationLogGroup}",
                        "log_stream_name": "{instance_id}/httpd/error"
                      }
                    ]
                  }
                }
              }
            }
            EOF
            
            # Start CloudWatch agent
            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config \
              -m ec2 \
              -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            
            # Get database credentials from Secrets Manager
            SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id ${DatabaseSecret} --region ${AWS::Region} --query SecretString --output text)
            DB_PASSWORD=$(echo $SECRET_JSON | jq -r .password)
            
            # Configure application
            cat > /var/www/html/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head><title>Web Application</title></head>
            <body>
            <h1>Web Application Infrastructure</h1>
            <p>Instance: $(hostname -f)</p>
            <p>Region: ${AWS::Region}</p>
            <p>Environment: ${EnvironmentName}</p>
            </body>
            </html>
            EOF
            
            # Health check endpoint
            cat > /var/www/html/health << 'EOF'
            OK
            EOF
            
            # Configure log rotation and S3 upload
            cat > /usr/local/bin/upload-logs.sh << 'EOF'
            #!/bin/bash
            LOG_DATE=$(date +%Y-%m-%d-%H)
            INSTANCE_ID=$(ec2-metadata --instance-id | cut -d " " -f 2)
            aws s3 cp /var/log/httpd/access_log s3://${ApplicationLogsBucket}/httpd/$INSTANCE_ID/access_log-$LOG_DATE --storage-class STANDARD_IA
            aws s3 cp /var/log/httpd/error_log s3://${ApplicationLogsBucket}/httpd/$INSTANCE_ID/error_log-$LOG_DATE --storage-class STANDARD_IA
            EOF
            chmod +x /usr/local/bin/upload-logs.sh
            
            # Add to crontab
            echo "0 * * * * /usr/local/bin/upload-logs.sh" | crontab -
            
            # Start services
            systemctl start httpd
            systemctl enable httpd
            
            # Signal CloudFormation
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AutoScalingGroup --region ${AWS::Region}
      TagSpecifications:
        - ResourceType: launch-template
          Tags:
            - Key: Name
              Value: webapp-launch-template
            - Key: iac-rlhf-amazon
              Value: 'true'
            
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: webapp-asg
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: '$Latest'
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      TargetGroupARNs:
        - !Ref ALBTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      MetricsCollection:
        - Granularity: 1Minute
      Tags:
        - Key: Name
          Value: webapp-instance
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref EnvironmentName
          PropagateAtLaunch: true
        - Key: iac-rlhf-amazon
          Value: 'true'
          PropagateAtLaunch: true
        - Key: Project
          Value: !Ref ProjectName
          PropagateAtLaunch: true
    CreationPolicy:
      ResourceSignal:
        Count: !Ref DesiredCapacity
        Timeout: PT15M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 2
        PauseTime: PT5M
        WaitOnResourceSignals: true
          
  ScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 70.0
        
  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: SimpleScaling
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: 1
      Cooldown: 300
      
  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      PolicyType: SimpleScaling
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: -1
      Cooldown: 300
        
  # ====================
  # RDS DATABASE
  # ====================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: webapp-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS database
      SubnetIds:
        - !Ref DatabaseSubnet1
        - !Ref DatabaseSubnet2
      Tags:
        - Key: Name
          Value: webapp-db-subnet-group
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: !Ref DatabaseName
      Engine: postgres
      EngineVersion: '15'
      DBInstanceClass: !Ref DatabaseInstanceClass
      AllocatedStorage: 20
      MaxAllocatedStorage: 100
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '03:00-04:00'
      PreferredMaintenanceWindow: 'sun:04:00-sun:05:00'
      MultiAZ: !If [IsProduction, true, false]
      EnableCloudwatchLogsExports:
        - error
        - general
        - slowquery
      Tags:
        - Key: Name
          Value: webapp-database
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
          
  DatabaseSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref DatabaseSecret
      TargetId: !Ref DatabaseInstance
      TargetType: AWS::RDS::DBInstance
          
  # ====================
  # BASTION HOST
  # ====================
  BastionHost:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      InstanceType: !Ref BastionInstanceType
      KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
      SubnetId: !Ref PublicSubnet1
      IamInstanceProfile: !Ref BastionInstanceProfile
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 8
            VolumeType: gp3
            Encrypted: true
            DeleteOnTermination: true
      MetadataOptions:
        HttpEndpoint: enabled
        HttpTokens: required
      UserData:
        Fn::Base64: |
          #!/bin/bash -xe
          yum update -y
          
          # Install SSM agent and other tools
          yum install -y amazon-ssm-agent mysql
          systemctl start amazon-ssm-agent
          systemctl enable amazon-ssm-agent
          
          # Install Session Manager plugin
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm" -o "session-manager-plugin.rpm"
          yum install -y session-manager-plugin.rpm
          
          # Configure SSH timeout
          echo "ClientAliveInterval 60" >> /etc/ssh/sshd_config
          echo "ClientAliveCountMax 10" >> /etc/ssh/sshd_config
          systemctl restart sshd
      Tags:
        - Key: Name
          Value: webapp-bastion-host
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName
          
  # ====================
  # CLOUDWATCH ALARMS & MONITORING
  # ====================
  SNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: webapp-alerts
      DisplayName: WebApp Infrastructure Alerts
      Subscription:
        - Endpoint: !Ref AlertEmail
          Protocol: email
      Tags:
        - Key: iac-rlhf-amazon
          Value: 'true'
          
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: webapp-high-cpu
      AlarmDescription: Alarm when CPU exceeds 80%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref SNSTopic
        - !Ref ScaleUpPolicy
      OKActions:
        - !Ref ScaleDownPolicy
        
  LowCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: webapp-low-cpu
      AlarmDescription: Alarm when CPU is below 25%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 25
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref ScaleDownPolicy
        
  UnHealthyHostAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: webapp-unhealthy-hosts
      AlarmDescription: Alarm when we have unhealthy hosts
      MetricName: UnHealthyHostCount
      Namespace: AWS/ApplicationELB
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 0
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TargetGroup
          Value: !GetAtt ALBTargetGroup.TargetGroupFullName
        - Name: LoadBalancer
          Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
      AlarmActions:
        - !Ref SNSTopic
        
  DatabaseCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: webapp-database-cpu
      AlarmDescription: Alarm when database CPU exceeds 75%
      MetricName: CPUUtilization
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 75
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DatabaseInstance
      AlarmActions:
        - !Ref SNSTopic
        
  DatabaseStorageAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: webapp-database-storage
      AlarmDescription: Alarm when free storage is less than 10%
      MetricName: FreeStorageSpace
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 2147483648  # 2GB in bytes
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref DatabaseInstance
      AlarmActions:
        - !Ref SNSTopic
        
  # ====================
  # CLOUDWATCH DASHBOARD
  # ====================
  CloudWatchDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: EnableMonitoring
    Properties:
      DashboardName: webapp-dashboard
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/ApplicationELB", "TargetResponseTime"],
                  [".", "RequestCount"]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "ALB Metrics"
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/EC2", "CPUUtilization", "AutoScalingGroupName", "${AutoScalingGroup}"],
                  [".", "NetworkIn", ".", "."]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "EC2 Metrics"
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/RDS", "CPUUtilization", "DBInstanceIdentifier", "${DatabaseInstance}"],
                  [".", "DatabaseConnections", ".", "."]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "RDS Metrics"
              }
            }
          ]
        }
        
  # ====================
  # AWS BACKUP - REMOVED (Not fully supported in LocalStack)
  # ====================
  # BackupVault, BackupPlan, BackupSelection, and BackupRole removed
  # RDS automated backups are still enabled via BackupRetentionPeriod

# ====================
# OUTPUTS
# ====================
Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'
      
  VPCCidr:
    Description: VPC CIDR block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub '${AWS::StackName}-VPC-CIDR'
      
  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1-ID'
      
  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2-ID'
      
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1-ID'
      
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2-ID'
      
  DatabaseSubnet1Id:
    Description: Database Subnet 1 ID
    Value: !Ref DatabaseSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseSubnet1-ID'
      
  DatabaseSubnet2Id:
    Description: Database Subnet 2 ID
    Value: !Ref DatabaseSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseSubnet2-ID'
      
  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-ALB-DNS'
      
  LoadBalancerArn:
    Description: ARN of the Application Load Balancer
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub '${AWS::StackName}-ALB-ARN'
      
  LoadBalancerURL:
    Description: URL of the Application Load Balancer
    Value: !If
      - HasSSLCertificate
      - !Sub 'https://${ApplicationLoadBalancer.DNSName}'
      - !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-ALB-URL'
      
  ApplicationLogsBucketName:
    Description: Name of S3 bucket for application logs
    Value: !Ref ApplicationLogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-AppLogs-Bucket'
      
  ApplicationLogsBucketArn:
    Description: ARN of S3 bucket for application logs
    Value: !GetAtt ApplicationLogsBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AppLogs-Bucket-ARN'
      
  VPCFlowLogsBucketName:
    Description: Name of S3 bucket for VPC flow logs
    Value: !Ref VPCFlowLogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-FlowLogs-Bucket'
      
  VPCFlowLogsBucketArn:
    Description: ARN of S3 bucket for VPC flow logs
    Value: !GetAtt VPCFlowLogsBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FlowLogs-Bucket-ARN'
      
  DatabaseEndpoint:
    Description: RDS database endpoint
    Value: !GetAtt DatabaseInstance.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-DB-Endpoint'
      
  DatabasePort:
    Description: RDS database port
    Value: !GetAtt DatabaseInstance.Endpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-DB-Port'
      
  DatabaseSecretArn:
    Description: ARN of the database secret in Secrets Manager
    Value: !Ref DatabaseSecret
    Export:
      Name: !Sub '${AWS::StackName}-DB-Secret-ARN'
      
  BastionHostInstanceId:
    Description: Instance ID of bastion host
    Value: !Ref BastionHost
    Export:
      Name: !Sub '${AWS::StackName}-Bastion-ID'
      
  BastionHostPublicIP:
    Description: Public IP of bastion host
    Value: !GetAtt BastionHost.PublicIp
    Export:
      Name: !Sub '${AWS::StackName}-Bastion-IP'
      
  BastionSSMSessionCommand:
    Description: AWS CLI command to connect to bastion via Session Manager
    Value: !Sub 'aws ssm start-session --target ${BastionHost} --region ${AWS::Region}'
    Export:
      Name: !Sub '${AWS::StackName}-Bastion-SSM-Command'
      
  AutoScalingGroupName:
    Description: Name of the Auto Scaling Group
    Value: !Ref AutoScalingGroup
    Export:
      Name: !Sub '${AWS::StackName}-ASG-Name'
      
  LaunchTemplateId:
    Description: ID of the Launch Template
    Value: !Ref LaunchTemplate
    Export:
      Name: !Sub '${AWS::StackName}-LaunchTemplate-ID'
      
  LaunchTemplateVersion:
    Description: Latest version of the Launch Template
    Value: !GetAtt LaunchTemplate.LatestVersionNumber
    Export:
      Name: !Sub '${AWS::StackName}-LaunchTemplate-Version'
      
  ALBSecurityGroupId:
    Description: Security Group ID for ALB
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ALB-SG-ID'
      
  WebServerSecurityGroupId:
    Description: Security Group ID for Web Servers
    Value: !Ref WebServerSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-WebServer-SG-ID'
      
  DatabaseSecurityGroupId:
    Description: Security Group ID for Database
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Database-SG-ID'
      
  BastionSecurityGroupId:
    Description: Security Group ID for Bastion
    Value: !Ref BastionSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Bastion-SG-ID'
      
  SNSTopicArn:
    Description: ARN of SNS Topic for alerts
    Value: !Ref SNSTopic
    Export:
      Name: !Sub '${AWS::StackName}-SNS-Topic-ARN'
      
  CloudWatchDashboardURL:
    Description: URL to CloudWatch Dashboard
    Condition: EnableMonitoring
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=webapp-dashboard'
    Export:
      Name: !Sub '${AWS::StackName}-Dashboard-URL'
      
  # BackupVaultArn and BackupPlanId outputs removed (AWS Backup not supported in LocalStack)

  StackName:
    Description: CloudFormation Stack Name
    Value: !Ref AWS::StackName
    Export:
      Name: !Sub '${AWS::StackName}-Stack-Name'
      
  StackId:
    Description: CloudFormation Stack ID
    Value: !Ref AWS::StackId
    Export:
      Name: !Sub '${AWS::StackName}-Stack-ID'
      
  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
    Export:
      Name: !Sub '${AWS::StackName}-Region'
      
  AccountId:
    Description: AWS Account ID
    Value: !Ref AWS::AccountId
    Export:
      Name: !Sub '${AWS::StackName}-Account-ID'
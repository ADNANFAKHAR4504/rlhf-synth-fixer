AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Deploys a highly available and scalable Node.js web application using AWS Elastic Beanstalk.
  This template includes the necessary IAM roles to create a stable, empty environment.

Parameters:
  ApplicationName:
    Type: String
    Description: The name of the Elastic Beanstalk application.
    Default: MyNodeJsApp

  InstanceType:
    Type: String
    Description: EC2 instance type for the web application servers.
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t3.micro
      - t3.small
      - m5.large

Resources:
  # --- IAM Roles and Profiles ---
  # Service Role for Elastic Beanstalk to manage other AWS services
  AWSElasticBeanstalkServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: elasticbeanstalk.amazonaws.com
            Action: sts:AssumeRole
      # WARNING: AdministratorAccess is for development/testing only.
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  # IAM Role for the EC2 instances launched by Elastic Beanstalk
  AWSElasticBeanstalkEC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      # WARNING: AdministratorAccess is for development/testing only.
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  # Instance Profile to attach the role to the EC2 instances
  AWSElasticBeanstalkEC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref AWSElasticBeanstalkEC2Role

  # --- Elastic Beanstalk Application ---
  WebAppApplication:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: !Ref ApplicationName
      Description: AWS Elastic Beanstalk application for our Node.js app.

  # REMOVED: The SampleApplicationVersion resource has been removed to bypass S3 access errors.

  # --- Elastic Beanstalk Environment ---
  WebAppEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref WebAppApplication
      Description: Environment for the Node.js web application
      SolutionStackName: "64bit Amazon Linux 2 v5.11.1 running Node.js 18"
      # REMOVED: The VersionLabel property is no longer needed.
      OptionSettings:
        # --- IAM and Instance Configuration ---
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value: !Ref AWSElasticBeanstalkEC2InstanceProfile
        - Namespace: aws:autoscaling:launchconfiguration
          OptionName: InstanceType
          Value: !Ref InstanceType
        # --- Service Role Configuration ---
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: ServiceRole
          Value: !Ref AWSElasticBeanstalkServiceRole
        # --- High Availability and Scalability Configuration ---
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value: LoadBalanced
        - Namespace: aws:elasticbeanstalk:environment
          OptionName: LoadBalancerType
          Value: application
        # --- Auto Scaling Group Configuration ---
        - Namespace: aws:autoscaling:asg
          OptionName: MinSize
          Value: '2'
        - Namespace: aws:autoscaling:asg
          OptionName: MaxSize
          Value: '10'
        # --- Networking Configuration ---
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: ELBScheme
          Value: public

Outputs:
  EnvironmentURL:
    Description: The URL of the new Elastic Beanstalk environment.
    Value: !Sub "http://${WebAppEnvironment.EndpointURL}"

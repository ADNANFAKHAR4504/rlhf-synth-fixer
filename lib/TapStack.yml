AWSTemplateFormatVersion: '2010-09-09'
Description: 'A comprehensive, multi-region stack for the Task Assignment Platform, including secure compute, storage, and database resources.'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Application Environment Configuration'
        Parameters:
          - EnvironmentSuffix
          - LatestAmiId
      - Label:
          default: 'Network Configuration'
        Parameters:
          - TrustedIPForSSH

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming (e.g., dev, staging, prod).'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters.'
  TrustedIPForSSH:
    Type: String
    Description: 'The trusted IP address (CIDR format, e.g., 192.168.1.1/32) for SSH access to the EC2 instance.'
    Default: '0.0.0.0/0' # Note: For production, this should be locked down to a specific IP.
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
    Description: 'The SSM Parameter for the latest Amazon Linux 2 AMI ID.'

Resources:
  # --- Database Resources ---
  TurnAroundPromptTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub 'TurnAroundPromptTable-${EnvironmentSuffix}'
      AttributeDefinitions:
        - AttributeName: 'id'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'id'
          KeyType: 'HASH'
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref NovaKMSKey
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Database

  # --- Security & IAM Resources ---
  EC2AppRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: NovaAppLeastPrivilegePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: S3AccessPermissions
                Effect: Allow
                Action: [s3:GetObject, s3:ListBucket]
                Resource:
                  - !GetAtt NovaDataBucket.Arn
                  - !Sub '${NovaDataBucket.Arn}/*'
              - Sid: CloudWatchLogsPermissions
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/ec2/nova-app-${AWS::Region}:*'
              - Sid: KMSUsagePermission
                Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Resource: !GetAtt NovaKMSKey.Arn
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2AppRole

  NovaKMSKey:
    Type: AWS::KMS::Key
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Description: 'KMS key for Nova application encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAdminsToManageKey
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Resource: '*'
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  NovaKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/nova-app-key
      TargetKeyId: !Ref NovaKMSKey

  # --- Storage & Compute Resources ---
  NovaDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'nova-data-bucket-${AWS::AccountId}-${AWS::Region}-${EnvironmentSuffix}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref NovaKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  NovaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group for Nova application EC2 instances'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref TrustedIPForSSH
          Description: 'Allow SSH from trusted IP'
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  NovaEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t3.micro
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !GetAtt NovaSecurityGroup.GroupId
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 20
            Encrypted: true
            KmsKeyId: !Ref NovaKMSKey
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y
          yum install -y amazon-cloudwatch-agent
          cat > /opt/aws/amazon-cloudwatch-agent/etc/config.json << 'EOF'
          {
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "/aws/ec2/nova-app-${AWS::Region}",
                      "log_stream_name": "{instance_id}"
                    }
                  ]
                }
              }
            }
          }
          EOF
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json -s
      Tags:
        - Key: Owner
          Value: YourName
        - Key: Purpose
          Value: Nova-App-Baseline

  # --- AWS Config Resources ---
  ConfigRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: config.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSConfigRole

  ConfigBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'config-bucket-${AWS::AccountId}-${AWS::Region}-${EnvironmentSuffix}'

  ConfigBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ConfigBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSConfigBucketPermissionsCheck
            Effect: Allow
            Principal: { Service: config.amazonaws.com }
            Action: s3:GetBucketAcl
            Resource: !GetAtt ConfigBucket.Arn
          - Sid: AWSConfigBucketDelivery
            Effect: Allow
            Principal: { Service: config.amazonaws.com }
            Action: s3:PutObject
            Resource: !Sub '${ConfigBucket.Arn}/AWSLogs/${AWS::AccountId}/Config/*'
            Condition:
              StringEquals: { 's3:x-amz-acl': 'bucket-owner-full-control' }

  ConfigurationRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: false

  DeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Properties:
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: TwentyFour_Hours
      S3BucketName: !Ref ConfigBucket

  S3EncryptionRule:
    Type: AWS::Config::ConfigRule
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED
    DependsOn: ConfigurationRecorder

  EbsEncryptionRule:
    Type: AWS::Config::ConfigRule
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: ENCRYPTED_VOLUMES
    DependsOn: ConfigurationRecorder

  IamRolePolicyCheck:
    Type: AWS::Config::ConfigRule
    Properties:
      Source:
        Owner: AWS
        SourceIdentifier: IAM_ROLE_MANAGED_POLICY_CHECK
      InputParameters:
        managedPolicyArns: 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
    DependsOn: ConfigurationRecorder

Outputs:
  TurnAroundPromptTableName:
    Description: 'Name of the DynamoDB table'
    Value: !Ref TurnAroundPromptTable
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableName'

  TurnAroundPromptTableArn:
    Description: 'ARN of the DynamoDB table'
    Value: !GetAtt TurnAroundPromptTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-TurnAroundPromptTableArn'

  EnvironmentSuffixOutput:
    Description: 'Environment suffix used for this deployment'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

  KMSKeyArn:
    Description: 'ARN of the regional KMS Key'
    Value: !GetAtt NovaKMSKey.Arn
  S3BucketName:
    Description: 'Name of the regional S3 Bucket'
    Value: !Ref NovaDataBucket
  EC2InstanceId:
    Description: 'ID of the regional EC2 Instance'
    Value: !Ref NovaEC2Instance

AWSTemplateFormatVersion: "2010-09-09"
Description: >
  TapStack.yml â€” Secure and Scalable Web Application Infrastructure.
  Provisions VPC, Subnets, IGW, NAT, Security Groups, ALB (HTTPS),
  Auto Scaling Group, CloudWatch Alarms, and S3 Logs with versioning.

Parameters:
  EnvironmentName:
    Type: String
    Default: prod
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name for tagging and resource naming

  VpcCIDR:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC

  PublicSubnet1CIDR:
    Type: String
    Default: 10.0.1.0/24
  PublicSubnet2CIDR:
    Type: String
    Default: 10.0.2.0/24
  PrivateSubnet1CIDR:
    Type: String
    Default: 10.0.11.0/24
  PrivateSubnet2CIDR:
    Type: String
    Default: 10.0.12.0/24

  InstanceType:
    Type: String
    Default: t3.micro
    Description: EC2 instance type for Auto Scaling Group

  KeyName:
    Type: String
    Default: ""
    Description: (Optional) Name of an existing EC2 KeyPair. Leave blank to disable SSH access.

  CertificateArn:
    Type: String
    Default: ""
    Description: (Optional) ACM certificate ARN for HTTPS. Leave blank to skip HTTPS listener.

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux 2 AMI ID from SSM Parameter Store

Conditions:
  HasKeyName: !Not [!Equals [!Ref KeyName, ""]]
  HasCertificate: !Not [!Equals [!Ref CertificateArn, ""]]

Resources:

  ## Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-vpc"

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-az1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-az2"

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1CIDR
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-private-az1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2CIDR
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-private-az2"

  ## Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  ## NAT + EIPs
  NatEIP1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP1.AllocationId
      SubnetId: !Ref PublicSubnet1

  NatEIP2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP2.AllocationId
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  ## Security Groups
  LoadBalancerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and HTTPS
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  InstanceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow only from ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref LoadBalancerSG

  ## Launch Template
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        ImageId: !Ref LatestAmiId
        SecurityGroupIds:
          - !Ref InstanceSG
        KeyName: !If [HasKeyName, !Ref KeyName, !Ref AWS::NoValue]
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${EnvironmentName}-app-instance"

  ## Auto Scaling
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 4
      DesiredCapacity: 2
      TargetGroupARNs:
        - !Ref TargetGroup
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-asg"
          PropagateAtLaunch: true

  ## ALB
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${EnvironmentName}-alb"
      Scheme: internet-facing
      SecurityGroups: [!Ref LoadBalancerSG]
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VPC
      Protocol: HTTP
      Port: 80
      TargetType: instance
      HealthCheckPath: /
      Matcher:
        HttpCode: 200

  ListenerHTTP:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  ListenerHTTPS:
    Condition: HasCertificate
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  ## CloudWatch Alarms
  CPUAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: High CPU alarm
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 70
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref ScaleUpPolicy

  CPUAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Low CPU alarm
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 20
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref ScaleDownPolicy

  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: 1

  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: -1

  ## S3 Logs
  LogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${EnvironmentName}-tapstack-logs-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-logs"

Outputs:
  VPCId:
    Description: VPC ID for the environment
    Value: !Ref VPC
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-VPCId"

  PrivateSubnet1Id:
    Description: ID of the first private subnet
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-PrivateSubnet1Id"

  PrivateSubnet2Id:
    Description: ID of the second private subnet
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-PrivateSubnet2Id"

  PublicSubnet1Id:
    Description: ID of the first public subnet
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-PublicSubnet1Id"

  PublicSubnet2Id:
    Description: ID of the second public subnet
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-PublicSubnet2Id"

  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-InternetGatewayId"

  NatGateway1Id:
    Description: NAT Gateway in AZ1
    Value: !Ref NatGateway1
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-NatGateway1Id"

  NatGateway2Id:
    Description: NAT Gateway in AZ2
    Value: !Ref NatGateway2
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-NatGateway2Id"

  LoadBalancerArn:
    Description: Application Load Balancer ARN
    Value: !Ref LoadBalancer
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LoadBalancerArn"

  LoadBalancerDNS:
    Description: DNS name of the ALB
    Value: !GetAtt LoadBalancer.DNSName
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LoadBalancerDNS"

  TargetGroupArn:
    Description: Target Group ARN
    Value: !Ref TargetGroup
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-TargetGroupArn"

  ListenerHTTPArn:
    Description: ARN of the HTTP listener
    Value: !Ref ListenerHTTP
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-ListenerHTTPArn"

  ListenerHTTPSArn:
    Condition: HasCertificate
    Description: ARN of the HTTPS listener
    Value: !Ref ListenerHTTPS
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-ListenerHTTPSArn"

  AutoScalingGroupName:
    Description: Auto Scaling Group logical name
    Value: !Ref AutoScalingGroup
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-AutoScalingGroupName"

  LaunchTemplateId:
    Description: EC2 Launch Template ID
    Value: !Ref LaunchTemplate
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LaunchTemplateId"

  LaunchTemplateVersion:
    Description: Latest version number of Launch Template
    Value: !GetAtt LaunchTemplate.LatestVersionNumber
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LaunchTemplateVersion"

  InstanceSecurityGroupId:
    Description: Security Group ID for EC2 instances
    Value: !Ref InstanceSG
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-InstanceSecurityGroupId"

  LoadBalancerSecurityGroupId:
    Description: Security Group ID for ALB
    Value: !Ref LoadBalancerSG
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LoadBalancerSecurityGroupId"

  LogBucketName:
    Description: Centralized S3 Log Bucket
    Value: !Ref LogBucket
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LogBucketName"

  LogBucketArn:
    Description: ARN of the S3 Log Bucket
    Value: !GetAtt LogBucket.Arn
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-LogBucketArn"

  CPUAlarmHighName:
    Description: Name of the High CPU CloudWatch Alarm
    Value: !Ref CPUAlarmHigh
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-CPUAlarmHigh"

  CPUAlarmLowName:
    Description: Name of the Low CPU CloudWatch Alarm
    Value: !Ref CPUAlarmLow
    Export:
      Name: !Sub "${EnvironmentName}-${AWS::StackName}-CPUAlarmLow"

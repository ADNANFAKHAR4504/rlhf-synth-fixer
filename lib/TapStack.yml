AWSTemplateFormatVersion: '2010-09-09'
Description: TapStack for isolated environments (dev/staging/prod)

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, staging, prod]
    Default: dev
    Description: Environment name (dev, staging, or prod)
  ProjectName:
    Type: String
    Default: tapstack
    Description: Project name (must start with lowercase letter)
  Owner:
    Type: String
    Default: team
    Description: Owner of the stack
  TeamPrincipalARN:
    Type: String
    Default: ''
    Description: Optional IAM principal ARN for role trust policy
  CreateNatPerAZ:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Create NAT Gateway per Availability Zone

Mappings:
  EnvironmentConfig:
    dev:
      CIDR: 10.0.0.0/16
      PublicSubnetA: 10.0.0.0/18
      PublicSubnetB: 10.0.64.0/18
      PrivateSubnetA: 10.0.128.0/18
      PrivateSubnetB: 10.0.192.0/18
    staging:
      CIDR: 10.1.0.0/16
      PublicSubnetA: 10.1.0.0/18
      PublicSubnetB: 10.1.64.0/18
      PrivateSubnetA: 10.1.128.0/18
      PrivateSubnetB: 10.1.192.0/18
    prod:
      CIDR: 10.2.0.0/16
      PublicSubnetA: 10.2.0.0/18
      PublicSubnetB: 10.2.64.0/18
      PrivateSubnetA: 10.2.128.0/18
      PrivateSubnetB: 10.2.192.0/18

Conditions:
  CreateNatPerAZ: !Equals [!Ref CreateNatPerAZ, 'true']
  SingleNat: !Equals [!Ref CreateNatPerAZ, 'false']
  HasTeamPrincipal: !Not [!Equals [!Ref TeamPrincipalARN, '']]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [EnvironmentConfig, !Ref Environment, CIDR]
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vpc
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-igw
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [EnvironmentConfig, !Ref Environment, PublicSubnetA]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-a
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [EnvironmentConfig, !Ref Environment, PublicSubnetB]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-b
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [EnvironmentConfig, !Ref Environment, PrivateSubnetA]
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-a
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [EnvironmentConfig, !Ref Environment, PrivateSubnetB]
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-b
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-rt
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  EIPA:
    Type: AWS::EC2::EIP
    Condition: CreateNatPerAZ
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-eip-a
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  NatGatewayA:
    Type: AWS::EC2::NatGateway
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PublicSubnetA
      AllocationId: !GetAtt EIPA.AllocationId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-nat-a
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  EIPB:
    Type: AWS::EC2::EIP
    Condition: CreateNatPerAZ
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-eip-b
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PublicSubnetB
      AllocationId: !GetAtt EIPB.AllocationId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-nat-b
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  SingleEIP:
    Type: AWS::EC2::EIP
    Condition: SingleNat
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-eip
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  SingleNatGateway:
    Type: AWS::EC2::NatGateway
    Condition: SingleNat
    Properties:
      SubnetId: !Ref PublicSubnetA
      AllocationId: !GetAtt SingleEIP.AllocationId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-nat
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-rt-a
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-rt-b
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteA:
    Type: AWS::EC2::Route
    Condition: CreateNatPerAZ
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayA

  PrivateRouteB:
    Type: AWS::EC2::Route
    Condition: CreateNatPerAZ
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayB

  SinglePrivateRouteA:
    Type: AWS::EC2::Route
    Condition: SingleNat
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref SingleNatGateway

  SinglePrivateRouteB:
    Type: AWS::EC2::Route
    Condition: SingleNat
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref SingleNatGateway

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  DataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ProjectName}-${Environment}-data-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-bucket
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DataBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource: 
              - !GetAtt DataBucket.Arn
              - !Sub ${DataBucket.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: false

  EnvironmentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${Environment}-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If 
                - HasTeamPrincipal
                - !Ref TeamPrincipalARN
                - !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt DataBucket.Arn
                  - !Sub ${DataBucket.Arn}/*
        - PolicyName: EC2ReadOnly
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:Describe*
                Resource: '*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnets:
    Description: Public Subnet IDs
    Value: !Join [',', [!Ref PublicSubnetA, !Ref PublicSubnetB]]
  PrivateSubnets:
    Description: Private Subnet IDs
    Value: !Join [',', [!Ref PrivateSubnetA, !Ref PrivateSubnetB]]
  DataBucketName:
    Description: S3 Bucket Name
    Value: !Ref DataBucket
  DataBucketARN:
    Description: S3 Bucket ARN
    Value: !GetAtt DataBucket.Arn
  EnvironmentRoleARN:
    Description: IAM Role ARN
    Value: !GetAtt EnvironmentRole.Arn
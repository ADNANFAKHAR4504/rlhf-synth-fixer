AWSTemplateFormatVersion: '2010-09-09'
Description: 'Enhanced serverless e-commerce order processing platform with comprehensive monitoring, security, and performance features'

# Parameters section for configurable values
Parameters:
  ProjectName:
    Type: String
    Default: 'ecommerce-orders'
    Description: 'Base name for all resources in this stack'
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: 'Must contain only lowercase letters, numbers, and hyphens'

  Environment:
    Type: String
    Default: 'dev'
    Description: 'Environment name (dev, staging, prod)'
    AllowedValues:
      - dev
      - staging
      - prod

  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming to avoid conflicts'
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: 'Must contain only lowercase letters, numbers, and hyphens'

  AlertEmailAddress:
    Type: String
    Description: 'Email address for CloudWatch alarms notifications'
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    ConstraintDescription: 'Must be a valid email address'
    Default: 'example@example.com'

# Resources section - Core infrastructure components
Resources:
  # KMS Key for encryption
  OrderProcessingKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS key for encrypting order processing resources'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
            Condition:
              ArnEquals:
                'kms:EncryptionContext:aws:logs:arn': !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Custom Resource Lambda for setting reserved concurrency
  ReservedConcurrencyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LambdaConcurrencyPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:PutFunctionConcurrency
                  - lambda:DeleteFunctionConcurrency
                Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-${EnvironmentSuffix}-order-processor'

  # KMS Key Alias
  OrderProcessingKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${ProjectName}-${EnvironmentSuffix}-encryption-key'
      TargetKeyId: !Ref OrderProcessingKMSKey

  # SNS Topic for alerts
  AlertingTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-${EnvironmentSuffix}-alerts'
      KmsMasterKeyId: !Ref OrderProcessingKMSKey
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # SNS Topic Subscription
  AlertingTopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref AlertingTopic
      Protocol: email
      Endpoint: !Ref AlertEmailAddress

  # DynamoDB Table for storing order data
  OrdersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    Properties:
      TableName: !Sub '${ProjectName}-${EnvironmentSuffix}-orders'
      AttributeDefinitions:
        - AttributeName: orderId
          AttributeType: S
        - AttributeName: customerId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: orderId
          KeyType: HASH
      # Global Secondary Index for customer queries
      GlobalSecondaryIndexes:
        - IndexName: CustomerIndex
          KeySchema:
            - AttributeName: customerId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref OrderProcessingKMSKey
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Enhanced IAM Role for Lambda function
  OrderProcessorLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: EnhancedDynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                Resource:
                  - !GetAtt OrdersTable.Arn
                  - !Sub '${OrdersTable.Arn}/index/*'
        - PolicyName: KMSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:GenerateDataKey
                Resource: !GetAtt OrderProcessingKMSKey.Arn
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'
                Condition:
                  StringEquals:
                    'cloudwatch:namespace': !Sub '${ProjectName}/${Environment}'
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt DeadLetterQueue.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Lambda function for processing orders with enhanced features
  OrderProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${EnvironmentSuffix}-order-processor'
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt OrderProcessorLambdaRole.Arn
      MemorySize: 512
      Timeout: 30
      DeadLetterConfig:
        TargetArn: !GetAtt DeadLetterQueue.Arn
      TracingConfig:
        Mode: Active
      Layers:
        # AWS-provided X-Ray layer for Python (update ARN for your region)
        - !Sub 'arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPythonV2:68'
      Environment:
        Variables:
          ORDERS_TABLE_NAME: !Ref OrdersTable
          ENVIRONMENT: !Ref Environment
          KMS_KEY_ID: !Ref OrderProcessingKMSKey
          CUSTOM_METRICS_NAMESPACE: !Sub '${ProjectName}/${Environment}'
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          import uuid
          import decimal
          from datetime import datetime
          from aws_xray_sdk.core import xray_recorder
          from aws_xray_sdk.core import patch_all

          # Patch AWS SDK calls for X-Ray tracing
          patch_all()

          # Initialize AWS clients
          dynamodb = boto3.resource('dynamodb')
          cloudwatch = boto3.client('cloudwatch')

          table_name = os.environ['ORDERS_TABLE_NAME']
          environment = os.environ['ENVIRONMENT']
          metrics_namespace = os.environ['CUSTOM_METRICS_NAMESPACE']

          table = dynamodb.Table(table_name)

          class DecimalEncoder(json.JSONEncoder):
              def default(self, obj):
                  if isinstance(obj, decimal.Decimal):
                      return float(obj)
                  return super(DecimalEncoder, self).default(obj)

          def validate_order_input(body):
              """Comprehensive input validation"""
              errors = []
              
              # Required fields validation
              required_fields = ['customerId', 'items', 'totalAmount']
              for field in required_fields:
                  if field not in body or not body[field]:
                      errors.append(f"Missing required field: {field}")
              
              # Data type validation
              if 'items' in body and not isinstance(body['items'], list):
                  errors.append("Items must be a list")
              
              if 'totalAmount' in body:
                  try:
                      amount = float(body['totalAmount'])
                      if amount <= 0:
                          errors.append("Total amount must be positive")
                  except (ValueError, TypeError):
                      errors.append("Total amount must be a valid number")
              
              # Items validation
              if 'items' in body and isinstance(body['items'], list):
                  if len(body['items']) == 0:
                      errors.append("Order must contain at least one item")
                  
                  for i, item in enumerate(body['items']):
                      if not isinstance(item, dict):
                          errors.append(f"Item {i} must be an object")
                          continue
                      
                      item_required = ['productId', 'quantity', 'price']
                      for field in item_required:
                          if field not in item:
                              errors.append(f"Item {i} missing required field: {field}")
              
              return errors

          def put_custom_metric(metric_name, value, unit='Count', dimensions=None):
              """Put custom metric to CloudWatch"""
              try:
                  metric_data = {
                      'MetricName': metric_name,
                      'Value': value,
                      'Unit': unit,
                      'Timestamp': datetime.utcnow()
                  }
                  
                  if dimensions:
                      metric_data['Dimensions'] = dimensions
                  
                  cloudwatch.put_metric_data(
                      Namespace=metrics_namespace,
                      MetricData=[metric_data]
                  )
              except Exception as e:
                  print(f"Error putting custom metric: {str(e)}")

          @xray_recorder.capture('lambda_handler')
          def lambda_handler(event, context):
              start_time = datetime.utcnow()
              
              try:
                  # Parse the incoming request body
                  if 'body' in event:
                      if isinstance(event['body'], str):
                          body = json.loads(event['body'])
                      else:
                          body = event['body']
                  else:
                      body = event
                  
                  # Input validation
                  validation_errors = validate_order_input(body)
                  if validation_errors:
                      put_custom_metric('ValidationError', 1)
                      return {
                          'statusCode': 400,
                          'headers': {
                              'Content-Type': 'application/json',
                              'Access-Control-Allow-Origin': '*'
                          },
                          'body': json.dumps({
                              'error': 'Validation failed',
                              'details': validation_errors
                          })
                      }
                  
                  # Generate unique order ID if not provided
                  order_id = body.get('orderId', str(uuid.uuid4()))
                  
                  # Calculate total from items if not provided
                  calculated_total = sum(float(item.get('price', 0)) * int(item.get('quantity', 0)) 
                                       for item in body.get('items', []))
                  
                  # Prepare order data with timestamp
                  order_data = {
                      'orderId': order_id,
                      'customerId': str(body.get('customerId', '')),
                      'items': body.get('items', []),
                      'totalAmount': decimal.Decimal(str(body.get('totalAmount', calculated_total))),
                      'currency': body.get('currency', 'USD'),
                      'status': 'PROCESSING',
                      'createdAt': datetime.utcnow().isoformat(),
                      'updatedAt': datetime.utcnow().isoformat(),
                      'version': 1
                  }
                  
                  # Store order in DynamoDB with subsegment tracing
                  with xray_recorder.in_subsegment('dynamodb_put_item'):
                      response = table.put_item(
                          Item=order_data,
                          ConditionExpression='attribute_not_exists(orderId)'
                      )
                  
                  # Custom metrics
                  put_custom_metric('OrdersProcessed', 1)
                  put_custom_metric('OrderValue', float(order_data['totalAmount']), 'None')
                  
                  processing_time = (datetime.utcnow() - start_time).total_seconds() * 1000
                  put_custom_metric('ProcessingLatency', processing_time, 'Milliseconds')
                  
                  # Return success response
                  return {
                      'statusCode': 200,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({
                          'message': 'Order processed successfully',
                          'orderId': order_id,
                          'status': 'PROCESSING',
                          'totalAmount': float(order_data['totalAmount']),
                          'processingTime': f"{processing_time:.2f}ms"
                      }, cls=DecimalEncoder)
                  }
                  
              except Exception as e:
                  # Error metrics
                  put_custom_metric('ProcessingError', 1)
                  
                  error_type = type(e).__name__
                  put_custom_metric('ErrorType', 1, dimensions=[
                      {'Name': 'ErrorType', 'Value': error_type}
                  ])
                  
                  print(f"Error processing order: {str(e)}")
                  xray_recorder.current_subsegment().add_exception(e)
                  
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({
                          'error': 'Internal server error',
                          'message': 'Unable to process order at this time',
                          'requestId': context.aws_request_id if context else 'unknown'
                      })
                  }
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Dead Letter Queue for failed Lambda executions
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${EnvironmentSuffix}-dlq'
      KmsMasterKeyId: !Ref OrderProcessingKMSKey
      MessageRetentionPeriod: 1209600 # 14 days
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # Lambda permission for API Gateway
  ApiGatewayLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref OrderProcessorFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${OrdersHttpApi}/*/*'

  # HTTP API Gateway with enhanced configuration
  OrdersHttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub '${ProjectName}-${EnvironmentSuffix}-orders-api'
      Description: 'Enhanced HTTP API for e-commerce order processing'
      ProtocolType: HTTP
      CorsConfiguration:
        AllowCredentials: false
        AllowHeaders:
          - Content-Type
          - X-Amz-Date
          - Authorization
          - X-Api-Key
          - X-Amz-Security-Token
        AllowMethods:
          - POST
          - OPTIONS
        AllowOrigins:
          - '*'
        MaxAge: 300
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment

  # API Gateway integration with Lambda
  OrdersApiIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref OrdersHttpApi
      Description: 'Lambda integration for order processing'
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${OrderProcessorFunction.Arn}/invocations'
      PayloadFormatVersion: '2.0'
      TimeoutInMillis: 30000

  # API Gateway route
  OrdersApiRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref OrdersHttpApi
      RouteKey: 'POST /orders'
      AuthorizationType: NONE
      Target: !Sub 'integrations/${OrdersApiIntegration}'

  # API Gateway stage with throttling
  OrdersApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref OrdersHttpApi
      StageName: !Ref Environment
      Description: !Sub 'Deployment stage for ${Environment} environment'
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingRateLimit: 1000
        ThrottlingBurstLimit: 2000
      AccessLogSettings:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","routeKey":"$context.routeKey","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength","error":"$context.error.message","integrationError":"$context.integration.error"}'
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment

  # CloudWatch Log Group for API Gateway with KMS encryption
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub '/aws/apigateway/${ProjectName}-${EnvironmentSuffix}-orders-api'
      RetentionInDays: 14
      KmsKeyId: !GetAtt OrderProcessingKMSKey.Arn

  # CloudWatch Log Group for Lambda with KMS encryption
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${EnvironmentSuffix}-order-processor'
      RetentionInDays: 14
      KmsKeyId: !GetAtt OrderProcessingKMSKey.Arn

  # CloudWatch Alarms
  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-lambda-errors'
      AlarmDescription: 'Lambda function error rate alarm'
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref OrderProcessorFunction
      AlarmActions:
        - !Ref AlertingTopic

  LambdaDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-lambda-duration'
      AlarmDescription: 'Lambda function duration alarm'
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 25000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref OrderProcessorFunction
      AlarmActions:
        - !Ref AlertingTopic

  LambdaThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-lambda-throttles'
      AlarmDescription: 'Lambda function throttle alarm'
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref OrderProcessorFunction
      AlarmActions:
        - !Ref AlertingTopic

  ApiGateway4XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-api-4xx-errors'
      AlarmDescription: 'API Gateway 4XX error rate alarm'
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-orders-api'
      AlarmActions:
        - !Ref AlertingTopic

  ApiGateway5XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-api-5xx-errors'
      AlarmDescription: 'API Gateway 5XX error rate alarm'
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: ApiName
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-orders-api'
      AlarmActions:
        - !Ref AlertingTopic

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-${EnvironmentSuffix}-dynamodb-throttles'
      AlarmDescription: 'DynamoDB throttle alarm'
      MetricName: ThrottledRequests
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref OrdersTable
      AlarmActions:
        - !Ref AlertingTopic

# Outputs section
Outputs:
  ApiGatewayEndpoint:
    Description: 'HTTP API Gateway endpoint URL for order submission'
    Value: !Sub 'https://${OrdersHttpApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/orders'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'

  DynamoDBTableName:
    Description: 'DynamoDB table name for storing orders'
    Value: !Ref OrdersTable
    Export:
      Name: !Sub '${AWS::StackName}-OrdersTable'

  LambdaFunctionArn:
    Description: 'Lambda function ARN for order processing'
    Value: !GetAtt OrderProcessorFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaArn'

  LambdaFunctionName:
    Description: 'Lambda function name'
    Value: !Ref OrderProcessorFunction
    Export:
      Name: !Sub '${AWS::StackName}-LambdaName'

  ApiGatewayId:
    Description: 'API Gateway ID'
    Value: !Ref OrdersHttpApi
    Export:
      Name: !Sub '${AWS::StackName}-ApiId'

  KMSKeyId:
    Description: 'KMS Key ID for encryption'
    Value: !Ref OrderProcessingKMSKey
    Export:
      Name: !Sub '${AWS::StackName}-KMSKey'

  DeadLetterQueueUrl:
    Description: 'Dead Letter Queue URL'
    Value: !Ref DeadLetterQueue
    Export:
      Name: !Sub '${AWS::StackName}-DLQ'

  SNSTopicArn:
    Description: 'SNS Topic ARN for alerts'
    Value: !Ref AlertingTopic
    Export:
      Name: !Sub '${AWS::StackName}-AlertTopic'

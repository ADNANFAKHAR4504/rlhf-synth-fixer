AWSTemplateFormatVersion: '2010-09-09'
Description: 'Production-ready IAM security configuration with MFA enforcement and least privilege access'

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'pr'
    AllowedValues: ['development', 'staging', 'production', 'pr']
    Description: 'Environment name for resource tagging and configuration (must be lowercase)'
    AllowedPattern: '[a-z]+'
    ConstraintDescription: 'Must contain only lowercase letters'
  
  TrustedAccountId:
    Type: String
    Description: 'AWS Account ID that can assume the IAM role'
    AllowedPattern: '[0-9]{12}'
    ConstraintDescription: 'Must be a valid 12-digit AWS Account ID'

  MFAMaxSessionDuration:
    Type: Number
    Default: 3600
    MinValue: 900
    MaxValue: 43200
    Description: 'Maximum session duration in seconds (15 minutes to 12 hours)'

Resources:
  # CloudTrail for security auditing and compliance 
  SecurityAuditTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: SecurityAuditBucketPolicy
    Properties:
      TrailName: !Sub '${EnvironmentSuffix}-security-audit-trail'
      S3BucketName: 
        Fn::Sub: '${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs'
      S3KeyPrefix: 'cloudtrail-logs'
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      IsLogging: true # Required property for CloudTrail
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Purpose
          Value: 'Security Audit Trail'
        - Key: Compliance
          Value: 'MFA-Enforcement-Tracking'

  # S3 bucket for CloudTrail logs
  SecurityAuditBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: 
        Fn::Sub: '${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: 'SecurityLogRetention'
            Status: Enabled
            ExpirationInDays: 2555 # 7 years retention for compliance
            NoncurrentVersionExpirationInDays: 90
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Purpose
          Value: 'Security Audit Storage'

  # S3 bucket policy for CloudTrail
  SecurityAuditBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SecurityAuditBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck20150319
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource:
              Fn::Sub: arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs
          - Sid: AWSCloudTrailWrite20150319
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource:
              - Fn::Sub: arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs/cloudtrail-logs/AWSLogs/${AWS::AccountId}/*
              - Fn::Sub: arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs/cloudtrail-logs/AWSLogs/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control

  # IAM Role with strict MFA enforcement
  SecureAccessRole:
    Type: AWS::IAM::Role
    Properties:
      Description: 'Production IAM role with mandatory MFA enforcement and least privilege access'
      MaxSessionDuration: !Ref MFAMaxSessionDuration
      # Trust policy requiring MFA for role assumption
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'RequireMFAForRoleAssumption'
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${TrustedAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '3600' # MFA must be within 1 hour
          - Sid: 'DenyAssumeRoleWithoutMFA'
            Effect: Deny
            Principal:
              AWS: !Sub 'arn:aws:iam::${TrustedAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              BoolIfExists:
                'aws:MultiFactorAuthPresent': 'false'
      ManagedPolicyArns:
        - !Ref ReadOnlyAccessPolicy
        - !Ref LimitedS3AccessPolicy
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: MFARequired
          Value: 'true'
        - Key: AccessLevel
          Value: 'LeastPrivilege'
        - Key: Purpose
          Value: 'Secure Production Access'

  # Custom policy for read-only access with MFA enforcement
  ReadOnlyAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${EnvironmentSuffix}-readonly-access-policy'
      Description: 'Read-only access policy with MFA enforcement for security operations'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow read-only access to most AWS services
          - Sid: 'ReadOnlyAccessWithMFA'
            Effect: Allow
            Action:
              - 'ec2:Describe*'
              - 'ec2:List*'
              - 's3:GetObject'
              - 's3:ListBucket'
              - 'iam:Get*'
              - 'iam:List*'
              - 'cloudtrail:LookupEvents'
              - 'cloudwatch:Get*'
              - 'cloudwatch:List*'
              - 'cloudwatch:Describe*'
              - 'logs:Describe*'
              - 'logs:Get*'
              - 'logs:List*'
              - 'logs:FilterLogEvents'
            Resource: '*'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '3600'
          
          # Explicitly deny sensitive IAM actions even with MFA
          - Sid: 'DenySensitiveIAMActions'
            Effect: Deny
            Action:
              - 'iam:CreateRole'
              - 'iam:DeleteRole'
              - 'iam:CreatePolicy'
              - 'iam:DeletePolicy'
              - 'iam:AttachRolePolicy'
              - 'iam:DetachRolePolicy'
              - 'iam:PutRolePolicy'
              - 'iam:DeleteRolePolicy'
              - 'iam:CreateUser'
              - 'iam:DeleteUser'
              - 'iam:CreateAccessKey'
              - 'iam:DeleteAccessKey'
            Resource: '*'

  # Limited S3 access policy with specific bucket restrictions
  LimitedS3AccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${EnvironmentSuffix}-limited-s3-access-policy'
      Description: 'Limited S3 access policy for specific operational needs with MFA enforcement'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow access to specific S3 buckets only
          - Sid: 'LimitedS3AccessWithMFA'
            Effect: Allow
            Action:
              - 's3:GetObject'
              - 's3:PutObject'
              - 's3:ListBucket'
              - 's3:GetBucketLocation'
            Resource:
              - Fn::Sub: 'arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs/*'
              - Fn::Sub: 'arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '3600'
          
          # Deny access to all other S3 buckets
          - Sid: 'DenyAccessToOtherS3Buckets'
            Effect: Deny
            Action: 's3:*'
            NotResource:
              - Fn::Sub: 'arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs/*'
              - Fn::Sub: 'arn:aws:s3:::${AWS::AccountId}-${EnvironmentSuffix}-security-audit-logs'

  # Additional security role for emergency access with stricter MFA requirements
  EmergencyAccessRole:
    Type: AWS::IAM::Role
    Properties:
      Description: 'Emergency access role with enhanced MFA requirements and time-limited access'
      MaxSessionDuration: 3600 # Minimum allowed session duration (1 hour)
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'RequireRecentMFAForEmergencyAccess'
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${TrustedAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '900' # MFA must be within 15 minutes
              DateGreaterThan:
                'aws:CurrentTime': '2024-01-01T00:00:00Z'
              DateLessThan:
                'aws:CurrentTime': '2030-12-31T23:59:59Z'
      ManagedPolicyArns:
        - !Ref EmergencyAccessPolicy
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: AccessType
          Value: 'Emergency'
        - Key: MFARequired
          Value: 'true'
        - Key: MaxSessionDuration
          Value: '1800'

  # Emergency access policy with limited permissions
  EmergencyAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${EnvironmentSuffix}-emergency-access-policy'
      Description: 'Emergency access policy with time-limited and MFA-enforced permissions'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow emergency access to critical resources
          - Sid: 'EmergencyAccessWithStrictMFA'
            Effect: Allow
            Action:
              - 'ec2:StopInstances'
              - 'ec2:StartInstances'
              - 'ec2:RebootInstances'
              - 'rds:StopDBInstance'
              - 'rds:StartDBInstance'
              - 'rds:RebootDBInstance'
              - 'cloudwatch:PutMetricAlarm'
              - 'sns:Publish'
            Resource: '*'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'
              NumericLessThan:
                'aws:MultiFactorAuthAge': '900'
              StringEquals:
                'aws:RequestedRegion': !Ref 'AWS::Region'

Outputs:
  SecureAccessRoleArn:
    Description: 'ARN of the secure access role with MFA enforcement'
    Value: !GetAtt SecureAccessRole.Arn
    Export:
      Name: !Sub '${EnvironmentSuffix}-secure-access-role-arn'

  EmergencyAccessRoleArn:
    Description: 'ARN of the emergency access role with enhanced MFA requirements'
    Value: !GetAtt EmergencyAccessRole.Arn
    Export:
      Name: !Sub '${EnvironmentSuffix}-emergency-access-role-arn'

  SecurityAuditTrailArn:
    Description: 'ARN of the CloudTrail for security auditing'
    Value: !GetAtt SecurityAuditTrail.Arn
    Export:
      Name: !Sub '${EnvironmentSuffix}-security-audit-trail-arn'

  SecurityAuditBucketName:
    Description: 'Name of the S3 bucket storing security audit logs'
    Value: !Ref SecurityAuditBucket
    Export:
      Name: !Sub '${EnvironmentSuffix}-security-audit-bucket-name'

  MFAComplianceStatus:
    Description: 'Confirmation that all roles enforce MFA authentication'
    Value: 'All IAM roles in this template enforce MFA with time-based validation'

  SecurityValidationChecklist:
    Description: 'Security validation checklist for deployment verification'
    Value: 'Verify: 1) MFA enforcement active, 2) Least privilege policies applied, 3) CloudTrail logging enabled, 4) S3 bucket encryption enabled'

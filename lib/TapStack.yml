AWSTemplateFormatVersion: '2010-09-09'
Description: 'NovaModel Secure Infrastructure'

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: prod
    Description: Suffix for environment-specific resources (e.g., prod, dev).
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: Must contain only alphanumeric characters.

Mappings:
  SubnetConfig:
    VPC:
      CIDR: '10.0.0.0/16'
    PublicOne:
      CIDR: '10.0.1.0/24'
    PublicTwo:
      CIDR: '10.0.2.0/24'
    PrivateOne:
      CIDR: '10.0.101.0/24'
    PrivateTwo:
      CIDR: '10.0.102.0/24'

Resources:
  # =================================================================
  # Logging & Monitoring
  # =================================================================
  CloudFormationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/cloudformation/${AWS::StackName}'
      RetentionInDays: 30

  CloudTrailLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 90

  ALBAccessLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 90

  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/novamodel-sec-${EnvironmentSuffix}-function'
      RetentionInDays: 30

  VPCFlowLogsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vpc/flowlogs/${AWS::StackName}'
      RetentionInDays: 14

  S3CloudTrailBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  CloudTrailLogsS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: s3:GetBucketAcl
            Resource: !GetAtt S3CloudTrailBucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: s3:PutObject
            Resource: !Sub '${S3CloudTrailBucket.Arn}/AWSLogs/${AWS::AccountId}/*'
            Condition:
              StringEquals: { 's3:x-amz-acl': 'bucket-owner-full-control' }

  CloudTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Sub 'novamodel-sec-${EnvironmentSuffix}-trail'
      S3BucketName: !Ref S3CloudTrailBucket
      CloudWatchLogsLogGroupArn: !GetAtt CloudTrailLogGroup.Arn
      CloudWatchLogsRoleArn: !GetAtt CloudTrailCWLRole.Arn
      IsLogging: true
      IsMultiRegionTrail: true
      IncludeGlobalServiceEvents: true
      EnableLogFileValidation: true
      EventSelectors:
        - ReadWriteType: 'All'
          IncludeManagementEvents: true
          DataResources:
            - Type: 'AWS::S3::Object'
              Values: [!Sub 'arn:aws:s3:::${S3CloudTrailBucket}/*']
            - Type: 'AWS::Lambda::Function'
              Values: [!GetAtt LambdaFunction.Arn]
            - Type: 'AWS::DynamoDB::Table'
              Values: [!GetAtt DynamoDBTable.Arn]
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  CloudTrailCWLRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal: { Service: cloudtrail.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: 'CloudTrail-CWL-Policy'
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: ['logs:CreateLogStream', 'logs:PutLogEvents']
                Resource: !GetAtt CloudTrailLogGroup.Arn

  ApiGatewayCloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs'
      Tags:
        - Key: Project
          Value: 'NovaModelBreaking'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Owner
          Value: 'DevSecOpsTeam'

  ApiGatewayAccountSettings:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchRole.Arn

  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: 'VPC-Flow-Logs-Policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                Resource: !GetAtt VPCFlowLogsLogGroup.Arn

  VPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogsLogGroup
      ResourceId: !Ref VPC
      ResourceType: VPC
      TrafficType: ALL
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn

  # =================================================================
  # KMS Customer Managed Key
  # =================================================================
  EBSKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'Customer-managed key for encrypting EC2 EBS volumes'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: 'Allow administration of the key'
            Effect: Allow
            Principal: { AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root' }
            Action: 'kms:*'
            Resource: '*'
          - Sid: 'Allow use of the key for EBS'
            Effect: Allow
            Principal:
              AWS: '*'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
            Resource: '*'
            Condition:
              StringEquals:
                'kms:ViaService':
                  - !Sub 'ec2.${AWS::Region}.amazonaws.com'
          - Sid: 'Allow attachment of persistent resources'
            Effect: Allow
            Principal:
              AWS: '*'
            Action:
              - 'kms:CreateGrant'
              - 'kms:ListGrants'
              - 'kms:RevokeGrant'
            Resource: '*'
            Condition:
              Bool:
                'kms:GrantIsForAWSResource': 'true'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  # =================================================================
  # Networking
  # =================================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [SubnetConfig, VPC, CIDR]
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - { Key: Name, Value: !Sub 'novamodel-sec-${EnvironmentSuffix}-vpc' }
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [SubnetConfig, PublicOne, CIDR]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'novamodel-sec-${EnvironmentSuffix}-public-subnet-1'
        - Key: Project
          Value: 'NovaModelBreaking'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Owner
          Value: 'DevSecOpsTeam'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [SubnetConfig, PublicTwo, CIDR]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'novamodel-sec-${EnvironmentSuffix}-public-subnet-2'
        - Key: Project
          Value: 'NovaModelBreaking'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Owner
          Value: 'DevSecOpsTeam'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [SubnetConfig, PrivateOne, CIDR]
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub 'novamodel-sec-${EnvironmentSuffix}-private-subnet-1'
        - Key: Project
          Value: 'NovaModelBreaking'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Owner
          Value: 'DevSecOpsTeam'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !FindInMap [SubnetConfig, PrivateTwo, CIDR]
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub 'novamodel-sec-${EnvironmentSuffix}-private-subnet-2'
        - Key: Project
          Value: 'NovaModelBreaking'
        - Key: Environment
          Value: !Ref EnvironmentSuffix
        - Key: Owner
          Value: 'DevSecOpsTeam'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  EIP1:
    Type: AWS::EC2::EIP
    Properties: { Domain: vpc }

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  EIP2:
    Type: AWS::EC2::EIP
    Properties: { Domain: vpc }

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP2.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway2

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # =================================================================
  # Security Groups
  # =================================================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'novamodel-sec-${EnvironmentSuffix}-alb-sg'
      GroupDescription: 'Allow public HTTP/HTTPS traffic'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: 'Allow HTTP from internet'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: 'Allow HTTPS from internet'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'novamodel-sec-${EnvironmentSuffix}-ec2-sg'
      GroupDescription: 'Allow traffic from ALB'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: 'Allow HTTP from ALB'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: 'Allow HTTPS from ALB'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'novamodel-sec-${EnvironmentSuffix}-lambda-sg'
      GroupDescription: 'Security group for Lambda function'
      VpcId: !Ref VPC
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'novamodel-sec-${EnvironmentSuffix}-rds-sg'
      GroupDescription: 'Allow traffic from EC2 and Lambda'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EC2SecurityGroup
          Description: 'Allow MySQL from EC2 instances'
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: 'Allow MySQL from Lambda functions'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  # =================================================================
  # Data Stores
  # =================================================================
  RDSPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub 'novamodel-sec-${EnvironmentSuffix}-rds-password'
      Description: 'RDS Master Password'
      GenerateSecretString:
        SecretStringTemplate: '{"username": "novadmin"}'
        GenerateStringKey: 'password'
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: 'Subnet group for the RDS instance'
      SubnetIds: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  RDSDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      AllocatedStorage: '20'
      DBInstanceClass: 'db.t3.micro'
      Engine: 'mysql'
      MasterUsername: !Sub '{{resolve:secretsmanager:${RDSPasswordSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${RDSPasswordSecret}:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups: [!Ref RDSSecurityGroup]
      MultiAZ: true
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      DeleteAutomatedBackups: false
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  RDSSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref RDSPasswordSecret
      TargetId: !Ref RDSDatabase
      TargetType: AWS::RDS::DBInstance

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'novamodel-sec-${EnvironmentSuffix}-data'
      AttributeDefinitions: [{ AttributeName: 'id', AttributeType: 'S' }]
      KeySchema: [{ AttributeName: 'id', KeyType: 'HASH' }]
      ProvisionedThroughput: { ReadCapacityUnits: 5, WriteCapacityUnits: 5 }
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  # =================================================================
  # Compute (ALB, ASG, Lambda) & API
  # =================================================================
  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      SecurityGroups: [!Ref ALBSecurityGroup]
      Subnets: [!Ref PublicSubnet1, !Ref PublicSubnet2]
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref EC2TargetGroup
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  EC2TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      VpcId: !Ref VPC
      Port: 80
      Protocol: HTTP
      HealthCheckPath: '/'
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub 'novamodel-sec-${EnvironmentSuffix}-lt'
      LaunchTemplateData:
        ImageId: 'ami-05a2d2d0a1020fecd'
        InstanceType: 't3.micro'
        SecurityGroupIds: [!Ref EC2SecurityGroup]
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd
            systemctl start httpd
            systemctl enable httpd
            echo "<h1>Hello from ${AWS::StackName}</h1>" > /var/www/html/index.html
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 8
              VolumeType: gp3
              Encrypted: true
              KmsKeyId: !Ref EBSKMSKey
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - { Key: Project, Value: 'NovaModelBreaking' }
              - { Key: Environment, Value: !Ref EnvironmentSuffix }
              - { Key: Owner, Value: 'DevSecOpsTeam' }
          - ResourceType: volume
            Tags:
              - { Key: Project, Value: 'NovaModelBreaking' }
              - { Key: Environment, Value: !Ref EnvironmentSuffix }
              - { Key: Owner, Value: 'DevSecOpsTeam' }

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn:
      - EBSKMSKey
      - NatGateway1
      - NatGateway2
    Properties:
      MinSize: '1'
      MaxSize: '2'
      DesiredCapacity: '1'
      VPCZoneIdentifier: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]
      LaunchTemplate:
        LaunchTemplateId: !Ref EC2LaunchTemplate
        Version: !GetAtt EC2LaunchTemplate.LatestVersionNumber
      TargetGroupARNs: [!Ref EC2TargetGroup]
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Project
          Value: 'NovaModelBreaking'
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref EnvironmentSuffix
          PropagateAtLaunch: true
        - Key: Owner
          Value: 'DevSecOpsTeam'
          PropagateAtLaunch: true

  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'novamodel-sec-${EnvironmentSuffix}-function'
      Handler: 'index.handler'
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: 'python3.11'
      VpcConfig:
        SecurityGroupIds: [!Ref LambdaSecurityGroup]
        SubnetIds: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]
      Code:
        ZipFile: |
          import json
          def handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps('Success')
              }
      Environment:
        Variables:
          TABLE_NAME: !Ref DynamoDBTable
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: 'lambda.amazonaws.com' }
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
      Policies:
        - PolicyName: 'DynamoDB-Write-Policy'
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: 'dynamodb:PutItem'
                Resource: !GetAtt DynamoDBTable.Arn
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  ApiGatewayRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub 'novamodel-sec-${EnvironmentSuffix}-api'
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  ApiGatewayResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ParentId: !GetAtt ApiGatewayRestApi.RootResourceId
      PathPart: 'data'

  ApiGatewayMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGatewayResource
      HttpMethod: 'POST'
      AuthorizationType: 'NONE'
      ApiKeyRequired: true
      Integration:
        Type: 'AWS_PROXY'
        IntegrationHttpMethod: 'POST'
        Uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaFunction.Arn}/invocations'

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn: ApiGatewayMethod
    Properties: { RestApiId: !Ref ApiGatewayRestApi }

  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      StageName: !Ref EnvironmentSuffix
      DeploymentId: !Ref ApiGatewayDeployment
      RestApiId: !Ref ApiGatewayRestApi
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  ApiGatewayApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Name: !Sub 'novamodel-sec-${EnvironmentSuffix}-key'
      Enabled: true
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  UsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      ApiStages:
        - ApiId: !Ref ApiGatewayRestApi
          Stage: !Ref ApiGatewayStage
      Tags:
        - { Key: Project, Value: 'NovaModelBreaking' }
        - { Key: Environment, Value: !Ref EnvironmentSuffix }
        - { Key: Owner, Value: 'DevSecOpsTeam' }

  UsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref ApiGatewayApiKey
      KeyType: 'API_KEY'
      UsagePlanId: !Ref UsagePlan

Outputs:
  VPCId:
    Description: 'ID of the created VPC'
    Value: !Ref VPC
    Export: { Name: !Sub '${AWS::StackName}-VPCId' }
  ALBDNSName:
    Description: 'DNS Name of the Application Load Balancer'
    Value: !GetAtt ALB.DNSName
    Export: { Name: !Sub '${AWS::StackName}-ALBDNSName' }
  ApiGatewayUrl:
    Description: 'URL of the API Gateway'
    Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentSuffix}/data'
    Export: { Name: !Sub '${AWS::StackName}-ApiGatewayUrl' }
  ApiKeyId:
    Description: 'ID of the API Key'
    Value: !Ref ApiGatewayApiKey
    Export: { Name: !Sub '${AWS::StackName}-ApiKeyId' }
  RDSEndpoint:
    Description: 'Endpoint address of the RDS instance'
    Value: !GetAtt RDSDatabase.Endpoint.Address
    Export: { Name: !Sub '${AWS::StackName}-RDSEndpoint' }
  S3BucketName:
    Description: 'Name of the CloudTrail S3 bucket'
    Value: !Ref S3CloudTrailBucket
    Export: { Name: !Sub '${AWS::StackName}-S3BucketName' }
  CloudTrailName:
    Description: 'Name of the CloudTrail'
    Value: !Ref CloudTrail
    Export: { Name: !Sub '${AWS::StackName}-CloudTrailName' }
  DynamoDBTableName:
    Description: 'Name of the DynamoDB table'
    Value: !Ref DynamoDBTable
    Export: { Name: !Sub '${AWS::StackName}-DynamoDBTableName' }
  LambdaFunctionName:
    Description: 'Name of the Lambda function'
    Value: !Ref LambdaFunction
    Export: { Name: !Sub '${AWS::StackName}-LambdaFunctionName' }
  AutoScalingGroupName:
    Description: 'Name of the Auto Scaling Group'
    Value: !Ref AutoScalingGroup
    Export: { Name: !Sub '${AWS::StackName}-AutoScalingGroupName' }
  RDSInstanceId:
    Description: 'RDS Instance Identifier'
    Value: !Ref RDSDatabase
    Export: { Name: !Sub '${AWS::StackName}-RDSInstanceId' }

AWSTemplateFormatVersion: '2010-09-09'
Description: 'Comprehensive CI/CD Pipeline with CodePipeline, CodeBuild, and secure artifact deployment'

Parameters:
  ProjectName:
    Type: String
    Default: 'my-cicd-project'
    Description: 'Name of the project for resource naming and tagging'

  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment name for resource naming and tagging'

  CodeStarConnectionArn:
    Type: String
    Description: 'ARN of the CodeStar Connection for GitHub integration'

  GitHubRepositoryOwner:
    Type: String
    Description: 'GitHub repository owner (username or organization)'

  GitHubRepositoryName:
    Type: String
    Description: 'GitHub repository name'

  GitHubBranchName:
    Type: String
    Default: 'main'
    Description: 'GitHub branch name to track'

  ApprovalNotificationEmail:
    Type: String
    Description: 'Email address for manual approval notifications'

  SecretValue:
    Type: String
    NoEcho: true
    Description: 'Secret value to store in AWS Secrets Manager'
    Default: 'my-secret-api-key'

Resources:
  # KMS Key for encryption
  PipelineKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub '${ProjectName}-${Environment} Pipeline KMS Key'
      KeyPolicy:
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow use of the key for S3
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
          - Sid: Allow use of the key for SNS
            Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  PipelineKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${ProjectName}-${Environment}-pipeline-key'
      TargetKeyId: !Ref PipelineKMSKey

  # S3 Bucket for Pipeline Artifacts
  PipelineArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-pipeline-artifacts-${AWS::AccountId}-${AWS::Region}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref PipelineKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionTransitions:
              - TransitionInDays: 30
                StorageClass: GLACIER
            NoncurrentVersionExpirationInDays: 365
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # S3 Bucket for Deployment Artifacts
  DeploymentArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-deployment-artifacts-${AWS::AccountId}-${AWS::Region}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref PipelineKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: ManageObjectVersions
            Status: Enabled
            NoncurrentVersionTransitions:
              - TransitionInDays: 30
                StorageClass: GLACIER
            NoncurrentVersionExpirationInDays: 365
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # AWS Secrets Manager Secret
  BuildSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-build-secret'
      Description: 'Secret for CI/CD pipeline build process'
      SecretString: !Ref SecretValue
      KmsKeyId: !Ref PipelineKMSKey
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # SNS Topic for Approval Notifications
  ApprovalNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-${Environment}-approval-notifications'
      DisplayName: 'Pipeline Approval Notifications'
      KmsMasterKeyId: !Ref PipelineKMSKey
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  ApprovalNotificationSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: email
      TopicArn: !Ref ApprovalNotificationTopic
      Endpoint: !Ref ApprovalNotificationEmail

  # CloudWatch Log Group for CodeBuild
  CodeBuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/codebuild/${ProjectName}-${Environment}-build'
      RetentionInDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for CodePipeline
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelineExecutionPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetBucketVersioning
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource:
                  - !Sub '${PipelineArtifactsBucket}/*'
                  - !Sub '${DeploymentArtifactsBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt PipelineArtifactsBucket.Arn
                  - !GetAtt DeploymentArtifactsBucket.Arn
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource: !GetAtt CodeBuildProject.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref ApprovalNotificationTopic
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt PipelineKMSKey.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for CodeBuild
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BuildExecutionPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub '${CodeBuildLogGroup.Arn}*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource:
                  - !Sub '${PipelineArtifactsBucket}/*'
                  - !Sub '${DeploymentArtifactsBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt PipelineArtifactsBucket.Arn
                  - !GetAtt DeploymentArtifactsBucket.Arn
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref BuildSecret
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource: !GetAtt PipelineKMSKey.Arn
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # CodeBuild Project
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-build'
      Description: 'Build project for CI/CD pipeline'
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
          - Name: PROJECT_NAME
            Value: !Ref ProjectName
          - Name: ENVIRONMENT
            Value: !Ref Environment
          - Name: SECRET_ARN
            Value: !Ref BuildSecret
          - Name: DEPLOYMENT_BUCKET
            Value: !Ref DeploymentArtifactsBucket
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                nodejs: 18
                python: 3.11
              commands:
                - echo "Installing dependencies..."
                - |
                  if [ -f package.json ]; then
                    npm install
                  elif [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                  elif [ -f pom.xml ]; then
                    mvn install -DskipTests
                  else
                    echo "No recognized dependency file found"
                  fi
            pre_build:
              commands:
                - echo "Running pre-build phase..."
                - echo "Retrieving secret from Secrets Manager..."
                - SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id $SECRET_ARN --query SecretString --output text)
                - echo "Secret retrieved successfully (not displaying value for security)"
                - echo "Running security scans and linters..."
                - |
                  if [ -f package.json ]; then
                    npm audit --audit-level high
                    if command -v eslint &> /dev/null; then
                      npm run lint || echo "Linting completed with warnings"
                    fi
                  elif [ -f requirements.txt ]; then
                    if command -v bandit &> /dev/null; then
                      bandit -r . || echo "Security scan completed with warnings"
                    fi
                    if command -v flake8 &> /dev/null; then
                      flake8 . || echo "Linting completed with warnings"
                    fi
                  fi
            build:
              commands:
                - echo "Build phase started on $(date)"
                - echo "Compiling application..."
                - |
                  if [ -f package.json ]; then
                    npm run build || echo "Build script not found, skipping"
                    npm test || echo "Test script not found, skipping"
                  elif [ -f requirements.txt ]; then
                    python -m pytest tests/ || echo "No tests found, skipping"
                  elif [ -f pom.xml ]; then
                    mvn clean compile test
                  else
                    echo "Creating sample application artifact"
                    mkdir -p dist
                    echo "Sample application built on $(date)" > dist/app.txt
                  fi
            post_build:
              commands:
                - echo "Post-build phase started on $(date)"
                - echo "Packaging artifacts..."
                - |
                  # Create deployment package
                  if [ -d dist ]; then
                    cd dist && zip -r ../deployment-package.zip . && cd ..
                  elif [ -d build ]; then
                    cd build && zip -r ../deployment-package.zip . && cd ..
                  elif [ -d target ]; then
                    cd target && zip -r ../deployment-package.zip . && cd ..
                  else
                    # Create a sample deployment package
                    mkdir -p package
                    echo "Deployment package created on $(date)" > package/deployment-info.txt
                    echo "Environment: $ENVIRONMENT" >> package/deployment-info.txt
                    echo "Project: $PROJECT_NAME" >> package/deployment-info.txt
                    cd package && zip -r ../deployment-package.zip . && cd ..
                  fi
                - echo "Artifacts packaged successfully"
                - ls -la *.zip
          artifacts:
            files:
              - deployment-package.zip
            name: BuildArtifact
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
          GroupName: !Ref CodeBuildLogGroup
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # CodePipeline
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-pipeline'
      RoleArn: !GetAtt CodePipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref PipelineArtifactsBucket
        EncryptionKey:
          Id: !GetAtt PipelineKMSKey.Arn
          Type: KMS
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Sub '${GitHubRepositoryOwner}/${GitHubRepositoryName}'
                BranchName: !Ref GitHubBranchName
                DetectChanges: true
              OutputArtifacts:
                - Name: SourceOutput
        - Name: Build
          Actions:
            - Name: BuildAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref CodeBuildProject
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: BuildOutput
        - Name: Approval
          Actions:
            - Name: ManualApproval
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: '1'
              Configuration:
                NotificationArn: !Ref ApprovalNotificationTopic
                CustomData: !Sub 'Please review and approve deployment for ${ProjectName} ${Environment} environment'
        - Name: Deploy
          Actions:
            - Name: DeployAction
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: S3
                Version: '1'
              Configuration:
                BucketName: !Ref DeploymentArtifactsBucket
                Extract: true
                ObjectKey: !Sub 'deployments/${ProjectName}-${Environment}'
              InputArtifacts:
                - Name: BuildOutput
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

Outputs:
  PipelineName:
    Description: 'Name of the created CodePipeline'
    Value: !Ref CodePipeline
    Export:
      Name: !Sub '${AWS::StackName}-PipelineName'

  PipelineArtifactsBucket:
    Description: 'S3 bucket for pipeline artifacts'
    Value: !Ref PipelineArtifactsBucket
    Export:
      Name: !Sub '${AWS::StackName}-PipelineArtifactsBucket'

  DeploymentArtifactsBucket:
    Description: 'S3 bucket for deployment artifacts'
    Value: !Ref DeploymentArtifactsBucket
    Export:
      Name: !Sub '${AWS::StackName}-DeploymentArtifactsBucket'

  CodeBuildProjectName:
    Description: 'Name of the CodeBuild project'
    Value: !Ref CodeBuildProject
    Export:
      Name: !Sub '${AWS::StackName}-CodeBuildProject'

  SecretsManagerSecretArn:
    Description: 'ARN of the Secrets Manager secret'
    Value: !Ref BuildSecret
    Export:
      Name: !Sub '${AWS::StackName}-BuildSecret'

  SNSTopicArn:
    Description: 'ARN of the SNS topic for approvals'
    Value: !Ref ApprovalNotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-ApprovalTopic'

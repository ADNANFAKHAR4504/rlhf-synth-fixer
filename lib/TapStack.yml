AWSTemplateFormatVersion: '2010-09-09'
Description: Highly available, scalable web-application stack

Parameters:
  Environment:
    Type: String
    Default: prod
    Description: Environment name for resource tagging

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access to instances

Resources:
  # VPC and Internet gateway
  ProdVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: prod-vpc
        - Key: Environment
          Value: !Ref Environment

  ProdInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: prod-internet-gateway
        - Key: Environment
          Value: !Ref Environment

  ProdVpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ProdVpc
      InternetGatewayId: !Ref ProdInternetGateway

  # Public subnets
  ProdPublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ProdVpc
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: prod-public-subnet-1
        - Key: Environment
          Value: !Ref Environment

  ProdPublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ProdVpc
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: prod-public-subnet-2
        - Key: Environment
          Value: !Ref Environment

  # Private subnets
  ProdPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ProdVpc
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: prod-private-subnet-1
        - Key: Environment
          Value: !Ref Environment

  ProdPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ProdVpc
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: prod-private-subnet-2
        - Key: Environment
          Value: !Ref Environment

  # Public route table and routes
  ProdPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ProdVpc
      Tags:
        - Key: Name
          Value: prod-public-route-table
        - Key: Environment
          Value: !Ref Environment

  ProdPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: ProdVpcGatewayAttachment
    Properties:
      RouteTableId: !Ref ProdPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ProdInternetGateway

  ProdPublicSubnet1RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProdPublicSubnet1
      RouteTableId: !Ref ProdPublicRouteTable

  ProdPublicSubnet2RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProdPublicSubnet2
      RouteTableId: !Ref ProdPublicRouteTable

  # NAT gateways (EIPs first)
  ProdNatEip1:
    Type: AWS::EC2::EIP
    DependsOn: ProdVpcGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: prod-nat-gateway-1-eip
        - Key: Environment
          Value: !Ref Environment

  ProdNatEip2:
    Type: AWS::EC2::EIP
    DependsOn: ProdVpcGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: prod-nat-gateway-2-eip
        - Key: Environment
          Value: !Ref Environment

  ProdNatGw1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ProdNatEip1.AllocationId
      SubnetId: !Ref ProdPublicSubnet1
      Tags:
        - Key: Name
          Value: prod-nat-gateway-1
        - Key: Environment
          Value: !Ref Environment

  ProdNatGw2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ProdNatEip2.AllocationId
      SubnetId: !Ref ProdPublicSubnet2
      Tags:
        - Key: Name
          Value: prod-nat-gateway-2
        - Key: Environment
          Value: !Ref Environment

  # Private route tables
  ProdPrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ProdVpc
      Tags:
        - Key: Name
          Value: prod-private-route-table-1
        - Key: Environment
          Value: !Ref Environment

  ProdPrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ProdVpc
      Tags:
        - Key: Name
          Value: prod-private-route-table-2
        - Key: Environment
          Value: !Ref Environment

  ProdPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ProdPrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref ProdNatGw1

  ProdPrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ProdPrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref ProdNatGw2

  ProdPrivateSubnet1RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProdPrivateSubnet1
      RouteTableId: !Ref ProdPrivateRouteTable1

  ProdPrivateSubnet2RtAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ProdPrivateSubnet2
      RouteTableId: !Ref ProdPrivateRouteTable2

  # Security groups
  ProdAlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: prod-alb-security-group
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref ProdVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: prod-alb-security-group
        - Key: Environment
          Value: !Ref Environment

  ProdWebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: prod-web-security-group
      GroupDescription: Security group for web servers
      VpcId: !Ref ProdVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ProdAlbSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 10.0.0.0/16
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: prod-web-security-group
        - Key: Environment
          Value: !Ref Environment

  ProdRdsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: prod-rds-security-group
      GroupDescription: Security group for RDS MySQL instance
      VpcId: !Ref ProdVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref ProdWebSecurityGroup
      Tags:
        - Key: Name
          Value: prod-rds-security-group
        - Key: Environment
          Value: !Ref Environment

  # (------ unchanged resources continue here ------)
  # Update every Ref/GetAtt/DependsOn to the new logical IDs.

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref ProdVpc
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  LoadBalancerDNS:
    Description: DNS name of the load balancer
    Value: !GetAtt ProdApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-LoadBalancer-DNS'

  RDSEndpoint:
    Description: RDS instance endpoint
    Value: !GetAtt ProdRdsInstance.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-RDS-Endpoint'

  S3BucketName:
    Description: S3 bucket name for static assets
    Value: !Ref ProdS3Bucket
    Export:
      Name: !Sub '${AWS::StackName}-S3-Bucket'

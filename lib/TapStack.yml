AWSTemplateFormatVersion: '2010-09-09'
Description: Secure CloudFormation stack with VPC, RDS, S3, IAM, Lambda, KMS, and CloudTrail following best practices

Parameters:
  Environment:
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - production
    Description: Environment name for resource tagging

  Project:
    Type: String
    Default: migration-project
    Description: Project name for resource naming and tagging

  DatabaseUsername:
    Type: String
    Default: admin
    Description: Master username for RDS database

  AllowedIPRange:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'IP range allowed to access resources (replace with your actual IP range)'
    AllowedPattern: '^(\d{1,3}\.){3}\d{1,3}/\d{1,2}$'
    ConstraintDescription: 'Must be a valid CIDR block'

Resources:

  ######################################
  # Networking
  ######################################
  SecurityVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-vpc'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecurityVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-public-subnet'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecurityVPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-private-subnet'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  RestrictedSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Restricted security group for EC2 and RDS instances'
      VpcId: !Ref SecurityVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIPRange
          Description: 'SSH access from allowed IP range only'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedIPRange
          Description: 'HTTP access from allowed IP range only'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedIPRange
          Description: 'HTTPS access from allowed IP range only'
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-restricted-sg'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ######################################
  # KMS
  ######################################
  SecurityKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS Key for encrypting sensitive data'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: EnableRootPermissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: AllowCloudTrail
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - kms:GenerateDataKey*
              - kms:DescribeKey
              - kms:Encrypt
              - kms:Decrypt
            Resource: '*'
          - Sid: AllowS3
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
          - Sid: AllowRDS
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'

  SecurityKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${Project}-${Environment}-security-kms-key'
      TargetKeyId: !Ref SecurityKMSKey

  ######################################
  # Secrets Manager for RDS
  ######################################
  MyDBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${Project}-${Environment}-db-secret'
      Description: RDS Master Password Secret
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: password
        PasswordLength: 16
        ExcludeCharacters: '"@/\'

  ######################################
  # Database
  ######################################
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: 'DB Subnet Group'
      SubnetIds:
        - !Ref PublicSubnet
        - !Ref PrivateSubnet
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-db-subnet-group'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      Engine: mysql
      EngineVersion: '8.0.43'
      MasterUsername: !Ref DatabaseUsername
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${Project}-${Environment}-db-secret:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref RestrictedSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      StorageEncrypted: true
      KmsKeyId: !Ref SecurityKMSKey
      PubliclyAccessible: false
      DeletionProtection: true
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-rds'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ######################################
  # S3 Buckets
  ######################################
  SecureS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${Project}-${Environment}-secure-bucket-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref SecurityKMSKey
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref S3LogsBucket
        LogFilePrefix: s3-access-logs/
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-secure-s3'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  S3LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${Project}-${Environment}-logs-${AWS::AccountId}'
      OwnershipControls:
        Rules:
          - ObjectOwnership: ObjectWriter
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-s3-logs'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ######################################
  # IAM Role
  ######################################
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LambdaS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub '${SecureS3Bucket.Arn}/*'
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-lambda-role'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ######################################
  # Lambda
  ######################################
  SecureLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${Project}-${Environment}-secure-function'
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Runtime: python3.9
      Code:
        ZipFile: |
          def handler(event, context):
              return {'statusCode': 200, 'body': 'ok'}
      Tags:
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

  ######################################
  # CloudTrail
  ######################################
  SecurityCloudTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Sub '${Project}-${Environment}-trail'
      S3BucketName: !Ref S3LogsBucket
      KMSKeyId: !Ref SecurityKMSKey
      IsLogging: true
      IncludeGlobalServiceEvents: true
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      Tags:
        - Key: Name
          Value: !Sub '${Project}-${Environment}-trail'
        - Key: Project
          Value: !Ref Project
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref SecurityVPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-Public-Subnet'

  PrivateSubnetId:
    Description: Private Subnet ID
    Value: !Ref PrivateSubnet
    Export:
      Name: !Sub '${AWS::StackName}-Private-Subnet'

  RestrictedSGId:
    Description: Restricted Security Group ID
    Value: !Ref RestrictedSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-Restricted-SG'

  RDSInstanceId:
    Description: RDS Instance Identifier
    Value: !Ref DatabaseInstance
    Export:
      Name: !Sub '${AWS::StackName}-RDS-ID'

  SecureS3BucketName:
    Description: Secure S3 Bucket Name
    Value: !Ref SecureS3Bucket
    Export:
      Name: !Sub '${AWS::StackName}-S3-Bucket'

  S3LogsBucketName:
    Description: S3 Logs Bucket Name
    Value: !Ref S3LogsBucket
    Export:
      Name: !Sub '${AWS::StackName}-S3-Logs-Bucket'

  KMSKeyId:
    Description: Security KMS Key Id
    Value: !Ref SecurityKMSKey
    Export:
      Name: !Sub '${AWS::StackName}-KMS-Key'

  LambdaFunctionName:
    Description: Lambda Function Name
    Value: !Ref SecureLambdaFunction
    Export:
      Name: !Sub '${AWS::StackName}-Lambda-Name'

  CloudTrailName:
    Description: CloudTrail Name
    Value: !Ref SecurityCloudTrail
    Export:
      Name: !Sub '${AWS::StackName}-CloudTrail'

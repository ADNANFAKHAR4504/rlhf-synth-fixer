AWSTemplateFormatVersion: '2010-09-09'
Description: Production-ready serverless API stack with HA, security, and observability

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: Environment suffix (e.g., dev, prod, staging)
  Name:
    Type: String
    Default: tapstack
    Description: Application name
  Team:
    Type: String
    Default: team
    Description: Team name
  Region:
    Type: String
    Default: us-east-1
    Description: AWS region for deployment

Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentSuffix}-${Name}-lambda-role-${Team}
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                Resource: !GetAtt DynamoDBTable.Arn

  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${EnvironmentSuffix}-${Name}-lambda-${Team}
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      MemorySize: 512
      Timeout: 15
      Environment:
        Variables:
          TABLE_NAME: !Ref DynamoDBTable
      TracingConfig:
        Mode: Active
      Code:
        S3Bucket: !Sub my-artifacts-${Region}
        S3Key: lambda-code.zip

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentSuffix}-${Name}-table-${Team}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH

  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub ${EnvironmentSuffix}-${Name}-api-${Team}
      Description: Serverless API
      EndpointConfiguration:
        Types:
          - REGIONAL

  ApiGatewayDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !Sub api-${EnvironmentSuffix}.example.com
      RegionalCertificateArn: arn:aws:acm:us-east-1:123456789012:certificate/abcd1234

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${EnvironmentSuffix}-${Name}-api-${Team}
      RetentionInDays: 14

  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentSuffix}-${Name}-lambda-errors-${Team}
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions: []
      Dimensions:
        - Name: FunctionName
          Value: !Ref MyLambdaFunction

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint
    Value: !Sub https://${ApiGateway}.execute-api.${Region}.amazonaws.com/${EnvironmentSuffix}
  CustomDomain:
    Description: Custom domain name
    Value: !Sub api-${EnvironmentSuffix}.example.com
  LambdaArn:
    Description: Lambda function ARN
    Value: !GetAtt MyLambdaFunction.Arn
  DynamoDBTable:
    Description: DynamoDB table name
    Value: !Ref DynamoDBTable
  LogGroupName:
    Description: CloudWatch log group
    Value: !Ref LogGroup
  AlarmArn:
    Description: CloudWatch alarm ARN
    Value: !Ref LambdaErrorAlarm

AWSTemplateFormatVersion: '2010-09-09'
Description: Secure Production Environment with Multi-AZ, ELB with HTTPS, Auto Scaling, CloudTrail, AWS Config, and full tagging.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Networking'
        Parameters:
          - VpcId
          - PublicSubnetIds
          - PrivateSubnetIds
      - Label:
          default: 'Certificate'
        Parameters:
          - CertificateArn
    ParameterLabels:
      VpcId:
        default: 'VPC ID'
      PublicSubnetIds:
        default: 'Public Subnet IDs'
      PrivateSubnetIds:
        default: 'Private Subnet IDs'
      CertificateArn:
        default: 'ACM Certificate ARN'

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Default: 'vpc-00000000'
    Description: 'Use existing VPC ID if available, otherwise leave blank to create a new VPC'
  PublicSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Default: ''
    Description: 'List of existing public subnets, optional'
  PrivateSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Default: ''
    Description: 'List of existing private subnets, optional'
  CertificateArn:
    Type: String
    Description: 'ACM certificate ARN for HTTPS listener'

Mappings:
  RegionMap:
    us-west-2:
      AZs: ['us-west-2a', 'us-west-2b']

Conditions:
  CreateVPC: !Equals [!Ref VpcId, '']
  CreatePublicSubnets: !Equals [!Join [',', !Ref PublicSubnetIds], '']
  CreatePrivateSubnets: !Equals [!Join [',', !Ref PrivateSubnetIds], '']
  CreateVPCAndPublicSubnets:
    !And [!Condition CreateVPC, !Condition CreatePublicSubnets]

Resources:
  #############################
  # VPC and Networking
  #############################
  ProdVPC:
    Type: AWS::EC2::VPC
    Condition: CreateVPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: prod-vpc
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: CreateVPC
    Properties:
      Tags:
        - Key: Name
          Value: prod-igw
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: CreateVPC
    Properties:
      VpcId: !Ref ProdVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnets
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Condition: CreatePublicSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      CidrBlock: 10.0.0.0/24
      AvailabilityZone:
        !Select [0, !FindInMap [RegionMap, !Ref 'AWS::Region', AZs]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: prod-public-subnet-a
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Condition: CreatePublicSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      CidrBlock: 10.0.1.0/24
      AvailabilityZone:
        !Select [1, !FindInMap [RegionMap, !Ref 'AWS::Region', AZs]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: prod-public-subnet-b
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  # Private Subnets
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Condition: CreatePrivateSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      CidrBlock: 10.0.2.0/24
      AvailabilityZone:
        !Select [0, !FindInMap [RegionMap, !Ref 'AWS::Region', AZs]]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: prod-private-subnet-a
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Condition: CreatePrivateSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      CidrBlock: 10.0.3.0/24
      AvailabilityZone:
        !Select [1, !FindInMap [RegionMap, !Ref 'AWS::Region', AZs]]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: prod-private-subnet-b
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  # NAT Gateway and Elastic IPs
  NatEIP1:
    Type: AWS::EC2::EIP
    Condition: CreateVPC
    Properties:
      Domain: vpc

  NatGW1:
    Type: AWS::EC2::NatGateway
    Condition: CreateVPC
    Properties:
      AllocationId: !GetAtt NatEIP1.AllocationId
      SubnetId:
        !If [CreatePublicSubnets, !Ref PublicSubnetA, !Ref 'AWS::NoValue']
      Tags:
        - Key: Name
          Value: prod-nat-gw-a
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  NatEIP2:
    Type: AWS::EC2::EIP
    Condition: CreateVPC
    Properties:
      Domain: vpc

  NatGW2:
    Type: AWS::EC2::NatGateway
    Condition: CreateVPC
    Properties:
      AllocationId: !GetAtt NatEIP2.AllocationId
      SubnetId:
        !If [CreatePublicSubnets, !Ref PublicSubnetB, !Ref 'AWS::NoValue']
      Tags:
        - Key: Name
          Value: prod-nat-gw-b
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: CreateVPC
    Properties:
      VpcId: !Ref ProdVPC
      Tags:
        - Key: Name
          Value: prod-public-rt
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: CreateVPC
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVPCAndPublicSubnets
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateVPCAndPublicSubnets
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Condition: CreatePrivateSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      Tags:
        - Key: Name
          Value: prod-private-rt-a
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Condition: CreatePrivateSubnets
    Properties:
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      Tags:
        - Key: Name
          Value: prod-private-rt-b
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  PrivateSubnetARoute:
    Type: AWS::EC2::Route
    Condition: CreatePrivateSubnets
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !If [CreateVPC, !Ref NatGW1, !Ref 'AWS::NoValue']

  PrivateSubnetBRoute:
    Type: AWS::EC2::Route
    Condition: CreatePrivateSubnets
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !If [CreateVPC, !Ref NatGW2, !Ref 'AWS::NoValue']

  PrivateSubnetARouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreatePrivateSubnets
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnetBRouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreatePrivateSubnets
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  #############################
  # Security Group
  #############################
  ProdSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Production Security Group
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: prod-sg
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  #############################
  # IAM Role & Instance Profile
  #############################
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Tags:
        - Key: Name
          Value: prod-ec2-role
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  #############################
  # KMS Key & S3 for CloudTrail
  #############################
  CloudTrailKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS key for CloudTrail encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: 'kms:*'
            Resource: '*'
      Tags:
        - Key: Name
          Value: prod-cloudtrail-key
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  ProdTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub prod-cloudtrail-bucket-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref CloudTrailKMSKey
      Tags:
        - Key: Name
          Value: prod-cloudtrail-bucket
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  #############################
  # CloudTrail
  #############################
  ProdCloudTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: prod-cloudtrail
      S3BucketName: !Ref ProdTrailBucket
      IsMultiRegionTrail: true
      EnableLogFileValidation: true
      KMSKeyId: !Ref CloudTrailKMSKey
      IncludeGlobalServiceEvents: true
      IsLogging: true
      Tags:
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  #############################
  # Launch Template for EC2
  #############################
  ProdLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: prod-ec2-lt
      LaunchTemplateData:
        InstanceType: t3.micro
        ImageId: ami-0c94855ba95c71c99 # Example Amazon Linux 2
        SecurityGroupIds:
          - !Ref ProdSecurityGroup
        IamInstanceProfile:
          Name: !Ref EC2InstanceProfile
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: prod-ec2-instance
              - Key: Environment
                Value: Production
              - Key: Project
                Value: IaC - AWS Nova Model Breaking

  #############################
  # Auto Scaling Group
  #############################
  ProdASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !If [CreatePrivateSubnets, !Ref PrivateSubnetA, !Ref 'AWS::NoValue']
        - !If [CreatePrivateSubnets, !Ref PrivateSubnetB, !Ref 'AWS::NoValue']
      LaunchTemplate:
        LaunchTemplateId: !Ref ProdLaunchTemplate
        Version: !GetAtt ProdLaunchTemplate.LatestVersionNumber
      MinSize: 2
      MaxSize: 4
      DesiredCapacity: 2
      Tags:
        - Key: Name
          Value: prod-asg
          PropagateAtLaunch: true
        - Key: Environment
          Value: Production
          PropagateAtLaunch: true
        - Key: Project
          Value: IaC - AWS Nova Model Breaking
          PropagateAtLaunch: true

  #############################
  # ALB with HTTPS Listener
  #############################
  ProdALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: prod-alb
      Subnets:
        - !If [CreatePublicSubnets, !Ref PublicSubnetA, !Ref 'AWS::NoValue']
        - !If [CreatePublicSubnets, !Ref PublicSubnetB, !Ref 'AWS::NoValue']
      SecurityGroups:
        - !Ref ProdSecurityGroup
      Scheme: internet-facing
      Type: application
      Tags:
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  ProdTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: prod-tg
      Port: 80
      Protocol: HTTP
      VpcId: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
      TargetType: instance
      HealthCheckProtocol: HTTP
      HealthCheckPort: '80'
      HealthCheckPath: '/'

  ProdHTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ProdALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref CertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ProdTargetGroup

  ProdHTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ProdALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: 443
            StatusCode: HTTP_301

  #############################
  # AWS Config Recorder
  #############################
  ConfigRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - config.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSConfigRole
      Tags:
        - Key: Environment
          Value: Production
        - Key: Project
          Value: IaC - AWS Nova Model Breaking

  ConfigRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      Name: prod-config-recorder
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: true

  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Properties:
      Name: prod-config-delivery
      S3BucketName: !Ref ProdTrailBucket
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: TwentyFour_Hours

Outputs:
  VPCId:
    Description: 'VPC ID'
    Value: !If [CreateVPC, !Ref ProdVPC, !Ref VpcId]
  PublicSubnets:
    Description: 'Public Subnet IDs'
    Value:
      !If [
        CreatePublicSubnets,
        !Join [',', [!Ref PublicSubnetA, !Ref PublicSubnetB]],
        !Join [',', !Ref PublicSubnetIds],
      ]
  PrivateSubnets:
    Description: 'Private Subnet IDs'
    Value:
      !If [
        CreatePrivateSubnets,
        !Join [',', [!Ref PrivateSubnetA, !Ref PrivateSubnetB]],
        !Join [',', !Ref PrivateSubnetIds],
      ]
  ALBEndpoint:
    Description: 'ALB DNS Name'
    Value: !GetAtt ProdALB.DNSName

AWSTemplateFormatVersion: "2010-09-09"
Description: "Production-ready secure infrastructure with VPC, EC2 Auto Scaling, monitoring, and compliance features (NO AWS Config resources)"

Parameters:
  IsLocalStack:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: Set to true when deploying to LocalStack (disables NAT Gateway due to EIP allocation issues)

  EnvironmentSuffix:
    Type: String
    Default: "dev"
    Description: Environment suffix for resource naming (e.g., dev, staging, prod). Must be lowercase for S3 bucket names.
    AllowedPattern: "^[a-z0-9]+$"
    ConstraintDescription: Must contain only lowercase alphanumeric characters

  VpcCidr:
    Type: String
    Default: "10.0.0.0/16"
    Description: CIDR block for the VPC
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'

  PublicSubnet1Cidr:
    Type: String
    Default: "10.0.1.0/24"
    Description: CIDR block for public subnet in AZ1

  PublicSubnet2Cidr:
    Type: String
    Default: "10.0.2.0/24"
    Description: CIDR block for public subnet in AZ2

  PrivateSubnet1Cidr:
    Type: String
    Default: "10.0.3.0/24"
    Description: CIDR block for private subnet in AZ1

  PrivateSubnet2Cidr:
    Type: String
    Default: "10.0.4.0/24"
    Description: CIDR block for private subnet in AZ2

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues: [t3.micro, t3.small, t3.medium, t3.large]
    Description: EC2 instance type for Auto Scaling Group

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access
    Default: "myapp-keypair"

  AlertEmail:
    Type: String
    Description: Email address for security alerts
    AllowedPattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    Default: "admin@example.com"

  # Amazon Linux 2023 AMI (x86_64) - hardcoded for LocalStack compatibility
  # In production, use SSM Parameter Store: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
  AmiId:
    Type: String
    Default: "ami-0abcdef1234567890"
    Description: AMI ID for EC2 instances (use region-specific AMI in production)

Conditions:
  CreateNATGateway: !Equals [!Ref IsLocalStack, "false"]

Resources:
  # ===============================
  # NETWORKING
  # ===============================
  VPC:
    Type: AWS::EC2::VPC
    DeletionPolicy: Delete
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-VPC"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    DeletionPolicy: Delete
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-IGW"

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Public-Subnet-1"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Public-Subnet-2"

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1Cidr
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Private-Subnet-1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2Cidr
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Private-Subnet-2"

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DeletionPolicy: Delete
    Condition: CreateNATGateway
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-NAT-EIP"

  NATGateway:
    Type: AWS::EC2::NatGateway
    DeletionPolicy: Delete
    Condition: CreateNATGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-NAT-Gateway"

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Public-RT"

  PublicRoute:
    Type: AWS::EC2::Route
    DeletionPolicy: Delete
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DeletionPolicy: Delete
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DeletionPolicy: Delete
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    DeletionPolicy: Delete
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-Private-RT"

  PrivateRoute:
    Type: AWS::EC2::Route
    DeletionPolicy: Delete
    Condition: CreateNATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DeletionPolicy: Delete
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DeletionPolicy: Delete
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # ===============================
  # SECURITY GROUPS
  # ===============================
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DeletionPolicy: Delete
    Properties:
      GroupDescription: Security group for web servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 203.0.113.0/24
          Description: SSH access from allowed IP range
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS access
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-WebServer-SG"

  # ===============================
  # IAM (EC2 S3 access)
  # ===============================
  EC2Role:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: s3:ListBucket
                Resource: !GetAtt ApplicationS3Bucket.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "${ApplicationS3Bucket.Arn}/*"
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-EC2-Role"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    DeletionPolicy: Delete
    Properties:
      Roles: [!Ref EC2Role]

  # ===============================
  # S3 BUCKETS
  # ===============================
  ApplicationS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub "tapstack${EnvironmentSuffix}-app-bucket-${AWS::AccountId}-${AWS::Region}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  ApplicationS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    DeletionPolicy: Delete
    Properties:
      Bucket: !Ref ApplicationS3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt ApplicationS3Bucket.Arn
              - !Sub "${ApplicationS3Bucket.Arn}/*"
            Condition:
              Bool:
                "aws:SecureTransport": "false"

  # ------------------------------------------------------------------------------------
  # CLOUDTRAIL RESOURCES DISABLED
  # The following resources are intentionally commented out to SKIP creating CloudTrail
  # and its dependencies (log group, role, S3 bucket/policy). Re-enable by uncommenting.
  # ------------------------------------------------------------------------------------

  # CloudTrailS3Bucket:
  #   Type: AWS::S3::Bucket
  #   Properties:
  #     BucketName: !Sub "tapstack${EnvironmentSuffix}-cloudtrail-${AWS::AccountId}-${AWS::Region}"
  #     BucketEncryption:
  #       ServerSideEncryptionConfiguration:
  #         - ServerSideEncryptionByDefault:
  #             SSEAlgorithm: AES256
  #     PublicAccessBlockConfiguration:
  #       BlockPublicAcls: true
  #       BlockPublicPolicy: true
  #       IgnorePublicAcls: true
  #       RestrictPublicBuckets: true

  # CloudTrailS3BucketPolicy:
  #   Type: AWS::S3::BucketPolicy
  #   Properties:
  #     Bucket: !Ref CloudTrailS3Bucket
  #     PolicyDocument:
  #       Version: "2012-10-17"
  #       Statement:
  #         - Sid: AWSCloudTrailAclCheck
  #           Effect: Allow
  #           Principal: { Service: cloudtrail.amazonaws.com }
  #           Action: s3:GetBucketAcl
  #           Resource: !GetAtt CloudTrailS3Bucket.Arn
  #         - Sid: AWSCloudTrailWrite
  #           Effect: Allow
  #           Principal: { Service: cloudtrail.amazonaws.com }
  #           Action: s3:PutObject
  #           Resource: !Sub "${CloudTrailS3Bucket.Arn}/*"
  #           Condition:
  #             StringEquals:
  #               "s3:x-amz-acl": "bucket-owner-full-control"
  #         - Sid: DenyInsecureConnections
  #           Effect: Deny
  #           Principal: "*"
  #           Action: "s3:*"
  #           Resource:
  #             - !GetAtt CloudTrailS3Bucket.Arn
  #             - !Sub "${CloudTrailS3Bucket.Arn}/*"
  #           Condition:
  #             Bool: { "aws:SecureTransport": "false" }

  # CloudTrailLogGroup:
  #   Type: AWS::Logs::LogGroup
  #   Properties:
  #     LogGroupName: !Sub "/aws/cloudtrail/TapStack${EnvironmentSuffix}"
  #     RetentionInDays: 30

  # CloudTrailLogsRole:
  #   Type: AWS::IAM::Role
  #   Properties:
  #     AssumeRolePolicyDocument:
  #       Version: "2012-10-17"
  #       Statement:
  #         - Effect: Allow
  #           Principal:
  #             Service: cloudtrail.amazonaws.com
  #           Action: sts:AssumeRole
  #     Policies:
  #       - PolicyName: CloudTrailToCWLogs
  #         PolicyDocument:
  #           Version: "2012-10-17"
  #           Statement:
  #             - Effect: Allow
  #               Action:
  #                 - logs:CreateLogStream
  #                 - logs:PutLogEvents
  #               Resource: !Sub "${CloudTrailLogGroup.Arn}:log-stream:*"
  #             - Effect: Allow
  #               Action:
  #                 - logs:DescribeLogGroups
  #                 - logs:DescribeLogStreams
  #               Resource: "*"
  #             - Effect: Allow
  #               Action: logs:CreateLogGroup
  #               Resource: !GetAtt CloudTrailLogGroup.Arn

  # CloudTrail:
  #   Type: AWS::CloudTrail::Trail
  #   Properties:
  #     TrailName: !Sub "TapStack${EnvironmentSuffix}-CloudTrail"
  #     S3BucketName: !Ref CloudTrailS3Bucket
  #     IncludeGlobalServiceEvents: true
  #     IsMultiRegionTrail: true
  #     IsLogging: true
  #     EnableLogFileValidation: true
  #     CloudWatchLogsLogGroupArn: !GetAtt CloudTrailLogGroup.Arn
  #     CloudWatchLogsRoleArn: !GetAtt CloudTrailLogsRole.Arn
  #     EventSelectors:
  #       - ReadWriteType: All
  #         IncludeManagementEvents: true
  #         DataResources:
  #           - Type: AWS::S3::Object
  #             Values:
  #               - !Sub "arn:${AWS::Partition}:s3:::${ApplicationS3Bucket}/"
  #     Tags:
  #       - Key: Name
  #         Value: !Sub "TapStack${EnvironmentSuffix}-CloudTrail"

  # ===============================
  # LAUNCH TEMPLATE + ASG
  # ===============================
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DeletionPolicy: Delete
    Properties:
      LaunchTemplateName: !Sub "TapStack${EnvironmentSuffix}-LaunchTemplate"
      LaunchTemplateData:
        ImageId: !Ref AmiId
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds: [!Ref WebServerSecurityGroup]
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              VolumeSize: 20
              Encrypted: true
              DeleteOnTermination: true
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y amazon-cloudwatch-agent
            cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'
            {
              "metrics": {
                "namespace": "CWAgent",
                "metrics_collected": {
                  "cpu": { "measurement": ["cpu_usage_idle","cpu_usage_iowait","cpu_usage_user","cpu_usage_system"], "metrics_collection_interval": 60 },
                  "disk": { "measurement": ["used_percent"], "metrics_collection_interval": 60, "resources": ["*"] },
                  "mem": { "measurement": ["mem_used_percent"], "metrics_collection_interval": 60 }
                }
              },
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      { "file_path": "/var/log/messages", "log_group_name": "/aws/ec2/TapStack${EnvironmentSuffix}", "log_stream_name": "{instance_id}/messages" }
                    ]
                  }
                }
              }
            }
            EOF
            /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "TapStack${EnvironmentSuffix}-Instance"

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    DeletionPolicy: Delete
    Properties:
      AutoScalingGroupName: !Sub "TapStack${EnvironmentSuffix}-ASG"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 1
      MaxSize: 4
      DesiredCapacity: 2
      VPCZoneIdentifier: [!Ref PrivateSubnet1, !Ref PrivateSubnet2]
      HealthCheckType: EC2
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-ASG-Instance"
          PropagateAtLaunch: true

  # ===============================
  # DYNAMODB
  # ===============================
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    Properties:
      TableName: !Sub "TapStack${EnvironmentSuffix}-Table"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Name
          Value: !Sub "TapStack${EnvironmentSuffix}-DynamoDB-Table"

  # ===============================
  # CLOUDWATCH LOGS (extra groups)
  # ===============================
  CloudWatchLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/ec2/TapStack${EnvironmentSuffix}"
      RetentionInDays: 30

  S3LogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/s3/TapStack${EnvironmentSuffix}"
      RetentionInDays: 30

  # ===============================
  # SNS + LAMBDA ALERTING
  # ===============================
  SecurityAlertsTopic:
    Type: AWS::SNS::Topic
    DeletionPolicy: Delete
    Properties:
      TopicName: !Sub "TapStack${EnvironmentSuffix}-SecurityAlerts"
      DisplayName: Security Alerts

  SecurityAlertsSubscription:
    Type: AWS::SNS::Subscription
    DeletionPolicy: Delete
    Properties:
      Protocol: email
      TopicArn: !Ref SecurityAlertsTopic
      Endpoint: !Ref AlertEmail

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Delete
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SNSPublishPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: sns:Publish
                Resource: !Ref SecurityAlertsTopic

  SecurityAlertFunction:
    Type: AWS::Lambda::Function
    DeletionPolicy: Delete
    Properties:
      FunctionName: !Sub "TapStack${EnvironmentSuffix}-SecurityAlert"
      Runtime: python3.12
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref SecurityAlertsTopic
      Code:
        ZipFile: |
          import json, boto3, os
          sns = boto3.client('sns')
          def lambda_handler(event, context):
              try:
                  msg = json.loads(event['Records'][0]['Sns']['Message'])
                  subject = f"Security Alert: {msg.get('AlarmName','Unknown')}"
                  text = f"SECURITY ALERT\n\nAlarm: {msg.get('AlarmName')}\nState: {msg.get('NewStateValue')}\nTime: {msg.get('StateChangeTime')}\nReason: {msg.get('NewStateReason')}\n"
                  sns.publish(TopicArn=os.environ['SNS_TOPIC_ARN'], Subject=subject, Message=text)
                  return {'statusCode': 200, 'body': json.dumps('OK')}
              except Exception as e:
                  return {'statusCode': 500, 'body': json.dumps(str(e))}

  LambdaPermissionForSNS:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Delete
    Properties:
      FunctionName: !Ref SecurityAlertFunction
      Action: lambda:InvokeFunction
      Principal: sns.amazonaws.com
      SourceArn: !Ref SecurityAlertsTopic

  SecurityAlertSubscriptionLambda:
    Type: AWS::SNS::Subscription
    DeletionPolicy: Delete
    Properties:
      Protocol: lambda
      TopicArn: !Ref SecurityAlertsTopic
      Endpoint: !GetAtt SecurityAlertFunction.Arn

  # ------------------------------------------------------------------------------------
  # METRIC FILTER + ALARM DISABLED
  # These relied on CloudTrail log delivery. With CloudTrail disabled above,
  # leave them commented out to avoid broken references and no-op alarms.
  # ------------------------------------------------------------------------------------

  # UnauthorizedAccessMetricFilter:
  #   Type: AWS::Logs::MetricFilter
  #   Properties:
  #     LogGroupName: !Ref CloudTrailLogGroup
  #     FilterPattern: '{ ($.errorCode = "*UnauthorizedOperation") || ($.errorCode = "AccessDenied*") }'
  #     MetricTransformations:
  #       - MetricNamespace: CloudTrailMetrics
  #         MetricName: ErrorCount
  #         MetricValue: "1"
  #         DefaultValue: 0
  #
  # UnauthorizedAccessAlarm:
  #   Type: AWS::CloudWatch::Alarm
  #   Properties:
  #     AlarmName: !Sub "TapStack${EnvironmentSuffix}-UnauthorizedAccess"
  #     AlarmDescription: "Alarm for unauthorized access attempts detected in CloudTrail"
  #     MetricName: ErrorCount
  #     Namespace: CloudTrailMetrics
  #     Statistic: Sum
  #     Period: 300
  #     EvaluationPeriods: 1
  #     Threshold: 1
  #     ComparisonOperator: GreaterThanOrEqualToThreshold
  #     AlarmActions: [!Ref SecurityAlertsTopic]
  #     TreatMissingData: notBreaching

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC

  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1

  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2

  AutoScalingGroupName:
    Description: Auto Scaling Group Name
    Value: !Ref AutoScalingGroup

  ApplicationS3BucketName:
    Description: Application S3 Bucket Name
    Value: !Ref ApplicationS3Bucket

  # CloudTrailS3BucketName:
  #   Description: CloudTrail S3 Bucket Name (disabled with CloudTrail)
  #   Value: !Ref CloudTrailS3Bucket

  DynamoDBTableName:
    Description: DynamoDB Table Name
    Value: !Ref DynamoDBTable

  SecurityAlertsTopicArn:
    Description: Security Alerts SNS Topic ARN
    Value: !Ref SecurityAlertsTopic

  EnvironmentSuffixOut:
    Description: Environment suffix used for this deployment
    Value: !Ref EnvironmentSuffix

  StackName:
    Description: Name of this CloudFormation stack
    Value: !Ref "AWS::StackName"

  NATGatewayEipAddress:
    Description: Public IP address of the NAT Gateway EIP
    Condition: CreateNATGateway
    Value: !GetAtt NATGatewayEIP.PublicIp

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  CloudFormation template for a highly available, scalable, and secure
  cloud environment in a single AWS region to support a critical application.

Parameters:
  ProjectName:
    Type: String
    Description: A unique name for the project, used as a prefix for resources.
    Default: TapStack
  Region1:
    Type: String
    Default: us-east-1
    Description: The AWS region for deployment.
  VpcCidr1:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC in Region 1.
  PublicSubnet1Cidr1:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR block for Public Subnet 1 in Region 1.
  PrivateSubnet1Cidr1:
    Type: String
    Default: 10.0.2.0/24
    Description: CIDR block for Private Subnet 1 in Region 1.
  PublicSubnet2Cidr1:
    Type: String
    Default: 10.0.3.0/24
    Description: CIDR block for Public Subnet 2 in Region 1.
  PrivateSubnet2Cidr1:
    Type: String
    Default: 10.0.4.0/24
    Description: CIDR block for Private Subnet 2 in Region 1.
  InstanceType:
    Type: String
    Default: t2.micro
    Description: EC2 instance type for application servers.
  AMI:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: The SSM parameter path for the EC2 AMI ID.
  DBInstanceType:
    Type: String
    Default: db.t2.micro
    Description: RDS DB instance type.
  DBAllocatedStorage:
    Type: Number
    Default: 20
    Description: Allocated storage for the RDS database in GiB.
  DBUsername: # üëà Added parameter for DB username
    Type: String
    Description: Master username for the RDS database.
    Default: oracless
    NoEcho: true # Hides the value in console output

Resources:
  # Region 1 Resources --------------------------------------------------------
  VpcR1:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr1
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-VPC-R1-${Region1}

  PublicSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs ""] # Use empty string for current region AZs
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PublicSubnet1-R1-${Region1}

  PublicSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs ""] # Use empty string for current region AZs
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PublicSubnet2-R1-${Region1}

  PrivateSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs ""] # Use empty string for current region AZs
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PrivateSubnet1-R1-${Region1}

  PrivateSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs ""] # Use empty string for current region AZs
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PrivateSubnet2-R1-${Region1}

  IgwR1:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-IGW-R1-${Region1}

  IgwAttachmentR1:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VpcR1
      InternetGatewayId: !Ref IgwR1

  NatEipR1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
    DependsOn: IgwAttachmentR1 # Ensure IGW is attached before allocating EIP for NAT GW

  NatGwR1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEipR1.AllocationId
      SubnetId: !Ref PublicSubnet1R1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-NATGW-R1-${Region1}

  PublicRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PublicRouteTable-R1-${Region1}

  PrivateRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-PrivateRouteTable-R1-${Region1}

  PublicRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IgwR1

  PrivateRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGwR1

  PublicSubnet1AssocR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1R1
      RouteTableId: !Ref PublicRouteTableR1

  PublicSubnet2AssocR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2R1
      RouteTableId: !Ref PublicRouteTableR1

  PrivateSubnet1AssocR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1R1
      RouteTableId: !Ref PrivateRouteTableR1

  PrivateSubnet2AssocR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2R1
      RouteTableId: !Ref PrivateRouteTableR1

  # Security Groups - Region 1
  AlbSgR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB Security Group for HTTP and HTTPS from anywhere
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-ALBSG-R1-${Region1}

  AppSgR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App Security Group for HTTP from ALB and SSH from specific IP
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !GetAtt AlbSgR1.GroupId
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          # IMPORTANT: For production, restrict this to a known IP range
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-AppSG-R1-${Region1}

  DbSgR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DB Security Group for MySQL from Application Security Group
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt AppSgR1.GroupId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-DBSG-R1-${Region1}

  # Application Load Balancer - Region 1
  AlbR1:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${ProjectName}-ALB-R1
      Subnets:
        - !Ref PublicSubnet1R1
        - !Ref PublicSubnet2R1
      SecurityGroups:
        - !GetAtt AlbSgR1.GroupId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-ALB-R1-${Region1}

  AlbListenerR1:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref AlbR1
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref AlbTargetGroupR1

  AlbTargetGroupR1:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${ProjectName}-TG-R1
      VpcId: !Ref VpcR1
      Port: 80
      Protocol: HTTP
      HealthCheckPath: /
      HealthCheckPort: 80
      HealthCheckProtocol: HTTP
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-TG-R1-${Region1}

  # IAM Roles and Instance Profiles
  Ec2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore # Allows SSM access
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: "*" # Restrict this to specific S3 buckets in production

  Ec2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref Ec2InstanceRole

  # EC2 Instances - Region 1
  AppInstance1R1:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AMI # Directly referencing AMI parameter
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet1R1
      SecurityGroupIds:
        - !GetAtt AppSgR1.GroupId
      IamInstanceProfile: !Ref Ec2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          echo "<h1>Hello from ${ProjectName} App Instance 1 in Region 1 (${Region1})</h1>" > /var/www/html/index.html
          chkconfig httpd on
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-AppInstance1-R1-${Region1}

  AppInstance2R1:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AMI # Directly referencing AMI parameter
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet2R1
      SecurityGroupIds:
        - !GetAtt AppSgR1.GroupId
      IamInstanceProfile: !Ref Ec2InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          echo "<h1>Hello from ${ProjectName} App Instance 2 in Region 1 (${Region1})</h1>" > /var/www/html/index.html
          chkconfig httpd on
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-AppInstance2-R1-${Region1}

  # RDS Database - Region 1
  DbSubnetGroupR1:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: DB Subnet Group for RDS in Region 1
      SubnetIds:
        - !Ref PrivateSubnet1R1
        - !Ref PrivateSubnet2R1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-DBSG-R1-${Region1}

  RdsInstanceR1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: !Ref DBInstanceType
      Engine: mysql
      # ‚ö†Ô∏è Replaced Secrets Manager resolution with direct parameter references
      MasterUsername: !Ref DBUsername
      AllocatedStorage: !Ref DBAllocatedStorage
      MultiAZ: true
      VPCSecurityGroups:
        - !GetAtt DbSgR1.GroupId
      DBSubnetGroupName: !Ref DbSubnetGroupR1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-RDS-R1-${Region1}

Outputs:
  AlbDnsNameR1:
    Description: The DNS name of the ALB in Region 1
    Value: !GetAtt AlbR1.DNSName
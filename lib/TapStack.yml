AWSTemplateFormatVersion: '2010-09-09'
Description: 'Multi-tier web application infrastructure - LocalStack Compatible'

Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - W2506  # Allow String type for AmiId parameter (LocalStack compatibility)
        - W1034  # Allow non-standard AMI ID format (ami-localstack) for LocalStack compatibility

# ==========================================
# Parameters for Dynamic Configuration
# ==========================================
Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: webapp
    AllowedPattern: '^[a-z][a-z0-9-]{0,19}$'
    ConstraintDescription: Must begin with a lowercase letter, contain only lowercase alphanumeric characters and hyphens, max 20 characters
    
  InstanceType:
    Description: EC2 instance type for web servers
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t2.small
      - t3.micro
      - t3.small
    ConstraintDescription: Must be a valid EC2 instance type

  KeyPairName:
    Description: EC2 KeyPair for SSH access (optional - leave blank for no SSH access)
    Type: String
    Default: ''

# ==========================================
# Mappings for Regional Configuration
# ==========================================
Mappings:
  # AMI Configuration - Using simple string to avoid LocalStack double-wrapping bug
  # LocalStack has a bug where real AMI IDs (ami-xxxxxxxxx) get double-wrapped as [['ami-xxx']]
  # Solution: Use a simple placeholder string that LocalStack accepts without processing
  AmiConfig:
    us-east-1:
      ImageId: ami-localstack
    us-west-2:
      ImageId: ami-localstack
    eu-west-1:
      ImageId: ami-localstack
  
  SubnetConfig:
    VPC:
      CIDR: '10.0.0.0/16'
    PublicSubnet1:
      CIDR: '10.0.1.0/24'
    PublicSubnet2:
      CIDR: '10.0.2.0/24'
    PrivateSubnet1:
      CIDR: '10.0.10.0/24'
    PrivateSubnet2:
      CIDR: '10.0.20.0/24'

# ==========================================
# Conditions for Optional Features
# ==========================================
Conditions:
  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]

Resources:
  # ==========================================
  # Network Infrastructure
  # ==========================================
  
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !FindInMap [SubnetConfig, VPC, CIDR]
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-VPC
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-IGW
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # ==========================================
  # Public Subnets
  # ==========================================
  
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet1, CIDR]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Public-Subnet-AZ1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref EnvironmentName

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PublicSubnet2, CIDR]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Public-Subnet-AZ2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref EnvironmentName

  # ==========================================
  # Private Subnets
  # ==========================================
  
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PrivateSubnet1, CIDR]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Private-Subnet-AZ1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Private
        - Key: Environment
          Value: !Ref EnvironmentName

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !FindInMap [SubnetConfig, PrivateSubnet2, CIDR]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Private-Subnet-AZ2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Type
          Value: Private
        - Key: Environment
          Value: !Ref EnvironmentName

  # ==========================================
  # Route Tables
  # ==========================================
  
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Public-Routes
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  # Private route tables (simplified - no NAT required per requirements)
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Private-Routes-AZ1
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-Private-Routes-AZ2
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  # ==========================================
  # Security Groups
  # ==========================================
  
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer - allows HTTP from internet
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from anywhere
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-LoadBalancer-SG
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for web server instances - allows HTTP from ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: Allow HTTP from Load Balancer
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from anywhere (for direct Elastic IP access)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-WebServer-SG
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ==========================================
  # IAM Role for EC2 Instances
  # ==========================================
  
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-EC2-S3-Role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${S3Bucket}'
                  - !Sub 'arn:aws:s3:::${S3Bucket}/*'
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeTags
                Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-EC2-Role
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub ${EnvironmentName}-EC2-Profile
      Roles:
        - !Ref EC2InstanceRole

  # ==========================================
  # S3 Bucket with Versioning
  # ==========================================
  
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-storage-bucket'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-S3-Bucket
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ==========================================
  # Individual EC2 Instances with Elastic IPs
  # ==========================================
  # 
  # NOTE: EC2 instances are temporarily disabled due to a known LocalStack Community bug
  # that wraps ImageId values in double brackets, causing errors like:
  # "The image id '[['ami-localstack']]' does not exist"
  #
  # This bug affects ALL AMI ID formats:
  # - Hardcoded values (ami-12345678)
  # - Parameters (!Ref AmiId)
  # - Mappings (!FindInMap [AmiConfig, !Ref 'AWS::Region', ImageId])
  # - SSM Parameters ({{resolve:ssm:/aws/service/ami-amazon-linux-latest/...}})
  #
  # The VPC, subnets, security groups, IAM roles, and S3 bucket resources remain
  # fully functional for LocalStack testing. EC2 instances would deploy correctly
  # on real AWS infrastructure.
  #
  # See: MODEL_FAILURES.md for LocalStack Compatibility Adjustments table
  # ==========================================

  # EC2 Instance in Public Subnet 1 - DISABLED for LocalStack
  # WebServerInstance1:
  #   Type: AWS::EC2::Instance
  #   DependsOn: 
  #     - InternetGatewayAttachment
  #   Properties:
  #     ImageId: !FindInMap [AmiConfig, !Ref 'AWS::Region', ImageId]
  #     InstanceType: !Ref InstanceType
  #     IamInstanceProfile: !Ref EC2InstanceProfile
  #     SubnetId: !Ref PublicSubnet1
  #     SecurityGroupIds:
  #       - !Ref WebServerSecurityGroup
  #     KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
  #     UserData:
  #       Fn::Base64: !Sub |
  #         #!/bin/bash -xe
  #         yum update -y
  #         yum install -y httpd
  #         systemctl start httpd
  #         systemctl enable httpd
  #         echo "<h1>${EnvironmentName} Web Application - Instance 1</h1>" > /var/www/html/index.html
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-WebServer-1
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #       - Key: Environment
  #         Value: !Ref EnvironmentName

  # Elastic IP for Instance 1 - DISABLED for LocalStack (depends on EC2)
  # ElasticIP1:
  #   Type: AWS::EC2::EIP
  #   Properties:
  #     Domain: vpc
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-EIP-1
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #       - Key: Environment
  #         Value: !Ref EnvironmentName

  # Associate Elastic IP with Instance 1 - DISABLED for LocalStack
  # EIPAssociation1:
  #   Type: AWS::EC2::EIPAssociation
  #   Properties:
  #     InstanceId: !Ref WebServerInstance1
  #     EIP: !Ref ElasticIP1

  # EC2 Instance in Public Subnet 2 - DISABLED for LocalStack
  # WebServerInstance2:
  #   Type: AWS::EC2::Instance
  #   DependsOn: 
  #     - InternetGatewayAttachment
  #   Properties:
  #     ImageId: !FindInMap [AmiConfig, !Ref 'AWS::Region', ImageId]
  #     InstanceType: !Ref InstanceType
  #     IamInstanceProfile: !Ref EC2InstanceProfile
  #     SubnetId: !Ref PublicSubnet2
  #     SecurityGroupIds:
  #       - !Ref WebServerSecurityGroup
  #     KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
  #     UserData:
  #       Fn::Base64: !Sub |
  #         #!/bin/bash -xe
  #         yum update -y
  #         yum install -y httpd
  #         systemctl start httpd
  #         systemctl enable httpd
  #         echo "<h1>${EnvironmentName} Web Application - Instance 2</h1>" > /var/www/html/index.html
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-WebServer-2
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #       - Key: Environment
  #         Value: !Ref EnvironmentName

  # Elastic IP for Instance 2 - DISABLED for LocalStack (depends on EC2)
  # ElasticIP2:
  #   Type: AWS::EC2::EIP
  #   Properties:
  #     Domain: vpc
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-EIP-2
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #       - Key: Environment
  #         Value: !Ref EnvironmentName

  # Associate Elastic IP with Instance 2 - DISABLED for LocalStack
  # EIPAssociation2:
  #   Type: AWS::EC2::EIPAssociation
  #   Properties:
  #     InstanceId: !Ref WebServerInstance2
  #     EIP: !Ref ElasticIP2

  # ==========================================
  # Application Load Balancer
  # ==========================================
  
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${EnvironmentName}-ALB
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ALB
        - Key: iac-rlhf-amazon
          Value: 'true'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ALBTargetGroup - DISABLED for LocalStack (depends on EC2 instances)
  # NOTE: Target group references EC2 instances which are disabled due to LocalStack ImageId bug
  # ALBTargetGroup:
  #   Type: AWS::ElasticLoadBalancingV2::TargetGroup
  #   Properties:
  #     Name: !Sub ${EnvironmentName}-TG
  #     Port: 80
  #     Protocol: HTTP
  #     VpcId: !Ref VPC
  #     TargetType: instance
  #     Targets:
  #       - Id: !Ref WebServerInstance1
  #         Port: 80
  #       - Id: !Ref WebServerInstance2
  #         Port: 80
  #     HealthCheckEnabled: true
  #     HealthCheckIntervalSeconds: 30
  #     HealthCheckPath: /
  #     HealthCheckProtocol: HTTP
  #     HealthCheckTimeoutSeconds: 5
  #     HealthyThresholdCount: 2
  #     UnhealthyThresholdCount: 3
  #     Matcher:
  #       HttpCode: 200-399
  #     TargetGroupAttributes:
  #       - Key: deregistration_delay.timeout_seconds
  #         Value: '60'
  #       - Key: stickiness.enabled
  #         Value: 'true'
  #       - Key: stickiness.type
  #         Value: lb_cookie
  #       - Key: stickiness.lb_cookie.duration_seconds
  #         Value: '86400'
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-TG
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #       - Key: Environment
  #         Value: !Ref EnvironmentName

  # ALBListener - DISABLED for LocalStack (depends on ALBTargetGroup)
  # ALBListener:
  #   Type: AWS::ElasticLoadBalancingV2::Listener
  #   Properties:
  #     DefaultActions:
  #       - Type: forward
  #         TargetGroupArn: !Ref ALBTargetGroup
  #     LoadBalancerArn: !Ref ApplicationLoadBalancer
  #     Port: 80
  #     Protocol: HTTP

  # ==========================================
  # Launch Template for Auto Scaling
  # ==========================================
  # DISABLED for LocalStack - Launch templates reference ImageId which triggers
  # the LocalStack double-bracket bug
  #
  # WebServerLaunchTemplate:
  #   Type: AWS::EC2::LaunchTemplate
  #   Properties:
  #     LaunchTemplateName: !Sub ${EnvironmentName}-LaunchTemplate
  #     LaunchTemplateData:
  #       ImageId: !FindInMap [AmiConfig, !Ref 'AWS::Region', ImageId]
  #       InstanceType: !Ref InstanceType
  #       IamInstanceProfile:
  #         Arn: !GetAtt EC2InstanceProfile.Arn
  #       SecurityGroupIds:
  #         - !Ref WebServerSecurityGroup
  #       KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
  #       UserData:
  #         Fn::Base64: !Sub |
  #           #!/bin/bash -xe
  #           yum update -y
  #           yum install -y httpd
  #           systemctl start httpd
  #           systemctl enable httpd
  #           echo "<h1>${EnvironmentName} - Auto Scaled Instance</h1>" > /var/www/html/index.html
  #       TagSpecifications:
  #         - ResourceType: instance
  #           Tags:
  #             - Key: Name
  #               Value: !Sub ${EnvironmentName}-ASG-WebServer
  #             - Key: iac-rlhf-amazon
  #               Value: 'true'
  #             - Key: Environment
  #               Value: !Ref EnvironmentName
  #             - Key: ManagedBy
  #               Value: AutoScalingGroup

  # ==========================================
  # Auto Scaling Group (maintains one instance per public subnet)
  # ==========================================
  # DISABLED for LocalStack - ASG depends on Launch Template which has ImageId bug
  #
  # WebServerAutoScalingGroup:
  #   Type: AWS::AutoScaling::AutoScalingGroup
  #   DependsOn:
  #     - WebServerInstance1
  #     - WebServerInstance2
  #   Properties:
  #     AutoScalingGroupName: !Sub ${EnvironmentName}-ASG
  #     LaunchTemplate:
  #       LaunchTemplateId: !Ref WebServerLaunchTemplate
  #       Version: !GetAtt WebServerLaunchTemplate.LatestVersionNumber
  #     MinSize: 2
  #     MaxSize: 4
  #     DesiredCapacity: 2
  #     VPCZoneIdentifier:
  #       - !Ref PublicSubnet1
  #       - !Ref PublicSubnet2
  #     TargetGroupARNs:
  #       - !Ref ALBTargetGroup
  #     HealthCheckType: ELB
  #     HealthCheckGracePeriod: 300
  #     Tags:
  #       - Key: Name
  #         Value: !Sub ${EnvironmentName}-ASG-Instance
  #         PropagateAtLaunch: true
  #       - Key: Environment
  #         Value: !Ref EnvironmentName
  #         PropagateAtLaunch: true
  #       - Key: iac-rlhf-amazon
  #         Value: 'true'
  #         PropagateAtLaunch: true

# ==========================================
# Stack Outputs
# ==========================================
Outputs:
  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub ${EnvironmentName}-ALB-DNS

  LoadBalancerURL:
    Description: Full URL of the Application Load Balancer
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub ${EnvironmentName}-ALB-URL

  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${EnvironmentName}-VPC-ID

  VPCCidr:
    Description: VPC CIDR Block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub ${EnvironmentName}-VPC-CIDR

  PublicSubnet1Id:
    Description: Public Subnet 1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnet1-ID

  PublicSubnet2Id:
    Description: Public Subnet 2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PublicSubnet2-ID

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub ${EnvironmentName}-PrivateSubnet1-ID

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub ${EnvironmentName}-PrivateSubnet2-ID

  # EC2 Instance outputs - DISABLED for LocalStack (EC2 instances commented out)
  # WebServerInstance1Id:
  #   Description: Instance ID of WebServer 1
  #   Value: !Ref WebServerInstance1
  #   Export:
  #     Name: !Sub ${EnvironmentName}-Instance1-ID

  # WebServerInstance2Id:
  #   Description: Instance ID of WebServer 2
  #   Value: !Ref WebServerInstance2
  #   Export:
  #     Name: !Sub ${EnvironmentName}-Instance2-ID

  # ElasticIP1Address:
  #   Description: Elastic IP address for WebServer 1
  #   Value: !Ref ElasticIP1
  #   Export:
  #     Name: !Sub ${EnvironmentName}-EIP1

  # ElasticIP2Address:
  #   Description: Elastic IP address for WebServer 2
  #   Value: !Ref ElasticIP2
  #   Export:
  #     Name: !Sub ${EnvironmentName}-EIP2

  # WebServerInstance1URL:
  #   Description: Direct URL to WebServer 1 via Elastic IP
  #   Value: !Sub 'http://${ElasticIP1}'
  #   Export:
  #     Name: !Sub ${EnvironmentName}-Instance1-URL

  # WebServerInstance2URL:
  #   Description: Direct URL to WebServer 2 via Elastic IP
  #   Value: !Sub 'http://${ElasticIP2}'
  #   Export:
  #     Name: !Sub ${EnvironmentName}-Instance2-URL

  S3BucketName:
    Description: Name of the S3 bucket
    Value: !Ref S3Bucket
    Export:
      Name: !Sub ${EnvironmentName}-S3-Bucket

  S3BucketArn:
    Description: ARN of the S3 bucket
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub ${EnvironmentName}-S3-Bucket-ARN

  WebServerSecurityGroupId:
    Description: Security Group ID for Web Servers
    Value: !Ref WebServerSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-WebServer-SG-ID

  LoadBalancerSecurityGroupId:
    Description: Security Group ID for Load Balancer
    Value: !Ref LoadBalancerSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-LB-SG-ID

  EC2RoleArn:
    Description: ARN of the IAM role for EC2 instances
    Value: !GetAtt EC2InstanceRole.Arn
    Export:
      Name: !Sub ${EnvironmentName}-EC2-Role-ARN

  # ASG and Launch Template outputs - DISABLED for LocalStack (resources commented out)
  # AutoScalingGroupName:
  #   Description: Name of the Auto Scaling Group
  #   Value: !Ref WebServerAutoScalingGroup
  #   Export:
  #     Name: !Sub ${EnvironmentName}-ASG-Name

  # LaunchTemplateId:
  #   Description: ID of the Launch Template
  #   Value: !Ref WebServerLaunchTemplate
  #   Export:
  #     Name: !Sub ${EnvironmentName}-LaunchTemplate-ID

  # TargetGroupArn:
  #   Description: ARN of the ALB Target Group
  #   Value: !Ref ALBTargetGroup
  #   Export:
  #     Name: !Sub ${EnvironmentName}-TG-ARN

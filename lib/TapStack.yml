
AWSTemplateFormatVersion: '2010-09-09'
Description: 'S3 + Lambda Event Trigger Stack with Versioning and Public Read Access'

Resources:
  CorpBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'corp-${AWS::StackName}-assets'
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Environment
          Value: Production
        - Key: Name
          Value: corp-s3-bucket
        - Key: ManagedBy
          Value: CloudFormation

  CorpBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CorpBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub '${CorpBucket.Arn}/*'

  CorpLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaBasicExecution
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt CorpBucket.Arn
                  - !Sub '${CorpBucket.Arn}/*'
      Tags:
        - Key: ManagedBy
          Value: CloudFormation

  CorpLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'corp-s3-event-handler-${AWS::StackName}'
      Runtime: nodejs18.x
      Handler: index.handler
      Role: !GetAtt CorpLambdaExecutionRole.Arn
      Code:
        ZipFile: |
          exports.handler = async (event) => {
            console.log('Received event:', JSON.stringify(event, null, 2));
            try {
              const record = event.Records[0];
              const bucket = record.s3.bucket.name;
              const key = decodeURIComponent(record.s3.object.key.replace(/\+/g, ' '));
              console.log(`Object Key: ${key}, Bucket: ${bucket}`);
              return { statusCode: 200, body: 'Success' };
            } catch (err) {
              console.error('Error processing S3 event', err);
              throw err;
            }
          };
      Environment:
        Variables:
          BUCKET_NAME: !Ref CorpBucket
          ENV: Production
      Tags:
        - Key: ManagedBy
          Value: CloudFormation

  CorpLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/corp-s3-event-handler-${AWS::StackName}'
      RetentionInDays: 14
      Tags:
        - Key: Environment
          Value: Production
        - Key: ManagedBy
          Value: CloudFormation

  CorpLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CorpLambdaFunction
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !GetAtt CorpBucket.Arn

Outputs:
  BucketName:
    Description: Name of the S3 bucket
    Value: !Ref CorpBucket
    Export:
      Name: !Sub '${AWS::StackName}-BucketName'

  BucketArn:
    Description: ARN of the S3 bucket
    Value: !GetAtt CorpBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BucketArn'

  LambdaFunctionName:
    Description: Name of the Lambda function
    Value: !Ref CorpLambdaFunction
    Export:
      Name: !Sub '${AWS::StackName}-LambdaFunctionName'

  LambdaFunctionArn:
    Description: ARN of the Lambda function
    Value: !GetAtt CorpLambdaFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaFunctionArn'

  LambdaExecutionRoleArn:
    Description: ARN of the IAM role for Lambda execution
    Value: !GetAtt CorpLambdaExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaExecutionRoleArn'

  LambdaLogGroupName:
    Description: Name of the CloudWatch Log Group for the Lambda function
    Value: !Ref CorpLambdaLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-LambdaLogGroupName'

  S3NotificationInstructions:
    Description: Manual command to configure S3 to invoke Lambda
    Value: !Sub |
      Run the following CLI command after deployment:
      aws s3api put-bucket-notification-configuration \
        --bucket ${CorpBucket} \
        --notification-configuration '{
          "LambdaFunctionConfigurations": [{
            "LambdaFunctionArn": "${CorpLambdaFunction.Arn}",
            "Events": ["s3:ObjectCreated:*"]
          }]
        }'
AWSTemplateFormatVersion: '2010-09-09'
Description: TapStack for isolated environments (dev/staging/prod) with S3 replication

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, staging, prod]
    Default: dev
    AllowedPattern: '^[a-z][a-z0-9-]{0,10}$'
    Description: Environment name (dev, staging, or prod; lowercase, max 12 chars for bucket name compliance)
  ProjectName:
    Type: String
    Default: TapStack
    AllowedPattern: '^[A-Z][a-zA-Z0-9-]*$'
    Description: Project name (must start with uppercase letter)
  Owner:
    Type: String
    Default: team
    AllowedPattern: '^[a-zA-Z0-9-]*$'
    Description: Owner of the stack
  TeamPrincipalARN:
    Type: String
    Default: ''
    AllowedPattern: '^$|^arn:aws:iam::\d{12}:(user|group|role)/[a-zA-Z0-9+=,.@_-]+$'
    Description: Optional IAM principal ARN for role trust policy
  CreateNatPerAZ:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Create NAT Gateway per Availability Zone

Mappings:
  RegionMap:
    us-east-1:
      DestinationRegion: us-east-2
      DestinationBucket: TapStack-staging-databucket-123456789012
    us-east-2:
      DestinationRegion: us-west-2
      DestinationBucket: TapStack-prod-databucket-123456789012
    us-west-2:
      DestinationRegion: ''
      DestinationBucket: ''

Conditions:
  CreateNatPerAZ: !Equals [!Ref CreateNatPerAZ, 'true']
  SingleNat: !Equals [!Ref CreateNatPerAZ, 'false']
  HasTeamPrincipal: !Not [!Equals [!Ref TeamPrincipalARN, '']]
  IsNotProd: !Not [!Equals [!Ref Environment, prod]]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.0.0/18
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-publicsubneta'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.64.0/18
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-publicsubnetb'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.128.0/18
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-privatesubneta'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.192.0/18
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-privatesubnetb'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-igw'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-publicrt'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  NatGatewayA:
    Type: AWS::EC2::NatGateway
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PublicSubnetA
      AllocationId: !GetAtt EIPA.AllocationId
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-natgatewaya'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  EIPA:
    Type: AWS::EC2::EIP
    Condition: CreateNatPerAZ
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-eipa'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PublicSubnetB
      AllocationId: !GetAtt EIPB.AllocationId
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-natgatewayb'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  EIPB:
    Type: AWS::EC2::EIP
    Condition: CreateNatPerAZ
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-eipb'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-privaterta'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteA:
    Type: AWS::EC2::Route
    Condition: CreateNatPerAZ
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayA

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-privatertb'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  PrivateRouteB:
    Type: AWS::EC2::Route
    Condition: CreateNatPerAZ
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayB

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: CreateNatPerAZ
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  SingleNatGateway:
    Type: AWS::EC2::NatGateway
    Condition: SingleNat
    Properties:
      SubnetId: !Ref PublicSubnetA
      AllocationId: !GetAtt SingleEIP.AllocationId
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-natgateway'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  SingleEIP:
    Type: AWS::EC2::EIP
    Condition: SingleNat
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-eip'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

  SinglePrivateRouteA:
    Type: AWS::EC2::Route
    Condition: SingleNat
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref SingleNatGateway

  SinglePrivateRouteB:
    Type: AWS::EC2::Route
    Condition: SingleNat
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref SingleNatGateway

  SinglePrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: SingleNat
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  SinglePrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: SingleNat
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  DataBucket:
    Type: AWS::S3::Bucket
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W1031 # Bucket name is valid, false positive due to dynamic AWS::AccountId
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-databucket-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-databucket'
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      ReplicationConfiguration:
        !If
        - IsNotProd
        - Role: !Ref ReplicationRole
          Rules:
            - Id: !Sub '${ProjectName}-${Environment}-replication'
              Status: Enabled
              Priority: 1
              DeleteMarkerReplication:
                Status: Disabled
              Destination:
                Bucket: !Join
                  - ''
                  - - 'arn:aws:s3:::'
                    - !FindInMap [RegionMap, !Ref AWS::Region, DestinationBucket]
              Filter:
                Prefix: ''
        - !Ref AWS::NoValue

  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DataBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource: !Sub 'arn:aws:s3:::${DataBucket}/*'
            Condition:
              Bool:
                aws:SecureTransport: false

  ReplicationRole:
    Type: AWS::IAM::Role
    Condition: IsNotProd
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-replication-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub '${ProjectName}-${Environment}-replication-policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject*
                  - s3:GetBucket*
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::TapStack-${Environment}-databucket-${AWS::AccountId}'
                  - !Sub 'arn:aws:s3:::TapStack-${Environment}-databucket-${AWS::AccountId}/*'
              - Effect: Allow
                Action:
                  - s3:ReplicateObject
                  - s3:ReplicateDelete
                  - s3:ReplicateTags
                Resource: !Join
                  - ''
                  - - 'arn:aws:s3:::'
                    - !FindInMap [RegionMap, !Ref AWS::Region, DestinationBucket]
                    - '/*'

  EnvironmentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If [HasTeamPrincipal, !Ref TeamPrincipalARN, !Sub 'arn:aws:iam::${AWS::AccountId}:root']
            Action: sts:AssumeRole
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: CreatedBy
          Value: !Ref Owner

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
  PublicSubnets:
    Description: Public Subnet IDs
    Value: !Join [',', [!Ref PublicSubnetA, !Ref PublicSubnetB]]
  PrivateSubnets:
    Description: Private Subnet IDs
    Value: !Join [',', [!Ref PrivateSubnetA, !Ref PrivateSubnetB]]
  DataBucketName:
    Description: S3 Bucket Name
    Value: !Ref DataBucket
  DataBucketARN:
    Description: S3 Bucket ARN
    Value: !GetAtt DataBucket.Arn
  EnvironmentRoleARN:
    Description: IAM Role ARN
    Value: !GetAtt EnvironmentRole.Arn

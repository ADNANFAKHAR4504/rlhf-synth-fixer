AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  ProjectName:
    Type: String
    Default: TapStack
  Region1:
    Type: String
    Default: us-east-1
  VpcCidr1:
    Type: String
    Default: 10.0.0.0/16
  PublicSubnet1Cidr1:
    Type: String
    Default: 10.0.1.0/24
  PublicSubnet2Cidr1:
    Type: String
    Default: 10.0.2.0/24
  PrivateSubnet1Cidr1:
    Type: String
    Default: 10.0.101.0/24
  PrivateSubnet2Cidr1:
    Type: String
    Default: 10.0.102.0/24
  InstanceType:
    Type: String
    Default: t2.micro
  DBInstanceType:
    Type: String
    Default: db.t2.micro
  DBAllocatedStorage:
    Type: Number
    Default: 20

Mappings:
  RegionMap:
    us-east-1:
      AMI: "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"

Resources:
  # Region 1 VPC
  VpcR1:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-vpc-r1
        - Key: Region
          Value: !Ref Region1

  # Subnets
  PublicSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs us-east-1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet1-r1"

  PublicSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs us-east-1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet2-r1"

  PrivateSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs us-east-1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet1-r1"

  PrivateSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs us-east-1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet2-r1"

  # Internet Gateway
  InternetGatewayR1:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-igw-r1

  # Attach IGW to VPC
  AttachIgwR1:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VpcR1
      InternetGatewayId: !Ref InternetGatewayR1

  # Route Tables
  PublicRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-public-rt-r1

  # Routes
  PublicRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGatewayR1

  # Subnet Route Table Associations
  PublicSubnet1RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1R1
      RouteTableId: !Ref PublicRouteTableR1

  PublicSubnet2RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2R1
      RouteTableId: !Ref PublicRouteTableR1

  # NAT Gateway
  NatGatewayR1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIPR1.AllocationId
      SubnetId: !Ref PublicSubnet1R1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-nat-r1

  # NAT Gateway EIP
  NatEIPR1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # Private Route Table
  PrivateRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-private-rt-r1

  # Private Route
  PrivateRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayR1

  # Private Subnet Route Table Associations
  PrivateSubnet1RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1R1
      RouteTableId: !Ref PrivateRouteTableR1

  PrivateSubnet2RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2R1
      RouteTableId: !Ref PrivateRouteTableR1

  # Security Groups
  ELBSecurityGroupR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ELB Security Group
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  AppSecurityGroupR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App Security Group
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ELBSecurityGroupR1
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  # EC2 Instance
  EC2InstanceR1:
    Type: AWS::EC2::Instance
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W1034
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref Region1, AMI]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PublicSubnet1R1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-ec2-r1

  # RDS DB Instance
  RDSInstanceR1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-db-r1"
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceType
      Engine: mysql
      MasterUsername: '{{resolve:secretsmanager:tapstack-db-credentials:SecretString:username}}'
      MasterUserPassword: '{{resolve:secretsmanager:tapstack-db-credentials:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref AppSecurityGroupR1
      DBSubnetGroupName: !Ref DBSubnetGroupR1
      MultiAZ: false
      PubliclyAccessible: false
      StorageType: gp2

  DBSubnetGroupR1:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS in Region 1
      SubnetIds:
        - !Ref PrivateSubnet1R1
        - !Ref PrivateSubnet2R1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-dbsubnetgroup-r1

Outputs:
  VpcIdR1:
    Value: !Ref VpcR1
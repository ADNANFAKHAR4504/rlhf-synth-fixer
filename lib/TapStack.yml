AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure web infrastructure with high availability and security'

Mappings:
  AWSRegionArch2AMI:
    us-east-1:
      x8664: ami-004021b186a0c56f8
    us-east-2:
      x8664: ami-004021b186a0c56f8
    us-west-1:
      x8664: ami-004021b186a0c56f8
    us-west-2:
      x8664: ami-004021b186a0c56f8
    eu-west-1:
      x8664: ami-004021b186a0c56f8
    eu-central-1:
      x8664: ami-004021b186a0c56f8
    ap-southeast-1:
      x8664: ami-004021b186a0c56f8
    ap-northeast-1:
      x8664: ami-004021b186a0c56f8

Parameters:
  Environment:
    Type: String
    Default: 'prod'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: Deployment environment
  DBUsername:
    Type: String
    Default: 'admin'
    Description: Database master username
    NoEcho: false
  UniqueIdentifier:
    Type: String
    Default: 'pr42'
    Description: Unique identifier to avoid resource naming conflicts

Resources:
  # 1. VPC with 3 AZs
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-vpc'

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-igw'

  # Attach Internet Gateway to VPC
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Route Table for Public Subnets
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-public-routes'

  # Default Route to Internet Gateway
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  # Public Subnets in 3 AZs
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-public-subnet-az1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-public-subnet-az2'

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.3.0/24'
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-public-subnet-az3'

  # Associate Public Subnets with Public Route Table
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet3

  # Private Subnets for RDS (New Addition)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.10.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-private-subnet-az1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.11.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-private-subnet-az2'

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.12.0/24'
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-private-subnet-az3'

  # Route Table for Private Subnets (New Addition)
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-private-routes'

  # Associate Private Subnets with Private Route Table (New Addition)
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet3

  # 13. Security Groups
  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Allow HTTP/HTTPS traffic to web servers'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-web-sg'

  # RDS Security Group (New Addition)
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Allow MySQL traffic from web servers'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt WebSecurityGroup.GroupId # Allow traffic only from web servers
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-db-sg'

  # 2. IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: {Service: [ec2.amazonaws.com]}
            Action: ['sts:AssumeRole']
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-ec2-role'

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # 4. Encrypted S3 Bucket
  WebContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${UniqueIdentifier}-${Environment}-tapstack-web-content-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-web-content-bucket'

  # 11. KMS Key
  EncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'Encryption key for sensitive data'
      EnableKeyRotation: true
      KeyPolicy: # Added Key Policy
        Version: '2012-10-17'
        Id: key-default-policy
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow access for RDS
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-encryption-key'

  # 3. Multi-AZ RDS MySQL
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: 'DB subnet group for private subnets'
      SubnetIds:
        - !Ref PrivateSubnet1 # Use private subnets
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-db-subnet-group'

  # 4. Secrets Manager for Database Password
  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${UniqueIdentifier}-${Environment}/db-password'
      Description: 'Database password for TapStack'
      SecretString: |
        {
          "password": "ChangeThisPassword123!"
        }
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-db-secret'

  # 5. RDS Database
  MySQLDB:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: mysql
      DBInstanceClass: db.t3.medium
      AllocatedStorage: 20
      MultiAZ: true
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:password}}'
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !GetAtt DBSecurityGroup.GroupId # Use the dedicated DB security group
      StorageEncrypted: true
      KmsKeyId: !Ref EncryptionKey
      PubliclyAccessible: false # Ensure it's not publicly accessible
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-mysql-db'

  # 6. Auto Scaling Group
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${UniqueIdentifier}-${Environment}-web-lt' # Add a name
      LaunchTemplateData:
        ImageId: !FindInMap [AWSRegionArch2AMI, !Ref 'AWS::Region', 'x8664']
        InstanceType: 't3.micro'
        SecurityGroupIds:
          - !GetAtt WebSecurityGroup.GroupId
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        UserData: !Base64 | # Example UserData for a simple web server
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>Hello from AWS CloudFormation!</h1>" > /var/www/html/index.html

  # Target Group for Load Balancer (New Addition)
  WebAppTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${UniqueIdentifier}-${Environment}-web-tg'
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-web-target-group'

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      MinSize: 2
      MaxSize: 4
      DesiredCapacity: 2
      VPCZoneIdentifier:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber # Using LatestVersionNumber for simplicity, can also use !Ref LaunchTemplate
      TargetGroupARNs: # Associate ASG with Target Group
        - !Ref WebAppTargetGroup
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-web-asg'
          PropagateAtLaunch: true # Propagate tags to EC2 instances

  # 9. Load Balancer
  AppLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${UniqueIdentifier}-${Environment}-alb'
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !GetAtt WebSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-app-load-balancer'

  # Listener for Load Balancer (New Addition)
  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref AppLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WebAppTargetGroup

  # CloudFront Origin Access Control (New Addition for S3 Security)
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${UniqueIdentifier}-${Environment}-cloudfront-oac'
        OriginAccessControlOriginType: s3
        SigningBehavior: no-override
        SigningProtocol: sigv4

  # 7. CloudFront with S3
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - DomainName: !GetAtt WebContentBucket.RegionalDomainName # Use RegionalDomainName for OAC
            Id: S3Origin
            S3OriginConfig: # Remove S3OriginConfig when using OAC
              OriginAccessIdentity: "" # This will be replaced by OAC
            OriginAccessControlId: !GetAtt CloudFrontOAC.Id # Associate OAC
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ['GET', 'HEAD']
          CachedMethods: ['GET', 'HEAD']
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: 'none'
        WebACLId: !GetAtt WebACL.Arn # Associate WAF with CloudFront

  # S3 Bucket Policy for CloudFront OAC (New Addition)
  WebContentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebContentBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub 'arn:aws:s3:::${WebContentBucket}/*'
            Condition:
              StringEquals:
                'AWS:SourceArn': !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  # 8. WAF
  WebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Sub '${UniqueIdentifier}-${Environment}-web-acl'
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: 'WebACLMetrics'
      Rules: # Example WAF rule (optional, you can customize or add more)
        - Name: 'AWS-ManagedRules-CommonRuleSet'
          Priority: 1
          Statement:
            ManagedRuleGroupStatement:
              VendorName: 'AWS'
              Name: 'AWSManagedRulesCommonRuleSet'
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: 'AWSManagedRulesCommonRuleSetMetrics'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-web-acl'

  # 5. CloudWatch Alarms
  CPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: 'CPU utilization > 80% on Auto Scaling Group'
      MetricName: 'CPUUtilization'
      Namespace: 'AWS/EC2'
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions: [] # No SNS topic for now - can be added later
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-cpu-alarm'

  # 10. Logging Bucket
  LogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${UniqueIdentifier}-${Environment}-tapstack-logs-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'
      Tags:
        - Key: Name
          Value: !Sub '${UniqueIdentifier}-${Environment}-logs-bucket'

Outputs:
  WebsiteURL:
    Description: 'CloudFront Distribution URL'
    Value: !GetAtt CloudFrontDistribution.DomainName
  LoadBalancerDNS:
    Description: 'Load Balancer DNS Name'
    Value: !GetAtt AppLoadBalancer.DNSName
  S3BucketName:
    Description: 'S3 Web Content Bucket Name'
    Value: !Ref WebContentBucket
  RDSInstanceEndpoint:
    Description: 'RDS Database Endpoint Address'
    Value: !GetAtt MySQLDB.Endpoint.Address
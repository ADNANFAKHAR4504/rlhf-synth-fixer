AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Production-ready app environment in AWS (us-east-1). Uses the specified existing VPC,
  discovers an existing subnet automatically, launches an EC2 instance on the latest
  Amazon Linux 2 AMI (via SSM), restricts inbound to SSH/HTTPS only, and provisions an S3
  bucket with server-side encryption. All resources tagged Environment: Production.

Metadata:
  ProvidedData:
    ExistingVpcIdLiteral: "vpc-12345abcde"

Rules:
  MustBeUsEast1:
    Assertions:
      - Assert: !Equals [ !Ref "AWS::Region", "us-east-1" ]
        AssertDescription: "This stack must be deployed in us-east-1."

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Existing VPC ID in us-east-1.
    Default: vpc-002dd1e7eb944d35a

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedPattern: '^[a-z0-9]+\.[a-z0-9]+$'
    Description: EC2 instance type.

  IngressCidrSsh:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: IPv4 CIDR for SSH ingress (port 22).

  IngressCidrHttps:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: ^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)\/(3[0-2]|[12]?\d)$
    Description: IPv4 CIDR for HTTPS ingress (port 443).

  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: SSM public parameter for latest Amazon Linux 2 AMI (us-east-1).

Resources:
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH (22) and HTTPS (443) only
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref IngressCidrSsh
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref IngressCidrHttps
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Environment
          Value: Production

  AppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Environment
          Value: Production

  # ---- Custom resource: discover a subnet in the provided VPC ----
  FindSubnetRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FindSubnetInline
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: ec2:DescribeSubnets
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Environment
          Value: Production

  FindSubnetFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.11
      Handler: index.handler
      Role: !GetAtt FindSubnetRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json, boto3, urllib.request
          def respond(event, context, status, data, physical_id=None):
              body = {
                'Status': status,
                'Reason': f"See CloudWatch Logs: {getattr(context,'log_stream_name','')}",
                'PhysicalResourceId': physical_id or getattr(context,'log_stream_name','FindSubnet'),
                'StackId': event['StackId'],
                'RequestId': event['RequestId'],
                'LogicalResourceId': event['LogicalResourceId'],
                'Data': data
              }
              req = urllib.request.Request(event['ResponseURL'], data=json.dumps(body).encode(), method='PUT')
              req.add_header('content-type','')
              req.add_header('content-length', str(len(json.dumps(body))))
              urllib.request.urlopen(req).read()
          def handler(event, context):
              try:
                  if event['RequestType'] in ('Create','Update'):
                      vpc_id = event['ResourceProperties']['VpcId']
                      ec2 = boto3.client('ec2')
                      subs = ec2.describe_subnets(Filters=[{'Name':'vpc-id','Values':[vpc_id]}]).get('Subnets', [])
                      if not subs:
                          raise Exception(f'No subnets found in VPC {vpc_id}')
                      subs.sort(key=lambda s: (not s.get('DefaultForAz', False), s.get('AvailabilityZoneId','zzz'), s['SubnetId']))
                      subnet_id = subs[0]['SubnetId']
                      respond(event, context, 'SUCCESS', {'SubnetId': subnet_id}, subnet_id)
                  else:
                      respond(event, context, 'SUCCESS', {}, 'deleted')
              except Exception as e:
                  respond(event, context, 'FAILED', {'Error': str(e)}, 'failed')
      Tags:
        - Key: Environment
          Value: Production

  FindSubnet:
    Type: Custom::FindSubnet
    Properties:
      ServiceToken: !GetAtt FindSubnetFunction.Arn
      VpcId: !Ref VpcId

  AppInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref InstanceType
      SubnetId: !GetAtt FindSubnet.SubnetId
      SecurityGroupIds:
        - !Ref AppSecurityGroup
      Tags:
        - Key: Environment
          Value: Production
  # ---- end custom subnet discovery ----

Outputs:
  SecurityGroupId:
    Description: ID of the security group allowing SSH/HTTPS.
    Value: !Ref AppSecurityGroup
  InstanceId:
    Description: ID of the EC2 instance.
    Value: !Ref AppInstance
  InstancePublicIp:
    Description: Public IPv4 of the EC2 instance (if assigned).
    Value: !GetAtt AppInstance.PublicIp
  BucketName:
    Description: Name of the S3 bucket with SSE enabled.
    Value: !Ref AppBucket
  DiscoveredSubnetId:
    Description: Subnet selected by the custom resource within the provided VPC.
    Value: !GetAtt FindSubnet.SubnetId

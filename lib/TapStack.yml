AWSTemplateFormatVersion: '2010-09-09'
Description: 'Secure AWS infrastructure for web application with enterprise security controls, MFA enforcement, IP restrictions, and comprehensive monitoring'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentName
          - VpcCidr
          - AllowedIPRange
      - Label:
          default: 'Security Configuration'
        Parameters:
          - EnableMFA
          - CredentialRotationDays
          - LogRetentionDays
    ParameterLabels:
      EnvironmentName:
        default: 'Environment Name'
      VpcCidr:
        default: 'VPC CIDR Block'
      AllowedIPRange:
        default: 'Allowed IP Range for Access'

Parameters:
  EnvironmentName:
    Type: String
    Default: 'dev'
    Description: 'Environment name for resource tagging and naming'
    AllowedValues: ['dev', 'staging', 'prod']
    ConstraintDescription: 'Must be dev, staging, or prod'

  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'CIDR block for the VPC'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  AllowedIPRange:
    Type: String
    Default: '203.0.113.0/24'
    Description: 'IP range allowed to access resources (CIDR notation)'
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  EnableMFA:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: 'Enable MFA enforcement for IAM policies'

  CredentialRotationDays:
    Type: Number
    Default: 30
    MinValue: 1
    MaxValue: 90
    Description: 'Number of days between credential rotations'

  LogRetentionDays:
    Type: Number
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
    Description: 'CloudWatch log retention period in days'

Conditions:
  IsProdEnvironment: !Equals [!Ref EnvironmentName, 'prod']
  EnableMFACondition: !Equals [!Ref EnableMFA, 'true']

Resources:
  # ===== NETWORKING RESOURCES =====
  
  SecureVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-secure-vpc'
        - Key: Environment
          Value: !Ref EnvironmentName

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureVPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 4, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-subnet'

  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SecureVPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCidr, 4, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-subnet'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref SecureVPC
      InternetGatewayId: !Ref InternetGateway

  # ===== ENCRYPTION & KEY MANAGEMENT =====
  
  ApplicationKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub 'KMS key for encrypting ${EnvironmentName} application data'
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow CloudTrail encryption
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action:
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
              - 'kms:Encrypt'
              - 'kms:ReEncrypt*'
              - 'kms:Decrypt'
            Resource: '*'
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-application-key'
        - Key: Environment
          Value: !Ref EnvironmentName

  ApplicationKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${EnvironmentName}-application-key'
      TargetKeyId: !Ref ApplicationKMSKey

  # ===== S3 STORAGE & POLICIES =====
  
  SecureLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-secure-logs-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref ApplicationKMSKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: LogRetentionRule
            Status: Enabled
            ExpirationInDays: !Ref LogRetentionDays
            NoncurrentVersionExpirationInDays: 7
          - Id: IntelligentTieringRule
            Status: Enabled
            Transitions:
              - StorageClass: INTELLIGENT_TIERING
                TransitionInDays: 30
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: s3:ObjectCreated:*
            CloudWatchConfiguration:
              LogGroupName: !Ref S3AccessLogGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-secure-log-bucket'
        - Key: Environment
          Value: !Ref EnvironmentName

  SecureLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SecureLogBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${SecureLogBucket}/*'
              - !GetAtt SecureLogBucket.Arn
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          - Sid: AllowCloudTrailLogging
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: 's3:PutObject'
            Resource: !Sub '${SecureLogBucket}/cloudtrail-logs/*'
            Condition:
              StringEquals:
                's3:x-amz-acl': 'bucket-owner-full-control'
          - Sid: AllowCloudTrailLocationCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: 's3:GetBucketAcl'
            Resource: !GetAtt SecureLogBucket.Arn
          - Sid: RestrictIPAccess
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub '${SecureLogBucket}/*'
              - !GetAtt SecureLogBucket.Arn
            Condition:
              IpAddressIfExists:
                'aws:SourceIp': !Ref AllowedIPRange
              Bool:
                'aws:ViaAWSService': 'false'

  ApplicationDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${EnvironmentName}-app-data-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref ApplicationKMSKey
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-application-data'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ===== IAM ROLES & POLICIES =====
  
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-EC2-InstanceRole'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: S3AccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt ApplicationDataBucket.Arn
                  - !Sub '${ApplicationDataBucket}/*'
                Condition:
                  IpAddress:
                    'aws:SourceIp': !Ref AllowedIPRange
              - Effect: Allow
                Action:
                  - 'kms:Decrypt'
                  - 'kms:GenerateDataKey'
                Resource: !GetAtt ApplicationKMSKey.Arn
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-ec2-role'
        - Key: Environment
          Value: !Ref EnvironmentName

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${EnvironmentName}-EC2-InstanceProfile'
      Roles:
        - !Ref EC2InstanceRole

  RestrictedApplicationUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub '${EnvironmentName}-RestrictedAppUser'
      Policies:
        - PolicyName: RestrictedS3ListPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:ListBucket'
                  - 's3:GetBucketLocation'
                Resource: !GetAtt ApplicationDataBucket.Arn
                Condition:
                  IpAddress:
                    'aws:SourceIp': !Ref AllowedIPRange
                  Bool:
                    'aws:MultiFactorAuthPresent': !If [EnableMFACondition, 'true', 'false']
              - Effect: Deny
                Action: '*'
                Resource: '*'
                Condition:
                  Bool:
                    'aws:MultiFactorAuthPresent': 'false'
                  IpAddressIfExists:
                    'aws:SourceIp': !Ref AllowedIPRange
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-restricted-user'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ===== CLOUDTRAIL & MONITORING =====
  
  CloudWatchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/cloudtrail/${EnvironmentName}'
      RetentionInDays: !Ref LogRetentionDays
      KmsKeyId: !GetAtt ApplicationKMSKey.Arn

  S3AccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/s3/${EnvironmentName}'
      RetentionInDays: !Ref LogRetentionDays

  CloudTrailRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudTrailLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:PutLogEvents'
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                Resource: !GetAtt CloudWatchLogGroup.Arn

  SecurityCloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn: SecureLogBucketPolicy
    Properties:
      TrailName: !Sub '${EnvironmentName}-security-trail'
      S3BucketName: !Ref SecureLogBucket
      S3KeyPrefix: 'cloudtrail-logs'
      CloudWatchLogsLogGroupArn: !GetAtt CloudWatchLogGroup.Arn
      CloudWatchLogsRoleArn: !GetAtt CloudTrailRole.Arn
      KMSKeyId: !Ref ApplicationKMSKey
      IsLogging: true
      IsMultiRegionTrail: true
      IncludeGlobalServiceEvents: true
      EnableLogFileValidation: true
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
          DataResources:
            - Type: 'AWS::S3::Object'
              Values:
                - !Sub '${SecureLogBucket}/*'
                - !Sub '${ApplicationDataBucket}/*'
            - Type: 'AWS::S3::Bucket'
              Values:
                - !GetAtt SecureLogBucket.Arn
                - !GetAtt ApplicationDataBucket.Arn
      InsightSelectors:
        - InsightType: ApiCallRateInsight
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-cloudtrail'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ===== NETWORK SECURITY =====
  
  WebApplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-webapp-sg'
      GroupDescription: 'Security group for web application with restricted access'
      VpcId: !Ref SecureVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref AllowedIPRange
          Description: 'HTTPS access from allowed IP range'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref AllowedIPRange
          Description: 'HTTP access from allowed IP range (redirect to HTTPS)'
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'HTTPS outbound for API calls'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'HTTP outbound for package downloads'
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'DNS TCP'
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'DNS UDP'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-webapp-sg'
        - Key: Environment
          Value: !Ref EnvironmentName

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-database-sg'
      GroupDescription: 'Security group for database with restricted access'
      VpcId: !Ref SecureVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref WebApplicationSecurityGroup
          Description: 'MySQL access from web application'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-database-sg'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ===== CREDENTIAL ROTATION AUTOMATION =====
  
  CredentialRotationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${EnvironmentName}-CredentialRotationRole'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CredentialRotationPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'iam:UpdateAccessKey'
                  - 'iam:DeleteAccessKey'
                  - 'iam:CreateAccessKey'
                  - 'iam:ListAccessKeys'
                  - 'iam:GetUser'
                Resource: !GetAtt RestrictedApplicationUser.Arn
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetSecretValue'
                  - 'secretsmanager:PutSecretValue'
                  - 'secretsmanager:UpdateSecret'
                Resource: !Ref UserCredentialsSecret
              - Effect: Allow
                Action:
                  - 'sns:Publish'
                Resource: !Ref SecurityAlertsTopic

  CredentialRotationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${EnvironmentName}-credential-rotation'
      Runtime: nodejs18.x
      Handler: index.handler
      Role: !GetAtt CredentialRotationLambdaRole.Arn
      Timeout: 300
      Environment:
        Variables:
          USER_NAME: !Ref RestrictedApplicationUser
          SECRET_ARN: !Ref UserCredentialsSecret
          SNS_TOPIC: !Ref SecurityAlertsTopic
      Code:
        ZipFile: |
          const AWS = require('aws-sdk');
          const iam = new AWS.IAM();
          const secretsManager = new AWS.SecretsManager();
          const sns = new AWS.SNS();
          
          exports.handler = async (event) => {
              console.log('Starting credential rotation for user:', process.env.USER_NAME);
              
              try {
                  // List current access keys
                  const keys = await iam.listAccessKeys({
                      UserName: process.env.USER_NAME
                  }).promise();
                  
                  // Create new access key
                  const newKey = await iam.createAccessKey({
                      UserName: process.env.USER_NAME
                  }).promise();
                  
                  // Update secret with new credentials
                  await secretsManager.putSecretValue({
                      SecretId: process.env.SECRET_ARN,
                      SecretString: JSON.stringify({
                          AccessKeyId: newKey.AccessKey.AccessKeyId,
                          SecretAccessKey: newKey.AccessKey.SecretAccessKey
                      })
                  }).promise();
                  
                  // Delete old access keys (keep only the newest)
                  for (const key of keys.AccessKeyMetadata) {
                      if (key.AccessKeyId !== newKey.AccessKey.AccessKeyId) {
                          await iam.deleteAccessKey({
                              UserName: process.env.USER_NAME,
                              AccessKeyId: key.AccessKeyId
                          }).promise();
                      }
                  }
                  
                  // Send success notification
                  await sns.publish({
                      TopicArn: process.env.SNS_TOPIC,
                      Message: `Credential rotation completed successfully for user: ${process.env.USER_NAME}`,
                      Subject: 'Credential Rotation Success'
                  }).promise();
                  
                  console.log('Credential rotation completed successfully');
                  return { statusCode: 200, body: 'Success' };
                  
              } catch (error) {
                  console.error('Credential rotation failed:', error);
                  
                  // Send failure notification
                  await sns.publish({
                      TopicArn: process.env.SNS_TOPIC,
                      Message: `Credential rotation failed for user: ${process.env.USER_NAME}. Error: ${error.message}`,
                      Subject: 'Credential Rotation Failure'
                  }).promise();
                  
                  throw error;
              }
          };
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-credential-rotation'
        - Key: Environment
          Value: !Ref EnvironmentName

  CredentialRotationSchedule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub '${EnvironmentName}-credential-rotation-schedule'
      Description: !Sub 'Rotate IAM user credentials every ${CredentialRotationDays} days'
      ScheduleExpression: !Sub 'rate(${CredentialRotationDays} days)'
      State: ENABLED
      Targets:
        - Arn: !GetAtt CredentialRotationLambda.Arn
          Id: CredentialRotationTarget

  CredentialRotationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CredentialRotationLambda
      Principal: events.amazonaws.com
      SourceArn: !GetAtt CredentialRotationSchedule.Arn

  # ===== SECRETS MANAGEMENT =====
  
  UserCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${EnvironmentName}/app/user-credentials'
      Description: 'Secure storage for application user credentials'
      KmsKeyId: !Ref ApplicationKMSKey
      SecretString: !Sub |
        {
          "AccessKeyId": "PLACEHOLDER",
          "SecretAccessKey": "PLACEHOLDER"
        }
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-user-credentials'
        - Key: Environment
          Value: !Ref EnvironmentName

  # ===== NOTIFICATIONS & ALERTING =====
  
  SecurityAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${EnvironmentName}-security-alerts'
      DisplayName: 'Security Alerts'
      KmsMasterKeyId: !Ref ApplicationKMSKey
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-security-alerts'
        - Key: Environment
          Value: !Ref EnvironmentName

  SecurityAlertsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref SecurityAlertsTopic
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: sns:Publish
            Resource: !Ref SecurityAlertsTopic
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sns:Publish
            Resource: !Ref SecurityAlertsTopic

  # ===== AWS CONFIG COMPLIANCE =====
  
  ConfigDeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Properties:
      Name: !Sub '${EnvironmentName}-config-delivery-channel'
      S3BucketName: !Ref SecureLogBucket
      S3KeyPrefix: 'aws-config'

  ConfigConfigurationRecorder:
    Type: AWS::Config::ConfigurationRecorder
    Properties:
      Name: !Sub '${EnvironmentName}-config-recorder'
      RoleARN: !GetAtt ConfigRole.Arn
      RecordingGroup:
        AllSupported: true
        IncludeGlobalResourceTypes: true
        ResourceTypes: []

  ConfigRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: config.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/ConfigRole
      Policies:
        - PolicyName: ConfigS3Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetBucketAcl'
                  - 's3:ListBucket'
                Resource: !GetAtt SecureLogBucket.Arn
              - Effect: Allow
                Action: 's3:PutObject'
                Resource: !Sub '${SecureLogBucket}/aws-config/*'
                Condition:
                  StringEquals:
                    's3:x-amz-acl': 'bucket-owner-full-control'

  # Config Rules for Compliance
  S3BucketSSLRequestsOnlyRule:
    Type: AWS::Config::ConfigRule
    DependsOn: ConfigConfigurationRecorder
    Properties:
      ConfigRuleName: !Sub '${EnvironmentName}-s3-bucket-ssl-requests-only'
      Description: 'Checks whether S3 buckets have policies that require requests to use SSL'
      Source:
        Owner: AWS
        SourceIdentifier: S3_BUCKET_SSL_REQUESTS_ONLY

  IAMPasswordPolicyRule:
    Type: AWS::Config::ConfigRule
    DependsOn: ConfigConfigurationRecorder
    Properties:
      ConfigRuleName: !Sub '${EnvironmentName}-iam-password-policy'
      Description: 'Checks whether the account password policy meets requirements'
      Source:
        Owner: AWS
        SourceIdentifier: IAM_PASSWORD_POLICY
      InputParameters: |
        {
          "RequireUppercaseCharacters": "true",
          "RequireLowercaseCharacters": "true",
          "RequireSymbols": "true",
          "RequireNumbers": "true",
          "MinimumPasswordLength": "14"
        }

  # ===== CLOUDWATCH ALARMS =====
  
  UnauthorizedAPICallsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${EnvironmentName}-unauthorized-api-calls'
      AlarmDescription: 'Alarm for unauthorized API calls'
      MetricName: 'UnauthorizedAPICalls'
      Namespace: 'CloudTrailMetrics'
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SecurityAlertsTopic
      TreatMissingData: notBreaching

  ConsoleSignInWithoutMFAAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${EnvironmentName}-console-signin-without-mfa'
      AlarmDescription: 'Alarm for console sign-ins without MFA'
      MetricName: 'ConsoleSignInWithoutMFA'
      Namespace: 'CloudTrailMetrics'
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions:
        - !Ref SecurityAlertsTopic

Outputs:
  VPCId:
    Description: 'ID of the secure VPC'
    Value: !Ref SecureVPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  PublicSubnetId:
    Description: 'ID of the public subnet'
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet-ID'

  PrivateSubnetId:
    Description: 'ID of the private subnet'
    Value: !Ref PrivateSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet-ID'

  KMSKeyId:
    Description: 'ID of the KMS key for encryption'
    Value: !Ref ApplicationKMSKey
    Export:
      Name: !Sub '${AWS::StackName}-KMS-Key-ID'

  KMSKeyAlias:
    Description: 'Alias of the KMS key'
    Value: !Ref ApplicationKMSKeyAlias
    Export:
      Name: !Sub '${AWS::StackName}-KMS-Key-Alias'

  LogBucketName:
    Description: 'Name of the secure log storage bucket'
    Value: !Ref SecureLogBucket
    Export:
      Name: !Sub '${AWS::StackName}-LogBucket-Name'

  ApplicationBucketName:
    Description: 'Name of the application data bucket'
    Value: !Ref ApplicationDataBucket
    Export:
      Name: !Sub '${AWS::StackName}-AppBucket-Name'

  EC2InstanceRoleArn:
    Description: 'ARN of the EC2 instance role'
    Value: !GetAtt EC2InstanceRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2Role-ARN'

  EC2InstanceProfileArn:
    Description: 'ARN of the EC2 instance profile'
    Value: !GetAtt EC2InstanceProfile.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EC2Profile-ARN'

  WebAppSecurityGroupId:
    Description: 'ID of the web application security group'
    Value: !Ref WebApplicationSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-WebAppSG-ID'

  DatabaseSecurityGroupId:
    Description: 'ID of the database security group'
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-DatabaseSG-ID'

  CloudTrailArn:
    Description: 'ARN of the CloudTrail'
    Value: !GetAtt SecurityCloudTrail.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CloudTrail-ARN'

  SecurityAlertsTopicArn:
    Description: 'ARN of the security alerts SNS topic'
    Value: !Ref SecurityAlertsTopic
    Export:
      Name: !Sub '${AWS::StackName}-SecurityAlerts-ARN'

  RestrictedUserArn:
    Description: 'ARN of the restricted IAM user'
    Value: !GetAtt RestrictedApplicationUser.Arn
    Export:
      Name: !Sub '${AWS::StackName}-RestrictedUser-ARN'

  CredentialRotationLambdaArn:
    Description: 'ARN of the credential rotation Lambda function'
    Value: !GetAtt CredentialRotationLambda.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CredentialRotation-ARN'

  UserCredentialsSecretArn:
    Description: 'ARN of the user credentials secret'
    Value: !Ref UserCredentialsSecret
    Export:
      Name: !Sub '${AWS::StackName}-UserSecret-ARN'
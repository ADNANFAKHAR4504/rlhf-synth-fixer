AWSTemplateFormatVersion: '2010-09-09'
Description: Production-ready serverless API stack with HA, security, and observability

Parameters:
  EnvironmentSuffix:
    Type: String
    Description: Environment suffix (e.g., dev, prod)

# Optionally define mappings for environment-specific values
Mappings:
  EnvMap:
    dev:
      Env: dev
      Name: tapstack
      Team: devteam
      DomainName: api-dev.example.com
      Region: us-east-1
    prod:
      Env: prod
      Name: tapstack
      Team: prodteam
      DomainName: api.example.com
      Region: us-east-1

Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub
        - '${Env}-${Name}-lambda-role-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                Resource: !GetAtt DynamoDBTable.Arn

  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub
        - '${Env}-${Name}-lambda-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      Runtime: python3.9
      Handler: index.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      MemorySize: 512
      Timeout: 15
      Environment:
        Variables:
          TABLE_NAME: !Ref DynamoDBTable
      TracingConfig:
        Mode: Active
      Code:
        S3Bucket: !Sub
          - 'my-artifacts-${Region}'
          - Region: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Region]
        S3Key: lambda-code.zip

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub
        - '${Env}-${Name}-table-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH

  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub
        - '${Env}-${Name}-api-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      Description: Serverless API
      EndpointConfiguration:
        Types:
          - REGIONAL

  ApiGatewayDomain:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !FindInMap [EnvMap, !Ref EnvironmentSuffix, DomainName]
      RegionalCertificateArn: arn:aws:acm:us-east-1:123456789012:certificate/abcd1234

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub
        - '/aws/apigateway/${Env}-${Name}-api-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      RetentionInDays: 14

  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub
        - '${Env}-${Name}-lambda-errors-${Team}'
        - Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
          Name: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Name]
          Team: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Team]
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      AlarmActions: []
      Dimensions:
        - Name: FunctionName
          Value: !Ref MyLambdaFunction

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint
    Value: !Sub
      - 'https://${ApiGateway}.execute-api.${Region}.amazonaws.com/${Env}'
      - ApiGateway: !Ref ApiGateway
        Region: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Region]
        Env: !FindInMap [EnvMap, !Ref EnvironmentSuffix, Env]
  CustomDomain:
    Description: Custom domain name
    Value: !FindInMap [EnvMap, !Ref EnvironmentSuffix, DomainName]
  LambdaArn:
    Description: Lambda function ARN
    Value: !GetAtt MyLambdaFunction.Arn
  DynamoDBTable:
    Description: DynamoDB table name
    Value: !Ref DynamoDBTable
  LogGroupName:
    Description: CloudWatch log group
    Value: !Ref LogGroup
  AlarmArn:
    Description: CloudWatch alarm ARN
    Value: !Ref LambdaErrorAlarm

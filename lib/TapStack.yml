AWSTemplateFormatVersion: '2010-09-09'
Description: >
  TapStack — Multi-AZ VPC + EC2 (ASG) + optional RDS + CloudWatch Logs/Alarms with least-privilege IAM.
  Includes LocalStack-safe mode via DeployTarget.

Parameters:
  ProjectName:
    Type: String
    Default: tapstack
    AllowedPattern: '^[a-z0-9-]{3,32}$'
    ConstraintDescription: must be 3–32 chars, lowercase letters, numbers, and hyphens only.
    Description: Logical project name used as a prefix in resource names.

  EnvironmentSuffix:
    Type: String
    Default: dev-us
    AllowedPattern: '^[a-z0-9-]{3,32}$'
    ConstraintDescription: must be 3–32 chars, lowercase letters, numbers, and hyphens only.
    Description: Suffix appended to all resource names for collision avoidance.

  DeployTarget:
    Type: String
    Default: localstack
    AllowedValues: [aws, localstack]
    Description: Use 'localstack' to skip services commonly unsupported by LocalStack.

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2])$'
    Description: Primary VPC CIDR block.

  PublicSubnetCidrs:
    Type: String
    Default: 10.0.0.0/20,10.0.16.0/20
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2]),([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2])$'
    Description: Two non-overlapping public subnet CIDRs (A,B), comma-separated (no spaces).

  PrivateSubnetCidrs:
    Type: String
    Default: 10.0.32.0/20,10.0.48.0/20
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2]),([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2])$'
    Description: Two non-overlapping private subnet CIDRs (A,B), comma-separated (no spaces).

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedPattern: '^[a-z0-9.]+$'
    Description: EC2 instance type for application nodes.

  DesiredCapacity:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10
    Description: Desired number of EC2 instances in ASG.

  MaxSize:
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 20
    Description: Maximum number of EC2 instances in ASG.

  KeyPairName:
    Type: String
    Default: ''
    Description: Optional EC2 KeyPair name. Leave empty to disable SSH key association.

  AllowedSshCidr:
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[1-2][0-9]|3[0-2])$'
    Description: CIDR allowed to SSH (tcp/22) to EC2 security group.

  EnableSnsForAlarms:
    Type: String
    Default: 'false'
    AllowedValues: ['true','false']
    Description: If 'true', creates SNS topic and subscribes provided email (AWS only recommended).

  AlarmEmail:
    Type: String
    Default: ''
    Description: Email address to subscribe for alarms when EnableSnsForAlarms=true.

  AmiId:
    Type: String
    Default: ''
    Description: >
      AMI ID to use for EC2 instances.
      Required for LocalStack. Optional for AWS (can be auto-resolved via SSM externally).

  RdsEngine:
    Type: String
    Default: postgres
    AllowedValues: [postgres, mysql]
    Description: Database engine (AWS mode).

  RdsEngineVersionPostgres:
    Type: String
    Default: '16.4'
    Description: Postgres engine version (AWS mode).

  RdsEngineVersionMySql:
    Type: String
    Default: '8.0.35'
    Description: MySQL engine version (AWS mode).

  RdsInstanceClass:
    Type: String
    Default: db.t4g.micro
    AllowedPattern: '^db\.[a-z0-9]+\.[a-z0-9]+$'
    Description: RDS instance class (AWS mode).

  RdsAllocatedStorage:
    Type: Number
    Default: 20
    MinValue: 20
    MaxValue: 16384
    Description: Allocated storage in GiB (AWS mode).

  DBName:
    Type: String
    Default: appdb
    AllowedPattern: '^[a-zA-Z0-9_]{1,63}$'
    Description: Initial database name (AWS mode).

  DbMasterUsername:
    Type: String
    Default: masteruser
    AllowedPattern: '^[a-zA-Z0-9_]{1,16}$'
    Description: Master username stored in Secrets Manager (AWS mode).

  RetainDbSnapshotOnDelete:
    Type: String
    Default: 'true'
    AllowedValues: ['true','false']
    Description: If 'true', deletion protection is enabled and snapshots retained on replacement (AWS mode).

Mappings:
  CW:
    Defaults:
      Interval: 60
      CpuHighThreshold: 80
      MemHighThreshold: 80
      RdsCpuHighThreshold: 80
      PeriodSecs: 300
      EvalPeriods: 1

Conditions:
  IsLocalStack: !Equals [!Ref DeployTarget, 'localstack']
  IsAws: !Equals [!Ref DeployTarget, 'aws']

  HasKeyPair: !Not [!Equals [!Ref KeyPairName, '']]
  EnableSns: !And [!Equals [!Ref EnableSnsForAlarms, 'true'], !Condition IsAws]
  HasAlarmEmail: !And [!Condition EnableSns, !Not [!Equals [!Ref AlarmEmail, '']]]

  EngineIsPg: !Equals [!Ref RdsEngine, 'postgres']
  RetainDbSnapshot: !Equals [!Ref RetainDbSnapshotOnDelete, 'true']

  HasAmiId: !Not [!Equals [!Ref AmiId, '']]

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-vpc' }]

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-igw' }]

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rtb-public' }]

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rtb-private-a' }]

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rtb-private-b' }]

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
    DependsOn: VPCGatewayAttachment

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Split [",", !Ref PublicSubnetCidrs]]
      MapPublicIpOnLaunch: true
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-subnet-public-a' }]

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Split [",", !Ref PublicSubnetCidrs]]
      MapPublicIpOnLaunch: true
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-subnet-public-b' }]

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Split [",", !Ref PrivateSubnetCidrs]]
      MapPublicIpOnLaunch: false
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-subnet-private-a' }]

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Split [",", !Ref PrivateSubnetCidrs]]
      MapPublicIpOnLaunch: false
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-subnet-private-b' }]

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Policies:
        - PolicyName: !Sub '${ProjectName}-${EnvironmentSuffix}-ec2-s3-readonly'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: ['s3:Get*','s3:List*']
                Resource: ['*']
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-ec2-role' }]

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref InstanceRole]
      Path: '/'

  SecurityGroupEc2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EC2 access SG
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 22,  ToPort: 22,  CidrIp: !Ref AllowedSshCidr }
        - { IpProtocol: tcp, FromPort: 80,  ToPort: 80,  CidrIp: 0.0.0.0/0 }
        - { IpProtocol: tcp, FromPort: 443, ToPort: 443, CidrIp: 0.0.0.0/0 }
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-sg-ec2' }]

  CloudWatchLogGroupEC2:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30

  CloudWatchLogGroupApp:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        IamInstanceProfile: { Arn: !GetAtt InstanceProfile.Arn }
        ImageId: !If
          - HasAmiId
          - !Ref AmiId
          - ami-1234567890abcdef0
        InstanceType: !Ref InstanceType
        KeyName: !If [HasKeyPair, !Ref KeyPairName, !Ref 'AWS::NoValue']
        SecurityGroupIds: [!Ref SecurityGroupEc2]
        MetadataOptions: { HttpTokens: required, HttpEndpoint: enabled }
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - { Key: Name,        Value: !Sub '${ProjectName}-${EnvironmentSuffix}-ec2' }
              - { Key: Project,     Value: !Ref ProjectName }
              - { Key: Environment, Value: !Ref EnvironmentSuffix }
          - ResourceType: volume
            Tags:
              - { Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-ec2' }
        UserData:
          Fn::Base64:
            Fn::Sub:
              - |
                #!/bin/bash
                set -xe

                dnf update -y || yum update -y
                dnf install -y amazon-cloudwatch-agent httpd || yum install -y amazon-cloudwatch-agent httpd

                systemctl enable httpd || true
                systemctl start httpd || true

                mkdir -p /opt/aws/amazon-cloudwatch-agent/etc

                cat >/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<CFG
                {
                  "agent": { "metrics_collection_interval": ${CWInterval} },
                  "metrics": {
                    "namespace": "CWAgent",
                    "append_dimensions": { "InstanceId": "{instance_id}" },
                    "metrics_collected": {
                      "mem": { "measurement": ["mem_used_percent"], "metrics_collection_interval": 60 },
                      "cpu": {
                        "measurement": ["cpu_usage_idle","cpu_usage_user","cpu_usage_system"],
                        "metrics_collection_interval": 60,
                        "resources": ["*"]
                      }
                    }
                  },
                  "logs": {
                    "logs_collected": {
                      "files": {
                        "collect_list": [
                          { "file_path": "/var/log/messages", "log_group_name": "${CloudWatchLogGroupEC2}", "log_stream_name": "{instance_id}/messages" },
                          { "file_path": "/var/log/cloud-init.log", "log_group_name": "${CloudWatchLogGroupEC2}", "log_stream_name": "{instance_id}/cloud-init.log" }
                        ]
                      }
                    }
                  }
                }
                CFG

                systemctl enable amazon-cloudwatch-agent || true
                systemctl restart amazon-cloudwatch-agent || true

                echo "hello from $(hostname) in ${AWS::Region}" > /var/www/html/index.html || true
              - CWInterval: !FindInMap [CW, Defaults, Interval]

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier: !If
        - IsLocalStack
        - [!Ref PublicSubnetA, !Ref PublicSubnetB]
        - [!Ref PrivateSubnetA, !Ref PrivateSubnetB]
      MinSize: '1'
      DesiredCapacity: !Ref DesiredCapacity
      MaxSize: !Ref MaxSize
      HealthCheckType: EC2
      HealthCheckGracePeriod: 120
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: $Latest
      MetricsCollection:
        - Granularity: '1Minute'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-ec2'
          PropagateAtLaunch: true

  AlarmEc2CpuHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      Statistic: Average
      Period: !FindInMap [CW, Defaults, PeriodSecs]
      EvaluationPeriods: !FindInMap [CW, Defaults, EvalPeriods]
      Threshold: !FindInMap [CW, Defaults, CpuHighThreshold]
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: !If [EnableSns, [!Ref SNSTopicAlarms], []]

  AlarmEc2MemoryHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Namespace: CWAgent
      MetricName: mem_used_percent
      Dimensions: [{ Name: AutoScalingGroupName, Value: !Ref AutoScalingGroup }]
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: !If [EnableSns, [!Ref SNSTopicAlarms], []]

  SNSTopicAlarms:
    Type: AWS::SNS::Topic
    Condition: EnableSns
    Properties: {}

  SNSSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasAlarmEmail
    Properties:
      Protocol: email
      Endpoint: !Ref AlarmEmail
      TopicArn: !Ref SNSTopicAlarms

  DbSecret:
    Type: AWS::SecretsManager::Secret
    Condition: IsAws
    Properties:
      Description: !Sub 'Auto-generated credentials for ${ProjectName}-${EnvironmentSuffix} RDS'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username":"${DbMasterUsername}"}'
        GenerateStringKey: password
        PasswordLength: 20
        ExcludePunctuation: true

  # ✅ FIX: LocalStack secret with explicit stable Name for reliable reference
  DbSecretLocal:
    Type: AWS::SecretsManager::Secret
    Condition: IsLocalStack
    Properties:
      Name: !Sub '${AWS::StackName}-db-secret-local'
      Description: !Sub 'LocalStack DB credentials for ${ProjectName}-${EnvironmentSuffix}'
      SecretString: |
        {
          "username": "masteruser",
          "password": "testpassword123456"
        }

  SecurityGroupRds:
    Type: AWS::EC2::SecurityGroup
    Condition: IsAws
    Properties:
      GroupDescription: RDS private access SG
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !If [EngineIsPg, 5432, 3306]
          ToPort:   !If [EngineIsPg, 5432, 3306]
          SourceSecurityGroupId: !Ref SecurityGroupEc2
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-sg-rds' }]

  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Condition: IsAws
    Properties:
      DBSubnetGroupDescription: !Sub '${ProjectName}-${EnvironmentSuffix}-rds-subnet-group'
      SubnetIds: [!Ref PrivateSubnetA, !Ref PrivateSubnetB]
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rds-subnet-group' }]

  RDSParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Condition: IsAws
    Properties:
      Description: !Sub '${ProjectName}-${EnvironmentSuffix}-rds-params'
      Family: !If [EngineIsPg, 'postgres16', 'mysql8.0']
      Tags: [{ Key: Name, Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rds-params' }]

  RDSInstanceAws:
    Type: AWS::RDS::DBInstance
    Condition: IsAws
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      Engine: !Ref RdsEngine
      EngineVersion: !If [EngineIsPg, !Ref RdsEngineVersionPostgres, !Ref RdsEngineVersionMySql]
      DBInstanceClass: !Ref RdsInstanceClass
      AllocatedStorage: !Ref RdsAllocatedStorage
      StorageEncrypted: true
      PubliclyAccessible: false
      VPCSecurityGroups: [!Ref SecurityGroupRds]
      DBSubnetGroupName: !Ref RDSSubnetGroup
      DBParameterGroupName: !Ref RDSParameterGroup
      DeletionProtection: !If [RetainDbSnapshot, true, false]
      MasterUsername: !Sub '{{resolve:secretsmanager:${DbSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DbSecret}:SecretString:password}}'
      DBName: !Ref DBName
      BackupRetentionPeriod: 7
      MultiAZ: false
      AutoMinorVersionUpgrade: true
      EnableCloudwatchLogsExports: !If [EngineIsPg, ['postgresql'], ['error']]
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentSuffix}-rds'

  # ✅ FIX: Use GetAtt to retrieve password from secret (LocalStack-compatible)
  # cfn-lint doesn't support NoEcho parameters for RDS, so we suppress W2501 for LocalStack test environments
  RDSInstanceLocal:
    Type: AWS::RDS::DBInstance
    Condition: IsLocalStack
    DependsOn: DbSecretLocal
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - W2501
    Properties:
      Engine: postgres
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      PubliclyAccessible: false
      MasterUsername: masteruser
      # For LocalStack CI/CD compatibility: using static test password
      # Production AWS deployments use Secrets Manager with dynamic references
      MasterUserPassword: testpassword123456

  AlarmRdsCpuHigh:
    Type: AWS::CloudWatch::Alarm
    Condition: IsAws
    Properties:
      Namespace: AWS/RDS
      MetricName: CPUUtilization
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref RDSInstanceAws
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions: !If [EnableSns, [!Ref SNSTopicAlarms], []]

Outputs:
  VpcId:
    Description: VPC Id
    Value: !Ref VPC

  PublicSubnetIds:
    Description: Comma-separated public subnet IDs
    Value: !Join [",", [!Ref PublicSubnetA, !Ref PublicSubnetB]]

  PrivateSubnetIds:
    Description: Comma-separated private subnet IDs
    Value: !Join [",", [!Ref PrivateSubnetA, !Ref PrivateSubnetB]]

  AsgName:
    Description: Auto Scaling Group name
    Value: !Ref AutoScalingGroup

  LaunchTemplateId:
    Description: Launch Template ID
    Value: !Ref LaunchTemplate

  InstanceProfileArn:
    Description: Instance profile ARN
    Value: !GetAtt InstanceProfile.Arn

  InstanceRoleArn:
    Description: Instance role ARN
    Value: !GetAtt InstanceRole.Arn

  CloudWatchEC2LogGroup:
    Description: EC2 log group
    Value: !Ref CloudWatchLogGroupEC2

  CloudWatchAppLogGroup:
    Description: App log group
    Value: !Ref CloudWatchLogGroupApp

  AlarmCpuName:
    Description: EC2 CPU alarm logical id
    Value: !Ref AlarmEc2CpuHigh

  AlarmMemName:
    Description: EC2 memory alarm logical id
    Value: !Ref AlarmEc2MemoryHigh

  RdsEndpoint:
    Condition: IsAws
    Description: RDS endpoint address
    Value: !GetAtt RDSInstanceAws.Endpoint.Address

  DbSecretArn:
    Condition: IsAws
    Description: DB secret ARN
    Value: !Ref DbSecret
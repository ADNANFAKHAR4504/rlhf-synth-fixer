AWSTemplateFormatVersion: '2010-09-09'
Description: Highly available, multi-region, scalable, and secure application infrastructure.

Parameters:
  ProjectName:
    Type: String
    Default: TapStack
  Region1:
    Type: String
    Default: us-east-1
  Region2:
    Type: String
    Default: us-west-2
  VpcCidr1:
    Type: String
    Default: 10.0.0.0/16
  VpcCidr2:
    Type: String
    Default: 10.1.0.0/16
  PublicSubnet1Cidr1:
    Type: String
    Default: 10.0.1.0/24
  PrivateSubnet1Cidr1:
    Type: String
    Default: 10.0.101.0/24
  PublicSubnet2Cidr1:
    Type: String
    Default: 10.0.2.0/24
  PrivateSubnet2Cidr1:
    Type: String
    Default: 10.0.102.0/24
  PublicSubnet1Cidr2:
    Type: String
    Default: 10.1.1.0/24
  PrivateSubnet1Cidr2:
    Type: String
    Default: 10.1.101.0/24
  PublicSubnet2Cidr2:
    Type: String
    Default: 10.1.2.0/24
  PrivateSubnet2Cidr2:
    Type: String
    Default: 10.1.102.0/24
  InstanceType:
    Type: String
    Default: t3.micro
  DBInstanceType:
    Type: String
    Default: db.t3.micro
  DBAllocatedStorage:
    Type: Number
    Default: 20
  DBUsername:
    Type: String
    NoEcho: true
  DBPassword:
    Type: String
    NoEcho: true

Mappings:
  RegionMap:
    us-east-1:
      AMI: "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
    us-west-2:
      AMI: "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"

Resources:
  # VPCs
  VpcR1:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr1
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-vpc-r1"
  VpcR2:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr2
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-vpc-r2"

  # Subnets Region 1
  PublicSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs !Ref Region1]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet1-r1"
  PublicSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PublicSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs !Ref Region1]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet2-r1"
  PrivateSubnet1R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet1Cidr1
      AvailabilityZone: !Select [0, !GetAZs !Ref Region1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet1-r1"
  PrivateSubnet2R1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR1
      CidrBlock: !Ref PrivateSubnet2Cidr1
      AvailabilityZone: !Select [1, !GetAZs !Ref Region1]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet2-r1"

  # Subnets Region 2
  PublicSubnet1R2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR2
      CidrBlock: !Ref PublicSubnet1Cidr2
      AvailabilityZone: !Select [0, !GetAZs !Ref Region2]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet1-r2"
  PublicSubnet2R2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR2
      CidrBlock: !Ref PublicSubnet2Cidr2
      AvailabilityZone: !Select [1, !GetAZs !Ref Region2]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-subnet2-r2"
  PrivateSubnet1R2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR2
      CidrBlock: !Ref PrivateSubnet1Cidr2
      AvailabilityZone: !Select [0, !GetAZs !Ref Region2]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet1-r2"
  PrivateSubnet2R2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VpcR2
      CidrBlock: !Ref PrivateSubnet2Cidr2
      AvailabilityZone: !Select [1, !GetAZs !Ref Region2]
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-subnet2-r2"

  # IGWs
  InternetGatewayR1:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-igw-r1"
  InternetGatewayR2:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-igw-r2"

  AttachIgwR1:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VpcR1
      InternetGatewayId: !Ref InternetGatewayR1
  AttachIgwR2:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VpcR2
      InternetGatewayId: !Ref InternetGatewayR2

  # EIPs for NAT
  NatEIPR1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NatEIPR2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # NAT Gateways
  NatGatewayR1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIPR1.AllocationId
      SubnetId: !Ref PublicSubnet1R1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-natgw-r1"
  NatGatewayR2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIPR2.AllocationId
      SubnetId: !Ref PublicSubnet1R2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-natgw-r2"

  # Route Tables and Routes Region 1
  PublicRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-rt-r1"
  PrivateRouteTableR1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-rt-r1"
  PublicRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGatewayR1
  PrivateRouteR1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableR1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayR1

  # Route Table Associations Region 1
  PublicSubnet1RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1R1
      RouteTableId: !Ref PublicRouteTableR1
  PublicSubnet2RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2R1
      RouteTableId: !Ref PublicRouteTableR1
  PrivateSubnet1RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1R1
      RouteTableId: !Ref PrivateRouteTableR1
  PrivateSubnet2RouteTableAssociationR1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2R1
      RouteTableId: !Ref PrivateRouteTableR1

  # Route Tables and Routes Region 2
  PublicRouteTableR2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-public-rt-r2"
  PrivateRouteTableR2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcR2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-private-rt-r2"
  PublicRouteR2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTableR2
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGatewayR2
  PrivateRouteR2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableR2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayR2

  # Route Table Associations Region 2
  PublicSubnet1RouteTableAssociationR2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1R2
      RouteTableId: !Ref PublicRouteTableR2
  PublicSubnet2RouteTableAssociationR2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2R2
      RouteTableId: !Ref PublicRouteTableR2
  PrivateSubnet1RouteTableAssociationR2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1R2
      RouteTableId: !Ref PrivateRouteTableR2
  PrivateSubnet2RouteTableAssociationR2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2R2
      RouteTableId: !Ref PrivateRouteTableR2

  # Security Groups (per region)
  ELBSecurityGroupR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ELB Security Group R1
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
  AppSecurityGroupR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App Security Group R1
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ELBSecurityGroupR1
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  DBSecurityGroupR1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DB Security Group R1
      VpcId: !Ref VpcR1
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroupR1

  ELBSecurityGroupR2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ELB Security Group R2
      VpcId: !Ref VpcR2
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
  AppSecurityGroupR2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App Security Group R2
      VpcId: !Ref VpcR2
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ELBSecurityGroupR2
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  DBSecurityGroupR2:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: DB Security Group R2
      VpcId: !Ref VpcR2
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref AppSecurityGroupR2

  # ALB (Application Load Balancer) and Target Groups (per region)
  ALBR1:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${ProjectName}-alb-r1"
      Subnets:
        - !Ref PublicSubnet1R1
        - !Ref PublicSubnet2R1
      SecurityGroups:
        - !Ref ELBSecurityGroupR1
      Scheme: internet-facing
      Type: application
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-alb-r1"
  ALBTargetGroupR1:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${ProjectName}-tg-r1"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VpcR1
      TargetType: instance
      HealthCheckPath: /
      Matcher:
        HttpCode: 200
      Targets:
        - Id: !Ref EC2Instance1R1
          Port: 80
        - Id: !Ref EC2Instance2R1
          Port: 80
  ALBListenerR1:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALBR1
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroupR1

  ALBR2:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${ProjectName}-alb-r2"
      Subnets:
        - !Ref PublicSubnet1R2
        - !Ref PublicSubnet2R2
      SecurityGroups:
        - !Ref ELBSecurityGroupR2
      Scheme: internet-facing
      Type: application
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-alb-r2"
  ALBTargetGroupR2:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${ProjectName}-tg-r2"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VpcR2
      TargetType: instance
      HealthCheckPath: /
      Matcher:
        HttpCode: 200
      Targets:
        - Id: !Ref EC2Instance1R2
          Port: 80
        - Id: !Ref EC2Instance2R2
          Port: 80
  ALBListenerR2:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALBR2
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroupR2

  # IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: ["sts:AssumeRole"]
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-ec2-role"
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref EC2Role]
      Path: /

  # EC2 Instances (2 per region, in private subnets)
  EC2Instance1R1:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref Region1, AMI]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet1R1
      SecurityGroupIds:
        - !Ref AppSecurityGroupR1
      IamInstanceProfile: !Ref EC2InstanceProfile
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-ec2-1-r1"
      UserData: !Base64 |
        #!/bin/bash
        yum update -y
        yum install -y httpd
        systemctl enable httpd
        systemctl start httpd
        echo "Hello from Region 1, Instance 1" > /var/www/html/index.html
  EC2Instance2R1:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref Region1, AMI]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet2R1
      SecurityGroupIds:
        - !Ref AppSecurityGroupR1
      IamInstanceProfile: !Ref EC2InstanceProfile
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-ec2-2-r1"
      UserData: !Base64 |
        #!/bin/bash
        yum update -y
        yum install -y httpd
        systemctl enable httpd
        systemctl start httpd
        echo "Hello from Region 1, Instance 2" > /var/www/html/index.html

  EC2Instance1R2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref Region2, AMI]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet1R2
      SecurityGroupIds:
        - !Ref AppSecurityGroupR2
      IamInstanceProfile: !Ref EC2InstanceProfile
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-ec2-1-r2"
      UserData: !Base64 |
        #!/bin/bash
        yum update -y
        yum install -y httpd
        systemctl enable httpd
        systemctl start httpd
        echo "Hello from Region 2, Instance 1" > /var/www/html/index.html
  EC2Instance2R2:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref Region2, AMI]
      InstanceType: !Ref InstanceType
      SubnetId: !Ref PrivateSubnet2R2
      SecurityGroupIds:
        - !Ref AppSecurityGroupR2
      IamInstanceProfile: !Ref EC2InstanceProfile
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-ec2-2-r2"
      UserData: !Base64 |
        #!/bin/bash
        yum update -y
        yum install -y httpd
        systemctl enable httpd
        systemctl start httpd
        echo "Hello from Region 2, Instance 2" > /var/www/html/index.html

  # Register EC2s with ALB Target Groups
  ALBTargetAttachment1R1:
    Type: AWS::ElasticLoadBalancingV2::TargetGroupAttachment
    Properties:
      TargetGroupArn: !Ref ALBTargetGroupR1
      TargetId: !Ref EC2Instance1R1
      Port: 80
  ALBTargetAttachment2R1:
    Type: AWS::ElasticLoadBalancingV2::TargetGroupAttachment
    Properties:
      TargetGroupArn: !Ref ALBTargetGroupR1
      TargetId: !Ref EC2Instance2R1
      Port: 80
  ALBTargetAttachment1R2:
    Type: AWS::ElasticLoadBalancingV2::TargetGroupAttachment
    Properties:
      TargetGroupArn: !Ref ALBTargetGroupR2
      TargetId: !Ref EC2Instance1R2
      Port: 80
  ALBTargetAttachment2R2:
    Type: AWS::ElasticLoadBalancingV2::TargetGroupAttachment
    Properties:
      TargetGroupArn: !Ref ALBTargetGroupR2
      TargetId: !Ref EC2Instance2R2
      Port: 80

  # RDS Subnet Groups
  DBSubnetGroupR1:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS in Region 1
      SubnetIds:
        - !Ref PrivateSubnet1R1
        - !Ref PrivateSubnet2R1
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-dbsubnetgroup-r1"
  DBSubnetGroupR2:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS in Region 2
      SubnetIds:
        - !Ref PrivateSubnet1R2
        - !Ref PrivateSubnet2R2
      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-dbsubnetgroup-r2"

  # RDS Instances (Multi-AZ)
  RDSInstanceR1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-db-r1"
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceType
      Engine: mysql
      MasterUsername: '{{resolve:secretsmanager:mydbsecret:SecretString:username}}'
      MasterUserPassword: '{{resolve:secretsmanager:mydbsecret:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref DBSecurityGroupR1
      DBSubnetGroupName: !Ref DBSubnetGroupR1
      MultiAZ: true
      PubliclyAccessible: false
      StorageType: gp2
  RDSInstanceR2:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${ProjectName}-db-r2"
      AllocatedStorage: !Ref DBAllocatedStorage
      DBInstanceClass: !Ref DBInstanceType
      Engine: mysql
      MasterUsername: '{{resolve:secretsmanager:mydbsecret:SecretString:username}}'
      MasterUserPassword: '{{resolve:secretsmanager:mydbsecret:SecretString:password}}'
      VPCSecurityGroups:
        - !Ref DBSecurityGroupR2
      DBSubnetGroupName: !Ref DBSubnetGroupR2
      MultiAZ: true
      PubliclyAccessible: false
      StorageType: gp2

Outputs:
  VpcIdR1:
    Description: VPC ID for Region 1
    Value: !Ref VpcR1
  VpcIdR2:
    Description: VPC ID for Region 2
    Value: !Ref VpcR2
  ALBDNSR1:
    Description: DNS name of the Application Load Balancer in Region 1
    Value: !GetAtt ALBR1.DNSName
  ALBDNSR2:
    Description: DNS name of the Application Load Balancer in Region 2
    Value: !GetAtt ALBR2.DNSName
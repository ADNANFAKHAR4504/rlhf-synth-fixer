AWSTemplateFormatVersion: '2010-09-09'
Description: 'High-Availability Multi-AZ Network Infrastructure with Public/Private Subnets, NAT Gateways, and Security Groups'

Parameters:
  EnvironmentSuffix:
    Type: String
    Default: 'dev'
    Description: 'Environment suffix for resource naming to ensure uniqueness across deployments'
    AllowedPattern: '^[a-zA-Z0-9]+$'
    ConstraintDescription: 'Must contain only alphanumeric characters'
    MinLength: 1
    MaxLength: 10
  SSHAllowedCIDR:
    Type: String
    Default: '10.0.0.0/16'
    Description: 'CIDR block allowed for SSH access to private subnets (restricted to private ranges)'
    AllowedPattern: '^(10\.(0|[1-9][0-9]?)\.(0|[1-9][0-9]?)\.(0|[1-9][0-9]?)\/([1-2][0-9]|3[0-2])|172\.(1[6-9]|2[0-9]|3[0-1])\.(0|[1-9][0-9]?)\.(0|[1-9][0-9]?)\/([1-2][0-9]|3[0-2])|192\.168\.(0|[1-9][0-9]?)\.(0|[1-9][0-9]?)\/([1-2][0-9]|3[0-2]))$'
    ConstraintDescription: 'Must be a valid RFC1918 private CIDR range (10.x.x.x/16-32, 172.16-31.x.x/16-32, or 192.168.x.x/16-32)'
  EnableNATGateway:
    Type: String
    Default: 'false'
    Description: 'Enable NAT Gateways for private subnet internet access (set to false for LocalStack compatibility)'
    AllowedValues:
      - 'true'
      - 'false'

Conditions:
  CreateNATGateway: !Equals [!Ref EnableNATGateway, 'true']

Resources:
  # VPC - Main Network
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-VPC-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-IGW-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Attach Internet Gateway to VPC
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnet in AZ 1 (dynamic AZ selection)
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.1.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PubSub1-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: Type
          Value: 'Public'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Public Subnet in AZ 2 (dynamic AZ selection)
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.2.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PubSub2-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: Type
          Value: 'Public'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Private Subnet in AZ 1 (dynamic AZ selection)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.11.0/24'
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PrivSub1-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: Type
          Value: 'Private'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Private Subnet in AZ 2 (dynamic AZ selection)
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.12.0/24'
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PrivSub2-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: Type
          Value: 'Private'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Elastic IP for NAT Gateway 1
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    Condition: CreateNATGateway
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-NAT1-EIP-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Elastic IP for NAT Gateway 2
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    Condition: CreateNATGateway
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-NAT2-EIP-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # NAT Gateway in Public Subnet 1
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Condition: CreateNATGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-NAT1-GW-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # NAT Gateway in Public Subnet 2
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Condition: CreateNATGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-NAT2-GW-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Route Table for Public Subnets
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PubRT-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Default Route for Public Route Table
  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  # Associate Public Subnet 1 with Public Route Table
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  # Associate Public Subnet 2 with Public Route Table
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  # Route Table for Private Subnet 1
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PrivRT1-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Default Route for Private Route Table 1 (via NAT Gateway 1)
  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Condition: CreateNATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway1

  # Associate Private Subnet 1 with Private Route Table 1
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  # Route Table for Private Subnet 2
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PrivRT2-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Default Route for Private Route Table 2 (via NAT Gateway 2)
  DefaultPrivateRoute2:
    Type: AWS::EC2::Route
    Condition: CreateNATGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway2

  # Associate Private Subnet 2 with Private Route Table 2
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  # Security Group for Public Web Traffic (HTTP/HTTPS)
  PublicWebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'HA-Prod-PubWeb-SG-${EnvironmentSuffix}-${AWS::AccountId}'
      GroupDescription: 'Security group for public web traffic allowing HTTP and HTTPS with restricted egress'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTP traffic from anywhere'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTPS traffic from anywhere'
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTP outbound for web services'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTPS outbound for secure web services'
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'Allow DNS over TCP'
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'Allow DNS over UDP'
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PubWeb-SG-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Security Group for Private SSH Access
  PrivateSSHSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'HA-Prod-PrivSSH-SG-${EnvironmentSuffix}-${AWS::AccountId}'
      GroupDescription: 'Security group for SSH access to private subnets from specific private CIDR with restricted egress'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHAllowedCIDR
          Description: 'Allow SSH access from specified private CIDR range only'
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTP outbound for package updates'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'
          Description: 'Allow HTTPS outbound for secure package updates'
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'Allow DNS over TCP'
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: '0.0.0.0/0'
          Description: 'Allow DNS over UDP'
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: '10.0.0.0/16'
          Description: 'Allow SSH to other instances within VPC'
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-PrivSSH-SG-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # Network ACL for additional security layer
  NetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub 'HA-Prod-NACL-${EnvironmentSuffix}-${AWS::AccountId}'
        - Key: Environment
          Value: 'Production'
        - Key: EnvironmentSuffix
          Value: !Ref EnvironmentSuffix

  # SSH rule for Network ACL (only for private subnets)
  NetworkAclEntryInboundSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NetworkAcl
      RuleNumber: 90
      Protocol: 6
      RuleAction: allow
      PortRange:
        From: 22
        To: 22
      CidrBlock: !Ref SSHAllowedCIDR

  # Associate Network ACL with Private Subnets only
  PrivateSubnet1NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      NetworkAclId: !Ref NetworkAcl

  PrivateSubnet2NetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      NetworkAclId: !Ref NetworkAcl

  # Inbound rule for HTTP traffic
  NetworkAclEntryInboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      PortRange:
        From: 80
        To: 80
      CidrBlock: '0.0.0.0/0'

  # Inbound rule for HTTPS traffic
  NetworkAclEntryInboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NetworkAcl
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      PortRange:
        From: 443
        To: 443
      CidrBlock: '0.0.0.0/0'

  # Inbound rule for ephemeral ports (for return traffic)
  NetworkAclEntryInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NetworkAcl
      RuleNumber: 120
      Protocol: 6
      RuleAction: allow
      PortRange:
        From: 1024
        To: 65535
      CidrBlock: '0.0.0.0/0'

  # Outbound rule for all traffic
  NetworkAclEntryOutbound:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref NetworkAcl
      RuleNumber: 100
      Protocol: -1
      Egress: true
      RuleAction: allow
      CidrBlock: '0.0.0.0/0'

Outputs:
  # Core Infrastructure Identifiers
  VPC:
    Description: 'VPC ID for the high-availability network infrastructure'
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPC-ID'

  EnvironmentSuffix:
    Description: 'Environment suffix used for resource naming'
    Value: !Ref EnvironmentSuffix
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentSuffix'

  StackName:
    Description: 'CloudFormation stack name for reference'
    Value: !Ref 'AWS::StackName'
    Export:
      Name: !Sub '${AWS::StackName}-StackName'

  # Availability Zone Information
  AvailabilityZone1:
    Description: 'First availability zone used for infrastructure'
    Value: !Select [0, !GetAZs '']
    Export:
      Name: !Sub '${AWS::StackName}-AZ1'

  AvailabilityZone2:
    Description: 'Second availability zone used for infrastructure'
    Value: !Select [1, !GetAZs '']
    Export:
      Name: !Sub '${AWS::StackName}-AZ2'

  # Subnet Information
  PublicSubnet1:
    Description: 'Public Subnet 1 ID in first availability zone'
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1-ID'

  PublicSubnet2:
    Description: 'Public Subnet 2 ID in second availability zone'
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2-ID'

  PrivateSubnet1:
    Description: 'Private Subnet 1 ID in first availability zone'
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1-ID'

  PrivateSubnet2:
    Description: 'Private Subnet 2 ID in second availability zone'
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2-ID'

  PublicSubnet1CIDR:
    Description: 'CIDR block for Public Subnet 1'
    Value: '10.0.1.0/24'
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet1-CIDR'

  PublicSubnet2CIDR:
    Description: 'CIDR block for Public Subnet 2'
    Value: '10.0.2.0/24'
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnet2-CIDR'

  PrivateSubnet1CIDR:
    Description: 'CIDR block for Private Subnet 1'
    Value: '10.0.11.0/24'
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet1-CIDR'

  PrivateSubnet2CIDR:
    Description: 'CIDR block for Private Subnet 2'
    Value: '10.0.12.0/24'
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnet2-CIDR'

  # Security Groups
  PublicWebSecurityGroup:
    Description: 'Security Group ID for public web traffic (HTTP/HTTPS)'
    Value: !Ref PublicWebSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-PublicWebSG-ID'

  PrivateSSHSecurityGroup:
    Description: 'Security Group ID for private SSH access'
    Value: !Ref PrivateSSHSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSSHSG-ID'

  # NAT Gateway Information
  NatGateway1:
    Condition: CreateNATGateway
    Description: 'NAT Gateway 1 ID in first availability zone'
    Value: !Ref NatGateway1
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway1-ID'

  NatGateway2:
    Condition: CreateNATGateway
    Description: 'NAT Gateway 2 ID in second availability zone'
    Value: !Ref NatGateway2
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway2-ID'

  NatGateway1EIP:
    Condition: CreateNATGateway
    Description: 'Elastic IP address for NAT Gateway 1'
    Value: !Ref NatGateway1EIP
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway1EIP'

  NatGateway2EIP:
    Condition: CreateNATGateway
    Description: 'Elastic IP address for NAT Gateway 2'
    Value: !Ref NatGateway2EIP
    Export:
      Name: !Sub '${AWS::StackName}-NatGateway2EIP'

  # Internet Gateway
  InternetGateway:
    Description: 'Internet Gateway ID for public internet access'
    Value: !Ref InternetGateway
    Export:
      Name: !Sub '${AWS::StackName}-InternetGateway-ID'

  # Route Tables
  PublicRouteTable:
    Description: 'Public Route Table ID for internet-bound traffic'
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-PublicRouteTable-ID'

  PrivateRouteTable1:
    Description: 'Private Route Table 1 ID for NAT Gateway 1 traffic'
    Value: !Ref PrivateRouteTable1
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable1-ID'

  PrivateRouteTable2:
    Description: 'Private Route Table 2 ID for NAT Gateway 2 traffic'
    Value: !Ref PrivateRouteTable2
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable2-ID'

  # Network ACL
  NetworkAcl:
    Description: 'Network ACL ID for additional security layer'
    Value: !Ref NetworkAcl
    Export:
      Name: !Sub '${AWS::StackName}-NetworkAcl-ID'

  # VPC CIDR
  VPCCIDR:
    Description: 'VPC CIDR block for the entire network'
    Value: '10.0.0.0/16'
    Export:
      Name: !Sub '${AWS::StackName}-VPC-CIDR'

  # Region Information
  AWSRegion:
    Description: 'AWS Region where infrastructure is deployed'
    Value: !Ref 'AWS::Region'
    Export:
      Name: !Sub '${AWS::StackName}-Region'

  # High Availability Confirmation
  HighAvailabilityEnabled:
    Description: 'Confirms high availability across multiple AZs'
    Value: 'true'
    Export:
      Name: !Sub '${AWS::StackName}-HighAvailability'

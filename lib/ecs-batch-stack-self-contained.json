{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "ECS Fargate Batch Processing System - Self-Contained with VPC and S3",
  "Parameters": {
    "EnvironmentSuffix": {
      "Type": "String",
      "Description": "Environment suffix for resource naming (e.g., dev, staging, prod)",
      "Default": "dev"
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "EnableDnsHostnames": true,
        "EnableDnsSupport": true,
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "ecs-batch-vpc-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": { "Fn::Select": [0, { "Fn::GetAZs": "" }] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "ecs-batch-private-subnet-1-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet2": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": { "Fn::Select": [1, { "Fn::GetAZs": "" }] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "ecs-batch-private-subnet-2-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "PrivateSubnet3": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "VPC" },
        "CidrBlock": "10.0.3.0/24",
        "AvailabilityZone": { "Fn::Select": [2, { "Fn::GetAZs": "" }] },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Sub": "ecs-batch-private-subnet-3-${EnvironmentSuffix}" }
          }
        ]
      }
    },
    "DataBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "ecs-batch-data-${AWS::AccountId}-${EnvironmentSuffix}" },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "OutputBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "ecs-batch-output-${AWS::AccountId}-${EnvironmentSuffix}" },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "LogEncryptionKey": {
      "Type": "AWS::KMS::Key",
      "Properties": {
        "Description": { "Fn::Sub": "KMS key for CloudWatch Logs encryption - ${EnvironmentSuffix}" },
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": { "AWS": { "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root" } },
              "Action": "kms:*",
              "Resource": "*"
            },
            {
              "Sid": "Allow CloudWatch Logs",
              "Effect": "Allow",
              "Principal": { "Service": { "Fn::Sub": "logs.${AWS::Region}.amazonaws.com" } },
              "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:CreateGrant",
                "kms:DescribeKey"
              ],
              "Resource": "*",
              "Condition": {
                "ArnLike": {
                  "kms:EncryptionContext:aws:logs:arn": { "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*" }
                }
              }
            }
          ]
        }
      }
    },
    "LogEncryptionKeyAlias": {
      "Type": "AWS::KMS::Alias",
      "Properties": {
        "AliasName": { "Fn::Sub": "alias/ecs-logs-${EnvironmentSuffix}" },
        "TargetKeyId": { "Ref": "LogEncryptionKey" }
      }
    },
    "DataIngestionLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Sub": "/ecs/data-ingestion-${EnvironmentSuffix}" },
        "RetentionInDays": 30,
        "KmsKeyId": { "Fn::GetAtt": ["LogEncryptionKey", "Arn"] }
      }
    },
    "RiskCalculationLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Sub": "/ecs/risk-calculation-${EnvironmentSuffix}" },
        "RetentionInDays": 30,
        "KmsKeyId": { "Fn::GetAtt": ["LogEncryptionKey", "Arn"] }
      }
    },
    "ReportGenerationLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Sub": "/ecs/report-generation-${EnvironmentSuffix}" },
        "RetentionInDays": 30,
        "KmsKeyId": { "Fn::GetAtt": ["LogEncryptionKey", "Arn"] }
      }
    },
    "DataIngestionRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": { "Fn::Sub": "data-ingestion-${EnvironmentSuffix}" },
        "ImageScanningConfiguration": { "ScanOnPush": true },
        "LifecyclePolicy": {
          "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Keep last 10 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":10},\"action\":{\"type\":\"expire\"}}]}"
        }
      }
    },
    "RiskCalculationRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": { "Fn::Sub": "risk-calculation-${EnvironmentSuffix}" },
        "ImageScanningConfiguration": { "ScanOnPush": true },
        "LifecyclePolicy": {
          "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Keep last 10 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":10},\"action\":{\"type\":\"expire\"}}]}"
        }
      }
    },
    "ReportGenerationRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": { "Fn::Sub": "report-generation-${EnvironmentSuffix}" },
        "ImageScanningConfiguration": { "ScanOnPush": true },
        "LifecyclePolicy": {
          "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Keep last 10 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":10},\"action\":{\"type\":\"expire\"}}]}"
        }
      }
    },
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": { "Fn::Sub": "batch-processing-${EnvironmentSuffix}" },
        "CapacityProviders": ["FARGATE", "FARGATE_SPOT"],
        "DefaultCapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Weight": 1,
            "Base": 0
          }
        ],
        "ClusterSettings": [{ "Name": "containerInsights", "Value": "enabled" }]
      }
    },
    "TaskExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "ecs-task-execution-${EnvironmentSuffix}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "ecs-tasks.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "ECRAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecr:GetAuthorizationToken",
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:BatchGetImage"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "CloudWatchLogsAccess",
            "PolicyDocument": {
              "Version": "2012-01-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
                  "Resource": [
                    { "Fn::GetAtt": ["DataIngestionLogGroup", "Arn"] },
                    { "Fn::GetAtt": ["RiskCalculationLogGroup", "Arn"] },
                    { "Fn::GetAtt": ["ReportGenerationLogGroup", "Arn"] }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": "KMSAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["kms:Decrypt", "kms:GenerateDataKey"],
                  "Resource": { "Fn::GetAtt": ["LogEncryptionKey", "Arn"] }
                }
              ]
            }
          }
        ]
      }
    },
    "TaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "ecs-task-role-${EnvironmentSuffix}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": "ecs-tasks.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "S3Access",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["s3:GetObject", "s3:ListBucket"],
                  "Resource": [
                    { "Fn::GetAtt": ["DataBucket", "Arn"] },
                    { "Fn::Sub": "${DataBucket.Arn}/*" }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["s3:PutObject", "s3:PutObjectAcl"],
                  "Resource": [{ "Fn::Sub": "${OutputBucket.Arn}/*" }]
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "ClusterName": {
      "Description": "ECS Cluster Name",
      "Value": { "Ref": "ECSCluster" }
    },
    "DataBucketName": {
      "Description": "Data input S3 bucket name",
      "Value": { "Ref": "DataBucket" }
    },
    "OutputBucketName": {
      "Description": "Data output S3 bucket name",
      "Value": { "Ref": "OutputBucket" }
    },
    "VpcId": {
      "Description": "VPC ID",
      "Value": { "Ref": "VPC" }
    },
    "DataIngestionRepository": {
      "Description": "ECR Repository for data ingestion",
      "Value": { "Fn::GetAtt": ["DataIngestionRepository", "RepositoryUri"] }
    },
    "RiskCalculationRepository": {
      "Description": "ECR Repository for risk calculation",
      "Value": { "Fn::GetAtt": ["RiskCalculationRepository", "RepositoryUri"] }
    },
    "ReportGenerationRepository": {
      "Description": "ECR Repository for report generation",
      "Value": { "Fn::GetAtt": ["ReportGenerationRepository", "RepositoryUri"] }
    }
  }
}

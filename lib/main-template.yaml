AWSTemplateFormatVersion: '2010-09-09'
Description: 'Multi-region AWS cloud environment for distributed web application'

Parameters:
  KeyPairName:
    Type: String
    Default: 'default-keypair'
    Description: 'EC2 Key Pair name for instances'
  
  ImageId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
    Description: 'Amazon Linux 2 AMI ID'

Resources:
  # US-East-1 Region Stack
  USEast1Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${AWS::StackName}-templates.s3.amazonaws.com/us-east-1-stack.yaml'
      Parameters:
        KeyPairName: !Ref KeyPairName
        ImageId: !Ref ImageId
        Region: 'us-east-1'
      Tags:
        - Key: Environment
          Value: Production
        - Key: Team
          Value: DevOps
        - Key: Region
          Value: us-east-1

  # US-West-2 Region Stack
  USWest2Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${AWS::StackName}-templates.s3.amazonaws.com/us-west-2-stack.yaml'
      Parameters:
        KeyPairName: !Ref KeyPairName
        ImageId: !Ref ImageId
        Region: 'us-west-2'
      Tags:
        - Key: Environment
          Value: Production
        - Key: Team
          Value: DevOps
        - Key: Region
          Value: us-west-2

Outputs:
  USEast1LoadBalancerDNS:
    Description: 'DNS name of the load balancer in US-East-1'
    Value: !GetAtt USEast1Stack.Outputs.LoadBalancerDNS
    Export:
      Name: !Sub '${AWS::StackName}-USEast1-ALB-DNS'
  
  USWest2LoadBalancerDNS:
    Description: 'DNS name of the load balancer in US-West-2'
    Value: !GetAtt USWest2Stack.Outputs.LoadBalancerDNS
    Export:
      Name: !Sub '${AWS::StackName}-USWest2-ALB-DNS'
  
  USEast1AutoScalingGroup:
    Description: 'Auto Scaling Group name in US-East-1'
    Value: !GetAtt USEast1Stack.Outputs.AutoScalingGroupName
    Export:
      Name: !Sub '${AWS::StackName}-USEast1-ASG'
  
  USWest2AutoScalingGroup:
    Description: 'Auto Scaling Group name in US-West-2'
    Value: !GetAtt USWest2Stack.Outputs.AutoScalingGroupName
    Export:
      Name: !Sub '${AWS::StackName}-USWest2-ASG'
"use strict";
// Test setup file for Jest
Object.defineProperty(exports, "__esModule", { value: true });
// Mock environment variables for testing
process.env.ENVIRONMENT_SUFFIX = 'test';
process.env.API_ENDPOINT =
    'https://mock-api.execute-api.us-east-1.amazonaws.com/test';
process.env.API_KEY = 'test-api-key';
process.env.COGNITO_USER_POOL_ID = 'us-east-1_testpool';
process.env.COGNITO_CLIENT_ID = 'test-client-id';
process.env.S3_BUCKET_NAME = 'test-serverless-data-bucket';
process.env.LAMBDA_FUNCTION_NAME = 'test-serverless-function';
process.env.BUCKET_NAME = 'test-serverless-data-bucket';
process.env.ENVIRONMENT = 'test';
// Global test utilities
global.testConfig = {
    apiEndpoint: process.env.API_ENDPOINT,
    apiKey: process.env.API_KEY,
    cognitoUserPoolId: process.env.COGNITO_USER_POOL_ID,
    cognitoClientId: process.env.COGNITO_CLIENT_ID,
    s3BucketName: process.env.S3_BUCKET_NAME,
    lambdaFunctionName: process.env.LAMBDA_FUNCTION_NAME,
};
// Mock console methods to reduce noise in tests
global.console = {
    ...console,
    log: jest.fn(),
    warn: jest.fn(),
    error: jest.fn(),
    info: jest.fn(),
    debug: jest.fn(),
};
// Mock fs for file operations
jest.mock('fs', () => ({
    ...jest.requireActual('fs'),
    readFileSync: jest.fn().mockImplementation((path) => {
        if (path.includes('cfn-outputs')) {
            return JSON.stringify({
                ServerlessStackServerlessApiEndpoint3B0EFFAB: 'https://mock-api.execute-api.us-east-1.amazonaws.com/test',
                ServerlessStackServerlessBucket42EDACEC: 'test-serverless-data-bucket',
                ServerlessStackServerlessFunction8E4B5BF6: 'test-serverless-function',
                ServerlessStackApiUserPool03DDFC07: 'us-east-1_testpool',
                ServerlessStackApiUserPoolClient78FCC2AF: 'test-client-id',
            });
        }
        return '{}';
    }),
    existsSync: jest.fn().mockReturnValue(true),
    writeFileSync: jest.fn(),
    mkdirSync: jest.fn(),
}));
// Mock axios for HTTP requests
jest.mock('axios', () => ({
    get: jest
        .fn()
        .mockImplementation((_url, config) => {
        const headers = config?.headers || {};
        // Mock different responses based on the request
        if (!headers['X-API-Key']) {
            return Promise.reject({
                response: { status: 403, data: 'Forbidden' },
            });
        }
        if (!headers['Authorization']) {
            return Promise.reject({
                response: { status: 401, data: 'Unauthorized' },
            });
        }
        if (_url.includes('/nonexistent')) {
            return Promise.reject({
                response: { status: 404, data: 'Not Found' },
            });
        }
        // Rate limiting simulation (deterministic for testing)
        if (_url.includes('/rate-limit-test')) {
            return Promise.reject({
                response: { status: 429, data: 'Too Many Requests' },
            });
        }
        return Promise.resolve({
            status: 200,
            data: {
                message: 'Success',
                timestamp: new Date().toISOString(),
            },
            headers: {
                'content-type': 'application/json',
            },
        });
    }),
    post: jest
        .fn()
        .mockImplementation((_url, data, config) => {
        const headers = config?.headers || {};
        if (!headers['X-API-Key']) {
            return Promise.reject({
                response: { status: 403, data: 'Forbidden' },
            });
        }
        if (!headers['Authorization']) {
            return Promise.reject({
                response: { status: 401, data: 'Unauthorized' },
            });
        }
        // Check for malformed JSON
        if (data === 'invalid-json') {
            return Promise.reject({
                response: { status: 400, data: 'Bad Request' },
            });
        }
        return Promise.resolve({
            status: 200,
            data: {
                message: 'Success',
                timestamp: new Date().toISOString(),
            },
            headers: {
                'content-type': 'application/json',
            },
        });
    }),
    options: jest
        .fn()
        .mockImplementation((_url, _config) => {
        return Promise.resolve({
            status: 204,
            headers: {
                'access-control-allow-origin': '*',
                'access-control-allow-methods': 'GET,POST,OPTIONS',
                'access-control-allow-headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key',
            },
        });
    }),
}));
// Test timeout configuration
jest.setTimeout(30000);
// Cleanup after each test
afterEach(() => {
    jest.clearAllMocks();
});
// Global test data
global.testData = {
    message: 'Integration test data',
    timestamp: new Date().toISOString(),
    testId: `test-${Date.now()}`,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR1cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsMkJBQTJCOztBQUUzQix5Q0FBeUM7QUFDekMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUM7QUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZO0lBQ3RCLDJEQUEyRCxDQUFDO0FBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQztBQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO0FBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsNkJBQTZCLENBQUM7QUFDM0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsR0FBRywwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyw2QkFBNkIsQ0FBQztBQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUM7QUFFakMsd0JBQXdCO0FBQ3ZCLE1BQWtDLENBQUMsVUFBVSxHQUFHO0lBQy9DLFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVk7SUFDckMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTztJQUMzQixpQkFBaUIsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtJQUNuRCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUI7SUFDOUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYztJQUN4QyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtDQUNyRCxDQUFDO0FBRUYsZ0RBQWdEO0FBQy9DLE1BQWtDLENBQUMsT0FBTyxHQUFH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QUFFO2FBQ3BDO1lBQ0QsT0FBTyxFQUFFO2dCQUNQLGNBQWMsRUFBRSxrQkFBa0I7YUFDbkM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQ0Y7SUFDSCxPQUFPLEVBQUUsSUFBSTtTQUNWLEVBQUUsRUFBRTtTQUNKLGtCQUFrQixDQUFDLENBQUMsSUFBWSxFQUFFLE9BQWlDLEVBQUUsRUFBRTtRQUN0RSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUM7WUFDckIsTUFBTSxFQUFFLEdBQUc7WUFDWCxPQUFPLEVBQUU7Z0JBQ1AsNkJBQTZCLEVBQUUsR0FBRztnQkFDbEMsOEJBQThCLEVBQUUsa0JBQWtCO2dCQUNsRCw4QkFBOEIsRUFDNUIsaURBQWlEO2FBQ3BEO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0NBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSiw2QkFBNkI7QUFDN0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QiwwQkFBMEI7QUFDMUIsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILG1CQUFtQjtBQUNsQixNQUFrQyxDQUFDLFFBQVEsR0FBRztJQUM3QyxPQUFPLEVBQUUsdUJBQXVCO0lBQ2hDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtJQUNuQyxNQUFNLEVBQUUsUUFBUSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUU7Q0FDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRlc3Qgc2V0dXAgZmlsZSBmb3IgSmVzdFxuXG4vLyBNb2NrIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgdGVzdGluZ1xucHJvY2Vzcy5lbnYuRU5WSVJPTk1FTlRfU1VGRklYID0gJ3Rlc3QnO1xucHJvY2Vzcy5lbnYuQVBJX0VORFBPSU5UID1cbiAgJ2h0dHBzOi8vbW9jay1hcGkuZXhlY3V0ZS1hcGkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGVzdCc7XG5wcm9jZXNzLmVudi5BUElfS0VZID0gJ3Rlc3QtYXBpLWtleSc7XG5wcm9jZXNzLmVudi5DT0dOSVRPX1VTRVJfUE9PTF9JRCA9ICd1cy1lYXN0LTFfdGVzdHBvb2wnO1xucHJvY2Vzcy5lbnYuQ09HTklUT19DTElFTlRfSUQgPSAndGVzdC1jbGllbnQtaWQnO1xucHJvY2Vzcy5lbnYuUzNfQlVDS0VUX05BTUUgPSAndGVzdC1zZXJ2ZXJsZXNzLWRhdGEtYnVja2V0JztcbnByb2Nlc3MuZW52LkxBTUJEQV9GVU5DVElPTl9OQU1FID0gJ3Rlc3Qtc2VydmVybGVzcy1mdW5jdGlvbic7XG5wcm9jZXNzLmVudi5CVUNLRVRfTkFNRSA9ICd0ZXN0LXNlcnZlcmxlc3MtZGF0YS1idWNrZXQnO1xucHJvY2Vzcy5lbnYuRU5WSVJPTk1FTlQgPSAndGVzdCc7XG5cbi8vIEdsb2JhbCB0ZXN0IHV0aWxpdGllc1xuKGdsb2JhbCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikudGVzdENvbmZpZyA9IHtcbiAgYXBpRW5kcG9pbnQ6IHByb2Nlc3MuZW52LkFQSV9FTkRQT0lOVCxcbiAgYXBpS2V5OiBwcm9jZXNzLmVudi5BUElfS0VZLFxuICBjb2duaXRvVXNlclBvb2xJZDogcHJvY2Vzcy5lbnYuQ09HTklUT19VU0VSX1BPT0xfSUQsXG4gIGNvZ25pdG9DbGllbnRJZDogcHJvY2Vzcy5lbnYuQ09HTklUT19DTElFTlRfSUQsXG4gIHMzQnVja2V0TmFtZTogcHJvY2Vzcy5lbnYuUzNfQlVDS0VUX05BTUUsXG4gIGxhbWJkYUZ1bmN0aW9uTmFtZTogcHJvY2Vzcy5lbnYuTEFNQkRBX0ZVTkNUSU9OX05BTUUsXG59O1xuXG4vLyBNb2NrIGNvbnNvbGUgbWV0aG9kcyB0byByZWR1Y2Ugbm9pc2UgaW4gdGVzdHNcbihnbG9iYWwgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pLmNvbnNvbGUgPSB7XG4gIC4uLmNvbnNvbGUsXG4gIGxvZzogamVzdC5mbigpLFxuICB3YXJuOiBqZXN0LmZuKCksXG4gIGVycm9yOiBqZXN0LmZuKCksXG4gIGluZm86IGplc3QuZm4oKSxcbiAgZGVidWc6IGplc3QuZm4oKSxcbn07XG5cbi8vIE1vY2sgZnMgZm9yIGZpbGUgb3BlcmF0aW9uc1xuamVzdC5tb2NrKCdmcycsICgpID0+ICh7XG4gIC4uLmplc3QucmVxdWlyZUFjdHVhbCgnZnMnKSxcbiAgcmVhZEZpbGVTeW5jOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICBpZiAocGF0aC5pbmNsdWRlcygnY2ZuLW91dHB1dHMnKSkge1xuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgU2VydmVybGVzc1N0YWNrU2VydmVybGVzc0FwaUVuZHBvaW50M0IwRUZGQUI6XG4gICAgICAgICAgJ2h0dHBzOi8vbW9jay1hcGkuZXhlY3V0ZS1hcGkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGVzdCcsXG4gICAgICAgIFNlcnZlcmxlc3NTdGFja1NlcnZlcmxlc3NCdWNrZXQ0MkVEQUNFQzogJ3Rlc3Qtc2VydmVybGVzcy1kYXRhLWJ1Y2tldCcsXG4gICAgICAgIFNlcnZlcmxlc3NTdGFja1NlcnZlcmxlc3NGdW5jdGlvbjhFNEI1QkY2OiAndGVzdC1zZXJ2ZXJsZXNzLWZ1bmN0aW9uJyxcbiAgICAgICAgU2VydmVybGVzc1N0YWNrQXBpVXNlclBvb2wwM0RERkMwNzogJ3VzLWVhc3QtMV90ZXN0cG9vbCcsXG4gICAgICAgIFNlcnZlcmxlc3NTdGFja0FwaVVzZXJQb29sQ2xpZW50NzhGQ0MyQUY6ICd0ZXN0LWNsaWVudC1pZCcsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuICd7fSc7XG4gIH0pLFxuICBleGlzdHNTeW5jOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHRydWUpLFxuICB3cml0ZUZpbGVTeW5jOiBqZXN0LmZuKCksXG4gIG1rZGlyU3luYzogamVzdC5mbigpLFxufSkpO1xuXG4vLyBNb2NrIGF4aW9zIGZvciBIVFRQIHJlcXVlc3RzXG5qZXN0Lm1vY2soJ2F4aW9zJywgKCkgPT4gKHtcbiAgZ2V0OiBqZXN0XG4gICAgLmZuKClcbiAgICAubW9ja0ltcGxlbWVudGF0aW9uKChfdXJsOiBzdHJpbmcsIGNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XG4gICAgICBjb25zdCBoZWFkZXJzID0gKGNvbmZpZz8uaGVhZGVycyBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB8fCB7fTtcblxuICAgICAgLy8gTW9jayBkaWZmZXJlbnQgcmVzcG9uc2VzIGJhc2VkIG9uIHRoZSByZXF1ZXN0XG4gICAgICBpZiAoIWhlYWRlcnNbJ1gtQVBJLUtleSddKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7XG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA0MDMsIGRhdGE6ICdGb3JiaWRkZW4nIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Qoe1xuICAgICAgICAgIHJlc3BvbnNlOiB7IHN0YXR1czogNDAxLCBkYXRhOiAnVW5hdXRob3JpemVkJyB9LFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKF91cmwuaW5jbHVkZXMoJy9ub25leGlzdGVudCcpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7XG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA0MDQsIGRhdGE6ICdOb3QgRm91bmQnIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBSYXRlIGxpbWl0aW5nIHNpbXVsYXRpb24gKGRldGVybWluaXN0aWMgZm9yIHRlc3RpbmcpXG4gICAgICBpZiAoX3VybC5pbmNsdWRlcygnL3JhdGUtbGltaXQtdGVzdCcpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7XG4gICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA0MjksIGRhdGE6ICdUb28gTWFueSBSZXF1ZXN0cycgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICBzdGF0dXM6IDIwMCxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6ICdTdWNjZXNzJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KSxcbiAgcG9zdDogamVzdFxuICAgIC5mbigpXG4gICAgLm1vY2tJbXBsZW1lbnRhdGlvbihcbiAgICAgIChfdXJsOiBzdHJpbmcsIGRhdGE6IHVua25vd24sIGNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PiB7XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSAoY29uZmlnPy5oZWFkZXJzIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4pIHx8IHt9O1xuXG4gICAgICAgIGlmICghaGVhZGVyc1snWC1BUEktS2V5J10pIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Qoe1xuICAgICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA0MDMsIGRhdGE6ICdGb3JiaWRkZW4nIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh7XG4gICAgICAgICAgICByZXNwb25zZTogeyBzdGF0dXM6IDQwMSwgZGF0YTogJ1VuYXV0aG9yaXplZCcgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBtYWxmb3JtZWQgSlNPTlxuICAgICAgICBpZiAoZGF0YSA9PT0gJ2ludmFsaWQtanNvbicpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Qoe1xuICAgICAgICAgICAgcmVzcG9uc2U6IHsgc3RhdHVzOiA0MDAsIGRhdGE6ICdCYWQgUmVxdWVzdCcgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdTdWNjZXNzJyxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICApLFxuICBvcHRpb25zOiBqZXN0XG4gICAgLmZuKClcbiAgICAubW9ja0ltcGxlbWVudGF0aW9uKChfdXJsOiBzdHJpbmcsIF9jb25maWc/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIHN0YXR1czogMjA0LFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ2FjY2Vzcy1jb250cm9sLWFsbG93LW9yaWdpbic6ICcqJyxcbiAgICAgICAgICAnYWNjZXNzLWNvbnRyb2wtYWxsb3ctbWV0aG9kcyc6ICdHRVQsUE9TVCxPUFRJT05TJyxcbiAgICAgICAgICAnYWNjZXNzLWNvbnRyb2wtYWxsb3ctaGVhZGVycyc6XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlLFgtQW16LURhdGUsQXV0aG9yaXphdGlvbixYLUFwaS1LZXknLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSksXG59KSk7XG5cbi8vIFRlc3QgdGltZW91dCBjb25maWd1cmF0aW9uXG5qZXN0LnNldFRpbWVvdXQoMzAwMDApO1xuXG4vLyBDbGVhbnVwIGFmdGVyIGVhY2ggdGVzdFxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG59KTtcblxuLy8gR2xvYmFsIHRlc3QgZGF0YVxuKGdsb2JhbCBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikudGVzdERhdGEgPSB7XG4gIG1lc3NhZ2U6ICdJbnRlZ3JhdGlvbiB0ZXN0IGRhdGEnLFxuICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgdGVzdElkOiBgdGVzdC0ke0RhdGUubm93KCl9YCxcbn07XG4iXX0=
import { readFileSync } from 'fs';
import { join } from 'path';
import { execSync } from 'child_process';
import fetch from 'node-fetch';

const outputsPath = join(__dirname, '../cfn-outputs/flat-outputs.json');
const terraformOutput = JSON.parse(readFileSync(outputsPath, 'utf8'));

const albDnsName: string = terraformOutput.alb_dns_name;
const rdsEndpoint: string = terraformOutput.rds_endpoint;
const vpcId: string = terraformOutput.vpc_id;
const subnetIds: string[] = terraformOutput.subnet_ids;
const albSg: string = terraformOutput.alb_sg_id;
const rdsSg: string = terraformOutput.rds_sg_id;

console.log('ALB DNS:', albDnsName);
console.log('RDS Endpoint:', rdsEndpoint);
console.log('VPC ID:', vpcId);

describe('TAP Stack Integration Tests', () => {
  // --------------------------
  // Application Reachability
  // --------------------------
  describe('Application Reachability', () => {
    test('ALB root endpoint returns HTTP 200 (HTML check)', async () => {
      expect(albDnsName).toBeDefined();
      expect(albDnsName).toContain('amazonaws.com');

      const response = await fetch(`http://${albDnsName}/`, {
        signal: AbortSignal.timeout(5000),
      });

      expect(response.status).toBe(200);
      const text = await response.text();
      expect(text).toContain('TAP'); // adjust keyword if app shows something else
    }, 60000);

    test('ALB health endpoint returns JSON', async () => {
      const response = await fetch(`http://${albDnsName}/health`, {
        signal: AbortSignal.timeout(5000),
      });

      expect(response.status).toBe(200);
      const data = await response.json();
      expect(data.status).toBeDefined();
    }, 60000);
  });

  // --------------------------
  // Database Security
  // --------------------------
  describe('Database Security', () => {
    test('RDS should not be publicly accessible', () => {
      const result = execSync(
        `aws rds describe-db-instances --query "DBInstances[?Endpoint.Address=='${rdsEndpoint.split(':')[0]}'].PubliclyAccessible" --output text`,
        { encoding: 'utf8' }
      ).trim();

      expect(result).toBe('False');
      console.log('✅ RDS is not publicly accessible');
    });

    test('RDS storage encryption enabled', () => {
      const rdsHost = rdsEndpoint.split(':')[0];

      const result = execSync(
        `aws rds describe-db-instances --query "DBInstances[?Endpoint.Address=='${rdsHost}'].StorageEncrypted" --output text`,
        { encoding: 'utf8' }
      ).trim();

      expect(result).toBe('True');
      console.log('✅ RDS storage encryption is enabled');
    });
  });

  // --------------------------
  // Infrastructure Outputs
  // --------------------------
  describe('Infrastructure Outputs', () => {
    test('VPC and subnets exist', () => {
      expect(vpcId).toMatch(/^vpc-/);
      expect(subnetIds.length).toBeGreaterThan(0);
      console.log('✅ VPC and subnets exist');
    });

    test('All essential outputs are present', () => {
      expect(albDnsName).toBeDefined();
      expect(rdsEndpoint).toBeDefined();
      expect(vpcId).toBeDefined();
      expect(albSg).toMatch(/^sg-/);
      expect(rdsSg).toMatch(/^sg-/);
      console.log('✅ All essential outputs are present');
    });
  });

  // --------------------------
  // Security Groups
  // --------------------------
  describe('Security Groups', () => {
    test('ALB security group exists', () => {
      expect(albSg).toMatch(/^sg-/);
      console.log('✅ ALB security group exists:', albSg);
    });

    test('RDS security group exists', () => {
      expect(rdsSg).toMatch(/^sg-/);
      console.log('✅ RDS security group exists:', rdsSg);
    });
  });
});

